{"pr_number": 637, "pr_title": "Add new Adoppler Bidder", "pr_createdAt": "2020-03-19T13:14:39Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/637", "timeline": [{"oid": "669564210484b0ffb6337a7a9e7cb5604f2c8228", "url": "https://github.com/prebid/prebid-server-java/commit/669564210484b0ffb6337a7a9e7cb5604f2c8228", "message": "Add new Adoppler Bidder", "committedDate": "2020-03-19T13:10:48Z", "type": "commit"}, {"oid": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "url": "https://github.com/prebid/prebid-server-java/commit/973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "message": "Commit all files", "committedDate": "2020-03-19T13:43:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ1NTQwOA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396455408", "bodyText": "does this change really necessary ?", "author": "DGarbar", "createdAt": "2020-03-23T13:37:20Z", "path": "src/test/java/org/prebid/server/it/SmartrtbTest.java", "diffHunk": "@@ -51,9 +51,7 @@ public void openrtb2AuctionShouldRespondWithBidsFromSmartrtb() throws IOExceptio\n                 \"openrtb2/smartrtb/test-auction-smartrtb-response.json\",\n                 response, singletonList(\"smartrtb\"));\n \n-", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2MjA2OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396462069", "bodyText": "Models can be only objects, not primitives", "author": "DGarbar", "createdAt": "2020-03-23T13:47:03Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/model/AdopplerResponseVideoAdsExt.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package org.prebid.server.bidder.adoppler.model;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Value;\n+\n+@AllArgsConstructor(staticName = \"of\")\n+@Value\n+public class AdopplerResponseVideoAdsExt {\n+\n+    int duration;", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ2OTgxOA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396469818", "bodyText": "redundant call to .format", "author": "DGarbar", "createdAt": "2020-03-23T13:57:49Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3MjI5Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396472293", "bodyText": "please extract this in a separate method createSingleRequest", "author": "DGarbar", "createdAt": "2020-03-23T14:01:13Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3Mzk2NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396473965", "bodyText": "Where the logic related to custom url in which they use ext.adUnit", "author": "DGarbar", "createdAt": "2020-03-23T14:03:39Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3NjYzNQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396476635", "bodyText": "redundant .format", "author": "DGarbar", "createdAt": "2020-03-23T14:07:41Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final BidResponse bidResponse;\n+        try {\n+            bidResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n+                    e.getMessage())));\n+        }\n+\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\"duplicate $.imp.id %s\", imp.getId())));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                return Result.emptyWithError(BidderError.badInput(String.format(", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ3NzgxNg==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396477816", "bodyText": "I'd probably extracted this into separate method", "author": "DGarbar", "createdAt": "2020-03-23T14:09:24Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final BidResponse bidResponse;\n+        try {\n+            bidResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n+                    e.getMessage())));\n+        }\n+\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\"duplicate $.imp.id %s\", imp.getId())));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\n+                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+            }", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MDM3NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396480375", "bodyText": "(adopplerResponseExt == null) redundant (or in the wrong place)", "author": "DGarbar", "createdAt": "2020-03-23T14:12:57Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final BidResponse bidResponse;\n+        try {\n+            bidResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n+                    e.getMessage())));\n+        }\n+\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\"duplicate $.imp.id %s\", imp.getId())));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\n+                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+            }\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (SeatBid seatBid : bidResponse.getSeatbid()) {\n+            for (Bid bid : seatBid.getBid()) {\n+                if (impTypes.get(bid.getImpid()) == null) {\n+                    return Result.emptyWithError(BidderError\n+                            .badServerResponse(String.format(\"unknown impid: %s\", bid.getImpid())));\n+                }\n+                final AdopplerResponseExt adopplerResponseExt;\n+                if (impTypes.get(bid.getImpid()) == BidType.video) {\n+                    final ObjectNode ext = bid.getExt();\n+                    try {\n+                        adopplerResponseExt = parseResponseExt(ext);\n+                    } catch (PreBidException e) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+                    }\n+                    final AdopplerResponseVideoExt adopplerResponseVideoExt = adopplerResponseExt.getAds();\n+                    if ((adopplerResponseExt == null) || (adopplerResponseVideoExt == null)) {", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MDUwNA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396480504", "bodyText": ".format redundant", "author": "DGarbar", "createdAt": "2020-03-23T14:13:08Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final BidResponse bidResponse;\n+        try {\n+            bidResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n+                    e.getMessage())));\n+        }\n+\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\"duplicate $.imp.id %s\", imp.getId())));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\n+                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+            }\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (SeatBid seatBid : bidResponse.getSeatbid()) {\n+            for (Bid bid : seatBid.getBid()) {\n+                if (impTypes.get(bid.getImpid()) == null) {\n+                    return Result.emptyWithError(BidderError\n+                            .badServerResponse(String.format(\"unknown impid: %s\", bid.getImpid())));\n+                }\n+                final AdopplerResponseExt adopplerResponseExt;\n+                if (impTypes.get(bid.getImpid()) == BidType.video) {\n+                    final ObjectNode ext = bid.getExt();\n+                    try {\n+                        adopplerResponseExt = parseResponseExt(ext);\n+                    } catch (PreBidException e) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+                    }\n+                    final AdopplerResponseVideoExt adopplerResponseVideoExt = adopplerResponseExt.getAds();\n+                    if ((adopplerResponseExt == null) || (adopplerResponseVideoExt == null)) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(String\n+                                .format(\"$.seatbid.bid.ext.ads.video required\")));", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4MzEwMg==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396483102", "bodyText": "I'd extract this into 2 separate methods\n1 one return List\n2 get Type and return ExtBidPrebidVideo", "author": "DGarbar", "createdAt": "2020-03-23T14:16:41Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final BidResponse bidResponse;\n+        try {\n+            bidResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n+                    e.getMessage())));\n+        }\n+\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\"duplicate $.imp.id %s\", imp.getId())));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\n+                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+            }\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (SeatBid seatBid : bidResponse.getSeatbid()) {\n+            for (Bid bid : seatBid.getBid()) {\n+                if (impTypes.get(bid.getImpid()) == null) {\n+                    return Result.emptyWithError(BidderError\n+                            .badServerResponse(String.format(\"unknown impid: %s\", bid.getImpid())));\n+                }\n+                final AdopplerResponseExt adopplerResponseExt;\n+                if (impTypes.get(bid.getImpid()) == BidType.video) {\n+                    final ObjectNode ext = bid.getExt();\n+                    try {\n+                        adopplerResponseExt = parseResponseExt(ext);\n+                    } catch (PreBidException e) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+                    }\n+                    final AdopplerResponseVideoExt adopplerResponseVideoExt = adopplerResponseExt.getAds();\n+                    if ((adopplerResponseExt == null) || (adopplerResponseVideoExt == null)) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(String\n+                                .format(\"$.seatbid.bid.ext.ads.video required\")));\n+                    }\n+                    ExtBidPrebidVideo.of(adopplerResponseVideoExt.getVideo().getDuration(), head(bid.getCat()));\n+                }\n+                final BidderBid bidderBid = BidderBid.of(bid, impTypes.get(bid.getImpid()), DEFAULT_BID_CURRENCY);\n+                bidderBids.add(bidderBid);\n+            }", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4NDU0MA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396484540", "bodyText": "As you can see, we do not have separate place for BidVideo. (thats why this code is unnecessary) But you can exclude it into separate methods to use it in a future", "author": "DGarbar", "createdAt": "2020-03-23T14:18:37Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final BidResponse bidResponse;\n+        try {\n+            bidResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n+                    e.getMessage())));\n+        }\n+\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\"duplicate $.imp.id %s\", imp.getId())));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\n+                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+            }\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (SeatBid seatBid : bidResponse.getSeatbid()) {\n+            for (Bid bid : seatBid.getBid()) {\n+                if (impTypes.get(bid.getImpid()) == null) {\n+                    return Result.emptyWithError(BidderError\n+                            .badServerResponse(String.format(\"unknown impid: %s\", bid.getImpid())));\n+                }\n+                final AdopplerResponseExt adopplerResponseExt;\n+                if (impTypes.get(bid.getImpid()) == BidType.video) {\n+                    final ObjectNode ext = bid.getExt();\n+                    try {\n+                        adopplerResponseExt = parseResponseExt(ext);\n+                    } catch (PreBidException e) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+                    }\n+                    final AdopplerResponseVideoExt adopplerResponseVideoExt = adopplerResponseExt.getAds();\n+                    if ((adopplerResponseExt == null) || (adopplerResponseVideoExt == null)) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(String\n+                                .format(\"$.seatbid.bid.ext.ads.video required\")));\n+                    }\n+                    ExtBidPrebidVideo.of(adopplerResponseVideoExt.getVideo().getDuration(), head(bid.getCat()));", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4NjI2MA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396486260", "bodyText": ".getVideo can produce NPE.", "author": "DGarbar", "createdAt": "2020-03-23T14:20:51Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,189 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import org.apache.commons.lang3.StringUtils;\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n+                        .singletonList(imp)).build();\n+                final String body = mapper.encode(outgoingRequest);\n+                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+                result.add(HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers)\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build());\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(String.format(\"$.imp.ext.adoppler.adunit required\"));\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        final BidResponse bidResponse;\n+        try {\n+            bidResponse = decodeBodyToBidResponse(httpCall);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n+                    e.getMessage())));\n+        }\n+\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\"duplicate $.imp.id %s\", imp.getId())));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                return Result.emptyWithError(BidderError.badInput(String.format(\n+                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+            }\n+        }\n+\n+        final List<BidderBid> bidderBids = new ArrayList<>();\n+        for (SeatBid seatBid : bidResponse.getSeatbid()) {\n+            for (Bid bid : seatBid.getBid()) {\n+                if (impTypes.get(bid.getImpid()) == null) {\n+                    return Result.emptyWithError(BidderError\n+                            .badServerResponse(String.format(\"unknown impid: %s\", bid.getImpid())));\n+                }\n+                final AdopplerResponseExt adopplerResponseExt;\n+                if (impTypes.get(bid.getImpid()) == BidType.video) {\n+                    final ObjectNode ext = bid.getExt();\n+                    try {\n+                        adopplerResponseExt = parseResponseExt(ext);\n+                    } catch (PreBidException e) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+                    }\n+                    final AdopplerResponseVideoExt adopplerResponseVideoExt = adopplerResponseExt.getAds();\n+                    if ((adopplerResponseExt == null) || (adopplerResponseVideoExt == null)) {\n+                        return Result.emptyWithError(BidderError.badServerResponse(String\n+                                .format(\"$.seatbid.bid.ext.ads.video required\")));\n+                    }\n+                    ExtBidPrebidVideo.of(adopplerResponseVideoExt.getVideo().getDuration(), head(bid.getCat()));", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4ODM3Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396488376", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-03-23T14:23:38Z", "path": "src/test/java/org/prebid/server/bidder/adoppler/AdopplerBidderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.util.HttpUtil;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+\n+public class AdopplerBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private AdopplerBidder adopplerBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adopplerBidder = new AdopplerBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new AdopplerBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build())\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, ExtImpAdoppler.of(null)))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"$.imp.ext.adoppler.adunit required\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrlAndDefaultHeaders() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(identity());\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(\"x-openrtb-version\", \"2.5\"),\n+                        tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"invalid body:\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfDuplicateId() throws JsonProcessingException {\n+        // given\n+        Imp imp1 = Imp.builder().id(\"impId\").banner(Banner.builder().build()).build();\n+        Imp imp2 = Imp.builder().id(\"impId\").video(Video.builder().build()).build();\n+        List imps = new ArrayList();\n+        imps.add(imp1);\n+        imps.add(imp2);\n+        BidRequest bidRequest = BidRequest.builder()\n+                .imp(imps)\n+                .build();\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                bidRequest, mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"duplicate $.imp.id impId\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfEmptyImp() throws JsonProcessingException {\n+        // given\n+        BidRequest bidRequest = BidRequest.builder()\n+                .imp(singletonList(Imp.builder().id(\"123\")\n+                        .banner(null)\n+                        .video(null)\n+                        .audio(null)\n+                        .xNative(null)\n+                        .build()))\n+                .build();\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                bidRequest, mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfBidIdEmpty() throws JsonProcessingException {\n+        // given\n+        BidRequest bidRequest = BidRequest.builder()", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4ODQxNw==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396488417", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-03-23T14:23:41Z", "path": "src/test/java/org/prebid/server/bidder/adoppler/AdopplerBidderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.util.HttpUtil;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+\n+public class AdopplerBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private AdopplerBidder adopplerBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adopplerBidder = new AdopplerBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new AdopplerBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build())\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, ExtImpAdoppler.of(null)))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"$.imp.ext.adoppler.adunit required\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrlAndDefaultHeaders() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(identity());\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(\"x-openrtb-version\", \"2.5\"),\n+                        tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"invalid body:\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfDuplicateId() throws JsonProcessingException {\n+        // given\n+        Imp imp1 = Imp.builder().id(\"impId\").banner(Banner.builder().build()).build();\n+        Imp imp2 = Imp.builder().id(\"impId\").video(Video.builder().build()).build();\n+        List imps = new ArrayList();\n+        imps.add(imp1);\n+        imps.add(imp2);\n+        BidRequest bidRequest = BidRequest.builder()\n+                .imp(imps)\n+                .build();\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                bidRequest, mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"duplicate $.imp.id impId\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfEmptyImp() throws JsonProcessingException {\n+        // given\n+        BidRequest bidRequest = BidRequest.builder()", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4ODQ2Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396488466", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-03-23T14:23:46Z", "path": "src/test/java/org/prebid/server/bidder/adoppler/AdopplerBidderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.util.HttpUtil;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+\n+public class AdopplerBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private AdopplerBidder adopplerBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adopplerBidder = new AdopplerBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new AdopplerBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build())\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, ExtImpAdoppler.of(null)))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"$.imp.ext.adoppler.adunit required\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrlAndDefaultHeaders() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(identity());\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(\"x-openrtb-version\", \"2.5\"),\n+                        tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"invalid body:\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfDuplicateId() throws JsonProcessingException {\n+        // given\n+        Imp imp1 = Imp.builder().id(\"impId\").banner(Banner.builder().build()).build();\n+        Imp imp2 = Imp.builder().id(\"impId\").video(Video.builder().build()).build();\n+        List imps = new ArrayList();\n+        imps.add(imp1);\n+        imps.add(imp2);", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ4OTI5Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396489297", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-03-23T14:24:55Z", "path": "src/test/java/org/prebid/server/bidder/adoppler/AdopplerBidderTest.java", "diffHunk": "@@ -0,0 +1,275 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.Banner;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Format;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Video;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpHeaderValues;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Function;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.prebid.server.VertxTest;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.util.HttpUtil;\n+\n+import static java.util.Collections.emptyMap;\n+import static java.util.Collections.singletonList;\n+import static java.util.function.Function.identity;\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.assertj.core.api.Assertions.assertThatIllegalArgumentException;\n+import static org.assertj.core.api.Assertions.tuple;\n+\n+public class AdopplerBidderTest extends VertxTest {\n+\n+    private static final String ENDPOINT_URL = \"https://test.endpoint.com\";\n+\n+    private AdopplerBidder adopplerBidder;\n+\n+    @Before\n+    public void setUp() {\n+        adopplerBidder = new AdopplerBidder(ENDPOINT_URL, jacksonMapper);\n+    }\n+\n+    @Test\n+    public void creationShouldFailOnInvalidEndpointUrl() {\n+        assertThatIllegalArgumentException().isThrownBy(() -> new AdopplerBidder(\"invalid_url\", jacksonMapper));\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldReturnErrorIfImpExtCouldNotBeParsed() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build())\n+                        .ext(mapper.valueToTree(ExtPrebid.of(null, ExtImpAdoppler.of(null)))));\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"$.imp.ext.adoppler.adunit required\");\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldCreateCorrectURL() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(\n+                impBuilder -> impBuilder\n+                        .banner(Banner.builder()\n+                                .format(singletonList(Format.builder().w(300).h(500).build()))\n+                                .build()));\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue()).hasSize(1);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+    }\n+\n+    @Test\n+    public void makeHttpRequestsShouldSetExpectedRequestUrlAndDefaultHeaders() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest(identity());\n+\n+        // when\n+        final Result<List<HttpRequest<BidRequest>>> result = adopplerBidder.makeHttpRequests(bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).isEmpty();\n+        assertThat(result.getValue().get(0).getHeaders()).isNotNull()\n+                .extracting(Map.Entry::getKey, Map.Entry::getValue)\n+                .containsOnly(tuple(\"x-openrtb-version\", \"2.5\"),\n+                        tuple(HttpUtil.CONTENT_TYPE_HEADER.toString(), HttpUtil.APPLICATION_JSON_CONTENT_TYPE),\n+                        tuple(HttpUtil.ACCEPT_HEADER.toString(), HttpHeaderValues.APPLICATION_JSON.toString()));\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfResponseBodyCouldNotBeParsed() {\n+        // given\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(null, \"invalid\");\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, null);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage()).startsWith(\"invalid body:\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfDuplicateId() throws JsonProcessingException {\n+        // given\n+        Imp imp1 = Imp.builder().id(\"impId\").banner(Banner.builder().build()).build();\n+        Imp imp2 = Imp.builder().id(\"impId\").video(Video.builder().build()).build();\n+        List imps = new ArrayList();\n+        imps.add(imp1);\n+        imps.add(imp2);\n+        BidRequest bidRequest = BidRequest.builder()\n+                .imp(imps)\n+                .build();\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                bidRequest, mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"duplicate $.imp.id impId\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfEmptyImp() throws JsonProcessingException {\n+        // given\n+        BidRequest bidRequest = BidRequest.builder()\n+                .imp(singletonList(Imp.builder().id(\"123\")\n+                        .banner(null)\n+                        .video(null)\n+                        .audio(null)\n+                        .xNative(null)\n+                        .build()))\n+                .build();\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                bidRequest, mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(\"123\"))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfBidIdEmpty() throws JsonProcessingException {\n+        // given\n+        BidRequest bidRequest = BidRequest.builder()\n+                .imp(singletonList(Imp.builder().id(\"123\")\n+                        .banner(Banner.builder().build())\n+                        .build()))\n+                .build();\n+        final HttpCall<BidRequest> httpCall = givenHttpCall(\n+                bidRequest, mapper.writeValueAsString(\n+                        givenBidResponse(bidBuilder -> bidBuilder.impid(null))));\n+\n+        // when\n+        final Result<List<BidderBid>> result = adopplerBidder.makeBids(httpCall, bidRequest);\n+\n+        // then\n+        assertThat(result.getErrors()).hasSize(1);\n+        assertThat(result.getErrors().get(0).getMessage())\n+                .startsWith(\"unknown impid: null\");\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getValue()).isEmpty();\n+    }\n+\n+    @Test\n+    public void makeBidsShouldReturnErrorIfExtEmpty() throws JsonProcessingException {\n+        // given\n+        Imp imp = Imp.builder().id(\"impId\").video(Video.builder().build()).build();\n+        List imps = new ArrayList();\n+        imps.add(imp);\n+        BidRequest bidRequest = BidRequest.builder().imp(imps).build();", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ5MDM5Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r396490393", "bodyText": "final", "author": "DGarbar", "createdAt": "2020-03-23T14:26:21Z", "path": "src/test/java/org/prebid/server/it/AdopplerTest.java", "diffHunk": "@@ -0,0 +1,55 @@\n+package org.prebid.server.it;\n+\n+import io.restassured.response.Response;\n+import java.io.IOException;\n+import org.json.JSONException;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+import org.skyscreamer.jsonassert.JSONCompareMode;\n+import org.springframework.test.context.junit4.SpringRunner;\n+\n+import static com.github.tomakehurst.wiremock.client.WireMock.aResponse;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalTo;\n+import static com.github.tomakehurst.wiremock.client.WireMock.equalToJson;\n+import static com.github.tomakehurst.wiremock.client.WireMock.post;\n+import static com.github.tomakehurst.wiremock.client.WireMock.urlPathEqualTo;\n+import static io.restassured.RestAssured.given;\n+import static java.util.Collections.singletonList;\n+\n+@RunWith(SpringRunner.class)\n+public class AdopplerTest extends IntegrationTest {\n+\n+    @Test\n+    public void openrtb2AuctionShouldRespondWithBidsFromAdoppler() throws IOException, JSONException {\n+        // given\n+        // Adoppler bid response for imp 001\n+        wireMockRule.stubFor(post(urlPathEqualTo(\"/adoppler-exchange\"))\n+                .withHeader(\"Accept\", equalTo(\"application/json\"))\n+                .withHeader(\"Content-Type\", equalTo(\"application/json;charset=UTF-8\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/adoppler/test-adoppler-bid-request-1.json\")))\n+                .willReturn(aResponse().withBody(jsonFrom(\"openrtb2/adoppler/test-adoppler-bid-response-1.json\"))));\n+\n+        // pre-bid cache\n+        wireMockRule.stubFor(post(urlPathEqualTo(\"/cache\"))\n+                .withRequestBody(equalToJson(jsonFrom(\"openrtb2/adoppler/test-cache-adoppler-request.json\")))\n+                .willReturn(aResponse().withBody(jsonFrom(\"openrtb2/adoppler/test-cache-adoppler-response.json\"))));\n+\n+        // when\n+        final Response response = given(spec)\n+                .header(\"Referer\", \"http://www.example.com\")\n+                .header(\"X-Forwarded-For\", \"193.168.244.1\")\n+                .header(\"User-Agent\", \"userAgent\")\n+                .header(\"Origin\", \"http://www.example.com\")\n+                .cookie(\"uids\", \"eyJ1aWRzIjp7ImdhbW9zaGkiOiJHTS1VSUQifX0=\")\n+                .body(jsonFrom(\"openrtb2/adoppler/test-auction-adoppler-request.json\"))\n+                .post(\"/openrtb2/auction\");\n+\n+        // then\n+        final String expectedAuctionResponse = openrtbAuctionResponseFrom(\n+                \"openrtb2/adoppler/test-auction-adoppler-response.json\",\n+                response, singletonList(\"adoppler\"));\n+        String actualStr = response.asString();", "originalCommit": "973f3b99c0e0af4d2714e245a06fbc925a05c4e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0dbfc2e6098e329307da02905d4d819e912a0d14", "url": "https://github.com/prebid/prebid-server-java/commit/0dbfc2e6098e329307da02905d4d819e912a0d14", "message": "Refactoring bidder and tests", "committedDate": "2020-03-27T22:52:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3MDE0OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402170149", "bodyText": "Notice that they used url.PathEscape so you need to use appropriate method in HttpUtils for .getAnunit", "author": "DGarbar", "createdAt": "2020-04-02T09:18:58Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -60,17 +61,8 @@ public AdopplerBidder(String endpointUrl, JacksonMapper mapper) {\n                 final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n                 final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n                 final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n-                final BidRequest outgoingRequest = updateRequest.toBuilder().imp(Collections\n-                        .singletonList(imp)).build();\n-                final String body = mapper.encode(outgoingRequest);\n-                final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n-                result.add(HttpRequest.<BidRequest>builder()\n-                        .method(HttpMethod.POST)\n-                        .uri(endpointUrl)\n-                        .headers(headers)\n-                        .payload(outgoingRequest)\n-                        .body(body)\n-                        .build());\n+                final String url = endpointUrl + \"/processHeaderBid/\" + validExtImp.getAdunit();", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3MzE3MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402173171", "bodyText": "redundant", "author": "DGarbar", "createdAt": "2020-04-02T09:23:53Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -110,11 +115,38 @@ private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n             return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n                     e.getMessage())));\n         }\n+        final Map<String, BidType> impTypes;\n+        final List<BidderBid> bidderBids;", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3MzUwNg==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402173506", "bodyText": "can be in try block", "author": "DGarbar", "createdAt": "2020-04-02T09:24:24Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -110,11 +115,38 @@ private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n             return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n                     e.getMessage())));\n         }\n+        final Map<String, BidType> impTypes;\n+        final List<BidderBid> bidderBids;\n+        try {\n+            impTypes = getImpTypes(bidRequest);\n+            bidderBids = getBids(bidResponse, impTypes);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+        return Result.of(bidderBids, Collections.emptyList());", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3NjQyOA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402176428", "bodyText": "try {\n            bidResponse = decodeBodyToBidResponse(httpCall);\n        } catch (PreBidException e) {\n            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n                    e.getMessage())));\n        }\n\nCan use same try block\nAnd code will be much cleaner", "author": "DGarbar", "createdAt": "2020-04-02T09:29:16Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -110,11 +115,38 @@ private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n             return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n                     e.getMessage())));\n         }\n+        final Map<String, BidType> impTypes;\n+        final List<BidderBid> bidderBids;\n+        try {\n+            impTypes = getImpTypes(bidRequest);\n+            bidderBids = getBids(bidResponse, impTypes);", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE3NjkzNA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402176934", "bodyText": "This is used later in the code", "author": "DGarbar", "createdAt": "2020-04-02T09:30:00Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -110,11 +115,38 @@ private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n             return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n                     e.getMessage())));\n         }\n+        final Map<String, BidType> impTypes;\n+        final List<BidderBid> bidderBids;\n+        try {\n+            impTypes = getImpTypes(bidRequest);\n+            bidderBids = getBids(bidResponse, impTypes);\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+        return Result.of(bidderBids, Collections.emptyList());\n+    }\n \n+    private BidResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n+        try {\n+            return mapper.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private AdopplerResponseExt parseResponseExt(ObjectNode ext) {\n+        try {\n+            return mapper.mapper().treeToValue(ext, AdopplerResponseExt.class);\n+        } catch (JsonProcessingException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4NTk5OA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402185998", "bodyText": "You did not set anything. You just return this value. Rename method.", "author": "DGarbar", "createdAt": "2020-04-02T09:44:51Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -125,54 +157,46 @@ private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n             } else if (imp.getXNative() != null) {\n                 impTypes.put(imp.getId(), BidType.xNative);\n             } else {\n-                return Result.emptyWithError(BidderError.badInput(String.format(\n-                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+                throw new PreBidException(\"one of $.imp.banner, $.imp.video, $.imp.audio \"\n+                        + \"and $.imp.native field required\");\n             }\n         }\n+        return impTypes;\n+    }\n \n+    private List<BidderBid> getBids(BidResponse bidResponse, Map<String, BidType> impTypes) {\n         final List<BidderBid> bidderBids = new ArrayList<>();\n         for (SeatBid seatBid : bidResponse.getSeatbid()) {\n             for (Bid bid : seatBid.getBid()) {\n                 if (impTypes.get(bid.getImpid()) == null) {\n-                    return Result.emptyWithError(BidderError\n-                            .badServerResponse(String.format(\"unknown impid: %s\", bid.getImpid())));\n-                }\n-                final AdopplerResponseExt adopplerResponseExt;\n-                if (impTypes.get(bid.getImpid()) == BidType.video) {\n-                    final ObjectNode ext = bid.getExt();\n-                    try {\n-                        adopplerResponseExt = parseResponseExt(ext);\n-                    } catch (PreBidException e) {\n-                        return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n-                    }\n-                    final AdopplerResponseVideoExt adopplerResponseVideoExt = adopplerResponseExt.getAds();\n-                    if ((adopplerResponseExt == null) || (adopplerResponseVideoExt == null)) {\n-                        return Result.emptyWithError(BidderError.badServerResponse(String\n-                                .format(\"$.seatbid.bid.ext.ads.video required\")));\n-                    }\n-                    ExtBidPrebidVideo.of(adopplerResponseVideoExt.getVideo().getDuration(), head(bid.getCat()));\n+                    throw new PreBidException(String.format(\"unknown impid: %s\", bid.getImpid()));\n                 }\n+                setExtBidPrebidVideo(bid, impTypes);", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4NzE5NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402187195", "bodyText": "getBids Can be replaced\n bidResponse.getSeatbid().stream()\n                .filter(Objects::nonNull)\n                .map(SeatBid::getBid)\n                .filter(Objects::nonNull)\n                .flatMap(Collection::stream)\n                .map(bid -> TODO createBid())\n                .collect(Collectors.toList())", "author": "DGarbar", "createdAt": "2020-04-02T09:46:56Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -110,11 +115,38 @@ private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n             return Result.emptyWithError(BidderError.badServerResponse(String.format(\"invalid body: %s\",\n                     e.getMessage())));\n         }\n+        final Map<String, BidType> impTypes;\n+        final List<BidderBid> bidderBids;\n+        try {\n+            impTypes = getImpTypes(bidRequest);\n+            bidderBids = getBids(bidResponse, impTypes);", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4ODA0Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402188042", "bodyText": "Do you really need catch to throw SIMILAR exception ?", "author": "DGarbar", "createdAt": "2020-04-02T09:48:20Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -125,54 +157,46 @@ private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n             } else if (imp.getXNative() != null) {\n                 impTypes.put(imp.getId(), BidType.xNative);\n             } else {\n-                return Result.emptyWithError(BidderError.badInput(String.format(\n-                        \"one of $.imp.banner, $.imp.video, $.imp.audio and $.imp.native field required\")));\n+                throw new PreBidException(\"one of $.imp.banner, $.imp.video, $.imp.audio \"\n+                        + \"and $.imp.native field required\");\n             }\n         }\n+        return impTypes;\n+    }\n \n+    private List<BidderBid> getBids(BidResponse bidResponse, Map<String, BidType> impTypes) {\n         final List<BidderBid> bidderBids = new ArrayList<>();\n         for (SeatBid seatBid : bidResponse.getSeatbid()) {\n             for (Bid bid : seatBid.getBid()) {\n                 if (impTypes.get(bid.getImpid()) == null) {\n-                    return Result.emptyWithError(BidderError\n-                            .badServerResponse(String.format(\"unknown impid: %s\", bid.getImpid())));\n-                }\n-                final AdopplerResponseExt adopplerResponseExt;\n-                if (impTypes.get(bid.getImpid()) == BidType.video) {\n-                    final ObjectNode ext = bid.getExt();\n-                    try {\n-                        adopplerResponseExt = parseResponseExt(ext);\n-                    } catch (PreBidException e) {\n-                        return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n-                    }\n-                    final AdopplerResponseVideoExt adopplerResponseVideoExt = adopplerResponseExt.getAds();\n-                    if ((adopplerResponseExt == null) || (adopplerResponseVideoExt == null)) {\n-                        return Result.emptyWithError(BidderError.badServerResponse(String\n-                                .format(\"$.seatbid.bid.ext.ads.video required\")));\n-                    }\n-                    ExtBidPrebidVideo.of(adopplerResponseVideoExt.getVideo().getDuration(), head(bid.getCat()));\n+                    throw new PreBidException(String.format(\"unknown impid: %s\", bid.getImpid()));\n                 }\n+                setExtBidPrebidVideo(bid, impTypes);\n                 final BidderBid bidderBid = BidderBid.of(bid, impTypes.get(bid.getImpid()), DEFAULT_BID_CURRENCY);\n                 bidderBids.add(bidderBid);\n             }\n         }\n-        return Result.of(bidderBids, Collections.emptyList());\n-    }\n-\n-    private BidResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n-        try {\n-            return mapper.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n-        } catch (DecodeException e) {\n-            throw new PreBidException(e.getMessage(), e);\n-        }\n+        return bidderBids;\n     }\n \n-    private AdopplerResponseExt parseResponseExt(ObjectNode ext) {\n-        try {\n-            return mapper.mapper().treeToValue(ext, AdopplerResponseExt.class);\n-        } catch (JsonProcessingException e) {\n-            throw new PreBidException(e.getMessage(), e);\n+    private ExtBidPrebidVideo setExtBidPrebidVideo(Bid bid, Map<String, BidType> impTypes) {\n+        final AdopplerResponseExt adopplerResponseExt;\n+        if (impTypes.get(bid.getImpid()) == BidType.video) {\n+            final ObjectNode ext = bid.getExt();\n+            try {\n+                adopplerResponseExt = parseResponseExt(ext);\n+            } catch (PreBidException e) {\n+                throw new PreBidException(e.getMessage());\n+            }", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4ODc0OA==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402188748", "bodyText": "style\n\ncant you just add /processHeaderBid/adUnit to ENDPOINT_URL ?", "author": "DGarbar", "createdAt": "2020-04-02T09:49:31Z", "path": "src/test/java/org/prebid/server/bidder/adoppler/AdopplerBidderTest.java", "diffHunk": "@@ -84,7 +84,7 @@ public void makeHttpRequestsShouldCreateCorrectURL() {\n         // then\n         assertThat(result.getErrors()).isEmpty();\n         assertThat(result.getValue()).hasSize(1);\n-        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL);\n+        assertThat(result.getValue().get(0).getUri()).isEqualTo(ENDPOINT_URL+\"/processHeaderBid/adUnit\");", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU2MDY1Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402560656", "bodyText": "That will be incorrect", "author": "AndriyPavlyuk", "createdAt": "2020-04-02T19:30:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4ODc0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE4OTI1OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r402189259", "bodyText": "use singletonList", "author": "DGarbar", "createdAt": "2020-04-02T09:50:26Z", "path": "src/test/java/org/prebid/server/bidder/adoppler/AdopplerBidderTest.java", "diffHunk": "@@ -190,17 +190,17 @@ public void makeBidsShouldReturnErrorIfBidIdEmpty() throws JsonProcessingExcepti\n         assertThat(result.getErrors()).hasSize(1);\n         assertThat(result.getErrors().get(0).getMessage())\n                 .startsWith(\"unknown impid: null\");\n-        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_server_response);\n+        assertThat(result.getErrors().get(0).getType()).isEqualTo(BidderError.Type.bad_input);\n         assertThat(result.getValue()).isEmpty();\n     }\n \n     @Test\n     public void makeBidsShouldReturnErrorIfExtEmpty() throws JsonProcessingException {\n         // given\n-        Imp imp = Imp.builder().id(\"impId\").video(Video.builder().build()).build();\n-        List imps = new ArrayList();\n+        final Imp imp = Imp.builder().id(\"impId\").video(Video.builder().build()).build();\n+        final List imps = new ArrayList();", "originalCommit": "0dbfc2e6098e329307da02905d4d819e912a0d14", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7342554ae76383341dce0ff8984ca27d7f37cef8", "url": "https://github.com/prebid/prebid-server-java/commit/7342554ae76383341dce0ff8984ca27d7f37cef8", "message": "Refactoring code and tests", "committedDate": "2020-04-02T19:35:34Z", "type": "commit"}, {"oid": "97ce94c38173d05c6ba9ff82a2fc0428473d68cb", "url": "https://github.com/prebid/prebid-server-java/commit/97ce94c38173d05c6ba9ff82a2fc0428473d68cb", "message": "Merge branch 'master' into add-adoppler-bidder", "committedDate": "2020-04-03T14:45:35Z", "type": "commit"}, {"oid": "f90d2da42004465e89f1107b5f15763b3306fe57", "url": "https://github.com/prebid/prebid-server-java/commit/f90d2da42004465e89f1107b5f15763b3306fe57", "message": "Checkstyle update", "committedDate": "2020-04-03T15:00:45Z", "type": "commit"}, {"oid": "e3906d7b1ac5c79d802e9735c375dfd5841bfc8e", "url": "https://github.com/prebid/prebid-server-java/commit/e3906d7b1ac5c79d802e9735c375dfd5841bfc8e", "message": "Merge branch 'master' into add-adoppler-bidder", "committedDate": "2020-04-13T18:59:23Z", "type": "commit"}, {"oid": "6cf221150f65902e15b78c90ede48e40cc6fe4f7", "url": "https://github.com/prebid/prebid-server-java/commit/6cf221150f65902e15b78c90ede48e40cc6fe4f7", "message": "Merge to master and add link", "committedDate": "2020-04-13T19:14:25Z", "type": "commit"}, {"oid": "6eced2892140359f4951d135f429093f99e40d0b", "url": "https://github.com/prebid/prebid-server-java/commit/6eced2892140359f4951d135f429093f99e40d0b", "message": "Add buyeruid to test json", "committedDate": "2020-04-21T15:35:47Z", "type": "commit"}, {"oid": "5a2f4881fc6c3aefa90600cc3c6ba3790ab48f3c", "url": "https://github.com/prebid/prebid-server-java/commit/5a2f4881fc6c3aefa90600cc3c6ba3790ab48f3c", "message": "Merge branch 'master' into add-adoppler-bidder", "committedDate": "2020-05-13T13:06:26Z", "type": "commit"}, {"oid": "90e360f917ee63c7ca18d11874e7a4a3dbab5e26", "url": "https://github.com/prebid/prebid-server-java/commit/90e360f917ee63c7ca18d11874e7a4a3dbab5e26", "message": "Merge branch 'master' into add-adoppler-bidder", "committedDate": "2020-06-04T09:56:10Z", "type": "commit"}, {"oid": "24985411e4776926675d5c93cefb1c7c2860a91d", "url": "https://github.com/prebid/prebid-server-java/commit/24985411e4776926675d5c93cefb1c7c2860a91d", "message": "Fixes after review", "committedDate": "2020-06-04T09:58:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTEzNzk4NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/637#discussion_r435137985", "bodyText": "What is the reason for this method?\nThe returned value is not used anywhere.", "author": "rpanchyk", "createdAt": "2020-06-04T10:02:20Z", "path": "src/main/java/org/prebid/server/bidder/adoppler/AdopplerBidder.java", "diffHunk": "@@ -0,0 +1,204 @@\n+package org.prebid.server.bidder.adoppler;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.Bid;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoAdsExt;\n+import org.prebid.server.bidder.adoppler.model.AdopplerResponseVideoExt;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.adoppler.ExtImpAdoppler;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.proto.openrtb.ext.response.ExtBidPrebidVideo;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Adoppler {@link Bidder} implementation.\n+ */\n+public class AdopplerBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpAdoppler>> ADOPPLER_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpAdoppler>>() {\n+            };\n+\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+\n+    private final String endpointTemplate;\n+    private final JacksonMapper mapper;\n+\n+    public AdopplerBidder(String endpointTemplate, JacksonMapper mapper) {\n+        this.endpointTemplate = HttpUtil.validateUrl(Objects.requireNonNull(endpointTemplate));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        final List<HttpRequest<BidRequest>> result = new ArrayList<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpAdoppler validExtImp = parseAndValidateImpExt(imp);\n+                final String updateRequestId = request.getId() + \"-\" + validExtImp.getAdunit();\n+                final BidRequest updateRequest = request.toBuilder().id(updateRequestId).build();\n+                final String uri = String.format(\"%s/processHeaderBid/%s\", endpointTemplate,\n+                        HttpUtil.encodeUrl(validExtImp.getAdunit()));\n+                result.add(createSingleRequest(imp, updateRequest, uri));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+        return Result.of(result, errors);\n+    }\n+\n+    private ExtImpAdoppler parseAndValidateImpExt(Imp imp) {\n+        final ExtImpAdoppler extImpAdoppler;\n+        try {\n+            extImpAdoppler = mapper.mapper().convertValue(imp.getExt(), ADOPPLER_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+        if (StringUtils.isBlank(extImpAdoppler.getAdunit())) {\n+            throw new PreBidException(\"$.imp.ext.adoppler.adunit required\");\n+        }\n+        return extImpAdoppler;\n+    }\n+\n+    private HttpRequest<BidRequest> createSingleRequest(Imp imp, BidRequest request, String url) {\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+        final String body = mapper.encode(outgoingRequest);\n+        final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+        return HttpRequest.<BidRequest>builder()\n+                .method(HttpMethod.POST)\n+                .uri(url)\n+                .headers(headers)\n+                .body(body)\n+                .payload(outgoingRequest)\n+                .build();\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"bad request\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        try {\n+            final BidResponse bidResponse = decodeBodyToBidResponse(httpCall);\n+            final Map<String, BidType> impTypes = getImpTypes(bidRequest);\n+            final List<BidderBid> bidderBids = bidResponse.getSeatbid().stream()\n+                    .filter(Objects::nonNull)\n+                    .map(SeatBid::getBid)\n+                    .filter(Objects::nonNull)\n+                    .flatMap(Collection::stream)\n+                    .map(bid -> createBid(bid, impTypes))\n+                    .collect(Collectors.toList());\n+            return Result.of(bidderBids, Collections.emptyList());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+    }\n+\n+    private BidResponse decodeBodyToBidResponse(HttpCall<BidRequest> httpCall) {\n+        try {\n+            return mapper.decodeValue(httpCall.getResponse().getBody(), BidResponse.class);\n+        } catch (DecodeException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private Map<String, BidType> getImpTypes(BidRequest bidRequest) {\n+        final Map<String, BidType> impTypes = new HashMap<>();\n+        for (Imp imp : bidRequest.getImp()) {\n+            if (impTypes.get(imp.getId()) != null) {\n+                throw new PreBidException(String.format(\"duplicate $.imp.id %s\", imp.getId()));\n+            }\n+            if (imp.getBanner() != null) {\n+                impTypes.put(imp.getId(), BidType.banner);\n+            } else if (imp.getVideo() != null) {\n+                impTypes.put(imp.getId(), BidType.video);\n+            } else if (imp.getAudio() != null) {\n+                impTypes.put(imp.getId(), BidType.audio);\n+            } else if (imp.getXNative() != null) {\n+                impTypes.put(imp.getId(), BidType.xNative);\n+            } else {\n+                throw new PreBidException(\"one of $.imp.banner, $.imp.video, $.imp.audio \"\n+                        + \"and $.imp.native field required\");\n+            }\n+        }\n+        return impTypes;\n+    }\n+\n+    private BidderBid createBid(Bid bid, Map<String, BidType> impTypes) {\n+        if (impTypes.get(bid.getImpid()) == null) {\n+            throw new PreBidException(String.format(\"unknown impid: %s\", bid.getImpid()));\n+        }\n+        getExtBidPrebidVideo(bid, impTypes);\n+        return BidderBid.of(bid, impTypes.get(bid.getImpid()), DEFAULT_BID_CURRENCY);\n+    }\n+\n+    private ExtBidPrebidVideo getExtBidPrebidVideo(Bid bid, Map<String, BidType> impTypes) {", "originalCommit": "24985411e4776926675d5c93cefb1c7c2860a91d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8db7281914b97075afdeb81100d5ebdd2da02cfb", "url": "https://github.com/prebid/prebid-server-java/commit/8db7281914b97075afdeb81100d5ebdd2da02cfb", "message": "Add validation of Response video extention", "committedDate": "2020-06-04T11:51:42Z", "type": "commit"}, {"oid": "7120e3e31a76856aa109bf1a0535fbd128bd8068", "url": "https://github.com/prebid/prebid-server-java/commit/7120e3e31a76856aa109bf1a0535fbd128bd8068", "message": "Merge remote-tracking branch 'internal-github/add-adoppler-bidder' into add-adoppler-bidder", "committedDate": "2020-06-04T11:52:14Z", "type": "commit"}]}