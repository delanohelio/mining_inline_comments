{"pr_number": 940, "pr_title": "Add Between bidder.", "pr_createdAt": "2020-10-05T10:21:32Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/940", "timeline": [{"oid": "8f17ca6cc7313b675b84e48a2e68c35c859c844f", "url": "https://github.com/prebid/prebid-server-java/commit/8f17ca6cc7313b675b84e48a2e68c35c859c844f", "message": "Add Between bidder.", "committedDate": "2020-10-05T10:53:58Z", "type": "forcePushed"}, {"oid": "f9ea38b443fae8054c3d9c27869ea9540a381318", "url": "https://github.com/prebid/prebid-server-java/commit/f9ea38b443fae8054c3d9c27869ea9540a381318", "message": "Add Between bidder.", "committedDate": "2020-10-05T10:56:12Z", "type": "forcePushed"}, {"oid": "a28a0e919718dabdaf2b26caf32e9e6db51d1878", "url": "https://github.com/prebid/prebid-server-java/commit/a28a0e919718dabdaf2b26caf32e9e6db51d1878", "message": "Add Between bidder.", "committedDate": "2020-10-05T11:03:52Z", "type": "commit"}, {"oid": "a28a0e919718dabdaf2b26caf32e9e6db51d1878", "url": "https://github.com/prebid/prebid-server-java/commit/a28a0e919718dabdaf2b26caf32e9e6db51d1878", "message": "Add Between bidder.", "committedDate": "2020-10-05T11:03:52Z", "type": "forcePushed"}, {"oid": "800efd64145c932597ae5933366c8e3d35946d0a", "url": "https://github.com/prebid/prebid-server-java/commit/800efd64145c932597ae5933366c8e3d35946d0a", "message": "Fixes after review", "committedDate": "2020-10-25T00:12:11Z", "type": "forcePushed"}, {"oid": "611313cccb12e8ead48ca0b496aa7fb49fa2c361", "url": "https://github.com/prebid/prebid-server-java/commit/611313cccb12e8ead48ca0b496aa7fb49fa2c361", "message": "Fixes", "committedDate": "2020-10-25T00:21:08Z", "type": "commit"}, {"oid": "7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "url": "https://github.com/prebid/prebid-server-java/commit/7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "message": "Merge branch 'master' into between_bidder/development", "committedDate": "2020-10-25T00:22:08Z", "type": "commit"}, {"oid": "7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "url": "https://github.com/prebid/prebid-server-java/commit/7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "message": "Merge branch 'master' into between_bidder/development", "committedDate": "2020-10-25T00:22:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMjI3Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/940#discussion_r511932276", "bodyText": "Minor. Empty line redundant.", "author": "rpanchyk", "createdAt": "2020-10-26T12:46:25Z", "path": "src/main/java/org/prebid/server/bidder/between/BetweenBidder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.prebid.server.bidder.between;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.between.ExtImpBetween;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Between {@link Bidder} implementation.\n+ */\n+public class BetweenBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpBetween>> BETWEEN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpBetween>>() {\n+            };\n+    private static final String URL_HOST_MACRO = \"{{Host}}\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public BetweenBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+", "originalCommit": "7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMzUwNA==", "url": "https://github.com/prebid/prebid-server-java/pull/940#discussion_r511933504", "bodyText": "Pls put this method after makeHttpRequests(..) according to the call order.", "author": "rpanchyk", "createdAt": "2020-10-26T12:48:39Z", "path": "src/main/java/org/prebid/server/bidder/between/BetweenBidder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.prebid.server.bidder.between;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.between.ExtImpBetween;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Between {@link Bidder} implementation.\n+ */\n+public class BetweenBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpBetween>> BETWEEN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpBetween>>() {\n+            };\n+    private static final String URL_HOST_MACRO = \"{{Host}}\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public BetweenBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final Map<Imp, ExtImpBetween> validImpsWithExts = new HashMap<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpBetween extImpBetween = parseImpExt(imp);\n+                validImpsWithExts.put(imp, extImpBetween);\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (validImpsWithExts.size() == 0) {\n+            return Result.emptyWithError(BidderError.badInput(\"No valid Imps in Bid Request\"));\n+        }\n+\n+        final List<HttpRequest<BidRequest>> madeRequests = new ArrayList<>();\n+\n+        for (Map.Entry<Imp, ExtImpBetween> entry : validImpsWithExts.entrySet()) {\n+            madeRequests.add(makeSingleRequest(entry.getValue(), request, entry.getKey()));\n+        }\n+\n+        return Result.of(madeRequests, errors);\n+    }\n+\n+    private HttpRequest<BidRequest> makeSingleRequest(ExtImpBetween extImpBetween, BidRequest request, Imp imp) {\n+\n+        final String url = endpointUrl.replace(URL_HOST_MACRO, extImpBetween.getHost());\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        return\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(HttpUtil.headers())\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build();\n+    }\n+\n+    private ExtImpBetween parseImpExt(Imp imp) {", "originalCommit": "7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzNTM5Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/940#discussion_r511935396", "bodyText": "Personally i don't like StringUtils.isBlank(..) but seems here it is more desirable.", "author": "rpanchyk", "createdAt": "2020-10-26T12:51:51Z", "path": "src/main/java/org/prebid/server/bidder/between/BetweenBidder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.prebid.server.bidder.between;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.between.ExtImpBetween;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Between {@link Bidder} implementation.\n+ */\n+public class BetweenBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpBetween>> BETWEEN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpBetween>>() {\n+            };\n+    private static final String URL_HOST_MACRO = \"{{Host}}\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public BetweenBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final Map<Imp, ExtImpBetween> validImpsWithExts = new HashMap<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpBetween extImpBetween = parseImpExt(imp);\n+                validImpsWithExts.put(imp, extImpBetween);\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (validImpsWithExts.size() == 0) {\n+            return Result.emptyWithError(BidderError.badInput(\"No valid Imps in Bid Request\"));\n+        }\n+\n+        final List<HttpRequest<BidRequest>> madeRequests = new ArrayList<>();\n+\n+        for (Map.Entry<Imp, ExtImpBetween> entry : validImpsWithExts.entrySet()) {\n+            madeRequests.add(makeSingleRequest(entry.getValue(), request, entry.getKey()));\n+        }\n+\n+        return Result.of(madeRequests, errors);\n+    }\n+\n+    private HttpRequest<BidRequest> makeSingleRequest(ExtImpBetween extImpBetween, BidRequest request, Imp imp) {\n+\n+        final String url = endpointUrl.replace(URL_HOST_MACRO, extImpBetween.getHost());\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        return\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(HttpUtil.headers())\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build();\n+    }\n+\n+    private ExtImpBetween parseImpExt(Imp imp) {\n+        final ExtImpBetween extImpBetween;\n+        try {\n+            extImpBetween = mapper.mapper().convertValue(imp.getExt(), BETWEEN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(String.format(\"Missing bidder ext: %s\", e.getMessage()));\n+        }\n+        if (StringUtils.isEmpty(extImpBetween.getHost())) {", "originalCommit": "7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzNTc1OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/940#discussion_r511935759", "bodyText": "Would be nice to see the imp ID in error message.", "author": "rpanchyk", "createdAt": "2020-10-26T12:52:28Z", "path": "src/main/java/org/prebid/server/bidder/between/BetweenBidder.java", "diffHunk": "@@ -0,0 +1,151 @@\n+package org.prebid.server.bidder.between;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.between.ExtImpBetween;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Between {@link Bidder} implementation.\n+ */\n+public class BetweenBidder implements Bidder<BidRequest> {\n+\n+    private static final TypeReference<ExtPrebid<?, ExtImpBetween>> BETWEEN_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpBetween>>() {\n+            };\n+    private static final String URL_HOST_MACRO = \"{{Host}}\";\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public BetweenBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest request) {\n+\n+        final List<BidderError> errors = new ArrayList<>();\n+        final Map<Imp, ExtImpBetween> validImpsWithExts = new HashMap<>();\n+\n+        for (Imp imp : request.getImp()) {\n+            try {\n+                final ExtImpBetween extImpBetween = parseImpExt(imp);\n+                validImpsWithExts.put(imp, extImpBetween);\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (validImpsWithExts.size() == 0) {\n+            return Result.emptyWithError(BidderError.badInput(\"No valid Imps in Bid Request\"));\n+        }\n+\n+        final List<HttpRequest<BidRequest>> madeRequests = new ArrayList<>();\n+\n+        for (Map.Entry<Imp, ExtImpBetween> entry : validImpsWithExts.entrySet()) {\n+            madeRequests.add(makeSingleRequest(entry.getValue(), request, entry.getKey()));\n+        }\n+\n+        return Result.of(madeRequests, errors);\n+    }\n+\n+    private HttpRequest<BidRequest> makeSingleRequest(ExtImpBetween extImpBetween, BidRequest request, Imp imp) {\n+\n+        final String url = endpointUrl.replace(URL_HOST_MACRO, extImpBetween.getHost());\n+        final BidRequest outgoingRequest = request.toBuilder().imp(Collections.singletonList(imp)).build();\n+\n+        return\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(url)\n+                        .headers(HttpUtil.headers())\n+                        .payload(outgoingRequest)\n+                        .body(mapper.encode(outgoingRequest))\n+                        .build();\n+    }\n+\n+    private ExtImpBetween parseImpExt(Imp imp) {\n+        final ExtImpBetween extImpBetween;\n+        try {\n+            extImpBetween = mapper.mapper().convertValue(imp.getExt(), BETWEEN_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(String.format(\"Missing bidder ext: %s\", e.getMessage()));\n+        }\n+        if (StringUtils.isEmpty(extImpBetween.getHost())) {\n+            throw new PreBidException(\"Invalid/Missing Host\");", "originalCommit": "7ec8bc0eff5ffd5985d5d391f90e2b8d59274093", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "be1086c025b5c6ed586dcb651a16ef1ac85ff7c5", "url": "https://github.com/prebid/prebid-server-java/commit/be1086c025b5c6ed586dcb651a16ef1ac85ff7c5", "message": "Fixes after review", "committedDate": "2020-10-26T17:51:26Z", "type": "commit"}]}