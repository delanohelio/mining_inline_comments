{"pr_number": 726, "pr_title": "Add TelariaBidder implementation and tests", "pr_createdAt": "2020-05-20T16:46:38Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/726", "timeline": [{"oid": "94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "url": "https://github.com/prebid/prebid-server-java/commit/94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "message": "Add TelariaBidder implementation and tests", "committedDate": "2020-05-20T16:44:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI1MTIxMA==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r429251210", "bodyText": "They also validates for bidders, and checks that at least one has video", "author": "DGarbar", "createdAt": "2020-05-22T13:39:12Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -0,0 +1,212 @@\n+package org.prebid.server.bidder.telaria;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Publisher;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpOutTelaria;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpTelaria;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.Objects;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Collections;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class TelariaBidder implements Bidder<BidRequest> {\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final TypeReference<ExtPrebid<?, ExtImpTelaria>> TELARIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpTelaria>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public TelariaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest bidRequest) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"Telaria: Missing Imp Object\"));\n+        }\n+        try {\n+            validateImp(bidRequest.getImp());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final String publisherId = getPublisherId(bidRequest);\n+        String seatCode = null;\n+        final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder();\n+        for (Imp imp : bidRequest.getImp()) {\n+            try {\n+                final ExtImpTelaria extImp = parseImpExt(imp);\n+                if (StringUtils.isBlank(extImp.getSeatCode())) {\n+                    throw new PreBidException(\"Telaria: Seat Code required\");\n+                }\n+                seatCode = extImp.getSeatCode();\n+                requestBuilder\n+                        .imp(Collections.singletonList(imp.toBuilder()\n+                                .tagid(extImp.getAdCode())\n+                                .ext(mapper.mapper().valueToTree(ExtImpOutTelaria.of(imp.getTagid(), publisherId)))\n+                                .build()));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (bidRequest.getSite() != null) {\n+            modifySite(seatCode, bidRequest, requestBuilder);\n+        } else if (bidRequest.getApp() != null) {\n+            modifyApp(seatCode, bidRequest, requestBuilder);\n+        }\n+\n+        final BidRequest outgoingRequest = requestBuilder.build();\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers(bidRequest))\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build()),\n+                errors);\n+    }\n+\n+    private void validateImp(List<Imp> imps) {\n+        for (Imp imp : imps) {\n+            if (imp.getVideo() == null) {\n+                throw new PreBidException(\"Telaria: Only Supports Video\");\n+            }\n+        }\n+    }", "originalCommit": "94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI1MzAzMA==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r429253030", "bodyText": "They use break after any error. SO we can extract this into a separate method and remove list of errors. (method can return prepared imps)", "author": "DGarbar", "createdAt": "2020-05-22T13:42:23Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -0,0 +1,212 @@\n+package org.prebid.server.bidder.telaria;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Publisher;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpOutTelaria;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpTelaria;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.Objects;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Collections;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class TelariaBidder implements Bidder<BidRequest> {\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final TypeReference<ExtPrebid<?, ExtImpTelaria>> TELARIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpTelaria>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public TelariaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest bidRequest) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"Telaria: Missing Imp Object\"));\n+        }\n+        try {\n+            validateImp(bidRequest.getImp());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final String publisherId = getPublisherId(bidRequest);\n+        String seatCode = null;\n+        final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder();\n+        for (Imp imp : bidRequest.getImp()) {\n+            try {\n+                final ExtImpTelaria extImp = parseImpExt(imp);\n+                if (StringUtils.isBlank(extImp.getSeatCode())) {\n+                    throw new PreBidException(\"Telaria: Seat Code required\");\n+                }\n+                seatCode = extImp.getSeatCode();\n+                requestBuilder\n+                        .imp(Collections.singletonList(imp.toBuilder()\n+                                .tagid(extImp.getAdCode())\n+                                .ext(mapper.mapper().valueToTree(ExtImpOutTelaria.of(imp.getTagid(), publisherId)))\n+                                .build()));\n+            } catch (PreBidException e) {", "originalCommit": "94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI1NDM3NA==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r429254374", "bodyText": "You will override imps for each iteration. Bug", "author": "DGarbar", "createdAt": "2020-05-22T13:44:38Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -0,0 +1,212 @@\n+package org.prebid.server.bidder.telaria;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Publisher;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpOutTelaria;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpTelaria;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.Objects;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Collections;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class TelariaBidder implements Bidder<BidRequest> {\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final TypeReference<ExtPrebid<?, ExtImpTelaria>> TELARIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpTelaria>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public TelariaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest bidRequest) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"Telaria: Missing Imp Object\"));\n+        }\n+        try {\n+            validateImp(bidRequest.getImp());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final String publisherId = getPublisherId(bidRequest);\n+        String seatCode = null;\n+        final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder();\n+        for (Imp imp : bidRequest.getImp()) {\n+            try {\n+                final ExtImpTelaria extImp = parseImpExt(imp);\n+                if (StringUtils.isBlank(extImp.getSeatCode())) {\n+                    throw new PreBidException(\"Telaria: Seat Code required\");\n+                }\n+                seatCode = extImp.getSeatCode();\n+                requestBuilder\n+                        .imp(Collections.singletonList(imp.toBuilder()", "originalCommit": "94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI3NDM3NA==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r429274374", "bodyText": "try to avoid passing builders into methods.\nThis method can be reverted and return site or app", "author": "DGarbar", "createdAt": "2020-05-22T14:18:39Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -0,0 +1,212 @@\n+package org.prebid.server.bidder.telaria;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Publisher;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpOutTelaria;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpTelaria;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.Objects;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Collections;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class TelariaBidder implements Bidder<BidRequest> {\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final TypeReference<ExtPrebid<?, ExtImpTelaria>> TELARIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpTelaria>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public TelariaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest bidRequest) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"Telaria: Missing Imp Object\"));\n+        }\n+        try {\n+            validateImp(bidRequest.getImp());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final String publisherId = getPublisherId(bidRequest);\n+        String seatCode = null;\n+        final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder();\n+        for (Imp imp : bidRequest.getImp()) {\n+            try {\n+                final ExtImpTelaria extImp = parseImpExt(imp);\n+                if (StringUtils.isBlank(extImp.getSeatCode())) {\n+                    throw new PreBidException(\"Telaria: Seat Code required\");\n+                }\n+                seatCode = extImp.getSeatCode();\n+                requestBuilder\n+                        .imp(Collections.singletonList(imp.toBuilder()\n+                                .tagid(extImp.getAdCode())\n+                                .ext(mapper.mapper().valueToTree(ExtImpOutTelaria.of(imp.getTagid(), publisherId)))\n+                                .build()));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (bidRequest.getSite() != null) {\n+            modifySite(seatCode, bidRequest, requestBuilder);\n+        } else if (bidRequest.getApp() != null) {\n+            modifyApp(seatCode, bidRequest, requestBuilder);", "originalCommit": "94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI3NTcwOA==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r429275708", "bodyText": "Accept-Encoding\", \"gzip\"", "author": "DGarbar", "createdAt": "2020-05-22T14:20:52Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -0,0 +1,212 @@\n+package org.prebid.server.bidder.telaria;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Publisher;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpOutTelaria;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpTelaria;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.Objects;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Collections;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class TelariaBidder implements Bidder<BidRequest> {\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final TypeReference<ExtPrebid<?, ExtImpTelaria>> TELARIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpTelaria>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public TelariaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest bidRequest) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"Telaria: Missing Imp Object\"));\n+        }\n+        try {\n+            validateImp(bidRequest.getImp());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final String publisherId = getPublisherId(bidRequest);\n+        String seatCode = null;\n+        final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder();\n+        for (Imp imp : bidRequest.getImp()) {\n+            try {\n+                final ExtImpTelaria extImp = parseImpExt(imp);\n+                if (StringUtils.isBlank(extImp.getSeatCode())) {\n+                    throw new PreBidException(\"Telaria: Seat Code required\");\n+                }\n+                seatCode = extImp.getSeatCode();\n+                requestBuilder\n+                        .imp(Collections.singletonList(imp.toBuilder()\n+                                .tagid(extImp.getAdCode())\n+                                .ext(mapper.mapper().valueToTree(ExtImpOutTelaria.of(imp.getTagid(), publisherId)))\n+                                .build()));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (bidRequest.getSite() != null) {\n+            modifySite(seatCode, bidRequest, requestBuilder);\n+        } else if (bidRequest.getApp() != null) {\n+            modifyApp(seatCode, bidRequest, requestBuilder);\n+        }\n+\n+        final BidRequest outgoingRequest = requestBuilder.build();\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers(bidRequest))\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build()),\n+                errors);\n+    }\n+\n+    private void validateImp(List<Imp> imps) {\n+        for (Imp imp : imps) {\n+            if (imp.getVideo() == null) {\n+                throw new PreBidException(\"Telaria: Only Supports Video\");\n+            }\n+        }\n+    }\n+\n+    private String getPublisherId(BidRequest bidRequest) {\n+        if (bidRequest.getSite() != null && bidRequest.getSite().getPublisher() != null) {\n+            return bidRequest.getSite().getPublisher().getId();\n+        } else if (bidRequest.getApp() != null && bidRequest.getApp().getPublisher() != null) {\n+            return bidRequest.getApp().getPublisher().getId();\n+        }\n+        return \"\";\n+    }\n+\n+    private ExtImpTelaria parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), TELARIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private static void modifySite(String seatCode, BidRequest bidRequest,\n+                                   BidRequest.BidRequestBuilder bidRequestBuilder) {\n+        final Site site = bidRequest.getSite();\n+        if (site.getPublisher() != null) {\n+            final Publisher modifiedPublisher = site.getPublisher().toBuilder().id(seatCode).build();\n+            bidRequestBuilder.site(site.toBuilder().publisher(modifiedPublisher).build());\n+        }\n+    }\n+\n+    private static void modifyApp(String seatCode, BidRequest bidRequest,\n+                                  BidRequest.BidRequestBuilder bidRequestBuilder) {\n+        final App app = bidRequest.getApp();\n+        if (app.getPublisher() != null) {\n+            final Publisher modifiedPublisher = app.getPublisher().toBuilder().id(seatCode).build();\n+            bidRequestBuilder.app(app.toBuilder().publisher(modifiedPublisher).build());\n+        }\n+    }\n+\n+    private MultiMap headers(BidRequest bidRequest) {\n+        final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");", "originalCommit": "94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTI4ODU3NQ==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r429288575", "bodyText": "Are you sure that this will work for gzip ?", "author": "DGarbar", "createdAt": "2020-05-22T14:41:58Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -0,0 +1,212 @@\n+package org.prebid.server.bidder.telaria;\n+\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.iab.openrtb.request.BidRequest;\n+import com.iab.openrtb.request.App;\n+import com.iab.openrtb.request.Site;\n+import com.iab.openrtb.request.Imp;\n+import com.iab.openrtb.request.Publisher;\n+import com.iab.openrtb.request.Device;\n+import com.iab.openrtb.response.BidResponse;\n+import com.iab.openrtb.response.SeatBid;\n+import io.netty.handler.codec.http.HttpResponseStatus;\n+import io.vertx.core.MultiMap;\n+import io.vertx.core.buffer.Buffer;\n+import io.vertx.core.http.HttpMethod;\n+import org.apache.commons.collections4.CollectionUtils;\n+import org.apache.commons.lang3.StringUtils;\n+import org.prebid.server.bidder.Bidder;\n+import org.prebid.server.bidder.model.HttpCall;\n+import org.prebid.server.bidder.model.HttpResponse;\n+import org.prebid.server.bidder.model.HttpRequest;\n+import org.prebid.server.bidder.model.Result;\n+import org.prebid.server.bidder.model.BidderError;\n+import org.prebid.server.bidder.model.BidderBid;\n+import org.prebid.server.exception.PreBidException;\n+import org.prebid.server.json.DecodeException;\n+import org.prebid.server.json.JacksonMapper;\n+import org.prebid.server.proto.openrtb.ext.ExtPrebid;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpOutTelaria;\n+import org.prebid.server.proto.openrtb.ext.request.telaria.ExtImpTelaria;\n+import org.prebid.server.proto.openrtb.ext.response.BidType;\n+import org.prebid.server.util.HttpUtil;\n+\n+import java.util.Objects;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Collections;\n+import java.util.Collection;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public class TelariaBidder implements Bidder<BidRequest> {\n+    private static final String DEFAULT_BID_CURRENCY = \"USD\";\n+    private static final TypeReference<ExtPrebid<?, ExtImpTelaria>> TELARIA_EXT_TYPE_REFERENCE =\n+            new TypeReference<ExtPrebid<?, ExtImpTelaria>>() {\n+            };\n+\n+    private final String endpointUrl;\n+    private final JacksonMapper mapper;\n+\n+    public TelariaBidder(String endpointUrl, JacksonMapper mapper) {\n+        this.endpointUrl = HttpUtil.validateUrl(Objects.requireNonNull(endpointUrl));\n+        this.mapper = Objects.requireNonNull(mapper);\n+    }\n+\n+    @Override\n+    public Result<List<HttpRequest<BidRequest>>> makeHttpRequests(BidRequest bidRequest) {\n+        final List<BidderError> errors = new ArrayList<>();\n+        if (CollectionUtils.isEmpty(bidRequest.getImp())) {\n+            return Result.emptyWithError(BidderError.badInput(\"Telaria: Missing Imp Object\"));\n+        }\n+        try {\n+            validateImp(bidRequest.getImp());\n+        } catch (PreBidException e) {\n+            return Result.emptyWithError(BidderError.badInput(e.getMessage()));\n+        }\n+\n+        final String publisherId = getPublisherId(bidRequest);\n+        String seatCode = null;\n+        final BidRequest.BidRequestBuilder requestBuilder = bidRequest.toBuilder();\n+        for (Imp imp : bidRequest.getImp()) {\n+            try {\n+                final ExtImpTelaria extImp = parseImpExt(imp);\n+                if (StringUtils.isBlank(extImp.getSeatCode())) {\n+                    throw new PreBidException(\"Telaria: Seat Code required\");\n+                }\n+                seatCode = extImp.getSeatCode();\n+                requestBuilder\n+                        .imp(Collections.singletonList(imp.toBuilder()\n+                                .tagid(extImp.getAdCode())\n+                                .ext(mapper.mapper().valueToTree(ExtImpOutTelaria.of(imp.getTagid(), publisherId)))\n+                                .build()));\n+            } catch (PreBidException e) {\n+                errors.add(BidderError.badInput(e.getMessage()));\n+            }\n+        }\n+\n+        if (bidRequest.getSite() != null) {\n+            modifySite(seatCode, bidRequest, requestBuilder);\n+        } else if (bidRequest.getApp() != null) {\n+            modifyApp(seatCode, bidRequest, requestBuilder);\n+        }\n+\n+        final BidRequest outgoingRequest = requestBuilder.build();\n+        final String body = mapper.encode(outgoingRequest);\n+\n+        return Result.of(Collections.singletonList(\n+                HttpRequest.<BidRequest>builder()\n+                        .method(HttpMethod.POST)\n+                        .uri(endpointUrl)\n+                        .headers(headers(bidRequest))\n+                        .payload(outgoingRequest)\n+                        .body(body)\n+                        .build()),\n+                errors);\n+    }\n+\n+    private void validateImp(List<Imp> imps) {\n+        for (Imp imp : imps) {\n+            if (imp.getVideo() == null) {\n+                throw new PreBidException(\"Telaria: Only Supports Video\");\n+            }\n+        }\n+    }\n+\n+    private String getPublisherId(BidRequest bidRequest) {\n+        if (bidRequest.getSite() != null && bidRequest.getSite().getPublisher() != null) {\n+            return bidRequest.getSite().getPublisher().getId();\n+        } else if (bidRequest.getApp() != null && bidRequest.getApp().getPublisher() != null) {\n+            return bidRequest.getApp().getPublisher().getId();\n+        }\n+        return \"\";\n+    }\n+\n+    private ExtImpTelaria parseImpExt(Imp imp) {\n+        try {\n+            return mapper.mapper().convertValue(imp.getExt(), TELARIA_EXT_TYPE_REFERENCE).getBidder();\n+        } catch (IllegalArgumentException e) {\n+            throw new PreBidException(e.getMessage(), e);\n+        }\n+    }\n+\n+    private static void modifySite(String seatCode, BidRequest bidRequest,\n+                                   BidRequest.BidRequestBuilder bidRequestBuilder) {\n+        final Site site = bidRequest.getSite();\n+        if (site.getPublisher() != null) {\n+            final Publisher modifiedPublisher = site.getPublisher().toBuilder().id(seatCode).build();\n+            bidRequestBuilder.site(site.toBuilder().publisher(modifiedPublisher).build());\n+        }\n+    }\n+\n+    private static void modifyApp(String seatCode, BidRequest bidRequest,\n+                                  BidRequest.BidRequestBuilder bidRequestBuilder) {\n+        final App app = bidRequest.getApp();\n+        if (app.getPublisher() != null) {\n+            final Publisher modifiedPublisher = app.getPublisher().toBuilder().id(seatCode).build();\n+            bidRequestBuilder.app(app.toBuilder().publisher(modifiedPublisher).build());\n+        }\n+    }\n+\n+    private MultiMap headers(BidRequest bidRequest) {\n+        final MultiMap headers = HttpUtil.headers().add(\"x-openrtb-version\", \"2.5\");\n+        final Device device = bidRequest.getDevice();\n+        if (device != null) {\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.USER_AGENT_HEADER, device.getUa());\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.X_FORWARDED_FOR_HEADER, device.getIp());\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.ACCEPT_LANGUAGE_HEADER, device.getLanguage());\n+            HttpUtil.addHeaderIfValueIsNotEmpty(headers, HttpUtil.DNT_HEADER, Objects.toString(device.getDnt(), null));\n+        }\n+        return headers;\n+    }\n+\n+    @Override\n+    public Result<List<BidderBid>> makeBids(HttpCall<BidRequest> httpCall, BidRequest bidRequest) {\n+        final int statusCode = httpCall.getResponse().getStatusCode();\n+        if (statusCode == HttpResponseStatus.NO_CONTENT.code()) {\n+            return Result.of(Collections.emptyList(), Collections.emptyList());\n+        } else if (statusCode == HttpResponseStatus.BAD_REQUEST.code()) {\n+            return Result.emptyWithError(BidderError.badInput(\"Invalid request.\"));\n+        } else if (statusCode != HttpResponseStatus.OK.code()) {\n+            return Result.emptyWithError(BidderError.badServerResponse(String.format(\"Unexpected HTTP status %s.\",\n+                    statusCode)));\n+        }\n+\n+        try {\n+            return Result.of(extractBids(httpCall.getRequest().getPayload(), getBidResponse(httpCall.getResponse())),\n+                    Collections.emptyList());\n+        } catch (DecodeException | PreBidException e) {\n+            return Result.emptyWithError(BidderError.badServerResponse(e.getMessage()));\n+        }\n+    }\n+\n+    private static List<BidderBid> extractBids(BidRequest bidRequest, BidResponse bidResponse) {\n+        return bidResponse == null || bidResponse.getSeatbid() == null\n+                ? Collections.emptyList()\n+                : bidsFromResponse(bidRequest, bidResponse);\n+    }\n+\n+    private BidResponse getBidResponse(HttpResponse response) {\n+        if (\"gzip\".equals(response.getHeaders().get(\"Content-Encoding\"))) {\n+            response.getHeaders().remove(\"Content-Encoding\");\n+            return mapper.decodeValue(Buffer.buffer(response.getBody()), BidResponse.class);", "originalCommit": "94e4412a48ff928ea5bdcf3d0b9aa6977db5a85a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "879b89658625a3e7cf18e6ca5912df3027c807fa", "url": "https://github.com/prebid/prebid-server-java/commit/879b89658625a3e7cf18e6ca5912df3027c807fa", "message": "Refactoring and fix unzip file", "committedDate": "2020-05-26T18:54:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxMjQ2OA==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r431912468", "bodyText": "You are still overriding imps.\nJust extract this method and return Collection of imps and then set it in the request", "author": "DGarbar", "createdAt": "2020-05-28T15:09:34Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -72,24 +74,18 @@ public TelariaBidder(String endpointUrl, JacksonMapper mapper) {\n         for (Imp imp : bidRequest.getImp()) {\n             try {\n                 final ExtImpTelaria extImp = parseImpExt(imp);\n-                if (StringUtils.isBlank(extImp.getSeatCode())) {\n-                    throw new PreBidException(\"Telaria: Seat Code required\");\n-                }\n                 seatCode = extImp.getSeatCode();\n-                requestBuilder\n-                        .imp(Collections.singletonList(imp.toBuilder()\n-                                .tagid(extImp.getAdCode())\n-                                .ext(mapper.mapper().valueToTree(ExtImpOutTelaria.of(imp.getTagid(), publisherId)))\n-                                .build()));\n+                Imp updateImp = updateImp(imp, extImp, publisherId);\n+                requestBuilder.imp(Collections.singletonList(updateImp));", "originalCommit": "879b89658625a3e7cf18e6ca5912df3027c807fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxNTAzOQ==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r431915039", "bodyText": "You need to create Publisher despite of his absence.", "author": "DGarbar", "createdAt": "2020-05-28T15:13:03Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -131,26 +143,26 @@ private ExtImpTelaria parseImpExt(Imp imp) {\n         }\n     }\n \n-    private static void modifySite(String seatCode, BidRequest bidRequest,\n-                                   BidRequest.BidRequestBuilder bidRequestBuilder) {\n+    private Site modifySite(String seatCode, BidRequest bidRequest) {\n         final Site site = bidRequest.getSite();\n         if (site.getPublisher() != null) {\n             final Publisher modifiedPublisher = site.getPublisher().toBuilder().id(seatCode).build();", "originalCommit": "879b89658625a3e7cf18e6ca5912df3027c807fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkxNTExOQ==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r431915119", "bodyText": "You need to create Publisher despite of his absence.", "author": "DGarbar", "createdAt": "2020-05-28T15:13:10Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -131,26 +143,26 @@ private ExtImpTelaria parseImpExt(Imp imp) {\n         }\n     }\n \n-    private static void modifySite(String seatCode, BidRequest bidRequest,\n-                                   BidRequest.BidRequestBuilder bidRequestBuilder) {\n+    private Site modifySite(String seatCode, BidRequest bidRequest) {\n         final Site site = bidRequest.getSite();\n         if (site.getPublisher() != null) {\n             final Publisher modifiedPublisher = site.getPublisher().toBuilder().id(seatCode).build();\n-            bidRequestBuilder.site(site.toBuilder().publisher(modifiedPublisher).build());\n+            return site.toBuilder().publisher(modifiedPublisher).build();\n         }\n+        return site;\n     }\n \n-    private static void modifyApp(String seatCode, BidRequest bidRequest,\n-                                  BidRequest.BidRequestBuilder bidRequestBuilder) {\n+    private App modifyApp(String seatCode, BidRequest bidRequest) {\n         final App app = bidRequest.getApp();\n         if (app.getPublisher() != null) {\n             final Publisher modifiedPublisher = app.getPublisher().toBuilder().id(seatCode).build();", "originalCommit": "879b89658625a3e7cf18e6ca5912df3027c807fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e247095a0074dce6fc16a249ad287c63404bc5cb", "url": "https://github.com/prebid/prebid-server-java/commit/e247095a0074dce6fc16a249ad287c63404bc5cb", "message": "Fix return imps of bidrequest. Fix publisher object creation.", "committedDate": "2020-05-28T15:59:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1MjUxNg==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r432352516", "bodyText": "NPE\nsite can be null.\napp can be null.\nPublisher can be null.\nPlease, just create separate method that can create publisher, and checks for NULL.\nCall this method from modifySite and modifyApp method that get Site and App object accordingly.\nALSO performing checks for null.", "author": "DGarbar", "createdAt": "2020-05-29T09:02:46Z", "path": "src/main/java/org/prebid/server/bidder/telaria/TelariaBidder.java", "diffHunk": "@@ -145,20 +146,14 @@ private ExtImpTelaria parseImpExt(Imp imp) {\n \n     private Site modifySite(String seatCode, BidRequest bidRequest) {\n         final Site site = bidRequest.getSite();\n-        if (site.getPublisher() != null) {\n-            final Publisher modifiedPublisher = site.getPublisher().toBuilder().id(seatCode).build();\n-            return site.toBuilder().publisher(modifiedPublisher).build();\n-        }\n-        return site;\n+        final Publisher modifiedPublisher = site.getPublisher().toBuilder().id(seatCode).build();\n+        return site.toBuilder().publisher(modifiedPublisher).build();\n     }\n \n     private App modifyApp(String seatCode, BidRequest bidRequest) {\n         final App app = bidRequest.getApp();\n-        if (app.getPublisher() != null) {\n-            final Publisher modifiedPublisher = app.getPublisher().toBuilder().id(seatCode).build();\n-            return app.toBuilder().publisher(modifiedPublisher).build();\n-        }\n-        return app;\n+        final Publisher modifiedPublisher = app.getPublisher().toBuilder().id(seatCode).build();\n+        return app.toBuilder().publisher(modifiedPublisher).build();", "originalCommit": "e247095a0074dce6fc16a249ad287c63404bc5cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM1Mzg0Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/726#discussion_r432353846", "bodyText": "Is it really good idea for adding empty publisher and hiding NPE in the test ?\nFix NPE remove this", "author": "DGarbar", "createdAt": "2020-05-29T09:05:25Z", "path": "src/test/java/org/prebid/server/bidder/telaria/TelariaBidderTest.java", "diffHunk": "@@ -135,7 +135,7 @@ public void makeHttpRequestsShouldNotSetAppPublisherIdIfSiteIsNotNull() {\n         // given\n         final BidRequest bidRequest = BidRequest.builder()\n                 .imp(singletonList(givenImp(identity())))\n-                .site(Site.builder().build())\n+                .site(Site.builder().publisher(Publisher.builder().build()).build())", "originalCommit": "e247095a0074dce6fc16a249ad287c63404bc5cb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5231c449bb00dd79254bb07835222a63c7b0d60e", "url": "https://github.com/prebid/prebid-server-java/commit/5231c449bb00dd79254bb07835222a63c7b0d60e", "message": "Add null check for publisher", "committedDate": "2020-05-29T10:24:34Z", "type": "commit"}, {"oid": "ab32f1354c9c31e67858b0be0c9d9f9b741e84cc", "url": "https://github.com/prebid/prebid-server-java/commit/ab32f1354c9c31e67858b0be0c9d9f9b741e84cc", "message": "Merge branch 'master' into add-telaria-bidder", "committedDate": "2020-07-06T09:02:49Z", "type": "commit"}, {"oid": "183a80c5bd6532542d0a77115dd5c31ec1e1a92c", "url": "https://github.com/prebid/prebid-server-java/commit/183a80c5bd6532542d0a77115dd5c31ec1e1a92c", "message": "Update config", "committedDate": "2020-07-06T09:07:02Z", "type": "commit"}]}