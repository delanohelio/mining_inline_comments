{"pr_number": 616, "pr_title": "Overwrite Bid Id", "pr_createdAt": "2020-02-07T14:41:39Z", "pr_url": "https://github.com/prebid/prebid-server-java/pull/616", "timeline": [{"oid": "06f93c666c990e4f1d1feef35bed7d6abfecd903", "url": "https://github.com/prebid/prebid-server-java/commit/06f93c666c990e4f1d1feef35bed7d6abfecd903", "message": "Bid Id can be overwritten if application.yaml auction.generate-bid-id = true.\nTest added", "committedDate": "2020-02-07T14:40:14Z", "type": "commit"}, {"oid": "99ee0efb84e9e3a4608acd3adab7d84bea02be53", "url": "https://github.com/prebid/prebid-server-java/commit/99ee0efb84e9e3a4608acd3adab7d84bea02be53", "message": "Merge branch 'master' into pbs-id-generation\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/BidResponseCreator.java\n#\tsrc/main/java/org/prebid/server/spring/config/ServiceConfiguration.java\n#\tsrc/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "committedDate": "2020-02-07T15:00:32Z", "type": "commit"}, {"oid": "df3ef9f4ecbb83904c8298e7d66132b039d6ff8a", "url": "https://github.com/prebid/prebid-server-java/commit/df3ef9f4ecbb83904c8298e7d66132b039d6ff8a", "message": "Merge branch 'master' into pbs-id-generation", "committedDate": "2020-02-07T15:29:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMDI2Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r392130266", "bodyText": "Pls extract this to separate method. No consumer need here.", "author": "rpanchyk", "createdAt": "2020-03-13T09:57:59Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -100,6 +104,29 @@ public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog\n         this.cacheAssetUrlTemplate = Objects.requireNonNull(cacheService.getCachedAssetURLTemplate());\n         this.storedRequestProcessor = Objects.requireNonNull(storedRequestProcessor);\n         this.mapper = Objects.requireNonNull(mapper);\n+\n+        if (generateBidId) {\n+            overwriteBidIdConsumer = bidderResponses -> {\n+                if (CollectionUtils.isNotEmpty(bidderResponses)) {\n+                    bidderResponses.stream()\n+                            .filter(Objects::nonNull)\n+                            .map(BidderResponse::getSeatBid)\n+                            .filter(Objects::nonNull)\n+                            .map(BidderSeatBid::getBids)\n+                            .filter(Objects::nonNull)\n+                            .forEach(bidderBids -> {\n+                                bidderBids.stream()\n+                                        .filter(Objects::nonNull)\n+                                        .map(BidderBid::getBid)\n+                                        .filter(Objects::nonNull)\n+                                        .forEach(bid -> bid.setId(UUID.randomUUID().toString()));\n+                            });", "originalCommit": "99ee0efb84e9e3a4608acd3adab7d84bea02be53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzMDU3Mg==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r392130572", "bodyText": "Pls avoid default config values, just add it to application.yaml.", "author": "rpanchyk", "createdAt": "2020-03-13T09:58:32Z", "path": "src/main/java/org/prebid/server/spring/config/ServiceConfiguration.java", "diffHunk": "@@ -406,9 +406,11 @@ BidResponseCreator bidResponseCreator(\n             BidderCatalog bidderCatalog,\n             EventsService eventsService,\n             StoredRequestProcessor storedRequestProcessor,\n-            JacksonMapper mapper) {\n+            JacksonMapper mapper,\n+            @Value(\"${auction.generate-bid-id:#{false}}\") Boolean generateBidId) {", "originalCommit": "99ee0efb84e9e3a4608acd3adab7d84bea02be53", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e9eea09c9a0224e971d246764a26aebbb81aa40", "url": "https://github.com/prebid/prebid-server-java/commit/0e9eea09c9a0224e971d246764a26aebbb81aa40", "message": "Overwriting exp.prebid.bid_id", "committedDate": "2020-03-16T10:12:07Z", "type": "commit"}, {"oid": "81ad0a7f9c78bf2ad74b5a4c8632420471b5b29f", "url": "https://github.com/prebid/prebid-server-java/commit/81ad0a7f9c78bf2ad74b5a4c8632420471b5b29f", "message": "Overwriting exp.prebid.bid_id", "committedDate": "2020-03-16T11:21:33Z", "type": "commit"}, {"oid": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "url": "https://github.com/prebid/prebid-server-java/commit/91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "message": "Overwriting exp.prebid.bid_id", "committedDate": "2020-03-16T11:26:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAxODcxOA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397018718", "bodyText": "Can produce NPE.\nReplace to Boolean and use BooleanUtils.isTrue and similar methods", "author": "DGarbar", "createdAt": "2020-03-24T09:41:00Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -89,9 +91,11 @@\n     private final String cachePath;\n     private final String cacheAssetUrlTemplate;\n     private final StoredRequestProcessor storedRequestProcessor;\n+    private final Consumer<BidResponse> overwriteBidIdConsumer;\n \n     public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog, EventsService eventsService,\n-                              StoredRequestProcessor storedRequestProcessor, JacksonMapper mapper) {\n+                              StoredRequestProcessor storedRequestProcessor,\n+                              JacksonMapper mapper, boolean generateBidId) {", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAxOTEwNg==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397019106", "bodyText": "replace to ? : operator", "author": "DGarbar", "createdAt": "2020-03-24T09:41:37Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -100,6 +104,45 @@ public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog\n         this.cacheAssetUrlTemplate = Objects.requireNonNull(cacheService.getCachedAssetURLTemplate());\n         this.storedRequestProcessor = Objects.requireNonNull(storedRequestProcessor);\n         this.mapper = Objects.requireNonNull(mapper);\n+\n+        if (generateBidId) {", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyMDU4OQ==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397020589", "bodyText": "extract into 2 values", "author": "DGarbar", "createdAt": "2020-03-24T09:44:06Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -100,6 +104,45 @@ public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog\n         this.cacheAssetUrlTemplate = Objects.requireNonNull(cacheService.getCachedAssetURLTemplate());\n         this.storedRequestProcessor = Objects.requireNonNull(storedRequestProcessor);\n         this.mapper = Objects.requireNonNull(mapper);\n+\n+        if (generateBidId) {\n+            overwriteBidIdConsumer = overwriteBidIdConsumer();\n+        } else {\n+            overwriteBidIdConsumer = bidderResponses -> {\n+            };\n+        }\n+\n+    }\n+\n+    private Consumer<BidResponse> overwriteBidIdConsumer() {\n+        return bidderResponses -> {\n+            bidderResponses.getSeatbid().stream()\n+                    .map(SeatBid::getBid)\n+                    .forEach(bids -> bids.stream()\n+                            .filter(Objects::nonNull)\n+                            .forEach(this::replaceBidId));\n+\n+        };\n+    }\n+\n+    private void replaceBidId(Bid bid) {\n+        final ObjectNode ext = bid.getExt();\n+        final ExtBidPrebid extBidPrebid = parsePrebidExt(ext);\n+        if (extBidPrebid != null) {\n+            extBidPrebid.setBidId(UUID.randomUUID().toString());\n+            try {\n+                bid.setExt(ext.set(PREBID_EXT, mapper.mapper().readTree(mapper.encode(extBidPrebid))));", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyMTM2Mw==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397021363", "bodyText": "It is better to log smth if we cant set id", "author": "DGarbar", "createdAt": "2020-03-24T09:45:28Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -100,6 +104,45 @@ public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog\n         this.cacheAssetUrlTemplate = Objects.requireNonNull(cacheService.getCachedAssetURLTemplate());\n         this.storedRequestProcessor = Objects.requireNonNull(storedRequestProcessor);\n         this.mapper = Objects.requireNonNull(mapper);\n+\n+        if (generateBidId) {\n+            overwriteBidIdConsumer = overwriteBidIdConsumer();\n+        } else {\n+            overwriteBidIdConsumer = bidderResponses -> {\n+            };\n+        }\n+\n+    }\n+\n+    private Consumer<BidResponse> overwriteBidIdConsumer() {\n+        return bidderResponses -> {\n+            bidderResponses.getSeatbid().stream()\n+                    .map(SeatBid::getBid)\n+                    .forEach(bids -> bids.stream()\n+                            .filter(Objects::nonNull)\n+                            .forEach(this::replaceBidId));\n+\n+        };\n+    }\n+\n+    private void replaceBidId(Bid bid) {\n+        final ObjectNode ext = bid.getExt();\n+        final ExtBidPrebid extBidPrebid = parsePrebidExt(ext);\n+        if (extBidPrebid != null) {\n+            extBidPrebid.setBidId(UUID.randomUUID().toString());\n+            try {\n+                bid.setExt(ext.set(PREBID_EXT, mapper.mapper().readTree(mapper.encode(extBidPrebid))));\n+            } catch (JsonProcessingException e) {\n+            }", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyMjUzOA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397022538", "bodyText": "I am not sure if it is good idea to make this mutable.\nJust imagine how hard it will be in a future to find state change if anyone can set whenever they want.\n@rpanchyk  what do you think?", "author": "DGarbar", "createdAt": "2020-03-24T09:47:24Z", "path": "src/main/java/org/prebid/server/proto/openrtb/ext/response/ExtBidPrebid.java", "diffHunk": "@@ -2,18 +2,20 @@\n \n import com.fasterxml.jackson.annotation.JsonProperty;\n import com.iab.openrtb.request.Video;\n-import lombok.AllArgsConstructor;\n-import lombok.Value;\n+import lombok.Builder;\n+import lombok.Data;\n \n import java.util.Map;\n \n /**\n  * Defines the contract for bidresponse.seatbid.bid[i].ext.prebid\n  */\n-@AllArgsConstructor(staticName = \"of\")\n-@Value\n+@Builder(toBuilder = true)\n+@Data", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNTMwOA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397025308", "bodyText": "I'd probably just added method toSeatbid, which create appropriate objects.\nAnd modify toSeatBid", "author": "DGarbar", "createdAt": "2020-03-24T09:51:46Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -514,12 +557,14 @@ private BidResponse toBidResponse(\n                 toExtBidResponse(bidderResponses, bidRequest, cacheResult, videoStoredDataResult,\n                         debugEnabled, bidErrors);\n \n-        return BidResponse.builder()\n+        BidResponse response = BidResponse.builder()\n                 .id(bidRequest.getId())\n                 .cur(bidRequest.getCur().get(0))\n                 .seatbid(seatBids)\n                 .ext(mapper.mapper().valueToTree(extBidResponse))\n                 .build();\n+        overwriteBidIdConsumer.accept(response);", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNzAxMg==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397027012", "bodyText": "?", "author": "DGarbar", "createdAt": "2020-03-24T09:54:24Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -371,6 +369,40 @@ public void shouldSkipBidderResponsesWhereSeatBidContainEmptyBids() {\n         verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n     }\n \n+    @Test\n+    public void shouldOverwriteBidderIdToUUID() throws JsonProcessingException {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest();\n+\n+        final ExtPrebid<ExtBidPrebid, ?> prebid = ExtPrebid.of(ExtBidPrebid.builder().type(banner).build(), null);\n+        final Bid bid = Bid.builder()\n+                .id(\"123\")\n+                .impid(\"imp123\")\n+                .w(123)\n+                .h(123)\n+                .price(BigDecimal.ONE)\n+                .ext(mapper.valueToTree(prebid))\n+                .build();\n+        final List<BidderResponse> bidderResponses = singletonList(\n+                BidderResponse.of(\"bidder2\", givenSeatBid(BidderBid.of(bid, banner, \"USD\")), 0));\n+\n+        final BidResponseCreator bidResponseCreator = new BidResponseCreator(cacheService, bidderCatalog, eventsService,\n+                storedRequestProcessor, jacksonMapper, true);\n+        // when\n+        final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n+                null, CACHE_INFO, ACCOUNT, timeout, false).result();\n+\n+        // then\n+        assertThat(bidResponse.getSeatbid()).hasSize(1);\n+        assertThat(bidResponse.getSeatbid().get(0).getBid()).hasSize(1);\n+        final ExtBidPrebid ext = mapper.readValue(bidResponse.getSeatbid().get(0).getBid().get(0)\n+                .getExt().get(\"prebid\").toString(), ExtBidPrebid.class);\n+        assertThat(ext.getBidId()).isNotNull();\n+\n+        System.out.println(ext.getBidId());", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNzMwOQ==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397027309", "bodyText": "expectedExtBidPrebid", "author": "DGarbar", "createdAt": "2020-03-24T09:54:51Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -371,6 +369,40 @@ public void shouldSkipBidderResponsesWhereSeatBidContainEmptyBids() {\n         verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n     }\n \n+    @Test\n+    public void shouldOverwriteBidderIdToUUID() throws JsonProcessingException {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest();\n+\n+        final ExtPrebid<ExtBidPrebid, ?> prebid = ExtPrebid.of(ExtBidPrebid.builder().type(banner).build(), null);\n+        final Bid bid = Bid.builder()\n+                .id(\"123\")\n+                .impid(\"imp123\")\n+                .w(123)\n+                .h(123)\n+                .price(BigDecimal.ONE)\n+                .ext(mapper.valueToTree(prebid))\n+                .build();\n+        final List<BidderResponse> bidderResponses = singletonList(\n+                BidderResponse.of(\"bidder2\", givenSeatBid(BidderBid.of(bid, banner, \"USD\")), 0));\n+\n+        final BidResponseCreator bidResponseCreator = new BidResponseCreator(cacheService, bidderCatalog, eventsService,\n+                storedRequestProcessor, jacksonMapper, true);\n+        // when\n+        final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n+                null, CACHE_INFO, ACCOUNT, timeout, false).result();\n+\n+        // then\n+        assertThat(bidResponse.getSeatbid()).hasSize(1);\n+        assertThat(bidResponse.getSeatbid().get(0).getBid()).hasSize(1);\n+        final ExtBidPrebid ext = mapper.readValue(bidResponse.getSeatbid().get(0).getBid().get(0)", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyNzY2NA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397027664", "bodyText": "does this values are really required ?", "author": "DGarbar", "createdAt": "2020-03-24T09:55:26Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -371,6 +369,40 @@ public void shouldSkipBidderResponsesWhereSeatBidContainEmptyBids() {\n         verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n     }\n \n+    @Test\n+    public void shouldOverwriteBidderIdToUUID() throws JsonProcessingException {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest();\n+\n+        final ExtPrebid<ExtBidPrebid, ?> prebid = ExtPrebid.of(ExtBidPrebid.builder().type(banner).build(), null);\n+        final Bid bid = Bid.builder()\n+                .id(\"123\")\n+                .impid(\"imp123\")\n+                .w(123)\n+                .h(123)\n+                .price(BigDecimal.ONE)", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyOTk1MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397029951", "bodyText": "Have you tried to use .extract method?", "author": "DGarbar", "createdAt": "2020-03-24T09:58:48Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -371,6 +369,40 @@ public void shouldSkipBidderResponsesWhereSeatBidContainEmptyBids() {\n         verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n     }\n \n+    @Test\n+    public void shouldOverwriteBidderIdToUUID() throws JsonProcessingException {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest();\n+\n+        final ExtPrebid<ExtBidPrebid, ?> prebid = ExtPrebid.of(ExtBidPrebid.builder().type(banner).build(), null);\n+        final Bid bid = Bid.builder()\n+                .id(\"123\")\n+                .impid(\"imp123\")\n+                .w(123)\n+                .h(123)\n+                .price(BigDecimal.ONE)\n+                .ext(mapper.valueToTree(prebid))\n+                .build();\n+        final List<BidderResponse> bidderResponses = singletonList(\n+                BidderResponse.of(\"bidder2\", givenSeatBid(BidderBid.of(bid, banner, \"USD\")), 0));\n+\n+        final BidResponseCreator bidResponseCreator = new BidResponseCreator(cacheService, bidderCatalog, eventsService,\n+                storedRequestProcessor, jacksonMapper, true);\n+        // when\n+        final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n+                null, CACHE_INFO, ACCOUNT, timeout, false).result();\n+\n+        // then\n+        assertThat(bidResponse.getSeatbid()).hasSize(1);\n+        assertThat(bidResponse.getSeatbid().get(0).getBid()).hasSize(1);\n+        final ExtBidPrebid ext = mapper.readValue(bidResponse.getSeatbid().get(0).getBid().get(0)\n+                .getExt().get(\"prebid\").toString(), ExtBidPrebid.class);\n+        assertThat(ext.getBidId()).isNotNull();", "originalCommit": "91f51d5d20695e76e2acf5adf255d3b9d1beed7e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE0MTEzMw==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r397141133", "bodyText": "assertThat(bidResponse.getSeatbid())\n                .flatExtracting(SeatBid::getBid)\n                .extracting(Bid::getExt)\n                .extracting(ext -> ext.get(\"prebid\"))\n                .extracting(extPrebid -> mapper.treeToValue(extPrebid, ExtBidPrebid.class))\n                .extracting(ExtBidPrebid::getBidId)\n                .hasSize(1)\n                .doesNotContainNull();```", "author": "DGarbar", "createdAt": "2020-03-24T13:13:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAyOTk1MQ=="}], "type": "inlineReview"}, {"oid": "76140ca4c7cb812d1249ba6ced3f206a8a4044bb", "url": "https://github.com/prebid/prebid-server-java/commit/76140ca4c7cb812d1249ba6ced3f206a8a4044bb", "message": "PR fix", "committedDate": "2020-03-24T11:21:08Z", "type": "commit"}, {"oid": "485e411e1ffa426878fbb1291192ba2b93250bd9", "url": "https://github.com/prebid/prebid-server-java/commit/485e411e1ffa426878fbb1291192ba2b93250bd9", "message": "test fix", "committedDate": "2020-03-24T13:46:54Z", "type": "commit"}, {"oid": "85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "url": "https://github.com/prebid/prebid-server-java/commit/85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "message": "applying change request", "committedDate": "2020-03-26T11:29:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTIzNjU1MA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r399236550", "bodyText": "we use treeToValue method", "author": "DGarbar", "createdAt": "2020-03-27T12:43:03Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -100,6 +108,48 @@ public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog\n         this.cacheAssetUrlTemplate = Objects.requireNonNull(cacheService.getCachedAssetURLTemplate());\n         this.storedRequestProcessor = Objects.requireNonNull(storedRequestProcessor);\n         this.mapper = Objects.requireNonNull(mapper);\n+\n+        overwriteBidIdConsumer = BooleanUtils.isTrue(generateBidId) ? overwriteBidIdConsumer() : bidResponse -> {\n+        };\n+\n+    }\n+\n+    private Consumer<BidResponse> overwriteBidIdConsumer() {\n+        return bidderResponses -> bidderResponses.getSeatbid().stream()\n+                .map(SeatBid::getBid)\n+                .forEach(bids -> bids.stream()\n+                        .filter(Objects::nonNull)\n+                        .forEach(this::replaceBidId));\n+    }\n+\n+    private void replaceBidId(Bid bid) {\n+        final ObjectNode ext = bid.getExt();\n+        final ExtBidPrebid extBidPrebid = parsePrebidExt(ext);\n+        if (extBidPrebid != null) {\n+            final ExtBidPrebid modifiedExtBidPrebid = ExtBidPrebid.of(\n+                    UUID.randomUUID().toString(),\n+                    extBidPrebid.getType(),\n+                    extBidPrebid.getTargeting(),\n+                    extBidPrebid.getCache(),\n+                    extBidPrebid.getStoredRequestAttributes(),\n+                    extBidPrebid.getEvents(),\n+                    extBidPrebid.getVideo());\n+            try {\n+                final JsonNode extBidPrebidValue = mapper.mapper().readTree(mapper.encode(modifiedExtBidPrebid));\n+                final ObjectNode prebidExtNode = ext.set(PREBID_EXT, extBidPrebidValue);\n+                bid.setExt(prebidExtNode);\n+            } catch (JsonProcessingException e) {\n+                logger.debug(\"Parsing error\", e);\n+            }\n+        }\n+    }\n+\n+    private ExtBidPrebid parsePrebidExt(ObjectNode ext) {\n+        try {\n+            return mapper.decodeValue(ext.get(PREBID_EXT).toString(), ExtBidPrebid.class);", "originalCommit": "85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MTE5MA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r399241190", "bodyText": "Isn't it all the logic above but in 1 line ?\n    final String bidId = isOverwriteBidIdConsumer ? UUID.randomUUID().toString() : null;\n    final ExtBidPrebid prebidExt = ExtBidPrebid.of(bidId, bidType, targetingKeywords, cache, storedVideo,\n                events, null);", "author": "DGarbar", "createdAt": "2020-03-27T12:51:29Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -641,7 +693,9 @@ private Bid toBid(BidderBid bidderBid, String bidder, ExtRequestTargeting target\n         final Video storedVideo = impIdToStoredVideo.get(bid.getImpid());\n         final Events events = eventsEnabled ? eventsService.createEvent(bid.getId(), account.getId()) : null;\n \n-        final ExtBidPrebid prebidExt = ExtBidPrebid.of(bidType, targetingKeywords, cache, storedVideo, events, null);\n+        final ExtBidPrebid prebidExt = ExtBidPrebid.of(null, bidType, targetingKeywords, cache, storedVideo,", "originalCommit": "85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MTQ4NA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r399241484", "bodyText": "check your IDEA code style", "author": "DGarbar", "createdAt": "2020-03-27T12:52:02Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -86,8 +86,7 @@\n import static org.mockito.BDDMockito.given;\n import static org.mockito.Mockito.never;\n import static org.mockito.Mockito.verify;\n-import static org.prebid.server.proto.openrtb.ext.response.BidType.banner;\n-import static org.prebid.server.proto.openrtb.ext.response.BidType.xNative;\n+import static org.prebid.server.proto.openrtb.ext.response.BidType.*;", "originalCommit": "85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MTc0NA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r399241744", "bodyText": "This is unnecessary", "author": "DGarbar", "createdAt": "2020-03-27T12:52:29Z", "path": "src/test/java/org/prebid/server/auction/BidResponseCreatorTest.java", "diffHunk": "@@ -371,6 +369,42 @@ public void shouldSkipBidderResponsesWhereSeatBidContainEmptyBids() {\n         verify(cacheService, never()).cacheBidsOpenrtb(anyList(), anyList(), any(), any(), any());\n     }\n \n+    @Test\n+    public void shouldOverwriteBidderIdToUUID() {\n+        // given\n+        final BidRequest bidRequest = givenBidRequest();\n+\n+        final ExtPrebid<ExtBidPrebid, ?> prebid = ExtPrebid.of(ExtBidPrebid.of(null, banner, null,\n+                null, null, null, null), null);\n+        final Bid bid = Bid.builder()\n+                .id(\"123\")\n+                .impid(\"imp123\")\n+                .ext(mapper.valueToTree(prebid))\n+                .build();\n+        final List<BidderResponse> bidderResponses = singletonList(\n+                BidderResponse.of(\"bidder2\", givenSeatBid(BidderBid.of(bid, banner, \"USD\")), 0));\n+\n+        final BidResponseCreator bidResponseCreator = new BidResponseCreator(cacheService, bidderCatalog, eventsService,\n+                storedRequestProcessor, jacksonMapper, true);\n+        // when\n+        final BidResponse bidResponse = bidResponseCreator.create(bidderResponses, bidRequest,\n+                null, CACHE_INFO, ACCOUNT, timeout, false).result();\n+\n+        // then\n+        assertThat(bidResponse.getSeatbid()).hasSize(1);\n+        assertThat(bidResponse.getSeatbid().get(0).getBid()).hasSize(1);", "originalCommit": "85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MjA5MQ==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r399242091", "bodyText": "Too ganeral debug message", "author": "DGarbar", "createdAt": "2020-03-27T12:53:04Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -100,6 +108,48 @@ public BidResponseCreator(CacheService cacheService, BidderCatalog bidderCatalog\n         this.cacheAssetUrlTemplate = Objects.requireNonNull(cacheService.getCachedAssetURLTemplate());\n         this.storedRequestProcessor = Objects.requireNonNull(storedRequestProcessor);\n         this.mapper = Objects.requireNonNull(mapper);\n+\n+        overwriteBidIdConsumer = BooleanUtils.isTrue(generateBidId) ? overwriteBidIdConsumer() : bidResponse -> {\n+        };\n+\n+    }\n+\n+    private Consumer<BidResponse> overwriteBidIdConsumer() {\n+        return bidderResponses -> bidderResponses.getSeatbid().stream()\n+                .map(SeatBid::getBid)\n+                .forEach(bids -> bids.stream()\n+                        .filter(Objects::nonNull)\n+                        .forEach(this::replaceBidId));\n+    }\n+\n+    private void replaceBidId(Bid bid) {\n+        final ObjectNode ext = bid.getExt();\n+        final ExtBidPrebid extBidPrebid = parsePrebidExt(ext);\n+        if (extBidPrebid != null) {\n+            final ExtBidPrebid modifiedExtBidPrebid = ExtBidPrebid.of(\n+                    UUID.randomUUID().toString(),\n+                    extBidPrebid.getType(),\n+                    extBidPrebid.getTargeting(),\n+                    extBidPrebid.getCache(),\n+                    extBidPrebid.getStoredRequestAttributes(),\n+                    extBidPrebid.getEvents(),\n+                    extBidPrebid.getVideo());\n+            try {\n+                final JsonNode extBidPrebidValue = mapper.mapper().readTree(mapper.encode(modifiedExtBidPrebid));\n+                final ObjectNode prebidExtNode = ext.set(PREBID_EXT, extBidPrebidValue);\n+                bid.setExt(prebidExtNode);\n+            } catch (JsonProcessingException e) {\n+                logger.debug(\"Parsing error\", e);", "originalCommit": "85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MzA5MA==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r399243090", "bodyText": "When creating event URLs and VAST IMP URLs, use this generated bidid instead of the bidder-created id.\nJust one line above.....", "author": "DGarbar", "createdAt": "2020-03-27T12:54:49Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -641,7 +693,9 @@ private Bid toBid(BidderBid bidderBid, String bidder, ExtRequestTargeting target\n         final Video storedVideo = impIdToStoredVideo.get(bid.getImpid());\n         final Events events = eventsEnabled ? eventsService.createEvent(bid.getId(), account.getId()) : null;", "originalCommit": "85dbf6e156b6237e14c281f68bfce1d9afc22c5f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3ODY1Nw==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r400778657", "bodyText": "?", "author": "DGarbar", "createdAt": "2020-03-31T09:43:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI0MzA5MA=="}], "type": "inlineReview"}, {"oid": "61471de7a22c072b6c2659442b4466cd77a1116e", "url": "https://github.com/prebid/prebid-server-java/commit/61471de7a22c072b6c2659442b4466cd77a1116e", "message": "change request", "committedDate": "2020-03-30T07:30:36Z", "type": "commit"}, {"oid": "813a7d184c94f3d14b816b1b0c05031db7b391e3", "url": "https://github.com/prebid/prebid-server-java/commit/813a7d184c94f3d14b816b1b0c05031db7b391e3", "message": "change request", "committedDate": "2020-03-31T08:00:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3NTU3Ng==", "url": "https://github.com/prebid/prebid-server-java/pull/616#discussion_r400775576", "bodyText": "Replace with if", "author": "DGarbar", "createdAt": "2020-03-31T09:38:20Z", "path": "src/main/java/org/prebid/server/auction/BidResponseCreator.java", "diffHunk": "@@ -641,7 +654,10 @@ private Bid toBid(BidderBid bidderBid, String bidder, ExtRequestTargeting target\n         final Video storedVideo = impIdToStoredVideo.get(bid.getImpid());\n         final Events events = eventsEnabled ? eventsService.createEvent(bid.getId(), account.getId()) : null;\n \n-        final ExtBidPrebid prebidExt = ExtBidPrebid.of(bidType, targetingKeywords, cache, storedVideo, events, null);\n+        final String bidId = bidIdSupplier.get();", "originalCommit": "813a7d184c94f3d14b816b1b0c05031db7b391e3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "42c412e7dcdfd17b97631ae3e85649989915fc2c", "url": "https://github.com/prebid/prebid-server-java/commit/42c412e7dcdfd17b97631ae3e85649989915fc2c", "message": "simplify code", "committedDate": "2020-03-31T11:53:34Z", "type": "commit"}, {"oid": "fb1cef490d772b4f04980463d9e9d3459e13a330", "url": "https://github.com/prebid/prebid-server-java/commit/fb1cef490d772b4f04980463d9e9d3459e13a330", "message": "simplify code", "committedDate": "2020-03-31T12:12:17Z", "type": "commit"}, {"oid": "40eae2aaea402bd2f57322a8be4e90a31d5dc471", "url": "https://github.com/prebid/prebid-server-java/commit/40eae2aaea402bd2f57322a8be4e90a31d5dc471", "message": "Merge branch 'master' into pbs-id-generation\n\n# Conflicts:\n#\tsrc/main/java/org/prebid/server/auction/BidResponseCreator.java\n#\tsrc/test/java/org/prebid/server/auction/BidResponseCreatorTest.java\n#\tsrc/test/java/org/prebid/server/handler/openrtb2/AmpHandlerTest.java", "committedDate": "2020-05-08T08:51:49Z", "type": "commit"}, {"oid": "87ee7d108ffd7f7a4d70ada89b6b614eed6775da", "url": "https://github.com/prebid/prebid-server-java/commit/87ee7d108ffd7f7a4d70ada89b6b614eed6775da", "message": "Minor changes", "committedDate": "2020-05-08T09:05:03Z", "type": "commit"}, {"oid": "5273bac0929643f098c383c9eba8aa1b451d8122", "url": "https://github.com/prebid/prebid-server-java/commit/5273bac0929643f098c383c9eba8aa1b451d8122", "message": "Fix org.prebid.server.proto.openrtb.ext.response.ExtBidPrebid.bidid", "committedDate": "2020-05-08T09:25:35Z", "type": "commit"}, {"oid": "9867e3058abb381dde7ef305800f188ea788baef", "url": "https://github.com/prebid/prebid-server-java/commit/9867e3058abb381dde7ef305800f188ea788baef", "message": "Fix tests", "committedDate": "2020-05-08T10:20:42Z", "type": "commit"}]}