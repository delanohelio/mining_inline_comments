{"pr_number": 6366, "pr_title": "Fixes/ adjustments: Excel Sales Order adjustments", "pr_createdAt": "2020-03-18T13:27:15Z", "pr_url": "https://github.com/metasfresh/metasfresh/pull/6366", "timeline": [{"oid": "71e28818204559cc2c844af5d1e5a7899b65aa40", "url": "https://github.com/metasfresh/metasfresh/commit/71e28818204559cc2c844af5d1e5a7899b65aa40", "message": "prototyping", "committedDate": "2020-03-18T13:25:39Z", "type": "commit"}, {"oid": "c9969fa5b4d5ccfe6c2e732e214e73bf043837b9", "url": "https://github.com/metasfresh/metasfresh/commit/c9969fa5b4d5ccfe6c2e732e214e73bf043837b9", "message": "#6364 Second commit.", "committedDate": "2020-03-19T14:59:55Z", "type": "commit"}, {"oid": "76e076246a5ad164abe4bf3462326491dce2b75e", "url": "https://github.com/metasfresh/metasfresh/commit/76e076246a5ad164abe4bf3462326491dce2b75e", "message": "#6364 Second commit.", "committedDate": "2020-03-20T13:14:10Z", "type": "commit"}, {"oid": "f2a1593927f60f4d59f841607001e638251af440", "url": "https://github.com/metasfresh/metasfresh/commit/f2a1593927f60f4d59f841607001e638251af440", "message": "#6364 Saving reports under name defined in reportfilename column.", "committedDate": "2020-03-20T16:02:20Z", "type": "commit"}, {"oid": "f885b19a762240f70c61a89e3568a91e45fe6447", "url": "https://github.com/metasfresh/metasfresh/commit/f885b19a762240f70c61a89e3568a91e45fe6447", "message": "#6364 Intermediary commit.", "committedDate": "2020-03-23T12:33:19Z", "type": "commit"}, {"oid": "da016a5a77dfac627dbdd7931616bd1a3ee34060", "url": "https://github.com/metasfresh/metasfresh/commit/da016a5a77dfac627dbdd7931616bd1a3ee34060", "message": "#6364 Sql adjustments", "committedDate": "2020-03-23T16:45:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzMjIwNA==", "url": "https://github.com/metasfresh/metasfresh/pull/6366#discussion_r396932204", "bodyText": "Please remove this comment", "author": "TheBestPessimist", "createdAt": "2020-03-24T06:49:02Z", "path": "de.metas.adempiere.adempiere/base/src/main/java/de/metas/process/ProcessExecutionResult.java", "diffHunk": "@@ -504,6 +504,7 @@ public void setReportData(@NonNull final ReportResultData reportResult)\n \t\treportFilename = reportResult.getReportFilename();\n \t\treportContentType = reportResult.getReportContentType();\n \t}\n+    //aici", "originalCommit": "da016a5a77dfac627dbdd7931616bd1a3ee34060", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI5MTEzMQ==", "url": "https://github.com/metasfresh/metasfresh/pull/6366#discussion_r397291131", "bodyText": "was done", "author": "metas-ts", "createdAt": "2020-03-24T16:29:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzMjIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzMjYxMw==", "url": "https://github.com/metasfresh/metasfresh/pull/6366#discussion_r396932613", "bodyText": "reportContentType is never used, sais codacy. Please check if it should be used, or remove it.", "author": "TheBestPessimist", "createdAt": "2020-03-24T06:50:19Z", "path": "de.metas.report/report-service/src/main/java/de/metas/report/rest/ReportRestController.java", "diffHunk": "@@ -56,19 +56,19 @@\n \t\t\t\tfinal MDCCloseable c3 = MDC.putCloseable(\"output\", String.valueOf(outputStr)))\n \t\t{\n \t\t\tfinal OutputType outputType = outputStr == null ? IReportServer.DEFAULT_OutputType : OutputType.valueOf(outputStr);\n-\t\t\tfinal String reportContentType = outputType.getContentType();\n-\t\t\tfinal String reportFilename = \"report.\" + outputType.getFileExtension();\n \n-\t\t\tfinal byte[] reportData = server.report(processId, pinstanceId, adLanguage, outputType);\n+\t\t\tfinal ReportResult report = server.report(processId, pinstanceId, adLanguage, outputType);\n+\t\t\tfinal String reportContentType = report.getOutputType().getContentType();", "originalCommit": "da016a5a77dfac627dbdd7931616bd1a3ee34060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzMzU4MA==", "url": "https://github.com/metasfresh/metasfresh/pull/6366#discussion_r396933580", "bodyText": "I believe this class should start with Capital", "author": "TheBestPessimist", "createdAt": "2020-03-24T06:53:12Z", "path": "de.metas.report/report-service/src/test/java/de/metas/report/xls/engine/JXlsExporterTest.java", "diffHunk": "@@ -33,80 +39,105 @@\n \n public class JXlsExporterTest\n {\n+\tprivate static final String RESOURCENAME_TestBPartners_xls = \"/jxls/TestBPartners.xls\";\n+\tprivate static final String RESOURCENAME_TestBPartners_xlsx = \"/jxls/TestBPartners.xlsx\";\n+\n+\tprivate ObjectXlsDataSource createBPartnersDataSource(final int count)\n+\t{\n+\t\treturn ObjectXlsDataSource.builder()\n+\t\t\t\t.rows(createTestBPartners(count))\n+\t\t\t\t.build();\n+\t}\n+\n+\tprivate List<TestBPartner> createTestBPartners(final int count)\n+\t{\n+\t\tfinal List<TestBPartner> list = new ArrayList<>();\n+\t\tfor (int i = 1; i <= count; i++)\n+\t\t{\n+\t\t\tlist.add(TestBPartner.builder()\n+\t\t\t\t\t.value(\"BP\" + count)\n+\t\t\t\t\t.name(\"BPartner \" + count)\n+\t\t\t\t\t.build());\n+\t\t}\n+\t\treturn list;\n+\t}\n+\n+\t@Builder\n+\t@Value\n+\tpublic static class TestBPartner\n+\t{\n+\t\tprivate String value;\n+\t\tprivate String name;\n+\t}\n+\n \t/**\n \t * Simple test to make sure {@link JXlsExporter} can process a simple template and does not have errors.\n-\t * \n-\t * @throws Exception\n \t */\n \t@Test\n-\tpublic void testProcessSimpleReport_XLS() throws Exception\n+\tpublic void testProcessSimpleReport_XLS()\n \t{\n-\t\tfinal InputStream jxlsTemplate = JXlsExporterTest.class.getResourceAsStream(\"/jxls/TestBPartners.xls\");\n-\t\tfinal IXlsDataSource dataSource = createBPartnersDataSource(10);\n-\n-\t\tfinal OutputStream output = new ByteArrayOutputStream();\n-\t\t// final OutputStream output = new FileOutputStream(\"c:\\\\tmp\\\\TestBPartners_out.xls\");\n+\t\tfinal InputStream jxlsTemplate = JXlsExporterTest.class.getResourceAsStream(RESOURCENAME_TestBPartners_xls);\n+\t\tfinal ObjectXlsDataSource dataSource = createBPartnersDataSource(10);\n \n \t\tJXlsExporter.newInstance()\n \t\t\t\t.setContext(new Properties())\n \t\t\t\t.setTemplate(jxlsTemplate)\n \t\t\t\t.setDataSource(dataSource)\n-\t\t\t\t.setOutput(output)\n \t\t\t\t.export();\n \t}\n \n \t@Test\n-\tpublic void testProcessSimpleReport_XLSX() throws Exception\n+\tpublic void testProcessSimpleReport_XLSX()\n \t{\n-\t\tfinal InputStream jxlsTemplate = JXlsExporterTest.class.getResourceAsStream(\"/jxls/TestBPartners.xlsx\");\n-\t\tfinal IXlsDataSource dataSource = createBPartnersDataSource(10);\n-\n-\t\tfinal OutputStream output = new ByteArrayOutputStream();\n-\t\t// final OutputStream output = new FileOutputStream(\"c:\\\\tmp\\\\TestBPartners_out.xlsx\");\n+\t\tfinal InputStream jxlsTemplate = JXlsExporterTest.class.getResourceAsStream(RESOURCENAME_TestBPartners_xlsx);\n+\t\tfinal ObjectXlsDataSource dataSource = createBPartnersDataSource(10);\n \n \t\tJXlsExporter.newInstance()\n \t\t\t\t.setContext(new Properties())\n \t\t\t\t.setTemplate(jxlsTemplate)\n \t\t\t\t.setDataSource(dataSource)\n-\t\t\t\t.setOutput(output)\n \t\t\t\t.export();\n \t}\n \n-\tprivate IXlsDataSource createBPartnersDataSource(final int count)\n+\t@Nested\n+\tpublic class getSuggestedFilename", "originalCommit": "da016a5a77dfac627dbdd7931616bd1a3ee34060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjkzNDI2Ng==", "url": "https://github.com/metasfresh/metasfresh/pull/6366#discussion_r396934266", "bodyText": "Could this work maybe ?\nthis(null, outputType, reportData);\nAnd annotate filename with @Nullable in the other constructor?", "author": "TheBestPessimist", "createdAt": "2020-03-24T06:55:22Z", "path": "de.metas.adempiere.adempiere/base/src/main/java/de/metas/report/ExecuteReportStrategy.java", "diffHunk": "@@ -48,6 +50,23 @@\n \t@ToString(exclude = \"reportData\")\n \tpublic class ExecuteReportResult\n \t{\n+\t\tpublic ExecuteReportResult(OutputType outputType, byte[] reportData)\n+\t\t{\n+\t\t\tthis.filename = null;", "originalCommit": "da016a5a77dfac627dbdd7931616bd1a3ee34060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk0MTg5MA==", "url": "https://github.com/metasfresh/metasfresh/pull/6366#discussion_r396941890", "bodyText": "Please use Check.isNotBlank", "author": "TheBestPessimist", "createdAt": "2020-03-24T07:17:10Z", "path": "de.metas.report/report-service/src/main/java/de/metas/report/rest/ReportRestController.java", "diffHunk": "@@ -81,6 +81,19 @@\n \t\t}\n \t}\n \n+\tprivate String extractReportFilename(final ReportResult report)\n+\t{\n+\t\tif (!Check.isBlank(report.getReportFilename()))", "originalCommit": "da016a5a77dfac627dbdd7931616bd1a3ee34060", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "06b35a5ff288e1e8386f0ae6caf097e338f84483", "url": "https://github.com/metasfresh/metasfresh/commit/06b35a5ff288e1e8386f0ae6caf097e338f84483", "message": "#6364 implemented review notes.", "committedDate": "2020-03-24T09:49:40Z", "type": "commit"}, {"oid": "fbfd73b51401460170b6f80b916fe478fae8caec", "url": "https://github.com/metasfresh/metasfresh/commit/fbfd73b51401460170b6f80b916fe478fae8caec", "message": "#6364 implemented review notes.", "committedDate": "2020-03-24T10:07:14Z", "type": "commit"}, {"oid": "69c866c6dbd87cb5681778bb5f4b7d4f7194cddf", "url": "https://github.com/metasfresh/metasfresh/commit/69c866c6dbd87cb5681778bb5f4b7d4f7194cddf", "message": "#6364 Added a fixed price precision of 2 for the price column.", "committedDate": "2020-03-24T18:43:30Z", "type": "commit"}, {"oid": "2d12efa86e35167ec37ed04ff78e4a7a7447b1b3", "url": "https://github.com/metasfresh/metasfresh/commit/2d12efa86e35167ec37ed04ff78e4a7a7447b1b3", "message": "6364-app - Fixes/ adjustments: Excel Sales Order adjustments\nExecuteReportResult: use static creator methods and avoid passing null parameters\nReportStarter: small logging improvement\n\nhttps://github.com/metasfresh/metasfresh/issues/6364", "committedDate": "2020-03-24T18:56:36Z", "type": "commit"}, {"oid": "6770b8e0835ff9099aa0a5fc7c6d4f20b50b0fb6", "url": "https://github.com/metasfresh/metasfresh/commit/6770b8e0835ff9099aa0a5fc7c6d4f20b50b0fb6", "message": "Merge branch 'gh6364' of github.com:metasfresh/metasfresh into gh6364", "committedDate": "2020-03-24T18:56:45Z", "type": "commit"}]}