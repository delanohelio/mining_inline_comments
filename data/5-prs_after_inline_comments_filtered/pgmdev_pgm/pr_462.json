{"pr_number": 462, "pr_title": "Vanish Improvements", "pr_createdAt": "2020-05-07T07:53:16Z", "pr_url": "https://github.com/PGMDev/PGM/pull/462", "timeline": [{"oid": "1c51478cd633661e39502f6653db0b691bb5d74f", "url": "https://github.com/PGMDev/PGM/commit/1c51478cd633661e39502f6653db0b691bb5d74f", "message": "Add vanish login features\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-07T07:44:29Z", "type": "commit"}, {"oid": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "url": "https://github.com/PGMDev/PGM/commit/f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "message": "Remove staff-count auto vanish\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-07T15:35:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDQwMw==", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840403", "bodyText": "Make this 30 seconds, which is the login timeout.", "author": "Electroid", "createdAt": "2020-05-07T22:56:09Z", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();", "originalCommit": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA==", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840580", "bodyText": "Maybe you want to do this check in AsyncPreLoginEvent?", "author": "Electroid", "createdAt": "2020-05-07T22:56:41Z", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {", "originalCommit": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTExMw==", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421841113", "bodyText": "Also, before the if statement, always invalidate the Cache for the player.", "author": "Electroid", "createdAt": "2020-05-07T22:58:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg3MDk4Mw==", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421870983", "bodyText": "As discussed AsyncPreLoginEvent does not have a way to determine the address used to login to the server with. Sticking with PlayerLoginEvent for now.", "author": "applenick", "createdAt": "2020-05-08T00:35:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDU4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MDY5Mw==", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421840693", "bodyText": "You'll want to remove from the Cache", "author": "Electroid", "createdAt": "2020-05-07T22:57:02Z", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -133,10 +137,38 @@ public void vanish(MatchPlayer sender, @Switch('s') boolean silent) throws Comma\n   }\n \n   /* Events */\n+  private final Cache<UUID, String> loginSubdomains =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.SECONDS).build();\n+\n+  @EventHandler(priority = EventPriority.MONITOR)\n+  public void onPreJoin(PlayerLoginEvent event) {\n+    Player player = event.getPlayer();\n+    if (player.hasPermission(Permissions.VANISH)\n+        && !isVanished(player.getUniqueId())\n+        && isVanishSubdomain(event.getHostname())) {\n+      loginSubdomains.put(player.getUniqueId(), event.getHostname());\n+    }\n+  }\n+\n   @EventHandler(priority = EventPriority.MONITOR)\n   public void onJoin(PlayerJoinEvent event) {\n-    if (isVanished(event.getPlayer().getUniqueId())) {\n-      matchManager.getPlayer(event.getPlayer()).setVanished(true);\n+    MatchPlayer player = matchManager.getPlayer(event.getPlayer());\n+    if (isVanished(player.getId())) { // Player is already vanished\n+      player.setVanished(true);\n+    } else if (player\n+        .getBukkit()\n+        .hasPermission(Permissions.VANISH)) { // Player is not vanished, but has permission to\n+\n+      // Automatic vanish if player logs in via a \"vanish\" subdomain.\n+      String domain = loginSubdomains.getIfPresent(player.getId());", "originalCommit": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTIwMw==", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421841203", "bodyText": "No need for config, I think this is ok.", "author": "Electroid", "createdAt": "2020-05-07T22:58:35Z", "path": "core/src/main/java/tc/oc/pgm/community/features/VanishManagerImpl.java", "diffHunk": "@@ -145,6 +177,10 @@ public void checkMatchPlayer(MatchPlayerAddEvent event) {\n     event.getPlayer().setVanished(isVanished(event.getPlayer().getId()));\n   }\n \n+  private boolean isVanishSubdomain(String address) {\n+    return address.startsWith(\"vanish\"); // TODO Maybe allow config value?", "originalCommit": "f6b4a1c9adb4235c7d0bedaee3087ed74d9efb45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg1MTgzMg==", "url": "https://github.com/PGMDev/PGM/pull/462#discussion_r421851832", "bodyText": "I'd make it vanish., otherwise it may match more than you want, i can only imagine some vanished.network having trouble with it", "author": "Pablete1234", "createdAt": "2020-05-07T23:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg0MTIwMw=="}], "type": "inlineReview"}, {"oid": "77d80619cbbacd2116a9017fd53eaf52e681bfa9", "url": "https://github.com/PGMDev/PGM/commit/77d80619cbbacd2116a9017fd53eaf52e681bfa9", "message": "Adjust vanish subdomain and clean up cache\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-08T00:34:13Z", "type": "commit"}, {"oid": "b3a70be2c7243088bb04e87dc7817871eb9e66d5", "url": "https://github.com/PGMDev/PGM/commit/b3a70be2c7243088bb04e87dc7817871eb9e66d5", "message": "Remove vanish login message\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-09T00:54:24Z", "type": "commit"}]}