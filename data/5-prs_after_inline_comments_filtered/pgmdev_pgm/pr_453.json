{"pr_number": 453, "pr_title": "Multiple fixes for various moderation features", "pr_createdAt": "2020-05-03T20:07:17Z", "pr_url": "https://github.com/PGMDev/PGM/pull/453", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1NzMwNQ==", "url": "https://github.com/PGMDev/PGM/pull/453#discussion_r419157305", "bodyText": "TextFormatter.list", "author": "Electroid", "createdAt": "2020-05-03T20:41:44Z", "path": "core/src/main/java/tc/oc/pgm/community/commands/ModerationCommands.java", "diffHunk": "@@ -98,124 +98,116 @@ private void removeCachedBan(BannedAccountInfo info) {\n   @Command(\n       aliases = {\"staff\", \"mods\", \"admins\"},\n       desc = \"List the online staff members\")\n-  public void staff(CommandSender sender, Match match) {\n+  public void staff(Audience viewer, CommandSender sender, Match match) {\n     // List of online staff based off of permission\n     List<Component> onlineStaff =\n         match.getPlayers().stream()\n-            .filter(player -> player.getBukkit().hasPermission(Permissions.STAFF))\n-            .map(player -> player.getStyledName(NameStyle.FANCY))\n+            .filter(\n+                player ->\n+                    (player.getBukkit().hasPermission(Permissions.STAFF)\n+                        && (!player.isVanished() || sender.hasPermission(Permissions.STAFF))))\n+            .map(p -> p.getName(NameStyle.VERBOSE))\n             .collect(Collectors.toList());\n \n     // FORMAT: Online Staff ({count}): {names}\n     Component staffCount =\n-        new PersonalizedText(Integer.toString(onlineStaff.size()))\n-            .color(onlineStaff.isEmpty() ? ChatColor.RED : ChatColor.AQUA);\n+        TextComponent.of(Integer.toString(onlineStaff.size()))\n+            .color(onlineStaff.isEmpty() ? TextColor.RED : TextColor.AQUA);\n \n     Component content =\n         onlineStaff.isEmpty()\n-            ? new PersonalizedTranslatable(\"moderation.staff.empty\")\n-                .getPersonalizedText()\n-                .color(ChatColor.RED)\n-            : new Component(\n-                Components.join(new PersonalizedText(\", \").color(ChatColor.GRAY), onlineStaff));\n+            ? TranslatableComponent.of(\"moderation.staff.empty\")\n+            : TextComponent.join(TextComponent.of(\", \", TextColor.GRAY), onlineStaff);", "originalCommit": "632d3c22453646894c55d06011aff485d7f3597e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1NzQxMg==", "url": "https://github.com/PGMDev/PGM/pull/453#discussion_r419157412", "bodyText": "Can we use the page translations we have? It's either under command or misc.", "author": "Electroid", "createdAt": "2020-05-03T20:42:59Z", "path": "core/src/main/java/tc/oc/pgm/community/commands/ModerationCommands.java", "diffHunk": "@@ -546,30 +532,27 @@ public void alts(\n       int pages = (altAccounts.size() + perPage - 1) / perPage;\n \n       Component pageNum =\n-          new PersonalizedTranslatable(\n-                  \"command.simplePageHeader\",\n-                  new PersonalizedText(Integer.toString(page)).color(ChatColor.DARK_AQUA),\n-                  new PersonalizedText(Integer.toString(pages)).color(ChatColor.DARK_AQUA))\n-              .getPersonalizedText()\n-              .color(ChatColor.GRAY);\n+          TranslatableComponent.of(\"command.simplePageHeader\", TextColor.GRAY)\n+              .args(\n+                  TextComponent.of(Integer.toString(page), TextColor.DARK_AQUA),\n+                  TextComponent.of(Integer.toString(pages), TextColor.DARK_AQUA));\n \n       Component headerText =\n-          new PersonalizedTranslatable(\"moderation.alts.header\")\n-              .getPersonalizedText()\n-              .color(ChatColor.DARK_AQUA);\n+          TranslatableComponent.of(\"moderation.alts.header\", TextColor.DARK_AQUA);\n \n       Component header =\n-          new PersonalizedText(\n-              headerText,\n-              new PersonalizedText(\" (\").color(ChatColor.GRAY),\n-              new PersonalizedText(Integer.toString(altAccounts.size())).color(ChatColor.DARK_AQUA),\n-              new PersonalizedText(\") \u00bb Page \").color(ChatColor.GRAY),\n-              pageNum);\n+          TextComponent.builder()\n+              .append(headerText)\n+              .append(\" (\", TextColor.GRAY)\n+              .append(Integer.toString(altAccounts.size()), TextColor.DARK_AQUA)\n+              .append(\") \u00bb Page \", TextColor.GRAY)", "originalCommit": "632d3c22453646894c55d06011aff485d7f3597e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1NzYxMg==", "url": "https://github.com/PGMDev/PGM/pull/453#discussion_r419157612", "bodyText": "I would modify Audience to add showTitle and the hotbar with the new components. Make them defaults and use TextTranslations", "author": "Electroid", "createdAt": "2020-05-03T20:44:40Z", "path": "core/src/main/java/tc/oc/pgm/community/commands/ModerationCommands.java", "diffHunk": "@@ -824,71 +780,74 @@ public static String formatPunishmentScreen(\n     List<Component> lines = Lists.newArrayList();\n \n     Component header =\n-        new PersonalizedText(\n+        TextComponent.of(\n             ComponentUtils.horizontalLineHeading(\n                 PGMConfig.Moderation.getServerName(), ChatColor.DARK_GRAY));\n-\n     Component footer =\n-        new PersonalizedText(\n+        TextComponent.of(\n             ComponentUtils.horizontalLine(ChatColor.DARK_GRAY, ComponentUtils.MAX_CHAT_WIDTH));\n \n     lines.add(header); // Header Line (server name) - START\n-    lines.add(Components.blank());\n+    lines.add(TextComponent.empty());\n     lines.add(type.getScreenComponent(formatPunishmentReason(reason))); // The reason\n-    lines.add(Components.blank());\n+    lines.add(TextComponent.empty());\n \n     // If punishment expires, inform user when\n     if (expires != null) {\n       Component timeLeft =\n-          PeriodFormats.briefNaturalApproximate(java.time.Duration.ofSeconds(expires.getSeconds()));\n+          TextComponent.of(\n+              ComponentRenderers.toLegacyText(\n+                  PeriodFormats.briefNaturalApproximate(\n+                      java.time.Duration.ofSeconds(expires.getSeconds())),\n+                  Bukkit.getConsoleSender()));\n       lines.add(\n-          new PersonalizedTranslatable(\"moderation.screen.expires\", timeLeft)\n-              .getPersonalizedText()\n-              .color(ChatColor.GRAY));\n-      lines.add(Components.blank());\n+          TranslatableComponent.of(\"moderation.screen.expires\", TextColor.GRAY).args(timeLeft));\n+      lines.add(TextComponent.empty());\n     }\n \n-    // Staff sign-off\n-    lines.add(\n-        new PersonalizedTranslatable(\"moderation.screen.signoff\", punisher)\n-            .getPersonalizedText()\n-            .color(ChatColor.GRAY)); // The sign-off of who performed the punishment\n+    // Staff sign-off - who performed the punishment\n+    lines.add(TranslatableComponent.of(\"moderation.screen.signoff\", TextColor.GRAY).args(punisher));\n \n     // Link to rules for review by player\n     if (PGMConfig.Moderation.isRuleLinkVisible()) {\n-      Component rules = new PersonalizedText(PGMConfig.Moderation.getRulesLink());\n+      Component rules = TextComponent.of(PGMConfig.Moderation.getRulesLink());\n \n-      lines.add(Components.blank());\n+      lines.add(TextComponent.empty());\n       lines.add(\n-          new PersonalizedTranslatable(\"moderation.screen.rulesLink\", rules)\n-              .getPersonalizedText()\n-              .color(ChatColor.GRAY)); // A link to the rules\n+          TranslatableComponent.of(\"moderation.screen.rulesLink\", TextColor.GRAY)\n+              .args(rules)); // Link to rules\n     }\n \n     // Configurable last line (for appeal message or etc)\n     if (PGMConfig.Moderation.isAppealVisible() && type.equals(PunishmentType.BAN)) {\n-      lines.add(Components.blank());\n-      lines.add(new PersonalizedText(PGMConfig.Moderation.getAppealMessage()));\n+      lines.add(TextComponent.empty());\n+      lines.add(TextComponent.of(PGMConfig.Moderation.getAppealMessage()));\n     }\n \n-    lines.add(Components.blank());\n+    lines.add(TextComponent.empty());\n     lines.add(footer); // Footer line - END\n \n-    return Components.join(new PersonalizedText(\"\\n\" + ChatColor.RESET), lines).toLegacyText();\n+    return TextTranslations.translateLegacy(\n+        TextComponent.join(TextComponent.of(\"\\n\" + ChatColor.RESET), lines),\n+        null); // TODO add viewer\n   }\n \n   /*\n    * Sends a formatted title and plays a sound warning a user of their actions\n    */\n   private void sendWarning(MatchPlayer target, String reason) {\n-    Component titleWord =\n-        new PersonalizedTranslatable(\"misc.warning\")\n-            .getPersonalizedText()\n-            .color(ChatColor.DARK_RED);\n-    Component title = new PersonalizedText(WARN_SYMBOL, titleWord, WARN_SYMBOL);\n-    Component subtitle = formatPunishmentReason(reason).color(ChatColor.GOLD);\n-\n-    target.showTitle(title, subtitle, 5, 200, 10);\n+    Component titleWord = TranslatableComponent.of(\"misc.warning\", TextColor.DARK_RED);\n+    Component title =\n+        TextComponent.builder().append(WARN_SYMBOL).append(titleWord).append(WARN_SYMBOL).build();\n+    Component subtitle = formatPunishmentReason(reason).color(TextColor.GOLD);\n+\n+    // TODO: Upgrade show title to new text\n+    tc.oc.pgm.util.component.Component oldTitle =\n+        new PersonalizedText(TextTranslations.translateLegacy(title, target.getBukkit()));\n+    tc.oc.pgm.util.component.Component oldSubTitle =\n+        new PersonalizedText(TextTranslations.translateLegacy(subtitle, target.getBukkit()));\n+\n+    target.showTitle(oldTitle, oldSubTitle, 5, 200, 10);", "originalCommit": "632d3c22453646894c55d06011aff485d7f3597e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1NzYzOA==", "url": "https://github.com/PGMDev/PGM/pull/453#discussion_r419157638", "bodyText": "Just use time here?", "author": "Electroid", "createdAt": "2020-05-03T20:45:07Z", "path": "core/src/main/java/tc/oc/pgm/community/commands/ModerationCommands.java", "diffHunk": "@@ -980,12 +936,14 @@ public Component getPunisher() {\n \n     public Component getHoverMessage() {\n       Component timeAgo =\n-          PeriodFormats.relativePastApproximate(java.time.Instant.ofEpochMilli(time.toEpochMilli()))\n-              .color(ChatColor.DARK_AQUA);\n-\n-      return new PersonalizedTranslatable(\"moderation.similarIP.hover\", getPunisher(), timeAgo)\n-          .getPersonalizedText()\n-          .color(ChatColor.GRAY);\n+          TextComponent.of(\n+              ComponentRenderers.toLegacyText(\n+                  PeriodFormats.relativePastApproximate(\n+                          java.time.Instant.ofEpochMilli(time.toEpochMilli()))", "originalCommit": "632d3c22453646894c55d06011aff485d7f3597e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTE1NzY5Nw==", "url": "https://github.com/PGMDev/PGM/pull/453#discussion_r419157697", "bodyText": "misc.unknown I believe exists", "author": "Electroid", "createdAt": "2020-05-03T20:45:45Z", "path": "core/src/main/java/tc/oc/pgm/community/commands/ReportCommands.java", "diffHunk": "@@ -149,98 +144,115 @@ public void reportHistory(\n     if (target != null) {\n       reportList =\n           reportList.stream()\n-              .filter(r -> r.getId().equalsIgnoreCase(target))\n+              .filter(r -> r.getTargetName(match).equalsIgnoreCase(target))\n               .collect(Collectors.toList());\n     }\n \n     Collections.sort(reportList); // Sort list\n     Collections.reverse(reportList); // Reverse so most recent show up first\n \n-    Component headerResultCount =\n-        new PersonalizedText(Long.toString(reportList.size())).color(ChatColor.RED);\n+    Component headerResultCount = TextComponent.of(Long.toString(reportList.size()), TextColor.RED);\n \n     int perPage = 6;\n     int pages = (reportList.size() + perPage - 1) / perPage;\n \n     Component pageNum =\n-        new PersonalizedTranslatable(\n-                \"command.simplePageHeader\",\n-                new PersonalizedText(Integer.toString(page)).color(ChatColor.RED),\n-                new PersonalizedText(Integer.toString(pages)).color(ChatColor.RED))\n-            .add(ChatColor.AQUA);\n+        TranslatableComponent.of(\"command.simplePageHeader\", TextColor.AQUA)\n+            .args(\n+                TextComponent.of(Integer.toString(page), TextColor.RED),\n+                TextComponent.of(Integer.toString(pages), TextColor.RED));\n \n     Component header =\n-        new PersonalizedText(\n-            new PersonalizedTranslatable(\"moderation.reports.header\", headerResultCount, pageNum)\n-                .getPersonalizedText()\n-                .color(ChatColor.GRAY),\n-            new PersonalizedText(\" (\"),\n-            headerResultCount,\n-            new PersonalizedText(\") \u00bb \"),\n-            pageNum);\n+        TranslatableComponent.of(\"moderation.reports.header\", TextColor.GRAY)\n+            .args(headerResultCount, pageNum)\n+            .append(\n+                TextComponent.of(\" (\")\n+                    .append(headerResultCount)\n+                    .append(TextComponent.of(\") \u00bb \"))\n+                    .append(pageNum));\n \n     Component formattedHeader =\n-        new PersonalizedText(\n+        TextComponent.of(\n             ComponentUtils.horizontalLineHeading(\n-                ComponentRenderers.toLegacyText(header, sender), ChatColor.DARK_GRAY));\n+                TextTranslations.translateLegacy(header, sender), ChatColor.DARK_GRAY));\n \n     new PrettyPaginatedComponentResults<Report>(formattedHeader, perPage) {\n       @Override\n       public Component format(Report data, int index) {\n \n         Component reporter =\n-            new PersonalizedTranslatable(\"moderation.reports.hover\", data.getSenderName())\n-                .color(ChatColor.GRAY);\n+            TranslatableComponent.of(\"moderation.reports.hover\", TextColor.GRAY)\n+                .args(data.getSenderComponent(match));\n \n         Component timeAgo =\n-            PeriodFormats.relativePastApproximate(\n-                    java.time.Instant.ofEpochMilli(data.getTimeSent().toEpochMilli()))\n-                .color(ChatColor.DARK_AQUA);\n-\n-        return new PersonalizedText(\n-            new PersonalizedText(timeAgo.render(sender))\n-                .hoverEvent(Action.SHOW_TEXT, reporter.render(sender)),\n-            new PersonalizedText(\": \").color(ChatColor.GRAY),\n-            data.getTargetName(),\n-            new PersonalizedText(\" \u00ab \").color(ChatColor.YELLOW),\n-            new PersonalizedText(data.getReason()).italic(true).color(ChatColor.WHITE));\n+            TextComponent.of(\n+                ComponentRenderers.toLegacyText(\n+                    PeriodFormats.relativePastApproximate(\n+                            Instant.ofEpochMilli(data.getTimeSent().toEpochMilli()))\n+                        .color(ChatColor.DARK_AQUA),\n+                    sender));\n+\n+        return TextComponent.builder()\n+            .append(timeAgo.hoverEvent(HoverEvent.of(Action.SHOW_TEXT, reporter)))\n+            .append(\": \", TextColor.GRAY)\n+            .append(data.getTargetComponent(match))\n+            .append(\" \u00ab \", TextColor.YELLOW)\n+            .append(data.getReason(), TextColor.WHITE, TextDecoration.ITALIC)\n+            .build();\n       }\n     }.display(audience, reportList, page);\n   }\n \n-  public static class Report implements Comparable<Report> {\n-    private final String id;\n+  private class Report implements Comparable<Report> {\n+    private final UUID targetUUID;\n+    private final UUID senderUUID;\n     private final String reason;\n-    private final Component targetName;\n-    private final Component sender;\n     private final Instant timeSent;\n \n-    public Report(String id, String reason, Component targetName, Component sender) {\n-      this.id = id;\n+    public Report(UUID target, UUID sender, String reason) {\n+      this.targetUUID = target;\n+      this.senderUUID = sender;\n       this.reason = reason;\n-      this.targetName = targetName;\n-      this.sender = sender;\n       this.timeSent = Instant.now();\n     }\n \n-    public String getId() {\n-      return id;\n+    public UUID getTarget() {\n+      return targetUUID;\n+    }\n+\n+    public UUID getSender() {\n+      return senderUUID;\n     }\n \n     public String getReason() {\n-      return reason;\n+      return reason.trim();\n     }\n \n-    public Component getTargetName() {\n-      return targetName;\n+    public Instant getTimeSent() {\n+      return timeSent;\n     }\n \n-    public Component getSenderName() {\n-      return sender;\n+    public String getTargetName(Match match) {\n+      return database.getUsername(targetUUID).getName();\n     }\n \n-    public Instant getTimeSent() {\n-      return timeSent;\n+    public Component getTargetComponent(Match match) {\n+      return getUsername(getTarget(), match);\n+    }\n+\n+    public Component getSenderComponent(Match match) {\n+      return getUsername(getSender(), match);\n+    }\n+\n+    private Component getUsername(UUID uuid, Match match) {\n+      MatchPlayer player = match.getPlayer(targetUUID);\n+      Component name = TextComponent.of(\"Unknown\", TextColor.AQUA, TextDecoration.ITALIC);", "originalCommit": "632d3c22453646894c55d06011aff485d7f3597e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9225d8ccdc447947bcd45abd446b3e9b636caf8d", "url": "https://github.com/PGMDev/PGM/commit/9225d8ccdc447947bcd45abd446b3e9b636caf8d", "message": "Multiple fixes for various moderation features\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-04T07:31:02Z", "type": "commit"}, {"oid": "77072af543b90356a80732e09d187936b337a546", "url": "https://github.com/PGMDev/PGM/commit/77072af543b90356a80732e09d187936b337a546", "message": "Update with more fixes\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-04T07:31:03Z", "type": "commit"}, {"oid": "77072af543b90356a80732e09d187936b337a546", "url": "https://github.com/PGMDev/PGM/commit/77072af543b90356a80732e09d187936b337a546", "message": "Update with more fixes\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-04T07:31:03Z", "type": "forcePushed"}, {"oid": "982072b61d68977e7d0bfba71598de3d9918181a", "url": "https://github.com/PGMDev/PGM/commit/982072b61d68977e7d0bfba71598de3d9918181a", "message": "Switch /freeze and /vanish to toggle modes\nThis removes /unfreeze and /unvanish in favor of a single command\nAlso:\n* Migrated MapPoolCommands to new text library\n* Fixed warning color bug\n* Added new methods to TextFormatter\n\nSigned-off-by: applenick <applenick@users.noreply.github.com>", "committedDate": "2020-05-05T06:56:40Z", "type": "commit"}]}