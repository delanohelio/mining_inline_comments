{"pr_number": 681, "pr_title": "Cleanup player components & name decorations", "pr_createdAt": "2020-10-17T17:34:34Z", "pr_url": "https://github.com/PGMDev/PGM/pull/681", "timeline": [{"oid": "80524ab16d4869fe694e28952ae74df01c363910", "url": "https://github.com/PGMDev/PGM/commit/80524ab16d4869fe694e28952ae74df01c363910", "message": "Cleanup player components & name decorations\n\nSigned-off-by: Pablete1234 <pabloherrerapalacio@gmail.com>", "committedDate": "2020-10-17T17:28:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjk4NjM3MA==", "url": "https://github.com/PGMDev/PGM/pull/681#discussion_r506986370", "bodyText": "player ? :)", "author": "Electroid", "createdAt": "2020-10-17T21:33:56Z", "path": "core/src/main/java/tc/oc/pgm/namedecorations/NameDecorationRegistryImpl.java", "diffHunk": "@@ -1,98 +1,148 @@\n package tc.oc.pgm.namedecorations;\n \n import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n+import javax.annotation.Nonnull;\n import javax.annotation.Nullable;\n+\n+import com.google.common.cache.CacheBuilder;\n+import com.google.common.cache.CacheLoader;\n+import com.google.common.cache.LoadingCache;\n import net.kyori.text.Component;\n import net.kyori.text.TextComponent;\n import net.kyori.text.format.TextColor;\n-import net.md_5.bungee.api.ChatColor;\n import org.bukkit.Bukkit;\n+import org.bukkit.ChatColor;\n import org.bukkit.entity.Player;\n import org.bukkit.event.EventHandler;\n+import org.bukkit.event.EventPriority;\n import org.bukkit.event.Listener;\n+import org.bukkit.event.player.PlayerJoinEvent;\n+import org.bukkit.metadata.FixedMetadataValue;\n+import org.bukkit.metadata.MetadataValue;\n import tc.oc.pgm.api.PGM;\n import tc.oc.pgm.api.event.NameDecorationChangeEvent;\n import tc.oc.pgm.api.party.Party;\n import tc.oc.pgm.api.player.MatchPlayer;\n import tc.oc.pgm.events.PlayerJoinMatchEvent;\n import tc.oc.pgm.events.PlayerPartyChangeEvent;\n+import tc.oc.pgm.util.named.NameDecorationProvider;\n import tc.oc.pgm.util.text.TextFormatter;\n+import tc.oc.pgm.util.text.types.PlayerComponent;\n \n+@SuppressWarnings(\"UnstableApiUsage\")\n public class NameDecorationRegistryImpl implements NameDecorationRegistry, Listener {\n \n+  private final MetadataValue METADATA_VALUE = new FixedMetadataValue(PGM.get(), this);\n+\n   private NameDecorationProvider provider;\n+  private final LoadingCache<UUID, DecorationCacheEntry> decorationCache =\n+      CacheBuilder.newBuilder().expireAfterAccess(1, TimeUnit.HOURS)\n+          .build(new CacheLoader<UUID, DecorationCacheEntry>() {\n+            @Override\n+            public DecorationCacheEntry load(@Nonnull UUID uuid) {\n+              return new DecorationCacheEntry(uuid);\n+            }\n+          });\n \n   public NameDecorationRegistryImpl(@Nullable NameDecorationProvider provider) {\n-    this.provider = provider;\n+    setProvider(provider);\n+  }\n+\n+  @EventHandler(priority = EventPriority.LOW)\n+  public void onPlayerJoin(PlayerJoinEvent e) {\n+    e.getPlayer().setMetadata(METADATA_KEY, METADATA_VALUE);\n   }\n \n   @EventHandler\n   public void onJoinMatch(PlayerJoinMatchEvent event) {\n     Player player = event.getPlayer().getBukkit();\n-    player.setDisplayName(getDecoratedName(player, event.getNewParty()));\n+    Party party = event.getNewParty();\n+    player.setDisplayName(getDecoratedName(player, party == null ? null : party.getColor()));\n   }\n \n   @EventHandler\n   public void onPartyChange(PlayerPartyChangeEvent event) {\n     Player player = event.getPlayer().getBukkit();\n-    player.setDisplayName(getDecoratedName(player, event.getNewParty()));\n+    Party party = event.getNewParty();\n+    player.setDisplayName(getDecoratedName(player, party == null ? null : party.getColor()));\n   }\n \n   @EventHandler\n   public void onNameDecorationChange(NameDecorationChangeEvent event) {\n     if (event.getUUID() == null) return;\n+    decorationCache.invalidate(event.getUUID());\n \n     final Player player = Bukkit.getPlayer(event.getUUID());\n     final MatchPlayer matchPlayer = PGM.get().getMatchManager().getPlayer(player);\n     if (matchPlayer == null) return;\n \n-    matchPlayer.getBukkit().setDisplayName(getDecoratedName(player, matchPlayer.getParty()));\n+    matchPlayer.getBukkit().setDisplayName(getDecoratedName(player, matchPlayer.getParty().getColor()));\n   }\n \n   @Override\n-  public String getDecoratedName(Player player, Party party) {\n+  public String getDecoratedName(Player player, ChatColor partyColor) {\n     return getPrefix(player.getUniqueId())\n-        + (party == null ? ChatColor.RESET : party.getColor())\n+        + (partyColor == null ? ChatColor.RESET : partyColor)\n         + player.getName()\n         + getSuffix(player.getUniqueId())\n         + ChatColor.WHITE;\n   }\n \n   @Override\n-  public Component getDecoratedNameComponent(Player player, Party party) {\n+  public Component getDecoratedNameComponent(Player player, ChatColor partyColor) {\n     return TextComponent.builder()\n         .append(getPrefixComponent(player.getUniqueId()))\n         .append(\n             player.getName(),\n-            party == null ? TextColor.WHITE : TextFormatter.convert(party.getColor()))\n+            partyColor == null ? TextColor.WHITE : TextFormatter.convert(partyColor))\n         .append(getSuffixComponent(player.getUniqueId()))\n         .build();\n   }\n \n   public String getPrefix(UUID uuid) {\n-    return provider != null ? provider.getPrefix(uuid) : \"\";\n+    return decorationCache.getUnchecked(uuid).prefix;\n   }\n \n   public String getSuffix(UUID uuid) {\n-    return provider != null ? provider.getSuffix(uuid) : \"\";\n+    return decorationCache.getUnchecked(uuid).suffix;\n+  }\n+\n+  public TextColor getColor(UUID uuid) {\n+    MatchPlayer pl = PGM.get().getMatchManager().getPlayer(uuid);", "originalCommit": "80524ab16d4869fe694e28952ae74df01c363910", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "url": "https://github.com/PGMDev/PGM/commit/0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "message": "Comply with formatter, and minor changes\n\nSigned-off-by: Pablete1234 <pabloherrerapalacio@gmail.com>", "committedDate": "2020-10-17T23:46:06Z", "type": "commit"}, {"oid": "0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "url": "https://github.com/PGMDev/PGM/commit/0a7bd871be0c8f00047a8ac176fe1a8b037f2755", "message": "Comply with formatter, and minor changes\n\nSigned-off-by: Pablete1234 <pabloherrerapalacio@gmail.com>", "committedDate": "2020-10-17T23:46:06Z", "type": "forcePushed"}, {"oid": "17d1cd885e95ae9e64de3d9daa4696cb8229696c", "url": "https://github.com/PGMDev/PGM/commit/17d1cd885e95ae9e64de3d9daa4696cb8229696c", "message": "Merge branch 'dev' into player-component-cleanup", "committedDate": "2020-10-20T23:51:54Z", "type": "commit"}, {"oid": "de8930b7bf5d2ec7fb9174a24fd9aaea987bb934", "url": "https://github.com/PGMDev/PGM/commit/de8930b7bf5d2ec7fb9174a24fd9aaea987bb934", "message": "Merge branch 'dev' into player-component-cleanup", "committedDate": "2020-10-25T23:02:28Z", "type": "commit"}]}