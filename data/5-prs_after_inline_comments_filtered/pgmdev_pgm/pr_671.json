{"pr_number": 671, "pr_title": "Add offset filter", "pr_createdAt": "2020-10-04T17:31:06Z", "pr_url": "https://github.com/PGMDev/PGM/pull/671", "timeline": [{"oid": "dba65089275671e1438a4741ae17916edfc4a0d2", "url": "https://github.com/PGMDev/PGM/commit/dba65089275671e1438a4741ae17916edfc4a0d2", "message": "Properly implement local locations\n- OffsetFilter -> LocationQueryModifier\n\nSigned-off-by: KingSimon <simonmorland@gmail.com>", "committedDate": "2020-10-07T22:00:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5Nzg5OQ==", "url": "https://github.com/PGMDev/PGM/pull/671#discussion_r501697899", "bodyText": "You're losing pitch & yaw information when doing this.\nUse location.set(x,y,z) to keep yaw/pitch, but watch out of unintended side-effects, i doubt it will be a thing since player#getLocation always returns a new location, but if other places create this location it could be keeping it modified even after leaving the child filter.\nAlternatively just copy pitch & yaw alongisde world", "author": "Pablete1234", "createdAt": "2020-10-08T12:56:40Z", "path": "core/src/main/java/tc/oc/pgm/filters/LocationQueryModifier.java", "diffHunk": "@@ -0,0 +1,96 @@\n+package tc.oc.pgm.filters;\n+\n+import javax.annotation.Nullable;\n+import org.bukkit.Location;\n+import org.bukkit.event.Event;\n+import org.bukkit.util.Vector;\n+import tc.oc.pgm.api.filter.Filter;\n+import tc.oc.pgm.api.filter.query.LocationQuery;\n+import tc.oc.pgm.filters.query.BlockQuery;\n+\n+public class LocationQueryModifier extends QueryModifier<LocationQuery> {\n+\n+  private final String[] coords;\n+  private final boolean local;\n+  Filter child;\n+\n+  public LocationQueryModifier(Filter child, String[] coords, boolean local) {\n+    super(child);\n+    this.coords = coords;\n+    this.local = local;\n+    this.child = child;\n+  }\n+\n+  @Override\n+  protected LocationQuery modifyQuery(LocationQuery query) {\n+    Location location = query.getLocation();\n+\n+    Vector newVector;\n+\n+    if (local) {\n+      newVector = parseLocalLocation(query.getLocation(), coords[0], coords[1], coords[2]);\n+    } else {\n+      newVector =\n+          new Vector(\n+              parseRelativeLocation(coords[0], location.getX()),\n+              parseRelativeLocation(coords[1], location.getY()),\n+              parseRelativeLocation(coords[2], location.getZ()));\n+    }\n+\n+    return new BlockQueryCustomLocation(\n+        query.getEvent(), newVector.toLocation(query.getMatch().getWorld()));", "originalCommit": "dba65089275671e1438a4741ae17916edfc4a0d2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4NTIxNw==", "url": "https://github.com/PGMDev/PGM/pull/671#discussion_r501785217", "bodyText": "this is solved with a clone(), good catch!", "author": "KingOfSquares", "createdAt": "2020-10-08T14:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5Nzg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODkwNzE5MA==", "url": "https://github.com/PGMDev/PGM/pull/671#discussion_r508907190", "bodyText": "Break this up into multiple classes, right now you are parsing this field during every query. Same with the relative vs. absolute coordinates. Do parsing at XML time, but it creates different classes with different functionality.", "author": "Electroid", "createdAt": "2020-10-20T23:55:30Z", "path": "core/src/main/java/tc/oc/pgm/filters/LocationQueryModifier.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package tc.oc.pgm.filters;\n+\n+import javax.annotation.Nullable;\n+import org.bukkit.Location;\n+import org.bukkit.event.Event;\n+import org.bukkit.util.Vector;\n+import tc.oc.pgm.api.filter.Filter;\n+import tc.oc.pgm.api.filter.query.LocationQuery;\n+import tc.oc.pgm.filters.query.BlockQuery;\n+\n+public class LocationQueryModifier extends QueryModifier<LocationQuery> {\n+\n+  private final String[] coords;", "originalCommit": "5f8e79419a74533669f5e6f45c9254ce6cc1b7ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTYwMDAxNw==", "url": "https://github.com/PGMDev/PGM/pull/671#discussion_r525600017", "bodyText": "I belive you could just pass this vector arround instead of a double[] with 3 values.\nIn case of the WorldLocationQueryModifier, pass both the vector and if x, y or z are relative or absolute", "author": "Pablete1234", "createdAt": "2020-11-17T23:45:46Z", "path": "core/src/main/java/tc/oc/pgm/filters/FilterParser.java", "diffHunk": "@@ -443,4 +446,46 @@ public StructuralLoadFilter parseStructuralLoad(Element el) throws InvalidXMLExc\n   public TimeFilter parseTimeFilter(Element el) throws InvalidXMLException {\n     return new TimeFilter(XMLUtils.parseDuration(el, null));\n   }\n+\n+  // Methods for parsing QueryModifiers\n+\n+  @MethodParser(\"offset\")\n+  public LocationQueryModifier parseOffsetFilter(Element el) throws InvalidXMLException {\n+    String value = el.getAttributeValue(\"location\");\n+    // Check vector format\n+    XMLUtils.parseVector(new Node(el), value.replaceAll(\"[\\\\^~]\", \"\"));", "originalCommit": "dbd3c102aaa5b07c45925fbbc3e5b08edaef4662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e12b44dbb2b016aae94e5cba86b171ceaf2d3ff", "url": "https://github.com/PGMDev/PGM/commit/3e12b44dbb2b016aae94e5cba86b171ceaf2d3ff", "message": "Add offset filter\n\nSigned-off-by: KingSimon <manmusic979@gmail.com>\nSigned-off-by: KingSimon <simonmorland@gmail.com>", "committedDate": "2020-12-03T21:57:55Z", "type": "commit"}, {"oid": "07fe6109cb6fa2719282c80ccede8bdf8d7604cd", "url": "https://github.com/PGMDev/PGM/commit/07fe6109cb6fa2719282c80ccede8bdf8d7604cd", "message": "Properly implement local locations\n- OffsetFilter -> LocationQueryModifier\n\nSigned-off-by: KingSimon <simonmorland@gmail.com>", "committedDate": "2020-12-03T21:58:23Z", "type": "commit"}, {"oid": "626f143441ab468d67ddc4148c252ae9b10a7f86", "url": "https://github.com/PGMDev/PGM/commit/626f143441ab468d67ddc4148c252ae9b10a7f86", "message": "Keep correct yaw and pitch after modification\n\nSigned-off-by: KingSimon <19822231+KingOfSquares@users.noreply.github.com>", "committedDate": "2020-12-03T21:58:23Z", "type": "commit"}, {"oid": "020530c5a952207c8e9b059e0246390f13e3c467", "url": "https://github.com/PGMDev/PGM/commit/020530c5a952207c8e9b059e0246390f13e3c467", "message": "Split the LocationQueryModifier into two separate ones\n- All string -> coordinate is done at XML parsing time\n\nSigned-off-by: KingSimon <19822231+KingOfSquares@users.noreply.github.com>", "committedDate": "2020-12-03T21:58:23Z", "type": "commit"}, {"oid": "b1c121aed7538e6349795b16bdaba4f574444b5d", "url": "https://github.com/PGMDev/PGM/commit/b1c121aed7538e6349795b16bdaba4f574444b5d", "message": "Use Vector instead of double array\n\nSigned-off-by: KingSimon <19822231+KingOfSquares@users.noreply.github.com>", "committedDate": "2020-12-03T22:05:07Z", "type": "commit"}, {"oid": "b1c121aed7538e6349795b16bdaba4f574444b5d", "url": "https://github.com/PGMDev/PGM/commit/b1c121aed7538e6349795b16bdaba4f574444b5d", "message": "Use Vector instead of double array\n\nSigned-off-by: KingSimon <19822231+KingOfSquares@users.noreply.github.com>", "committedDate": "2020-12-03T22:05:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNzc3NQ==", "url": "https://github.com/PGMDev/PGM/pull/671#discussion_r535717775", "bodyText": "You're already running an XMLUtils.parseVector all the way at the top, no need to parse individual coords in substrings", "author": "Pablete1234", "createdAt": "2020-12-03T23:19:11Z", "path": "core/src/main/java/tc/oc/pgm/filters/FilterParser.java", "diffHunk": "@@ -453,4 +457,46 @@ public TimeFilter parseTimeFilter(Element el) throws InvalidXMLException {\n   public ScoreFilter parseScoreFilter(Element el) throws InvalidXMLException {\n     return new ScoreFilter(XMLUtils.parseNumericRange(new Node(el), Integer.class));\n   }\n+\n+  // Methods for parsing QueryModifiers\n+\n+  @MethodParser(\"offset\")\n+  public LocationQueryModifier parseOffsetFilter(Element el) throws InvalidXMLException {\n+    String value = el.getAttributeValue(\"location\");\n+    // Check vector format\n+    XMLUtils.parseVector(new Node(el), value.replaceAll(\"[\\\\^~]\", \"\"));\n+\n+    String[] coords = value.split(\"\\\\s*,\\\\s*\");\n+\n+    Boolean local = null;\n+    for (String coord : coords) {\n+      if (local == null) {\n+        local = coord.startsWith(\"^\");\n+      }\n+\n+      if (coord.startsWith(\"^\") != local)\n+        throw new InvalidXMLException(\"Cannot mix world & local coordinates\", el);\n+    }\n+\n+    if (local == null) throw new InvalidXMLException(\"No coordinates provided\", el);\n+\n+    if (local) {\n+      double x = Double.parseDouble(coords[0].substring(1));\n+      double y = Double.parseDouble(coords[1].substring(1));\n+      double z = Double.parseDouble(coords[2].substring(1));\n+      return new LocalLocationQueryModifier(parseChild(el), new Vector(x, y, z));", "originalCommit": "b1c121aed7538e6349795b16bdaba4f574444b5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzAyNjkxOQ==", "url": "https://github.com/PGMDev/PGM/pull/671#discussion_r537026919", "bodyText": "Right, forgot about that", "author": "KingOfSquares", "createdAt": "2020-12-06T12:19:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxNzc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcxODA3NQ==", "url": "https://github.com/PGMDev/PGM/pull/671#discussion_r535718075", "bodyText": "kinda same thing here, no need for coordinates, just use the vector and just check for ~", "author": "Pablete1234", "createdAt": "2020-12-03T23:19:52Z", "path": "core/src/main/java/tc/oc/pgm/filters/FilterParser.java", "diffHunk": "@@ -453,4 +457,46 @@ public TimeFilter parseTimeFilter(Element el) throws InvalidXMLException {\n   public ScoreFilter parseScoreFilter(Element el) throws InvalidXMLException {\n     return new ScoreFilter(XMLUtils.parseNumericRange(new Node(el), Integer.class));\n   }\n+\n+  // Methods for parsing QueryModifiers\n+\n+  @MethodParser(\"offset\")\n+  public LocationQueryModifier parseOffsetFilter(Element el) throws InvalidXMLException {\n+    String value = el.getAttributeValue(\"location\");\n+    // Check vector format\n+    XMLUtils.parseVector(new Node(el), value.replaceAll(\"[\\\\^~]\", \"\"));\n+\n+    String[] coords = value.split(\"\\\\s*,\\\\s*\");\n+\n+    Boolean local = null;\n+    for (String coord : coords) {\n+      if (local == null) {\n+        local = coord.startsWith(\"^\");\n+      }\n+\n+      if (coord.startsWith(\"^\") != local)\n+        throw new InvalidXMLException(\"Cannot mix world & local coordinates\", el);\n+    }\n+\n+    if (local == null) throw new InvalidXMLException(\"No coordinates provided\", el);\n+\n+    if (local) {\n+      double x = Double.parseDouble(coords[0].substring(1));\n+      double y = Double.parseDouble(coords[1].substring(1));\n+      double z = Double.parseDouble(coords[2].substring(1));\n+      return new LocalLocationQueryModifier(parseChild(el), new Vector(x, y, z));\n+    } else {\n+      boolean[] relative = new boolean[3];\n+      double[] coordinates = new double[3];\n+      for (int i = 0; i < coords.length; i++) {\n+        String coord = coords[i];\n+        boolean isRelative = coord.startsWith(\"~\");\n+        relative[i] = isRelative;\n+        coordinates[i] = Double.parseDouble(isRelative ? coord.substring(1) : coord);\n+      }\n+\n+      return new WorldLocationQueryModifier(\n+          parseChild(el), new Vector(coordinates[0], coordinates[1], coordinates[2]), relative);", "originalCommit": "b1c121aed7538e6349795b16bdaba4f574444b5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e4f723d342bdd40f22fee4737a3e00ffc847f26d", "url": "https://github.com/PGMDev/PGM/commit/e4f723d342bdd40f22fee4737a3e00ffc847f26d", "message": "stash\n\nSigned-off-by: KingSimon <19822231+KingOfSquares@users.noreply.github.com>", "committedDate": "2020-12-05T00:41:10Z", "type": "commit"}, {"oid": "9ca4828f512b4bc076dbf6ae595b864c24af0b89", "url": "https://github.com/PGMDev/PGM/commit/9ca4828f512b4bc076dbf6ae595b864c24af0b89", "message": "Make Vector once\n- Add helpful check if someone forgets providing a offset vector\n\nSigned-off-by: KingSimon <19822231+KingOfSquares@users.noreply.github.com>", "committedDate": "2020-12-06T12:23:14Z", "type": "commit"}]}