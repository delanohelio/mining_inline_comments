{"pr_number": 541, "pr_title": "Create synthetic root modules modules for target specs", "pr_createdAt": "2020-06-24T13:03:47Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk1MTAxNQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r444951015", "bodyText": "Fastpass uses the -project-root naming convention but it still feels a bit weird. Any suggestions for a clearer or more self-explanatory name? \ud83e\udd14", "author": "olafurpg", "createdAt": "2020-06-24T14:48:12Z", "path": "src/com/twitter/intellij/pants/service/project/resolver/PantsSourceRootsExtension.java", "diffHunk": "@@ -67,6 +77,68 @@ public void resolve(\n \n       createContentRoots(moduleDataNode, targetInfo);\n     }\n+    installSyntheticModules(executor, projectDataNode, modules);\n+  }\n+\n+  /**\n+   * Takes a set of paths. Returns a new set without paths that are children of any other path in the set\n+   * Ex. for [A, A/B, A/B/C, B, C/D] the result set is [A, B, C/D]\n+   */\n+  public static Set<String> removeChildren(Set<String> paths) {\n+    if(paths.size() > 0 ) {\n+      List<String> sorted = paths.stream().sorted().collect(Collectors.toList());\n+      String current = sorted.get(0);\n+      List<String> buf = new ArrayList<>();\n+      buf.add(current);\n+      for (String s : sorted.stream().skip(1).collect(Collectors.toList())) {\n+        if (!s.startsWith(current)) {\n+          current = s;\n+          buf.add(s);\n+        }\n+      }\n+      return new HashSet<>(buf);\n+    }\n+    return Collections.emptySet();\n+  }\n+\n+  private void installSyntheticModules(\n+    @NotNull PantsCompileOptionsExecutor executor,\n+    @NotNull DataNode<ProjectData> projectDataNode,\n+    @NotNull Map<String, DataNode<ModuleData>> modules\n+  ) {\n+    Path projectPath = Paths.get(executor.getBuildRoot().getAbsolutePath());\n+    Set<String> replaced =\n+      executor.getOptions().getSelectedTargetSpecs().stream()\n+        .map(x -> x.replaceFirst(\"/?:.*\", \"\"))\n+        .collect(Collectors.toSet());\n+    Set<String> replacedWithoutChildren = removeChildren(replaced);\n+    Set<String> allContentRoots =\n+      modules.values().stream()\n+        .flatMap(x -> x.getChildren()\n+        .stream())\n+        .map(x -> x.getData(ProjectKeys.CONTENT_ROOT))\n+        .filter(Objects::nonNull)\n+        .map(x -> x.getRootPath())\n+        .collect(Collectors.toSet());\n+    replacedWithoutChildren.removeAll(allContentRoots);\n+\n+    for (String path: replaced) {\n+      String moduleName = projectPath.relativize(Paths.get(path)).toString().replaceAll(\"/\", \"_\") + \"-project-root\";", "originalCommit": "90c058974c19a799e6e92a1c95d974391dfa1219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4Mjg5MQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r445082891", "bodyText": "I'm not sure. It could be something less commonly used in build systems, so  it's easier to search it it code/issue tracker. So for example \"common ancestor\"", "author": "tpasternak", "createdAt": "2020-06-24T18:16:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk1MTAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk1MTg2OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r444951869", "bodyText": "(unrelated to this PR) This module doesn't have any content roots from what I can see. Is there a way to achieve exactly the same via BSP? When I tried to create empty Bloop projects then it didn't help, I had to add a fake resource directory which caused other problems.", "author": "olafurpg", "createdAt": "2020-06-24T14:49:19Z", "path": "src/com/twitter/intellij/pants/service/project/resolver/PantsSourceRootsExtension.java", "diffHunk": "@@ -67,6 +77,68 @@ public void resolve(\n \n       createContentRoots(moduleDataNode, targetInfo);\n     }\n+    installSyntheticModules(executor, projectDataNode, modules);\n+  }\n+\n+  /**\n+   * Takes a set of paths. Returns a new set without paths that are children of any other path in the set\n+   * Ex. for [A, A/B, A/B/C, B, C/D] the result set is [A, B, C/D]\n+   */\n+  public static Set<String> removeChildren(Set<String> paths) {\n+    if(paths.size() > 0 ) {\n+      List<String> sorted = paths.stream().sorted().collect(Collectors.toList());\n+      String current = sorted.get(0);\n+      List<String> buf = new ArrayList<>();\n+      buf.add(current);\n+      for (String s : sorted.stream().skip(1).collect(Collectors.toList())) {\n+        if (!s.startsWith(current)) {\n+          current = s;\n+          buf.add(s);\n+        }\n+      }\n+      return new HashSet<>(buf);\n+    }\n+    return Collections.emptySet();\n+  }\n+\n+  private void installSyntheticModules(\n+    @NotNull PantsCompileOptionsExecutor executor,\n+    @NotNull DataNode<ProjectData> projectDataNode,\n+    @NotNull Map<String, DataNode<ModuleData>> modules\n+  ) {\n+    Path projectPath = Paths.get(executor.getBuildRoot().getAbsolutePath());\n+    Set<String> replaced =\n+      executor.getOptions().getSelectedTargetSpecs().stream()\n+        .map(x -> x.replaceFirst(\"/?:.*\", \"\"))\n+        .collect(Collectors.toSet());\n+    Set<String> replacedWithoutChildren = removeChildren(replaced);\n+    Set<String> allContentRoots =\n+      modules.values().stream()\n+        .flatMap(x -> x.getChildren()\n+        .stream())\n+        .map(x -> x.getData(ProjectKeys.CONTENT_ROOT))\n+        .filter(Objects::nonNull)\n+        .map(x -> x.getRootPath())\n+        .collect(Collectors.toSet());\n+    replacedWithoutChildren.removeAll(allContentRoots);\n+\n+    for (String path: replaced) {\n+      String moduleName = projectPath.relativize(Paths.get(path)).toString().replaceAll(\"/\", \"_\") + \"-project-root\";\n+      final ModuleData moduleData = new ModuleData(", "originalCommit": "90c058974c19a799e6e92a1c95d974391dfa1219", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA4MzU0OA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r445083548", "bodyText": "the content root is added below", "author": "tpasternak", "createdAt": "2020-06-24T18:17:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk1MTg2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2NzQ1OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r445167459", "bodyText": "is replaceFirst(\"/?:.*\", \"\") the same as split(\":\")[0], if it's easier to reason?", "author": "wisechengyi", "createdAt": "2020-06-24T20:57:23Z", "path": "src/com/twitter/intellij/pants/service/project/resolver/PantsSourceRootsExtension.java", "diffHunk": "@@ -67,6 +77,72 @@ public void resolve(\n \n       createContentRoots(moduleDataNode, targetInfo);\n     }\n+    installSyntheticModules(executor, projectDataNode, modules);\n+  }\n+\n+  /**\n+   * Takes a set of paths. Returns a new set without paths that are children of any other path in the set\n+   * Ex. for [A, A/B, A/B/C, B, C/D] the result set is [A, B, C/D]\n+   */\n+  public static Set<String> removeChildren(Set<String> paths) {\n+    if(paths.size() > 0 ) {\n+      List<String> sorted = paths.stream().sorted().collect(Collectors.toList());\n+      String current = sorted.get(0);\n+      List<String> buf = new ArrayList<>();\n+      buf.add(current);\n+      for (String s : sorted.stream().skip(1).collect(Collectors.toList())) {\n+        if (!s.startsWith(current)) {\n+          current = s;\n+          buf.add(s);\n+        }\n+      }\n+      return new HashSet<>(buf);\n+    }\n+    return Collections.emptySet();\n+  }\n+\n+  private void installSyntheticModules(\n+    @NotNull PantsCompileOptionsExecutor executor,\n+    @NotNull DataNode<ProjectData> projectDataNode,\n+    @NotNull Map<String, DataNode<ModuleData>> modules\n+  ) {\n+    Path projectPath = Paths.get(executor.getBuildRoot().getAbsolutePath());\n+    Set<String> targetSpecPaths =\n+      executor.getOptions().getSelectedTargetSpecs().stream()\n+        .map(x -> x.replaceFirst(\"/?:.*\", \"\"))", "originalCommit": "9de98d0c5c098c7a86906d616de066e6ded17431", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY0OTg2Nw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r445649867", "bodyText": "I copied the regex from here, it was assumed that the spec may be of the form spec_path/:spec_target I'm not sure if it's possible at all, but kept it just in case\nhttps://github.com/scalameta/fastpass/blob/0e8092e8e650608aa879427e834cb1b1ab469501/fastpass/src/main/scala/scala/meta/internal/fastpass/pantsbuild/PantsConfiguration.scala#L93-L110", "author": "tpasternak", "createdAt": "2020-06-25T15:34:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2NzQ1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY4NzE4OA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r445687188", "bodyText": "Sounds good. Thanks!", "author": "wisechengyi", "createdAt": "2020-06-25T16:30:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE2NzQ1OQ=="}], "type": "inlineReview"}, {"oid": "49d623152041708d30ef6d7a800154002094caa1", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/49d623152041708d30ef6d7a800154002094caa1", "message": "Create synthetic root modules modules for target specs", "committedDate": "2020-06-25T12:23:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTY1NTAyNg==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/541#discussion_r445655026", "bodyText": "Left a \"todo\" here because I'm not sure if it's worth doing it. I iterate over the list of all already created content roots for each target spec passed as an argument. This means N*M complexity. It could be optimized to N log(M) if I used trie data structure.", "author": "tpasternak", "createdAt": "2020-06-25T15:42:36Z", "path": "src/com/twitter/intellij/pants/service/project/resolver/PantsSourceRootsExtension.java", "diffHunk": "@@ -67,6 +77,72 @@ public void resolve(\n \n       createContentRoots(moduleDataNode, targetInfo);\n     }\n+    installSyntheticModules(executor, projectDataNode, modules);\n+  }\n+\n+  /**\n+   * Takes a set of paths. Returns a new set without paths that are children of any other path in the set\n+   * Ex. for [A, A/B, A/B/C, B, C/D] the result set is [A, B, C/D]\n+   */\n+  public static Set<String> removeChildren(Set<String> paths) {\n+    if(paths.size() > 0 ) {\n+      List<String> sorted = paths.stream().sorted().collect(Collectors.toList());\n+      String current = sorted.get(0);\n+      List<String> buf = new ArrayList<>();\n+      buf.add(current);\n+      for (String s : sorted.stream().skip(1).collect(Collectors.toList())) {\n+        if (!s.startsWith(current)) {\n+          current = s;\n+          buf.add(s);\n+        }\n+      }\n+      return new HashSet<>(buf);\n+    }\n+    return Collections.emptySet();\n+  }\n+\n+  private void installSyntheticModules(\n+    @NotNull PantsCompileOptionsExecutor executor,\n+    @NotNull DataNode<ProjectData> projectDataNode,\n+    @NotNull Map<String, DataNode<ModuleData>> modules\n+  ) {\n+    Path projectPath = Paths.get(executor.getBuildRoot().getAbsolutePath());\n+    Set<String> targetSpecPaths =\n+      executor.getOptions().getSelectedTargetSpecs().stream()\n+        .map(x -> x.replaceFirst(\"/?:.*\", \"\"))\n+        .map(x -> Paths.get(x).isAbsolute() ? projectPath.relativize(Paths.get(x)).toString() : x)\n+        .collect(Collectors.toSet());\n+    Set<String> targetSpecPathsWithoutChildren = removeChildren(targetSpecPaths);\n+    Set<String> allContentRoots =\n+      modules.values().stream()\n+        .flatMap(x -> x.getChildren()\n+        .stream())\n+        .map(x -> x.getData(ProjectKeys.CONTENT_ROOT))\n+        .filter(Objects::nonNull)\n+        .map(x -> x.getRootPath())\n+        .collect(Collectors.toSet());\n+\n+    // todo - optimize from m*n to m * log(n)\n+    targetSpecPathsWithoutChildren.removeIf(targetSpec -> allContentRoots.stream().anyMatch(contentRoot ->  projectPath.resolve(targetSpec).startsWith(contentRoot)));", "originalCommit": "49d623152041708d30ef6d7a800154002094caa1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}