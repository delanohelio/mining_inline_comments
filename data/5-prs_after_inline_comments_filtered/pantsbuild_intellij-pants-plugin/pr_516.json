{"pr_number": 516, "pr_title": "Action to convert pants project to bsp", "pr_createdAt": "2020-04-17T14:06:10Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516", "timeline": [{"oid": "ad30af80ce2b33358897a30135f3934f2400a79b", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/ad30af80ce2b33358897a30135f3934f2400a79b", "message": "Action to convert pants project to bsp", "committedDate": "2020-04-17T13:45:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2MDM0OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r410260349", "bodyText": "Instead of hardcoding a version here I think we can use latest.stable instead, which will let Coursier figure out the latest stable Metals version.", "author": "olafurpg", "createdAt": "2020-04-17T14:28:14Z", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,130 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String METALS_VERSION = \"0.8.4\";", "originalCommit": "ad30af80ce2b33358897a30135f3934f2400a79b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI3MDU5OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r411270599", "bodyText": "I expected coursier to have something like this, but didn't find it initially. Changed.", "author": "lukaszwawrzyk", "createdAt": "2020-04-20T10:32:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2MDM0OQ=="}], "type": "inlineReview"}, {"oid": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/4faf3e61e343c892c6c6ce8c51e1d4c29517e414", "message": "Handle existing bsp project", "committedDate": "2020-04-20T10:30:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg1NQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412082855", "bodyText": "It looks like these are absolute paths since the generated project is named .Users.lgeirsson.workspace.source...\n\nI think we can fix this by stripping the prefix containing the absolute path to the Pants workspace away\n- INFO  process: /Users/lgeirsson/workspace/source/pants ... /Users/lgeirsson/workspace/source/buildcache::\n+ INFO  process: /Users/lgeirsson/workspace/source/pants ... buildcache::", "author": "olafurpg", "createdAt": "2020-04-21T10:56:06Z", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );\n+    commandLine.addParameters(commandBase);\n+\n+    List<String> targets = pantsTargets(project);", "originalCommit": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjg5MzI1OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412893259", "bodyText": "@olafurpg I will push potential fix, Yet I couldn't reproduce. If you could tell me how you setup the pants project to get this problem I could test it.\nI just take bsp-pants repo on branch scratchfile, I do import pants project pointing to 'scratchfile' directory and proceed with defaults. This results in targets being a List(\"scratchfile/::\") and project is named \"scratchfile.\".", "author": "lukaszwawrzyk", "createdAt": "2020-04-22T11:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU3NDg4NA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r414574884", "bodyText": "That fixed the issue. Thanks!", "author": "olafurpg", "createdAt": "2020-04-24T13:27:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA4Mjg1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMDM5Nw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412300397", "bodyText": "cc/ @wiwa can you elaborate on what is needed in order to collect the correct metrics here?", "author": "olafurpg", "createdAt": "2020-04-21T16:13:24Z", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,165 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.function.Consumer;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            String message = formatError(output, outputErr);\n+            throw new RuntimeException(message);\n+          }\n+          else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+            ProjectUtil.openOrImport(projectPath, new OpenProjectTask());\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    //String name = project.getName();\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",", "originalCommit": "4faf3e61e343c892c6c6ce8c51e1d4c29517e414", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwNDMyMg==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412304322", "bodyText": "We need to be able to have a fastpass.properties config file on the classpath as implemented in https://github.com/scalameta/metals/pull/1582/files#diff-1ff86c347afd6af0342fc1157784b735R39", "author": "wiwa", "createdAt": "2020-04-21T16:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMDM5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMxNTU1OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412315559", "bodyText": "@lukaszwawrzyk please ignore this comment, we figured out a way to solve this problem so that this coursier launch command works unchanged.", "author": "olafurpg", "createdAt": "2020-04-21T16:41:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMwMDM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2NjgyMg==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r412966822", "bodyText": "This leaves a leading / in the start resulting in project names like .foo", "author": "olafurpg", "createdAt": "2020-04-22T13:09:13Z", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -126,13 +127,19 @@ private Path coursierPath() throws IOException {\n   }\n \n   private List<String> pantsTargets(Project project) {\n+    String root = PantsUtil.findBuildRoot(project).map(VirtualFile::getPath).orElse(\"/\");\n     PantsSettings pantsSettings = PantsSettings.getInstance(project);\n     return pantsSettings.getLinkedProjectsSettings()\n       .stream()\n       .flatMap(projectSettings -> projectSettings.getSelectedTargetSpecs().stream())\n+      .map(target -> stripPrefix(target, root))\n       .collect(Collectors.toList());\n   }\n \n+  private String stripPrefix(String s, String prefix) {\n+    return s.startsWith(prefix) ? s.substring(prefix.length()) : s;", "originalCommit": "8f216cdd96823f57255dff8eea60d8b8a04dba3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDU1MzQxOA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r414553418", "bodyText": "@olafurpg I implemented removing the \"/\" Hope it works now, as I don't have reproduction for full directory in target names.", "author": "lukaszwawrzyk", "createdAt": "2020-04-24T12:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk2NjgyMg=="}], "type": "inlineReview"}, {"oid": "964bb51177389329f4aa896de17fc3223463ef2b", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/964bb51177389329f4aa896de17fc3223463ef2b", "message": "Relativize target ids", "committedDate": "2020-04-23T08:48:04Z", "type": "commit"}, {"oid": "964bb51177389329f4aa896de17fc3223463ef2b", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/964bb51177389329f4aa896de17fc3223463ef2b", "message": "Relativize target ids", "committedDate": "2020-04-23T08:48:04Z", "type": "forcePushed"}, {"oid": "064a4faee81434b3f72e9e257c0dd373fbec0862", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/064a4faee81434b3f72e9e257c0dd373fbec0862", "message": "Handle preexisting bsp project", "committedDate": "2020-04-24T14:48:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNDkxNQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417904915", "bodyText": "We download the newest coursier here. Imo this should either be changed to  some fixed version, or logged. Without it we lose information about coursier version that may be essential to reproduce potential bugs.", "author": "tpasternak", "createdAt": "2020-04-30T10:16:27Z", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,192 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            Path workspace = commandLine.getWorkDirectory().toPath();\n+            Optional<Path> projectPath = existingProjectPath(outputErr, workspace);\n+\n+            projectPath.ifPresent(path -> registerNewBspProjectAndOpen(path, project));\n+            projectPath.orElseThrow(() -> new RuntimeException(formatError(output, outputErr)));\n+          } else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            registerNewBspProjectAndOpen(projectPath, project);\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private void registerNewBspProjectAndOpen(Path projectPath, Project project) {\n+    PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+    ApplicationManager.getApplication()\n+      .invokeLater(() -> ProjectUtil.openOrImport(projectPath, new OpenProjectTask()));\n+  }\n+\n+  private Optional<Path> existingProjectPath(String output, Path workspace) {\n+    Pattern pattern = Pattern.compile(\"can't create project named '(.*?)' because it already exists\");\n+    Matcher matcher = pattern.matcher(output);\n+    if (matcher.find()) {\n+      String name = matcher.group(1);\n+      return Optional.of(workspace.resolveSibling(\"bsp-projects\").resolve(name));\n+    } else {\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );\n+    commandLine.addParameters(commandBase);\n+\n+    List<String> targets = pantsTargets(project);\n+    commandLine.addParameters(targets);\n+    return commandLine;\n+  }\n+\n+  private Path coursierPath() throws IOException {\n+    Path destination = Paths.get(System.getProperty(\"java.io.tmpdir\"), \"pants-plugin-coursier\");\n+    if (!Files.exists(destination)) {\n+      URL url = new URL(\"https://git.io/coursier-cli\");", "originalCommit": "064a4faee81434b3f72e9e257c0dd373fbec0862", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzNDAwOA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417934008", "bodyText": "This is a good point. If we copy the coursier bootstrap script from resources then we always use the same coursier version", "author": "olafurpg", "createdAt": "2020-04-30T11:12:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNDkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNjAyMA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417906020", "bodyText": "It would be nice to log downloaded metals version or fix it in code.", "author": "tpasternak", "createdAt": "2020-04-30T10:18:32Z", "path": "src/com/twitter/intellij/pants/ui/PantsToBspProjectAction.java", "diffHunk": "@@ -0,0 +1,192 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.ui;\n+\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.ide.impl.OpenProjectTask;\n+import com.intellij.ide.impl.ProjectUtil;\n+import com.intellij.ide.util.PropertiesComponent;\n+import com.intellij.openapi.actionSystem.AnAction;\n+import com.intellij.openapi.actionSystem.AnActionEvent;\n+import com.intellij.openapi.application.ApplicationManager;\n+import com.intellij.openapi.progress.ProgressIndicator;\n+import com.intellij.openapi.progress.ProgressManager;\n+import com.intellij.openapi.progress.Task;\n+import com.intellij.openapi.project.DumbAware;\n+import com.intellij.openapi.project.Project;\n+import com.intellij.openapi.ui.Messages;\n+import com.intellij.openapi.vfs.LocalFileSystem;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.settings.PantsSettings;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.apache.commons.io.IOUtils;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Consumer;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+import java.util.stream.Collectors;\n+\n+public class PantsToBspProjectAction extends AnAction implements DumbAware {\n+  private static final String BSP_LINKED_PROJECT_PATH = \"bsp.linked_project_path\";\n+\n+  @Override\n+  public void update(@NotNull AnActionEvent e) {\n+    Project project = e.getProject();\n+    boolean isPants = project != null && PantsUtil.isPantsProject(project);\n+    e.getPresentation().setEnabledAndVisible(isPants);\n+    if (isPants) {\n+      dependingOnBspProjectExistence(\n+        project,\n+        () -> e.getPresentation().setText(\"Create new BSP project based on this Pants project\"),\n+        linkedBspProject -> e.getPresentation().setText(\"Open linked BSP project\")\n+      );\n+    }\n+  }\n+\n+  @Override\n+  public void actionPerformed(AnActionEvent e) {\n+    Project project = e.getProject();\n+    if (project == null) {\n+      Messages.showInfoMessage(\"Project not found.\", \"Error\");\n+      return;\n+    }\n+    dependingOnBspProjectExistence(\n+      project,\n+      () -> createBspProject(project),\n+      linkedBspProject -> ProjectUtil.openOrImport(Paths.get(linkedBspProject), new OpenProjectTask())\n+    );\n+  }\n+\n+  private void createBspProject(Project project) {\n+    ProgressManager.getInstance().run(new Task.Backgroundable(project, \"Preparing BSP Project\", false) {\n+      @Override\n+      public void run(@NotNull ProgressIndicator indicator) {\n+        try {\n+          GeneralCommandLine commandLine = createCommandLine(project);\n+          Process process = commandLine.createProcess();\n+          String output = readToString(process.getInputStream());\n+          String outputErr = readToString(process.getErrorStream());\n+          int result = process.waitFor();\n+          if (result != 0) {\n+            Path workspace = commandLine.getWorkDirectory().toPath();\n+            Optional<Path> projectPath = existingProjectPath(outputErr, workspace);\n+\n+            projectPath.ifPresent(path -> registerNewBspProjectAndOpen(path, project));\n+            projectPath.orElseThrow(() -> new RuntimeException(formatError(output, outputErr)));\n+          } else {\n+            Path projectPath = Paths.get(output).toAbsolutePath();\n+            registerNewBspProjectAndOpen(projectPath, project);\n+          }\n+        }\n+        catch (Exception ex) {\n+          ApplicationManager.getApplication()\n+            .invokeLater(() -> Messages.showErrorDialog(project, ex.getMessage(), \"Error\"));\n+        }\n+      }\n+    });\n+  }\n+\n+  private void registerNewBspProjectAndOpen(Path projectPath, Project project) {\n+    PropertiesComponent.getInstance(project).setValue(BSP_LINKED_PROJECT_PATH, projectPath.toString());\n+    ApplicationManager.getApplication()\n+      .invokeLater(() -> ProjectUtil.openOrImport(projectPath, new OpenProjectTask()));\n+  }\n+\n+  private Optional<Path> existingProjectPath(String output, Path workspace) {\n+    Pattern pattern = Pattern.compile(\"can't create project named '(.*?)' because it already exists\");\n+    Matcher matcher = pattern.matcher(output);\n+    if (matcher.find()) {\n+      String name = matcher.group(1);\n+      return Optional.of(workspace.resolveSibling(\"bsp-projects\").resolve(name));\n+    } else {\n+      return Optional.empty();\n+    }\n+  }\n+\n+  private GeneralCommandLine createCommandLine(Project project) throws IOException {\n+    GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(project);\n+\n+    String coursier = coursierPath().toString();\n+    commandLine.setExePath(coursier);\n+\n+    List<String> commandBase = Arrays.asList(\n+      \"launch\", \"org.scalameta:metals_2.12:latest.stable\",\n+      \"--main\", \"scala.meta.internal.pantsbuild.BloopPants\",\n+      \"--\",\n+      \"create\",\n+      \"--intellij\",\n+      \"--intellijLauncher\", \"echo\"\n+    );", "originalCommit": "064a4faee81434b3f72e9e257c0dd373fbec0862", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkzOTM5Ng==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417939396", "bodyText": "I don't think we can tell the exact Metals version from this command when using latest.stable. One alternative would be to additionally launch a version command so that we can log what version got picked up \ud83e\udd14", "author": "olafurpg", "createdAt": "2020-04-30T11:24:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNjAyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzk3MzA1Nw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/516#discussion_r417973057", "bodyText": "Right, but I think it's not essential for this PR, so it can be done as a follow-up (as well as the cousier-verison related issue). Nevertheless it must be done soon, as bug fixing may be very hard without it, in some specific cases.", "author": "tpasternak", "createdAt": "2020-04-30T12:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzkwNjAyMA=="}], "type": "inlineReview"}]}