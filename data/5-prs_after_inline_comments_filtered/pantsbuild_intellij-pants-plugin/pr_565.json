{"pr_number": 565, "pr_title": "Make \"$PantsFilePathRelativeToBuildRoot$\" macro working for sources jar", "pr_createdAt": "2020-09-07T16:45:58Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/565", "timeline": [{"oid": "b8a223cabe68116a02429efce3687c1e017b8053", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/b8a223cabe68116a02429efce3687c1e017b8053", "message": "Make \"$PantsFilePathRelativeToBuildRoot$\" macro working for sources jar\n\nFor dependencies that are not directly specified in config spec, fastpass\ngenerates \"*-sources.jar\" files. PantsFilePathRelativeToBuildRoot was\nnot working for sources in these files.", "committedDate": "2020-09-07T16:44:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3OTk5MQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/565#discussion_r484679991", "bodyText": "Do we guess the root directory from the name of the jar file? I think it can be more robust if fastpass writes the root directory in the jar file, around here\nhttps://github.com/scalameta/fastpass/blob/df9359fa7756c6e7f0f062af56fe617201897876/fastpass/src/main/scala/scala/meta/internal/fastpass/pantsbuild/SourcesJarBuilder.scala#L24\nIf that info doesn't exist in the jar file then we can fallback to this heuristic.", "author": "olafurpg", "createdAt": "2020-09-08T06:31:10Z", "path": "src/com/twitter/intellij/pants/macro/FilePathRelativeToBuiltRootMacro.java", "diffHunk": "@@ -6,37 +6,80 @@\n import com.intellij.ide.macro.Macro;\n import com.intellij.openapi.actionSystem.CommonDataKeys;\n import com.intellij.openapi.actionSystem.DataContext;\n+import com.intellij.openapi.project.Project;\n import com.intellij.openapi.util.io.FileUtil;\n import com.intellij.openapi.vfs.VfsUtil;\n import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.bsp.JarMappings;\n+import com.twitter.intellij.pants.bsp.PantsBspData;\n+import com.twitter.intellij.pants.bsp.PantsTargetAddress;\n import com.twitter.intellij.pants.util.PantsUtil;\n+import org.jetbrains.annotations.NotNull;\n \n+import java.nio.file.Path;\n import java.util.Optional;\n+import java.util.Set;\n \n public class FilePathRelativeToBuiltRootMacro extends Macro {\n   /**\n    * @return corresponding name of this macro\n    */\n+  @NotNull\n   @Override\n   public String getName() {\n     return \"PantsFilePathRelativeToBuildRoot\";\n   }\n \n+  @NotNull\n   @Override\n   public String getDescription() {\n     return \"Relative path from build root\";\n   }\n \n+  private Optional<String> jarFilePath(Project project, VirtualFile vFile) {\n+    Optional<VirtualFile> jarFile = JarMappings.getParentJar(vFile);\n+    if(jarFile.isPresent()) {\n+      JarMappings mappings = JarMappings.getInstance(project);\n+      Optional<Path> target = mappings", "originalCommit": "b8a223cabe68116a02429efce3687c1e017b8053", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5MzI0OA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/565#discussion_r485493248", "bodyText": "Ok, now it tries to get this info from *jar!/META-INF/fastpass/source-root", "author": "tpasternak", "createdAt": "2020-09-09T10:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3OTk5MQ=="}], "type": "inlineReview"}, {"oid": "566407d32087e8c161baf9d2b05eb28da01034af", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/566407d32087e8c161baf9d2b05eb28da01034af", "message": "Try to read source root from inside *-sources.jar file\n\nNew fastpass creates META-INF/fastpass/source-root file that can be used to imply path to the original file in the local file system", "committedDate": "2020-09-08T12:34:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU2MzcxNQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/565#discussion_r485563715", "bodyText": "you could use ifPresent (similar to scala foreach)", "author": "lukaszwawrzyk", "createdAt": "2020-09-09T12:15:16Z", "path": "src/com/twitter/intellij/pants/macro/FilePathRelativeToBuiltRootMacro.java", "diffHunk": "@@ -6,37 +6,103 @@\n import com.intellij.ide.macro.Macro;\n import com.intellij.openapi.actionSystem.CommonDataKeys;\n import com.intellij.openapi.actionSystem.DataContext;\n+import com.intellij.openapi.project.Project;\n import com.intellij.openapi.util.io.FileUtil;\n import com.intellij.openapi.vfs.VfsUtil;\n import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.bsp.JarMappings;\n+import com.twitter.intellij.pants.bsp.PantsBspData;\n+import com.twitter.intellij.pants.bsp.PantsTargetAddress;\n import com.twitter.intellij.pants.util.PantsUtil;\n+import org.jetbrains.annotations.NotNull;\n \n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n import java.util.Optional;\n+import java.util.Set;\n+\n+import static com.intellij.openapi.fileEditor.impl.LoadTextUtil.loadText;\n \n public class FilePathRelativeToBuiltRootMacro extends Macro {\n   /**\n    * @return corresponding name of this macro\n    */\n+  @NotNull\n   @Override\n   public String getName() {\n     return \"PantsFilePathRelativeToBuildRoot\";\n   }\n \n+  @NotNull\n   @Override\n   public String getDescription() {\n     return \"Relative path from build root\";\n   }\n \n+  private Optional<String> jarFilePathBasedOnFilename(Project project, VirtualFile vFile) {\n+    Optional<VirtualFile> jarFile = JarMappings.getParentJar(vFile);\n+    if(jarFile.isPresent()) {\n+      JarMappings mappings = JarMappings.getInstance(project);\n+      Optional<Path> target = mappings\n+        .findTargetForJar(jarFile.get())\n+        .flatMap(PantsTargetAddress::tryParse)\n+        .map(PantsTargetAddress::getPath);\n+      if (target.isPresent()){\n+        String relativePath = target.get().resolve(vFile.getName()).toString();\n+        Set<VirtualFile> pantsRoots = PantsBspData.pantsRoots(project);\n+        boolean pathExists = pantsRoots.stream()\n+          .anyMatch(x -> x.findFileByRelativePath(relativePath) != null);\n+        if (pathExists) {\n+          return Optional.of(relativePath);\n+        } else {\n+          return Optional.empty();\n+        }\n+      }\n+    }\n+    return Optional.empty();\n+  }\n+\n+  private Optional<String> jarFilePathBasedOnMetaInf(VirtualFile vFile) {\n+    Optional<VirtualFile> jarFile = JarMappings.getParentJar(vFile);\n+    if(jarFile.isPresent()) {", "originalCommit": "566407d32087e8c161baf9d2b05eb28da01034af", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}