{"pr_number": 476, "pr_title": "Don't retreive pants options in Event Dispatch Thread", "pr_createdAt": "2020-01-13T09:51:21Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476", "timeline": [{"oid": "1a676a270677f2577a7286a3cab0741e42374216", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/1a676a270677f2577a7286a3cab0741e42374216", "message": "Don't retreive pants options in Event Dispatch Thread\n\nFileChangeTracker methods are always called in Event Dispatch Thread.\nPants Plugin implementation sometimes needs to retrieve pants options\nin order to decide, whether to mark project as dirty. Unfortunatly,\nPants Options are retrieved via an external process call, what is\nforbidden in the Event Dispatch Thread.\n\nIn this commit, the bahvior of the listener is changed in that way,\nthe pants options are retrieved before the listener is initialized,\non a thread from thread pool, and they're passed to listener's\nconstructor.\n\nUnfortunately, pants options may be read only when a project\ncontains any modules. Therefore, it we can't just read them at\n`projectOpened` stage, because the project may be initially empty.\nThat's why we register a ModuleListener in case when the project is\nempty.\n\nFixes #463", "committedDate": "2020-01-13T11:30:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5ODg1Mg==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365798852", "bodyText": "Can be private", "author": "lukaszwawrzyk", "createdAt": "2020-01-13T13:20:04Z", "path": "src/com/twitter/intellij/pants/file/FileChangeTracker.java", "diffHunk": "@@ -298,36 +297,41 @@ public static void unregisterProject(@NotNull Project project) {\n       });\n   }\n \n-  private static VirtualFileListener getNewListener() {\n+  private static VirtualFileListener getNewListener(final PantsOptions pantsOptions) {\n     return new VirtualFileListener() {\n+\n+      void markDirty(VirtualFile file) {", "originalCommit": "1a676a270677f2577a7286a3cab0741e42374216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwOTc3Mw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365809773", "bodyText": "Done", "author": "tpasternak", "createdAt": "2020-01-13T13:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5ODg1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5OTA5NQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365799095", "bodyText": "All these new imports are suspicious as there are no further changes in this file", "author": "lukaszwawrzyk", "createdAt": "2020-01-13T13:20:38Z", "path": "src/com/twitter/intellij/pants/service/project/metadata/PantsMetadataService.java", "diffHunk": "@@ -11,16 +12,23 @@\n import com.intellij.openapi.module.Module;\n import com.intellij.openapi.project.Project;\n import com.intellij.openapi.util.Computable;\n+import com.intellij.openapi.vfs.VirtualFile;\n+import com.twitter.intellij.pants.file.FileChangeTracker;\n+import com.twitter.intellij.pants.model.PantsOptions;\n import com.twitter.intellij.pants.service.project.PantsResolver;\n+import com.twitter.intellij.pants.settings.PantsProjectSettings;\n import com.twitter.intellij.pants.settings.PantsSettings;\n import com.twitter.intellij.pants.util.PantsConstants;\n import com.twitter.intellij.pants.util.PantsUtil;\n import org.jetbrains.annotations.NotNull;\n import org.jetbrains.annotations.Nullable;\n import com.google.gson.Gson;\n \n+import java.util.ArrayList;\n import java.util.Collection;\n import java.util.Collections;\n+import java.util.List;\n+import java.util.Optional;", "originalCommit": "1a676a270677f2577a7286a3cab0741e42374216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwOTgyMA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365809820", "bodyText": "Done", "author": "tpasternak", "createdAt": "2020-01-13T13:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5OTA5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5OTI2Mw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365799263", "bodyText": "You can run formatter on this file", "author": "lukaszwawrzyk", "createdAt": "2020-01-13T13:21:00Z", "path": "src/com/twitter/intellij/pants/file/FileChangeTracker.java", "diffHunk": "@@ -104,10 +104,10 @@ public FileChangeTracker getInstance() {\n     return instance;\n   }\n \n-  private static void markDirty(@NotNull VirtualFile file, @NotNull VirtualFileListener listener) {\n+  private static void markDirty(@NotNull VirtualFile file,final PantsOptions pantsOptions, @NotNull VirtualFileListener listener) {", "originalCommit": "1a676a270677f2577a7286a3cab0741e42374216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwOTk2NA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365809964", "bodyText": "Done", "author": "tpasternak", "createdAt": "2020-01-13T13:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5OTI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5OTQ3MA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365799470", "bodyText": "contains", "author": "lukaszwawrzyk", "createdAt": "2020-01-13T13:21:29Z", "path": "src/com/twitter/intellij/pants/components/impl/PantsProjectComponentImpl.java", "diffHunk": "@@ -188,6 +193,46 @@ private void prepareGuiComponents() {\n           }\n         }\n \n+\n+        /**\n+         * VSF tracker implementation requires PantsOptions object, that cannot be constructed in\n+         * the Event Dispatch Thread. What is more, it can't be constructed if the project contain", "originalCommit": "1a676a270677f2577a7286a3cab0741e42374216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgxMDAwMw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365810003", "bodyText": "Done", "author": "tpasternak", "createdAt": "2020-01-13T13:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5OTQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMDA2Mw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365800063", "bodyText": "This is redundant", "author": "lukaszwawrzyk", "createdAt": "2020-01-13T13:22:56Z", "path": "src/com/twitter/intellij/pants/components/impl/PantsProjectComponentImpl.java", "diffHunk": "@@ -188,6 +193,46 @@ private void prepareGuiComponents() {\n           }\n         }\n \n+\n+        /**\n+         * VSF tracker implementation requires PantsOptions object, that cannot be constructed in\n+         * the Event Dispatch Thread. What is more, it can't be constructed if the project contain\n+         * no modules, and cannot be registered twice. Hence, there are two cases when VFS tracker is\n+         * needed:\n+         *   1. When the Pants project is opened and it already contains modules - then we can register tracker immediately\n+         *   2. When the Pants project is opened, but modules are not loaded yet - then we have to wait until a module is loaded\n+         * @param project", "originalCommit": "1a676a270677f2577a7286a3cab0741e42374216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgxMDAyOA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365810028", "bodyText": "Done", "author": "tpasternak", "createdAt": "2020-01-13T13:43:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMDA2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMDY4OA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365800688", "bodyText": "Also run formatter on this file", "author": "lukaszwawrzyk", "createdAt": "2020-01-13T13:24:18Z", "path": "src/com/twitter/intellij/pants/components/impl/PantsProjectComponentImpl.java", "diffHunk": "@@ -188,6 +193,46 @@ private void prepareGuiComponents() {\n           }\n         }\n \n+\n+        /**\n+         * VSF tracker implementation requires PantsOptions object, that cannot be constructed in\n+         * the Event Dispatch Thread. What is more, it can't be constructed if the project contain\n+         * no modules, and cannot be registered twice. Hence, there are two cases when VFS tracker is\n+         * needed:\n+         *   1. When the Pants project is opened and it already contains modules - then we can register tracker immediately\n+         *   2. When the Pants project is opened, but modules are not loaded yet - then we have to wait until a module is loaded\n+         * @param project\n+         */\n+        private void registerVfsListener(Project project) {\n+          if(ModuleManager.getInstance(project).getModules().length > 0) {", "originalCommit": "1a676a270677f2577a7286a3cab0741e42374216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgxMDA2Mw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r365810063", "bodyText": "Done", "author": "tpasternak", "createdAt": "2020-01-13T13:43:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTgwMDY4OA=="}], "type": "inlineReview"}, {"oid": "49629dcce3397c64eeb236125d1feb82618d823d", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/49629dcce3397c64eeb236125d1feb82618d823d", "message": "Apply recommendations from the review\n\n1. makeDirty marked private\n2. removed unused import\n3. formatter run some files", "committedDate": "2020-01-13T13:38:35Z", "type": "commit"}, {"oid": "cf35b1cb53a004ccefb8bd6920673fb97c4123f4", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/cf35b1cb53a004ccefb8bd6920673fb97c4123f4", "message": "Ensure findProject is called on the project that was actually opened", "committedDate": "2020-01-13T13:47:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjE0MDEwNA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/476#discussion_r366140104", "bodyText": "no change in this file.", "author": "wisechengyi", "createdAt": "2020-01-14T03:41:48Z", "path": "src/com/twitter/intellij/pants/service/project/metadata/PantsMetadataService.java", "diffHunk": "@@ -3,6 +3,7 @@\n \n package com.twitter.intellij.pants.service.project.metadata;\n \n+import com.intellij.openapi.application.ApplicationManager;", "originalCommit": "cf35b1cb53a004ccefb8bd6920673fb97c4123f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "59145888a3b740e5af0fae616ed713fe819c14c2", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/59145888a3b740e5af0fae616ed713fe819c14c2", "message": "Remove unused import", "committedDate": "2020-01-14T16:52:16Z", "type": "commit"}, {"oid": "4834d6d6aa194843f672bd2a0b1e9fd31da3a09f", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/4834d6d6aa194843f672bd2a0b1e9fd31da3a09f", "message": "Remove more unused imports", "committedDate": "2020-01-14T16:53:51Z", "type": "commit"}, {"oid": "8bf80e95805920068202cf25d3e2de204044f821", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/8bf80e95805920068202cf25d3e2de204044f821", "message": "Merge branch 'master' into do-not-retrieve-pants-options-in-edt", "committedDate": "2020-01-14T18:13:56Z", "type": "commit"}]}