{"pr_number": 492, "pr_title": "Fix CI", "pr_createdAt": "2020-02-07T13:02:16Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/492", "timeline": [{"oid": "4db8ae2fdee4f6b78fe9e479f53081ff3b5ff9fa", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/4db8ae2fdee4f6b78fe9e479f53081ff3b5ff9fa", "message": "Log content of a collection if element not found", "committedDate": "2020-02-07T12:56:05Z", "type": "commit"}, {"oid": "bb713827b35ad854264db4070788ac0a315e662a", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/bb713827b35ad854264db4070788ac0a315e662a", "message": "Don't use hardcoded names for module run config test", "committedDate": "2020-02-10T08:04:50Z", "type": "commit"}, {"oid": "41367d5e7fa1705a4cf9539ac4ab3fbfc239cf13", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/41367d5e7fa1705a4cf9539ac4ab3fbfc239cf13", "message": "Don't use hardcoded names for method run config test", "committedDate": "2020-02-10T08:32:14Z", "type": "commit"}, {"oid": "3ef091a7fbc753fc1388f58e978be6c0f9733d83", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/3ef091a7fbc753fc1388f58e978be6c0f9733d83", "message": "Don't use hardcoded dependencies in class run config test", "committedDate": "2020-02-10T08:59:28Z", "type": "commit"}, {"oid": "3ef091a7fbc753fc1388f58e978be6c0f9733d83", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/3ef091a7fbc753fc1388f58e978be6c0f9733d83", "message": "Don't use hardcoded dependencies in class run config test", "committedDate": "2020-02-10T08:59:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA2MzU5MA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/492#discussion_r377063590", "bodyText": "The method name is actually self-descripting :)", "author": "tpasternak", "createdAt": "2020-02-10T13:33:21Z", "path": "tests/com/twitter/intellij/pants/integration/TargetFileCompletionIntegrationTest.java", "diffHunk": "@@ -90,6 +93,10 @@ private void completionTest(String stringToComplete, String[] expected) {\n     String fullStringToComplete = \"\\n\\n\" + stringToComplete;\n     // should be only tested with pants versions above 1.24.0\n     if (PantsUtil.isCompatiblePantsVersion(myProjectRoot.getPath(), \"1.24.0\")) {\n+      // invalidate caches", "originalCommit": "1811ac35e58ee624eac1a50a5b2feec9f803d14e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f6969a2d888d2c64ca705db41bf5df880438de51", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/f6969a2d888d2c64ca705db41bf5df880438de51", "message": "Invalidate caches related to completions", "committedDate": "2020-02-11T13:22:45Z", "type": "forcePushed"}, {"oid": "dcefd34ae63e873b0662f9d23a6013365c1a5d10", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/dcefd34ae63e873b0662f9d23a6013365c1a5d10", "message": "Invalidate caches related to completions", "committedDate": "2020-02-11T16:28:00Z", "type": "commit"}, {"oid": "dcefd34ae63e873b0662f9d23a6013365c1a5d10", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/dcefd34ae63e873b0662f9d23a6013365c1a5d10", "message": "Invalidate caches related to completions", "committedDate": "2020-02-11T16:28:00Z", "type": "forcePushed"}, {"oid": "a9d73e59402f1ee7bfa99c0c7c6b8974f76c27b1", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/a9d73e59402f1ee7bfa99c0c7c6b8974f76c27b1", "message": "Don't use hardcoded values in the test case", "committedDate": "2020-02-11T18:30:43Z", "type": "commit"}, {"oid": "a9d73e59402f1ee7bfa99c0c7c6b8974f76c27b1", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/a9d73e59402f1ee7bfa99c0c7c6b8974f76c27b1", "message": "Don't use hardcoded values in the test case", "committedDate": "2020-02-11T18:30:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxNzQyMg==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/492#discussion_r377917422", "bodyText": "can inline\nCollections.singletonList(\"test\")", "author": "wisechengyi", "createdAt": "2020-02-11T21:43:36Z", "path": "tests/com/twitter/intellij/pants/execution/OSSPantsJvmRunConfigurationIntegrationTest.java", "diffHunk": "@@ -20,48 +20,41 @@\n import com.intellij.psi.PsiElement;\n import com.intellij.psi.PsiMethod;\n import com.intellij.psi.PsiPackage;\n-import com.intellij.psi.search.GlobalSearchScope;\n import com.intellij.testFramework.MapDataContext;\n import com.twitter.intellij.pants.PantsManager;\n+import com.twitter.intellij.pants.util.ProjectTestJvms;\n import com.twitter.intellij.pants.service.task.PantsTaskManager;\n import com.twitter.intellij.pants.settings.PantsExecutionSettings;\n import com.twitter.intellij.pants.testFramework.OSSPantsIntegrationTest;\n import com.twitter.intellij.pants.util.PantsUtil;\n import org.jetbrains.annotations.NotNull;\n+import org.junit.Assert;\n \n import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Optional;\n import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n \n \n public class OSSPantsJvmRunConfigurationIntegrationTest extends OSSPantsIntegrationTest {\n   public void testClassRunConfiguration() throws Throwable {\n     doImport(\"testprojects/tests/java/org/pantsbuild/testproject/testjvms\");\n \n-    String classReference = \"org.pantsbuild.testproject.testjvms.TestSix\";\n-\n-    PsiClass testClass = JavaPsiFacade.getInstance(myProject).findClass(classReference, GlobalSearchScope.allScope(myProject));\n-    assertNotNull(testClass);\n+    PsiClass testClass = ProjectTestJvms.anyTestClass(myProject, getProjectPath());\n \n     ExternalSystemRunConfiguration esc = getExternalSystemRunConfiguration(testClass);\n \n     // Make sure task name is `test` goal.\n-    assertEquals(Collections.singletonList(\"test\"), esc.getSettings().getTaskNames());\n+    String testTask = \"test\";\n+    assertEquals(Collections.singletonList(testTask), esc.getSettings().getTaskNames());", "originalCommit": "a9d73e59402f1ee7bfa99c0c7c6b8974f76c27b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxOTQ2Ng==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/492#discussion_r377919466", "bodyText": "Do you think it'd be possible to wrap this around\nif (PantsUtil.isCompatiblePantsVersion(getProjectPath(), \"1.25.0\")) { \n...\n} \nelse {\n// testprojects/tests/java/org/pantsbuild/testproject/testjvms:base\n// testprojects/tests/java/org/pantsbuild/testproject/testjvms:eight\n// testprojects/tests/java/org/pantsbuild/testproject/testjvms:eight-test-platform\n}", "author": "wisechengyi", "createdAt": "2020-02-11T21:47:51Z", "path": "tests/com/twitter/intellij/pants/execution/OSSPantsJvmRunConfigurationIntegrationTest.java", "diffHunk": "@@ -20,48 +20,41 @@\n import com.intellij.psi.PsiElement;\n import com.intellij.psi.PsiMethod;\n import com.intellij.psi.PsiPackage;\n-import com.intellij.psi.search.GlobalSearchScope;\n import com.intellij.testFramework.MapDataContext;\n import com.twitter.intellij.pants.PantsManager;\n+import com.twitter.intellij.pants.util.ProjectTestJvms;\n import com.twitter.intellij.pants.service.task.PantsTaskManager;\n import com.twitter.intellij.pants.settings.PantsExecutionSettings;\n import com.twitter.intellij.pants.testFramework.OSSPantsIntegrationTest;\n import com.twitter.intellij.pants.util.PantsUtil;\n import org.jetbrains.annotations.NotNull;\n+import org.junit.Assert;\n \n import java.util.Arrays;\n+import java.util.Collection;\n import java.util.Collections;\n import java.util.HashSet;\n import java.util.List;\n import java.util.Optional;\n import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n \n \n public class OSSPantsJvmRunConfigurationIntegrationTest extends OSSPantsIntegrationTest {\n   public void testClassRunConfiguration() throws Throwable {\n     doImport(\"testprojects/tests/java/org/pantsbuild/testproject/testjvms\");\n \n-    String classReference = \"org.pantsbuild.testproject.testjvms.TestSix\";\n-\n-    PsiClass testClass = JavaPsiFacade.getInstance(myProject).findClass(classReference, GlobalSearchScope.allScope(myProject));\n-    assertNotNull(testClass);\n+    PsiClass testClass = ProjectTestJvms.anyTestClass(myProject, getProjectPath());\n \n     ExternalSystemRunConfiguration esc = getExternalSystemRunConfiguration(testClass);\n \n     // Make sure task name is `test` goal.\n-    assertEquals(Collections.singletonList(\"test\"), esc.getSettings().getTaskNames());\n+    String testTask = \"test\";\n+    assertEquals(Collections.singletonList(testTask), esc.getSettings().getTaskNames());\n \n     List<String> configScriptParameters = PantsUtil.parseCmdParameters(Optional.ofNullable(esc.getSettings().getScriptParameters()));\n-\n-    List<String> expectedConfigScriptParameters = Arrays.asList(\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:eight-test-platform\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:six\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:seven\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:eight\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:base\",\n-      \"--test-junit-test=\" + classReference\n-    );\n-    assertEquals(expectedConfigScriptParameters, configScriptParameters);", "originalCommit": "a9d73e59402f1ee7bfa99c0c7c6b8974f76c27b1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODIyMjk4MA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/492#discussion_r378222980", "bodyText": "Sorry, I don't think I follow.\nThe highlighted code is removed from repository as it is no longer necessary - now, we don't use hardcoded names of the files but rather inspect the directory and get expected names from there. This should work the same way regardless of the pants version.\nCould you rephrase your intention so that I can understand it better?", "author": "mzarnowski", "createdAt": "2020-02-12T12:34:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxOTQ2Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQwNDYzMA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/492#discussion_r378404630", "bodyText": "I see. I guess that works, too. Thanks!\nMy original thought was to keep the existing mechanism, and assert on different targets based on the pants version in the pantsbuild/pants repo.", "author": "wisechengyi", "createdAt": "2020-02-12T17:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxOTQ2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkxOTU4OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/492#discussion_r377919589", "bodyText": "same here", "author": "wisechengyi", "createdAt": "2020-02-11T21:48:04Z", "path": "tests/com/twitter/intellij/pants/execution/OSSPantsJvmRunConfigurationIntegrationTest.java", "diffHunk": "@@ -76,34 +69,21 @@ public void testClassRunConfiguration() throws Throwable {\n \n     String debuggerSetup = \"dummy_debugger_setup\";\n \n-    GeneralCommandLine finalDebugCommandline = getFinalCommandline(esc, debuggerSetup, taskManagerClass);\n+    List<String> debugParameters = Arrays.asList(\"--no-test-junit-timeouts\", \"--jvm-test-junit-options=\" + debuggerSetup, \"test\");\n+    List<String> expectedDebugParameters = Stream.of(debugParameters, configScriptParameters)\n+      .flatMap(Collection::stream)\n+      .collect(Collectors.toList());\n \n-    List<String> expectedFinalDebugCommandlineParameters = Arrays.asList(\n-      \"--no-test-junit-timeouts\",\n-      \"--jvm-test-junit-options=\" + debuggerSetup,\n-      \"test\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:eight-test-platform\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:six\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:seven\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:eight\",\n-      \"testprojects/tests/java/org/pantsbuild/testproject/testjvms:base\",\n-      \"--test-junit-test=\" + classReference\n-    );", "originalCommit": "a9d73e59402f1ee7bfa99c0c7c6b8974f76c27b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}