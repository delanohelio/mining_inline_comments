{"pr_number": 594, "pr_title": "Use the venv_builder tool to prepare a Python virtual environment", "pr_createdAt": "2020-12-24T04:34:58Z", "pr_url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594", "timeline": [{"oid": "1c4671d35e2896d54cfbdbb11896c96eb383de76", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/1c4671d35e2896d54cfbdbb11896c96eb383de76", "message": "Use Python from .venv if present", "committedDate": "2020-12-07T10:27:00Z", "type": "commit"}, {"oid": "b01b5b8d5681ce4e9c4c500920c8e37664ed2075", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/b01b5b8d5681ce4e9c4c500920c8e37664ed2075", "message": "Set Python as the SDK for modules", "committedDate": "2020-12-07T10:27:00Z", "type": "commit"}, {"oid": "74614648c1d187f638f1b6fc217798fac33298a5", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/74614648c1d187f638f1b6fc217798fac33298a5", "message": "Detect and invoke the venv_builder tool when importing a Pants project with Python targets", "committedDate": "2020-12-11T15:45:06Z", "type": "commit"}, {"oid": "2e8c619e8a1cd6c5bb2d512417965e0119f3734b", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/2e8c619e8a1cd6c5bb2d512417965e0119f3734b", "message": "isMainTarget", "committedDate": "2020-12-14T12:06:04Z", "type": "commit"}, {"oid": "6d73f5535b1edc7e691be35b6ba72b62253ecc0d", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/6d73f5535b1edc7e691be35b6ba72b62253ecc0d", "message": "associateWithModulePath", "committedDate": "2020-12-14T13:38:37Z", "type": "commit"}, {"oid": "68bb97154d165c320d5b5582b908befed8f08b4f", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/68bb97154d165c320d5b5582b908befed8f08b4f", "message": "sdkName", "committedDate": "2020-12-15T12:38:36Z", "type": "commit"}, {"oid": "74703e79728cf2ecc2413a2ffa2af13b93f294ad", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/74703e79728cf2ecc2413a2ffa2af13b93f294ad", "message": "project.getName()", "committedDate": "2020-12-15T14:20:33Z", "type": "commit"}, {"oid": "d65a05d43e911eef4b48354efe0f35fc80cea717", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/d65a05d43e911eef4b48354efe0f35fc80cea717", "message": ".getExternalName", "committedDate": "2020-12-15T15:03:56Z", "type": "commit"}, {"oid": "b5495d5124ce01504e52614710d9af6df34c1ed5", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/b5495d5124ce01504e52614710d9af6df34c1ed5", "message": "projectData.getExternalName", "committedDate": "2020-12-18T13:36:37Z", "type": "commit"}, {"oid": "2eb94f8a98d68c61c54d79d9bb45ddc8afab3067", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/2eb94f8a98d68c61c54d79d9bb45ddc8afab3067", "message": "mainTargetName(List<String> selectedTargets)", "committedDate": "2020-12-22T11:11:52Z", "type": "commit"}, {"oid": "ed1019c304db708af8113246d2139f734663c051", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/ed1019c304db708af8113246d2139f734663c051", "message": "GeneralCommandLine buildAndRunVenvBuilder", "committedDate": "2020-12-22T17:10:58Z", "type": "commit"}, {"oid": "da8d3602c6fbd208c0357d50e89a4d63afb8c1b8", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/da8d3602c6fbd208c0357d50e89a4d63afb8c1b8", "message": "smol changes", "committedDate": "2020-12-22T19:00:45Z", "type": "commit"}, {"oid": "0479331f7e1bca1958ab90d2b0ac726e1b3eb9a6", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/0479331f7e1bca1958ab90d2b0ac726e1b3eb9a6", "message": "PythonVenvBuilder.processAdapter", "committedDate": "2020-12-23T15:59:07Z", "type": "commit"}, {"oid": "c144d7bdb4094f2689dd2962c0341532c232cea0", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/c144d7bdb4094f2689dd2962c0341532c232cea0", "message": "PythonVenvBuilder.forProjectPath", "committedDate": "2020-12-23T22:47:43Z", "type": "commit"}, {"oid": "2197d3f19fbfccb442fd50c46c2e3378aeda982b", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/2197d3f19fbfccb442fd50c46c2e3378aeda982b", "message": "Removed PythonVenvFinder", "committedDate": "2020-12-26T06:47:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM2NTE5Nw==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594#discussion_r549365197", "bodyText": "+1", "author": "tpasternak", "createdAt": "2020-12-28T14:23:23Z", "path": "src/com/twitter/intellij/pants/service/project/PantsResolver.java", "diffHunk": "@@ -93,6 +100,30 @@ public void resolve(\n     }\n   }\n \n+  public void resolvePythonEnvironment(\n+    ProjectData projectData,\n+    List<String> selectedTargets,\n+    ProcessAdapter processAdapter\n+  ) {\n+    PythonSetup pythonSetup = myProjectInfo.getPythonSetup();\n+    boolean needsPython = myProjectInfo.getTargets().values().stream().anyMatch(t -> t.isPythonTarget());\n+    if (needsPython && pythonSetup != null) {\n+      PythonVenvBuilder.forProjectPath(myExecutor.getBuildRoot().toString(), processAdapter).ifPresent(builder -> {\n+        String target = mainTargetName(selectedTargets);\n+        Path venvDir = Paths.get(projectData.getIdeProjectFileDirectoryPath(), \"venv\");\n+        PythonInterpreterInfo python = builder.build(target, venvDir);\n+        String environmentName = \"Python virtual environment from venv_builder\";\n+        pythonSetup.getInterpreters().put(environmentName, python);\n+        pythonSetup.setDefaultInterpreter(environmentName);\n+      });\n+    }\n+  }\n+\n+  private String mainTargetName(List<String> selectedTargets){\n+    //FIXME can there be more than one target?", "originalCommit": "d0a99a5816893c209544802b50c9f5cbd146ba6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTU0MTA3MA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594#discussion_r549541070", "bodyText": "The venv_builder tool supports only one target selector (which, however, can be as general as ::), so I think this way of selecting the \"main\" target is an acceptable compromise for now.\nP.S. This problem is fixed in pull request #598.", "author": "odisseus", "createdAt": "2020-12-29T01:58:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTM2NTE5Nw=="}], "type": "inlineReview"}, {"oid": "1c3b5da3a8e55544f664463b8dc9804b3b6da759", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/1c3b5da3a8e55544f664463b8dc9804b3b6da759", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-29T00:25:36Z", "type": "forcePushed"}, {"oid": "0b5758c76ceea3c54cd71160e86a58f963cf15f6", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/0b5758c76ceea3c54cd71160e86a58f963cf15f6", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-29T22:49:39Z", "type": "forcePushed"}, {"oid": "1a0468f0eab2b501b5b9553309c784dd9290c686", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/1a0468f0eab2b501b5b9553309c784dd9290c686", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-29T23:03:10Z", "type": "forcePushed"}, {"oid": "b95ae6133613dc513a8e6c8b1b4f8d4c57930787", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/b95ae6133613dc513a8e6c8b1b4f8d4c57930787", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-30T02:16:11Z", "type": "forcePushed"}, {"oid": "034c5c235f6b199ed5c2c072d4a4ea9235baf078", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/034c5c235f6b199ed5c2c072d4a4ea9235baf078", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-30T05:41:04Z", "type": "forcePushed"}, {"oid": "75cbc803a578b110a15b51be7d5be34d71553924", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/75cbc803a578b110a15b51be7d5be34d71553924", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-30T06:25:35Z", "type": "forcePushed"}, {"oid": "0fdf5dd13218ffb9478ebea37ef936f468d59a64", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/0fdf5dd13218ffb9478ebea37ef936f468d59a64", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-30T13:29:49Z", "type": "commit"}, {"oid": "0fdf5dd13218ffb9478ebea37ef936f468d59a64", "url": "https://github.com/pantsbuild/intellij-pants-plugin/commit/0fdf5dd13218ffb9478ebea37ef936f468d59a64", "message": "PantsUtil.listMatchingTargets", "committedDate": "2020-12-30T13:29:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MTUxMA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594#discussion_r557351510", "bodyText": "I think we could use com.twitter.intellij.pants.bsp.PantsTargetAddress class here instead of String for selector\n(and it could be moved from bsp package)", "author": "tpasternak", "createdAt": "2021-01-14T12:13:03Z", "path": "common/com/twitter/intellij/pants/util/PantsUtil.java", "diffHunk": "@@ -421,6 +422,54 @@ public static GeneralCommandLine defaultCommandLine(@NotNull File pantsExecutabl\n     }\n   }\n \n+  public static Collection<String> listMatchingTargets(@NotNull String projectPath, String selector) throws PantsException {", "originalCommit": "0fdf5dd13218ffb9478ebea37ef936f468d59a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTA4NTYxNA==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594#discussion_r565085614", "bodyText": "What is the conceptual difference between com.twitter.intellij.pants.bsp.PantsTargetAddress and com.twitter.intellij.pants.model.PantsTargetAddress?", "author": "odisseus", "createdAt": "2021-01-27T07:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MTUxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MjM2OQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594#discussion_r557352369", "bodyText": "Shouldn't the target name be configurable?", "author": "tpasternak", "createdAt": "2021-01-14T12:14:50Z", "path": "src/com/twitter/intellij/pants/service/project/PythonVenvBuilder.java", "diffHunk": "@@ -0,0 +1,77 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.service.project;\n+\n+import com.intellij.execution.ExecutionException;\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.execution.process.ProcessAdapter;\n+import com.intellij.execution.process.ProcessOutput;\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.twitter.intellij.pants.service.project.model.PythonInterpreterInfo;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.nio.file.Path;\n+import java.util.Collection;\n+import java.util.Optional;\n+\n+public class PythonVenvBuilder {\n+\n+  protected static final Logger LOG = Logger.getInstance(PythonVenvBuilder.class);\n+\n+  private final String projectPath;\n+  private final ProcessAdapter processAdapter;\n+\n+  private PythonVenvBuilder(String projectPath, ProcessAdapter processAdapter) {\n+    this.projectPath = projectPath;\n+    this.processAdapter = processAdapter;\n+  }\n+\n+  public static Optional<PythonVenvBuilder> forProjectPath(String projectPath, ProcessAdapter processAdapter){\n+    Collection<String> allTargets = PantsUtil.listMatchingTargets(projectPath, \"entsec/venv_builder:venv_builder\");", "originalCommit": "0fdf5dd13218ffb9478ebea37ef936f468d59a64", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ4MzYzMQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594#discussion_r557483631", "bodyText": "The target name is always the same. If your project doesn't have this exact target, you probably can't use the venv_builder tool anyway.  Therefore, I think it is permissible to hardcode this target name.\nHowever, the tool itself doesn't seem to contain any special logic. In the future, we might want to get that tool released to the public, or perhaps create a similar one.", "author": "odisseus", "createdAt": "2021-01-14T15:33:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzM1MjM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzQ0MzQzMQ==", "url": "https://github.com/pantsbuild/intellij-pants-plugin/pull/594#discussion_r557443431", "bodyText": "Again, this should be configurable", "author": "tpasternak", "createdAt": "2021-01-14T14:41:17Z", "path": "src/com/twitter/intellij/pants/service/project/PythonVenvBuilder.java", "diffHunk": "@@ -0,0 +1,77 @@\n+// Copyright 2020 Pants project contributors (see CONTRIBUTORS.md).\n+// Licensed under the Apache License, Version 2.0 (see LICENSE).\n+\n+package com.twitter.intellij.pants.service.project;\n+\n+import com.intellij.execution.ExecutionException;\n+import com.intellij.execution.configurations.GeneralCommandLine;\n+import com.intellij.execution.process.ProcessAdapter;\n+import com.intellij.execution.process.ProcessOutput;\n+import com.intellij.openapi.diagnostic.Logger;\n+import com.twitter.intellij.pants.service.project.model.PythonInterpreterInfo;\n+import com.twitter.intellij.pants.util.PantsUtil;\n+import org.jetbrains.annotations.NotNull;\n+\n+import java.nio.file.Path;\n+import java.util.Collection;\n+import java.util.Optional;\n+\n+public class PythonVenvBuilder {\n+\n+  protected static final Logger LOG = Logger.getInstance(PythonVenvBuilder.class);\n+\n+  private final String projectPath;\n+  private final ProcessAdapter processAdapter;\n+\n+  private PythonVenvBuilder(String projectPath, ProcessAdapter processAdapter) {\n+    this.projectPath = projectPath;\n+    this.processAdapter = processAdapter;\n+  }\n+\n+  public static Optional<PythonVenvBuilder> forProjectPath(String projectPath, ProcessAdapter processAdapter){\n+    Collection<String> allTargets = PantsUtil.listMatchingTargets(projectPath, \"entsec/venv_builder:venv_builder\");\n+    if(!allTargets.isEmpty())\n+      return Optional.of(new PythonVenvBuilder(projectPath, processAdapter));\n+    else\n+      return Optional.empty();\n+  }\n+\n+  public PythonInterpreterInfo build(String target, Path venvDir) {\n+    LOG.info(String.format(\"Invoking the .venv builder with target %s at %s\", target, venvDir));\n+    try {\n+      GeneralCommandLine command = buildAndRunVenvBuilder(target, venvDir);\n+      final ProcessOutput processOutput = getProcessOutput(command);\n+      if(processOutput.checkSuccess(LOG)) {\n+        PythonInterpreterInfo result = new PythonInterpreterInfo();\n+        result.setBinary(venvDir.resolve(\"bin/python\").toString());\n+        result.setChroot(venvDir.toString());\n+        return result;\n+      }\n+      else {\n+        throw new RuntimeException(String.format(\"Failed to create a Python virtual environment in %s\", venvDir));\n+      }\n+    } catch(ExecutionException ee) {\n+      throw new RuntimeException(\"An error occurred while running the .venv builder\", ee);\n+    }\n+  }\n+\n+  private GeneralCommandLine buildAndRunVenvBuilder(String target, Path venvDir) {\n+    //TODO Use PantsTaskManager.executeTasks?\n+    final GeneralCommandLine commandLine = PantsUtil.defaultCommandLine(projectPath)\n+      .withEnvironment(\"PANTS_CONCURRENT\", \"true\");\n+    commandLine.addParameters(\"run\", \"entsec/venv_builder:venv_builder\", \"--\");", "originalCommit": "0fdf5dd13218ffb9478ebea37ef936f468d59a64", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}