{"pr_number": 2469, "pr_title": "Invoke command on main thread if it is invoked from off-thread", "pr_createdAt": "2020-01-05T21:32:08Z", "pr_url": "https://github.com/SpongePowered/Sponge/pull/2469", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExODQzMA==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363118430", "bodyText": "Wouldn't it make more sense to re-submit the command on the main thread? Much like how packets are handled in NetHandlerPlayServer?", "author": "gabizou", "createdAt": "2020-01-05T21:33:17Z", "path": "src/main/java/org/spongepowered/common/command/SpongeCommandManager.java", "diffHunk": "@@ -299,6 +299,9 @@ public boolean containsMapping(CommandMapping mapping) {\n \n     @Override\n     public CommandResult process(CommandSource source, String commandLine) {\n+        if (!Sponge.getServer().isMainThread()) {", "originalCommit": "b2e86447ab3905b6f16f0b0e426fcd8e8a997e20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExODQ2Nw==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363118467", "bodyText": "Granted, it'd be a slight behavioral change, but the behavior change is more of \"Hey, instead of crashing we re-submit the command to be processed on the main thread.\"", "author": "gabizou", "createdAt": "2020-01-05T21:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExODQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExODkzMQ==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363118931", "bodyText": "We could, but given this is non-void, what would we return in this case? Or would we just block the async thread - which admittedly, I'm okay with.", "author": "dualspiral", "createdAt": "2020-01-05T21:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExODQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM3NDIxNg==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363374216", "bodyText": "I'd be fine with blocking the async task if anything. Thoughts @Zidane ?", "author": "gabizou", "createdAt": "2020-01-06T16:36:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExODQzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQwMTA0Mg==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363401042", "bodyText": "Block the async task", "author": "Zidane", "createdAt": "2020-01-06T17:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExODQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363119303", "bodyText": "Wouldn't it be better to use SpongeImplHooks#isMainThread ?", "author": "ImMorpheus", "createdAt": "2020-01-05T21:48:32Z", "path": "src/main/java/org/spongepowered/common/command/SpongeCommandManager.java", "diffHunk": "@@ -299,6 +299,9 @@ public boolean containsMapping(CommandMapping mapping) {\n \n     @Override\n     public CommandResult process(CommandSource source, String commandLine) {\n+        if (!Sponge.getServer().isMainThread()) {", "originalCommit": "b2e86447ab3905b6f16f0b0e426fcd8e8a997e20", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzEyMDEwNw==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363120107", "bodyText": "I don't really think it matters either way, but it doesn't hurt to be defensive.", "author": "dualspiral", "createdAt": "2020-01-05T22:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM3Mzk0Ng==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363373946", "bodyText": "It does matter in the sense that the SpongeImplHooks#isMainThread has a stupid fast optimization check (much like the phase tracker)", "author": "gabizou", "createdAt": "2020-01-06T16:36:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM4ODY0Ng==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363388646", "bodyText": "I'm actually curious about that statement, considering SpongeImplHooks#isMainThread is this check, with a isServerAvailable check prepended to it. I had a look at SF and SV to see if we overwrite that check, and we don't.\nWhat is the optimization check? Checking two booleans is never going to be faster than checking one, is it?", "author": "dualspiral", "createdAt": "2020-01-06T17:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzM5ODk3NQ==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363398975", "bodyText": "It\u2019s an overwrite (SpongeImplHooks is our \u201coverwrite for optimizations and forge compat\u201d) in ThreadChecks package", "author": "gabizou", "createdAt": "2020-01-06T17:34:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQwMDU5Ng==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363400596", "bodyText": "They are both equal in performance. With that said, we do try (stress try here...) to not call API methods to keep the call stacks clean.\nBiggest thing to consider is the isServerAvailable check. You want that check to happen here.", "author": "Zidane", "createdAt": "2020-01-06T17:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQzMDM1Mg==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363430352", "bodyText": "It\u2019s an overwrite (SpongeImplHooks is our \u201coverwrite for optimizations and forge compat\u201d) in ThreadChecks package\n\nHuh, Github didn't show that when I searched. Cool - learn something new every day. Neat.\n\nWith that said, we do try (stress try here...) to not call API methods to keep the call stacks clean.\n\nFair point. I was going to change it anyway - but good to keep in mind.", "author": "dualspiral", "createdAt": "2020-01-06T18:52:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUwODkxMg==", "url": "https://github.com/SpongePowered/Sponge/pull/2469#discussion_r363508912", "bodyText": "Biggest thing to consider is the isServerAvailable check. You want that check to happen here.\n\nThat's what the SpongeImplHooks version will do, since it keeps itself updated whether the server is available, whether the server thread itself exists as a field, all in one method call.", "author": "gabizou", "createdAt": "2020-01-06T22:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzExOTMwMw=="}], "type": "inlineReview"}, {"oid": "cfc67b0e04413b23e45a72e97d6b6f97f9599e2b", "url": "https://github.com/SpongePowered/Sponge/commit/cfc67b0e04413b23e45a72e97d6b6f97f9599e2b", "message": "Update message and test plugins", "committedDate": "2020-02-15T13:29:15Z", "type": "forcePushed"}, {"oid": "595931c3a88a44689d99629876ca390b90033a16", "url": "https://github.com/SpongePowered/Sponge/commit/595931c3a88a44689d99629876ca390b90033a16", "message": "Invoke commands on the main thread when called from an async thread.", "committedDate": "2020-02-15T13:31:50Z", "type": "forcePushed"}, {"oid": "cd424add778a1059f036c052c3f685619305d001", "url": "https://github.com/SpongePowered/Sponge/commit/cd424add778a1059f036c052c3f685619305d001", "message": "Invoke commands on the main thread when called from an async thread.", "committedDate": "2020-02-22T11:59:15Z", "type": "commit"}, {"oid": "cd424add778a1059f036c052c3f685619305d001", "url": "https://github.com/SpongePowered/Sponge/commit/cd424add778a1059f036c052c3f685619305d001", "message": "Invoke commands on the main thread when called from an async thread.", "committedDate": "2020-02-22T11:59:15Z", "type": "forcePushed"}]}