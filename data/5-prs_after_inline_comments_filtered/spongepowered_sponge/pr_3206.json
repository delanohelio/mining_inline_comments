{"pr_number": 3206, "pr_title": "Add max-chunk-lifetime setting used by chunk gc (#3167) - fixed", "pr_createdAt": "2020-11-20T09:52:05Z", "pr_url": "https://github.com/SpongePowered/Sponge/pull/3206", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MDI1Nw==", "url": "https://github.com/SpongePowered/Sponge/pull/3206#discussion_r527690257", "bodyText": "Just clarify something for me here: this seems to change the logic such that chunk data and extra chunk data will never be saved if the max chunk lifetime is disabled because this check will then always succeed and fall through to the continue? Shouldn't this check only pass if the chunk isn't due to be unloaded in the first place?", "author": "dualspiral", "createdAt": "2020-11-20T13:28:55Z", "path": "src/main/java/org/spongepowered/common/mixin/core/world/gen/ChunkProviderServerMixin.java", "diffHunk": "@@ -268,22 +270,34 @@ public boolean tick()\n             final Iterator<Chunk> iterator = this.loadedChunks.values().iterator();\n             int chunksUnloaded = 0;\n             final long now = System.currentTimeMillis();\n+            final long world_time = this.world.getTotalWorldTime();\n             while (chunksUnloaded < this.impl$maxChunkUnloads && iterator.hasNext()) {\n                 final Chunk chunk = iterator.next();\n                 final ChunkBridge spongeChunk = (ChunkBridge) chunk;\n-                if (chunk != null && chunk.unloadQueued && !spongeChunk.bridge$isPersistedChunk()) {\n+                if (chunk == null || spongeChunk.bridge$isPersistedChunk()) {\n+                    continue;\n+                }\n+                if (chunk.unloadQueued) {\n                     if (this.bridge$getChunkUnloadDelay() > 0) {\n                         if ((now - spongeChunk.bridge$getScheduledForUnload()) < this.impl$chunkUnloadDelay) {\n                             continue;\n                         }\n                         spongeChunk.bridge$setScheduledForUnload(-1);\n                     }\n                     chunk.onUnload();\n-                    this.saveChunkData(chunk);\n-                    this.saveChunkExtraData(chunk);\n+                }\n+                // max lifetime only applies to chunks that should stay loaded but still need saving once in a while\n+                else if (this.impl$maxChunkLifetime <= 0 // if setting is disabled", "originalCommit": "edd1d1df3baeb133c1aca17550eaa5245ee896b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MjkwNg==", "url": "https://github.com/SpongePowered/Sponge/pull/3206#discussion_r527692906", "bodyText": "Oh, wait, I see, else if. Got it.", "author": "dualspiral", "createdAt": "2020-11-20T13:33:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MDI1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc4NTE2NA==", "url": "https://github.com/SpongePowered/Sponge/pull/3206#discussion_r527785164", "bodyText": "Exactly. If the chunk is scheduled for unload - it's lifetime doesn't need to be checked - we just fall through to the saving code.", "author": "PolyacovYury", "createdAt": "2020-11-20T15:53:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY5MDI1Nw=="}], "type": "inlineReview"}, {"oid": "b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "url": "https://github.com/SpongePowered/Sponge/commit/b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "message": "Add max-chunk-lifetime setting used by chunk gc (#3167) - fixed\n\n- mostly useful for those who need to disable full auto-saves controlled by auto-save-interval\n- spreads out server load induced by chunk saving\n- allows to periodically save chunks kept active by players for a long time", "committedDate": "2020-12-21T12:23:45Z", "type": "commit"}, {"oid": "b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "url": "https://github.com/SpongePowered/Sponge/commit/b8d7ba2d534a7fcb00e192f8af8bd241fa1c7763", "message": "Add max-chunk-lifetime setting used by chunk gc (#3167) - fixed\n\n- mostly useful for those who need to disable full auto-saves controlled by auto-save-interval\n- spreads out server load induced by chunk saving\n- allows to periodically save chunks kept active by players for a long time", "committedDate": "2020-12-21T12:23:45Z", "type": "forcePushed"}]}