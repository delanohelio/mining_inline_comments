{"pr_number": 3204, "pr_title": "ARTEMIS-2823 Use datasource with JDBC store db connections", "pr_createdAt": "2020-06-29T06:43:40Z", "pr_url": "https://github.com/apache/activemq-artemis/pull/3204", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NDY2Mw==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r482874663", "bodyText": "One thought on this change, to have the same semantic, the connectionPool must have a max pool size of 1. That needs to be enforced.\nWith the original code, the entire jdbc operation is serialised on the connection, and that will only still hold if the connection pool blocks when it single entry is in use. ie: if it has a max pool size of 1.", "author": "gtully", "createdAt": "2020-09-03T10:27:37Z", "path": "artemis-jdbc-store/src/main/java/org/apache/activemq/artemis/jdbc/store/file/Db2SequentialFileDriver.java", "diffHunk": "@@ -30,33 +31,30 @@ public Db2SequentialFileDriver() {\n       super();\n    }\n \n-   public Db2SequentialFileDriver(DataSource dataSource, SQLProvider provider) {\n-      super(dataSource, provider);\n-   }\n-\n-   public Db2SequentialFileDriver(Connection connection, SQLProvider provider) {\n-      super(connection, provider);\n+   public Db2SequentialFileDriver(JDBCConnectionProvider connectionProvider, SQLProvider provider) {\n+      super(connectionProvider, provider);\n    }\n \n    @Override\n-   protected void prepareStatements() throws SQLException {\n-      this.deleteFile = connection.prepareStatement(sqlProvider.getDeleteFileSQL());\n-      this.createFile = connection.prepareStatement(sqlProvider.getInsertFileSQL(), new String[]{\"ID\"});\n-      this.selectFileByFileName = connection.prepareStatement(sqlProvider.getSelectFileByFileName());\n-      this.copyFileRecord = connection.prepareStatement(sqlProvider.getCopyFileRecordByIdSQL());\n-      this.renameFile = connection.prepareStatement(sqlProvider.getUpdateFileNameByIdSQL());\n-      this.readLargeObject = connection.prepareStatement(sqlProvider.getReadLargeObjectSQL());\n-      this.appendToLargeObject = connection.prepareStatement(sqlProvider.getAppendToLargeObjectSQL());\n-      this.selectFileNamesByExtension = connection.prepareStatement(sqlProvider.getSelectFileNamesByExtensionSQL());\n+   protected void prepareStatements() {\n+      this.deleteFile = sqlProvider.getDeleteFileSQL();\n+      this.createFile = sqlProvider.getInsertFileSQL();\n+      this.createFileColumnNames = new String[]{\"ID\"};\n+      this.selectFileByFileName = sqlProvider.getSelectFileByFileName();\n+      this.copyFileRecord = sqlProvider.getCopyFileRecordByIdSQL();\n+      this.renameFile = sqlProvider.getUpdateFileNameByIdSQL();\n+      this.readLargeObject = sqlProvider.getReadLargeObjectSQL();\n+      this.appendToLargeObject = sqlProvider.getAppendToLargeObjectSQL();\n+      this.selectFileNamesByExtension = sqlProvider.getSelectFileNamesByExtensionSQL();\n    }\n \n    @Override\n    public int writeToFile(JDBCSequentialFile file, byte[] data) throws SQLException {\n       if (data == null || data.length == 0) {\n          return 0;\n       }\n-      synchronized (connection) {\n-         try {", "originalCommit": "bd7f9367f4ff0ef8f86a9068d31dd31aab92d456", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjIxOTczNA==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r486219734", "bodyText": "I've done this through the broker.xml config and completely forgot to enforce the max size in code if not configured. Will try to find a proper solution for this", "author": "uomik", "createdAt": "2020-09-10T10:05:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NDY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjY1NjI0Nw==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r486656247", "bodyText": "@gtully\nI'm searching trough the master code base and although it seems that it's using a single database connection I'm not 100% sure of it: I will verify it tomorrow with a running broker tomorrow.\nProbably we've many JDBC connections opened (see AbstractJDBCDriver childrens -> journal(s), node manager and sequential file fatories)\nProbably there is no need to hard code such limit", "author": "franz1981", "createdAt": "2020-09-10T21:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NDY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg0MzkwNA==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r486843904", "bodyText": "I did a quick check by just starting \"stock\" Artemis and it at least opens several connections to the database on startup. After a while it seems to settle down to two active connections. And I have to correct myself, I forgot that I actually decided to drop the setting form the configs as well as I came to conclusion that removing it has no negative effect. But correct me if I'm wrong.", "author": "uomik", "createdAt": "2020-09-11T08:02:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg3NDY2Mw=="}], "type": "inlineReview"}, {"oid": "c602ef8853566bc2f95f832cbb729e297725cf5b", "url": "https://github.com/apache/activemq-artemis/commit/c602ef8853566bc2f95f832cbb729e297725cf5b", "message": "ARTEMIS-2823 adding dbcp2 as the default pooled DataSource to be used", "committedDate": "2020-09-21T17:51:02Z", "type": "forcePushed"}, {"oid": "4e0825deaa4606393a1d819530e256feef0666e6", "url": "https://github.com/apache/activemq-artemis/commit/4e0825deaa4606393a1d819530e256feef0666e6", "message": "ARTEMIS-2823 adding dbcp2 as the default pooled DataSource to be used", "committedDate": "2020-09-25T05:15:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0NjQ0Ng==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r495046446", "bodyText": "Can't we keep this method and call this(new JDBCConnectionProvider(ds));", "author": "ehsavoie", "createdAt": "2020-09-25T14:58:17Z", "path": "artemis-jdbc-store/src/main/java/org/apache/activemq/artemis/jdbc/store/sql/PropertySQLProvider.java", "diffHunk": "@@ -362,8 +363,12 @@ public Factory(SQLDialect dialect) {\n          }\n       }\n \n-      public Factory(DataSource dataSource) {", "originalCommit": "1efccfc4cf0ea01f4e74c176f7b389ff95fa5420", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgyNTM1MA==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r496825350", "bodyText": "@uomik this is still missing in your latest changes", "author": "ehsavoie", "createdAt": "2020-09-29T15:38:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0NjQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzI1NTEwMg==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r497255102", "bodyText": "@ehsavoie Fixed now. For some reason the commit did not make it to my last push.", "author": "uomik", "createdAt": "2020-09-30T05:43:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA0NjQ0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTA2NjAyMg==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r495066022", "bodyText": "I see that JDBCSequentialFile directoryList and JDBCSequentialFileFactoryDriver dbDriver  are not used as data members: can be removed", "author": "franz1981", "createdAt": "2020-09-25T15:29:23Z", "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/paging/impl/PagingStoreFactoryDatabase.java", "diffHunk": "@@ -106,8 +105,8 @@ public PagingStoreFactoryDatabase(final DatabaseStorageConfiguration dbConf,\n                                      final ScheduledExecutorService scheduledExecutor,", "originalCommit": "4e0825deaa4606393a1d819530e256feef0666e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e7cdc682009a979c2e1b638c791cac44c2806bf6", "url": "https://github.com/apache/activemq-artemis/commit/e7cdc682009a979c2e1b638c791cac44c2806bf6", "message": "ARTEMIS-2823 Remove never used data members from JDBC paging store factory", "committedDate": "2020-09-25T19:14:50Z", "type": "forcePushed"}, {"oid": "092eeff60dc9898032baace97d5e4f1cedaecacc", "url": "https://github.com/apache/activemq-artemis/commit/092eeff60dc9898032baace97d5e4f1cedaecacc", "message": "ARTEMIS-2823 Add SQL provider Factory constructor with datasource argument", "committedDate": "2020-09-30T05:37:07Z", "type": "forcePushed"}, {"oid": "e9c890606d44a09dbb0b561ca622058693b04b6f", "url": "https://github.com/apache/activemq-artemis/commit/e9c890606d44a09dbb0b561ca622058693b04b6f", "message": "ARTEMIS-2823 Let the db connection pool have unbounded number of connections by default", "committedDate": "2020-10-01T05:57:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NzE2Mg==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r498467162", "bodyText": "connection is not a parameter of this method", "author": "ehsavoie", "createdAt": "2020-10-01T19:26:37Z", "path": "artemis-jdbc-store/src/main/java/org/apache/activemq/artemis/jdbc/store/file/PostgresLargeObjectManager.java", "diffHunk": "@@ -56,31 +56,31 @@ public PostgresLargeObjectManager(Connection connection) throws SQLException {\n       }\n    }\n \n-   public final Long createLO() throws SQLException {\n+   public final Long createLO(Connection connection) throws SQLException {\n       if (shouldUseReflection) {\n-         Object largeObjectManager = getLargeObjectManager();\n+         Object largeObjectManager = getLargeObjectManager(connection);\n          try {\n-            Method method = largeObjectManager.getClass().getMethod(\"createLO\");\n-            return (Long) method.invoke(largeObjectManager);\n+            Method method = largeObjectManager.getClass().getMethod(\"createLO\", Connection.class);\n+            return (Long) method.invoke(largeObjectManager, connection);", "originalCommit": "e9c890606d44a09dbb0b561ca622058693b04b6f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQ2NzMxMA==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r498467310", "bodyText": "connection is not a parameter of this method", "author": "ehsavoie", "createdAt": "2020-10-01T19:26:59Z", "path": "artemis-jdbc-store/src/main/java/org/apache/activemq/artemis/jdbc/store/file/PostgresLargeObjectManager.java", "diffHunk": "@@ -56,31 +56,31 @@ public PostgresLargeObjectManager(Connection connection) throws SQLException {\n       }\n    }\n \n-   public final Long createLO() throws SQLException {\n+   public final Long createLO(Connection connection) throws SQLException {\n       if (shouldUseReflection) {\n-         Object largeObjectManager = getLargeObjectManager();\n+         Object largeObjectManager = getLargeObjectManager(connection);\n          try {\n-            Method method = largeObjectManager.getClass().getMethod(\"createLO\");\n-            return (Long) method.invoke(largeObjectManager);\n+            Method method = largeObjectManager.getClass().getMethod(\"createLO\", Connection.class);\n+            return (Long) method.invoke(largeObjectManager, connection);\n          } catch (NoSuchMethodException | SecurityException | IllegalAccessException | IllegalArgumentException | InvocationTargetException ex) {\n             throw new SQLException(\"Couldn't access org.postgresql.largeobject.LargeObjectManager\", ex);\n          }\n       } else {\n-         return ((PGConnection) realConnection).getLargeObjectAPI().createLO();\n+         return ((PGConnection) unwrap(connection)).getLargeObjectAPI().createLO();\n       }\n    }\n \n-   public Object open(long oid, int mode) throws SQLException {\n+   public Object open(Connection connection, long oid, int mode) throws SQLException {\n       if (shouldUseReflection) {\n-         Object largeObjectManager = getLargeObjectManager();\n+         Object largeObjectManager = getLargeObjectManager(connection);\n          try {\n-            Method method = largeObjectManager.getClass().getMethod(\"open\", long.class, int.class);\n-            return method.invoke(largeObjectManager, oid, mode);\n+            Method method = largeObjectManager.getClass().getMethod(\"open\", Connection.class, long.class, int.class);\n+            return method.invoke(largeObjectManager, connection, oid, mode);", "originalCommit": "e9c890606d44a09dbb0b561ca622058693b04b6f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcxNDExOA==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r498714118", "bodyText": "you need to pass Statement.RETURN_GENERATED_KEYS as second argument (check line 55 on previous code)", "author": "ehsavoie", "createdAt": "2020-10-02T09:27:54Z", "path": "artemis-jdbc-store/src/main/java/org/apache/activemq/artemis/jdbc/store/file/PostgresSequentialSequentialFileDriver.java", "diffHunk": "@@ -36,37 +36,32 @@ public PostgresSequentialSequentialFileDriver() throws SQLException {\n       super();\n    }\n \n-   public PostgresSequentialSequentialFileDriver(DataSource dataSource, SQLProvider provider) {\n+   public PostgresSequentialSequentialFileDriver(JDBCConnectionProvider connectionProvider, SQLProvider provider) {\n       super();\n-      this.setDataSource(dataSource);\n-      this.setSqlProvider(provider);\n-   }\n-\n-   public PostgresSequentialSequentialFileDriver(Connection connection, SQLProvider provider) {\n-      super();\n-      this.setConnection(connection);\n+      this.setJdbcConnectionProvider(connectionProvider);\n       this.setSqlProvider(provider);\n    }\n \n    @Override\n-   protected void prepareStatements() throws SQLException {\n-      this.largeObjectManager = new PostgresLargeObjectManager(connection);\n-      this.deleteFile = connection.prepareStatement(sqlProvider.getDeleteFileSQL());\n-      this.createFile = connection.prepareStatement(sqlProvider.getInsertFileSQL(), Statement.RETURN_GENERATED_KEYS);\n-      this.selectFileByFileName = connection.prepareStatement(sqlProvider.getSelectFileByFileName());\n-      this.copyFileRecord = connection.prepareStatement(sqlProvider.getCopyFileRecordByIdSQL());\n-      this.renameFile = connection.prepareStatement(sqlProvider.getUpdateFileNameByIdSQL());\n-      this.readLargeObject = connection.prepareStatement(sqlProvider.getReadLargeObjectSQL());\n-      this.appendToLargeObject = connection.prepareStatement(sqlProvider.getAppendToLargeObjectSQL());\n-      this.selectFileNamesByExtension = connection.prepareStatement(sqlProvider.getSelectFileNamesByExtensionSQL());\n+   protected void prepareStatements() {\n+      this.largeObjectManager = new PostgresLargeObjectManager();\n+      this.deleteFile = sqlProvider.getDeleteFileSQL();\n+      this.createFile = sqlProvider.getInsertFileSQL();\n+      this.createFileAutogeneratedKeys = Statement.RETURN_GENERATED_KEYS;\n+      this.selectFileByFileName = sqlProvider.getSelectFileByFileName();\n+      this.copyFileRecord = sqlProvider.getCopyFileRecordByIdSQL();\n+      this.renameFile = sqlProvider.getUpdateFileNameByIdSQL();\n+      this.readLargeObject = sqlProvider.getReadLargeObjectSQL();\n+      this.appendToLargeObject = sqlProvider.getAppendToLargeObjectSQL();\n+      this.selectFileNamesByExtension = sqlProvider.getSelectFileNamesByExtensionSQL();\n    }\n \n    @Override\n    public void createFile(JDBCSequentialFile file) throws SQLException {\n-      synchronized (connection) {\n-         try {\n+      try (Connection connection = connectionProvider.getConnection()) {\n+         try (PreparedStatement createFile = connection.prepareStatement(this.createFile)) {", "originalCommit": "f39c65f9a1753e5d9802ee2e97bb3ca880310e8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcyMzQxNg==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r498723416", "bodyText": "We should declare the largeObject here instead of 4 lines before (even if that was how it was done before)", "author": "ehsavoie", "createdAt": "2020-10-02T09:47:54Z", "path": "artemis-jdbc-store/src/main/java/org/apache/activemq/artemis/jdbc/store/file/PostgresSequentialSequentialFileDriver.java", "diffHunk": "@@ -132,10 +129,10 @@ public int writeToFile(JDBCSequentialFile file, byte[] data, boolean append) thr\n    public int readFromFile(JDBCSequentialFile file, ByteBuffer bytes) throws SQLException {\n       Object largeObject = null;\n       long oid = getOID(file);\n-      synchronized (connection) {\n+      try (Connection connection = connectionProvider.getConnection()) {\n          try {\n             connection.setAutoCommit(false);\n-            largeObject = largeObjectManager.open(oid, PostgresLargeObjectManager.READ);\n+            largeObject = largeObjectManager.open(connection, oid, PostgresLargeObjectManager.READ);", "originalCommit": "f39c65f9a1753e5d9802ee2e97bb3ca880310e8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcyMzQ2Ng==", "url": "https://github.com/apache/activemq-artemis/pull/3204#discussion_r498723466", "bodyText": "We should declare the largeObject here instead of 4 lines before (even if that was how it was done before)", "author": "ehsavoie", "createdAt": "2020-10-02T09:48:01Z", "path": "artemis-jdbc-store/src/main/java/org/apache/activemq/artemis/jdbc/store/file/PostgresSequentialSequentialFileDriver.java", "diffHunk": "@@ -87,31 +82,33 @@ public void createFile(JDBCSequentialFile file) throws SQLException {\n \n    @Override\n    public void loadFile(JDBCSequentialFile file) throws SQLException {\n-      synchronized (connection) {\n-         connection.setAutoCommit(false);\n-         readLargeObject.setLong(1, file.getId());\n+      try (Connection connection = connectionProvider.getConnection()) {\n+         try (PreparedStatement readLargeObject = connection.prepareStatement(this.readLargeObject)) {\n+            connection.setAutoCommit(false);\n+            readLargeObject.setLong(1, file.getId());\n \n-         try (ResultSet rs = readLargeObject.executeQuery()) {\n-            if (rs.next()) {\n-               file.setWritePosition(getPostGresLargeObjectSize(file));\n+            try (ResultSet rs = readLargeObject.executeQuery()) {\n+               if (rs.next()) {\n+                  file.setWritePosition(getPostGresLargeObjectSize(file));\n+               }\n+               connection.commit();\n+            } catch (SQLException e) {\n+               connection.rollback();\n+               throw e;\n             }\n-            connection.commit();\n-         } catch (SQLException e) {\n-            connection.rollback();\n-            throw e;\n          }\n       }\n    }\n \n    @Override\n    public int writeToFile(JDBCSequentialFile file, byte[] data, boolean append) throws SQLException {\n-      synchronized (connection) {\n+      try (Connection connection = connectionProvider.getConnection()) {\n          Object largeObject = null;\n \n          Long oid = getOID(file);\n          try {\n             connection.setAutoCommit(false);\n-            largeObject = largeObjectManager.open(oid, PostgresLargeObjectManager.WRITE);\n+            largeObject = largeObjectManager.open(connection, oid, PostgresLargeObjectManager.WRITE);", "originalCommit": "f39c65f9a1753e5d9802ee2e97bb3ca880310e8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2faafec737b10f68aa38925825029b7136f23ee1", "url": "https://github.com/apache/activemq-artemis/commit/2faafec737b10f68aa38925825029b7136f23ee1", "message": "ARTEMIS-2823 Use datasource with JDBC store db connections\n\nReplaces direct jdbc connections with dbcp2 datasource. Adds\nconfiguration options to use alternative datasources and to alter the\nparameters. While adding slight overhead, this vastly improves the\nmanagement and pooling capabilities with db connections.", "committedDate": "2020-10-06T05:32:58Z", "type": "commit"}, {"oid": "2faafec737b10f68aa38925825029b7136f23ee1", "url": "https://github.com/apache/activemq-artemis/commit/2faafec737b10f68aa38925825029b7136f23ee1", "message": "ARTEMIS-2823 Use datasource with JDBC store db connections\n\nReplaces direct jdbc connections with dbcp2 datasource. Adds\nconfiguration options to use alternative datasources and to alter the\nparameters. While adding slight overhead, this vastly improves the\nmanagement and pooling capabilities with db connections.", "committedDate": "2020-10-06T05:32:58Z", "type": "forcePushed"}]}