{"pr_number": 3172, "pr_title": "ARTEMIS-2797 - Reset queue properties by unsetting them in broker.xml", "pr_createdAt": "2020-06-09T05:11:39Z", "pr_url": "https://github.com/apache/activemq-artemis/pull/3172", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r437564056", "bodyText": "Should think about applying the same to all, e.g. if now null set back to default for address setting (or static default) else some users will get different behaviour of what update does per queue config. We should have uniform behaviour across all. E.g. if support here should have similar logic ob all. And also def requires doc updates, and a call out in behaviour changes in release notes", "author": "michaelandrepearce", "createdAt": "2020-06-09T16:30:01Z", "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/postoffice/impl/PostOfficeImpl.java", "diffHunk": "@@ -689,7 +689,10 @@ public QueueBinding updateQueue(QueueConfiguration queueConfiguration) throws Ex\n                queue.setDelayBeforeDispatch(queueConfiguration.getDelayBeforeDispatch().longValue());\n             }\n             Filter filter = FilterImpl.createFilter(queueConfiguration.getFilterString());\n-            if (filter != null && !filter.equals(queue.getFilter())) {\n+            if ((filter == null) && (queue.getFilter() != null)) {", "originalCommit": "9430a0ab952cb78f6e50a16223c3289e4a3d9b26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg5MjI4OQ==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r437892289", "bodyText": "I've added the config reload test.\nI'm not sure about what you mean by the default behavior. Shall I add some sort of constant (like DEFAULT_FILTER) or just document the fact that there's no filter by default and that setting it to null (by removing it from the configuration) or to \"\" reverts it back to the default value?", "author": "jsmucr", "createdAt": "2020-06-10T06:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkwNDczMQ==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r437904731", "bodyText": "I was meaning other queue configurations that you can update e.g like the one immediately above delaybeforedispatch. E.g. if change of behaviour from currently if null do not update, now youre proposing to make it if null set back to default which for filter is null. We would want that behaviour consistent. Else we end up with some ignoring and some reverting.\nIts very important behaviour is consistent for all, so either all do nothing when new value is null (ignore) current behaviour before your proposed change or all update back to their defaults (being either the default at address setting or where a default constant its used)", "author": "michaelandrepearce", "createdAt": "2020-06-10T07:09:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk1OTY3MA==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r437959670", "bodyText": "I see. I'll take look at that.", "author": "jsmucr", "createdAt": "2020-06-10T08:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk3MzEzMA==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r437973130", "bodyText": "Hm, I must have overlooked the fact that the other properties behave the same too.\nIs the behavior I propose a correct one? Or is there a reason for ignoring null values?\nNow that it's obvious - even to me :-) - that the issue is a lot broader, shall I continue with implementing the rest here or would that be a whole new pull request?\nMy use case in an automatic cluster configuration deployment and the current behavior sort of breaks the idea.", "author": "jsmucr", "createdAt": "2020-06-10T09:02:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEyMzMxMw==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r438123313", "bodyText": "So question here is what is the challenge you have right now? Btw i dont work for a service provider but actually an arch at a financial firm that uses artemis (been using for many yrs), and we manage alot of the broker configuration automatically so be interesting what challenge you have which we havent had to solve.", "author": "michaelpearce-gain", "createdAt": "2020-06-10T13:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODEyMzcyNw==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r438123727", "bodyText": "The idea of the null checks, is so that you update just a partial part, e,g, if i only wanted to update say exclusive consumer, i wouldnt have to know all the rest of the config. And there for the update had to be a positive (e.g. it was set) change, to avoid an accident. Maybe could be that the approach here is to use \"\" empty string as a single its a positive change, e.g. theres a difference semantically in that its been set to \"\" its not null, and there for then could use that to clear it.", "author": "michaelpearce-gain", "createdAt": "2020-06-10T13:31:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1MzA4NQ==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r438253085", "bodyText": "Looking further, you could probably safely apply the null thing on all of them, if you defaulted values (the same was as one on create) using maybe somewhere around line 633 (essentially before the checks)\n     QueueConfigurationUtils.applyDynamicQueueDefaults(queueConfiguration, addressSettingsRepository.getMatch(queueConfiguration.getAddress().toString()));", "author": "michaelpearce-gain", "createdAt": "2020-06-10T16:23:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI1NTQ2Mw==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r438255463", "bodyText": "I can actually see same issue with trying to clear groupFirstKey, e.g. you can't clear it, so i understand your issue, just trying to think how to achieve this unilaterally and safely. Def needs docs what ever we do.", "author": "michaelpearce-gain", "createdAt": "2020-06-10T16:26:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODU0Mzg4OA==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r438543888", "bodyText": "Clearing the value using \"\" does not work, at least not for a filter.\n//...\npublic static Filter createFilter(final SimpleString filterStr) throws ActiveMQException {\n      if (filterStr == null || filterStr.length() == 0) {\n         return null;\n      }\n// ...\n\nSo there would have to be a breaking change anyway, just to achieve this.\nI understand the issue with resetting the whole configuration. Maybe there could be a toggle to enable this.\nI'm working for a cloud-based EDI provider and our ultimate goal is to have all of our infrastructure configurable via Ansible (or similar tools) so that in case of a major failure there'd be no need to perform too many manual steps in order to rebuild the service from scratch. That makes the Ansible repository the only place to store our configuration, and therefore it would be highly beneficial if I could redeploy the Artemis configuration from there. :-) It would also open the way to create a bit more user friendly tool to design the MQ related infrastructure.\nI'd be happy to hear about the way you do it in your company. :-)", "author": "jsmucr", "createdAt": "2020-06-11T05:02:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU2NDA1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzkwODA5MA==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r437908090", "bodyText": "I would expect the test to first validate a filter works and queueimpl has filter matching with a real filter, then reload config and validate both the queueimpl is null and now no filtering is applied on flow. To vaildate update does indeed remove a filter if previously set.", "author": "michaelandrepearce", "createdAt": "2020-06-10T07:16:37Z", "path": "tests/integration-tests/src/test/java/org/apache/activemq/artemis/tests/integration/jms/RedeployTest.java", "diffHunk": "@@ -287,6 +287,99 @@ public void run() {\n       }\n    }\n \n+   private void doTestRemoveFilter(URL testConfiguration) throws Exception {\n+\n+      Path brokerXML = getTestDirfile().toPath().resolve(\"broker.xml\");\n+\n+      URL baseConfig = RedeployTest.class.getClassLoader().getResource(\"reload-queue-filter.xml\");\n+\n+      Files.copy(baseConfig.openStream(), brokerXML, StandardCopyOption.REPLACE_EXISTING);\n+\n+      EmbeddedActiveMQ embeddedActiveMQ = new EmbeddedActiveMQ();\n+      embeddedActiveMQ.setConfigResourcePath(brokerXML.toUri().toString());\n+      embeddedActiveMQ.start();\n+\n+      final ReusableLatch latch = new ReusableLatch(1);\n+\n+      Runnable tick = new Runnable() {\n+         @Override\n+         public void run() {\n+            latch.countDown();\n+         }\n+      };\n+\n+      try {\n+\n+         embeddedActiveMQ.getActiveMQServer().getReloadManager().setTick(tick);\n+         latch.await(10, TimeUnit.SECONDS);\n+\n+         try (ActiveMQConnectionFactory factory = new ActiveMQConnectionFactory();\n+              Connection connection = factory.createConnection();\n+              Session session = connection.createSession(Session.AUTO_ACKNOWLEDGE)) {\n+\n+            connection.start();\n+            Queue queue = session.createQueue(\"myFilterQueue\");\n+            MessageProducer producer = session.createProducer(queue);\n+\n+            Message passingMessage = session.createMessage();\n+            passingMessage.setStringProperty(\"x\", \"x\");\n+            producer.send(passingMessage);\n+\n+            Message filteredMessage = session.createMessage();\n+            filteredMessage.setStringProperty(\"x\", \"y\");\n+            producer.send(filteredMessage);\n+\n+            MessageConsumer consumer = session.createConsumer(queue);\n+            Message receivedMessage = consumer.receive(2000);\n+            assertNotNull(receivedMessage);\n+            assertEquals(\"x\", receivedMessage.getStringProperty(\"x\"));\n+\n+            assertNull(consumer.receive(2000));\n+\n+            consumer.close();\n+         }\n+\n+         Files.copy(testConfiguration.openStream(), brokerXML, StandardCopyOption.REPLACE_EXISTING);\n+         brokerXML.toFile().setLastModified(System.currentTimeMillis() + 1000);\n+\n+         latch.setCount(1);\n+         embeddedActiveMQ.getActiveMQServer().getReloadManager().setTick(tick);\n+         latch.await(10, TimeUnit.SECONDS);\n+\n+         try (ActiveMQConnectionFactory factory = new ActiveMQConnectionFactory();\n+              Connection connection = factory.createConnection();\n+              Session session = connection.createSession(Session.AUTO_ACKNOWLEDGE)) {\n+\n+            connection.start();\n+            Queue queue = session.createQueue(\"myFilterQueue\");\n+            MessageProducer producer = session.createProducer(queue);\n+\n+            Message message1 = session.createMessage();\n+            message1.setStringProperty(\"x\", \"x\");\n+            producer.send(message1);\n+\n+            Message message2 = session.createMessage();\n+            message2.setStringProperty(\"x\", \"y\");\n+            producer.send(message2);\n+\n+            MessageConsumer consumer = session.createConsumer(queue);\n+            assertNotNull(consumer.receive(2000));\n+            assertNotNull(consumer.receive(2000));\n+\n+            consumer.close();\n+         }\n+\n+      } finally {\n+         embeddedActiveMQ.stop();\n+      }\n+   }\n+\n+   @Test\n+   public void testRedeployRemoveFilter() throws Exception {\n+      doTestRemoveFilter(RedeployTest.class.getClassLoader().getResource(\"reload-queue-filter-updated-empty.xml\"));\n+      doTestRemoveFilter(RedeployTest.class.getClassLoader().getResource(\"reload-queue-filter-removed.xml\"));\n+   }", "originalCommit": "b7506071a15081c81be1cc77f1b5f0fed92c553b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYyMDkwOA==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r438620908", "bodyText": "So to get defaults, should be using the address settings.\nTheres actually a common method that does this thats used else where, as its quite common\n QueueConfigurationUtils.applyDynamicQueueDefaults(queueConfiguration, addressSettingsRepository.getMatch(queueConfiguration.getAddress().toString()));\n\nThis then will correctly set defaults on everything in the queueConfiguration", "author": "michaelpearce-gain", "createdAt": "2020-06-11T08:20:21Z", "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/postoffice/impl/PostOfficeImpl.java", "diffHunk": "@@ -647,66 +649,121 @@ public QueueBinding updateQueue(QueueConfiguration queueConfiguration) throws Ex\n                }\n             }\n \n-            //atomic update\n-            if (queueConfiguration.getMaxConsumers() != null && queue.getMaxConsumers() != queueConfiguration.getMaxConsumers().intValue()) {\n+            // atomic update, reset to defaults if value == null\n+            // maxConsumers\n+            final int newMaxConsumers = queueConfiguration.getMaxConsumers() == null\n+                    ? ActiveMQDefaultConfiguration.getDefaultMaxQueueConsumers()\n+                    : queueConfiguration.getMaxConsumers();\n+            if (queue.getMaxConsumers() != newMaxConsumers) {\n                changed = true;\n-               queue.setMaxConsumer(queueConfiguration.getMaxConsumers());\n+               queue.setMaxConsumer(newMaxConsumers);\n             }\n-            if (queueConfiguration.getRoutingType() != null && queue.getRoutingType() != queueConfiguration.getRoutingType()) {\n+            // routingType\n+            final RoutingType newRoutingType = queueConfiguration.getRoutingType() == null", "originalCommit": "93cb9ff582c880aeaa6badeab727c6b65a828299", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYyMTI2MQ==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r438621261", "bodyText": "e.g. you could just do this once before the section of atomic updates.", "author": "michaelpearce-gain", "createdAt": "2020-06-11T08:20:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODYyMDkwOA=="}], "type": "inlineReview"}, {"oid": "5fe64d5c69992d429a2c481434c4dd30b7b69001", "url": "https://github.com/apache/activemq-artemis/commit/5fe64d5c69992d429a2c481434c4dd30b7b69001", "message": "Rebase onto the current master (+ apply the changes for Queue::isEnabled)", "committedDate": "2020-06-22T08:38:02Z", "type": "forcePushed"}, {"oid": "eb0159bc5eee657e549c40942b11a38a034b2c50", "url": "https://github.com/apache/activemq-artemis/commit/eb0159bc5eee657e549c40942b11a38a034b2c50", "message": "Rebase onto the current master (+ apply the changes for Queue::isEnabled)", "committedDate": "2020-06-23T05:14:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA2Mjg5Mg==", "url": "https://github.com/apache/activemq-artemis/pull/3172#discussion_r444062892", "bodyText": "can you rebase, this is already fixed in master", "author": "michaelpearce-gain", "createdAt": "2020-06-23T08:46:10Z", "path": "artemis-server/src/main/java/org/apache/activemq/artemis/core/server/impl/QueueImpl.java", "diffHunk": "@@ -3954,7 +3954,7 @@ public QueueConfiguration getQueueConfiguration() {\n          .setAddress(address)\n          .setId(id)\n          .setRoutingType(routingType)\n-         .setFilterString(filter.getFilterString())\n+         .setFilterString(filter == null ? null : filter.getFilterString())", "originalCommit": "b274f2e083842f87dd9a7395d6640205147228ca", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5070e7a72c84552c342d1f2da84c35650469e82f", "url": "https://github.com/apache/activemq-artemis/commit/5070e7a72c84552c342d1f2da84c35650469e82f", "message": "ARTEMIS-2797 - Reset queue properties by unsetting them in broker.xml\n\nNow it is possible to reset queue parameters to their defaults by removing them\nfrom broker.xml and redeploying the configuration.\n\nOriginally this PR covered the \"filter\" parameter only.", "committedDate": "2020-06-23T09:20:03Z", "type": "commit"}, {"oid": "5070e7a72c84552c342d1f2da84c35650469e82f", "url": "https://github.com/apache/activemq-artemis/commit/5070e7a72c84552c342d1f2da84c35650469e82f", "message": "ARTEMIS-2797 - Reset queue properties by unsetting them in broker.xml\n\nNow it is possible to reset queue parameters to their defaults by removing them\nfrom broker.xml and redeploying the configuration.\n\nOriginally this PR covered the \"filter\" parameter only.", "committedDate": "2020-06-23T09:20:03Z", "type": "forcePushed"}]}