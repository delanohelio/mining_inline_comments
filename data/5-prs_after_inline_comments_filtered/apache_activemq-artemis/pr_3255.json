{"pr_number": 3255, "pr_title": "ARTEMIS-2875 - Failed to handle re-establish connection failover", "pr_createdAt": "2020-09-07T06:52:52Z", "pr_url": "https://github.com/apache/activemq-artemis/pull/3255", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NTQyOQ==", "url": "https://github.com/apache/activemq-artemis/pull/3255#discussion_r485575429", "bodyText": "shouldn't you close the connection before setting it to null?\nalso... do you have a test showing the issue?\nAnd 3rd... can you amend the commit with the JIRA?\ngit commit --amend\n# on Vim or your configured editor, add the JIRA to the commit message (not the GitHub title)\ngit push origin -f\n(If you happen to have a test meanwhile you're doing that?)", "author": "clebertsuconic", "createdAt": "2020-09-09T12:35:43Z", "path": "artemis-core-client/src/main/java/org/apache/activemq/artemis/core/client/impl/ClientSessionFactoryImpl.java", "diffHunk": "@@ -632,11 +632,21 @@ private void failoverOrReconnect(final Object connectionID,\n \n                connector = null;\n \n-               reconnectSessions(oldConnection, reconnectAttempts, me);\n+               boolean allSessionReconnected;\n+               int failedReconnectSessionsCounter = 0;\n+               do {\n+                  allSessionReconnected = reconnectSessions(oldConnection, reconnectAttempts, me);\n+                  if (oldConnection != null) {\n+                     oldConnection.destroy();\n+                  }\n+                  oldConnection = connection;\n \n-               if (oldConnection != null) {\n-                  oldConnection.destroy();\n+                  if (!allSessionReconnected) {\n+                     failedReconnectSessionsCounter++;", "originalCommit": "e5a8955e197a6b4509b1ee0ec7686a52ab23116f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5ODk4Mw==", "url": "https://github.com/apache/activemq-artemis/pull/3255#discussion_r485598983", "bodyText": "the connection is not closed because the oldConnection is still using it. but the oldConnection might not get closed, I will fix that\n\n\nquite tricky to come up with a test as described in the other comment\n\n\nwill do", "author": "skrutzler", "createdAt": "2020-09-09T13:11:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NTQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NjE2Mg==", "url": "https://github.com/apache/activemq-artemis/pull/3255#discussion_r485576162", "bodyText": "this is the only test you changed... would this be enough to replicate the issue?\nshouldn't we parameterize the test to add this condition, since this seems to be changing other tests...\nI need some context on why you changed this.. if this is your test or what is this?\nthanks!", "author": "clebertsuconic", "createdAt": "2020-09-09T12:36:51Z", "path": "tests/integration-tests/src/test/java/org/apache/activemq/artemis/tests/integration/remoting/ReconnectTest.java", "diffHunk": "@@ -361,7 +361,7 @@ public boolean intercept(Packet packet, RemotingConnection connection) throws Ac\n \n       final long retryInterval = 50;\n       final double retryMultiplier = 1d;\n-      final int reconnectAttempts = 10;\n+      final int reconnectAttempts = 1;", "originalCommit": "e5a8955e197a6b4509b1ee0ec7686a52ab23116f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5MzkxMw==", "url": "https://github.com/apache/activemq-artemis/pull/3255#discussion_r485593913", "bodyText": "this test never used the reconnectAttempts because on a failed connection while processing a failover we immediatelly set the FailoverEventType.FAILOVER_FAILED. With my changes we now retry to reconnect for as often as reconnectAttempts is set, therefore on second try we would succeed to reconnect and never send the FailoverEventType.FAILOVER_FAILED.\nThis test was not done by me but shows that we do not try to reconnect for the specified amount of times.\nAdding a test for the issue I wanted to solve seems rather tricky because the issue is only present when the client can connect to the broker and while trying to handle the failover on the session looses the new connection.", "author": "skrutzler", "createdAt": "2020-09-09T13:04:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU3NjE2Mg=="}], "type": "inlineReview"}, {"oid": "1783aa15cba53ab3f03c8e9b21aa05479ba85df9", "url": "https://github.com/apache/activemq-artemis/commit/1783aa15cba53ab3f03c8e9b21aa05479ba85df9", "message": "ARTEMIS-2875 - retry to reattach sessions on failed failover for the specified amount of times set in reconnectAttempts parameter", "committedDate": "2020-09-10T06:21:18Z", "type": "commit"}]}