{"pr_number": 3130, "pr_title": "ARTEMIS-2757 improving flow control in AMQP", "pr_createdAt": "2020-05-12T23:27:20Z", "pr_url": "https://github.com/apache/activemq-artemis/pull/3130", "timeline": [{"oid": "2e5f0f8a3f67f4dedd09fa6bbfbd3e52637d3d66", "url": "https://github.com/apache/activemq-artemis/commit/2e5f0f8a3f67f4dedd09fa6bbfbd3e52637d3d66", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-12T23:27:50Z", "type": "forcePushed"}, {"oid": "06131629fde375528b71158b8c46d59c8841c6c5", "url": "https://github.com/apache/activemq-artemis/commit/06131629fde375528b71158b8c46d59c8841c6c5", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-12T23:30:38Z", "type": "forcePushed"}, {"oid": "1599ac1a36b0938f500fcf86096300ee46f70d1a", "url": "https://github.com/apache/activemq-artemis/commit/1599ac1a36b0938f500fcf86096300ee46f70d1a", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-12T23:31:38Z", "type": "forcePushed"}, {"oid": "11b8dc11e29b25dbaa8ece71440952cd6f0ca4f6", "url": "https://github.com/apache/activemq-artemis/commit/11b8dc11e29b25dbaa8ece71440952cd6f0ca4f6", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-12T23:32:33Z", "type": "forcePushed"}, {"oid": "1585e7f424e80528acd19378cfbd48da9f55e261", "url": "https://github.com/apache/activemq-artemis/commit/1585e7f424e80528acd19378cfbd48da9f55e261", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-12T23:37:53Z", "type": "forcePushed"}, {"oid": "2c0778588fef546b28a4e6b0c2d9da082ef72fdb", "url": "https://github.com/apache/activemq-artemis/commit/2c0778588fef546b28a4e6b0c2d9da082ef72fdb", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-12T23:55:51Z", "type": "forcePushed"}, {"oid": "3ed3af04f58239bac878af26f283e55ca521bba4", "url": "https://github.com/apache/activemq-artemis/commit/3ed3af04f58239bac878af26f283e55ca521bba4", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-13T18:03:48Z", "type": "forcePushed"}, {"oid": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "url": "https://github.com/apache/activemq-artemis/commit/bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements", "committedDate": "2020-05-14T19:12:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM3MTUzNw==", "url": "https://github.com/apache/activemq-artemis/pull/3130#discussion_r425371537", "bodyText": "This should fix your test... as this will guarantee no executor for non durable. It will be basically a straight call like before.", "author": "clebertsuconic", "createdAt": "2020-05-14T19:13:21Z", "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/broker/AMQPSessionCallback.java", "diffHunk": "@@ -496,15 +499,21 @@ public void serverSend(ProtonServerReceiverContext context,\n             }\n          } else {\n             message.setConnectionID(receiver.getSession().getConnection().getRemoteContainer());\n-            // We need to transfer IO execution to a different thread otherwise we may deadlock netty loop\n-            sessionExecutor.execute(() -> inSessionSend(context, transaction, message, delivery, receiver, routingContext));\n+            // If there are pending messages (durable) on the executors, we should still use the executors\n+            // otherwise we risk running out of order\n+            if (pendingSettles == 0 && !message.isDurable()) {", "originalCommit": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM3MTc3NA==", "url": "https://github.com/apache/activemq-artemis/pull/3130#discussion_r425371774", "bodyText": "@tabish121 this will also fix your test, as it will avoid using an executor for non durable", "author": "clebertsuconic", "createdAt": "2020-05-14T19:13:48Z", "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/broker/AMQPSessionCallback.java", "diffHunk": "@@ -543,7 +552,7 @@ private void inSessionSend(final ProtonServerReceiverContext context,\n             afterIO(new IOCallback() {\n                @Override\n                public void done() {\n-                  connection.runLater(() -> {\n+                  connection.runNow(() -> {", "originalCommit": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM4NjMxMQ==", "url": "https://github.com/apache/activemq-artemis/pull/3130#discussion_r425386311", "bodyText": "I tested this.. and the number of pending settlements is always 0 after this change for non durables... with durables it can go to a few dozen at a times.. .but credits will now take pending settlements into consideration.", "author": "clebertsuconic", "createdAt": "2020-05-14T19:42:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM3MTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTM3MjEyMw==", "url": "https://github.com/apache/activemq-artemis/pull/3130#discussion_r425372123", "bodyText": "@tabish121 also, in case you mix durable and non durable and use the executors, this will adjust pending settles on the credits.", "author": "clebertsuconic", "createdAt": "2020-05-14T19:14:31Z", "path": "artemis-protocols/artemis-amqp-protocol/src/main/java/org/apache/activemq/artemis/protocol/amqp/proton/ProtonServerReceiverContext.java", "diffHunk": "@@ -128,10 +147,11 @@ public void run() {\n          }\n \n          connection.requireInHandler();\n-         if (receiver.getCredit() <= threshold) {\n-            int topUp = refill - receiver.getCredit();\n+         int pending = context != null ? context.pendingSettles : 0;", "originalCommit": "bbffd73ca87966b6343adfc353e21d0e9e2c64c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84978c41ebf032b43d477c828fd6f875f3605091", "url": "https://github.com/apache/activemq-artemis/commit/84978c41ebf032b43d477c828fd6f875f3605091", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements", "committedDate": "2020-05-14T19:38:56Z", "type": "forcePushed"}, {"oid": "64793ca0c4220e4262b6e15f6330a4d257522f42", "url": "https://github.com/apache/activemq-artemis/commit/64793ca0c4220e4262b6e15f6330a4d257522f42", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements", "committedDate": "2020-05-14T19:39:08Z", "type": "forcePushed"}, {"oid": "58ea641e2683277d047a6ccc8dcadf6aa52b2f94", "url": "https://github.com/apache/activemq-artemis/commit/58ea641e2683277d047a6ccc8dcadf6aa52b2f94", "message": "ARTEMIS-2757 Improving flow control in AMQP 2nd improvements", "committedDate": "2020-05-14T19:49:40Z", "type": "forcePushed"}, {"oid": "7490bac8adb3cc984952b98cec5b9c1767008e9e", "url": "https://github.com/apache/activemq-artemis/commit/7490bac8adb3cc984952b98cec5b9c1767008e9e", "message": "ARTEMIS-2757 to be squashed - testing added", "committedDate": "2020-05-14T20:36:39Z", "type": "forcePushed"}, {"oid": "231df44d44f726038ebb53e45e142dd8f04ae6e6", "url": "https://github.com/apache/activemq-artemis/commit/231df44d44f726038ebb53e45e142dd8f04ae6e6", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-14T22:11:33Z", "type": "forcePushed"}, {"oid": "aacaee5c12808d258e5e4ae4e05c7179a5c9f7ea", "url": "https://github.com/apache/activemq-artemis/commit/aacaee5c12808d258e5e4ae4e05c7179a5c9f7ea", "message": "ARTEMIS-2757 Isolating Credits Calculation and adding a test", "committedDate": "2020-05-15T14:39:44Z", "type": "forcePushed"}, {"oid": "9ff3c17525b39410a934073a30548e3aa1b1cddc", "url": "https://github.com/apache/activemq-artemis/commit/9ff3c17525b39410a934073a30548e3aa1b1cddc", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-15T20:12:07Z", "type": "commit"}, {"oid": "9ff3c17525b39410a934073a30548e3aa1b1cddc", "url": "https://github.com/apache/activemq-artemis/commit/9ff3c17525b39410a934073a30548e3aa1b1cddc", "message": "ARTEMIS-2757 improving flow control in AMQP", "committedDate": "2020-05-15T20:12:07Z", "type": "forcePushed"}]}