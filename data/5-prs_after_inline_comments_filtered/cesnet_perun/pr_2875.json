{"pr_number": 2875, "pr_title": "Core - created display name heuristic", "pr_createdAt": "2020-08-31T11:50:00Z", "pr_url": "https://github.com/CESNET/perun/pull/2875", "timeline": [{"oid": "fee046319f4df211fb2773d2e87f08eeda9ff932", "url": "https://github.com/CESNET/perun/commit/fee046319f4df211fb2773d2e87f08eeda9ff932", "message": "Core - created display name heuristic\n\n* There were some known problems with parsing display name. If the name\ncontained a middle name, it was not parsed properly. Also, sometimes the\ndisplay name contained first name and last name in reverse order.\n* Sometimes, it is possible to improve this, if the IDP send sn(surname)\nand given name of the user.\n* Now, if the idp did sent the information, the parser tries to match\nthese values (also in reverse order). If is succeedes it tries to parse\ntitles and middle name.", "committedDate": "2020-08-31T15:52:28Z", "type": "forcePushed"}, {"oid": "e3f33a5c8fc17ff841a10183743df3f5c57fac9c", "url": "https://github.com/CESNET/perun/commit/e3f33a5c8fc17ff841a10183743df3f5c57fac9c", "message": "Core - created display name heuristic\n\n* There were some known problems with parsing display name. If the name\ncontained a middle name, it was not parsed properly. Also, sometimes the\ndisplay name contained first name and last name in reverse order.\n* Sometimes, it is possible to improve this, if the IDP send sn(surname)\nand given name of the user.\n* Now, if the idp did sent the information, the parser tries to match\nthese values (also in reverse order). If is succeedes it tries to parse\ntitles and middle name.", "committedDate": "2020-08-31T16:48:18Z", "type": "forcePushed"}, {"oid": "b20170c98ca063eb55ed92f052f58192d4badf9b", "url": "https://github.com/CESNET/perun/commit/b20170c98ca063eb55ed92f052f58192d4badf9b", "message": "Core - created display name heuristic\n\n* There were some known problems with parsing display name. If the name\ncontained a middle name, it was not parsed properly. Also, sometimes the\ndisplay name contained first name and last name in reverse order.\n* Sometimes, it is possible to improve this, if the IDP send sn(surname)\nand given name of the user.\n* Now, if the idp did sent the information, the parser tries to match\nthese values (also in reverse order). If is succeedes it tries to parse\ntitles and middle name.", "committedDate": "2020-08-31T16:49:21Z", "type": "forcePushed"}, {"oid": "70306a0acf9bdc26b5fb356e9fcec27ac7dff2de", "url": "https://github.com/CESNET/perun/commit/70306a0acf9bdc26b5fb356e9fcec27ac7dff2de", "message": "Core - created display name heuristic\n\n* There were some known problems with parsing display name. If the name\ncontained a middle name, it was not parsed properly. Also, sometimes the\ndisplay name contained first name and last name in reverse order.\n* Sometimes, it is possible to improve this, if the IDP send sn(surname)\nand given name of the user.\n* Now, if the idp did sent the information, the parser tries to match\nthese values (also in reverse order). If is succeedes it tries to parse\ntitles and middle name.", "committedDate": "2020-08-31T16:54:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk2NTIzNg==", "url": "https://github.com/CESNET/perun/pull/2875#discussion_r481965236", "bodyText": "Typo getNamesPatter", "author": "balcirakpeter", "createdAt": "2020-09-02T10:27:26Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -3323,27 +3353,133 @@ private Candidate createCandidateFromApplicationData(Integer appId) {\n \t\t\t\tcandidate.setTitleAfter(commonName.get(\"titleAfter\"));\n \t\t\t}\n \t\t}\n+\t}\n \n-\t\t// if names are separated, used them after\n-\t\tfor (String attrName : attributes.keySet()) {\n-\t\t\t// if value not null or empty - set to candidate\n-\t\t\tif (attributes.get(attrName) != null\n-\t\t\t\t&& !attributes.get(attrName).isEmpty()) {\n-\t\t\t\tif (URN_USER_TITLE_BEFORE.equals(attrName)) {\n-\t\t\t\t\tcandidate.setTitleBefore(attributes.get(attrName));\n-\t\t\t\t} else if (URN_USER_TITLE_AFTER.equals(attrName)) {\n-\t\t\t\t\tcandidate.setTitleAfter(attributes.get(attrName));\n-\t\t\t\t} else if (URN_USER_FIRST_NAME.equals(attrName)) {\n-\t\t\t\t\tcandidate.setFirstName(attributes.get(attrName));\n-\t\t\t\t} else if (URN_USER_LAST_NAME.equals(attrName)) {\n-\t\t\t\t\tcandidate.setLastName(attributes.get(attrName));\n-\t\t\t\t} else if (URN_USER_MIDDLE_NAME.equals(attrName)) {\n-\t\t\t\t\tcandidate.setMiddleName(attributes.get(attrName));\n-\t\t\t\t}\n+\t/**\n+\t * Check if the given fed info contains givenName and sn (surname). If so,\n+\t * it sets it to the candidate and tries to match titles and middle name from\n+\t * display name.\n+\t *\n+\t * @param candidate candidate\n+\t * @param attributes attributes with values\n+\t * @param fedInfo key-value info from idp\n+\t */\n+\tpublic void parseNamesFromDisplayNameAndFedInfo(Candidate candidate, Map<String, String> attributes,\n+\t                                                Map<String, String> fedInfo) {\n+\t\tif (fedInfo != null && containsNonEmptyValue(fedInfo, FED_GIVEN_NAME) && containsNonEmptyValue(fedInfo, FED_SN)) {\n+\t\t\tString firstName = fedInfo.get(FED_GIVEN_NAME);\n+\t\t\tString lastName = fedInfo.get(FED_SN);\n+\n+\t\t\tcandidate.setFirstName(firstName);\n+\t\t\tcandidate.setLastName(lastName);\n+\n+\t\t\ttryToParseTitlesAndMiddleName(candidate, attributes, firstName, lastName);\n+\t\t} else {\n+\t\t\tparseNamesFromDisplayName(candidate, attributes);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * If the given map of attributes contains a user display name, it tries to match\n+\t * the given firstName and lastName and find titles and middle name.\n+\t *\n+\t * @param candidate candidate\n+\t * @param attributes map of attributes with values\n+\t * @param firstName first name to match\n+\t * @param lastName last name to match\n+\t */\n+\tprivate void tryToParseTitlesAndMiddleName(Candidate candidate, Map<String, String> attributes, String firstName,\n+\t                                           String lastName) {\n+\t\tif (containsNonEmptyValue(attributes, URN_USER_DISPLAY_NAME)) {\n+\t\t\tString displayName = attributes.get(URN_USER_DISPLAY_NAME);\n+\n+\t\t\tPattern pattern = getNamesPatter(firstName, lastName);\n+\t\t\tif (!tryToParseTitlesAndMiddleNameFromPattern(candidate, displayName, pattern)) {\n+\t\t\t\tPattern reversePattern = getNamesPatter(lastName, firstName);\n+\t\t\t\ttryToParseTitlesAndMiddleNameFromPattern(candidate, displayName, reversePattern);\n \t\t\t}\n \t\t}\n+\t}\n \n-\t\treturn candidate;\n+\t/**\n+\t * Tries to match the given pattern to the given display name. If it matches, its sets\n+\t * titles and middle name from matcher of the given pattern to the given candidate.\n+\t *\n+\t * This method expects the pattern to define 3 groups in order - 1. Titles before, 2. Middle name, 3. Titles after\n+\t *\n+\t * @param candidate candidate\n+\t * @param displayName display name\n+\t * @param pattern pattern with 3 matching groups\n+\t * @return true, if the matcher matched\n+\t */\n+\tprivate boolean tryToParseTitlesAndMiddleNameFromPattern(Candidate candidate, String displayName, Pattern pattern) {\n+\t\tMatcher matcher = pattern.matcher(displayName);\n+\t\tif (!matcher.matches()) {\n+\t\t\treturn false;\n+\t\t}\n+\t\tif (matcher.groupCount() != 3) {\n+\t\t\tthrow new InternalErrorException(\"Expected pattern with 3 groups to match - titles before, middle name and \" +\n+\t\t\t\t\t\"titles after, but get \" + matcher.groupCount() + \" groups.\" );\n+\t\t}\n+\n+\t\tparseTitlesBefore(candidate, matcher.group(1));\n+\t\tparseMiddleName(candidate, matcher.group(2));\n+\t\tparseTitlesAfter(candidate, matcher.group(3));\n+\n+\t\treturn true;\n+\t}\n+\n+\t/**\n+\t * To given candidate, sets titleBefore from trim of given value, or null if empty.\n+\t *\n+\t * @param candidate candidate\n+\t * @param value value\n+\t */\n+\tprivate void parseTitlesBefore(Candidate candidate, String value) {\n+\t\tcandidate.setTitleBefore(value.trim().isEmpty() ? null : value.trim());\n+\t}\n+\n+\t/**\n+\t * To given candidate, sets middle name from trim of given value.\n+\t * @param candidate candidate\n+\t * @param value value\n+\t */\n+\tprivate void parseMiddleName(Candidate candidate, String value) {\n+\t\tcandidate.setMiddleName(value.trim().isEmpty() ? null : value.trim());\n+\t}\n+\n+\t/**\n+\t * To given candidate, sets titleAfter from trim of given value, or null if empty.\n+\t *\n+\t * @param candidate candidate\n+\t * @param value value\n+\t */\n+\tprivate void parseTitlesAfter(Candidate candidate, String value) {\n+\t\tcandidate.setTitleAfter(value.trim().isEmpty() ? null : value.trim());\n+\t}\n+\n+\t/**\n+\t * Generates pattern for parsing titles and middle name from given values.\n+\t *\n+\t * The pattern is of format: ^(.*){firstName}(.*){lastName}(.*)$\n+\t *\n+\t * @param firstName first name\n+\t * @param lastName last name\n+\t * @return pattern for parsing titles and middle name\n+\t */\n+\tprivate Pattern getNamesPatter(String firstName, String lastName) {", "originalCommit": "70306a0acf9bdc26b5fb356e9fcec27ac7dff2de", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1b08b4a0d9f15843a0119e37adff05b45ff34cf7", "url": "https://github.com/CESNET/perun/commit/1b08b4a0d9f15843a0119e37adff05b45ff34cf7", "message": "Core - created display name heuristic\n\n* There were some known problems with parsing display name. If the name\ncontained a middle name, it was not parsed properly. Also, sometimes the\ndisplay name contained first name and last name in reverse order.\n* Sometimes, it is possible to improve this, if the IDP send sn(surname)\nand given name of the user.\n* Now, if the idp did sent the information, the parser tries to match\nthese values (also in reverse order). If is succeedes it tries to parse\ntitles and middle name.", "committedDate": "2020-09-02T12:48:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3OTY2Nw==", "url": "https://github.com/CESNET/perun/pull/2875#discussion_r482779667", "bodyText": "Not necessarily in this pull-request, but we might want to improve updateUserNameTitles(Application app) too, since it parses displayName form the form in order to get and update titles before/after. It might work better if we use new matching against first/last name regexes from getNamesPattern().", "author": "zlamalp", "createdAt": "2020-09-03T07:53:11Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -1675,7 +1679,7 @@ public Application approveApplicationInternal(PerunSession sess, int appId) thro\n \t\t\t\t\t\t// ==> updateNameTitles() in case of change in appForm.\n \t\t\t\t\t\tupdateUserNameTitles(app);", "originalCommit": "1b08b4a0d9f15843a0119e37adff05b45ff34cf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM1MTk1Nw==", "url": "https://github.com/CESNET/perun/pull/2875#discussion_r484351957", "bodyText": "We actually want to make some bigger changes to the logic of parsing names. So I think this won't be necessary right now, or we can fix that in some other PR.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-07T10:45:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc3OTY2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4MTY4OQ==", "url": "https://github.com/CESNET/perun/pull/2875#discussion_r482781689", "bodyText": "We already have these constants few lines below. But you can update them to your format/style which is correct.", "author": "zlamalp", "createdAt": "2020-09-03T07:56:34Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -158,6 +160,8 @@\n \tprivate static final String NAMESPACE_GROUP_MAIL_FOOTER = AttributesManager.NS_GROUP_ATTR_DEF;\n \tstatic final String URN_GROUP_MAIL_FOOTER = NAMESPACE_GROUP_MAIL_FOOTER + \":\" + FRIENDLY_NAME_GROUP_MAIL_FOOTER;\n \n+\tprivate static final String FED_SN = \"sn\";\n+\tprivate static final String FED_GIVEN_NAME = \"givenName\";", "originalCommit": "1b08b4a0d9f15843a0119e37adff05b45ff34cf7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDM1MjE4OA==", "url": "https://github.com/CESNET/perun/pull/2875#discussion_r484352188", "bodyText": "I have used the old constants.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-07T10:45:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjc4MTY4OQ=="}], "type": "inlineReview"}, {"oid": "5e19ee731d296b010f201cc8c8c51db276746e2d", "url": "https://github.com/CESNET/perun/commit/5e19ee731d296b010f201cc8c8c51db276746e2d", "message": "Core - created display name heuristic\n\n* There were some known problems with parsing display name. If the name\ncontained a middle name, it was not parsed properly. Also, sometimes the\ndisplay name contained first name and last name in reverse order.\n* Sometimes, it is possible to improve this, if the IDP send sn(surname)\nand given name of the user.\n* Now, if the idp did sent the information, the parser tries to match\nthese values (also in reverse order). If is succeedes it tries to parse\ntitles and middle name.", "committedDate": "2020-09-07T10:38:12Z", "type": "commit"}, {"oid": "5e19ee731d296b010f201cc8c8c51db276746e2d", "url": "https://github.com/CESNET/perun/commit/5e19ee731d296b010f201cc8c8c51db276746e2d", "message": "Core - created display name heuristic\n\n* There were some known problems with parsing display name. If the name\ncontained a middle name, it was not parsed properly. Also, sometimes the\ndisplay name contained first name and last name in reverse order.\n* Sometimes, it is possible to improve this, if the IDP send sn(surname)\nand given name of the user.\n* Now, if the idp did sent the information, the parser tries to match\nthese values (also in reverse order). If is succeedes it tries to parse\ntitles and middle name.", "committedDate": "2020-09-07T10:38:12Z", "type": "forcePushed"}]}