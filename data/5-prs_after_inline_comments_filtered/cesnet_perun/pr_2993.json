{"pr_number": 2993, "pr_title": "Fix roles management", "pr_createdAt": "2020-11-22T16:59:35Z", "pr_url": "https://github.com/CESNET/perun/pull/2993", "timeline": [{"oid": "b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "url": "https://github.com/CESNET/perun/commit/b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "message": "Fix roles management\n\n- getAdminGroups and getRichAdmins use only simple perun bean consisting\n  only from its name and id. However, to properly resolve authorization,\n  we need also information about connected objects like vo id for group etc.\n- Second issue is that methods setRole and unsetRole are composing\n  PerunBeans only from information recieved from input. Therefore, someone\n  can fake information about the connected objects like fake vo id for\n  group. This way it would be possible to setRole on object without proper\n  rights.\n- Solution for these issues was to fetch the real object from database\n  according to bean name and its id. This way the final object will have\n  correct all its values. For this purpose were implemented methods\n  fetchPerunBean and fetchPerunBeans. They suppport only objects which\n  can be managed for now. It will be extended later. These methods are\n  now used in RPC methods setRole, unsetRole, getAdminGroups and\n  getRichAdmins.\n- While fixing these problems, we have realized that it is not possible\n  to call set and unset role methods without complementary object.\n  However the underlying logic allows to operate with null complementary\n  object. Therefore, this option was added to these RPC methods.", "committedDate": "2020-11-23T08:16:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNDAwMw==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528524003", "bodyText": "Can't we simply fetch bean based on \"class\" and \"id? If you would update getBeanFromDatabase() for that, you could use shared logic, instead of instantiating fake class and then replacing it with the real object anyway.", "author": "zlamalp", "createdAt": "2020-11-23T08:08:40Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -129,6 +129,7 @@ public AuthzRoles call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\ttry {\n \t\t\t\tbean = (PerunBean) Class.forName(\"cz.metacentrum.perun.core.api.\" + complementaryObjectName).getConstructor().newInstance();\n \t\t\t\tbean.setId(complementaryObjectId);\n+\t\t\t\tbean = ac.fetchPerunBean(bean);", "originalCommit": "bad1f228a3b341354fa1e011cb820fba8af71e67", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMDgxNw==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528530817", "bodyText": "You are right I will change it.", "author": "balcirakpeter", "createdAt": "2020-11-23T08:23:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNDAwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYwMDQxNg==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528600416", "bodyText": "Ok, we have decided that we will do it in the future as a refactorization.", "author": "balcirakpeter", "createdAt": "2020-11-23T10:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyNDAwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTg4OQ==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528529889", "bodyText": "So, generally there is no longer any check, that role requires some complementary object and we can expect more \"group managers without any group\" or what? If there is no check, then it might fail in AuthzResolverBlImpl.unsetRole(sess, user, complementaryObject, role) for role SPONSOR where code fetches beanName from complementaryObject. There might be more places like this.", "author": "zlamalp", "createdAt": "2020-11-23T08:21:27Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -250,6 +270,15 @@ public AuthzRoles call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t * @exampleParam role \"VOADMIN\"\n \t * @exampleParam complementaryObject { \"id\" : 123 , \"name\" : \"My testing VO\" , \"shortName\" : \"test_vo\" , \"beanName\" : \"Vo\" }\n \t */\n+\t/*#\n+\t * Set role for users.\n+\t *\n+\t * IMPORTANT: Refresh authz only if user in session is affected.\n+\t *\n+\t * @param role String Role which will be set for given users ( FACILITYADMIN | GROUPADMIN | PERUNADMIN | RESOURCEADMIN | RESOURCESELFSERVICE | SPONSOR | TOPGROUPCREATOR | VOADMIN | VOOBSERVER | PERUNOBSERVER | SECURITYADMIN | CABINETADMIN )\n+\t * @param users int[] <code>ids</code> of users for which is the role set\n+\t * @exampleParam role \"VOADMIN\"\n+\t */", "originalCommit": "b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUzMjQzMw==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528532433", "bodyText": "Rules for that are defined in the perun-roles.yml. So for example, it is possible to set/unset role without a complementary object for PERUNADMIN, PERUNOBSERVER, CABINETADMIN. However, it is not possible to set/unset role without a complementary object for GROUPADMIN, VOADMIN, SPONSOR etc.\nThis is checked in the business logic of set/unset role methods.", "author": "balcirakpeter", "createdAt": "2020-11-23T08:26:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTg4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2ODQwNA==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528668404", "bodyText": "Ok, that makes sense. It just might be confusing in javadoc, since we do not list correct combinations, but only all possible. But since its technically configurable per-instance we probably can't do anything about it.", "author": "zlamalp", "createdAt": "2020-11-23T12:29:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODUyOTg4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NDE5Nw==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528674197", "bodyText": "Nit: Unused imports.", "author": "Vojtech-Sassmann", "createdAt": "2020-11-23T12:39:39Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/ApiCaller.java", "diffHunk": "@@ -1,8 +1,12 @@\n package cz.metacentrum.perun.rpc;\n \n import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Collections;\n import java.util.List;\n import java.util.Map;\n+import java.util.function.BiFunction;\n+import java.util.function.Function;", "originalCommit": "b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4OTM0Nw==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528689347", "bodyText": "Removed", "author": "balcirakpeter", "createdAt": "2020-11-23T13:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY3NDE5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTU1NA==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528681554", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n          \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),", "author": "Vojtech-Sassmann", "createdAt": "2020-11-23T12:53:04Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -279,63 +317,79 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\t\tif(parms.contains(\"complementaryObject\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"),\n+\t\t\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")),\n \t\t\t\t\t\t\t\troleName);\n \t\t\t\t\treturn null;\n \t\t\t\t} else if(parms.contains(\"complementaryObjects\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readListPerunBeans(\"complementaryObjects\"));\n+\t\t\t\t\t\tac.fetchPerunBeans(parms.readListPerunBeans(\"complementaryObjects\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"list of complementary objects or complementary object\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),", "originalCommit": "b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4OTU3Mg==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528689572", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-11-23T13:06:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTY4MA==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528681680", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n          \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),", "author": "Vojtech-Sassmann", "createdAt": "2020-11-23T12:53:18Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -279,63 +317,79 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\t\tif(parms.contains(\"complementaryObject\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"),\n+\t\t\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")),\n \t\t\t\t\t\t\t\troleName);\n \t\t\t\t\treturn null;\n \t\t\t\t} else if(parms.contains(\"complementaryObjects\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readListPerunBeans(\"complementaryObjects\"));\n+\t\t\t\t\t\tac.fetchPerunBeans(parms.readListPerunBeans(\"complementaryObjects\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"list of complementary objects or complementary object\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n+\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n+\t\t\t\t\t\tnull,\n+\t\t\t\t\t\troleName);\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n \t\t\t} else if (parms.contains(\"users\")) {\n+\t\t\t\tint[] userIds = parms.readArrayOfInts(\"users\");\n+\t\t\t\tList<User> users = new ArrayList<>(userIds.length);\n+\t\t\t\tfor (int userId : userIds) {\n+\t\t\t\t\tusers.add(ac.getUserById(userId));\n+\t\t\t\t}\n \t\t\t\tif (parms.contains(\"complementaryObject\")) {\n-\t\t\t\t\tint[] userIds = parms.readArrayOfInts(\"users\");\n-\t\t\t\t\tList<User> users = new ArrayList<>(userIds.length);\n-\t\t\t\t\tfor (int userId : userIds) {\n-\t\t\t\t\t\tusers.add(ac.getUserById(userId));\n-\t\t\t\t\t}\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tusers,\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"));\n+\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"complementaryObject\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),", "originalCommit": "b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4OTUzOQ==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528689539", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-11-23T13:06:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTY4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTgzNA==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528681834", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n          \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),", "author": "Vojtech-Sassmann", "createdAt": "2020-11-23T12:53:37Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -279,63 +317,79 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\t\tif(parms.contains(\"complementaryObject\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"),\n+\t\t\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")),\n \t\t\t\t\t\t\t\troleName);\n \t\t\t\t\treturn null;\n \t\t\t\t} else if(parms.contains(\"complementaryObjects\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readListPerunBeans(\"complementaryObjects\"));\n+\t\t\t\t\t\tac.fetchPerunBeans(parms.readListPerunBeans(\"complementaryObjects\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"list of complementary objects or complementary object\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n+\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n+\t\t\t\t\t\tnull,\n+\t\t\t\t\t\troleName);\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n \t\t\t} else if (parms.contains(\"users\")) {\n+\t\t\t\tint[] userIds = parms.readArrayOfInts(\"users\");\n+\t\t\t\tList<User> users = new ArrayList<>(userIds.length);\n+\t\t\t\tfor (int userId : userIds) {\n+\t\t\t\t\tusers.add(ac.getUserById(userId));\n+\t\t\t\t}\n \t\t\t\tif (parms.contains(\"complementaryObject\")) {\n-\t\t\t\t\tint[] userIds = parms.readArrayOfInts(\"users\");\n-\t\t\t\t\tList<User> users = new ArrayList<>(userIds.length);\n-\t\t\t\t\tfor (int userId : userIds) {\n-\t\t\t\t\t\tusers.add(ac.getUserById(userId));\n-\t\t\t\t\t}\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tusers,\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"));\n+\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"complementaryObject\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n+\t\t\t\t\t\tusers,\n+\t\t\t\t\t\troleName,\n+\t\t\t\t\t\tnull);\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n \t\t\t} else if (parms.contains(\"authorizedGroups\")) {\n+\t\t\t\tint[] groupIds = parms.readArrayOfInts(\"authorizedGroups\");\n+\t\t\t\tList<Group> groups = new ArrayList<>(groupIds.length);\n+\t\t\t\tfor (int groupId : groupIds) {\n+\t\t\t\t\tgroups.add(ac.getGroupById(groupId));\n+\t\t\t\t}\n \t\t\t\tif (parms.contains(\"complementaryObject\")) {\n-\t\t\t\t\tint[] groupIds = parms.readArrayOfInts(\"authorizedGroups\");\n-\t\t\t\t\tList<Group> groups = new ArrayList<>(groupIds.length);\n-\t\t\t\t\tfor (int groupId : groupIds) {\n-\t\t\t\t\t\tgroups.add(ac.getGroupById(groupId));\n-\t\t\t\t\t}\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tgroups,\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"),\n+\t\t\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")),\n \t\t\t\t\t\t\t\troleName);\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"complementaryObject\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),", "originalCommit": "b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4OTUxMg==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528689512", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-11-23T13:06:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MTgzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MzEyMQ==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528683121", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n          \n          \n            \n            \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),", "author": "Vojtech-Sassmann", "createdAt": "2020-11-23T12:55:43Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -279,63 +317,79 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\t\tif(parms.contains(\"complementaryObject\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"),\n+\t\t\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")),\n \t\t\t\t\t\t\t\troleName);\n \t\t\t\t\treturn null;\n \t\t\t\t} else if(parms.contains(\"complementaryObjects\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readListPerunBeans(\"complementaryObjects\"));\n+\t\t\t\t\t\tac.fetchPerunBeans(parms.readListPerunBeans(\"complementaryObjects\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"list of complementary objects or complementary object\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n+\t\t\t\t\t\tac.getUserById(parms.readInt(\"user\")),\n+\t\t\t\t\t\tnull,\n+\t\t\t\t\t\troleName);\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n \t\t\t} else if (parms.contains(\"users\")) {\n+\t\t\t\tint[] userIds = parms.readArrayOfInts(\"users\");\n+\t\t\t\tList<User> users = new ArrayList<>(userIds.length);\n+\t\t\t\tfor (int userId : userIds) {\n+\t\t\t\t\tusers.add(ac.getUserById(userId));\n+\t\t\t\t}\n \t\t\t\tif (parms.contains(\"complementaryObject\")) {\n-\t\t\t\t\tint[] userIds = parms.readArrayOfInts(\"users\");\n-\t\t\t\t\tList<User> users = new ArrayList<>(userIds.length);\n-\t\t\t\t\tfor (int userId : userIds) {\n-\t\t\t\t\t\tusers.add(ac.getUserById(userId));\n-\t\t\t\t\t}\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tusers,\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"));\n+\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"complementaryObject\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n+\t\t\t\t\t\tusers,\n+\t\t\t\t\t\troleName,\n+\t\t\t\t\t\tnull);\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n \t\t\t} else if (parms.contains(\"authorizedGroups\")) {\n+\t\t\t\tint[] groupIds = parms.readArrayOfInts(\"authorizedGroups\");\n+\t\t\t\tList<Group> groups = new ArrayList<>(groupIds.length);\n+\t\t\t\tfor (int groupId : groupIds) {\n+\t\t\t\t\tgroups.add(ac.getGroupById(groupId));\n+\t\t\t\t}\n \t\t\t\tif (parms.contains(\"complementaryObject\")) {\n-\t\t\t\t\tint[] groupIds = parms.readArrayOfInts(\"authorizedGroups\");\n-\t\t\t\t\tList<Group> groups = new ArrayList<>(groupIds.length);\n-\t\t\t\t\tfor (int groupId : groupIds) {\n-\t\t\t\t\t\tgroups.add(ac.getGroupById(groupId));\n-\t\t\t\t\t}\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tgroups,\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"),\n+\t\t\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")),\n \t\t\t\t\t\t\t\troleName);\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"complementaryObject\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),\n+\t\t\t\t\t\tgroups,\n+\t\t\t\t\t\tnull,\n+\t\t\t\t\t\troleName);\n+\t\t\t\t\treturn null;\n \t\t\t\t}\n \t\t\t} else if(parms.contains(\"authorizedGroup\")) {\n \t\t\t\tif(parms.contains(\"complementaryObject\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getGroupById(parms.readInt(\"authorizedGroup\")),\n-\t\t\t\t\t\t\t\tparms.readPerunBean(\"complementaryObject\"),\n+\t\t\t\t\t\t\t\tac.fetchPerunBean(parms.readPerunBean(\"complementaryObject\")),\n \t\t\t\t\t\t\t\troleName);\n \t\t\t\t\treturn null;\n \t\t\t\t} else if(parms.contains(\"complementaryObjects\")) {\n \t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.setRole(ac.getSession(),\n \t\t\t\t\t\t\t\tac.getGroupById(parms.readInt(\"authorizedGroup\")),\n \t\t\t\t\t\t\t\troleName,\n-\t\t\t\t\t\t\t\tparms.readListPerunBeans(\"complementaryObjects\"));\n+\t\t\t\t\t\t\t\tac.fetchPerunBeans(parms.readListPerunBeans(\"complementaryObjects\")));\n \t\t\t\t\treturn null;\n \t\t\t\t} else {\n-\t\t\t\t\tthrow new RpcException(RpcException.Type.MISSING_VALUE, \"list of complementary objects or complementary object\");\n+\t\t\t\t\tcz.metacentrum.perun.core.api.AuthzResolver.unsetRole(ac.getSession(),", "originalCommit": "b7075fd6b98d9044dd5b63852bad2986fa49a3eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4OTQ2OA==", "url": "https://github.com/CESNET/perun/pull/2993#discussion_r528689468", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-11-23T13:06:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY4MzEyMQ=="}], "type": "inlineReview"}, {"oid": "4417fa0975a1ec958d722b46e8d1f999e8788c44", "url": "https://github.com/CESNET/perun/commit/4417fa0975a1ec958d722b46e8d1f999e8788c44", "message": "Fix roles management\n\n- getAdminGroups and getRichAdmins use only simple perun bean consisting\n  only from its name and id. However, to properly resolve authorization,\n  we need also information about connected objects like vo id for group etc.\n- Second issue is that methods setRole and unsetRole are composing\n  PerunBeans only from information recieved from input. Therefore, someone\n  can fake information about the connected objects like fake vo id for\n  group. This way it would be possible to setRole on object without proper\n  rights.\n- Solution for these issues was to fetch the real object from database\n  according to bean name and its id. This way the final object will have\n  correct all its values. For this purpose were implemented methods\n  fetchPerunBean and fetchPerunBeans. They suppport only objects which\n  can be managed for now. It will be extended later. These methods are\n  now used in RPC methods setRole, unsetRole, getAdminGroups and\n  getRichAdmins.\n- While fixing these problems, we have realized that it is not possible\n  to call set and unset role methods without complementary object.\n  However the underlying logic allows to operate with null complementary\n  object. Therefore, this option was added to these RPC methods.", "committedDate": "2020-11-23T13:05:56Z", "type": "commit"}, {"oid": "4417fa0975a1ec958d722b46e8d1f999e8788c44", "url": "https://github.com/CESNET/perun/commit/4417fa0975a1ec958d722b46e8d1f999e8788c44", "message": "Fix roles management\n\n- getAdminGroups and getRichAdmins use only simple perun bean consisting\n  only from its name and id. However, to properly resolve authorization,\n  we need also information about connected objects like vo id for group etc.\n- Second issue is that methods setRole and unsetRole are composing\n  PerunBeans only from information recieved from input. Therefore, someone\n  can fake information about the connected objects like fake vo id for\n  group. This way it would be possible to setRole on object without proper\n  rights.\n- Solution for these issues was to fetch the real object from database\n  according to bean name and its id. This way the final object will have\n  correct all its values. For this purpose were implemented methods\n  fetchPerunBean and fetchPerunBeans. They suppport only objects which\n  can be managed for now. It will be extended later. These methods are\n  now used in RPC methods setRole, unsetRole, getAdminGroups and\n  getRichAdmins.\n- While fixing these problems, we have realized that it is not possible\n  to call set and unset role methods without complementary object.\n  However the underlying logic allows to operate with null complementary\n  object. Therefore, this option was added to these RPC methods.", "committedDate": "2020-11-23T13:05:56Z", "type": "forcePushed"}]}