{"pr_number": 2671, "pr_title": "CORE: Fixed audit message resolving for eduPersonScopedAffiliations", "pr_createdAt": "2020-04-17T21:19:11Z", "pr_url": "https://github.com/CESNET/perun/pull/2671", "timeline": [{"oid": "98873fb29be0146a14a5e0827ae4ea169446c098", "url": "https://github.com/CESNET/perun/commit/98873fb29be0146a14a5e0827ae4ea169446c098", "message": "CORE: Fixed audit message resolving for eduPersonScopedAffiliations\n\n- Shorter code when resolving affiliations from users groups.\n- Added getMembersByUserWithStatus() into MembersManagerBl, it\n  returns only those members of users, which have specified status,\n  eg. VALID.\n- Module for user:virt:eduPersonScopedAffiliations now reacts also\n  on necessary group membership and member status events.\n  Implemented new message resolving within module for case of source\n  group attribute changes, since we must iterate over current group\n  users.", "committedDate": "2020-04-17T21:17:14Z", "type": "commit"}, {"oid": "68e70c107bf3d82b955b9744260c066272a31b6b", "url": "https://github.com/CESNET/perun/commit/68e70c107bf3d82b955b9744260c066272a31b6b", "message": "CORE: Fixed tests of eduPersonScopedAffiliations\n\n- We must mock different methods, since implementation of module changed.\n- Also those methods return only VALID members, hence there is no reason\n  for expired member in mocks.", "committedDate": "2020-04-20T10:51:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI4NjMxMg==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411286312", "bodyText": "Are you sure this is necessary?  I can't find casting to integer in any other method (using status) in this manager.", "author": "stavamichal", "createdAt": "2020-04-20T11:00:48Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/MembersManagerImpl.java", "diffHunk": "@@ -147,6 +147,19 @@ public Member getMemberByUserId(PerunSession sess, Vo vo, int userId) throws Int\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Member> getMembersByUserWithStatus(PerunSession sess, User user, Status status) throws InternalErrorException {\n+\t\ttry {\n+\t\t\treturn jdbc.query(\"SELECT \" + memberMappingSelectQuery + \" FROM\" +\n+\t\t\t\t\t\t\t\" members WHERE members.user_id=? and members.status \"+Compatibility.castToInteger()+\"=?\",", "originalCommit": "68e70c107bf3d82b955b9744260c066272a31b6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUyNTgzMg==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411525832", "bodyText": "I didn't want to end up with doubling the select based on DB type, like in getMembersCount(). It is used like that in getGroupMembers() in GroupsManagerImpl. The problem is, that jdbc postgres driver fails to convert passed number for the char(1) column, while oracle driver has no problem. But we could probably clean up all usages to always convert passed Status object to the string.\nAnyway, I'll test it on devel, since I noticed whitespace before that cast and I'm not sure it won't fail the sql.", "author": "zlamalp", "createdAt": "2020-04-20T16:38:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI4NjMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMTEyOA==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411301128", "bodyText": "Wrong indentation.", "author": "stavamichal", "createdAt": "2020-04-20T11:26:46Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_eduPersonScopedAffiliations.java", "diffHunk": "@@ -210,28 +207,133 @@ public Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDe\n \n \t@Override\n \tpublic List<AttributeHandleIdentifier> getHandleIdentifiers() {\n+\n \t\tList<AttributeHandleIdentifier> handleIdentifiers = super.getHandleIdentifiers();\n+\n+\t\t// member related events\n \t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AllAttributesRemovedForUser) {\n-\t\t\t\treturn ((AllAttributesRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (auditEvent instanceof DirectMemberAddedToGroup) {\n+\t\t\t\treturn ((DirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof IndirectMemberAddedToGroup) {\n+\t\t\t\treturn ((IndirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberRemovedFromGroupTotally) {\n+\t\t\t\treturn ((MemberRemovedFromGroupTotally) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpiredInGroup) {\n+\t\t\t\treturn ((MemberExpiredInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidatedInGroup) {\n+\t\t\t\treturn ((MemberValidatedInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidated) {\n+\t\t\t\treturn ((MemberValidated) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpired) {\n+\t\t\t\treturn ((MemberExpired) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberSuspended) {\n+\t\t\t\treturn ((MemberSuspended) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberDisabled) {\n+\t\t\t\treturn ((MemberDisabled) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberInvalidated) {\n+\t\t\t\treturn ((MemberInvalidated) auditEvent).getMember().getUserId();\n \t\t\t}\n+\n+\t\t\t// no match\n+\t\t\treturn null;\n+\n \t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeSetForUser && ((AttributeSetForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeSetForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\treturn handleIdentifiers;\n+\t}\n+\n+\t@Override\n+\tpublic List<AuditEvent> resolveVirtualAttributeValueChange(PerunSessionImpl perunSession, AuditEvent message) throws InternalErrorException, WrongReferenceAttributeValueException, AttributeNotExistsException, WrongAttributeAssignmentException {\n+\n+\t\t// generic handling\n+\t\tList<AuditEvent> resolvingMessages = super.resolveVirtualAttributeValueChange(perunSession, message);\n+\n+\t\t// handle source user attribute changes\n+\n+\t\tif (message instanceof AttributeSetForUser &&\n+\t\t\t\t((AttributeSetForUser) message).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeSetForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AttributeRemovedForUser &&\n+\t\t\t\t((AttributeRemovedForUser) message).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AttributeRemovedForUser) message).getUser()));\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForUser) {\n+\n+\t\t\tboolean skip = false;\n+\t\t\ttry {\n+\t\t\t\tAttributeDefinition sourceExists = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getSecondarySourceAttributeName());\n+\t\t\t\tUser user = perunSession.getPerunBl().getUsersManagerBl().getUserById(perunSession, ((AllAttributesRemovedForUser) message).getUser().getId());\n+\t\t\t} catch (AttributeNotExistsException | UserNotExistsException ex) {\n+\t\t\t\t// silently skip this event, since source attribute couldn't be between deleted\n+\t\t\t\t// or user no longer exist\n+\t\t\t\tskip = true;\n \t\t\t}\n-\t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeRemovedForUser && ((AttributeRemovedForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (!skip) {\n+\t\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), ((AllAttributesRemovedForUser) message).getUser()));\n \t\t\t}\n-\t\t});\n-\t\treturn handleIdentifiers;\n+\n+\t\t}\n+\n+\t\t// handle group attr changes, exclude \"members\" group, since its not counted within attr value\n+\n+\t\tif (message instanceof AttributeSetForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AttributeSetForGroup) message).getGroup().getName()) &&\n+\t\t\t\t((AttributeSetForGroup) message).getAttribute().getName().equals(getTertiarySourceAttributeName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t// TODO - get only active group users, since expired are not affected by current group affiliations\n+\t\t\tList<User> users = perunSession.getPerunBl().getGroupsManagerBl().getGroupUsers(perunSession, ((AttributeSetForGroup) message).getGroup());\n+\t\t\tfor (User user : users) {\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), user));\n+\t\t\t}\n+\n+\t\t} else if (message instanceof AttributeRemovedForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AttributeRemovedForGroup) message).getGroup().getName()) &&\n+\t\t\t\t((AttributeRemovedForGroup) message).getAttribute().getName().equals(getTertiarySourceAttributeName())) {\n+\n+\t\t\tAttributeDefinition attributeDefinition = perunSession.getPerunBl().getAttributesManagerBl().getAttributeDefinition(perunSession, getDestinationAttributeName());\n+\t\t\t// TODO - get only active group users, since expired are not affected by current group affiliations\n+\t\t\tList<User> users = perunSession.getPerunBl().getGroupsManagerBl().getGroupUsers(perunSession, ((AttributeRemovedForGroup) message).getGroup());\n+\t\t\tfor (User user : users) {\n+\t\t\t\tresolvingMessages.add(new AttributeChangedForUser(new Attribute(attributeDefinition), user));\n+\t\t\t}\n+\n+\t\t} else if (message instanceof AllAttributesRemovedForGroup &&\n+\t\t\t\t!VosManager.MEMBERS_GROUP.equals(((AllAttributesRemovedForGroup) message).getGroup().getName())) {", "originalCommit": "68e70c107bf3d82b955b9744260c066272a31b6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU0Njg1Mg==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411546852", "bodyText": "File is auto aligned consistently with two tabs, if its break of expression or method call chain. It seems to be like that in other files too. One tab is reserved for default indent, like class and its content, or method and its content or generally any code block and its content.", "author": "zlamalp", "createdAt": "2020-04-20T17:09:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMTEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNTMzMA==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411915330", "bodyText": "I see it now. Missed that exclamation mark (now i see it is part of if clause).", "author": "stavamichal", "createdAt": "2020-04-21T06:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMTEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMjY2Nw==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411302667", "bodyText": "I am not sure if this will work when you are overriding method resolveVirtualAttributeValueChange.", "author": "stavamichal", "createdAt": "2020-04-20T11:29:23Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/modules/attributes/urn_perun_user_attribute_def_virt_eduPersonScopedAffiliations.java", "diffHunk": "@@ -210,28 +207,133 @@ public Attribute getAttributeValue(PerunSessionImpl sess, User user, AttributeDe\n \n \t@Override\n \tpublic List<AttributeHandleIdentifier> getHandleIdentifiers() {\n+\n \t\tList<AttributeHandleIdentifier> handleIdentifiers = super.getHandleIdentifiers();\n+\n+\t\t// member related events\n \t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AllAttributesRemovedForUser) {\n-\t\t\t\treturn ((AllAttributesRemovedForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\t\tif (auditEvent instanceof DirectMemberAddedToGroup) {\n+\t\t\t\treturn ((DirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof IndirectMemberAddedToGroup) {\n+\t\t\t\treturn ((IndirectMemberAddedToGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberRemovedFromGroupTotally) {\n+\t\t\t\treturn ((MemberRemovedFromGroupTotally) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpiredInGroup) {\n+\t\t\t\treturn ((MemberExpiredInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidatedInGroup) {\n+\t\t\t\treturn ((MemberValidatedInGroup) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberValidated) {\n+\t\t\t\treturn ((MemberValidated) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberExpired) {\n+\t\t\t\treturn ((MemberExpired) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberSuspended) {\n+\t\t\t\treturn ((MemberSuspended) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberDisabled) {\n+\t\t\t\treturn ((MemberDisabled) auditEvent).getMember().getUserId();\n+\t\t\t} else if (auditEvent instanceof MemberInvalidated) {\n+\t\t\t\treturn ((MemberInvalidated) auditEvent).getMember().getUserId();\n \t\t\t}\n+\n+\t\t\t// no match\n+\t\t\treturn null;\n+\n \t\t});\n-\t\thandleIdentifiers.add(auditEvent -> {\n-\t\t\tif (auditEvent instanceof AttributeSetForUser && ((AttributeSetForUser) auditEvent).getAttribute().getFriendlyName().equals(getSecondarySourceAttributeFriendlyName())) {\n-\t\t\t\treturn ((AttributeSetForUser) auditEvent).getUser().getId();\n-\t\t\t} else {\n-\t\t\t\treturn null;\n+\n+\t\treturn handleIdentifiers;\n+\t}", "originalCommit": "68e70c107bf3d82b955b9744260c066272a31b6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUyOTg3OQ==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411529879", "bodyText": "I believe, calling super.resolveVirtualAttributeValueChange() at the start of own implementation of resolveVirtualAttributeValueChange() should still in its logic call getHandleIdentifiers() on actual module/class, since its overridden too. Inside of it it calls super to add generic message handlers, then adds our member messages handlers and everything is processed by super logic of resolveVirtualAttributeValueChange. Then it process group messages and returns resolved messages.", "author": "zlamalp", "createdAt": "2020-04-20T16:44:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMjY2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxNDUyNg==", "url": "https://github.com/CESNET/perun/pull/2671#discussion_r411914526", "bodyText": "My bad, I missed that line.", "author": "stavamichal", "createdAt": "2020-04-21T06:45:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMjY2Nw=="}], "type": "inlineReview"}, {"oid": "f3d26a34bae4cdeb2aaea6c7afb8e97cfde6078e", "url": "https://github.com/CESNET/perun/commit/f3d26a34bae4cdeb2aaea6c7afb8e97cfde6078e", "message": "CORE: Fixed SQL indent in getMembersByUserWithStatus()\n\n- Removed unnecessary whitespace in SQL of getMembersByUserWithStatus();\n- Fixed indent in user:virt:eduPersonScopedAffiliations module.", "committedDate": "2020-04-20T17:05:05Z", "type": "commit"}]}