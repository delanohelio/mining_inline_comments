{"pr_number": 2910, "pr_title": "Registrar - name prefills improvement", "pr_createdAt": "2020-09-24T14:38:15Z", "pr_url": "https://github.com/CESNET/perun/pull/2910", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3ODEzOQ==", "url": "https://github.com/CESNET/perun/pull/2910#discussion_r494378139", "bodyText": "You probably wanted to use fedLastName variable instead of repeating federValues.get(...).", "author": "zlamalp", "createdAt": "2020-09-24T14:44:30Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -2867,18 +2874,40 @@ private Application getApplicationById(int appId) {\n \t\t} else {\n \t\t\tparsedName = new HashMap<>();\n \t\t}\n-\t\t// try to fill if initial parsing failed -> returned null\n-\t\tif (parsedName.get(\"firstName\") == null) {\n-\t\t\tparsedName.put(\"firstName\", federValues.get(shibFirstNameVar));\n-\t\t}\n-\t\tif (parsedName.get(\"lastName\") == null) {\n-\t\t\tparsedName.put(\"lastName\", federValues.get(shibLastNameVar));\n+\t\t// if the idp provided first name or last name, always use it\n+\t\tString fedFirstName = federValues.get(shibFirstNameVar);\n+\t\tString fedLastName = federValues.get(shibLastNameVar);\n+\n+\t\tsetIfNonEmpty(parsedName, fedFirstName, \"firstName\");\n+\t\tsetIfNonEmpty(parsedName, federValues.get(shibLastNameVar), \"lastName\");", "originalCommit": "6024709ba876af3df3e9b2a24427d52019b4764d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2MzM0Nw==", "url": "https://github.com/CESNET/perun/pull/2910#discussion_r498663347", "bodyText": "Yes, I have fixed it.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-02T07:44:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDM3ODEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzMDY2NQ==", "url": "https://github.com/CESNET/perun/pull/2910#discussion_r495530665", "bodyText": "This can fail during the getNamesPattern method if the fedFirstName or the fedLastName is null.", "author": "balcirakpeter", "createdAt": "2020-09-27T05:23:13Z", "path": "perun-registrar-lib/src/main/java/cz/metacentrum/perun/registrar/impl/RegistrarManagerImpl.java", "diffHunk": "@@ -2867,18 +2874,40 @@ private Application getApplicationById(int appId) {\n \t\t} else {\n \t\t\tparsedName = new HashMap<>();\n \t\t}\n-\t\t// try to fill if initial parsing failed -> returned null\n-\t\tif (parsedName.get(\"firstName\") == null) {\n-\t\t\tparsedName.put(\"firstName\", federValues.get(shibFirstNameVar));\n-\t\t}\n-\t\tif (parsedName.get(\"lastName\") == null) {\n-\t\t\tparsedName.put(\"lastName\", federValues.get(shibLastNameVar));\n+\t\t// if the idp provided first name or last name, always use it\n+\t\tString fedFirstName = federValues.get(shibFirstNameVar);\n+\t\tString fedLastName = federValues.get(shibLastNameVar);\n+\n+\t\tsetIfNonEmpty(parsedName, fedFirstName, \"firstName\");\n+\t\tsetIfNonEmpty(parsedName, federValues.get(shibLastNameVar), \"lastName\");\n+\n+\t\t// do new parsing heuristic\n+\t\tCandidate candidate = new Candidate();\n+\t\tif (displayName != null && !displayName.isEmpty()) {\n+\t\t\tparseTitlesAndMiddleName(candidate, displayName, fedFirstName, fedLastName);", "originalCommit": "6024709ba876af3df3e9b2a24427d52019b4764d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2MzYyOQ==", "url": "https://github.com/CESNET/perun/pull/2910#discussion_r498663629", "bodyText": "I have added conditions, so this is not called if any of the names are missing.", "author": "Vojtech-Sassmann", "createdAt": "2020-10-02T07:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTUzMDY2NQ=="}], "type": "inlineReview"}, {"oid": "c8785c4bfe370d7880f24d5465ed02327d0113fb", "url": "https://github.com/CESNET/perun/commit/c8785c4bfe370d7880f24d5465ed02327d0113fb", "message": "Registrar - name prefills improvement\n\n* Improved heuristic for prefilling user names and titles.\n* If the idp send givenName and sn attributes, they are always used as\nuser-firstName and user-lastName attributes.\n* If the idp sends givenName, sn, and displayName attributes, it is also\npossible to parse the middleName from the displayName.\n* These changes have been manually tested.", "committedDate": "2020-10-02T07:43:02Z", "type": "commit"}, {"oid": "c8785c4bfe370d7880f24d5465ed02327d0113fb", "url": "https://github.com/CESNET/perun/commit/c8785c4bfe370d7880f24d5465ed02327d0113fb", "message": "Registrar - name prefills improvement\n\n* Improved heuristic for prefilling user names and titles.\n* If the idp send givenName and sn attributes, they are always used as\nuser-firstName and user-lastName attributes.\n* If the idp sends givenName, sn, and displayName attributes, it is also\npossible to parse the middleName from the displayName.\n* These changes have been manually tested.", "committedDate": "2020-10-02T07:43:02Z", "type": "forcePushed"}]}