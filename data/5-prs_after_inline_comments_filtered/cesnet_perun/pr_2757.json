{"pr_number": 2757, "pr_title": "Optimized assignGroupsToResource", "pr_createdAt": "2020-06-22T07:39:01Z", "pr_url": "https://github.com/CESNET/perun/pull/2757", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3Mzc0Nw==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r444073747", "bodyText": "I don't think that we need to retrieve whole VO just to check its ID. You can use the following to perform whole check:\ngetPerunBl().getAttributesManagerBl().checkGroupIsFromTheSameVoLikeResource(perunSession, g, resource);\nIt will introduce thrown exception GroupResourceMismatchException, but its generally expected behavior in our api.", "author": "zlamalp", "createdAt": "2020-06-23T09:02:38Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ResourcesManagerBlImpl.java", "diffHunk": "@@ -344,50 +346,55 @@ public boolean isGroupAssigned(PerunSession sess, Group group, Resource resource\n \n \t@Override\n \tpublic void assignGroupToResource(PerunSession sess, Group group, Resource resource) throws InternalErrorException, WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException {\n-\t\tVo groupVo = getPerunBl().getGroupsManagerBl().getVo(sess, group);\n+\t\tassignGroupsToResource(sess, Collections.singletonList(group), resource);\n+\t}\n \n-\t\t// Check if the group and resource belongs to the same VO\n-\t\tif (!groupVo.equals(this.getVo(sess, resource))) {\n-\t\t\tthrow new InternalErrorException(\"Group \" + group + \" and resource \" + resource + \" belongs to the different VOs\");\n-\t\t}\n+\t@Override\n+\tpublic void assignGroupsToResource(PerunSession perunSession, List<Group> groups, Resource resource) throws InternalErrorException, WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException {\n+\t\tSet<Member> members = new HashSet<>();\n \n-\t\tif(isGroupAssigned(sess, group, resource)) throw new GroupAlreadyAssignedException(group);\n+\t\tfor(Group g: groups) {\n+\t\t\tVo groupVo = getPerunBl().getGroupsManagerBl().getVo(perunSession, g);", "originalCommit": "6d5a0372ebcd3fabe52488d79e7f1b9fbf2aff43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgxMTExNw==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r444811117", "bodyText": "Okay, it is rewritten as you mentioned.", "author": "metodej", "createdAt": "2020-06-24T10:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3Mzc0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NTIyOQ==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r444075229", "bodyText": "I would probably resolve this once, before iterating over the groups. So either attributes are processed for all groups or none of them.", "author": "zlamalp", "createdAt": "2020-06-23T09:05:10Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ResourcesManagerBlImpl.java", "diffHunk": "@@ -344,50 +346,55 @@ public boolean isGroupAssigned(PerunSession sess, Group group, Resource resource\n \n \t@Override\n \tpublic void assignGroupToResource(PerunSession sess, Group group, Resource resource) throws InternalErrorException, WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException {\n-\t\tVo groupVo = getPerunBl().getGroupsManagerBl().getVo(sess, group);\n+\t\tassignGroupsToResource(sess, Collections.singletonList(group), resource);\n+\t}\n \n-\t\t// Check if the group and resource belongs to the same VO\n-\t\tif (!groupVo.equals(this.getVo(sess, resource))) {\n-\t\t\tthrow new InternalErrorException(\"Group \" + group + \" and resource \" + resource + \" belongs to the different VOs\");\n-\t\t}\n+\t@Override\n+\tpublic void assignGroupsToResource(PerunSession perunSession, List<Group> groups, Resource resource) throws InternalErrorException, WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException {\n+\t\tSet<Member> members = new HashSet<>();\n \n-\t\tif(isGroupAssigned(sess, group, resource)) throw new GroupAlreadyAssignedException(group);\n+\t\tfor(Group g: groups) {\n+\t\t\tVo groupVo = getPerunBl().getGroupsManagerBl().getVo(perunSession, g);\n \n-\t\t//first we must assign group to resource and then set na check attributes, because methods checkAttributesSemantics and fillAttribute need actual state to work correctly\n-\t\tgetResourcesManagerImpl().assignGroupToResource(sess, group, resource);\n-\t\tgetPerunBl().getAuditer().log(sess, new GroupAssignedToResource(group, resource));\n+\t\t\t// Check if the group and resource belongs to the same VO\n+\t\t\tif (!groupVo.equals(this.getVo(perunSession, resource))) {\n+\t\t\t\tthrow new InternalErrorException(\"Group \" + g + \" and resource \" + resource + \" belongs to the different VOs\");\n+\t\t\t}\n \n-\t\t// if there are no assigned services, no attributes have to be checked or filled\n-\t\tif (getAssignedServices(sess, resource).isEmpty()) {\n-\t\t\treturn;\n-\t\t}\n-\t\t// get/fill/set all required group and group-resource attributes\n-\t\ttry {\n-\t\t\tList<Attribute> attributes = getPerunBl().getAttributesManagerBl().getResourceRequiredAttributes(sess, resource, resource, group, true);\n-\t\t\tattributes = getPerunBl().getAttributesManagerBl().fillAttributes(sess, resource, group, attributes, true);\n-\t\t\tgetPerunBl().getAttributesManagerBl().setAttributes(sess, resource, group, attributes, true);\n-\t\t} catch(WrongAttributeAssignmentException | GroupResourceMismatchException ex) {\n-\t\t\tthrow new ConsistencyErrorException(ex);\n+\t\t\tif(isGroupAssigned(perunSession, g, resource)) throw new GroupAlreadyAssignedException(g);\n+\n+\t\t\t//first we must assign group to resource and then set na check attributes, because methods checkAttributesSemantics and fillAttribute need actual state to work correctly\n+\t\t\tgetResourcesManagerImpl().assignGroupToResource(perunSession, g, resource);\n+\t\t\tgetPerunBl().getAuditer().log(perunSession, new GroupAssignedToResource(g, resource));\n+\n+\t\t\t// if there are no assigned services, no attributes have to be checked or filled\n+\t\t\tif (getAssignedServices(perunSession, resource).isEmpty()) {", "originalCommit": "6d5a0372ebcd3fabe52488d79e7f1b9fbf2aff43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDgxMTQ2NQ==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r444811465", "bodyText": "Ok, I moved the check outside the loop.", "author": "metodej", "createdAt": "2020-06-24T10:55:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA3NTIyOQ=="}], "type": "inlineReview"}, {"oid": "3a15195f12253aa4f75c66adabf723a8244acb27", "url": "https://github.com/CESNET/perun/commit/3a15195f12253aa4f75c66adabf723a8244acb27", "message": "Optimized assignGroupsToResource\n\n- assignGroupsToResource now sets required attributes to every member just once even though the groups are not disjoint\n- also added test for this method", "committedDate": "2020-06-24T10:38:28Z", "type": "commit"}, {"oid": "333bf4e797c91c195f34761df8341c5760bcf09f", "url": "https://github.com/CESNET/perun/commit/333bf4e797c91c195f34761df8341c5760bcf09f", "message": "Fixes based on review\n\n- emptiness of service is checked only once\n- checkGroupIsFromTheSameVoLikeResource used to verify that resource and group are from the same vo", "committedDate": "2020-06-24T10:42:44Z", "type": "commit"}, {"oid": "333bf4e797c91c195f34761df8341c5760bcf09f", "url": "https://github.com/CESNET/perun/commit/333bf4e797c91c195f34761df8341c5760bcf09f", "message": "Fixes based on review\n\n- emptiness of service is checked only once\n- checkGroupIsFromTheSameVoLikeResource used to verify that resource and group are from the same vo", "committedDate": "2020-06-24T10:42:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg2ODAxNg==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r444868016", "bodyText": "set na check -> set and check", "author": "zlamalp", "createdAt": "2020-06-24T12:48:28Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ResourcesManagerBlImpl.java", "diffHunk": "@@ -343,55 +345,58 @@ public boolean isGroupAssigned(PerunSession sess, Group group, Resource resource\n \n \n \t@Override\n-\tpublic void assignGroupToResource(PerunSession sess, Group group, Resource resource) throws WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException {\n-\t\tVo groupVo = getPerunBl().getGroupsManagerBl().getVo(sess, group);\n+\tpublic void assignGroupToResource(PerunSession sess, Group group, Resource resource) throws WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException, GroupResourceMismatchException {\n+\t\tassignGroupsToResource(sess, Collections.singletonList(group), resource);\n+\t}\n \n-\t\t// Check if the group and resource belongs to the same VO\n-\t\tif (!groupVo.equals(this.getVo(sess, resource))) {\n-\t\t\tthrow new InternalErrorException(\"Group \" + group + \" and resource \" + resource + \" belongs to the different VOs\");\n+\t@Override\n+\tpublic void assignGroupsToResource(PerunSession perunSession, List<Group> groups, Resource resource) throws WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException, GroupResourceMismatchException {\n+\t\tSet<Member> members = new HashSet<>();\n+\t\tboolean processAttributes = true;\n+\t\t// if there are no assigned services, no attributes have to be checked or filled\n+\t\tif (getAssignedServices(perunSession, resource).isEmpty()) {\n+\t\t\tprocessAttributes = false;\n \t\t}\n \n-\t\tif(isGroupAssigned(sess, group, resource)) throw new GroupAlreadyAssignedException(group);\n-\n-\t\t//first we must assign group to resource and then set na check attributes, because methods checkAttributesSemantics and fillAttribute need actual state to work correctly\n-\t\tgetResourcesManagerImpl().assignGroupToResource(sess, group, resource);\n-\t\tgetPerunBl().getAuditer().log(sess, new GroupAssignedToResource(group, resource));\n+\t\tfor(Group g: groups) {\n+\t\t\tgetPerunBl().getAttributesManagerBl().checkGroupIsFromTheSameVoLikeResource(perunSession, g, resource);\n+\n+\t\t\tif(isGroupAssigned(perunSession, g, resource)) throw new GroupAlreadyAssignedException(g);\n+\n+\t\t\t//first we must assign group to resource and then set na check attributes, because methods checkAttributesSemantics and fillAttribute need actual state to work correctly", "originalCommit": "333bf4e797c91c195f34761df8341c5760bcf09f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg3Mjk0NQ==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r444872945", "bodyText": "Maybe this could be a one-liner like:\n// skip processing of required attributes, if there are no services\nboolean skipAttributes = getAssignedServices(perunSession, resource).isEmpty();\nwith inverted condition. Then you can call continue in the groups cycle to skip processing of those group attributes.\nAlso you should skip processing of attributes for the members by this condition. Now you skip only group and group-resource attributes, but perform fill/set/check for user/member/... attributes, which is not necessary it this case.\nSo you don't event have to retrieve group members in such case and keep members empty in later code. Maybe just add comment with reason, why it might be empty.", "author": "zlamalp", "createdAt": "2020-06-24T12:57:12Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/ResourcesManagerBlImpl.java", "diffHunk": "@@ -343,55 +345,58 @@ public boolean isGroupAssigned(PerunSession sess, Group group, Resource resource\n \n \n \t@Override\n-\tpublic void assignGroupToResource(PerunSession sess, Group group, Resource resource) throws WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException {\n-\t\tVo groupVo = getPerunBl().getGroupsManagerBl().getVo(sess, group);\n+\tpublic void assignGroupToResource(PerunSession sess, Group group, Resource resource) throws WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException, GroupResourceMismatchException {\n+\t\tassignGroupsToResource(sess, Collections.singletonList(group), resource);\n+\t}\n \n-\t\t// Check if the group and resource belongs to the same VO\n-\t\tif (!groupVo.equals(this.getVo(sess, resource))) {\n-\t\t\tthrow new InternalErrorException(\"Group \" + group + \" and resource \" + resource + \" belongs to the different VOs\");\n+\t@Override\n+\tpublic void assignGroupsToResource(PerunSession perunSession, List<Group> groups, Resource resource) throws WrongAttributeValueException, WrongReferenceAttributeValueException, GroupAlreadyAssignedException, GroupResourceMismatchException {\n+\t\tSet<Member> members = new HashSet<>();\n+\t\tboolean processAttributes = true;\n+\t\t// if there are no assigned services, no attributes have to be checked or filled\n+\t\tif (getAssignedServices(perunSession, resource).isEmpty()) {", "originalCommit": "333bf4e797c91c195f34761df8341c5760bcf09f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIxMzgwMg==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r445213802", "bodyText": "I think that since the members.addAll phase was skipped in group cycle, the fill/set/check for user/member attributes was skipped as well, but it was quite messy. I hope it's nicer and clearer now.", "author": "metodej", "createdAt": "2020-06-24T22:50:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg3Mjk0NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTMwMTc3OA==", "url": "https://github.com/CESNET/perun/pull/2757#discussion_r445301778", "bodyText": "Ok, I probably overlooked it in the diff. Thank you. Its clear now.", "author": "zlamalp", "createdAt": "2020-06-25T04:36:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg3Mjk0NQ=="}], "type": "inlineReview"}, {"oid": "1ade4c8539b5c447be67e5bb7e7f16fc803a2ef1", "url": "https://github.com/CESNET/perun/commit/1ade4c8539b5c447be67e5bb7e7f16fc803a2ef1", "message": "Fixes based on review\n\n- skipped user/member fill/set/check if there is no service", "committedDate": "2020-06-24T22:37:20Z", "type": "commit"}]}