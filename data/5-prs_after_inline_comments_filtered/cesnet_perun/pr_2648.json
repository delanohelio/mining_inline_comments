{"pr_number": 2648, "pr_title": "Fix wrong exception when updating group with existing name", "pr_createdAt": "2020-03-30T13:11:17Z", "pr_url": "https://github.com/CESNET/perun/pull/2648", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3OTUzMA==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400679530", "bodyText": "We can check this using SQL constraint itself in impl/dao layer, since we update name and description separately. We can catch DataIntegrityViolationException when updating name and then throw GroupExistsException rather than current InternalErrorException. See example in FacilitiesManagerImpl method updateFacility().", "author": "zlamalp", "createdAt": "2020-03-31T06:49:54Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/entry/GroupsManagerEntry.java", "diffHunk": "@@ -200,7 +200,7 @@ public void deleteGroups(PerunSession perunSession, List<Group> groups, boolean\n \t}\n \n \t@Override\n-\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, InternalErrorException, PrivilegeException {\n+\tpublic Group updateGroup(PerunSession sess, Group group) throws GroupNotExistsException, GroupExistsException, InternalErrorException, PrivilegeException {", "originalCommit": "17d92fdc5226cbed1242f29c91f91ecd63d54200", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMTczMw==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400731733", "bodyText": "Yes, you are right. I changed that logic to be same as for Facility.", "author": "stavamichal", "createdAt": "2020-03-31T08:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3OTUzMA=="}], "type": "inlineReview"}, {"oid": "fe893d467d0654cf9999e6fa6a35be1763fd53e7", "url": "https://github.com/CESNET/perun/commit/fe893d467d0654cf9999e6fa6a35be1763fd53e7", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception", "committedDate": "2020-03-31T08:24:41Z", "type": "forcePushed"}, {"oid": "1de1e1a33d2868df720efab3a347a8201112be79", "url": "https://github.com/CESNET/perun/commit/1de1e1a33d2868df720efab3a347a8201112be79", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception", "committedDate": "2020-03-31T08:26:07Z", "type": "forcePushed"}, {"oid": "3086980616fc552c3eebda89dea4039921486f07", "url": "https://github.com/CESNET/perun/commit/3086980616fc552c3eebda89dea4039921486f07", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception", "committedDate": "2020-03-31T08:27:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400740500", "bodyText": "Maybe we should include used name in the exception text.", "author": "zlamalp", "createdAt": "2020-03-31T08:41:47Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -212,6 +214,8 @@ public Group updateGroup(PerunSession sess, Group group) throws InternalErrorExc\n \t\t\ttry {\n \t\t\t\tjdbc.update(\"update groups set name=?,modified_by=?, modified_by_uid=?, modified_at=\" + Compatibility.getSysdate() + \" where id=?\", dbGroup.getName(),\n \t\t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), dbGroup.getId());\n+\t\t\t} catch (DataIntegrityViolationException e) {\n+\t\t\t\tthrow new GroupExistsException(\"The name must be unique and it's already occupied.\", e);", "originalCommit": "3086980616fc552c3eebda89dea4039921486f07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0Mzc3Mw==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400743773", "bodyText": "I don't really think we need to know that. And it is exactly the same copy of the logic like in facilityManager.", "author": "stavamichal", "createdAt": "2020-03-31T08:47:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3NjgxMQ==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400776811", "bodyText": "Do you insist? Of course I can add it, but I don't think it is important except the situation when database constraint works improperly.", "author": "stavamichal", "createdAt": "2020-03-31T09:40:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg2MDU4NQ==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400860585", "bodyText": "Not really, but since its in DAO layer, it might fail also some inner logic (move group?, group structure sync?). I'm not sure. Right now it won't be possible to know, which group caused the problem, unless it is logged anywhere else, since even passed SQL exception doesn't contain input data.", "author": "zlamalp", "createdAt": "2020-03-31T12:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDg5Mjk3Nw==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400892977", "bodyText": "Ok - added.", "author": "stavamichal", "createdAt": "2020-03-31T13:00:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc0MDUwMA=="}], "type": "inlineReview"}, {"oid": "2c2879d205d581556ff94e441e022fe2c99b5280", "url": "https://github.com/CESNET/perun/commit/2c2879d205d581556ff94e441e022fe2c99b5280", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception", "committedDate": "2020-03-31T12:59:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDkwMjIwNQ==", "url": "https://github.com/CESNET/perun/pull/2648#discussion_r400902205", "bodyText": "Unused import.", "author": "balcirakpeter", "createdAt": "2020-03-31T13:13:35Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -18,6 +18,7 @@\n import cz.metacentrum.perun.core.api.Vo;\n import cz.metacentrum.perun.core.api.exceptions.AlreadyMemberException;\n import cz.metacentrum.perun.core.api.exceptions.ConsistencyErrorException;\n+import cz.metacentrum.perun.core.api.exceptions.FacilityExistsException;", "originalCommit": "2c2879d205d581556ff94e441e022fe2c99b5280", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8d617a8dac497a738048c5f097dc99d793b5b74", "url": "https://github.com/CESNET/perun/commit/f8d617a8dac497a738048c5f097dc99d793b5b74", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception", "committedDate": "2020-03-31T13:51:53Z", "type": "commit"}, {"oid": "f8d617a8dac497a738048c5f097dc99d793b5b74", "url": "https://github.com/CESNET/perun/commit/f8d617a8dac497a738048c5f097dc99d793b5b74", "message": "Fix wrong exception when updating group with existing name\n\n - when we are trying to update a group's name with name which is\n already occupied in the same VO, we need to throw GroupExistsException\n instead of SQL constraint exception", "committedDate": "2020-03-31T13:51:53Z", "type": "forcePushed"}]}