{"pr_number": 2890, "pr_title": "Core - UUID", "pr_createdAt": "2020-09-09T10:38:44Z", "pr_url": "https://github.com/CESNET/perun/pull/2890", "timeline": [{"oid": "ff871ed9473020b2e5199b0d04ebf029e44629c0", "url": "https://github.com/CESNET/perun/commit/ff871ed9473020b2e5199b0d04ebf029e44629c0", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-15T08:19:02Z", "type": "forcePushed"}, {"oid": "80aa5b2d6b614b8bcdc46b2b630fc4efd0ee5397", "url": "https://github.com/CESNET/perun/commit/80aa5b2d6b614b8bcdc46b2b630fc4efd0ee5397", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-15T08:33:05Z", "type": "forcePushed"}, {"oid": "ccf2b683a064f8d3843dee606c50a55cdc72da40", "url": "https://github.com/CESNET/perun/commit/ccf2b683a064f8d3843dee606c50a55cdc72da40", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-15T09:04:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxODk0Mg==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489318942", "bodyText": "I don't really think this is necessary.  You get the whole new group correctly set with all expected attributes.", "author": "stavamichal", "createdAt": "2020-09-16T10:03:30Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/GroupsManagerImpl.java", "diffHunk": "@@ -129,21 +131,28 @@ public Group createGroup(PerunSession sess, Vo vo, Group group) throws GroupExis\n \t\t\tthrow new InternalErrorException(e);\n \t\t}\n \n+\t\tint newId;\n \t\ttry {\n \t\t\t// Store the group into the DB\n-\t\t\tint newId = Utils.getNewId(jdbc, \"groups_id_seq\");\n+\t\t\tnewId = Utils.getNewId(jdbc, \"groups_id_seq\");\n \n \t\t\tjdbc.update(\"insert into groups (id, parent_group_id, name, dsc, vo_id, created_by,created_at,modified_by,modified_at,created_by_uid,modified_by_uid) \" +\n \t\t\t\t\t\"values (?,?,?,?,?,?,\" + Compatibility.getSysdate() + \",?,\" + Compatibility.getSysdate() + \",?,?)\", newId, group.getParentGroupId(),\n \t\t\t\t\tgroup.getName(), group.getDescription(), vo.getId(), sess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), sess.getPerunPrincipal().getUserId());\n-\t\t\tgroup.setId(newId);\n-\n-\t\t\tgroup.setVoId(vo.getId());\n-\n-\t\t\treturn group;\n \t\t} catch (RuntimeException err) {\n \t\t\tthrow new InternalErrorException(err);\n \t\t}\n+\t\tGroup newGroup;\n+\t\ttry {\n+\t\t\tnewGroup = getGroupById(sess, newId);\n+\t\t} catch (GroupNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to read newly created group with id: \" + newId, e);\n+\t\t}\n+\t\tgroup.setId(newId);\n+\t\tgroup.setUuid(newGroup.getUuid());\n+\t\tgroup.setVoId(newGroup.getVoId());", "originalCommit": "ccf2b683a064f8d3843dee606c50a55cdc72da40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMyMTU3Mw==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489321573", "bodyText": "Actually, it is. Because a lot of code expects the given object to be modified. Without it, a lot of code would have to be rewritten.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-16T10:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxODk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMyNDEyNQ==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489324125", "bodyText": "Ok so please just comment it.", "author": "stavamichal", "createdAt": "2020-09-16T10:12:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxODk0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDE2MjYwNA==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r490162604", "bodyText": "Regarding this, don't we want to then return group object instead of the newGroup ?\nAnd just a note, it would be so nice to use Postgres INSERT .... RETURNING query, but its not supported by HSQLDB which we use for the tests.", "author": "zlamalp", "createdAt": "2020-09-17T11:16:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxODk0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxOTU4MA==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489319580", "bodyText": "Same as for Group.", "author": "stavamichal", "createdAt": "2020-09-16T10:04:37Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/ResourcesManagerImpl.java", "diffHunk": "@@ -222,22 +224,28 @@ public Resource getResourceByName(PerunSession sess, Vo vo, Facility facility, S\n \tpublic Resource createResource(PerunSession sess, Vo vo, Resource resource, Facility facility) {\n \t\tUtils.notNull(resource.getName(), \"resource.getName()\");\n \n+\t\tint newId;\n \t\ttry {\n-\t\t\tint newId = Utils.getNewId(jdbc, \"resources_id_seq\");\n+\t\t\tnewId = Utils.getNewId(jdbc, \"resources_id_seq\");\n \n \t\t\tjdbc.update(\"insert into resources(id, name, dsc, facility_id, vo_id, created_by, created_at,modified_by,modified_at,created_by_uid,modified_by_uid) \" +\n \t\t\t\t\t\"values (?,?,?,?,?,?,\" + Compatibility.getSysdate() + \",?,\" + Compatibility.getSysdate() + \",?,?)\",\n \t\t\t\t\tnewId, resource.getName(), resource.getDescription(), facility.getId(), vo.getId(), sess.getPerunPrincipal().getActor(),\n \t\t\t\t\tsess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getUserId(), sess.getPerunPrincipal().getUserId());\n-\n-\t\t\tresource.setId(newId);\n-\t\t\tresource.setFacilityId(facility.getId());\n-\t\t\tresource.setVoId(vo.getId());\n-\n-\t\t\treturn resource;\n \t\t} catch(RuntimeException ex) {\n \t\t\tthrow new InternalErrorException(ex);\n \t\t}\n+\t\tResource newResource;\n+\t\ttry {\n+\t\t\tnewResource = getResourceById(sess, newId);\n+\t\t} catch (ResourceNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to read newly created resource with id: \" + newId, e);\n+\t\t}\n+\t\tresource.setId(newId);\n+\t\tresource.setVoId(newResource.getVoId());\n+\t\tresource.setFacilityId(newResource.getFacilityId());\n+\t\tresource.setUuid(newResource.getUuid());", "originalCommit": "ccf2b683a064f8d3843dee606c50a55cdc72da40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxOTkwNg==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489319906", "bodyText": "Same as for Group.", "author": "stavamichal", "createdAt": "2020-09-16T10:05:11Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/UsersManagerImpl.java", "diffHunk": "@@ -367,18 +368,25 @@ public void deleteUser(PerunSession sess, User user) throws UserAlreadyRemovedEx\n \n \t@Override\n \tpublic User createUser(PerunSession sess, User user) {\n+\t\tint newId;\n \t\ttry {\n-\t\t\tint newId = Utils.getNewId(jdbc, \"users_id_seq\");\n+\t\t\tnewId = Utils.getNewId(jdbc, \"users_id_seq\");\n \t\t\tjdbc.update(\"insert into users(id,first_name,last_name,middle_name,title_before,title_after,created_by,modified_by,service_acc,sponsored_acc,created_by_uid,modified_by_uid)\" +\n \t\t\t\t\t\" values (?,?,?,?,?,?,?,?,?,?,?,?)\", newId, user.getFirstName(), user.getLastName(), user.getMiddleName(),\n \t\t\t\t\tuser.getTitleBefore(), user.getTitleAfter(), sess.getPerunPrincipal().getActor(), sess.getPerunPrincipal().getActor(), user.isServiceUser(), user.isSponsoredUser(),\n \t\t\t\t\tsess.getPerunPrincipal().getUserId(), sess.getPerunPrincipal().getUserId());\n-\t\t\tuser.setId(newId);\n-\n-\t\t\treturn user;\n \t\t} catch (RuntimeException err) {\n \t\t\tthrow new InternalErrorException(err);\n \t\t}\n+\t\tUser newUser;\n+\t\ttry {\n+\t\t\tnewUser = getUserById(sess, newId);\n+\t\t} catch (UserNotExistsException e) {\n+\t\t\tthrow new InternalErrorException(\"Failed to read newly created user with id: \" + newId, e);\n+\t\t}\n+\t\tuser.setId(newId);\n+\t\tuser.setUuid(newUser.getUuid());\n+\t\treturn newUser;", "originalCommit": "ccf2b683a064f8d3843dee606c50a55cdc72da40", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c5df17c5a5f5b49f54a7550dc2385f95ad09911", "url": "https://github.com/CESNET/perun/commit/6c5df17c5a5f5b49f54a7550dc2385f95ad09911", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-16T10:48:34Z", "type": "forcePushed"}, {"oid": "6e673d200a0868f0e2aa59e3aa81c96379745789", "url": "https://github.com/CESNET/perun/commit/6e673d200a0868f0e2aa59e3aa81c96379745789", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-16T10:58:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5NTczMg==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489395732", "bodyText": "There is missing the change for RichGroup.", "author": "stavamichal", "createdAt": "2020-09-16T12:25:59Z", "path": "perun-auditparser/src/main/java/cz/metacentrum/perun/auditparser/AuditParser.java", "diffHunk": "@@ -716,6 +729,10 @@ private static RichResource createRichResource(Map<String, String> beanAttr) {\n \t\tif(beanAttr==null) return null;\n \t\tRichResource richResource = new RichResource();\n \t\trichResource.setId(Integer.valueOf(beanAttr.get(\"id\")));\n+\t\tString uuidString = beanAttr.get(\"uuid\");\n+\t\tif (uuidString != null && !\"null\".equals(uuidString)) {\n+\t\t\trichResource.setUuid(UUID.fromString(uuidString));\n+\t\t}", "originalCommit": "6e673d200a0868f0e2aa59e3aa81c96379745789", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMDA0Mw==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489400043", "bodyText": "It is not needed in rich group because it is reusing the method for creating a group where it is present.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-16T12:33:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5NTczMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMjQ0MQ==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489402441", "bodyText": "My bad :)", "author": "stavamichal", "createdAt": "2020-09-16T12:37:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5NTczMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5NzQwNA==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489397404", "bodyText": "Setting of UUID is missing in constructor.", "author": "stavamichal", "createdAt": "2020-09-16T12:28:44Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/RichResource.java", "diffHunk": "@@ -130,6 +131,7 @@ public String toString() {\n \n \t\treturn str.append(getClass().getSimpleName()).append(\":[\"\n \t\t\t).append(\"id='\").append(getId()\n+\t\t\t).append(\"', uuid='\").append(getUuid()", "originalCommit": "6e673d200a0868f0e2aa59e3aa81c96379745789", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMDg3Mg==", "url": "https://github.com/CESNET/perun/pull/2890#discussion_r489400872", "bodyText": "Fixed.", "author": "Vojtech-Sassmann", "createdAt": "2020-09-16T12:34:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM5NzQwNA=="}], "type": "inlineReview"}, {"oid": "e7cd94d1a5b85c49c9393f0fd1adc23fe5dde8ba", "url": "https://github.com/CESNET/perun/commit/e7cd94d1a5b85c49c9393f0fd1adc23fe5dde8ba", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-16T12:34:06Z", "type": "forcePushed"}, {"oid": "e72964e00960c69416b39db33c675d6f1e439a8a", "url": "https://github.com/CESNET/perun/commit/e72964e00960c69416b39db33c675d6f1e439a8a", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-18T07:19:28Z", "type": "commit"}, {"oid": "e72964e00960c69416b39db33c675d6f1e439a8a", "url": "https://github.com/CESNET/perun/commit/e72964e00960c69416b39db33c675d6f1e439a8a", "message": "Core - UUID\n\n* DEPLOYMENT:\n  * New DB version\n  * Need to enable postgres plugin with command `CREATE EXTENSION IF NOT\nEXISTS \"pgcrypto\";`\n* Added UUID to Group, User and Resource entities.\n* The UUID is of version 4 and is generated by the DB.", "committedDate": "2020-09-18T07:19:28Z", "type": "forcePushed"}]}