{"pr_number": 3015, "pr_title": "New methods getObjectWhereUserIsInRoles", "pr_createdAt": "2020-12-01T08:14:39Z", "pr_url": "https://github.com/CESNET/perun/pull/3015", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2NzExNQ==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r533367115", "bodyText": "There is no info in the commit message that you also fixed a bug (typo) there.", "author": "stavamichal", "createdAt": "2020-12-01T12:20:32Z", "path": "perun-base/src/main/java/cz/metacentrum/perun/core/api/Role.java", "diffHunk": "@@ -10,7 +10,7 @@\n \tpublic static final String PERUNOBSERVER = \"PERUNOBSERVER\";\n \tpublic static final String VOADMIN = \"VOADMIN\";\n \tpublic static final String GROUPADMIN = \"GROUPADMIN\";\n-\tpublic static final String GROUPOBSERVER = \"GROUPOBSERER\";\n+\tpublic static final String GROUPOBSERVER = \"GROUPOBSERVER\";", "originalCommit": "17e3d668fc56a07c51f2e0c908fbee8174675869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzMzY2NQ==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534033665", "bodyText": "Added.", "author": "balcirakpeter", "createdAt": "2020-12-02T09:52:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM2NzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MzgzMQ==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r533383831", "bodyText": "You should use \"Set\" here to prevent duplicates in the result.", "author": "stavamichal", "createdAt": "2020-12-01T12:50:43Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AuthzResolverBlImpl.java", "diffHunk": "@@ -1843,6 +1843,134 @@ public static PerunBl setPerunBl(PerunBl perunBl) {\n \t\treturn perunBl;\n \t}\n \n+\t/**\n+\t * Get all Vos where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Vos are retrieved\n+\t * @param roles for which Vos are retrieved\n+\t * @return List of Vos\n+\t */\n+\tpublic static List<Vo> getVosWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn authzResolverImpl.getVosWhereUserIsInRoles(user, roles);\n+\t}\n+\n+\t/**\n+\t * Get all Facilities where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Facilities are retrieved\n+\t * @param roles for which Facilities are retrieved\n+\t * @return List of Facilities\n+\t */\n+\tpublic static List<Facility> getFacilitiesWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn authzResolverImpl.getFacilitiesWhereUserIsInRoles(user, roles);\n+\t}\n+\n+\t/**\n+\t * Get all Resources where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Resources are retrieved\n+\t * @param roles for which Resources are retrieved\n+\t * @return List of Resources\n+\t */\n+\tpublic static List<Resource> getResourcesWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn authzResolverImpl.getResourcesWhereUserIsInRoles(user, roles);\n+\t}\n+\n+\t/**\n+\t * Get all Groups where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Groups are retrieved\n+\t * @param roles for which Groups are retrieved\n+\t * @return List of Groups\n+\t */\n+\tpublic static List<Group> getGroupsWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\tSet<Group> result = new HashSet<>();\n+\t\tList<Group> parentGroups = authzResolverImpl.getGroupsWhereUserIsInRoles(user, roles);\n+\n+\t\tfor (Group parentGroup: parentGroups) {\n+\t\t\tresult.add(parentGroup);\n+\t\t\tresult.addAll(perunBl.getGroupsManagerBl().getAllSubGroups(sess, parentGroup));\n+\t\t}\n+\n+\t\treturn new ArrayList<>(result);", "originalCommit": "17e3d668fc56a07c51f2e0c908fbee8174675869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNTMyMw==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534035323", "bodyText": "I have removed the subgroups fetching so this is not relevant anymore. However, the result variable was the \"Set\" type. That's why I've converted it to ArrayList at the end of the method.", "author": "balcirakpeter", "createdAt": "2020-12-02T09:54:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MzgzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ1NzAwMg==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r533457002", "bodyText": "Typo in the name of the method.", "author": "stavamichal", "createdAt": "2020-12-01T14:39:47Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AuthzResolverImpl.java", "diffHunk": "@@ -902,6 +917,120 @@ public void unsetRole(PerunSession sess, Map<String, Integer> mappingOfValues, S\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Vo> getVosWhereUserIsInRoles(User user, List<String> roles) {\n+\t\tMapSqlParameterSource parameters = prepareParametersToGetObjectsByuserRoles(user, roles);\n+\n+\t\ttry {\n+\t\t\treturn namedParameterJdbcTemplate.query(\"select \" + voMappingSelectQuery + \" from authz join vos on authz.vo_id=vos.id \" +\n+\t\t\t\t\t\" left outer join groups_members on groups_members.group_id=authz.authorized_group_id \" +\n+\t\t\t\t\t\" left outer join members on members.id=groups_members.member_id \" +\n+\t\t\t\t\t\" where (authz.user_id=:uid or members.user_id=:uid) and authz.role_id in \" +\n+\t\t\t\t\t\"(select id from roles where name in (:roles))\",\n+\t\t\t\t\tparameters, VO_MAPPER);\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<Facility> getFacilitiesWhereUserIsInRoles(User user, List<String> roles) {\n+\t\tMapSqlParameterSource parameters = prepareParametersToGetObjectsByuserRoles(user, roles);\n+\n+\t\ttry {\n+\t\t\treturn namedParameterJdbcTemplate.query(\"select \" + facilityMappingSelectQuery + \" from authz join facilities on authz.facility_id=facilities.id \" +\n+\t\t\t\t\t\" left outer join groups_members on groups_members.group_id=authz.authorized_group_id \" +\n+\t\t\t\t\t\" left outer join members on members.id=groups_members.member_id \" +\n+\t\t\t\t\t\" where (authz.user_id=:uid or members.user_id=:uid) and authz.role_id in \" +\n+\t\t\t\t\t\"(select id from roles where name in (:roles))\",\n+\t\t\t\tparameters, FACILITY_MAPPER);\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<Resource> getResourcesWhereUserIsInRoles(User user, List<String> roles) {\n+\t\tMapSqlParameterSource parameters = prepareParametersToGetObjectsByuserRoles(user, roles);\n+\n+\t\ttry {\n+\t\t\treturn namedParameterJdbcTemplate.query(\"select \" + resourceMappingSelectQuery + \" from authz join resources on authz.resource_id=resources.id \" +\n+\t\t\t\t\t\" left outer join groups_members on groups_members.group_id=authz.authorized_group_id \" +\n+\t\t\t\t\t\" left outer join members on members.id=groups_members.member_id \" +\n+\t\t\t\t\t\" where (authz.user_id=:uid or members.user_id=:uid) and authz.role_id in \" +\n+\t\t\t\t\t\"(select id from roles where name in (:roles))\",\n+\t\t\t\tparameters, RESOURCE_MAPPER);\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<Group> getGroupsWhereUserIsInRoles(User user, List<String> roles) {\n+\t\tMapSqlParameterSource parameters = prepareParametersToGetObjectsByuserRoles(user, roles);\n+\n+\t\ttry {\n+\t\t\treturn namedParameterJdbcTemplate.query(\"select \" + groupMappingSelectQuery + \" from authz join groups on authz.group_id=groups.id \" +\n+\t\t\t\t\t\" left outer join groups_members on groups_members.group_id=authz.authorized_group_id \" +\n+\t\t\t\t\t\" left outer join members on members.id=groups_members.member_id \" +\n+\t\t\t\t\t\" where (authz.user_id=:uid or members.user_id=:uid) and authz.role_id in \" +\n+\t\t\t\t\t\"(select id from roles where name in (:roles))\",\n+\t\t\t\tparameters, GROUP_MAPPER);\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<Member> getMembersWhereUserIsInRoles(User user, List<String> roles) {\n+\t\tMapSqlParameterSource parameters = prepareParametersToGetObjectsByuserRoles(user, roles);\n+\n+\t\ttry {\n+\t\t\treturn namedParameterJdbcTemplate.query(\"select \" + memberMappingSelectQuery + \" from authz join members on authz.member_id=members.id \" +\n+\t\t\t\t\t\" left outer join groups_members on groups_members.group_id=authz.authorized_group_id \" +\n+\t\t\t\t\t\" left outer join members on members.id=groups_members.member_id \" +\n+\t\t\t\t\t\" where (authz.user_id=:uid or members.user_id=:uid) and authz.role_id in \" +\n+\t\t\t\t\t\"(select id from roles where name in (:roles))\",\n+\t\t\t\tparameters, MEMBER_MAPPER);\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t@Override\n+\tpublic List<SecurityTeam> getSecurityTeamsWhereUserIsInRoles(User user, List<String> roles) {\n+\t\tMapSqlParameterSource parameters = prepareParametersToGetObjectsByuserRoles(user, roles);\n+\n+\t\ttry {\n+\t\t\treturn namedParameterJdbcTemplate.query(\"select \" + securityTeamMappingSelectQuery + \" from authz join security_teams on authz.security_team_id=security_teams.id \" +\n+\t\t\t\t\t\" left outer join groups_members on groups_members.group_id=authz.authorized_group_id \" +\n+\t\t\t\t\t\" left outer join members on members.id=groups_members.member_id \" +\n+\t\t\t\t\t\" where (authz.user_id=:uid or members.user_id=:uid) and authz.role_id in \" +\n+\t\t\t\t\t\"(select id from roles where name in (:roles))\",\n+\t\t\t\tparameters, SECURITY_TEAM_MAPPER);\n+\t\t} catch (RuntimeException ex) {\n+\t\t\tthrow new InternalErrorException(ex);\n+\t\t}\n+\t}\n+\n+\t/**\n+\t * Create parameters for obtaining objects according to user and list of roles.\n+\t *\n+\t * @param user for who will be fetched id\n+\t * @param roles which will be lower cased\n+\t * @return user and roles parameters\n+\t */\n+\tprivate MapSqlParameterSource prepareParametersToGetObjectsByuserRoles(User user, List<String> roles) {", "originalCommit": "17e3d668fc56a07c51f2e0c908fbee8174675869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNTM2Nw==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534035367", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-12-02T09:54:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ1NzAwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2OTQ1Mw==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r533469453", "bodyText": "You should prevent duplicates in the list (use set or something like that). Should be used for all these methods.", "author": "stavamichal", "createdAt": "2020-12-01T14:49:02Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/impl/AuthzResolverImpl.java", "diffHunk": "@@ -902,6 +917,120 @@ public void unsetRole(PerunSession sess, Map<String, Integer> mappingOfValues, S\n \t\t}\n \t}\n \n+\t@Override\n+\tpublic List<Vo> getVosWhereUserIsInRoles(User user, List<String> roles) {\n+\t\tMapSqlParameterSource parameters = prepareParametersToGetObjectsByuserRoles(user, roles);\n+\n+\t\ttry {\n+\t\t\treturn namedParameterJdbcTemplate.query(\"select \" + voMappingSelectQuery + \" from authz join vos on authz.vo_id=vos.id \" +", "originalCommit": "17e3d668fc56a07c51f2e0c908fbee8174675869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNTc1OA==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534035758", "bodyText": "All Impl methods return Set of objects now. It is converted to ArrayList in the Bl layer.", "author": "balcirakpeter", "createdAt": "2020-12-02T09:55:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ2OTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ3MzQyMQ==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r533473421", "bodyText": "There is missing information about the type of parameter (List for example here). The same problem is in the other Javadoc here.", "author": "stavamichal", "createdAt": "2020-12-01T14:53:39Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -782,5 +785,269 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\tcz.metacentrum.perun.core.api.AuthzResolver.loadAuthorizationComponents(ac.getSession());\n \t\t\treturn null;\n \t\t}\n+\t},\n+\n+\t/*#\n+\t * Get all Vos where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param user for who Vos are retrieved\n+\t * @param roles for which Vos are retrieved\n+\t * @return List of Vos\n+\t *\n+\t * @throws PrivilegeException when the principal is not authorized.\n+\t */\n+\t/*#\n+\t * Get all Vos where the given principal has set one of the given roles\n+\t * or the given principal is a member of an authorized group with such roles.\n+\t *\n+\t * @param roles for which Vos are retrieved", "originalCommit": "17e3d668fc56a07c51f2e0c908fbee8174675869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNTg3MA==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534035870", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-12-02T09:55:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzQ3MzQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMTQ5OQ==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534001499", "bodyText": "I am not really sure if we want this behavior. It might be a bit confusing. Image a rich tree group structure and some user who has been given a GROUPADMIN of the root group. In GUI, he will be shown, that he is an admin of something like 1000 groups and he will not be able to distinguish between the root group and subgroups.", "author": "Vojtech-Sassmann", "createdAt": "2020-12-02T09:06:06Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/blImpl/AuthzResolverBlImpl.java", "diffHunk": "@@ -1843,6 +1843,134 @@ public static PerunBl setPerunBl(PerunBl perunBl) {\n \t\treturn perunBl;\n \t}\n \n+\t/**\n+\t * Get all Vos where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Vos are retrieved\n+\t * @param roles for which Vos are retrieved\n+\t * @return List of Vos\n+\t */\n+\tpublic static List<Vo> getVosWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn authzResolverImpl.getVosWhereUserIsInRoles(user, roles);\n+\t}\n+\n+\t/**\n+\t * Get all Facilities where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Facilities are retrieved\n+\t * @param roles for which Facilities are retrieved\n+\t * @return List of Facilities\n+\t */\n+\tpublic static List<Facility> getFacilitiesWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn authzResolverImpl.getFacilitiesWhereUserIsInRoles(user, roles);\n+\t}\n+\n+\t/**\n+\t * Get all Resources where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Resources are retrieved\n+\t * @param roles for which Resources are retrieved\n+\t * @return List of Resources\n+\t */\n+\tpublic static List<Resource> getResourcesWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn authzResolverImpl.getResourcesWhereUserIsInRoles(user, roles);\n+\t}\n+\n+\t/**\n+\t * Get all Groups where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param sess Perun session\n+\t * @param user for who Groups are retrieved\n+\t * @param roles for which Groups are retrieved\n+\t * @return List of Groups\n+\t */\n+\tpublic static List<Group> getGroupsWhereUserIsInRoles(PerunSession sess, User user, List<String> roles) {\n+\t\tfor (String role: roles) {\n+\t\t\tif (!roleExists(role)) {\n+\t\t\t\tthrow new InternalErrorException(\"Role: \"+ role +\" does not exists.\");\n+\t\t\t}\n+\t\t}\n+\n+\t\tSet<Group> result = new HashSet<>();\n+\t\tList<Group> parentGroups = authzResolverImpl.getGroupsWhereUserIsInRoles(user, roles);\n+\n+\t\tfor (Group parentGroup: parentGroups) {\n+\t\t\tresult.add(parentGroup);\n+\t\t\tresult.addAll(perunBl.getGroupsManagerBl().getAllSubGroups(sess, parentGroup));", "originalCommit": "17e3d668fc56a07c51f2e0c908fbee8174675869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNjAwMw==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534036003", "bodyText": "You are right. Removed.", "author": "balcirakpeter", "createdAt": "2020-12-02T09:55:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwMTQ5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwOTQ2Mg==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534009462", "bodyText": "Nit: For assertions like this, it is good to use the Assertj library. You don't even need to check the size explicitly with such assertion.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tassertTrue(result.containsAll(Arrays.asList(testVo, testVo3)));\n          \n          \n            \n            \t\tassertThat(result).containsOnly(testVo, testVo3);", "author": "Vojtech-Sassmann", "createdAt": "2020-12-02T09:17:51Z", "path": "perun-core/src/test/java/cz/metacentrum/perun/core/api/AuthzResolverIntegrationTest.java", "diffHunk": "@@ -1080,6 +1080,248 @@ public void getVoRichAdminsWithWrongObjects() throws Exception {\n \t\tAuthzResolver.getRichAdmins(sess, testUser, new ArrayList<>(), Role.VOADMIN, false, true);\n \t}\n \n+\t@Test\n+\tpublic void getVosWhereUserIsInRoles() throws Exception {\n+\t\tSystem.out.println(CLASS_NAME + \"getVosWhereUserIsInRoles\");\n+\n+\t\tfinal Vo testVo = perun.getVosManager().createVo(sess, new Vo(0,\"testvo1\",\"testvo1\"));\n+\t\tfinal Vo testVo2 = perun.getVosManager().createVo(sess, new Vo(1,\"testvo2\",\"testvo2\"));\n+\t\tfinal Vo testVo3 = perun.getVosManager().createVo(sess, new Vo(2,\"testvo3\",\"testvo3\"));\n+\t\tfinal Group testGroup = perun.getGroupsManager().createGroup(sess, testVo, new Group(\"testGroup\", \"testg\"));\n+\t\tfinal Member testMember = createSomeMember(testVo);\n+\t\tfinal User testUser = perun.getUsersManagerBl().getUserByMember(sess, testMember);\n+\t\tperun.getGroupsManager().addMember(sess, testGroup, testMember);\n+\n+\t\tAuthzResolver.setRole(sess, testUser, testVo, Role.VOADMIN);\n+\t\tAuthzResolver.setRole(sess, testUser, testVo2, Role.SPONSOR);\n+\t\tAuthzResolver.setRole(sess, testGroup, testVo3, Role.VOOBSERVER);\n+\t\tList<Vo> result = AuthzResolver.getVosWhereUserIsInRoles(sess, testUser, Arrays.asList(Role.VOADMIN, Role.VOOBSERVER));\n+\n+\t\tassertEquals(2, result.size());\n+\t\tassertTrue(result.containsAll(Arrays.asList(testVo, testVo3)));", "originalCommit": "17e3d668fc56a07c51f2e0c908fbee8174675869", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNjI0NA==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534036244", "bodyText": "Thanks. I will use it next time but I will not change it in this PR.", "author": "balcirakpeter", "createdAt": "2020-12-02T09:56:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAwOTQ2Mg=="}], "type": "inlineReview"}, {"oid": "50f108cd7726e1aaaf34f2c42cc529f7ae44a833", "url": "https://github.com/CESNET/perun/commit/50f108cd7726e1aaaf34f2c42cc529f7ae44a833", "message": "New methods getObjectWhereUserIsInRoles\n\n- These methods were implemented for Vo, Facility, Resource, Group,\n  Member and SecurityTeam.\n- Method for service was not implemented because it is not used at all.\n- Groups are fetched without their subgroups.\n- SPONSORSHIP is supported for members.\n- Fixed typo in GROUPOBSERVER name.", "committedDate": "2020-12-02T09:42:50Z", "type": "forcePushed"}, {"oid": "8d05b53ff8bf1033e3be8d1d5262ee1e72ee65dd", "url": "https://github.com/CESNET/perun/commit/8d05b53ff8bf1033e3be8d1d5262ee1e72ee65dd", "message": "New methods getObjectWhereUserIsInRoles\n\n- These methods were implemented for Vo, Facility, Resource, Group,\n  Member and SecurityTeam.\n- Method for service was not implemented because it is not used at all.\n- Groups are fetched without their subgroups.\n- SPONSORSHIP is supported for members.\n- Fixed typo in GROUPOBSERVER name.", "committedDate": "2020-12-02T09:46:59Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNDIxMw==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534034213", "bodyText": "Set of objects (there are more of these typos in the file).", "author": "stavamichal", "createdAt": "2020-12-02T09:53:21Z", "path": "perun-core/src/main/java/cz/metacentrum/perun/core/implApi/AuthzResolverImplApi.java", "diffHunk": "@@ -568,4 +570,67 @@\n \t * @return list of authorizedGroups\n \t */\n \tList<Group> getAdminGroups(Map<String, Integer> mappingOfValues);\n+\n+\t/**\n+\t * Get all Vos where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param user for who Vos are retrieved\n+\t * @param roles for which Vos are retrieved\n+\t * @return List of Vos", "originalCommit": "8d05b53ff8bf1033e3be8d1d5262ee1e72ee65dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MzA3NA==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534043074", "bodyText": "Fixed", "author": "balcirakpeter", "createdAt": "2020-12-02T10:05:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNDIxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNTkyMg==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534035922", "bodyText": "The param is still in the wrong format. It should be like this:\n@param roles List<String> list of role names for which Vos are retrieved", "author": "stavamichal", "createdAt": "2020-12-02T09:55:37Z", "path": "perun-rpc/src/main/java/cz/metacentrum/perun/rpc/methods/AuthzResolverMethod.java", "diffHunk": "@@ -782,5 +785,273 @@ public Void call(ApiCaller ac, Deserializer parms) throws PerunException {\n \t\t\tcz.metacentrum.perun.core.api.AuthzResolver.loadAuthorizationComponents(ac.getSession());\n \t\t\treturn null;\n \t\t}\n+\t},\n+\n+\t/*#\n+\t * Get all Vos where the given user has set one of the given roles\n+\t * or the given user is a member of an authorized group with such roles.\n+\t *\n+\t * @param user id for which Vos are retrieved\n+\t * @param List of role names for which Vos are retrieved", "originalCommit": "8d05b53ff8bf1033e3be8d1d5262ee1e72ee65dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MzI5OA==", "url": "https://github.com/CESNET/perun/pull/3015#discussion_r534043298", "bodyText": "Fixed for all aprameters", "author": "balcirakpeter", "createdAt": "2020-12-02T10:06:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAzNTkyMg=="}], "type": "inlineReview"}, {"oid": "b6c84e15203825c555b1096a036b9fd7b26f246f", "url": "https://github.com/CESNET/perun/commit/b6c84e15203825c555b1096a036b9fd7b26f246f", "message": "New methods getObjectWhereUserIsInRoles\n\n- These methods were implemented for Vo, Facility, Resource, Group,\n  Member and SecurityTeam.\n- Method for service was not implemented because it is not used at all.\n- Groups are fetched without their subgroups.\n- SPONSORSHIP is supported for members.\n- Fixed typo in GROUPOBSERVER name.", "committedDate": "2020-12-02T10:05:30Z", "type": "commit"}, {"oid": "b6c84e15203825c555b1096a036b9fd7b26f246f", "url": "https://github.com/CESNET/perun/commit/b6c84e15203825c555b1096a036b9fd7b26f246f", "message": "New methods getObjectWhereUserIsInRoles\n\n- These methods were implemented for Vo, Facility, Resource, Group,\n  Member and SecurityTeam.\n- Method for service was not implemented because it is not used at all.\n- Groups are fetched without their subgroups.\n- SPONSORSHIP is supported for members.\n- Fixed typo in GROUPOBSERVER name.", "committedDate": "2020-12-02T10:05:30Z", "type": "forcePushed"}]}