{"pr_number": 1004, "pr_title": "fix auth: property of int or date type can't be filtered", "pr_createdAt": "2020-05-26T20:17:55Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1004", "timeline": [{"oid": "91e213e7ed9a1ddba6922346d99b78270870a5df", "url": "https://github.com/hugegraph/hugegraph/commit/91e213e7ed9a1ddba6922346d99b78270870a5df", "message": "fix auth: property of int or date type can't be filtered\n\nChange-Id: I794165b89b9d21f31938f09daa2041881ba2eb8d", "committedDate": "2020-05-26T20:14:30Z", "type": "commit"}, {"oid": "8729de07f9b4c36641513d5d38bb50f4c2ba6e37", "url": "https://github.com/hugegraph/hugegraph/commit/8729de07f9b4c36641513d5d38bb50f4c2ba6e37", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888", "committedDate": "2020-05-26T20:26:50Z", "type": "forcePushed"}, {"oid": "c04377dcaa8e677522134e2389a13666a08a8467", "url": "https://github.com/hugegraph/hugegraph/commit/c04377dcaa8e677522134e2389a13666a08a8467", "message": "support P.contains() for list/set property\n\nChange-Id: I13678f1a28886c9592f8ea2ae51f953a5b4d6774", "committedDate": "2020-05-27T13:15:59Z", "type": "commit"}, {"oid": "e35a9db3bb52c0420e878844da24043e1f034c56", "url": "https://github.com/hugegraph/hugegraph/commit/e35a9db3bb52c0420e878844da24043e1f034c56", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888", "committedDate": "2020-05-27T13:16:17Z", "type": "commit"}, {"oid": "e35a9db3bb52c0420e878844da24043e1f034c56", "url": "https://github.com/hugegraph/hugegraph/commit/e35a9db3bb52c0420e878844da24043e1f034c56", "message": "add WsAndHttpBasicAuthHandler to fix crosstalk users\n\nChange-Id: Id07a2f24b4625402250bd5e137f3db7eef3a8888", "committedDate": "2020-05-27T13:16:17Z", "type": "forcePushed"}, {"oid": "eb760e02d02f7579c18ad111314090309aaeb241", "url": "https://github.com/hugegraph/hugegraph/commit/eb760e02d02f7579c18ad111314090309aaeb241", "message": "fix blob property read/write/compare\n\nsupport construct blob from byte[],base64-string,hex-string,byte-list\n\nChange-Id: I47357c537dcdacae2913139fd55f3794f57f322a", "committedDate": "2020-05-28T22:26:35Z", "type": "commit"}, {"oid": "eb760e02d02f7579c18ad111314090309aaeb241", "url": "https://github.com/hugegraph/hugegraph/commit/eb760e02d02f7579c18ad111314090309aaeb241", "message": "fix blob property read/write/compare\n\nsupport construct blob from byte[],base64-string,hex-string,byte-list\n\nChange-Id: I47357c537dcdacae2913139fd55f3794f57f322a", "committedDate": "2020-05-28T22:26:35Z", "type": "forcePushed"}, {"oid": "531515368d6cb1c64f6752d6eaf113bb6d5be73b", "url": "https://github.com/hugegraph/hugegraph/commit/531515368d6cb1c64f6752d6eaf113bb6d5be73b", "message": "improve auth log for tasks\n\nChange-Id: I62bb87ac346813984c23038f27e24e5566bb3cac", "committedDate": "2020-05-29T13:33:57Z", "type": "commit"}, {"oid": "2e07b831fd7f07a94e8f346f59944cc45e6c1176", "url": "https://github.com/hugegraph/hugegraph/commit/2e07b831fd7f07a94e8f346f59944cc45e6c1176", "message": "fix validPropertyValue with blob and Cardinality.SINGLE\n\nChange-Id: Ic13c7a4bc8ebd591f3f8e5657fcc3cb1708706f9", "committedDate": "2020-06-01T08:47:46Z", "type": "commit"}, {"oid": "82afc2dc4e66047e7cbb540d40a85542083d9488", "url": "https://github.com/hugegraph/hugegraph/commit/82afc2dc4e66047e7cbb540d40a85542083d9488", "message": "fix validPropertyValue with list/set property and P.contains(value)\n\nChange-Id: Ice21c4493347d8ca02cce2d184648ef3824484e3", "committedDate": "2020-06-02T13:12:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NTY5NQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434255695", "bodyText": "rename to KEY_ADDRESS", "author": "zhoney", "createdAt": "2020-06-03T01:09:37Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/auth/HugeAuthenticator.java", "diffHunk": "@@ -48,7 +48,7 @@\n     public static final String KEY_PASSWORD =\n                                CredentialGraphTokens.PROPERTY_PASSWORD;\n     public static final String KEY_ROLE = \"role\";\n-    public static final String KEY_CLIENT = \"client\";\n+    public static final String KEY_CLIENT = \"address\";", "originalCommit": "82afc2dc4e66047e7cbb540d40a85542083d9488", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NjYxMQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434256611", "bodyText": "recheck to make sure it's expected", "author": "zhoney", "createdAt": "2020-06-03T01:13:11Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/auth/WsAndHttpBasicAuthHandler.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.baidu.hugegraph.auth;\n+\n+import static io.netty.handler.codec.http.HttpHeaderNames.CONNECTION;\n+import static io.netty.handler.codec.http.HttpHeaderNames.UPGRADE;\n+import static io.netty.handler.codec.http.HttpResponseStatus.UNAUTHORIZED;\n+import static io.netty.handler.codec.http.HttpVersion.HTTP_1_1;\n+import static org.apache.tinkerpop.gremlin.groovy.jsr223.dsl.credential.CredentialGraphTokens.PROPERTY_PASSWORD;\n+import static org.apache.tinkerpop.gremlin.groovy.jsr223.dsl.credential.CredentialGraphTokens.PROPERTY_USERNAME;\n+\n+import java.nio.charset.Charset;\n+import java.util.Base64;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.apache.tinkerpop.gremlin.server.Settings;\n+import org.apache.tinkerpop.gremlin.server.auth.AuthenticationException;\n+import org.apache.tinkerpop.gremlin.server.auth.Authenticator;\n+import org.apache.tinkerpop.gremlin.server.handler.AbstractAuthenticationHandler;\n+import org.apache.tinkerpop.gremlin.server.handler.SaslAuthenticationHandler;\n+\n+import io.netty.channel.ChannelFutureListener;\n+import io.netty.channel.ChannelHandler;\n+import io.netty.channel.ChannelHandlerContext;\n+import io.netty.channel.ChannelPipeline;\n+import io.netty.handler.codec.http.DefaultFullHttpResponse;\n+import io.netty.handler.codec.http.FullHttpMessage;\n+import io.netty.handler.codec.http.HttpMessage;\n+import io.netty.util.ReferenceCountUtil;\n+\n+/**\n+ * An Authentication Handler for doing WebSocket and Http Basic auth\n+ * TODO: remove this class after fixed TINKERPOP-2374\n+ */\n+@ChannelHandler.Sharable\n+public class WsAndHttpBasicAuthHandler extends SaslAuthenticationHandler {\n+\n+    private static final String AUTHENTICATOR = \"authenticator\";\n+    private static final String HTTP_AUTH = \"http-authentication\";\n+\n+    public WsAndHttpBasicAuthHandler(Authenticator authenticator,\n+                                     Settings.AuthenticationSettings settings) {\n+        super(authenticator, settings);\n+    }\n+\n+    @Override\n+    public void channelRead(final ChannelHandlerContext ctx, final Object obj)\n+                            throws Exception {\n+        if (obj instanceof HttpMessage && !isWebSocket((HttpMessage) obj)) {\n+            ChannelPipeline pipeline = ctx.pipeline();\n+            ChannelHandler authHandler = pipeline.get(HTTP_AUTH);\n+            if (authHandler != null) {\n+                authHandler = pipeline.remove(HTTP_AUTH);\n+            } else {\n+                authHandler = new HttpBasicAuthHandler(\n+                              this.authenticator,  this.authenticationSettings);\n+            }\n+            pipeline.addAfter(AUTHENTICATOR, HTTP_AUTH, authHandler);\n+            ctx.fireChannelRead(obj);\n+        } else {\n+            super.channelRead(ctx, obj);\n+        }\n+    }\n+\n+    public static boolean isWebSocket(final HttpMessage msg) {\n+        final String connectionHeader = msg.headers().get(CONNECTION);\n+        final String upgradeHeader = msg.headers().get(UPGRADE);\n+        return \"Upgrade\".equalsIgnoreCase(connectionHeader) ||", "originalCommit": "82afc2dc4e66047e7cbb540d40a85542083d9488", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTA0MDk0Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r435040942", "bodyText": "sure", "author": "javeme", "createdAt": "2020-06-04T07:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NjYxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NzEzMQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434257131", "bodyText": "this. cardinality.single()", "author": "zhoney", "createdAt": "2020-06-03T01:15:24Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/PropertyKey.java", "diffHunk": "@@ -214,11 +181,43 @@ public String clazz() {\n         return valid;\n     }\n \n+    /**\n+     * Check type of the value valid\n+     * @param value the property value to be checked data type\n+     * @param <V>   the property value original data type\n+     * @return true if the value is or can convert to the data type,\n+     *         otherwise false\n+     */\n+    private <V> boolean checkDataType(V value) {\n+        return this.dataType().clazz().isInstance(value);\n+    }\n+\n+    /**\n+     * Check type of all the values(may be some of list properties) valid\n+     * @param values the property values to be checked data type\n+     * @param <V> the property value class\n+     * @return true if all the values are or can convert to the data type,\n+     *         otherwise false\n+     */\n+    private <V> boolean checkDataType(Collection<V> values) {\n+        boolean valid = true;\n+        for (Object o : values) {\n+            if (!this.checkDataType(o)) {\n+                valid = false;\n+                break;\n+            }\n+        }\n+        return valid;\n+    }\n+\n     public <V> Object serialValue(V value) {\n         V validValue = this.validValue(value);\n         E.checkArgument(validValue != null,\n                         \"Invalid property value '%s' for key '%s'\",\n                         value, this.name());\n+        E.checkArgument(this.cardinality == Cardinality.SINGLE,", "originalCommit": "82afc2dc4e66047e7cbb540d40a85542083d9488", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDI1NzI2Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/1004#discussion_r434257263", "bodyText": "this.cardinality.single()", "author": "zhoney", "createdAt": "2020-06-03T01:15:50Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/PropertyKey.java", "diffHunk": "@@ -238,46 +237,61 @@ public String clazz() {\n     }\n \n     public <V> V validValue(V value) {\n-        return this.convValue(value, true);\n+        try {\n+            return this.convValue(value);\n+        } catch (RuntimeException e) {\n+            throw new IllegalArgumentException(String.format(\n+                      \"Invalid property value '%s' for key '%s': %s\",\n+                      value, this.name(), e.getMessage()));\n+        }\n     }\n \n     @SuppressWarnings(\"unchecked\")\n-    public <V, T> V convValue(V value, boolean checkValue) {\n+    private <V, T> V convValue(V value) {\n         if (value == null) {\n             return null;\n         }\n+        if (this.checkValueType(value)) {\n+            // Same as expected type, no conversion required\n+            return value;\n+        }\n \n-        V validValue;\n+        V validValue = null;\n         Collection<T> validValues;\n-        if (!(value instanceof Collection)) {\n+        if (this.cardinality == Cardinality.SINGLE) {", "originalCommit": "82afc2dc4e66047e7cbb540d40a85542083d9488", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "92d27d63cd9fce2fcfceec90d80b489652f35ee3", "url": "https://github.com/hugegraph/hugegraph/commit/92d27d63cd9fce2fcfceec90d80b489652f35ee3", "message": "tiny improve\n\nChange-Id: I9227897f9ddb00cb5cf0547e43fc8d06c150f191", "committedDate": "2020-06-04T07:15:00Z", "type": "commit"}]}