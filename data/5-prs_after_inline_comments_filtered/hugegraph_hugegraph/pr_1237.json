{"pr_number": 1237, "pr_title": "Move lz4 decompress to backend executor", "pr_createdAt": "2020-11-02T10:44:04Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1237", "timeline": [{"oid": "445a2bffa4198f7f0395d8f3fe04c6b820ffbc0d", "url": "https://github.com/hugegraph/hugegraph/commit/445a2bffa4198f7f0395d8f3fe04c6b820ffbc0d", "message": "Let lz4 decompress in thread pool\n\nChange-Id: Idf2e796739fda1dc5ce5ffcfa16bc61b6e1a6281", "committedDate": "2020-11-02T10:42:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk0NDQyOQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r515944429", "bodyText": "prefer to define a var", "author": "javeme", "createdAt": "2020-11-02T12:41:41Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -230,7 +230,8 @@ private void waitIfBusy() {\n             if (this.busyCounter.get() > 0) {\n                 synchronized (this) {\n                     if (this.busyCounter.get() > 0) {\n-                        this.busyCounter.decrementAndGet();\n+                        LOG.info(\"Decrease busy counter: [{}]\",\n+                                 this.busyCounter.decrementAndGet());", "originalCommit": "445a2bffa4198f7f0395d8f3fe04c6b820ffbc0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk0NDk1Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r515944953", "bodyText": "prefer isRpcTimeout", "author": "javeme", "createdAt": "2020-11-02T12:42:41Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftNode.java", "diffHunk": "@@ -278,6 +279,16 @@ private boolean isWriteBufferOverflow(Status status) {\n                    status.getErrorMsg().contains(expectMsg);\n         }\n \n+        /**\n+         * Maybe useful in the future\n+         */\n+        private boolean isRPCTimeout(Status status) {", "originalCommit": "445a2bffa4198f7f0395d8f3fe04c6b820ffbc0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f3ac5449f94d07b7081cdd50dcd132b6e7c152d4", "url": "https://github.com/hugegraph/hugegraph/commit/f3ac5449f94d07b7081cdd50dcd132b6e7c152d4", "message": "tiny improve\n\nChange-Id: I4b4c470228caa4ba7e44df9618a7aa1f35da06ef", "committedDate": "2020-11-03T02:50:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwMjgzMg==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r516402832", "bodyText": "ditto", "author": "zhoney", "createdAt": "2020-11-03T02:53:29Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/config/CoreOptions.java", "diffHunk": "@@ -249,6 +249,22 @@ public static synchronized CoreOptions instance() {\n                     60000\n             );\n \n+    public static final ConfigOption<Integer> RAFT_RPC_BUF_LOW_WATER_MARK =\n+            new ConfigOption<>(\n+                    \"raft.rpc_buf_low_water_mark\",\n+                    \"\",\n+                    positiveInt(),\n+                    10 * 1024 * 1024\n+            );\n+\n+    public static final ConfigOption<Integer> RAFT_RPC_BUF_HIGH_WATER_MARK =\n+            new ConfigOption<>(\n+                    \"raft.rpc_buf_high_water_mark\",\n+                    \"\",", "originalCommit": "f3ac5449f94d07b7081cdd50dcd132b6e7c152d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQwMjkwMQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r516402901", "bodyText": "prefer write some description", "author": "zhoney", "createdAt": "2020-11-03T02:53:48Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/config/CoreOptions.java", "diffHunk": "@@ -249,6 +249,22 @@ public static synchronized CoreOptions instance() {\n                     60000\n             );\n \n+    public static final ConfigOption<Integer> RAFT_RPC_BUF_LOW_WATER_MARK =\n+            new ConfigOption<>(\n+                    \"raft.rpc_buf_low_water_mark\",\n+                    \"\",", "originalCommit": "f3ac5449f94d07b7081cdd50dcd132b6e7c152d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ0NDY2NA==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r516444664", "bodyText": "add some comment", "author": "javeme", "createdAt": "2020-11-03T06:13:33Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/raft/RaftSharedContext.java", "diffHunk": "@@ -266,6 +267,9 @@ public void notifyCache(HugeType type, Id id) {\n             eventHub = this.params.graphEventHub();\n         } else if (type.isSchema()) {\n             eventHub = this.params.schemaEventHub();\n+            if (id.number() && id.asLong() < 0) {\n+                return;", "originalCommit": "f3ac5449f94d07b7081cdd50dcd132b6e7c152d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjQ0OTM2Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r516449367", "bodyText": "need to perform", "author": "javeme", "createdAt": "2020-11-03T06:33:07Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/util/LZ4Util.java", "diffHunk": "@@ -54,6 +54,10 @@ public static BytesBuffer compress(byte[] bytes, int blockSize,\n         } catch (IOException e) {\n             throw new BackendException(\"Failed to compress\", e);\n         }\n+        /*\n+         * If need perform reading outside the method,", "originalCommit": "f3ac5449f94d07b7081cdd50dcd132b6e7c152d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "408689e38fbb1a40775a382310a14b010c86df3c", "url": "https://github.com/hugegraph/hugegraph/commit/408689e38fbb1a40775a382310a14b010c86df3c", "message": "some improve\n\nChange-Id: I70c2fcfd92ed923d801394cd6f97b31afa8475d4", "committedDate": "2020-11-03T08:05:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjU1ODU2Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r516558567", "bodyText": "move to remove() method", "author": "javeme", "createdAt": "2020-11-03T10:19:36Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedSchemaTransaction.java", "diffHunk": "@@ -107,7 +107,9 @@ private void listenChanges() {\n             if (\"invalid\".equals(args[0])) {\n                 HugeType type = (HugeType) args[1];\n                 Id id = (Id) args[2];\n-                this.arrayCaches.remove(type, id);\n+                if (id.number() && id.asLong() > 0) {\n+                    this.arrayCaches.remove(type, id);", "originalCommit": "408689e38fbb1a40775a382310a14b010c86df3c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "url": "https://github.com/hugegraph/hugegraph/commit/d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "message": "tiny improve\n\nChange-Id: I8008c86b8e7c92d72dac205eca8894826a39edb8", "committedDate": "2020-11-04T02:08:35Z", "type": "commit"}, {"oid": "d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "url": "https://github.com/hugegraph/hugegraph/commit/d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "message": "tiny improve\n\nChange-Id: I8008c86b8e7c92d72dac205eca8894826a39edb8", "committedDate": "2020-11-04T02:08:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE0Njk0OQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r517146949", "bodyText": "define var longId=id.asLong()", "author": "javeme", "createdAt": "2020-11-04T07:41:42Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedSchemaTransaction.java", "diffHunk": "@@ -322,13 +320,16 @@ public void updateIfNeeded(V schema) {\n                 return;\n             }\n             Id id = schema.id();\n-            if (id.number() && id.asLong() > 0) {\n+            if (id.number() && id.asLong() > 0L) {\n                 this.set(schema.type(), id, schema);\n             }\n         }\n \n         public V get(HugeType type, Id id) {\n-            assert id.number() && id.asLong() > 0 : id;\n+            assert id.number();\n+            if (id.asLong() <= 0L) {", "originalCommit": "d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE0NzA3NQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r517147075", "bodyText": "ditto", "author": "javeme", "createdAt": "2020-11-04T07:41:59Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedSchemaTransaction.java", "diffHunk": "@@ -348,7 +349,10 @@ public V get(HugeType type, Id id) {\n         }\n \n         public void set(HugeType type, Id id, V value) {\n-            assert id.number() && id.asLong() > 0 : id;\n+            assert id.number();\n+            if (id.asLong() <= 0L) {", "originalCommit": "d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE0NzEzNQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r517147135", "bodyText": "ditto", "author": "javeme", "createdAt": "2020-11-04T07:42:06Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedSchemaTransaction.java", "diffHunk": "@@ -373,7 +377,10 @@ public void set(HugeType type, Id id, V value) {\n         }\n \n         public void remove(HugeType type, Id id) {\n-            assert id.number() && id.asLong() > 0 : id;\n+            assert id.number();\n+            if (id.asLong() <= 0L) {", "originalCommit": "d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "25f7e50527147084630082bfb6abf80bb902116a", "url": "https://github.com/hugegraph/hugegraph/commit/25f7e50527147084630082bfb6abf80bb902116a", "message": "use whitebox to set LOW_WATER_MARK and HIGH_WATER_MARK\n\nChange-Id: Ia15672c9e0564cb9673a0b8ab983272c3943c276", "committedDate": "2020-11-04T08:32:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzE3NDE2MA==", "url": "https://github.com/hugegraph/hugegraph/pull/1237#discussion_r517174160", "bodyText": "add assert false : id;", "author": "javeme", "createdAt": "2020-11-04T08:36:20Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/cache/CachedSchemaTransaction.java", "diffHunk": "@@ -348,7 +349,10 @@ public V get(HugeType type, Id id) {\n         }\n \n         public void set(HugeType type, Id id, V value) {\n-            assert id.number() && id.asLong() > 0 : id;\n+            assert id.number();\n+            if (id.asLong() <= 0L) {\n+                return;", "originalCommit": "d1189c7c08d190dd2ac3e272974b7b5bc3a0d3fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ec8cb4db87eebd614de627cc5d9ef19c703699cd", "url": "https://github.com/hugegraph/hugegraph/commit/ec8cb4db87eebd614de627cc5d9ef19c703699cd", "message": "tiny improve\n\nChange-Id: I4d7a90c5e40117e00c1e017917ac5d83824df3ce", "committedDate": "2020-11-04T08:42:07Z", "type": "commit"}, {"oid": "21178e0f5e120b278f95a0d126a723d3b5a72efd", "url": "https://github.com/hugegraph/hugegraph/commit/21178e0f5e120b278f95a0d126a723d3b5a72efd", "message": "tiny improve\n\nChange-Id: Ic7770f0b8cb9a81dbb714ea9ce8ef99d5b710807", "committedDate": "2020-11-04T08:51:23Z", "type": "commit"}]}