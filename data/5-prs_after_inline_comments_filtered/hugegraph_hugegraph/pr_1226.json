{"pr_number": 1226, "pr_title": "set indexlabel invalid if create or rebuild failed", "pr_createdAt": "2020-10-27T03:42:19Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/1226", "timeline": [{"oid": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "url": "https://github.com/hugegraph/hugegraph/commit/e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "message": "set indexlabel invalid if create or rebuild failed\n\nalso check if indexlabel invalid when query by index\n\nChange-Id: If890b3bd8c441b63642a2006479cf4ccca9ddf67", "committedDate": "2020-10-27T03:40:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MDA3Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512450073", "bodyText": "validate", "author": "javeme", "createdAt": "2020-10-27T06:49:04Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/tx/GraphIndexTransaction.java", "diffHunk": "@@ -1349,6 +1354,13 @@ private static NoIndexException noIndexException(HugeGraph graph,\n                                     name, String.join(\"/\", mismatched));\n     }\n \n+    private static void validIndexLabel(IndexLabel indexLabel) {", "originalCommit": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1MTc5Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512451793", "bodyText": "Can't query by label index '%s' due to it is in invalid status", "author": "javeme", "createdAt": "2020-10-27T06:53:50Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/tx/GraphIndexTransaction.java", "diffHunk": "@@ -1349,6 +1354,13 @@ private static NoIndexException noIndexException(HugeGraph graph,\n                                     name, String.join(\"/\", mismatched));\n     }\n \n+    private static void validIndexLabel(IndexLabel indexLabel) {\n+        if (indexLabel.status() == SchemaStatus.INVALID) {\n+            throw new HugeException(\"The label index %s is invalid\",", "originalCommit": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1Mzg1Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512453852", "bodyText": "does save to backend store? seems need to call schemaTx.updateSchemaStatus()", "author": "javeme", "createdAt": "2020-10-27T06:59:27Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/job/schema/RebuildIndexCallable.java", "diffHunk": "@@ -158,6 +166,9 @@ private void removeIndex(Collection<Id> indexLabelIds) {\n             try {\n                 locks.lockWrites(LockUtil.INDEX_LABEL_DELETE, indexLabelIds);\n                 graphTx.removeIndex(il);\n+            } catch (Throwable t) {\n+                il.status(SchemaStatus.INVALID);", "originalCommit": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1Mzg4Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512453886", "bodyText": "ditto", "author": "javeme", "createdAt": "2020-10-27T06:59:32Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -222,13 +222,19 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n \n             // Create index label (just schema)\n             indexLabel.status(SchemaStatus.CREATING);\n-            this.graph().addIndexLabel(schemaLabel, indexLabel);\n+            try {\n+                this.graph().addIndexLabel(schemaLabel, indexLabel);\n \n-            // Async rebuild index\n-            Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n-            E.checkNotNull(rebuildTask, \"rebuild-index task\");\n+                // Async rebuild index\n+                Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n+                E.checkNotNull(rebuildTask, \"rebuild-index task\");\n \n-            return new IndexLabel.CreatedIndexLabel(indexLabel, rebuildTask);\n+                return new IndexLabel.CreatedIndexLabel(indexLabel,\n+                                                        rebuildTask);\n+            } catch (Throwable t) {\n+                indexLabel.status(SchemaStatus.INVALID);", "originalCommit": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ1NDM3OQ==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512454379", "bodyText": "rename t to e", "author": "javeme", "createdAt": "2020-10-27T07:00:59Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -222,13 +222,19 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n \n             // Create index label (just schema)\n             indexLabel.status(SchemaStatus.CREATING);\n-            this.graph().addIndexLabel(schemaLabel, indexLabel);\n+            try {\n+                this.graph().addIndexLabel(schemaLabel, indexLabel);\n \n-            // Async rebuild index\n-            Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n-            E.checkNotNull(rebuildTask, \"rebuild-index task\");\n+                // Async rebuild index\n+                Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n+                E.checkNotNull(rebuildTask, \"rebuild-index task\");\n \n-            return new IndexLabel.CreatedIndexLabel(indexLabel, rebuildTask);\n+                return new IndexLabel.CreatedIndexLabel(indexLabel,\n+                                                        rebuildTask);\n+            } catch (Throwable t) {\n+                indexLabel.status(SchemaStatus.INVALID);\n+                throw t;", "originalCommit": "e8fb9f08d427ea01e588b159f9dd81b4d2697cb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e81ea8842d2352e043900514f5f6ecea80c62f27", "url": "https://github.com/hugegraph/hugegraph/commit/e81ea8842d2352e043900514f5f6ecea80c62f27", "message": "improve\n\nChange-Id: Ib8ee461872a463480fdc03faf3240a4254cc66f9", "committedDate": "2020-10-27T11:03:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjY2Nzk0NA==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r512667944", "bodyText": "schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.INVALID);", "author": "javeme", "createdAt": "2020-10-27T12:56:04Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -222,18 +222,18 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n \n             // Create index label (just schema)\n             indexLabel.status(SchemaStatus.CREATING);\n+            this.graph().addIndexLabel(schemaLabel, indexLabel);\n             try {\n-                this.graph().addIndexLabel(schemaLabel, indexLabel);\n-\n                 // Async rebuild index\n                 Id rebuildTask = this.rebuildIndex(indexLabel, removeTasks);\n                 E.checkNotNull(rebuildTask, \"rebuild-index task\");\n \n                 return new IndexLabel.CreatedIndexLabel(indexLabel,\n                                                         rebuildTask);\n-            } catch (Throwable t) {\n+            } catch (Throwable e) {\n                 indexLabel.status(SchemaStatus.INVALID);\n-                throw t;\n+                this.graph().addIndexLabel(schemaLabel, indexLabel);", "originalCommit": "e81ea8842d2352e043900514f5f6ecea80c62f27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "381aefe5ad7db83be300a4ddf58cb77e43167c23", "url": "https://github.com/hugegraph/hugegraph/commit/381aefe5ad7db83be300a4ddf58cb77e43167c23", "message": "improve\n\nChange-Id: I57331425089e18582f5938536c5026e703ce34c6", "committedDate": "2020-10-27T13:11:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE5NjAyNA==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r513196024", "bodyText": "also consider removeSubIndex() at line 207", "author": "javeme", "createdAt": "2020-10-28T05:53:02Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/schema/builder/IndexLabelBuilder.java", "diffHunk": "@@ -231,8 +231,7 @@ private boolean hasSameProperties(IndexLabel existedIndexLabel) {\n                 return new IndexLabel.CreatedIndexLabel(indexLabel,\n                                                         rebuildTask);\n             } catch (Throwable e) {\n-                indexLabel.status(SchemaStatus.INVALID);\n-                this.graph().addIndexLabel(schemaLabel, indexLabel);\n+                this.updateSchemaStatus(indexLabel, SchemaStatus.INVALID);", "originalCommit": "381aefe5ad7db83be300a4ddf58cb77e43167c23", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "077fa8500a97936f23b8fb8ad4779d4b8224654a", "url": "https://github.com/hugegraph/hugegraph/commit/077fa8500a97936f23b8fb8ad4779d4b8224654a", "message": "improve\n\nChange-Id: I6aeaabe6325c336e947fa0d09a824a4138473fa4", "committedDate": "2020-10-28T06:55:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyMTIzNg==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r513221236", "bodyText": "should update status to INVALID  when failure to remove vertex/edge label?", "author": "javeme", "createdAt": "2020-10-28T07:10:44Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/job/schema/IndexLabelRemoveCallable.java", "diffHunk": "@@ -54,14 +54,20 @@ protected static void removeIndexLabel(HugeGraphParams graph, Id id) {\n             // TODO add update lock\n             // Set index label to \"deleting\" status\n             schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.DELETING);\n-            // Remove index data\n-            // TODO: use event to replace direct call\n-            graphTx.removeIndex(indexLabel);\n-            // Remove label from indexLabels of vertex or edge label\n-            removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n-            removeSchema(schemaTx, indexLabel);\n-            // Should commit changes to backend store before release delete lock\n-            graph.graph().tx().commit();\n+            try {\n+                // Remove index data\n+                // TODO: use event to replace direct call\n+                graphTx.removeIndex(indexLabel);\n+                // Remove label from indexLabels of vertex or edge label\n+                removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n+                removeSchema(schemaTx, indexLabel);\n+                // Should commit changes to backend store\n+                // before release delete lock\n+                graph.graph().tx().commit();\n+            } catch (Throwable e) {\n+                schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.INVALID);\n+                throw e;\n+            }", "originalCommit": "077fa8500a97936f23b8fb8ad4779d4b8224654a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyMjY4Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r513222687", "bodyText": "no need. Fail to remove vertex/edge label will lead to partial delete of vertices/edges. vertex/edge label need to be still valid for remaining vertices/edges", "author": "zhoney", "createdAt": "2020-10-28T07:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyMTIzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzIyMTM3Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/1226#discussion_r513221377", "bodyText": "use \"/*\"", "author": "javeme", "createdAt": "2020-10-28T07:11:04Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/job/schema/IndexLabelRemoveCallable.java", "diffHunk": "@@ -54,14 +54,20 @@ protected static void removeIndexLabel(HugeGraphParams graph, Id id) {\n             // TODO add update lock\n             // Set index label to \"deleting\" status\n             schemaTx.updateSchemaStatus(indexLabel, SchemaStatus.DELETING);\n-            // Remove index data\n-            // TODO: use event to replace direct call\n-            graphTx.removeIndex(indexLabel);\n-            // Remove label from indexLabels of vertex or edge label\n-            removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n-            removeSchema(schemaTx, indexLabel);\n-            // Should commit changes to backend store before release delete lock\n-            graph.graph().tx().commit();\n+            try {\n+                // Remove index data\n+                // TODO: use event to replace direct call\n+                graphTx.removeIndex(indexLabel);\n+                // Remove label from indexLabels of vertex or edge label\n+                removeIndexLabelFromBaseLabel(schemaTx, indexLabel);\n+                removeSchema(schemaTx, indexLabel);\n+                // Should commit changes to backend store\n+                // before release delete lock", "originalCommit": "077fa8500a97936f23b8fb8ad4779d4b8224654a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0b3742f47439d456c09f5e7a9130860448251c22", "url": "https://github.com/hugegraph/hugegraph/commit/0b3742f47439d456c09f5e7a9130860448251c22", "message": "improve\n\nChange-Id: I855e51feda284ba74522cd98f11b11975dcb80d9", "committedDate": "2020-10-28T07:14:56Z", "type": "commit"}, {"oid": "d20e5770f2d41ff95c3c853ce70cbf3f0f691000", "url": "https://github.com/hugegraph/hugegraph/commit/d20e5770f2d41ff95c3c853ce70cbf3f0f691000", "message": "set vl/el to UNDELETED if fail to delete\n\nChange-Id: I7537bd5aff2b43e8a3ba26c88f83761889386ff3", "committedDate": "2020-10-28T08:06:57Z", "type": "commit"}]}