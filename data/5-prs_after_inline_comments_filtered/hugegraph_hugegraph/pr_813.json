{"pr_number": 813, "pr_title": "optimize aggregate functions", "pr_createdAt": "2020-01-05T15:01:32Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/813", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA5ODc4Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/813#discussion_r363098787", "bodyText": "remove", "author": "javeme", "createdAt": "2020-01-05T15:05:09Z", "path": "hugegraph-example/src/main/java/com/baidu/hugegraph/example/Example1.java", "diffHunk": "@@ -256,6 +257,46 @@ public static void loadData(final HugeGraph graph) {\n     }\n \n     public static void testQuery(final HugeGraph graph) {\n+//        System.out.println(\">>>>groupCount=\"+\n+//                graph.traversal().E().hasLabel(\"has_vcore_attr\")\n+//                .groupCount().by(__.outV().properties(\"p_trade\").value()).explain());\n+//\n+//        System.out.println(\">>>>flatmapCount=\"+\n+//                graph.traversal().E().hasLabel(\"has_vcore_attr\")\n+//                .outV().has(\"p_trade\",\"xx\").count().profile());\n+\n+        System.out.println(\">>>>groupCount=\"+\n+                graph.traversal().E().hasLabel(\"write\")\n+                     .groupCount().by(__.bothV().values(\"name\")).toList());\n+\n+        System.out.println(\">>>>groupCount=\"+\n+                graph.traversal().E().hasLabel(\"write\")\n+                     .group().by(__.inV().values(\"name\")).toList());\n+\n+        System.out.println(\">>>>num0.v=\"+\n+                graph.traversal().V().count().toList());\n+\n+        System.out.println(\">>>>num0.e=\"+\n+                graph.traversal().E().count().toList());\n+\n+        System.out.println(\">>>>num1=\"+\n+                graph.traversal().V().hasLabel(\"author\",\"book\").count().toList());\n+\n+        System.out.println(\">>>>num1.prop=\"+\n+                graph.traversal().V().hasLabel(\"person\").has(\"age\", P.gt(18)).count().toList());\n+\n+        System.out.println(\">>>>num1 max=\"+\n+                graph.traversal().V().hasLabel(\"author\").count().max().toList());\n+\n+        System.out.println(\">>>>num2=\"+\n+                graph.traversal().V().hasLabel(\"author\").bothE().count().toList());\n+\n+        System.out.println(\">>>>num3=\"+\n+            graph.traversal().V().hasLabel(\"person\").values(\"age\").sum().toList());\n+\n+        System.out.println(\">>>>num4=\"+\n+            graph.traversal().V().hasLabel(\"person\").both().values(\"age\").sum().toList());\n+", "originalCommit": "5e4f5bcfeb03817d2d8c6545cbffba4cc85e7808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA5ODg3MA==", "url": "https://github.com/hugegraph/hugegraph/pull/813#discussion_r363098870", "bodyText": "remove //", "author": "javeme", "createdAt": "2020-01-05T15:06:18Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/traversal/optimize/HugeCountStepStrategy.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2017 HugeGraph Authors\n+ *\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with this\n+ * work for additional information regarding copyright ownership. The ASF\n+ * licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.baidu.hugegraph.traversal.optimize;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+\n+import org.apache.tinkerpop.gremlin.process.traversal.Step;\n+import org.apache.tinkerpop.gremlin.process.traversal.Traversal;\n+import org.apache.tinkerpop.gremlin.process.traversal.TraversalStrategy.ProviderOptimizationStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.TraversalParent;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.CountGlobalStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.GraphStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.map.NoOpBarrierStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.sideEffect.AggregateStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.sideEffect.IdentityStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.sideEffect.SideEffectStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.step.util.CollectingBarrierStep;\n+import org.apache.tinkerpop.gremlin.process.traversal.strategy.AbstractTraversalStrategy;\n+import org.apache.tinkerpop.gremlin.process.traversal.util.TraversalHelper;\n+import org.apache.tinkerpop.gremlin.structure.Element;\n+\n+import com.baidu.hugegraph.backend.query.Aggregate.AggregateFunc;\n+\n+public final class HugeCountStepStrategy\n+             extends AbstractTraversalStrategy<ProviderOptimizationStrategy>\n+             implements ProviderOptimizationStrategy {\n+\n+    private static final long serialVersionUID = -3910433925919057771L;\n+\n+    private static final HugeCountStepStrategy INSTANCE;\n+\n+    static {\n+        INSTANCE = new HugeCountStepStrategy();\n+    }\n+\n+    private HugeCountStepStrategy() {\n+        // pass\n+    }\n+\n+    @Override\n+//    @SuppressWarnings({ \"rawtypes\", \"unchecked\" })", "originalCommit": "5e4f5bcfeb03817d2d8c6545cbffba4cc85e7808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA5ODk1NA==", "url": "https://github.com/hugegraph/hugegraph/pull/813#discussion_r363098954", "bodyText": "TODO", "author": "javeme", "createdAt": "2020-01-05T15:07:40Z", "path": "hugegraph-cassandra/src/main/java/com/baidu/hugegraph/backend/store/cassandra/CassandraTable.java", "diffHunk": "@@ -91,25 +98,51 @@ protected void registerMetaHandlers() {\n         });\n     }\n \n+    @Override\n+    public Number queryNumber(CassandraSessionPool.Session session,\n+                              Query query) {\n+        Aggregate aggregate = query.aggregateNotNull();\n+        Iterator<Number> results = this.query(query, statement -> {\n+            // Set request timeout to a large value\n+            // TODO read from conf", "originalCommit": "5e4f5bcfeb03817d2d8c6545cbffba4cc85e7808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA5ODk4NA==", "url": "https://github.com/hugegraph/hugegraph/pull/813#discussion_r363098984", "bodyText": "remove TODO", "author": "javeme", "createdAt": "2020-01-05T15:08:15Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/tx/AbstractTransaction.java", "diffHunk": "@@ -88,7 +88,24 @@ public BackendStore store() {\n     }\n \n     @Watched(prefix = \"tx\")\n-    public QueryResults query(Query query) {\n+    public Number queryNumber(Query query) {\n+        LOG.debug(\"Transaction queryNumber: {}\", query);\n+\n+        E.checkArgument(query.aggregate() != null,\n+                        \"The aggregate must be set for number query: %s\",\n+                        query);\n+        Query squery = this.serializer.writeQuery(query);\n+\n+        this.beforeRead();\n+        try {\n+            return this.store.queryNumber(squery);\n+        } finally {\n+            this.afterRead(); // TODO: not complete the iteration currently", "originalCommit": "5e4f5bcfeb03817d2d8c6545cbffba4cc85e7808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA5OTAwMw==", "url": "https://github.com/hugegraph/hugegraph/pull/813#discussion_r363099003", "bodyText": "TODO", "author": "javeme", "createdAt": "2020-01-05T15:08:33Z", "path": "hugegraph-hbase/src/main/java/com/baidu/hugegraph/backend/store/hbase/HbaseSessions.java", "diffHunk": "@@ -91,6 +97,15 @@ private Table table(String table) throws IOException {\n         return this.hbase.getTable(tableName);\n     }\n \n+    private AggregationClient aggregationClient() {\n+        Configuration hConfig = this.hbase.getConfiguration();\n+        hConfig = HBaseConfiguration.create(hConfig);\n+        // TODO: read from conf", "originalCommit": "5e4f5bcfeb03817d2d8c6545cbffba4cc85e7808", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "40dd15e3bca158fb14f013cae13adb5b745a67ab", "url": "https://github.com/hugegraph/hugegraph/commit/40dd15e3bca158fb14f013cae13adb5b745a67ab", "message": "optimize aggregate functions\n\nChange-Id: I87af5f447c06e7a42c077d3d9eb1a3acde9d3b66", "committedDate": "2020-03-31T13:45:59Z", "type": "commit"}, {"oid": "3509c1247d170841f214150550bf6b1250709f42", "url": "https://github.com/hugegraph/hugegraph/commit/3509c1247d170841f214150550bf6b1250709f42", "message": "put backend dependencies into submodules\n\nChange-Id: If8579e920d950b5573a87f25b1f79f34b7114ca1", "committedDate": "2020-03-31T13:46:02Z", "type": "commit"}, {"oid": "2b5cac2a9b703d3cbf578f1faf6f7bd7169e0703", "url": "https://github.com/hugegraph/hugegraph/commit/2b5cac2a9b703d3cbf578f1faf6f7bd7169e0703", "message": "adapt hbase\n\nChange-Id: Iab39d76c764f0b3ed3953be54dcebe51eb8afb7c", "committedDate": "2020-03-31T13:48:54Z", "type": "commit"}, {"oid": "2e36b201b73254c01e3833aa9d63649e58f56246", "url": "https://github.com/hugegraph/hugegraph/commit/2e36b201b73254c01e3833aa9d63649e58f56246", "message": "improve test\n\nChange-Id: I09dc9aad7458d17e1b7b5b76fa028edbee5501b4", "committedDate": "2020-03-31T13:48:56Z", "type": "commit"}, {"oid": "2e4b8ed1811adfac58a3894fb0cc4baf899881d9", "url": "https://github.com/hugegraph/hugegraph/commit/2e4b8ed1811adfac58a3894fb0cc4baf899881d9", "message": "adapt to rocksdb\n\nChange-Id: Ie68884edf56c552e1add6158cd82a1c3588bf6eb", "committedDate": "2020-03-31T13:48:56Z", "type": "commit"}, {"oid": "f282425ab9cb6e4c30c626759960acf66476cceb", "url": "https://github.com/hugegraph/hugegraph/commit/f282425ab9cb6e4c30c626759960acf66476cceb", "message": "adapt to mysql\n\nChange-Id: Ic83b5c55db8ea089b6adaa9491757a52a9d59cfe", "committedDate": "2020-03-31T14:03:26Z", "type": "commit"}, {"oid": "307994a84a4002da1eaea8b1964d459b68610195", "url": "https://github.com/hugegraph/hugegraph/commit/307994a84a4002da1eaea8b1964d459b68610195", "message": "adapt to memory backend\n\nChange-Id: Icf781d62b09c617c0a2585d8b389617ae4711c63", "committedDate": "2020-03-31T14:03:28Z", "type": "commit"}, {"oid": "3c403d12aab47b05d12b772b07e2096b347fcc29", "url": "https://github.com/hugegraph/hugegraph/commit/3c403d12aab47b05d12b772b07e2096b347fcc29", "message": "reset conf\n\nChange-Id: I58c646b4699f1d0653807cb7b9e0a0e2acaaa404", "committedDate": "2020-03-31T14:03:28Z", "type": "commit"}, {"oid": "3c403d12aab47b05d12b772b07e2096b347fcc29", "url": "https://github.com/hugegraph/hugegraph/commit/3c403d12aab47b05d12b772b07e2096b347fcc29", "message": "reset conf\n\nChange-Id: I58c646b4699f1d0653807cb7b9e0a0e2acaaa404", "committedDate": "2020-03-31T14:03:28Z", "type": "forcePushed"}, {"oid": "5b7b805bd108175f5ebcad8b730c029193550f65", "url": "https://github.com/hugegraph/hugegraph/commit/5b7b805bd108175f5ebcad8b730c029193550f65", "message": "fix query count with uncommitted records\n\nChange-Id: I636ff6c84444f81bdb86eb6efcb040530d85fef8", "committedDate": "2020-03-31T15:38:09Z", "type": "commit"}, {"oid": "f1d0d90ff7848c3dac2948d5ca7c55188df3c45b", "url": "https://github.com/hugegraph/hugegraph/commit/f1d0d90ff7848c3dac2948d5ca7c55188df3c45b", "message": "add option aggregation_timeout for cassandra and hbase\n\nChange-Id: I0b5a740078251b77d88b8490e9cde965bfe5696c", "committedDate": "2020-03-31T16:11:27Z", "type": "commit"}, {"oid": "6716f03e3e94253eb7b5a97c8c25b42033fc4f5a", "url": "https://github.com/hugegraph/hugegraph/commit/6716f03e3e94253eb7b5a97c8c25b42033fc4f5a", "message": "add travis log for run-api-test\n\nChange-Id: I4bb9bf21126b62bd58f3c5b1f4b1d8513c385612", "committedDate": "2020-04-03T14:03:42Z", "type": "commit"}, {"oid": "5d8d2c371c82403cc2d7c68078a9f4056ce86bf6", "url": "https://github.com/hugegraph/hugegraph/commit/5d8d2c371c82403cc2d7c68078a9f4056ce86bf6", "message": "fix jersey dependency conflict\n\nChange-Id: I7ceab1896b9b72725b1d50327aa66f4396ec8806", "committedDate": "2020-04-03T16:24:09Z", "type": "forcePushed"}, {"oid": "cf5cb55e2411730d6fbc41553fb8ed89d525ed8d", "url": "https://github.com/hugegraph/hugegraph/commit/cf5cb55e2411730d6fbc41553fb8ed89d525ed8d", "message": "fix jersey dependency conflict\n\nhadoop depend on jersey 1.9\n\nChange-Id: I7ceab1896b9b72725b1d50327aa66f4396ec8806", "committedDate": "2020-04-03T17:26:56Z", "type": "commit"}, {"oid": "cf5cb55e2411730d6fbc41553fb8ed89d525ed8d", "url": "https://github.com/hugegraph/hugegraph/commit/cf5cb55e2411730d6fbc41553fb8ed89d525ed8d", "message": "fix jersey dependency conflict\n\nhadoop depend on jersey 1.9\n\nChange-Id: I7ceab1896b9b72725b1d50327aa66f4396ec8806", "committedDate": "2020-04-03T17:26:56Z", "type": "forcePushed"}, {"oid": "e01eafa6c6ec95b6b121fb4d053309cfb2c6ae43", "url": "https://github.com/hugegraph/hugegraph/commit/e01eafa6c6ec95b6b121fb4d053309cfb2c6ae43", "message": "fix travis cache\n\nChange-Id: I78c5e14f4ed110de5d4012cb5e1c414276f628b6", "committedDate": "2020-04-03T18:07:20Z", "type": "forcePushed"}, {"oid": "3e9e2e2df53954f148d242ff0e66c7510676c032", "url": "https://github.com/hugegraph/hugegraph/commit/3e9e2e2df53954f148d242ff0e66c7510676c032", "message": "fix travis cache\n\nChange-Id: I78c5e14f4ed110de5d4012cb5e1c414276f628b6", "committedDate": "2020-04-03T18:12:24Z", "type": "forcePushed"}, {"oid": "30ba06eb1364bf0ce2ddc27b81a72a21396436a5", "url": "https://github.com/hugegraph/hugegraph/commit/30ba06eb1364bf0ce2ddc27b81a72a21396436a5", "message": "fix travis cache\n\nChange-Id: I78c5e14f4ed110de5d4012cb5e1c414276f628b6", "committedDate": "2020-04-03T18:16:51Z", "type": "forcePushed"}, {"oid": "01d72dacb4214b9ad6fa6e6d3f41b27514af171a", "url": "https://github.com/hugegraph/hugegraph/commit/01d72dacb4214b9ad6fa6e6d3f41b27514af171a", "message": "fix travis cache\n\nChange-Id: I78c5e14f4ed110de5d4012cb5e1c414276f628b6", "committedDate": "2020-04-03T18:54:29Z", "type": "forcePushed"}, {"oid": "6bfd54b85f3f8758a1ebd298ec7e7be3cf9371b2", "url": "https://github.com/hugegraph/hugegraph/commit/6bfd54b85f3f8758a1ebd298ec7e7be3cf9371b2", "message": "fix javax.servlet conflict\n\nChange-Id: I3332044f18601076e8c56b66353561ac31793ffd", "committedDate": "2020-04-04T02:06:09Z", "type": "commit"}, {"oid": "6bfd54b85f3f8758a1ebd298ec7e7be3cf9371b2", "url": "https://github.com/hugegraph/hugegraph/commit/6bfd54b85f3f8758a1ebd298ec7e7be3cf9371b2", "message": "fix javax.servlet conflict\n\nChange-Id: I3332044f18601076e8c56b66353561ac31793ffd", "committedDate": "2020-04-04T02:06:09Z", "type": "forcePushed"}, {"oid": "1164a782c7c78f3fe37fa1fcb895eb12d8d3b739", "url": "https://github.com/hugegraph/hugegraph/commit/1164a782c7c78f3fe37fa1fcb895eb12d8d3b739", "message": "specify specific exclusion names instead of wildcards\n\nChange-Id: If223f62970276e02d4c74877fae811c10afe6459", "committedDate": "2020-04-04T03:08:06Z", "type": "commit"}]}