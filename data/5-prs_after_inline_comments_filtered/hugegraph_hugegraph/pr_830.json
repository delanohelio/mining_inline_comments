{"pr_number": 830, "pr_title": "Fix mac check bug", "pr_createdAt": "2020-01-14T09:31:26Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/830", "timeline": [{"oid": "9dfc064c8ac65aaf2d5d58318ae2a439c8a12aa4", "url": "https://github.com/hugegraph/hugegraph/commit/9dfc064c8ac65aaf2d5d58318ae2a439c8a12aa4", "message": "Fix mac check bug\n\nChange-Id: If7df1f3906b334bdf82523a07f4a1fa040f729d3", "committedDate": "2020-01-14T09:43:49Z", "type": "commit"}, {"oid": "9dfc064c8ac65aaf2d5d58318ae2a439c8a12aa4", "url": "https://github.com/hugegraph/hugegraph/commit/9dfc064c8ac65aaf2d5d58318ae2a439c8a12aa4", "message": "Fix mac check bug\n\nChange-Id: If7df1f3906b334bdf82523a07f4a1fa040f729d3", "committedDate": "2020-01-14T09:43:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NTUwMQ==", "url": "https://github.com/hugegraph/hugegraph/pull/830#discussion_r366695501", "bodyText": "The mac must be not empty here", "author": "javeme", "createdAt": "2020-01-15T04:54:54Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/license/LicenseVerifyManager.java", "diffHunk": "@@ -177,20 +175,40 @@ private void checkIpAndMac(ExtraParam param) {\n         if (StringUtils.isEmpty(expectMac)) {\n             return;\n         }\n-        String actualMac;\n-        try {\n-            actualMac = this.machineInfo.getMacByInetAddress(\n-                        InetAddress.getByName(expectIp));\n-        } catch (UnknownHostException e) {\n-            throw newLicenseException(\n-                  \"Failed to get mac address for ip '%s'\", expectIp);\n-        }\n-        String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n-        String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n-        if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n-            throw newLicenseException(\n-                  \"The server's mac '%s' doesn't match the authorized '%s'\",\n-                  actualMac, expectMac);\n+\n+        // Mac must not empty", "originalCommit": "9dfc064c8ac65aaf2d5d58318ae2a439c8a12aa4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NTc3NQ==", "url": "https://github.com/hugegraph/hugegraph/pull/830#discussion_r366695775", "bodyText": "move to line 200", "author": "javeme", "createdAt": "2020-01-15T04:56:39Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/license/LicenseVerifyManager.java", "diffHunk": "@@ -177,20 +175,40 @@ private void checkIpAndMac(ExtraParam param) {\n         if (StringUtils.isEmpty(expectMac)) {\n             return;\n         }\n-        String actualMac;\n-        try {\n-            actualMac = this.machineInfo.getMacByInetAddress(\n-                        InetAddress.getByName(expectIp));\n-        } catch (UnknownHostException e) {\n-            throw newLicenseException(\n-                  \"Failed to get mac address for ip '%s'\", expectIp);\n-        }\n-        String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n-        String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n-        if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n-            throw newLicenseException(\n-                  \"The server's mac '%s' doesn't match the authorized '%s'\",\n-                  actualMac, expectMac);\n+\n+        // Mac must not empty\n+        if (!StringUtils.isEmpty(expectIp)) {\n+            String actualMac;\n+            try {\n+                actualMac = this.machineInfo.getMacByInetAddress(\n+                            InetAddress.getByName(expectIp));\n+            } catch (UnknownHostException e) {\n+                throw newLicenseException(\n+                      \"Failed to get mac address for ip '%s'\", expectIp);\n+            }\n+            String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n+            String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n+            if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n+                throw newLicenseException(\n+                      \"The server's mac '%s' doesn't match the authorized '%s'\",\n+                      actualMac, expectMac);\n+            }\n+        } else {\n+            matched = false;", "originalCommit": "9dfc064c8ac65aaf2d5d58318ae2a439c8a12aa4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NTgyMQ==", "url": "https://github.com/hugegraph/hugegraph/pull/830#discussion_r366695821", "bodyText": "why not keep \":\"", "author": "javeme", "createdAt": "2020-01-15T04:56:58Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/license/LicenseVerifyManager.java", "diffHunk": "@@ -177,20 +175,40 @@ private void checkIpAndMac(ExtraParam param) {\n         if (StringUtils.isEmpty(expectMac)) {\n             return;\n         }\n-        String actualMac;\n-        try {\n-            actualMac = this.machineInfo.getMacByInetAddress(\n-                        InetAddress.getByName(expectIp));\n-        } catch (UnknownHostException e) {\n-            throw newLicenseException(\n-                  \"Failed to get mac address for ip '%s'\", expectIp);\n-        }\n-        String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n-        String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n-        if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n-            throw newLicenseException(\n-                  \"The server's mac '%s' doesn't match the authorized '%s'\",\n-                  actualMac, expectMac);\n+\n+        // Mac must not empty\n+        if (!StringUtils.isEmpty(expectIp)) {\n+            String actualMac;\n+            try {\n+                actualMac = this.machineInfo.getMacByInetAddress(\n+                            InetAddress.getByName(expectIp));\n+            } catch (UnknownHostException e) {\n+                throw newLicenseException(\n+                      \"Failed to get mac address for ip '%s'\", expectIp);\n+            }\n+            String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n+            String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n+            if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n+                throw newLicenseException(\n+                      \"The server's mac '%s' doesn't match the authorized '%s'\",\n+                      actualMac, expectMac);\n+            }\n+        } else {\n+            matched = false;\n+            String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n+            List<String> actualMacs = this.machineInfo.getMacAddress();\n+            for (String actualMac : actualMacs) {\n+                String actualFormatMac = actualMac.replaceAll(\":\", \"-\");", "originalCommit": "9dfc064c8ac65aaf2d5d58318ae2a439c8a12aa4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU1MzExNA==", "url": "https://github.com/hugegraph/hugegraph/pull/830#discussion_r374553114", "bodyText": "There may be two kinds of join symbols in the mac address, ':' and '-', they are both valid. To avoid check failures due to symbol mismatches, so unified the symbol to '-'", "author": "Linary", "createdAt": "2020-02-04T09:19:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjY5NTgyMQ=="}], "type": "inlineReview"}, {"oid": "f4ef00e3b43fccdcac56152a713bcd78d13194f7", "url": "https://github.com/hugegraph/hugegraph/commit/f4ef00e3b43fccdcac56152a713bcd78d13194f7", "message": "tiny improve\n\nChange-Id: I4a7fff3a8378f0bf10949005f94e40debce64b19", "committedDate": "2020-02-04T09:06:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MTQ4OQ==", "url": "https://github.com/hugegraph/hugegraph/pull/830#discussion_r374641489", "bodyText": "change to \"The server's macs '%s' don't\"\nalign with newLicenseException", "author": "zhoney", "createdAt": "2020-02-04T12:28:30Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/license/LicenseVerifyManager.java", "diffHunk": "@@ -177,20 +175,40 @@ private void checkIpAndMac(ExtraParam param) {\n         if (StringUtils.isEmpty(expectMac)) {\n             return;\n         }\n-        String actualMac;\n-        try {\n-            actualMac = this.machineInfo.getMacByInetAddress(\n-                        InetAddress.getByName(expectIp));\n-        } catch (UnknownHostException e) {\n-            throw newLicenseException(\n-                  \"Failed to get mac address for ip '%s'\", expectIp);\n-        }\n-        String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n-        String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n-        if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n-            throw newLicenseException(\n-                  \"The server's mac '%s' doesn't match the authorized '%s'\",\n-                  actualMac, expectMac);\n+\n+        // The mac must be not empty here\n+        if (!StringUtils.isEmpty(expectIp)) {\n+            String actualMac;\n+            try {\n+                actualMac = this.machineInfo.getMacByInetAddress(\n+                            InetAddress.getByName(expectIp));\n+            } catch (UnknownHostException e) {\n+                throw newLicenseException(\n+                      \"Failed to get mac address for ip '%s'\", expectIp);\n+            }\n+            String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n+            String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n+            if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n+                throw newLicenseException(\n+                      \"The server's mac '%s' doesn't match the authorized '%s'\",\n+                      actualMac, expectMac);\n+            }\n+        } else {\n+            String expectFormatMac = expectMac.replaceAll(\":\", \"-\");\n+            List<String> actualMacs = this.machineInfo.getMacAddress();\n+            matched = false;\n+            for (String actualMac : actualMacs) {\n+                String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n+                if (actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n+                    matched = true;\n+                    break;\n+                }\n+            }\n+            if (!matched) {\n+                throw newLicenseException(\n+                        \"The server's mac '%s' doesn't match the authorized '%s'\",", "originalCommit": "f4ef00e3b43fccdcac56152a713bcd78d13194f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d8f2833f158d7ae7435613d1443c588512676635", "url": "https://github.com/hugegraph/hugegraph/commit/d8f2833f158d7ae7435613d1443c588512676635", "message": "tiny improve\n\nChange-Id: Ib2413bc1f215a964c890bb98909575f0d756f400", "committedDate": "2020-02-04T12:32:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NjU5Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/830#discussion_r374646597", "bodyText": "macs '%s' => macs %s", "author": "javeme", "createdAt": "2020-02-04T12:39:58Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/license/LicenseVerifyManager.java", "diffHunk": "@@ -206,8 +206,8 @@ private void checkIpAndMac(ExtraParam param) {\n             }\n             if (!matched) {\n                 throw newLicenseException(\n-                        \"The server's mac '%s' doesn't match the authorized '%s'\",\n-                        actualMacs, expectMac);\n+                      \"The server's macs '%s' don't match the authorized '%s'\",", "originalCommit": "d8f2833f158d7ae7435613d1443c588512676635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0NzQyOA==", "url": "https://github.com/hugegraph/hugegraph/pull/830#discussion_r374647428", "bodyText": "keep origin message \"The server's mac '%s' doesn't...\"", "author": "javeme", "createdAt": "2020-02-04T12:41:24Z", "path": "hugegraph-api/src/main/java/com/baidu/hugegraph/license/LicenseVerifyManager.java", "diffHunk": "@@ -190,7 +190,7 @@ private void checkIpAndMac(ExtraParam param) {\n             String actualFormatMac = actualMac.replaceAll(\":\", \"-\");\n             if (!actualFormatMac.equalsIgnoreCase(expectFormatMac)) {\n                 throw newLicenseException(\n-                      \"The server's mac '%s' doesn't match the authorized '%s'\",\n+                      \"The server's macs '%s' don't match the authorized '%s'\",", "originalCommit": "d8f2833f158d7ae7435613d1443c588512676635", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7ea4859277bd6aeaf8762fd02d636ecb11b54d54", "url": "https://github.com/hugegraph/hugegraph/commit/7ea4859277bd6aeaf8762fd02d636ecb11b54d54", "message": "message improve\n\nChange-Id: I9bdbba070f763d9a6a69c1152401097dd61e844e", "committedDate": "2020-02-05T09:59:14Z", "type": "forcePushed"}, {"oid": "8452eae702b3a23fda2d5c9bb6f46a4eaedd523b", "url": "https://github.com/hugegraph/hugegraph/commit/8452eae702b3a23fda2d5c9bb6f46a4eaedd523b", "message": "message improve\n\nChange-Id: I9bdbba070f763d9a6a69c1152401097dd61e844e", "committedDate": "2020-02-05T10:11:02Z", "type": "forcePushed"}, {"oid": "e54bc6b9a59fab9fce11cc7f1f14b7fff50e69ea", "url": "https://github.com/hugegraph/hugegraph/commit/e54bc6b9a59fab9fce11cc7f1f14b7fff50e69ea", "message": "message improve\n\nChange-Id: I9bdbba070f763d9a6a69c1152401097dd61e844e", "committedDate": "2020-02-05T12:14:42Z", "type": "forcePushed"}, {"oid": "4a7f0faaad9c3175f8f14a99d66a506e96fb50b0", "url": "https://github.com/hugegraph/hugegraph/commit/4a7f0faaad9c3175f8f14a99d66a506e96fb50b0", "message": "message improve\n\nChange-Id: I9bdbba070f763d9a6a69c1152401097dd61e844e", "committedDate": "2020-02-05T12:43:49Z", "type": "commit"}, {"oid": "4a7f0faaad9c3175f8f14a99d66a506e96fb50b0", "url": "https://github.com/hugegraph/hugegraph/commit/4a7f0faaad9c3175f8f14a99d66a506e96fb50b0", "message": "message improve\n\nChange-Id: I9bdbba070f763d9a6a69c1152401097dd61e844e", "committedDate": "2020-02-05T12:43:49Z", "type": "forcePushed"}]}