{"pr_number": 974, "pr_title": "Hbase shard improve and implement mysql/memory shard", "pr_createdAt": "2020-04-27T13:41:36Z", "pr_url": "https://github.com/hugegraph/hugegraph/pull/974", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg0NjY3Mg==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r417846672", "bodyText": "0L", "author": "javeme", "createdAt": "2020-04-30T08:35:27Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/memory/InMemoryDBTable.java", "diffHunk": "@@ -277,4 +319,26 @@ private static boolean matchCondition(BackendEntry item, Condition c) {\n         }\n         return false;\n     }\n+\n+    private class InMemoryShardSpliter extends ShardSpliter {\n+\n+        public InMemoryShardSpliter(String table) {\n+            super(table);\n+        }\n+\n+        @Override\n+        protected long maxKey() {\n+            return InMemoryDBTable.this.store.size();\n+        }\n+\n+        @Override\n+        protected long estimateDataSize(BackendSession session) {\n+            return 0;", "originalCommit": "3f4bdb555cdfeeb0488000e4415c759d954999ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg4MjYyMA==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r417882620", "bodyText": "move to fetch()", "author": "javeme", "createdAt": "2020-04-30T09:36:39Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/BackendEntryIterator.java", "diffHunk": "@@ -80,9 +80,17 @@ public BackendEntry next() {\n \n         this.current = null;\n         this.count += this.sizeOf(current);\n+        if (this.query.paging() && !this.query.nolimit() &&\n+            this.count > this.query.limit()) {\n+            this.reduce2limit(current);", "originalCommit": "3f4bdb555cdfeeb0488000e4415c759d954999ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5NTk3Nw==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r417895977", "bodyText": "TODO: unify format\nat least unify start and end", "author": "javeme", "createdAt": "2020-04-30T09:59:56Z", "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/EdgeCoreTest.java", "diffHunk": "@@ -3326,8 +3327,18 @@ public void testScanEdgeInPaging() {\n         List<Edge> edges = new LinkedList<>();\n \n         ConditionQuery query = new ConditionQuery(HugeType.EDGE);\n-        query.scan(String.valueOf(Long.MIN_VALUE),\n-                   String.valueOf(Long.MAX_VALUE));\n+\n+        String backend = graph.backend();\n+        if (backend.equals(\"hbase\")) {\n+            query.scan(\"00\", BackendTable.ShardSpliter.END);\n+        } else if (backend.equals(\"mysql\") || backend.equals(\"postgresql\")) {\n+            query.scan(BackendTable.ShardSpliter.END,\n+                       BackendTable.ShardSpliter.END);\n+        } else {\n+            query.scan(String.valueOf(Long.MIN_VALUE),\n+                       String.valueOf(Long.MAX_VALUE));\n+        }", "originalCommit": "3f4bdb555cdfeeb0488000e4415c759d954999ee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NzExNA==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r420797114", "bodyText": "set START=END=\"\"\nand just set cassandra as long value", "author": "javeme", "createdAt": "2020-05-06T13:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5NTk3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5ODA2MA==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r417898060", "bodyText": "improve code", "author": "javeme", "createdAt": "2020-04-30T10:03:50Z", "path": "hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlTable.java", "diffHunk": "@@ -389,6 +411,65 @@ public Number queryNumber(Session session, Query query) {\n         return selections;\n     }\n \n+    protected StringBuilder queryByRange(ConditionQuery query,\n+                                         StringBuilder select) {\n+        E.checkArgument(query.relations().size() == 1,\n+                        \"Invalid scan with multi conditions: %s\", query);\n+        Condition.Relation scan = query.relations().iterator().next();\n+        Shard shard = (Shard) scan.value();\n+\n+        String page = query.page();\n+        if (MysqlShardSpliter.END.equals(shard.start()) &&\n+            MysqlShardSpliter.END.equals(shard.end()) &&\n+            (page == null || page.isEmpty())) {\n+            select.append(this.orderByKeys());\n+            if (!query.nolimit()) {\n+                // Fetch `limit + 1` rows for judging whether reached the last page\n+                select.append(\" limit \");\n+                select.append(query.limit() + 1);\n+            }\n+            select.append(\";\");\n+            return select;\n+        }\n+\n+        // < end\n+        HugeKeys partitionKey = this.idColumnName().get(0);\n+        WhereBuilder where = this.newWhereBuilder();\n+        boolean prefixAnd = true;\n+        if (!MysqlShardSpliter.END.equals(shard.end())) {\n+            where.lt(formatKey(partitionKey), shard.end());\n+        } else {\n+            prefixAnd = false;\n+        }\n+        select.append(where.build());\n+\n+        if (page != null && !page.isEmpty()) {\n+            // >= page\n+            wrapPage(select, query, prefixAnd);\n+        } else {\n+            // >= start\n+            if (!MysqlShardSpliter.END.equals(shard.start())) {\n+                if (prefixAnd) {\n+                    select.append(\" AND \");\n+                }\n+                where = this.newWhereBuilder(false);\n+                where.gte(formatKey(partitionKey), shard.start());\n+                select.append(where.build());\n+            }\n+\n+            select.append(this.orderByKeys());\n+\n+            if (!query.nolimit()) {\n+                // Fetch `limit + 1` rows for judging whether reached the last page\n+                select.append(\" limit \");\n+                select.append(query.limit() + 1);\n+            }\n+            select.append(\";\");\n+        }\n+\n+        return select;\n+    }", "originalCommit": "3f4bdb555cdfeeb0488000e4415c759d954999ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg5ODIzOQ==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r417898239", "bodyText": "ditto", "author": "javeme", "createdAt": "2020-04-30T10:04:08Z", "path": "hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlEntryIterator.java", "diffHunk": "@@ -86,6 +86,14 @@ protected final boolean fetch() {\n         return this.current != null;\n     }\n \n+    @Override\n+    protected void reduce2limit(BackendEntry entry) {\n+        MysqlBackendEntry e = (MysqlBackendEntry) entry;\n+        int size = e.subRows().size();\n+        // Remove last paging row\n+        e.subRows().remove(size - 1);\n+    }", "originalCommit": "3f4bdb555cdfeeb0488000e4415c759d954999ee", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NDcxNg==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r420794716", "bodyText": "this.wrapLimit", "author": "javeme", "createdAt": "2020-05-06T13:35:32Z", "path": "hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlTable.java", "diffHunk": "@@ -402,7 +402,8 @@ public Number queryNumber(Session session, Query query) {\n                 this.wrapOrderBy(selection, query);\n             }\n             if (query.paging()) {\n-                this.wrapPage(selection, query);\n+                this.wrapPage(selection, query, false);\n+                wrapLimit(selection, query);", "originalCommit": "79e6e22c3f8e8169d9a845ceee82e5dd41027111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NTA0Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r420795043", "bodyText": "this.wrapPage", "author": "javeme", "createdAt": "2020-05-06T13:35:54Z", "path": "hugegraph-mysql/src/main/java/com/baidu/hugegraph/backend/store/mysql/MysqlTable.java", "diffHunk": "@@ -422,50 +423,40 @@ protected StringBuilder queryByRange(ConditionQuery query,\n         if (MysqlShardSpliter.END.equals(shard.start()) &&\n             MysqlShardSpliter.END.equals(shard.end()) &&\n             (page == null || page.isEmpty())) {\n-            select.append(this.orderByKeys());\n-            if (!query.nolimit()) {\n-                // Fetch `limit + 1` rows for judging whether reached the last page\n-                select.append(\" limit \");\n-                select.append(query.limit() + 1);\n-            }\n-            select.append(\";\");\n+            this.wrapLimit(select, query);\n             return select;\n         }\n \n-        // < end\n         HugeKeys partitionKey = this.idColumnName().get(0);\n-        WhereBuilder where = this.newWhereBuilder();\n-        boolean prefixAnd = true;\n-        if (!MysqlShardSpliter.END.equals(shard.end())) {\n-            where.lt(formatKey(partitionKey), shard.end());\n-        } else {\n-            prefixAnd = false;\n-        }\n-        select.append(where.build());\n \n         if (page != null && !page.isEmpty()) {\n             // >= page\n-            wrapPage(select, query, prefixAnd);\n+            wrapPage(select, query, true);", "originalCommit": "79e6e22c3f8e8169d9a845ceee82e5dd41027111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc5NzI5Mw==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r420797293", "bodyText": "ditto", "author": "javeme", "createdAt": "2020-05-06T13:38:56Z", "path": "hugegraph-test/src/main/java/com/baidu/hugegraph/core/VertexCoreTest.java", "diffHunk": "@@ -5034,10 +5035,19 @@ public void testScanVertexInPaging() {\n         init10Vertices();\n \n         List<Vertex> vertices = new LinkedList<>();\n-\n         ConditionQuery query = new ConditionQuery(HugeType.VERTEX);\n-        query.scan(String.valueOf(Long.MIN_VALUE),\n-                   String.valueOf(Long.MAX_VALUE));\n+\n+        String backend = graph.backend();\n+        if (backend.equals(\"hbase\")) {\n+            query.scan(\"00\", BackendTable.ShardSpliter.END);\n+        } else if (backend.equals(\"mysql\") || backend.equals(\"postgresql\")) {\n+            query.scan(BackendTable.ShardSpliter.END,\n+                       BackendTable.ShardSpliter.END);", "originalCommit": "79e6e22c3f8e8169d9a845ceee82e5dd41027111", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "27496d5491c389cd30e4cca858db0dd98aa7b74b", "url": "https://github.com/hugegraph/hugegraph/commit/27496d5491c389cd30e4cca858db0dd98aa7b74b", "message": "improve rocksdb shard by get first and last row key\n\nChange-Id: Id3bf5d13cc3a6cd98e2710e1fb0abefc4afa349f", "committedDate": "2020-05-09T04:06:41Z", "type": "forcePushed"}, {"oid": "750d0374384fe0650637f534dbd23cd870e522b5", "url": "https://github.com/hugegraph/hugegraph/commit/750d0374384fe0650637f534dbd23cd870e522b5", "message": "improve rocksdb shard by get first and last row key\n\nChange-Id: Id3bf5d13cc3a6cd98e2710e1fb0abefc4afa349f", "committedDate": "2020-05-13T03:10:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4MzI1MA==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r424583250", "bodyText": "keyRange", "author": "javeme", "createdAt": "2020-05-13T16:46:01Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBSessions.java", "diffHunk": "@@ -63,6 +64,7 @@ public abstract RocksDBSessions copy(HugeConfig config,\n         public static final int SCAN_LTE_END = 0x30;\n \n         public abstract String property(String table, String property);\n+        public abstract Pair<byte[], byte[]> getKeyRange(String table);", "originalCommit": "750d0374384fe0650637f534dbd23cd870e522b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NDM1Ng==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r424584356", "bodyText": "return Pair.of(startKey, null);", "author": "javeme", "createdAt": "2020-05-13T16:47:39Z", "path": "hugegraph-rocksdb/src/main/java/com/baidu/hugegraph/backend/store/rocksdb/RocksDBStdSessions.java", "diffHunk": "@@ -603,6 +604,25 @@ public String property(String table, String property) {\n             }\n         }\n \n+        @Override\n+        public Pair<byte[], byte[]> getKeyRange(String table) {\n+            byte[] startKey, endKey;\n+            try (CFHandle cf = cf(table);\n+                 RocksIterator iter = rocksdb().newIterator(cf.get())) {\n+                iter.seekToFirst();\n+                if (!iter.isValid()) {\n+                    return null;\n+                }\n+                startKey = iter.key();\n+                iter.seekToLast();\n+                if (!iter.isValid()) {\n+                    return null;", "originalCommit": "750d0374384fe0650637f534dbd23cd870e522b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDU4NTQyMg==", "url": "https://github.com/hugegraph/hugegraph/pull/974#discussion_r424585422", "bodyText": "align", "author": "javeme", "createdAt": "2020-05-13T16:49:20Z", "path": "hugegraph-core/src/main/java/com/baidu/hugegraph/backend/store/BackendTable.java", "diffHunk": "@@ -127,7 +131,17 @@ public static final String joinTableName(String prefix, String table) {\n         // We assume the size of each key-value is 100 bytes\n         protected static final int ESTIMATE_BYTES_PER_KV = 100;\n \n-        public static final String END = \"-1\";\n+        public static final String START = \"\";\n+        public static final String END = \"\";\n+\n+        private static final byte[] EMPTY = new byte[0];\n+        public static final byte[] START_BYTES = new byte[]{0x0};\n+        public static final byte[] END_BYTES = new byte[]{\n+                -1, -1, -1, -1, -1, -1, -1, -1,", "originalCommit": "750d0374384fe0650637f534dbd23cd870e522b5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "22224e9a92244538907fdbce84ed2ef8d6d7845e", "url": "https://github.com/hugegraph/hugegraph/commit/22224e9a92244538907fdbce84ed2ef8d6d7845e", "message": "improve hbase shard with region start/end key\n\nChange-Id: I5a660a08239f63b7da4cc382d6ddb449d1532e5f", "committedDate": "2020-05-14T03:09:04Z", "type": "commit"}, {"oid": "e478009f46634f663d9aa875f89a26b03662a789", "url": "https://github.com/hugegraph/hugegraph/commit/e478009f46634f663d9aa875f89a26b03662a789", "message": "support shard for mysql and memory backend\n\nChange-Id: Ibb840388667a0ed3e57b965ff607427ff429dcf9", "committedDate": "2020-05-14T03:09:04Z", "type": "commit"}, {"oid": "40840e6ef4f526c8366b2cbce893ab68eb007c10", "url": "https://github.com/hugegraph/hugegraph/commit/40840e6ef4f526c8366b2cbce893ab68eb007c10", "message": "improve hbase and rocksdb shards end\n\nChange-Id: I4dbfd4b726c715cc2f00816d574ae438d1300b2c", "committedDate": "2020-05-14T03:09:04Z", "type": "commit"}, {"oid": "b7d9fb27cd9ea5fa39e5a2ef7cd148dc84175071", "url": "https://github.com/hugegraph/hugegraph/commit/b7d9fb27cd9ea5fa39e5a2ef7cd148dc84175071", "message": "improve\n\nChange-Id: Ie146c5abe98b441ecd67de8e5d04900e46e72471", "committedDate": "2020-05-14T03:09:04Z", "type": "commit"}, {"oid": "58e3ec3c4a9dd787b6ebdb9099c7ffb1d13bdcc9", "url": "https://github.com/hugegraph/hugegraph/commit/58e3ec3c4a9dd787b6ebdb9099c7ffb1d13bdcc9", "message": "fix mysql/postgresql mistakenly return paging edge row\n\nChange-Id: I9d478119d343dc9aab5bd38680090f9b6175dc9e", "committedDate": "2020-05-14T03:09:04Z", "type": "commit"}, {"oid": "8181b96430fcb5cf5ba9d31cd49eedcb9a768e8f", "url": "https://github.com/hugegraph/hugegraph/commit/8181b96430fcb5cf5ba9d31cd49eedcb9a768e8f", "message": "improve\n\nChange-Id: I0e58d0b1c7947ac3ad10a59d052e87066dce0b67", "committedDate": "2020-05-14T03:16:16Z", "type": "commit"}, {"oid": "dd7726c63a84f3cb6beaf4e7077e48f6d71139ea", "url": "https://github.com/hugegraph/hugegraph/commit/dd7726c63a84f3cb6beaf4e7077e48f6d71139ea", "message": "improve rocksdb shard by get first and last row key\n\nChange-Id: Id3bf5d13cc3a6cd98e2710e1fb0abefc4afa349f", "committedDate": "2020-05-14T03:17:26Z", "type": "commit"}, {"oid": "4405da15921e28726ac13fa08c2bee9024cd6bd0", "url": "https://github.com/hugegraph/hugegraph/commit/4405da15921e28726ac13fa08c2bee9024cd6bd0", "message": "improve\n\nChange-Id: I6c98ba38bd8e2439dcab21d4cdca3eba04358e92", "committedDate": "2020-05-14T03:25:44Z", "type": "commit"}, {"oid": "4405da15921e28726ac13fa08c2bee9024cd6bd0", "url": "https://github.com/hugegraph/hugegraph/commit/4405da15921e28726ac13fa08c2bee9024cd6bd0", "message": "improve\n\nChange-Id: I6c98ba38bd8e2439dcab21d4cdca3eba04358e92", "committedDate": "2020-05-14T03:25:44Z", "type": "forcePushed"}]}