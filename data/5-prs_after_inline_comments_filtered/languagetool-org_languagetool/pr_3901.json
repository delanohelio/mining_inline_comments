{"pr_number": 3901, "pr_title": "HunspellRule: calculate suggestions lazily", "pr_createdAt": "2020-11-20T12:11:18Z", "pr_url": "https://github.com/languagetool-org/languagetool/pull/3901", "timeline": [{"oid": "1b7270895577d7c042fce8f4f813c5273ce05f24", "url": "https://github.com/languagetool-org/languagetool/commit/1b7270895577d7c042fce8f4f813c5273ce05f24", "message": "HunspellRule: calculate suggestions lazily", "committedDate": "2020-11-20T12:10:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzODI2Mg==", "url": "https://github.com/languagetool-org/languagetool/pull/3901#discussion_r529538262", "bodyText": "Do you know when this can happen? I wonder whether it makes sense to give out the error. in general, we tend to throw an exception instead.", "author": "danielnaber", "createdAt": "2020-11-24T13:19:17Z", "path": "languagetool-core/src/main/java/org/languagetool/rules/spelling/hunspell/HunspellRule.java", "diffHunk": "@@ -181,59 +181,16 @@ protected boolean isQuotedCompound (AnalyzedSentence analyzedSentence, int idx,\n             messages.getString(\"desc_spelling_short\"));\n           ruleMatch.setType(RuleMatch.Type.UnknownWord);\n           if (userConfig == null || userConfig.getMaxSpellingSuggestions() == 0 || ruleMatches.size() <= userConfig.getMaxSpellingSuggestions()) {\n-            List<SuggestedReplacement> suggestions = SuggestedReplacement.convert(getSuggestions(cleanWord));\n-            if (word.endsWith(\".\")) {\n-              int pos = 1;\n-              for (String suggestion : getSuggestions(word)) {\n-                if (!suggestions.contains(suggestion)) {\n-                  suggestions.add(Math.min(pos, suggestions.size()), new SuggestedReplacement(suggestion.substring(0, suggestion.length()-1)));\n-                  pos += 2;  // we mix the lists, as we don't know which one is the better one\n+            ruleMatch.setLazySuggestedReplacements(() -> {\n+              try {\n+                synchronized (this) { // some getSuggestions overrides are thread-unsafe\n+                  return calcSuggestions(word, cleanWord);\n                 }\n+              } catch (IOException e) {\n+                logger.error(\"Error while calculating speller suggestions\", e);\n+                return Collections.singletonList(new SuggestedReplacement(\"Internal error: \" + e.getMessage()));", "originalCommit": "1b7270895577d7c042fce8f4f813c5273ce05f24", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU1MzgxMg==", "url": "https://github.com/languagetool-org/languagetool/pull/3901#discussion_r529553812", "bodyText": "The exception can be thrown from init(), but it seems init should be already done by the time getSuggestions is called (at least in the current codebase, I can imagine someone calling getSuggestions explicitly without preceding match). So if you believe it's safe, I can remove needsInit checks from getSuggestions.\nMy idea with message was to give users indication that something went wrong. I can rethrow a RuntimeException if you think it's better. MorfologikSpellerRule#appendLazySuggestions would need to be changed as well.", "author": "donnerpeter", "createdAt": "2020-11-24T13:43:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzODI2Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU1NTc4Nw==", "url": "https://github.com/languagetool-org/languagetool/pull/3901#discussion_r529555787", "bodyText": "I can rethrow a RuntimeException if you think it's better.\n\nYes, I think it's better to go with the \"fail early\" approach that serves us well so far.", "author": "danielnaber", "createdAt": "2020-11-24T13:45:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTUzODI2Mg=="}], "type": "inlineReview"}, {"oid": "4c770b24fd39771ca493c49a9af9bc35185c481d", "url": "https://github.com/languagetool-org/languagetool/commit/4c770b24fd39771ca493c49a9af9bc35185c481d", "message": "hunspell/morfologik lazy suggestions: wrap IOExceptions instead of logging them", "committedDate": "2020-11-24T13:51:36Z", "type": "commit"}]}