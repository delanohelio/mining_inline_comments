{"pr_number": 5328, "pr_title": "Added \"not enough space dialog\"", "pr_createdAt": "2020-01-27T14:33:56Z", "pr_url": "https://github.com/nextcloud/android/pull/5328", "timeline": [{"oid": "8e09c99f1ff7a040b76e0fe4bc8b403ebb9a3ca2", "url": "https://github.com/nextcloud/android/commit/8e09c99f1ff7a040b76e0fe4bc8b403ebb9a3ca2", "message": "Added dialog when sync is too heavy for device (unfinished)", "committedDate": "2020-01-24T13:19:40Z", "type": "commit"}, {"oid": "5c146d4f08f37c4bf813f44dd5261c011f1562ca", "url": "https://github.com/nextcloud/android/commit/5c146d4f08f37c4bf813f44dd5261c011f1562ca", "message": "Added translations for dialog", "committedDate": "2020-01-24T13:37:15Z", "type": "commit"}, {"oid": "9fac55da6b158aca95da8bab7f1e41c20d0a8da2", "url": "https://github.com/nextcloud/android/commit/9fac55da6b158aca95da8bab7f1e41c20d0a8da2", "message": "Added args for SyncFileNotEnoughSpaceFragment (unfinished)\n\nCaption support is missing", "committedDate": "2020-01-24T14:08:03Z", "type": "commit"}, {"oid": "03a307825d53ca1024cc8d723691d1b30fa2ac1f", "url": "https://github.com/nextcloud/android/commit/03a307825d53ca1024cc8d723691d1b30fa2ac1f", "message": "Finished \"Not Enough Space\" dialog + Optimized UX", "committedDate": "2020-01-27T14:29:46Z", "type": "commit"}, {"oid": "56076dfd96c7f2a75e763a91f117d039bdd5f96d", "url": "https://github.com/nextcloud/android/commit/56076dfd96c7f2a75e763a91f117d039bdd5f96d", "message": "small typo enhancements\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-01-28T10:26:41Z", "type": "commit"}, {"oid": "54f30670dde6cfd62ffcdcba0bc60393b95909f6", "url": "https://github.com/nextcloud/android/commit/54f30670dde6cfd62ffcdcba0bc60393b95909f6", "message": "Removed translatable attribute from strings\n\nSigned-off-by: Kilian P\u00e9risset <kilian.perisset@infomaniak.com>", "committedDate": "2020-01-28T12:28:54Z", "type": "commit"}, {"oid": "1c44f2003dcdf9abe645c80259bd4bbbb7510adc", "url": "https://github.com/nextcloud/android/commit/1c44f2003dcdf9abe645c80259bd4bbbb7510adc", "message": "Removed codacy issues", "committedDate": "2020-01-28T12:59:24Z", "type": "commit"}, {"oid": "e3c19410c810846988493480dea274a6845a75b1", "url": "https://github.com/nextcloud/android/commit/e3c19410c810846988493480dea274a6845a75b1", "message": "Removed redundant code for Codacy grade", "committedDate": "2020-01-28T13:05:50Z", "type": "commit"}, {"oid": "8737d9b835c5d659b79fcf4f3b07bd4922a493d0", "url": "https://github.com/nextcloud/android/commit/8737d9b835c5d659b79fcf4f3b07bd4922a493d0", "message": "add ui test\n- some small code changes\n- removed unneeded code\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-01-28T15:02:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEwNzQ3Mg==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r372107472", "bodyText": "Please consider hasEnoughSpace.", "author": "ezaquarii", "createdAt": "2020-01-28T23:02:12Z", "path": "src/main/java/com/owncloud/android/ui/helpers/FileOperationsHelper.java", "diffHunk": "@@ -1043,5 +1039,22 @@ public static String getCapturedImageName() {\n         return new SimpleDateFormat(\"yyyy-MM-dd_HHmmss\", Locale.US).format(new Date()) + \".jpg\";\n     }\n \n+    public static Pair<Boolean, Long> isSpaceEnough(OCFile file) {", "originalCommit": "e3c19410c810846988493480dea274a6845a75b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjEwOTQxOQ==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r372109419", "bodyText": "I'd consider a data class with named fields:\ndata class AvailableSpace(val hasEnoughSpace: Boolean, val availableSpace: Long)\nor somehting similar (this is Kotlin, btw).\nPair is pretty useful concept in general, but the first and second field names are less than helpful when reading. I guess this is why Java did not ship Pair at all, argumenting that one should just create a well-named type instead.\nIf you believe that we should use Pair anyway, please consider using the class available in Kotlin stdlib instead of Android platform API, which gives us headaches during testing.", "author": "ezaquarii", "createdAt": "2020-01-28T23:07:48Z", "path": "src/main/java/com/owncloud/android/ui/helpers/FileOperationsHelper.java", "diffHunk": "@@ -1043,5 +1039,22 @@ public static String getCapturedImageName() {\n         return new SimpleDateFormat(\"yyyy-MM-dd_HHmmss\", Locale.US).format(new Date()) + \".jpg\";\n     }\n \n+    public static Pair<Boolean, Long> isSpaceEnough(OCFile file) {\n+        StatFs stat = new StatFs(Environment.getExternalStorageDirectory().getPath());\n+        long availableBytesOnDevice;\n+        if (android.os.Build.VERSION.SDK_INT >=\n+            android.os.Build.VERSION_CODES.JELLY_BEAN_MR2) {\n+            availableBytesOnDevice = stat.getBlockSizeLong() * stat.getAvailableBlocksLong();\n+        }\n+        else {\n+            availableBytesOnDevice = (long) stat.getBlockSize() * (long) stat.getAvailableBlocks();\n+        }\n+\n+        boolean isSpaceEnough = file.getFileLength() < availableBytesOnDevice;\n+\n+        return new Pair<>(isSpaceEnough, availableBytesOnDevice);", "originalCommit": "e3c19410c810846988493480dea274a6845a75b1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d5e3da126bda11b883a53d0b04e3d162c920d74", "url": "https://github.com/nextcloud/android/commit/9d5e3da126bda11b883a53d0b04e3d162c920d74", "message": "Merge remote-tracking branch 'origin/fix/not-enough-space-dialog' into fix/not-enough-space-dialog\n\n# Conflicts:\n#\tsrc/main/java/com/owncloud/android/ui/dialog/SyncFileNotEnoughSpaceDialogFragment.java", "committedDate": "2020-01-29T07:35:20Z", "type": "commit"}, {"oid": "52edda73f6c0e9c668da8ebe609ea20352e83eb0", "url": "https://github.com/nextcloud/android/commit/52edda73f6c0e9c668da8ebe609ea20352e83eb0", "message": "Formated the code and removed Pair", "committedDate": "2020-01-29T09:39:45Z", "type": "commit"}, {"oid": "4bed2adc2f923e05a8fd89fef297839027949a9c", "url": "https://github.com/nextcloud/android/commit/4bed2adc2f923e05a8fd89fef297839027949a9c", "message": "Merge branch 'fix/not-enough-space-dialog' of github.com:nextcloud/android into fix/not-enough-space-dialog", "committedDate": "2020-01-29T09:39:52Z", "type": "commit"}, {"oid": "6dbce81c1d222faef07055d34e04b57ac2ba0b3a", "url": "https://github.com/nextcloud/android/commit/6dbce81c1d222faef07055d34e04b57ac2ba0b3a", "message": "update screenshot\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-01-30T13:55:18Z", "type": "commit"}, {"oid": "1ac4e1394be716c5bcfaec591565f3305202a694", "url": "https://github.com/nextcloud/android/commit/1ac4e1394be716c5bcfaec591565f3305202a694", "message": "update screenshot test cases\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-01-30T13:56:50Z", "type": "commit"}, {"oid": "82baea306205977844ee3d523fbf380a7eaa2505", "url": "https://github.com/nextcloud/android/commit/82baea306205977844ee3d523fbf380a7eaa2505", "message": "Normalized the code", "committedDate": "2020-01-30T15:55:37Z", "type": "commit"}, {"oid": "b74c9f25173e6bd7714d0f127ef8d66cb19907af", "url": "https://github.com/nextcloud/android/commit/b74c9f25173e6bd7714d0f127ef8d66cb19907af", "message": "use correct storage location\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-02-04T10:24:10Z", "type": "commit"}, {"oid": "88c4d6d2abfdb5f6ebe94690098899a7a9680974", "url": "https://github.com/nextcloud/android/commit/88c4d6d2abfdb5f6ebe94690098899a7a9680974", "message": "Merge remote-tracking branch 'origin/fix/not-enough-space-dialog' into fix/not-enough-space-dialog", "committedDate": "2020-02-04T10:24:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3ODY0OA==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r374578648", "bodyText": "please line wrap", "author": "tobiasKaminsky", "createdAt": "2020-02-04T10:08:02Z", "path": "src/main/java/com/owncloud/android/ui/dialog/SyncFileNotEnoughSpaceDialogFragment.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *   Nextcloud Android client application\n+ *\n+ *   @author Kilian P\u00e9risset\n+ *   Copyright (C) 2020 Infomaniak Network SA\n+ *\n+ *   This program is free software: you can redistribute it and/or modify\n+ *   it under the terms of the GNU Affero General Public License (GPLv3),\n+ *   as published by the Free Software Foundation.\n+ *\n+ *   This program is distributed in the hope that it will be useful,\n+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ *   GNU General Public License for more details.\n+ *\n+ *   You should have received a copy of the GNU General Public License\n+ *   along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.owncloud.android.ui.dialog;\n+\n+import android.app.Dialog;\n+import android.content.Intent;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.os.storage.StorageManager;\n+\n+import com.owncloud.android.R;\n+import com.owncloud.android.datamodel.OCFile;\n+import com.owncloud.android.ui.dialog.ConfirmationDialogFragment.ConfirmationDialogFragmentListener;\n+import com.owncloud.android.ui.fragment.OCFileListFragment;\n+import com.owncloud.android.utils.DisplayUtils;\n+import com.owncloud.android.utils.ThemeUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RequiresApi;\n+import androidx.appcompat.app.AlertDialog;\n+\n+/**\n+ * Dialog requiring confirmation when a file/folder is too \"big\" to be synchronized/downloaded on device.\n+ */\n+public class SyncFileNotEnoughSpaceDialogFragment extends ConfirmationDialogFragment implements\n+    ConfirmationDialogFragmentListener {\n+\n+    private static final String ARG_PASSED_FILE = \"fragment_parent_caller\";\n+    private static final int REQUEST_CODE_STORAGE = 20;\n+\n+    private OCFile targetFile;\n+\n+    public static SyncFileNotEnoughSpaceDialogFragment newInstance(OCFile file, long availableDeviceSpace) {\n+        Bundle args = new Bundle();\n+        SyncFileNotEnoughSpaceDialogFragment frag = new SyncFileNotEnoughSpaceDialogFragment();\n+        String properFileSize = DisplayUtils.bytesToHumanReadable(file.getFileLength());\n+        String properDiskAvailableSpace = DisplayUtils.bytesToHumanReadable(availableDeviceSpace);\n+\n+        // Defining title, message and resources\n+        args.putInt(ARG_TITLE_ID, R.string.sync_not_enough_space_dialog_title);\n+        args.putInt(ARG_MESSAGE_RESOURCE_ID, R.string.sync_not_enough_space_dialog_placeholder);\n+        args.putStringArray(ARG_MESSAGE_ARGUMENTS, new String[]{file.getFileName(), properFileSize, properDiskAvailableSpace});", "originalCommit": "82baea306205977844ee3d523fbf380a7eaa2505", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3OTAyNA==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r374579024", "bodyText": "What happens on older Android versions?", "author": "tobiasKaminsky", "createdAt": "2020-02-04T10:08:41Z", "path": "src/main/java/com/owncloud/android/ui/dialog/SyncFileNotEnoughSpaceDialogFragment.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *   Nextcloud Android client application\n+ *\n+ *   @author Kilian P\u00e9risset\n+ *   Copyright (C) 2020 Infomaniak Network SA\n+ *\n+ *   This program is free software: you can redistribute it and/or modify\n+ *   it under the terms of the GNU Affero General Public License (GPLv3),\n+ *   as published by the Free Software Foundation.\n+ *\n+ *   This program is distributed in the hope that it will be useful,\n+ *   but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ *   GNU General Public License for more details.\n+ *\n+ *   You should have received a copy of the GNU General Public License\n+ *   along with this program.  If not, see <http://www.gnu.org/licenses/>.\n+ */\n+\n+package com.owncloud.android.ui.dialog;\n+\n+import android.app.Dialog;\n+import android.content.Intent;\n+import android.os.Build;\n+import android.os.Bundle;\n+import android.os.storage.StorageManager;\n+\n+import com.owncloud.android.R;\n+import com.owncloud.android.datamodel.OCFile;\n+import com.owncloud.android.ui.dialog.ConfirmationDialogFragment.ConfirmationDialogFragmentListener;\n+import com.owncloud.android.ui.fragment.OCFileListFragment;\n+import com.owncloud.android.utils.DisplayUtils;\n+import com.owncloud.android.utils.ThemeUtils;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.RequiresApi;\n+import androidx.appcompat.app.AlertDialog;\n+\n+/**\n+ * Dialog requiring confirmation when a file/folder is too \"big\" to be synchronized/downloaded on device.\n+ */\n+public class SyncFileNotEnoughSpaceDialogFragment extends ConfirmationDialogFragment implements\n+    ConfirmationDialogFragmentListener {\n+\n+    private static final String ARG_PASSED_FILE = \"fragment_parent_caller\";\n+    private static final int REQUEST_CODE_STORAGE = 20;\n+\n+    private OCFile targetFile;\n+\n+    public static SyncFileNotEnoughSpaceDialogFragment newInstance(OCFile file, long availableDeviceSpace) {\n+        Bundle args = new Bundle();\n+        SyncFileNotEnoughSpaceDialogFragment frag = new SyncFileNotEnoughSpaceDialogFragment();\n+        String properFileSize = DisplayUtils.bytesToHumanReadable(file.getFileLength());\n+        String properDiskAvailableSpace = DisplayUtils.bytesToHumanReadable(availableDeviceSpace);\n+\n+        // Defining title, message and resources\n+        args.putInt(ARG_TITLE_ID, R.string.sync_not_enough_space_dialog_title);\n+        args.putInt(ARG_MESSAGE_RESOURCE_ID, R.string.sync_not_enough_space_dialog_placeholder);\n+        args.putStringArray(ARG_MESSAGE_ARGUMENTS, new String[]{file.getFileName(), properFileSize, properDiskAvailableSpace});\n+        args.putParcelable(ARG_PASSED_FILE, file);\n+\n+        // Defining buttons\n+        if (file.isFolder()) {\n+            args.putInt(ARG_POSITIVE_BTN_RES, R.string.sync_not_enough_space_dialog_action_choose);\n+        }\n+        if (android.os.Build.VERSION.SDK_INT >= android.os.Build.VERSION_CODES.N_MR1) {", "originalCommit": "82baea306205977844ee3d523fbf380a7eaa2505", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE0MzY0Ng==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r375143646", "bodyText": "The \"Free up space\" button will simply not appear, because this function is unavailable before Jelly Bean.\nAnd, I take this opportunity to ask you why you stay on a minimal level of compilation on Android 4.1 (API level 16), it's a system that is 8 years old today.\nWithout getting ahead of myself, I would say that the application is too complex today to run successfully (all the features) on Jelly Bean, are you planning to change the  minSdkVersion over time?", "author": "Kilian-Perisset", "createdAt": "2020-02-05T09:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3OTAyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTE1MTM3MQ==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r375151371", "bodyText": "are you planning to change the minSdkVersion over time?\n\nYes, we do. The rule (introduced with the latest feature release): #150 --> check if oldest Android version is EOL by Google and user usage <= 0.5% and drop it if so", "author": "AndyScherzinger", "createdAt": "2020-02-05T09:45:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU3OTAyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4MjUzNQ==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r374582535", "bodyText": "This is correct, but for me it is not intuitive to read, what about this:\ngetRemainingSpaceOnDevice -> should return how much space is left in this folder/partition\n(no need of passing OCFile)\nthen it is just a\nboolean isSpaceEnough = remainingSpaceOnDevice > file.getFileLenght();", "author": "tobiasKaminsky", "createdAt": "2020-02-04T10:15:25Z", "path": "src/main/java/com/owncloud/android/ui/fragment/OCFileListFragment.java", "diffHunk": "@@ -1720,6 +1724,33 @@ private boolean isSearchEventSet(SearchEvent event) {\n             && event.getUnsetType() != null;\n     }\n \n+    private void syncAndCheckFiles(Collection<OCFile> files) {\n+        for (OCFile file : files) {\n+            // Get the remaining space on device (after file download)\n+            long remainingSpaceOnDevice = FileOperationsHelper.getRemainingSpaceOnDevice(file);\n+            // Get the total available space on device (before file download)\n+            long availableSpaceOnDevice = file.getFileLength() + remainingSpaceOnDevice;\n+            // Determine if space is enough to download the file\n+            boolean isSpaceEnough = remainingSpaceOnDevice > 0;", "originalCommit": "82baea306205977844ee3d523fbf380a7eaa2505", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4MzE4MQ==", "url": "https://github.com/nextcloud/android/pull/5328#discussion_r374583181", "bodyText": "As written above, return remaining space as method name suggests that, do not subtract file length", "author": "tobiasKaminsky", "createdAt": "2020-02-04T10:16:34Z", "path": "src/main/java/com/owncloud/android/ui/helpers/FileOperationsHelper.java", "diffHunk": "@@ -1043,5 +1038,19 @@ public static String getCapturedImageName() {\n         return new SimpleDateFormat(\"yyyy-MM-dd_HHmmss\", Locale.US).format(new Date()) + \".jpg\";\n     }\n \n+    public static Long getRemainingSpaceOnDevice(OCFile file) {", "originalCommit": "82baea306205977844ee3d523fbf380a7eaa2505", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f9a47e6b3b6a9412b6d512d5bffe5a8cb6c10e4c", "url": "https://github.com/nextcloud/android/commit/f9a47e6b3b6a9412b6d512d5bffe5a8cb6c10e4c", "message": "Formated the code", "committedDate": "2020-02-05T09:50:44Z", "type": "commit"}]}