{"pr_number": 5986, "pr_title": "Remove Evernote job scheduler dependency", "pr_createdAt": "2020-04-30T23:32:23Z", "pr_url": "https://github.com/nextcloud/android/pull/5986", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODQ4Ng==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418348486", "bodyText": "I don't get what was the purpose of this line?", "author": "ezaquarii", "createdAt": "2020-04-30T23:40:11Z", "path": "src/main/java/com/owncloud/android/files/services/FileUploader.java", "diffHunk": "@@ -1027,7 +1026,6 @@ public static void retryFailedUploads(\n                         uploadsStorageManager.updateUpload(failedUpload);\n                     }\n                 } else {\n-                    charging = charging || Device.getBatteryStatus(context).getBatteryPercent() == 1;", "originalCommit": "fcbff7019b8537f7bff9e4f96fbce283fb817dff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUyMDc1Mg==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419520752", "bodyText": "This checks if battery is 100%.\nI assume that on some strange devices charging state is not shown correct and therefore 100% is assumed as \"ongoing charging\".", "author": "tobiasKaminsky", "createdAt": "2020-05-04T15:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM0ODQ4Ng=="}], "type": "inlineReview"}, {"oid": "419d802f382d3565b2fb998697853aa99b32959d", "url": "https://github.com/nextcloud/android/commit/419d802f382d3565b2fb998697853aa99b32959d", "message": "Remove Evernote job scheduler dependency\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-04-30T23:58:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjE3NQ==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418386175", "bodyText": "I renamed the isInernetWalled() API.\nWe could have perfect internet connectivity but the server could be in maintenance mode, which this API checks as well. So he name referring to a \"walled garden\" probably went past it's shelf live at some point, so I renamed it.", "author": "ezaquarii", "createdAt": "2020-05-01T02:12:01Z", "path": "src/main/java/com/nextcloud/client/network/ConnectivityService.java", "diffHunk": "@@ -20,10 +20,25 @@\n \n package com.nextcloud.client.network;\n \n-import com.evernote.android.job.JobRequest;\n-\n+/**\n+ * This service provides information about current network connectivity\n+ * and server reachableity.\n+ */\n public interface ConnectivityService {\n-    boolean isInternetWalled();\n-    boolean isOnlineWithWifi();\n-    JobRequest.NetworkType getActiveNetworkType();\n+\n+    /**\n+     * Check if server is accessible by issuing HTTP status check request.\n+     * Since this call involves network traffic, it should not be called\n+     * on a main thread.\n+     *\n+     * @return True if server is reachable and operational, false otherwise\n+     */\n+    boolean isServerAvailable();", "originalCommit": "1ec762678f492fbe0878306e85d6353a3501db84", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNjQzNA==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419706434", "bodyText": "Nope, changing semantics from \"it is\" to \"it is not\" wasn't a terrific idea after all...", "author": "ezaquarii", "createdAt": "2020-05-04T20:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODM4NjQ5NA==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r418386494", "bodyText": "This was confusing status... Having those flags in that varying form made simple \"connected\" statate quite unintuitive to figure out. Connectivity gives one a simpler answer.", "author": "ezaquarii", "createdAt": "2020-05-01T02:13:45Z", "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();\n         } catch (Throwable t) {\n-            return JobRequest.NetworkType.ANY;\n-        }\n-\n-        if (networkInfo == null || !networkInfo.isConnectedOrConnecting()) {\n-            return JobRequest.NetworkType.ANY;\n+            ni = null; // no network available or no information (permission denied?)\n         }\n \n-        boolean metered = ConnectivityManagerCompat.isActiveNetworkMetered(connectivityManager);\n-        if (!metered) {\n-            return JobRequest.NetworkType.UNMETERED;\n+        if (ni != null) {\n+            boolean isConnected = ni.isConnectedOrConnecting();\n+            boolean isMetered = ConnectivityManagerCompat.isActiveNetworkMetered(platformConnectivityManager);\n+            boolean isWifi = ni.getType() == ConnectivityManager.TYPE_WIFI || isAnyOtherNetworkWifi();\n+            return new Connectivity(isConnected, isMetered, isWifi, null);\n+        } else {\n+            return Connectivity.DISCONNECTED;\n         }\n+    }\n \n-        if (networkInfo.isRoaming()) {\n-            return JobRequest.NetworkType.CONNECTED;\n-        } else {\n-            return JobRequest.NetworkType.NOT_ROAMING;", "originalCommit": "1ec762678f492fbe0878306e85d6353a3501db84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "691a7c60c407cf9c6fdf1b87770ff9b5f3689036", "url": "https://github.com/nextcloud/android/commit/691a7c60c407cf9c6fdf1b87770ff9b5f3689036", "message": "Remove Evernote job scheduler dependency\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-01T18:19:57Z", "type": "forcePushed"}, {"oid": "5c7cbf99232ce24da87f9d3bae27dcc3e44c27a8", "url": "https://github.com/nextcloud/android/commit/5c7cbf99232ce24da87f9d3bae27dcc3e44c27a8", "message": "Remove Evernote job scheduler dependency\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-03T23:56:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTQ0MA==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419519440", "bodyText": "Can we keep networkInfo?", "author": "tobiasKaminsky", "createdAt": "2020-05-04T15:24:17Z", "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();", "originalCommit": "3f5caa45b9e84ed822808e1457052271803af484", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNjc4NQ==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419706785", "bodyText": "done", "author": "ezaquarii", "createdAt": "2020-05-04T20:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTcwOQ==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419519709", "bodyText": "Same here.", "author": "tobiasKaminsky", "createdAt": "2020-05-04T15:24:37Z", "path": "src/main/java/com/nextcloud/client/network/ConnectivityServiceImpl.java", "diffHunk": "@@ -116,65 +116,37 @@ public boolean isInternetWalled() {\n                 }\n             }\n         } else {\n-            return getActiveNetworkType() == JobRequest.NetworkType.ANY;\n+            return !getConnectivity().isConnected();\n         }\n \n         return true;\n     }\n \n     @Override\n-    public boolean isOnlineWithWifi() {\n+    public Connectivity getConnectivity() {\n+        NetworkInfo ni;\n         try {\n-            NetworkInfo activeNetwork = connectivityManager.getActiveNetworkInfo();\n-\n-            if (activeNetwork.isConnectedOrConnecting()) {\n-                switch (activeNetwork.getType()) {\n-                    case ConnectivityManager.TYPE_VPN:\n-                        // check if any other network is wifi\n-                        for (NetworkInfo networkInfo : connectivityManager.getAllNetworkInfo()) {\n-                            if (networkInfo.isConnectedOrConnecting() &&\n-                                networkInfo.getType() == ConnectivityManager.TYPE_WIFI) {\n-                                return true;\n-                            }\n-                        }\n-                        return false;\n-\n-                    case ConnectivityManager.TYPE_WIFI:\n-                        return true;\n-\n-                    default:\n-                        return false;\n-                }\n-            } else {\n-                return false;\n-            }\n-        } catch (NullPointerException exception) {\n-            return false;\n-        }\n-    }\n-\n-    @Override\n-    public JobRequest.NetworkType getActiveNetworkType() {\n-        NetworkInfo networkInfo;\n-        try {\n-            networkInfo = connectivityManager.getActiveNetworkInfo();\n+            ni = platformConnectivityManager.getActiveNetworkInfo();\n         } catch (Throwable t) {\n-            return JobRequest.NetworkType.ANY;\n-        }\n-\n-        if (networkInfo == null || !networkInfo.isConnectedOrConnecting()) {\n-            return JobRequest.NetworkType.ANY;\n+            ni = null; // no network available or no information (permission denied?)\n         }\n \n-        boolean metered = ConnectivityManagerCompat.isActiveNetworkMetered(connectivityManager);\n-        if (!metered) {\n-            return JobRequest.NetworkType.UNMETERED;\n+        if (ni != null) {\n+            boolean isConnected = ni.isConnectedOrConnecting();\n+            boolean isMetered = ConnectivityManagerCompat.isActiveNetworkMetered(platformConnectivityManager);\n+            boolean isWifi = ni.getType() == ConnectivityManager.TYPE_WIFI || isAnyOtherNetworkWifi();\n+            return new Connectivity(isConnected, isMetered, isWifi, null);\n+        } else {\n+            return Connectivity.DISCONNECTED;\n         }\n+    }\n \n-        if (networkInfo.isRoaming()) {\n-            return JobRequest.NetworkType.CONNECTED;\n-        } else {\n-            return JobRequest.NetworkType.NOT_ROAMING;\n+    private boolean isAnyOtherNetworkWifi() {\n+        for (NetworkInfo ni : platformConnectivityManager.getAllNetworkInfo()) {", "originalCommit": "3f5caa45b9e84ed822808e1457052271803af484", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcwNjgxOA==", "url": "https://github.com/nextcloud/android/pull/5986#discussion_r419706818", "bodyText": "done", "author": "ezaquarii", "createdAt": "2020-05-04T20:26:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTUxOTcwOQ=="}], "type": "inlineReview"}, {"oid": "c38a067312bb34711324b07e1e7815d2762f56e8", "url": "https://github.com/nextcloud/android/commit/c38a067312bb34711324b07e1e7815d2762f56e8", "message": "Remove Evernote job scheduler dependency\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-04T20:40:31Z", "type": "forcePushed"}, {"oid": "821f68fc8dc7ce13c33461b166a8b6de6c1e45fc", "url": "https://github.com/nextcloud/android/commit/821f68fc8dc7ce13c33461b166a8b6de6c1e45fc", "message": "Test needs connected wifi\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-05T06:34:13Z", "type": "forcePushed"}, {"oid": "245decb0f88c2326ff1fa3aa688c8ebb9d53f58d", "url": "https://github.com/nextcloud/android/commit/245decb0f88c2326ff1fa3aa688c8ebb9d53f58d", "message": "show \"no new version available\" only when clicking on it, not in background check\n\nSigned-off-by: tobiasKaminsky <tobias@kaminsky.me>", "committedDate": "2020-05-05T15:25:32Z", "type": "commit"}, {"oid": "8073a0d0038b643c740de331692e4a7f725c7770", "url": "https://github.com/nextcloud/android/commit/8073a0d0038b643c740de331692e4a7f725c7770", "message": "Remove Evernote job scheduler dependency\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-05T21:57:16Z", "type": "commit"}, {"oid": "8073a0d0038b643c740de331692e4a7f725c7770", "url": "https://github.com/nextcloud/android/commit/8073a0d0038b643c740de331692e4a7f725c7770", "message": "Remove Evernote job scheduler dependency\n\nSigned-off-by: Chris Narkiewicz <hello@ezaquarii.com>", "committedDate": "2020-05-05T21:57:16Z", "type": "forcePushed"}, {"oid": "eee55edb805973acb041a3b02e3e71b4a8d4237a", "url": "https://github.com/nextcloud/android/commit/eee55edb805973acb041a3b02e3e71b4a8d4237a", "message": "Merge commit '8073a0d0038b643c740de331692e4a7f725c7770'", "committedDate": "2020-05-05T21:57:56Z", "type": "commit"}, {"oid": "1cf41b93ff12f7e5fe12875db96bfcf7a568b8a6", "url": "https://github.com/nextcloud/android/commit/1cf41b93ff12f7e5fe12875db96bfcf7a568b8a6", "message": "Drone: update FindBugs results to reflect reduced error/warning count [skip ci]\n\nSigned-off-by: nextcloud-android-bot <android@nextcloud.com>", "committedDate": "2020-05-05T22:08:08Z", "type": "commit"}, {"oid": "ab6d2557e09694928b1e7619ef5da3de75858c59", "url": "https://github.com/nextcloud/android/commit/ab6d2557e09694928b1e7619ef5da3de75858c59", "message": "[tx-robot] updated from transifex", "committedDate": "2020-05-06T03:24:26Z", "type": "commit"}, {"oid": "d86e5bb25631425cda85e1021aac62ecbb669268", "url": "https://github.com/nextcloud/android/commit/d86e5bb25631425cda85e1021aac62ecbb669268", "message": "Merge pull request #6007 from nextcloud/devInfoOnlyOnClick\n\nshow \"no new version available\" only when clicking on it, not in background check", "committedDate": "2020-05-06T11:56:23Z", "type": "commit"}, {"oid": "f899c2c668f1406e52cd997098ec9621335aa7e8", "url": "https://github.com/nextcloud/android/commit/f899c2c668f1406e52cd997098ec9621335aa7e8", "message": "Merge commit '1cf41b93ff12f7e5fe12875db96bfcf7a568b8a6'", "committedDate": "2020-05-06T13:35:15Z", "type": "commit"}, {"oid": "7084735f5e4a2e63cdda743b3ed11b627bcdb5fb", "url": "https://github.com/nextcloud/android/commit/7084735f5e4a2e63cdda743b3ed11b627bcdb5fb", "message": "Drone: update Lint results to reflect reduced error/warning count [skip ci]\n\nSigned-off-by: nextcloud-android-bot <android@nextcloud.com>", "committedDate": "2020-05-06T13:50:48Z", "type": "commit"}]}