{"pr_number": 6544, "pr_title": "Fixed regression where alt haplotypes with deletion at end of padded region caused exceptions", "pr_createdAt": "2020-04-07T12:26:26Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6544", "timeline": [{"oid": "3f4ef3046014b61582ebc0b810730fafb4b9f38c", "url": "https://github.com/broadinstitute/gatk/commit/3f4ef3046014b61582ebc0b810730fafb4b9f38c", "message": "Fixed regression where alt haplotypes with deletion at end of padded region caused exceptions", "committedDate": "2020-04-07T05:11:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1ODUzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r404858530", "bodyText": "Can you add a test to HaplotypeUnitTest that asserts this works reasonably with leading insertions and deletions? You should hopefullh be able to use the constructor to build dummy haplotype objects and assert that leading/trailing indels are being destroyed correctly.", "author": "jamesemery", "createdAt": "2020-04-07T14:35:13Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/haplotype/Haplotype.java", "diffHunk": "@@ -98,11 +98,21 @@ public Haplotype trim(final Locatable loc) {\n             return null;\n         }\n \n-        // note: trimCigarByReference does not remove leading indels, while getBasesCoveringRefInterval does remove bases\n-        // of leading indels.  We must remove leading indels from the Cigar manually.\n+        // note: trimCigarByReference does not remove leading or trailing indels, while getBasesCoveringRefInterval does remove bases", "originalCommit": "3f4ef3046014b61582ebc0b810730fafb4b9f38c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE0OTk5NA==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r407149994", "bodyText": "I wrote a test for insertions.  The existing tests already cover the expected null result for deletions.", "author": "davidbenjamin", "createdAt": "2020-04-12T05:46:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1ODUzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1MDM0Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r407150342", "bodyText": "We may at some point want to rethink the null result for leading/trailing deletions, however.  I get that if we are only trimming the padding after SW alignment of the padded haplotypes that every haplotype should share the initial (final) kmer of the ref source (sink).  In that a leading deletion means a bogus haplotype.  But I see nothing inherently wrong with a leading/trailing deletion of a haplotype that has been trimmed to fit a small genotyping window for Pair-HMM.  In practice since we pad these windows around all assembled events maybe no real variation would ever get lost in this way.  Still, it seems wrong and unnecessary.", "author": "davidbenjamin", "createdAt": "2020-04-12T05:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1ODUzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2NjQzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r404866430", "bodyText": "This would also consume other leading/trailing signals like softclips correct?", "author": "jamesemery", "createdAt": "2020-04-07T14:45:11Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/haplotype/Haplotype.java", "diffHunk": "@@ -98,11 +98,21 @@ public Haplotype trim(final Locatable loc) {\n             return null;\n         }\n \n-        // note: trimCigarByReference does not remove leading indels, while getBasesCoveringRefInterval does remove bases\n-        // of leading indels.  We must remove leading indels from the Cigar manually.\n+        // note: trimCigarByReference does not remove leading or trailing indels, while getBasesCoveringRefInterval does remove bases\n+        // of leading and trailing insertions.  We must remove leading and trailing insertions from the Cigar manually.\n+        // we keep leading and trailing deletions because these are necessary for haplotypes to maintain consistent reference coordinates\n         final Cigar newCigar = AlignmentUtils.trimCigarByReference(getCigar(), newStart, newStop).getCigar();\n-        final Cigar leadingIndelTrimmedNewCigar = newCigar.getFirstCigarElement().getOperator().consumesReferenceBases() ? newCigar :\n-                new CigarBuilder().addAll(newCigar.getCigarElements().subList(1, newCigar.numCigarElements())).make();\n+        final boolean leadingInsertion = !newCigar.getFirstCigarElement().getOperator().consumesReferenceBases();", "originalCommit": "3f4ef3046014b61582ebc0b810730fafb4b9f38c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1MDgxNw==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r407150817", "bodyText": "It would, but we never produce haplotypes with softclips (I think) and if we do we don't let them survive this far.  There may be a future refactoring to decouple the Haplotype from the assumption that it is necessarily produced by our particular combination of assembly, padding, Smith-Waterman, and trimming, but the time for that is not now.", "author": "davidbenjamin", "createdAt": "2020-04-12T05:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg2NjQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MjE4Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r404882186", "bodyText": "I like that we have an integration test. Generally even if the test is intended to assert that we aren't getting an exception its best to actually assert something about the output. It wouldn't be too difficult to check in an output VCF for this file I shouldn't think.", "author": "jamesemery", "createdAt": "2020-04-07T15:04:22Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerIntegrationTest.java", "diffHunk": "@@ -1318,6 +1318,23 @@ public void testAdjacentIndels() {\n                 .allMatch(vc -> vc.isBiallelic() && (vc.getReference().length() == 1 || vc.getAlternateAllele(0).length() == 1)));\n     }\n \n+    // this test has a reference with 8 repeats of a 28-mer and an alt with 7 repeats.  This deletion left-aligns to the\n+    // beginning of the padded assembly region, and an exception occurs if we carelessly drop the leading deletion from\n+    // the alt haplotype's cigar.  This is a regression test for https://github.com/broadinstitute/gatk/issues/6533.\n+    @Test\n+    public void testLeadingDeletionInAltHaplotype() {\n+        final File bam = new File(TEST_FILES_DIR, \"alt-haplotype-leading-deletion.bam\");\n+", "originalCommit": "3f4ef3046014b61582ebc0b810730fafb4b9f38c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1MTI3Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r407151277", "bodyText": "Added check that the 28-base deletion is called.", "author": "davidbenjamin", "createdAt": "2020-04-12T06:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg4MjE4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg5OTk4OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r404899989", "bodyText": "Add a run of tests asserting both true and false cases for this variable.", "author": "jamesemery", "createdAt": "2020-04-07T15:27:07Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/read/CigarBuilder.java", "diffHunk": "@@ -34,11 +36,19 @@\n \n     private Section section = Section.LEFT_HARD_CLIP;\n \n+    private final boolean removeDeletionsAtEnds;\n+\n     private int leadingDeletionBasesRemoved = 0;\n     private int trailingDeletionBasesRemoved = 0;\n     private int trailingDeletionBasesRemovedInMake = 0;\n \n-    public CigarBuilder() { }\n+    public CigarBuilder(final boolean removeDeletionsAtEnds) {\n+        this.removeDeletionsAtEnds = removeDeletionsAtEnds;", "originalCommit": "3f4ef3046014b61582ebc0b810730fafb4b9f38c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzE1MTQyOA==", "url": "https://github.com/broadinstitute/gatk/pull/6544#discussion_r407151428", "bodyText": "This is the testRetainDeletions unit test.", "author": "davidbenjamin", "createdAt": "2020-04-12T06:03:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg5OTk4OQ=="}], "type": "inlineReview"}, {"oid": "375a625c92c6a6cf2c1e700d8265da5e1122712b", "url": "https://github.com/broadinstitute/gatk/commit/375a625c92c6a6cf2c1e700d8265da5e1122712b", "message": "review edits", "committedDate": "2020-04-12T06:03:57Z", "type": "commit"}]}