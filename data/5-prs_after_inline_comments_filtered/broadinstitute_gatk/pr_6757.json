{"pr_number": 6757, "pr_title": "Enable re-reblocking with no PLs", "pr_createdAt": "2020-08-18T18:02:05Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6757", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEyNjI3MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6757#discussion_r513126271", "bodyText": "END= annotation is not exclusive of hom-ref blocks, right? I guess within the context this method is used it is though. Perhaps can you add a comment indicating so.", "author": "vruano", "createdAt": "2020-10-28T01:29:01Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/variantutils/ReblockGVCF.java", "diffHunk": "@@ -256,7 +266,7 @@ private VariantContext regenotypeVC(final VariantContext originalVC) {\n     }\n \n     private boolean isHomRefBlock(final VariantContext result) {\n-        return result.getLog10PError() == VariantContext.NO_LOG10_PERROR;\n+        return result.hasAttribute(VCFConstants.END_KEY);", "originalCommit": "613525738733233e46f44532ad3be73ec4ff3560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEyODU1MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6757#discussion_r513128551", "bodyText": "Shouldn't hasGQ be called before any getGQ?  Shouldn't it even fail if not?\nPerhaps you could force rgpThreshold to be 0 or greater in that case the == 0 is unnecessary. Fail if it is no in [0.0 ... MAX_VALUE] (so negatives, NaN and Infinities would fail).\nAlso based on the description of rgpThreshold sounds like these comparisons should < rather than <=. Perhaps the doc of the argument should be changed.", "author": "vruano", "createdAt": "2020-10-28T01:37:23Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/variantutils/ReblockGVCF.java", "diffHunk": "@@ -272,10 +282,34 @@ private boolean isHomRefCall(final VariantContext result) {\n \n     private VariantContext filterHomRefBlock(final VariantContext result) {\n         final Genotype genotype = result.getGenotype(0);\n-        if (dropLowQuals && (genotype.getGQ() <= rgqThreshold || genotype.getGQ() == 0)) {\n+        if (dropLowQuals && (genotype.getGQ() <= rgqThreshold || genotype.getGQ() == 0 || !genotype.hasGQ())) {", "originalCommit": "613525738733233e46f44532ad3be73ec4ff3560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEyOTQwOA==", "url": "https://github.com/broadinstitute/gatk/pull/6757#discussion_r513129408", "bodyText": "Perhaps the warning message should say that we are using GQ in leu.", "author": "vruano", "createdAt": "2020-10-28T01:40:52Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/variantutils/ReblockGVCF.java", "diffHunk": "@@ -272,10 +282,34 @@ private boolean isHomRefCall(final VariantContext result) {\n \n     private VariantContext filterHomRefBlock(final VariantContext result) {\n         final Genotype genotype = result.getGenotype(0);\n-        if (dropLowQuals && (genotype.getGQ() <= rgqThreshold || genotype.getGQ() == 0)) {\n+        if (dropLowQuals && (genotype.getGQ() <= rgqThreshold || genotype.getGQ() == 0 || !genotype.hasGQ())) {\n             return null;\n         }\n         else if (genotype.isCalled() && genotype.isHomRef()) {\n+            if (!genotype.hasPL()) {\n+                if (genotype.hasGQ()) {\n+                    logger.warn(\"PL is missing for hom ref genotype at at least one position for sample \" + genotype.getSampleName() + \": \" + result.getContig() + \":\" + result.getStart() +", "originalCommit": "613525738733233e46f44532ad3be73ec4ff3560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzMTgyMg==", "url": "https://github.com/broadinstitute/gatk/pull/6757#discussion_r513131822", "bodyText": "Should this be an error instead of a warning?\nActually it really should as below there is code that clearly depends on it being a diploid and even may result in exception if not. Error makes more sense.", "author": "vruano", "createdAt": "2020-10-28T01:49:57Z", "path": "src/main/java/org/broadinstitute/hellbender/tools/walkers/variantutils/ReblockGVCF.java", "diffHunk": "@@ -190,7 +198,9 @@ public void onTraversalStart() {\n         }\n         vcfWriter.writeHeader(new VCFHeader(headerLines, inputHeader.getGenotypeSamples()));\n \n-        logger.info(\"Notice that the -ploidy parameter is ignored in \" + getClass().getSimpleName() + \" tool as this is tool assumes a diploid sample\");\n+        if (genotypeArgs.samplePloidy != PLOIDY_TWO) {", "originalCommit": "613525738733233e46f44532ad3be73ec4ff3560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzOTE3Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6757#discussion_r513139172", "bodyText": "I would compact the two last elses as minGQ = minGQ == -1 ? genotype.getGQ() : Math.min(...);", "author": "vruano", "createdAt": "2020-10-28T02:17:04Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/variant/writers/HomRefBlock.java", "diffHunk": "@@ -124,6 +128,15 @@ public void add(final int pos, final int newEnd, final Genotype genotype) {\n                 }\n             }\n         }\n+        if (minPPs != null) {\n+            minGQ = GATKVariantContextUtils.calculateGQFromPLs(minPPs);\n+        } else if (minPLs != null) {\n+            minGQ = GATKVariantContextUtils.calculateGQFromPLs(minPLs);\n+        } else if (minGQ == -1) {\n+            minGQ = genotype.getGQ();", "originalCommit": "613525738733233e46f44532ad3be73ec4ff3560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzEzOTcxNg==", "url": "https://github.com/broadinstitute/gatk/pull/6757#discussion_r513139716", "bodyText": "This test seems a bit weak.... can you do a more through test e.g. the unaffected blocks should be in the same order and unchanged... etc.", "author": "vruano", "createdAt": "2020-10-28T02:19:14Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/variantutils/ReblockGVCFIntegrationTest.java", "diffHunk": "@@ -185,4 +185,19 @@ public void testMQHeadersAreUpdated() throws Exception {\n             }\n         }\n     }\n+\n+    @Test\n+    public void testReReblocking() {\n+        final File input = new File(getToolTestDataDir() + \"alreadyReblocked.chr22snippet.vcf\");\n+        final File output = createTempFile(\"rereblockedgvcf\", \".vcf\");\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        args.add(\"V\", input)\n+                .addOutput(output);\n+        runCommandLine(args);\n+\n+        Pair<VCFHeader, List<VariantContext>> inputVCs = VariantContextTestUtils.readEntireVCFIntoMemory(input.getAbsolutePath());\n+        Pair<VCFHeader, List<VariantContext>> outputVCs = VariantContextTestUtils.readEntireVCFIntoMemory(output.getAbsolutePath());\n+\n+        Assert.assertTrue(inputVCs.getRight().size() > outputVCs.getRight().size());", "originalCommit": "613525738733233e46f44532ad3be73ec4ff3560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzE0MDY3Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6757#discussion_r513140676", "bodyText": "Looks a bit weak of a test. Anything else that can be tested", "author": "vruano", "createdAt": "2020-10-28T02:22:56Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/variant/writers/HomRefBlockUnitTest.java", "diffHunk": "@@ -110,6 +110,22 @@ public void testCantAddDifferentNumbersOfPls(){\n         band.add(vc.getStart() + 1, getValidGenotypeBuilder().PL(new int[] {1,2,4,5,6}).make() );\n     }\n \n+    @Test\n+    public void testNoPLs() {\n+        //add VC with no PLs to block with PLs\n+        final VariantContext vc = getVariantContext();\n+        final GVCFBlock band = getHomRefBlock(getVariantContext());\n+        band.add(vc.getStart(), getValidGenotypeBuilder().make() );\n+        band.add(vc.getStart() + 1, getValidGenotypeBuilder().noPL().make());\n+        Assert.assertTrue(band.getSize() == 2);", "originalCommit": "613525738733233e46f44532ad3be73ec4ff3560", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dcd1398afdb703df59efbfc13d5b4096210480fc", "url": "https://github.com/broadinstitute/gatk/commit/dcd1398afdb703df59efbfc13d5b4096210480fc", "message": "Address review comments; more tests", "committedDate": "2020-11-19T16:26:57Z", "type": "forcePushed"}, {"oid": "5be3d05e22702dd721f0697e7fe0593e42fe55db", "url": "https://github.com/broadinstitute/gatk/commit/5be3d05e22702dd721f0697e7fe0593e42fe55db", "message": "Enable re-reblocking with no PLs", "committedDate": "2020-11-30T19:14:38Z", "type": "commit"}, {"oid": "84303f2f41d500f83a87220653a6588fafc390c9", "url": "https://github.com/broadinstitute/gatk/commit/84303f2f41d500f83a87220653a6588fafc390c9", "message": "Fix unit tests too", "committedDate": "2020-11-30T19:14:41Z", "type": "commit"}, {"oid": "e91ca7d6bcc9ceba221b27c4ae925405dd636e8f", "url": "https://github.com/broadinstitute/gatk/commit/e91ca7d6bcc9ceba221b27c4ae925405dd636e8f", "message": "Address review comments; more tests", "committedDate": "2020-11-30T19:14:41Z", "type": "commit"}, {"oid": "6d30f93f036b4aaa418dcf54f524a1caf91fbc51", "url": "https://github.com/broadinstitute/gatk/commit/6d30f93f036b4aaa418dcf54f524a1caf91fbc51", "message": "I built test data with bad PLs", "committedDate": "2020-11-30T19:14:41Z", "type": "commit"}, {"oid": "6d30f93f036b4aaa418dcf54f524a1caf91fbc51", "url": "https://github.com/broadinstitute/gatk/commit/6d30f93f036b4aaa418dcf54f524a1caf91fbc51", "message": "I built test data with bad PLs", "committedDate": "2020-11-30T19:14:41Z", "type": "forcePushed"}, {"oid": "e9fcb6ccac64c6c6b5b47478c95b2e0a1ad29335", "url": "https://github.com/broadinstitute/gatk/commit/e9fcb6ccac64c6c6b5b47478c95b2e0a1ad29335", "message": "Maybe a sleep will fix the sporadic CNV WDL test failures", "committedDate": "2020-12-01T14:43:41Z", "type": "commit"}]}