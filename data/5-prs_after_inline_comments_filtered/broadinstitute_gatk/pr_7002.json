{"pr_number": 7002, "pr_title": "Fixed a NPE when null ReadNameRegex provided to MDSpark", "pr_createdAt": "2020-12-15T15:12:54Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/7002", "timeline": [{"oid": "4f03e9298504f26cf2e545858b37c75e1ccd4133", "url": "https://github.com/broadinstitute/gatk/commit/4f03e9298504f26cf2e545858b37c75e1ccd4133", "message": "fixed a NPE when null ReadNameRegex provided to MDSpark", "committedDate": "2020-12-15T14:55:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk1MTAzMw==", "url": "https://github.com/broadinstitute/gatk/pull/7002#discussion_r555951033", "bodyText": "Is this really testing with an actual null pointer in the READ_NAME_REGEX field, or just the literal String \"null\"?\nCan you add in a unit test showing that OpticalDuplicateFinder can be constructed from a null READ_NAME_REGEX, and that methods like addLocationInformation() can still function?", "author": "droazen", "createdAt": "2021-01-12T17:32:45Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/spark/pipelines/MarkDuplicatesSparkIntegrationTest.java", "diffHunk": "@@ -495,6 +496,33 @@ public void testAssertCorrectSortOrderMultipleBamsOverriding() {\n         runCommandLine(args);\n     }\n \n+    @Test\n+    public void testNullOpticalDuplicates() {\n+        final File output = createTempFile(\"supplementaryReadUnmappedMate\", \"bam\");\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        args.addOutput(output);\n+        args.addInput(new File(TEST_DATA_DIR,\"optical_dupes.bam\"));\n+        args.addFlag(MarkDuplicatesSpark.ALLOW_MULTIPLE_SORT_ORDERS_IN_INPUT_ARG);\n+        args.add(OpticalDuplicatesArgumentCollection.READ_NAME_REGEX_LONG_NAME, \"null\");", "originalCommit": "4f03e9298504f26cf2e545858b37c75e1ccd4133", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk2MzY0MQ==", "url": "https://github.com/broadinstitute/gatk/pull/7002#discussion_r555963641", "bodyText": "Yes it is an actual null reference that gets passed. I believe the argument parser interprets \"null\" as null which is expected behavior in the picard MarkDuplicates documentation for disabling the OpticalDuplicates finder. In GATK4 we ported the same method but we accidentally encased it in a ternary that nulled out the Finder object (which should not have happened) and caused the exception.", "author": "jamesemery", "createdAt": "2021-01-12T17:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk1MTAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk2NTcyMQ==", "url": "https://github.com/broadinstitute/gatk/pull/7002#discussion_r555965721", "bodyText": "This test does actually assert that the optical dupes finder works as intended when \"null\" is provided. It is intended to count NOTHING as an optical duplicate and this test asserts that reads that normally would count as optical duplicates are treated as such. I'm somewhat hesitant to add that test since the OpticalDuplicatesFinder object is a picard class that we call into in GATK.", "author": "jamesemery", "createdAt": "2021-01-12T17:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk1MTAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk2OTIxMQ==", "url": "https://github.com/broadinstitute/gatk/pull/7002#discussion_r555969211", "bodyText": "In picard OpticalDuplicatesFinder there is the following exit case for a null regex that is the intended target here:\nif (this.readNameRegex == null || length < 2 || length > maxDuplicateSetSize) {\n            return opticalDuplicateFlags;\n        }", "author": "jamesemery", "createdAt": "2021-01-12T18:00:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTk1MTAzMw=="}], "type": "inlineReview"}]}