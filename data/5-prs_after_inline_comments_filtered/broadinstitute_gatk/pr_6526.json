{"pr_number": 6526, "pr_title": "Adding initial support for http(s) paths including signed urls.", "pr_createdAt": "2020-03-25T16:58:00Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6526", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MDMyOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401780329", "bodyText": "I think that isCloudStorageUrl() is meant to test specifically for GCS urls, as the name implies, so I don't think we should overload it to also check for http. Recommend introducing a new method isHTTPUrl(), and calling it from appropriate places such as BucketUtils.isRemoteStorageUrl()", "author": "droazen", "createdAt": "2020-04-01T17:18:18Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/gcs/BucketUtils.java", "diffHunk": "@@ -66,7 +68,8 @@ public static boolean isCloudStorageUrl(final GATKPathSpecifier pathSpec) {\n \n     public static boolean isCloudStorageUrl(final java.nio.file.Path path) {\n         // the initial \"\" protects us against a null scheme\n-        return (\"\" + path.toUri().getScheme() + \"://\").equals(GCS_PREFIX);\n+        final String prefix = \"\" + path.toUri().getScheme() + \"://\";\n+        return prefix.equals(GCS_PREFIX) || prefix.equals(HTTP_PREFIX) || prefix.equals(HTTPS_PREFIX);", "originalCommit": "d602d99b9a82adccddaddd93f886689ce8981114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzMjI1NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401832255", "bodyText": "oh, yeah, that was the patch I was working on that I delayed and then forgot to push.", "author": "lbergelson", "createdAt": "2020-04-01T18:45:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MDMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NjU1OA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r404396558", "bodyText": "I'm reshuffling things a bit.  It's not clear to me what \"cloud storage\" means exactly.  I examined the different uses of these methods and it looks like some overloads are used to test \"is this a google url\" and need to remain google only.  I'm renaming those to isGcsUrl which is clear that it's GOOGLE cloud storage. This overload is only used in places where you want to know if it's some sort of laggy remote file.  I'm renaming this to \"isEligibleForPrefetching\" to make it clear what it's asking.", "author": "lbergelson", "createdAt": "2020-04-06T21:22:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MDMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MTI0MA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401781240", "bodyText": "If this method is generally useful, perhaps it should live in BucketUtils rather than in this test class.", "author": "droazen", "createdAt": "2020-04-01T17:19:50Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +52,66 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),\n+               new SimpleInterval(\"3\", 1_000_003, 1_000_100),\n+                new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+\n+        final List<SimpleInterval> cramIntervals = Arrays.asList(new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+        return new Object[][]{\n+                {bucketPathToPublicHttpUrl(bam), bucketPathToPublicHttpUrl(bai), bam, bai, largeFileIntervals},\n+                {toSignedUrl(bam), toSignedUrl(bai), bam, bai, largeFileIntervals},\n+                {bucketPathToPublicHttpUrl(cram), bucketPathToPublicHttpUrl(crai), cram, crai, cramIntervals},\n+                {toSignedUrl(cram), toSignedUrl(crai), cram, crai, cramIntervals}\n+\n+        };\n+    }\n+\n+    @Test(groups = {\"cloud\", \"bucket\"}, dataProvider = \"getHttpPaths\")\n+    public void testHttpPaths(String reads, String index, String nonHttpReads, String nonHttpIndex, List<SimpleInterval> intervals) throws IOException {\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        final File out = createTempFile(\"out\", \".bam\");\n+        System.out.println(\"reading http\");\n+        args.addInput(reads)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(\"read-index\", index)\n+                .addReference(GATKBaseTest.b37Reference)\n+                .addOutput(out);\n+        intervals.forEach(args::addInterval);\n+        runCommandLine(args);\n+\n+        System.out.println(\"reading gs\");\n+        final ArgumentsBuilder args2 = new ArgumentsBuilder();\n+        final File out2 = createTempFile(\"out\", \".bam\");\n+        args2.addInput(nonHttpReads)\n+                .add(\"read-index\", nonHttpIndex)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .addReference(GATKBaseTest.b37Reference)\n+                .addOutput(out2);\n+        intervals.forEach(args2::addInterval);\n+        runCommandLine(args2);\n+\n+        SamAssertionUtils.assertEqualBamFiles(out, out2, false, ValidationStringency.DEFAULT_STRINGENCY);\n+    }\n+\n+    public static String toSignedUrl(String path) {\n+        final Storage storage = StorageOptions.getDefaultInstance().getService();\n+        final BlobInfo info = BlobInfo.newBuilder(BucketUtils.getBucket(path), BucketUtils.getPathWithoutBucket(path)).build();\n+        return storage.signUrl(info, 1L, TimeUnit.HOURS,\n+                Storage.SignUrlOption.httpMethod(HttpMethod.GET)\n+        ).toString();\n+    }\n+\n+    public static String bucketPathToPublicHttpUrl(String path){\n+        return String.format(\"https://storage.googleapis.com/%s/%s\", BucketUtils.getBucket(path), BucketUtils.getPathWithoutBucket(path));", "originalCommit": "d602d99b9a82adccddaddd93f886689ce8981114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzE3Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r404397177", "bodyText": "Sure, although it's not necessarily stable forever.  I don't know if they promise anywhere to construct paths like this, this is just what seems to work.", "author": "lbergelson", "createdAt": "2020-04-06T21:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MTI0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MTYzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401781630", "bodyText": "This is another utility method that might be useful to move to BucketUtils", "author": "droazen", "createdAt": "2020-04-01T17:20:27Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +52,66 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),\n+               new SimpleInterval(\"3\", 1_000_003, 1_000_100),\n+                new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+\n+        final List<SimpleInterval> cramIntervals = Arrays.asList(new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+        return new Object[][]{\n+                {bucketPathToPublicHttpUrl(bam), bucketPathToPublicHttpUrl(bai), bam, bai, largeFileIntervals},\n+                {toSignedUrl(bam), toSignedUrl(bai), bam, bai, largeFileIntervals},\n+                {bucketPathToPublicHttpUrl(cram), bucketPathToPublicHttpUrl(crai), cram, crai, cramIntervals},\n+                {toSignedUrl(cram), toSignedUrl(crai), cram, crai, cramIntervals}\n+\n+        };\n+    }\n+\n+    @Test(groups = {\"cloud\", \"bucket\"}, dataProvider = \"getHttpPaths\")\n+    public void testHttpPaths(String reads, String index, String nonHttpReads, String nonHttpIndex, List<SimpleInterval> intervals) throws IOException {\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        final File out = createTempFile(\"out\", \".bam\");\n+        System.out.println(\"reading http\");\n+        args.addInput(reads)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(\"read-index\", index)\n+                .addReference(GATKBaseTest.b37Reference)\n+                .addOutput(out);\n+        intervals.forEach(args::addInterval);\n+        runCommandLine(args);\n+\n+        System.out.println(\"reading gs\");\n+        final ArgumentsBuilder args2 = new ArgumentsBuilder();\n+        final File out2 = createTempFile(\"out\", \".bam\");\n+        args2.addInput(nonHttpReads)\n+                .add(\"read-index\", nonHttpIndex)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .addReference(GATKBaseTest.b37Reference)\n+                .addOutput(out2);\n+        intervals.forEach(args2::addInterval);\n+        runCommandLine(args2);\n+\n+        SamAssertionUtils.assertEqualBamFiles(out, out2, false, ValidationStringency.DEFAULT_STRINGENCY);\n+    }\n+\n+    public static String toSignedUrl(String path) {\n+        final Storage storage = StorageOptions.getDefaultInstance().getService();\n+        final BlobInfo info = BlobInfo.newBuilder(BucketUtils.getBucket(path), BucketUtils.getPathWithoutBucket(path)).build();\n+        return storage.signUrl(info, 1L, TimeUnit.HOURS,\n+                Storage.SignUrlOption.httpMethod(HttpMethod.GET)", "originalCommit": "d602d99b9a82adccddaddd93f886689ce8981114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzQ5NA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r404397494", "bodyText": "I'll move it but it's tricky to test in useful way.", "author": "lbergelson", "createdAt": "2020-04-06T21:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MTYzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MjAwOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401782009", "bodyText": "Use the logger instead of System.out.println()", "author": "droazen", "createdAt": "2020-04-01T17:21:02Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +52,66 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),\n+               new SimpleInterval(\"3\", 1_000_003, 1_000_100),\n+                new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+\n+        final List<SimpleInterval> cramIntervals = Arrays.asList(new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+        return new Object[][]{\n+                {bucketPathToPublicHttpUrl(bam), bucketPathToPublicHttpUrl(bai), bam, bai, largeFileIntervals},\n+                {toSignedUrl(bam), toSignedUrl(bai), bam, bai, largeFileIntervals},\n+                {bucketPathToPublicHttpUrl(cram), bucketPathToPublicHttpUrl(crai), cram, crai, cramIntervals},\n+                {toSignedUrl(cram), toSignedUrl(crai), cram, crai, cramIntervals}\n+\n+        };\n+    }\n+\n+    @Test(groups = {\"cloud\", \"bucket\"}, dataProvider = \"getHttpPaths\")\n+    public void testHttpPaths(String reads, String index, String nonHttpReads, String nonHttpIndex, List<SimpleInterval> intervals) throws IOException {\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        final File out = createTempFile(\"out\", \".bam\");\n+        System.out.println(\"reading http\");", "originalCommit": "d602d99b9a82adccddaddd93f886689ce8981114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM5NzU4Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r404397583", "bodyText": "Meant to remove these.", "author": "lbergelson", "createdAt": "2020-04-06T21:24:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MjAwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MjMzOA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401782338", "bodyText": "What happens if you run with the default prefetch settings?", "author": "droazen", "createdAt": "2020-04-01T17:21:37Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +52,66 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),\n+               new SimpleInterval(\"3\", 1_000_003, 1_000_100),\n+                new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+\n+        final List<SimpleInterval> cramIntervals = Arrays.asList(new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+        return new Object[][]{\n+                {bucketPathToPublicHttpUrl(bam), bucketPathToPublicHttpUrl(bai), bam, bai, largeFileIntervals},\n+                {toSignedUrl(bam), toSignedUrl(bai), bam, bai, largeFileIntervals},\n+                {bucketPathToPublicHttpUrl(cram), bucketPathToPublicHttpUrl(crai), cram, crai, cramIntervals},\n+                {toSignedUrl(cram), toSignedUrl(crai), cram, crai, cramIntervals}\n+\n+        };\n+    }\n+\n+    @Test(groups = {\"cloud\", \"bucket\"}, dataProvider = \"getHttpPaths\")\n+    public void testHttpPaths(String reads, String index, String nonHttpReads, String nonHttpIndex, List<SimpleInterval> intervals) throws IOException {\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        final File out = createTempFile(\"out\", \".bam\");\n+        System.out.println(\"reading http\");\n+        args.addInput(reads)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)", "originalCommit": "d602d99b9a82adccddaddd93f886689ce8981114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTgzMjcxNg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401832716", "bodyText": "It downloads 40mb chunks around the 1kb spots it's looking for.", "author": "lbergelson", "createdAt": "2020-04-01T18:46:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MjMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MjYwOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401782609", "bodyText": "Use the logger instead of System.out.println()", "author": "droazen", "createdAt": "2020-04-01T17:22:04Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +52,66 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),\n+               new SimpleInterval(\"3\", 1_000_003, 1_000_100),\n+                new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+\n+        final List<SimpleInterval> cramIntervals = Arrays.asList(new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+        return new Object[][]{\n+                {bucketPathToPublicHttpUrl(bam), bucketPathToPublicHttpUrl(bai), bam, bai, largeFileIntervals},\n+                {toSignedUrl(bam), toSignedUrl(bai), bam, bai, largeFileIntervals},\n+                {bucketPathToPublicHttpUrl(cram), bucketPathToPublicHttpUrl(crai), cram, crai, cramIntervals},\n+                {toSignedUrl(cram), toSignedUrl(crai), cram, crai, cramIntervals}\n+\n+        };\n+    }\n+\n+    @Test(groups = {\"cloud\", \"bucket\"}, dataProvider = \"getHttpPaths\")\n+    public void testHttpPaths(String reads, String index, String nonHttpReads, String nonHttpIndex, List<SimpleInterval> intervals) throws IOException {\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        final File out = createTempFile(\"out\", \".bam\");\n+        System.out.println(\"reading http\");\n+        args.addInput(reads)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(\"read-index\", index)\n+                .addReference(GATKBaseTest.b37Reference)\n+                .addOutput(out);\n+        intervals.forEach(args::addInterval);\n+        runCommandLine(args);\n+\n+        System.out.println(\"reading gs\");", "originalCommit": "d602d99b9a82adccddaddd93f886689ce8981114", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MzEwNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r401783105", "bodyText": "Can you also assert that the output files are non-empty and contain the expected number of records given the intervals?", "author": "droazen", "createdAt": "2020-04-01T17:23:00Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +52,66 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),\n+               new SimpleInterval(\"3\", 1_000_003, 1_000_100),\n+                new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+\n+        final List<SimpleInterval> cramIntervals = Arrays.asList(new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+        return new Object[][]{\n+                {bucketPathToPublicHttpUrl(bam), bucketPathToPublicHttpUrl(bai), bam, bai, largeFileIntervals},\n+                {toSignedUrl(bam), toSignedUrl(bai), bam, bai, largeFileIntervals},\n+                {bucketPathToPublicHttpUrl(cram), bucketPathToPublicHttpUrl(crai), cram, crai, cramIntervals},\n+                {toSignedUrl(cram), toSignedUrl(crai), cram, crai, cramIntervals}\n+\n+        };\n+    }\n+\n+    @Test(groups = {\"cloud\", \"bucket\"}, dataProvider = \"getHttpPaths\")\n+    public void testHttpPaths(String reads, String index, String nonHttpReads, String nonHttpIndex, List<SimpleInterval> intervals) throws IOException {\n+        final ArgumentsBuilder args = new ArgumentsBuilder();\n+        final File out = createTempFile(\"out\", \".bam\");\n+        System.out.println(\"reading http\");\n+        args.addInput(reads)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(\"read-index\", index)\n+                .addReference(GATKBaseTest.b37Reference)\n+                .addOutput(out);\n+        intervals.forEach(args::addInterval);\n+        runCommandLine(args);\n+\n+        System.out.println(\"reading gs\");\n+        final ArgumentsBuilder args2 = new ArgumentsBuilder();\n+        final File out2 = createTempFile(\"out\", \".bam\");\n+        args2.addInput(nonHttpReads)\n+                .add(\"read-index\", nonHttpIndex)\n+                .add(StandardArgumentDefinitions.CLOUD_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .add(StandardArgumentDefinitions.CLOUD_INDEX_PREFETCH_BUFFER_LONG_NAME, 1)\n+                .addReference(GATKBaseTest.b37Reference)\n+                .addOutput(out2);\n+        intervals.forEach(args2::addInterval);\n+        runCommandLine(args2);\n+\n+        SamAssertionUtils.assertEqualBamFiles(out, out2, false, ValidationStringency.DEFAULT_STRINGENCY);", "originalCommit": "d602d99b9a82adccddaddd93f886689ce8981114", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgxOTk0Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r405819947", "bodyText": "Yes.. I should have done this.  It turns out I lost a digit somewhere and was reading the cram in the wrong location.", "author": "lbergelson", "createdAt": "2020-04-08T21:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4MzEwNQ=="}], "type": "inlineReview"}, {"oid": "fd83748eea2d6a1d53122b9285d4868fb7b994ad", "url": "https://github.com/broadinstitute/gatk/commit/fd83748eea2d6a1d53122b9285d4868fb7b994ad", "message": "Adding initial support for http(s) paths including signed urls.\n\n* Adding a beta version of http-nio which allows streaming http files and seeking within them.\n* This allows using https urls including signed urls to access remote files.\n* Bams/crams can be read by specifying the index manually.  Automatic index resolution does not work correctly at the moment.\n* known caveats\n    * some methods are not implement in the nio filesystem library yet\n    * failures are not retryied", "committedDate": "2020-04-06T21:16:41Z", "type": "commit"}, {"oid": "d4d3433013ded8fe81ce9fec09cf895de9d27295", "url": "https://github.com/broadinstitute/gatk/commit/d4d3433013ded8fe81ce9fec09cf895de9d27295", "message": "update to release version", "committedDate": "2020-04-06T21:16:41Z", "type": "commit"}, {"oid": "42cb03a8a025cf6063ecdd9da98767a14dc09a1e", "url": "https://github.com/broadinstitute/gatk/commit/42cb03a8a025cf6063ecdd9da98767a14dc09a1e", "message": "responding to comments", "committedDate": "2020-04-08T21:17:05Z", "type": "commit"}, {"oid": "42cb03a8a025cf6063ecdd9da98767a14dc09a1e", "url": "https://github.com/broadinstitute/gatk/commit/42cb03a8a025cf6063ecdd9da98767a14dc09a1e", "message": "responding to comments", "committedDate": "2020-04-08T21:17:05Z", "type": "forcePushed"}, {"oid": "caa035396ddb92944803f5742edbf770818c24bb", "url": "https://github.com/broadinstitute/gatk/commit/caa035396ddb92944803f5742edbf770818c24bb", "message": "more bucket utils changes", "committedDate": "2020-04-08T22:01:59Z", "type": "commit"}, {"oid": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "url": "https://github.com/broadinstitute/gatk/commit/d45831063016b39b2dab157f0f5b631f94cd4ce8", "message": "woops", "committedDate": "2020-04-08T22:04:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408217312", "bodyText": "It seems like this condition should actually be: \"if this is any kind of URL at all, return it unmodified\"", "author": "droazen", "createdAt": "2020-04-14T15:13:39Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/gcs/BucketUtils.java", "diffHunk": "@@ -89,7 +115,7 @@ public static boolean isRemoteStorageUrl(String path) {\n      * @return an absolute file path if the original path was a relative file path, otherwise the original path\n      */\n     public static String makeFilePathAbsolute(String path){\n-        if (isCloudStorageUrl(path) || isHadoopUrl(path) || isFileUrl(path)){\n+        if (isGcsUrl(path) || isHadoopUrl(path) || isFileUrl(path) || isHttpUrl(path)){\n             return path;", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1Nzc3Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408357772", "bodyText": "Yeah, this method is bad.  I guess a check for having a scheme of some sort would be reasonable.  We could also convert to Path and call toAbsolutePath().toUri().toString() Maybe we should do that.", "author": "lbergelson", "createdAt": "2020-04-14T18:46:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1OTYyNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408359625", "bodyText": "If you attempt the latter, you should be aware that the client code might be relying on paths to local files not turning into file:// URIs...", "author": "droazen", "createdAt": "2020-04-14T18:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4NzE3OA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408387178", "bodyText": "Nope, that doesn't work, it always adds a scheme.", "author": "lbergelson", "createdAt": "2020-04-14T19:37:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODE1NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408388155", "bodyText": "Is \"contains(\"://\") a valid test for scheme having? Or is that allowed later in a url?  I'm keeping this as is because it's spooky unless we come up with a safe way to do it.", "author": "lbergelson", "createdAt": "2020-04-14T19:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MDQ1MA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408390450", "bodyText": "You could do URI uri = new GATKPathSpecifier(path).getURI(). That will absolutize the path against the local file system only if its not already any kind of URL. Then if that URI has a file scheme, return uri.getPath(), which will be the absolute local path.\nOTOH I'm hoping to remove this method completely in my next uri PR so you could just leave it as is.", "author": "cmnbroad", "createdAt": "2020-04-14T19:44:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MDg4Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408390886", "bodyText": "I added a test for this method as well.", "author": "lbergelson", "createdAt": "2020-04-14T19:44:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NjM4Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408396386", "bodyText": "@cmnbroad I've left it as is.  Please kill it with fire :)", "author": "lbergelson", "createdAt": "2020-04-14T19:55:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxNzMxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxOTYxNA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408219614", "bodyText": "The comment \"Only apply the wrappers if the feature input is on Google Cloud Storage\" needs updating.", "author": "droazen", "createdAt": "2020-04-14T15:16:44Z", "path": "src/main/java/org/broadinstitute/hellbender/engine/FeatureDataSource.java", "diffHunk": "@@ -374,7 +374,7 @@ final void printCacheStats() {\n             final boolean requireIndex = false;\n \n             // Only apply the wrappers if the feature input is on Google Cloud Storage\n-            if (BucketUtils.isCloudStorageUrl(featureInput)) {\n+            if (BucketUtils.isEligibleForPrefetching(featureInput)) {", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1MzI0MA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408353240", "bodyText": "done", "author": "lbergelson", "createdAt": "2020-04-14T18:38:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIxOTYxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyNTE1OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408225159", "bodyText": "Would be better if you could call the isGcsUrl()/isHttpUrl() methods from here, but no big deal (@cmnbroad is probably going to refactor all of this code anyway as part of the GATKPathSpecifier migration..). More importantly: have you actually tested the prefetcher with HTTP/HTTPs inputs to make sure that it works properly?", "author": "droazen", "createdAt": "2020-04-14T15:23:59Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/gcs/BucketUtils.java", "diffHunk": "@@ -15,58 +19,80 @@\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.FileSystem;\n import org.apache.hadoop.fs.Path;\n-import org.apache.logging.log4j.LogManager;\n-import org.apache.logging.log4j.Logger;\n import org.broadinstitute.hellbender.engine.GATKPathSpecifier;\n import org.broadinstitute.hellbender.exceptions.GATKException;\n import org.broadinstitute.hellbender.exceptions.UserException;\n import org.broadinstitute.hellbender.utils.Utils;\n import org.broadinstitute.hellbender.utils.io.IOUtils;\n+import org.broadinstitute.http.nio.HttpFileSystemProvider;\n+import org.broadinstitute.http.nio.HttpsFileSystemProvider;\n import shaded.cloud_nio.com.google.api.gax.retrying.RetrySettings;\n import shaded.cloud_nio.com.google.auth.oauth2.GoogleCredentials;\n import shaded.cloud_nio.com.google.cloud.http.HttpTransportOptions;\n import shaded.cloud_nio.org.threeten.bp.Duration;\n \n import java.io.*;\n+import java.net.URL;\n import java.nio.channels.SeekableByteChannel;\n import java.nio.file.Files;\n import java.util.Arrays;\n import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n import java.util.function.Function;\n \n /**\n  * Utilities for dealing with google buckets.\n  */\n public final class BucketUtils {\n-    public static final String GCS_SCHEME = \"gs\";\n-    public static final String GCS_PREFIX = GCS_SCHEME + \"://\";\n+    public static final String GCS_PREFIX = GoogleCloudStorageFileSystem.SCHEME + \"://\";\n+    public static final String HTTP_PREFIX = HttpFileSystemProvider.SCHEME + \"://\";\n+    public static final String HTTPS_PREFIX = HttpsFileSystemProvider.SCHEME +\"://\";\n     public static final String HDFS_PREFIX = \"hdfs://\";\n \n     // slashes omitted since hdfs paths seem to only have 1 slash which would be weirder to include than no slashes\n     public static final String FILE_PREFIX = \"file:\";\n \n-    public static final Logger logger = LogManager.getLogger(\"org.broadinstitute.hellbender.utils.gcs\");\n-\n     private BucketUtils(){} //private so that no one will instantiate this class\n \n-    public static boolean isCloudStorageUrl(final String path) {\n+    /**\n+     * @param path path to inspect\n+     * @return true if this path represents a gcs location\n+     */\n+    public static boolean isGcsUrl(final String path) {\n         Utils.nonNull(path);\n         return path.startsWith(GCS_PREFIX);\n     }\n \n     /**\n-     * Return true if this {@code GATKPathSpecifier} represents a gcs URI.\n      * @param pathSpec specifier to inspect\n-     * @return true if this {@code GATKPathSpecifier} represents a gcs URI.\n+     * @return true if this {@code GATKPathSpecifier} represents a remote storage system which may benefit from prefetching (gcs or http(s))\n      */\n-    public static boolean isCloudStorageUrl(final GATKPathSpecifier pathSpec) {\n+    public static boolean isEligibleForPrefetching(final GATKPathSpecifier pathSpec) {\n         Utils.nonNull(pathSpec);\n-        return pathSpec.getScheme().equals(GCS_SCHEME);\n+        return isEligibleForPrefetching(pathSpec.getScheme());\n+     }\n+\n+    /**\n+     * @param path path to inspect\n+     * @return true if this {@code Path} represents a remote storage system which may benefit from prefetching (gcs or http(s))\n+     */\n+    public static boolean isEligibleForPrefetching(final java.nio.file.Path path) {\n+        Utils.nonNull(path);\n+        return isEligibleForPrefetching(path.toUri().getScheme());\n     }\n \n-    public static boolean isCloudStorageUrl(final java.nio.file.Path path) {\n-        // the initial \"\" protects us against a null scheme\n-        return (\"\" + path.toUri().getScheme() + \"://\").equals(GCS_PREFIX);\n+    private static boolean isEligibleForPrefetching(final String scheme){\n+        return scheme != null\n+                && (scheme.equals(GoogleCloudStorageFileSystem.SCHEME)\n+                || scheme.equals(HttpFileSystemProvider.SCHEME)\n+                || scheme.equals(HttpsFileSystemProvider.SCHEME));", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1NTI1Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408355256", "bodyText": "Yes, it's used in the the PrintReads http tests.  Going to leave it how it is because I factored it to use the scheme rather than the whole url at the moment.", "author": "lbergelson", "createdAt": "2020-04-14T18:41:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyNTE1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyNTY2NA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408225664", "bodyText": "Iif -> if", "author": "droazen", "createdAt": "2020-04-14T15:24:37Z", "path": "src/main/java/org/broadinstitute/hellbender/utils/gcs/BucketUtils.java", "diffHunk": "@@ -15,58 +19,80 @@\n import org.apache.hadoop.fs.FileStatus;\n import org.apache.hadoop.fs.FileSystem;\n import org.apache.hadoop.fs.Path;\n-import org.apache.logging.log4j.LogManager;\n-import org.apache.logging.log4j.Logger;\n import org.broadinstitute.hellbender.engine.GATKPathSpecifier;\n import org.broadinstitute.hellbender.exceptions.GATKException;\n import org.broadinstitute.hellbender.exceptions.UserException;\n import org.broadinstitute.hellbender.utils.Utils;\n import org.broadinstitute.hellbender.utils.io.IOUtils;\n+import org.broadinstitute.http.nio.HttpFileSystemProvider;\n+import org.broadinstitute.http.nio.HttpsFileSystemProvider;\n import shaded.cloud_nio.com.google.api.gax.retrying.RetrySettings;\n import shaded.cloud_nio.com.google.auth.oauth2.GoogleCredentials;\n import shaded.cloud_nio.com.google.cloud.http.HttpTransportOptions;\n import shaded.cloud_nio.org.threeten.bp.Duration;\n \n import java.io.*;\n+import java.net.URL;\n import java.nio.channels.SeekableByteChannel;\n import java.nio.file.Files;\n import java.util.Arrays;\n import java.util.UUID;\n+import java.util.concurrent.TimeUnit;\n import java.util.function.Function;\n \n /**\n  * Utilities for dealing with google buckets.\n  */\n public final class BucketUtils {\n-    public static final String GCS_SCHEME = \"gs\";\n-    public static final String GCS_PREFIX = GCS_SCHEME + \"://\";\n+    public static final String GCS_PREFIX = GoogleCloudStorageFileSystem.SCHEME + \"://\";\n+    public static final String HTTP_PREFIX = HttpFileSystemProvider.SCHEME + \"://\";\n+    public static final String HTTPS_PREFIX = HttpsFileSystemProvider.SCHEME +\"://\";\n     public static final String HDFS_PREFIX = \"hdfs://\";\n \n     // slashes omitted since hdfs paths seem to only have 1 slash which would be weirder to include than no slashes\n     public static final String FILE_PREFIX = \"file:\";\n \n-    public static final Logger logger = LogManager.getLogger(\"org.broadinstitute.hellbender.utils.gcs\");\n-\n     private BucketUtils(){} //private so that no one will instantiate this class\n \n-    public static boolean isCloudStorageUrl(final String path) {\n+    /**\n+     * @param path path to inspect\n+     * @return true if this path represents a gcs location\n+     */\n+    public static boolean isGcsUrl(final String path) {\n         Utils.nonNull(path);\n         return path.startsWith(GCS_PREFIX);\n     }\n \n     /**\n-     * Return true if this {@code GATKPathSpecifier} represents a gcs URI.\n      * @param pathSpec specifier to inspect\n-     * @return true if this {@code GATKPathSpecifier} represents a gcs URI.\n+     * @return true if this {@code GATKPathSpecifier} represents a remote storage system which may benefit from prefetching (gcs or http(s))\n      */\n-    public static boolean isCloudStorageUrl(final GATKPathSpecifier pathSpec) {\n+    public static boolean isEligibleForPrefetching(final GATKPathSpecifier pathSpec) {\n         Utils.nonNull(pathSpec);\n-        return pathSpec.getScheme().equals(GCS_SCHEME);\n+        return isEligibleForPrefetching(pathSpec.getScheme());\n+     }\n+\n+    /**\n+     * @param path path to inspect\n+     * @return true if this {@code Path} represents a remote storage system which may benefit from prefetching (gcs or http(s))\n+     */\n+    public static boolean isEligibleForPrefetching(final java.nio.file.Path path) {\n+        Utils.nonNull(path);\n+        return isEligibleForPrefetching(path.toUri().getScheme());\n     }\n \n-    public static boolean isCloudStorageUrl(final java.nio.file.Path path) {\n-        // the initial \"\" protects us against a null scheme\n-        return (\"\" + path.toUri().getScheme() + \"://\").equals(GCS_PREFIX);\n+    private static boolean isEligibleForPrefetching(final String scheme){\n+        return scheme != null\n+                && (scheme.equals(GoogleCloudStorageFileSystem.SCHEME)\n+                || scheme.equals(HttpFileSystemProvider.SCHEME)\n+                || scheme.equals(HttpsFileSystemProvider.SCHEME));\n+    }\n+\n+    /**\n+     * @return true Iif the given path is an http or https Url.", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM1NTQ4Ng==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408355486", "bodyText": "done", "author": "lbergelson", "createdAt": "2020-04-14T18:42:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyNTY2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyODYyMQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408228621", "bodyText": "This class should be named BucketUtilsUnitTest", "author": "droazen", "createdAt": "2020-04-14T15:28:17Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUtilsTest.java", "diffHunk": "@@ -4,23 +4,24 @@\n import com.google.cloud.storage.contrib.nio.SeekableByteChannelPrefetcher;\n import htsjdk.samtools.util.IOUtil;\n import org.broadinstitute.hellbender.GATKBaseTest;\n+import org.broadinstitute.hellbender.engine.GATKPathSpecifier;\n import org.broadinstitute.hellbender.testutils.MiniClusterUtils;\n import org.broadinstitute.hellbender.utils.config.ConfigFactory;\n+import org.broadinstitute.hellbender.utils.io.IOUtils;\n import org.testng.Assert;\n import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n \n import java.io.File;\n import java.io.FileWriter;\n import java.io.IOException;\n-import java.net.URI;\n-import java.nio.channels.FileChannel;\n import java.nio.channels.SeekableByteChannel;\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.util.function.Function;\n+import java.util.stream.Stream;\n \n public final class BucketUtilsTest extends GATKBaseTest {", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4OTg0OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408389849", "bodyText": "renamed", "author": "lbergelson", "createdAt": "2020-04-14T19:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyODYyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTUxNA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408229514", "bodyText": "largeFileIntervals -> bamIntervals", "author": "droazen", "createdAt": "2020-04-14T15:29:24Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +50,59 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4ODcxMA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408388710", "bodyText": "done", "author": "lbergelson", "createdAt": "2020-04-14T19:40:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIyOTUxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMDY0Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408230642", "bodyText": "I assume that you've verified these expected read counts using a code path that does not go through the new HTTP NIO provider?", "author": "droazen", "createdAt": "2020-04-14T15:30:53Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/PrintReadsIntegrationTest.java", "diffHunk": "@@ -39,4 +50,59 @@ public void testNoConflictPG() throws IOException {\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads\"));\n         Assert.assertNotNull(SamReaderFactory.makeDefault().open(outFile).getFileHeader().getProgramRecord(\"GATK PrintReads.1\"));\n     }\n+\n+    @DataProvider\n+    public Object[][] getHttpPaths(){\n+        final String bam = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam\";\n+        final String bai = \"gs://hellbender/test/resources/benchmark/CEUTrio.HiSeq.WEx.b37.NA12892.bam.bai\";\n+        final String cram = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram\";\n+        final String crai = \"gs://hellbender/test/resources/large/CEUTrio.HiSeq.WGS.b37.NA12878.20.21.cram.bai\";\n+        final List<SimpleInterval> largeFileIntervals = Arrays.asList(new SimpleInterval(\"3\",1_000_000, 1_000_001),\n+               new SimpleInterval(\"3\", 1_000_003, 1_000_100),\n+                new SimpleInterval(\"20\", 1_099_000, 1_100_000));\n+\n+        final List<SimpleInterval> cramIntervals = Arrays.asList(new SimpleInterval(\"20\", 9_999_902, 10_000_000));\n+        return new Object[][]{\n+                {BucketUtils.bucketPathToPublicHttpUrl(bam), BucketUtils.bucketPathToPublicHttpUrl(bai), bam, bai, largeFileIntervals, 528L},\n+                {BucketUtils.createSignedUrlToGcsObject(bam, 1L), BucketUtils.createSignedUrlToGcsObject(bai, 1L), bam, bai, largeFileIntervals, 528L},\n+                {BucketUtils.bucketPathToPublicHttpUrl(cram), BucketUtils.bucketPathToPublicHttpUrl(crai), cram, crai, cramIntervals, 112L},\n+                {BucketUtils.createSignedUrlToGcsObject(cram, 1L), BucketUtils.createSignedUrlToGcsObject(crai, 1L), cram, crai, cramIntervals, 112L}", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4OTMwOA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408389308", "bodyText": "I used the standard GCS nio provider as well.   I looked manually, but the test gets it with both http and gcs and compares the results to be sure they are the same.", "author": "lbergelson", "createdAt": "2020-04-14T19:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMDY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMzUxMg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408233512", "bodyText": "file:///", "author": "droazen", "createdAt": "2020-04-14T15:34:51Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUtilsTest.java", "diffHunk": "@@ -31,22 +32,36 @@\n     }\n \n     @Test(groups={\"bucket\"})\n-    public void testIsCloudStorageURL(){\n-        Assert.assertTrue(BucketUtils.isCloudStorageUrl(\"gs://abucket/bucket\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"hdfs://namenode/path/to/file\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"localFile\"));\n+    public void testIsGcsUrl(){\n+        Assert.assertTrue(BucketUtils.isGcsUrl(\"gs://abucket/bucket\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"hdfs://namenode/path/to/file\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"localFile\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"https://www.somewhere.com\"));\n+    }\n \n-        Assert.assertTrue(BucketUtils.isCloudStorageUrl(Paths.get(URI.create(\"gs://abucket/bucket\"))));\n-        // We cannot run this one because the HDFS provider looks for the \"namenode\" machine\n-        // and throws an exception.\n-        //Assert.assertFalse(BucketUtils.isCloudStorageUrl(Paths.get(URI.create(\"hdfs://namenode/path/to/file\"))));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(Paths.get(\"localFile\")));\n+    @DataProvider\n+    public Object[][] getVariousPathsForPrefetching(){\n+        return new Object[][]{\n+                {\"localFile\", false},\n+                {\"files:///local/file\", false},", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MTEyMA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408391120", "bodyText": "good catch, done", "author": "lbergelson", "createdAt": "2020-04-14T19:45:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMzUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMzk5OQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408233999", "bodyText": "You could unit test the HDFS case by calling the overload that takes the scheme as a raw String...", "author": "droazen", "createdAt": "2020-04-14T15:35:33Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUtilsTest.java", "diffHunk": "@@ -31,22 +32,36 @@\n     }\n \n     @Test(groups={\"bucket\"})\n-    public void testIsCloudStorageURL(){\n-        Assert.assertTrue(BucketUtils.isCloudStorageUrl(\"gs://abucket/bucket\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"hdfs://namenode/path/to/file\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"localFile\"));\n+    public void testIsGcsUrl(){\n+        Assert.assertTrue(BucketUtils.isGcsUrl(\"gs://abucket/bucket\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"hdfs://namenode/path/to/file\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"localFile\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"https://www.somewhere.com\"));\n+    }\n \n-        Assert.assertTrue(BucketUtils.isCloudStorageUrl(Paths.get(URI.create(\"gs://abucket/bucket\"))));\n-        // We cannot run this one because the HDFS provider looks for the \"namenode\" machine\n-        // and throws an exception.\n-        //Assert.assertFalse(BucketUtils.isCloudStorageUrl(Paths.get(URI.create(\"hdfs://namenode/path/to/file\"))));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(Paths.get(\"localFile\")));\n+    @DataProvider\n+    public Object[][] getVariousPathsForPrefetching(){\n+        return new Object[][]{\n+                {\"localFile\", false},\n+                {\"files:///local/file\", false},\n+                {\"http://www.somewhere.com\", true},\n+                {\"https://www.somewhere.com\", true},\n+               // {\"hdfs://namenode/path/to/file\", false}, skip this because it fails when namenode doesn't exist", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MjI4MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408392281", "bodyText": "It seems to work with the GATKPathSpecifier so I added a specific test for it.", "author": "lbergelson", "createdAt": "2020-04-14T19:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzMzk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNDcwOA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408234708", "bodyText": "Test file:// here as well", "author": "droazen", "createdAt": "2020-04-14T15:36:30Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUtilsTest.java", "diffHunk": "@@ -61,20 +76,26 @@ public void testIsHadoopURL(){\n         Assert.assertFalse(BucketUtils.isHadoopUrl(\"gs://abucket/bucket\"));\n         Assert.assertTrue(BucketUtils.isHadoopUrl(\"hdfs://namenode/path/to/file\"));\n         Assert.assertFalse(BucketUtils.isHadoopUrl(\"localFile\"));\n+        Assert.assertFalse(BucketUtils.isHadoopUrl(\"http://www.somewhere.com\"));\n+        Assert.assertFalse(BucketUtils.isHadoopUrl(\"https://www.somewhere.com\"));\n     }\n \n     @Test\n     public void testIsRemoteStorageURL(){\n         Assert.assertTrue(BucketUtils.isRemoteStorageUrl(\"gs://abucket/bucket\"));\n         Assert.assertTrue(BucketUtils.isRemoteStorageUrl(\"hdfs://namenode/path/to/file\"));\n         Assert.assertFalse(BucketUtils.isRemoteStorageUrl(\"localFile\"));\n+        Assert.assertTrue(BucketUtils.isRemoteStorageUrl(\"http://www.somewhere.com\"));\n+        Assert.assertTrue(BucketUtils.isRemoteStorageUrl(\"https://www.somewhere.com\"));", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MjY4Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408392687", "bodyText": "done", "author": "lbergelson", "createdAt": "2020-04-14T19:48:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNDcwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNTQyOQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408235429", "bodyText": "Can you add a unit test like this for isHttpUrl() as well?", "author": "droazen", "createdAt": "2020-04-14T15:37:33Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUtilsTest.java", "diffHunk": "@@ -31,22 +32,36 @@\n     }\n \n     @Test(groups={\"bucket\"})\n-    public void testIsCloudStorageURL(){\n-        Assert.assertTrue(BucketUtils.isCloudStorageUrl(\"gs://abucket/bucket\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"hdfs://namenode/path/to/file\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"localFile\"));\n+    public void testIsGcsUrl(){\n+        Assert.assertTrue(BucketUtils.isGcsUrl(\"gs://abucket/bucket\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"hdfs://namenode/path/to/file\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"localFile\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"https://www.somewhere.com\"));\n+    }", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MDczOA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408390738", "bodyText": "done", "author": "lbergelson", "createdAt": "2020-04-14T19:44:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNTQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNjQzMA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408236430", "bodyText": "Is this really a \"cloud\" test? It just does local String operations.", "author": "droazen", "createdAt": "2020-04-14T15:38:48Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUtilsTest.java", "diffHunk": "@@ -202,4 +223,27 @@ public void testGetWrapper(int bufferSize, boolean prefetchingIsEnabled) throws\n             Assert.assertEquals(wrapped instanceof SeekableByteChannelPrefetcher, prefetchingIsEnabled);\n         }\n     }\n+\n+    @Test(groups=\"cloud\")\n+    public void testCreateSignedUrl() throws IOException {\n+        final String gcsPathString = getGCPTestInputPath() + \"nio/big.txt\";\n+        Assert.assertTrue(Files.exists(IOUtils.getPath(gcsPathString)), \"test file is missing, \" + gcsPathString);\n+\n+        final String signed = BucketUtils.createSignedUrlToGcsObject(gcsPathString, 1);\n+        final Path path = IOUtils.getPath(signed);\n+        Assert.assertTrue(signed.startsWith(\"https://\"), \"path doesn't star with https, \" + signed);\n+        Assert.assertTrue(signed.contains(\"big.txt\"), \"path is missing blob name, \"+ signed);\n+        Assert.assertTrue(Files.exists(path), \"path doesn't exist: \" + signed);\n+        try(final Stream<String> lines = Files.lines(path))  {\n+            Assert.assertTrue(lines.anyMatch(line -> line.contains(\"The Project Gutenberg EBook of The Adventures of Sherlock Holmes\")), \"blob data is incorrect, \" + signed);\n+        }\n+    }\n+\n+    @Test(groups=\"cloud\")\n+    public void testBucketPathToPublicHttpUrl(){", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5NDgyMQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408394821", "bodyText": "I wavered between testing for the existence of the files vs not doing so.  I've added checks to make sure both files exist so we're warned if the gcs -> http path scheme changes.", "author": "lbergelson", "createdAt": "2020-04-14T19:52:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNjQzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNjc1NA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408236754", "bodyText": "star -> start", "author": "droazen", "createdAt": "2020-04-14T15:39:14Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUtilsTest.java", "diffHunk": "@@ -202,4 +223,27 @@ public void testGetWrapper(int bufferSize, boolean prefetchingIsEnabled) throws\n             Assert.assertEquals(wrapped instanceof SeekableByteChannelPrefetcher, prefetchingIsEnabled);\n         }\n     }\n+\n+    @Test(groups=\"cloud\")\n+    public void testCreateSignedUrl() throws IOException {\n+        final String gcsPathString = getGCPTestInputPath() + \"nio/big.txt\";\n+        Assert.assertTrue(Files.exists(IOUtils.getPath(gcsPathString)), \"test file is missing, \" + gcsPathString);\n+\n+        final String signed = BucketUtils.createSignedUrlToGcsObject(gcsPathString, 1);\n+        final Path path = IOUtils.getPath(signed);\n+        Assert.assertTrue(signed.startsWith(\"https://\"), \"path doesn't star with https, \" + signed);", "originalCommit": "d45831063016b39b2dab157f0f5b631f94cd4ce8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5Mjk2Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408392962", "bodyText": "\u2b50", "author": "lbergelson", "createdAt": "2020-04-14T19:48:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODIzNjc1NA=="}], "type": "inlineReview"}, {"oid": "528f73ae6cc9b7fa03aaa63aab19acaafc54b640", "url": "https://github.com/broadinstitute/gatk/commit/528f73ae6cc9b7fa03aaa63aab19acaafc54b640", "message": "re-responding to comments", "committedDate": "2020-04-14T19:53:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxOTI4Mg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408419282", "bodyText": "BucketUnitUtilsTest -> BucketUtilsUnitTest", "author": "droazen", "createdAt": "2020-04-14T20:36:32Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUnitUtilsTest.java", "diffHunk": "@@ -4,25 +4,26 @@\n import com.google.cloud.storage.contrib.nio.SeekableByteChannelPrefetcher;\n import htsjdk.samtools.util.IOUtil;\n import org.broadinstitute.hellbender.GATKBaseTest;\n+import org.broadinstitute.hellbender.engine.GATKPathSpecifier;\n import org.broadinstitute.hellbender.testutils.MiniClusterUtils;\n import org.broadinstitute.hellbender.utils.config.ConfigFactory;\n+import org.broadinstitute.hellbender.utils.io.IOUtils;\n import org.testng.Assert;\n import org.testng.annotations.DataProvider;\n import org.testng.annotations.Test;\n \n import java.io.File;\n import java.io.FileWriter;\n import java.io.IOException;\n-import java.net.URI;\n-import java.nio.channels.FileChannel;\n import java.nio.channels.SeekableByteChannel;\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.security.GeneralSecurityException;\n import java.util.function.Function;\n+import java.util.stream.Stream;\n \n-public final class BucketUtilsTest extends GATKBaseTest {\n+public final class BucketUnitUtilsTest extends GATKBaseTest {", "originalCommit": "528f73ae6cc9b7fa03aaa63aab19acaafc54b640", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNDc5Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408434793", "bodyText": "\ud83e\udd26 \ud83e\udd26", "author": "lbergelson", "createdAt": "2020-04-14T21:05:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQxOTI4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMDQ0OA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408420448", "bodyText": "Where's the unit test for isHttpUrl()?", "author": "droazen", "createdAt": "2020-04-14T20:38:44Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUnitUtilsTest.java", "diffHunk": "@@ -31,20 +32,39 @@\n     }\n \n     @Test(groups={\"bucket\"})\n-    public void testIsCloudStorageURL(){\n-        Assert.assertTrue(BucketUtils.isCloudStorageUrl(\"gs://abucket/bucket\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"hdfs://namenode/path/to/file\"));\n-        Assert.assertFalse(BucketUtils.isCloudStorageUrl(\"localFile\"));\n+    public void testIsGcsUrl(){\n+        Assert.assertTrue(BucketUtils.isGcsUrl(\"gs://abucket/bucket\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"hdfs://namenode/path/to/file\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"localFile\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"https://www.somewhere.com\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"http://www.somewhere.com\"));\n+        Assert.assertFalse(BucketUtils.isGcsUrl(\"https://www.somewhere.com\"));\n+    }", "originalCommit": "528f73ae6cc9b7fa03aaa63aab19acaafc54b640", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNjMwMg==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408436302", "bodyText": "oh, I misread what you were asking, added", "author": "lbergelson", "createdAt": "2020-04-14T21:08:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMDQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMjA3NA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408422074", "bodyText": "existanc -> existence", "author": "droazen", "createdAt": "2020-04-14T20:41:36Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUnitUtilsTest.java", "diffHunk": "@@ -202,4 +244,28 @@ public void testGetWrapper(int bufferSize, boolean prefetchingIsEnabled) throws\n             Assert.assertEquals(wrapped instanceof SeekableByteChannelPrefetcher, prefetchingIsEnabled);\n         }\n     }\n+\n+    @Test(groups=\"cloud\")\n+    public void testCreateSignedUrl() throws IOException {\n+        final String gcsPathString = getGCPTestInputPath() + \"nio/big.txt\";\n+        Assert.assertTrue(Files.exists(IOUtils.getPath(gcsPathString)), \"test file is missing, \" + gcsPathString);\n+\n+        final String signed = BucketUtils.createSignedUrlToGcsObject(gcsPathString, 1);\n+        final Path path = IOUtils.getPath(signed);\n+        Assert.assertTrue(signed.startsWith(\"https://\"), \"path doesn't start with https, \" + signed);\n+        Assert.assertTrue(signed.contains(\"big.txt\"), \"path is missing blob name, \"+ signed);\n+        Assert.assertTrue(Files.exists(path), \"path doesn't exist: \" + signed);\n+        try(final Stream<String> lines = Files.lines(path))  {\n+            Assert.assertTrue(lines.anyMatch(line -> line.contains(\"The Project Gutenberg EBook of The Adventures of Sherlock Holmes\")), \"blob data is incorrect, \" + signed);\n+        }\n+    }\n+\n+    @Test(groups=\"cloud\")\n+    public void testBucketPathToPublicHttpUrl(){\n+        final String gcsPathString = \"gs://hellbender/test/resources/nio/big.txt\"; //note this doesn't actually check the existanc", "originalCommit": "528f73ae6cc9b7fa03aaa63aab19acaafc54b640", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNjU3MA==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408436570", "bodyText": "this comment should actually just be removed.", "author": "lbergelson", "createdAt": "2020-04-14T21:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMjA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMjQ2MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408422461", "bodyText": "Just checking that the runtime of this test is reasonable (since the file is named \"big.txt\")?", "author": "droazen", "createdAt": "2020-04-14T20:42:18Z", "path": "src/test/java/org/broadinstitute/hellbender/utils/gcs/BucketUnitUtilsTest.java", "diffHunk": "@@ -202,4 +244,28 @@ public void testGetWrapper(int bufferSize, boolean prefetchingIsEnabled) throws\n             Assert.assertEquals(wrapped instanceof SeekableByteChannelPrefetcher, prefetchingIsEnabled);\n         }\n     }\n+\n+    @Test(groups=\"cloud\")\n+    public void testCreateSignedUrl() throws IOException {\n+        final String gcsPathString = getGCPTestInputPath() + \"nio/big.txt\";\n+        Assert.assertTrue(Files.exists(IOUtils.getPath(gcsPathString)), \"test file is missing, \" + gcsPathString);\n+\n+        final String signed = BucketUtils.createSignedUrlToGcsObject(gcsPathString, 1);\n+        final Path path = IOUtils.getPath(signed);\n+        Assert.assertTrue(signed.startsWith(\"https://\"), \"path doesn't start with https, \" + signed);\n+        Assert.assertTrue(signed.contains(\"big.txt\"), \"path is missing blob name, \"+ signed);\n+        Assert.assertTrue(Files.exists(path), \"path doesn't exist: \" + signed);\n+        try(final Stream<String> lines = Files.lines(path))  {\n+            Assert.assertTrue(lines.anyMatch(line -> line.contains(\"The Project Gutenberg EBook of The Adventures of Sherlock Holmes\")), \"blob data is incorrect, \" + signed);", "originalCommit": "528f73ae6cc9b7fa03aaa63aab19acaafc54b640", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNjY3NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6526#discussion_r408436675", "bodyText": "yeah, that's the first line", "author": "lbergelson", "createdAt": "2020-04-14T21:08:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMjQ2MQ=="}], "type": "inlineReview"}, {"oid": "aa27912b60d2ba685ed6d2a98c0c357934dbdf12", "url": "https://github.com/broadinstitute/gatk/commit/aa27912b60d2ba685ed6d2a98c0c357934dbdf12", "message": "fix", "committedDate": "2020-04-14T21:09:32Z", "type": "commit"}]}