{"pr_number": 6868, "pr_title": "Fix HaplotypeCaller crash due to IUPAC base", "pr_createdAt": "2020-10-07T14:29:24Z", "pr_url": "https://github.com/broadinstitute/gatk/pull/6868", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc3NTU5Mw==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r501775593", "bodyText": "And this is because there is an R in the reference at this site and that gets propagated into the CRAM reads correct?", "author": "jamesemery", "createdAt": "2020-10-08T14:40:07Z", "path": "src/test/java/org/broadinstitute/hellbender/tools/walkers/haplotypecaller/HaplotypeCallerIntegrationTest.java", "diffHunk": "@@ -1319,6 +1319,31 @@ public void testAdjacentIndels() {\n                 .allMatch(vc -> vc.isBiallelic() && (vc.getReference().length() == 1 || vc.getAlternateAllele(0).length() == 1)));\n     }\n \n+    /*\n+    Prior to IUPAC ReadTransformer fix, this test yields\n+    java.lang.IllegalArgumentException: Unexpected base in allele bases 'ATTCATTTCACAAGGGTAAAGCTTTCTTTGGATTCAGCAGGTTGGAAAATCTGTTTTTCACCTTTCTGTGAATGGACGTTTGGGAGCTCATTGAGGCCAGTGRCAATAAAGGAGATATCTCAGGGTGAAAAATAAAAGACAGGAATGTGAGAATTGGCTTTGTGATGTGAGCATTCATTTCACAAAGTTAAACCTTTCTTTTCATTCAGCAGTTAGAAATCACTGGTTTTGTAGAATCTG'\n+    where there's an R in that big long string representing the assembled haplotype.", "originalCommit": "fee113007004111134ec68928c61210805ba3b6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU0OTg2MQ==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r502549861", "bodyText": "Exactly.  I added that note.", "author": "ldgauthier", "createdAt": "2020-10-09T16:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc3NTU5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MjkyNw==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r501782927", "bodyText": "Hmm... I'm tempted to say this should actually be true for the HaplotypeCaller. If the input really has bases that aren't even IUPAC then do we really want to silently allow them?", "author": "jamesemery", "createdAt": "2020-10-08T14:49:25Z", "path": "src/main/java/org/broadinstitute/hellbender/transformers/IUPACReadTransformer.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.broadinstitute.hellbender.transformers;\n+\n+import org.broadinstitute.hellbender.utils.BaseUtils;\n+import org.broadinstitute.hellbender.utils.read.GATKRead;\n+\n+public class IUPACReadTransformer implements ReadTransformer {\n+    private static final long serialVersionUID = 1L;\n+    private boolean strictMode;\n+\n+    public IUPACReadTransformer() {\n+        this.strictMode = false;", "originalCommit": "fee113007004111134ec68928c61210805ba3b6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU0OTgwMg==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r502549802", "bodyText": "Okay, I left the default as false, but constructed the HC transformer with strict=true.", "author": "ldgauthier", "createdAt": "2020-10-09T16:39:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MjkyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MzQ0OA==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r501783448", "bodyText": "I would add a javadoc here that explains that this transformation is done in-place without copying.", "author": "jamesemery", "createdAt": "2020-10-08T14:50:00Z", "path": "src/main/java/org/broadinstitute/hellbender/transformers/IUPACReadTransformer.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.broadinstitute.hellbender.transformers;\n+\n+import org.broadinstitute.hellbender.utils.BaseUtils;\n+import org.broadinstitute.hellbender.utils.read.GATKRead;\n+\n+public class IUPACReadTransformer implements ReadTransformer {", "originalCommit": "fee113007004111134ec68928c61210805ba3b6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4ODAyNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r501788025", "bodyText": "Furthermore I would probably also provide an explanation for why this is necessary with cram reads.", "author": "jamesemery", "createdAt": "2020-10-08T14:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MzQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU0OTk3NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r502549975", "bodyText": "Done.", "author": "ldgauthier", "createdAt": "2020-10-09T16:39:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4MzQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4OTE4NQ==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r501789185", "bodyText": "You can take this or leave it. I actually think it might be useful to attach a one-shot-logger to this that warns the user that this has happened for some of their reads and spits out the readname so they can check later. Given how this is set up it might be a bit of a hassle though...", "author": "jamesemery", "createdAt": "2020-10-08T14:57:06Z", "path": "src/main/java/org/broadinstitute/hellbender/transformers/IUPACReadTransformer.java", "diffHunk": "@@ -0,0 +1,23 @@\n+package org.broadinstitute.hellbender.transformers;\n+\n+import org.broadinstitute.hellbender.utils.BaseUtils;\n+import org.broadinstitute.hellbender.utils.read.GATKRead;\n+\n+public class IUPACReadTransformer implements ReadTransformer {\n+    private static final long serialVersionUID = 1L;\n+    private boolean strictMode;\n+\n+    public IUPACReadTransformer() {\n+        this.strictMode = false;\n+    }\n+\n+    public IUPACReadTransformer(final boolean strictMode) {\n+        this.strictMode = strictMode;\n+    }\n+\n+    @Override\n+    public GATKRead apply(GATKRead read) {\n+        read.setBases(BaseUtils.convertIUPACtoN(read.getBases(), strictMode, false));", "originalCommit": "fee113007004111134ec68928c61210805ba3b6b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1MDAyNQ==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r502550025", "bodyText": "That's a really good point.  I have something I'm happy enough with, but let me know if you can think of something more efficient.", "author": "ldgauthier", "createdAt": "2020-10-09T16:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc4OTE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU5Mjg4Nw==", "url": "https://github.com/broadinstitute/gatk/pull/6868#discussion_r502592887", "bodyText": "This looks like an expensive string to construct. This should be pushed into a supplier (so () <- {STRING_STUFF} and you should add an overload in the one shot logger that takes a supplier and only feeds it to the underlying logger if it hasn't spoken yet:\n    /**\n     * Logs a message which is only to be constructed if the logging level is the {@link Level#WARN WARN} level.\n     *\n     * @param msgSupplier A function, which when called, produces the desired log message; the format depends on the\n     *            message factory.\n     * @since 2.4\n     */\n    void warn(Supplier<?> msgSupplier);", "author": "jamesemery", "createdAt": "2020-10-09T18:05:13Z", "path": "src/main/java/org/broadinstitute/hellbender/transformers/IUPACReadTransformer.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package org.broadinstitute.hellbender.transformers;\n+\n+import org.broadinstitute.hellbender.utils.BaseUtils;\n+import org.broadinstitute.hellbender.utils.logging.OneShotLogger;\n+import org.broadinstitute.hellbender.utils.read.GATKRead;\n+\n+import java.util.Arrays;\n+import java.util.stream.Collectors;\n+import java.util.stream.IntStream;\n+\n+/**\n+ * A read transformer to convert IUPAC bases (i.e. non-ATCGs) to Ns\n+ * Some references (like human hg38) contain IUPAC bases that can be propagated into the reads when decoding cram\n+ * This transformation is done in-place without copying\n+ */\n+public class IUPACReadTransformer implements ReadTransformer {\n+    private static final long serialVersionUID = 1L;\n+    private boolean strictMode;\n+    private OneShotLogger logger = new OneShotLogger(this.getClass());\n+\n+    public IUPACReadTransformer() {\n+        this.strictMode = false;\n+    }\n+\n+    public IUPACReadTransformer(final boolean strictMode) {\n+        this.strictMode = strictMode;\n+    }\n+\n+    @Override\n+    public GATKRead apply(GATKRead read) {\n+        final byte[] maybeTransformed = BaseUtils.convertIUPACtoN(read.getBases(), strictMode, false);\n+        if (!Arrays.equals(read.getBases(), maybeTransformed)) {\n+            logger.warn(\"At least one read contains IUPAC bases that have been transformed.  Read \" + read.getName() + \" contains: \"", "originalCommit": "3d2b799614fa3202f4b33e4bb273ddff0b31d6c8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "72b1b8c3c1e2981b28c976318fdf44a5c897c46a", "url": "https://github.com/broadinstitute/gatk/commit/72b1b8c3c1e2981b28c976318fdf44a5c897c46a", "message": "Broad production crams can be read back in with IUPAC bases, which\nhtsjdk doesn't condone.  Run a read transformer to clean them up by\ndefault.", "committedDate": "2020-10-28T15:20:30Z", "type": "commit"}, {"oid": "72b1b8c3c1e2981b28c976318fdf44a5c897c46a", "url": "https://github.com/broadinstitute/gatk/commit/72b1b8c3c1e2981b28c976318fdf44a5c897c46a", "message": "Broad production crams can be read back in with IUPAC bases, which\nhtsjdk doesn't condone.  Run a read transformer to clean them up by\ndefault.", "committedDate": "2020-10-28T15:20:30Z", "type": "forcePushed"}]}