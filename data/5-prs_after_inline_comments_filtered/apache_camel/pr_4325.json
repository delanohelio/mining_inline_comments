{"pr_number": 4325, "pr_title": "camel-platform-http-vertx: handle requests using a thread from the worker pool", "pr_createdAt": "2020-09-30T13:31:02Z", "pr_url": "https://github.com/apache/camel/pull/4325", "timeline": [{"oid": "b83291ef2b682cf58c2724b238e2e791e4580384", "url": "https://github.com/apache/camel/commit/b83291ef2b682cf58c2724b238e2e791e4580384", "message": "camel-platform-http-vertx: handle requests using a thread from the worker pool", "committedDate": "2020-09-30T13:39:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1Nzk5NA==", "url": "https://github.com/apache/camel/pull/4325#discussion_r497557994", "bodyText": "You should favour async processor anyway as that makes camel use it where it can", "author": "davsclaus", "createdAt": "2020-09-30T14:31:37Z", "path": "components/camel-platform-http-vertx/src/main/java/org/apache/camel/component/platform/http/vertx/VertxPlatformHttpConsumer.java", "diffHunk": "@@ -163,6 +146,63 @@ private String configureEndpointPath(PlatformHttpEndpoint endpoint) {\n         return PATH_PARAMETER_PATTERN.matcher(path).replaceAll(\":$1\");\n     }\n \n+    private void handleRequest(RoutingContext ctx) {\n+        final Vertx vertx = ctx.vertx();\n+        final Exchange exchange = toExchange(ctx);\n+\n+        //\n+        // We do not know if any of the processing logic of the route is synchronous or not so we\n+        // need to process the request on a thread on the Vert.x worker pool.\n+        //\n+        // As example, assuming the platform-http component is configured as the transport provider\n+        // for the rest dsl, then the following code may result in a blocking operation that could\n+        // block Vert.x event-loop for too long if the target service takes long to respond, as\n+        // example in case the service is a knative service scaled to zero that could take some time\n+        // to be come available:\n+        //\n+        //     rest(\"/results\")\n+        //         .get(\"/{id}\")\n+        //         .route()\n+        //             .removeHeaders(\"*\", \"CamelHttpPath\")\n+        //             .to(\"rest:get:?bridgeEndpoint=true\");\n+        //\n+        vertx.executeBlocking(\n+                promise -> {\n+                    try {\n+                        createUoW(exchange);\n+\n+                        // no need to use an async processor as the processing happen in\n+                        // a dedicated thread ans it won't block the Vert.x event loop\n+                        getProcessor().process(exchange);", "originalCommit": "b83291ef2b682cf58c2724b238e2e791e4580384", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2MzMxMw==", "url": "https://github.com/apache/camel/pull/4325#discussion_r497563313", "bodyText": "@davsclaus something like: getAsyncProcessor().process(exchange, c -> promise.complete()); ?", "author": "lburgazzoli", "createdAt": "2020-09-30T14:38:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1Nzk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2Mzg5Nw==", "url": "https://github.com/apache/camel/pull/4325#discussion_r497563897", "bodyText": "Yes exactly", "author": "davsclaus", "createdAt": "2020-09-30T14:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1Nzk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NTk5NQ==", "url": "https://github.com/apache/camel/pull/4325#discussion_r497565995", "bodyText": "or maybe better\ngetAsyncProcessor().process(exchange, c -> {\n    if (!exchange.isFailed()) {\n        promise.complete();\n    } else {\n        promise.fail(exchange.getException());\n    }\n});", "author": "lburgazzoli", "createdAt": "2020-09-30T14:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1Nzk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2NjU3MA==", "url": "https://github.com/apache/camel/pull/4325#discussion_r497566570", "bodyText": "@davsclaus ^", "author": "lburgazzoli", "createdAt": "2020-09-30T14:42:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1Nzk5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU2OTgzNg==", "url": "https://github.com/apache/camel/pull/4325#discussion_r497569836", "bodyText": "Yeah just be sure that when promise.fail will also trigger the result block (I dont know what it does) as the UoW must be done as it does below in the finally block", "author": "davsclaus", "createdAt": "2020-09-30T14:46:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzU1Nzk5NA=="}], "type": "inlineReview"}, {"oid": "972be666afa90fc4ca32e11341e5915188ae8fa4", "url": "https://github.com/apache/camel/commit/972be666afa90fc4ca32e11341e5915188ae8fa4", "message": "camel-platform-http-vertx: handle requests using a thread from the worker pool", "committedDate": "2020-09-30T14:57:04Z", "type": "commit"}, {"oid": "972be666afa90fc4ca32e11341e5915188ae8fa4", "url": "https://github.com/apache/camel/commit/972be666afa90fc4ca32e11341e5915188ae8fa4", "message": "camel-platform-http-vertx: handle requests using a thread from the worker pool", "committedDate": "2020-09-30T14:57:04Z", "type": "forcePushed"}]}