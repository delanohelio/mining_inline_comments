{"pr_number": 3760, "pr_title": "[CAMEL-14932] Add new Splunk HEC component", "pr_createdAt": "2020-04-20T00:36:28Z", "pr_url": "https://github.com/apache/camel/pull/3760", "timeline": [{"oid": "d681dd5d29aea54297ab1327a3f93fbd82ba11f1", "url": "https://github.com/apache/camel/commit/d681dd5d29aea54297ab1327a3f93fbd82ba11f1", "message": "[CAMEL-14932] Add new Splunk HEC component", "committedDate": "2020-04-20T00:45:32Z", "type": "commit"}, {"oid": "d681dd5d29aea54297ab1327a3f93fbd82ba11f1", "url": "https://github.com/apache/camel/commit/d681dd5d29aea54297ab1327a3f93fbd82ba11f1", "message": "[CAMEL-14932] Add new Splunk HEC component", "committedDate": "2020-04-20T00:45:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2MzgxMA==", "url": "https://github.com/apache/camel/pull/3760#discussion_r411163810", "bodyText": "Isn't better to have httpClient.close before super.doStop()?", "author": "omarsmak", "createdAt": "2020-04-20T07:44:53Z", "path": "components/camel-splunk-hec/src/main/java/org/apache/camel/component/splunkhec/SplunkHECProducer.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.component.splunkhec;\n+\n+\n+import java.io.ByteArrayOutputStream;\n+import java.nio.charset.StandardCharsets;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.apache.camel.Exchange;\n+import org.apache.camel.Message;\n+import org.apache.camel.support.DefaultProducer;\n+import org.apache.http.client.methods.CloseableHttpResponse;\n+import org.apache.http.client.methods.HttpPost;\n+import org.apache.http.conn.ssl.NoopHostnameVerifier;\n+import org.apache.http.conn.ssl.SSLConnectionSocketFactory;\n+import org.apache.http.entity.ContentType;\n+import org.apache.http.entity.EntityTemplate;\n+import org.apache.http.impl.client.CloseableHttpClient;\n+import org.apache.http.impl.client.HttpClientBuilder;\n+import org.apache.http.impl.client.HttpClients;\n+import org.apache.http.ssl.SSLContextBuilder;\n+\n+/**\n+ * The Splunk HEC producer.\n+ */\n+public class SplunkHECProducer extends DefaultProducer {\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    private SplunkHECEndpoint endpoint;\n+    private CloseableHttpClient httpClient;\n+\n+\n+    public SplunkHECProducer(SplunkHECEndpoint endpoint) {\n+        super(endpoint);\n+        this.endpoint = endpoint;\n+    }\n+\n+    @Override\n+    protected void doStart() throws Exception {\n+        super.doStart();\n+        HttpClientBuilder builder = HttpClients.custom().\n+                setUserAgent(\"Camel Splunk HEC/\" + getEndpoint().getCamelContext().getVersion()).\n+                setMaxConnTotal(10);\n+        if (endpoint.getConfiguration().isSkiptlsverify()) {\n+            SSLContextBuilder sslbuilder = new SSLContextBuilder();\n+            sslbuilder.loadTrustMaterial(null, (chain, authType) -> true);\n+            SSLConnectionSocketFactory sslsf = new\n+                    SSLConnectionSocketFactory(sslbuilder.build(), NoopHostnameVerifier.INSTANCE);\n+            builder.setSSLSocketFactory(sslsf);\n+        }\n+        httpClient = builder.build();\n+    }\n+\n+    @Override\n+    public void process(Exchange exchange) throws Exception {\n+        Map<String, Object> payload = createPayload(exchange.getIn());\n+\n+        HttpPost httppost = new HttpPost((endpoint.getConfiguration().isHttps() ? \"https\" : \"http\") + \"://\" + endpoint.getSplunkURL() + \"/services/collector/event\");\n+        httppost.addHeader(\"Authorization\", \" Splunk \" + endpoint.getToken());\n+\n+        EntityTemplate entityTemplate = new EntityTemplate(outputStream -> MAPPER.writer().writeValue(outputStream, payload));\n+        entityTemplate.setContentType(ContentType.APPLICATION_JSON.getMimeType());\n+\n+        httppost.setEntity(entityTemplate);\n+        try (CloseableHttpResponse response = httpClient.execute(httppost)) {\n+            if (response.getStatusLine().getStatusCode() != 200) {\n+                ByteArrayOutputStream output = new ByteArrayOutputStream();\n+                response.getEntity().writeTo(output);\n+\n+                throw new RuntimeException(response.getStatusLine().toString() + \"\\n\" + new String(output.toByteArray(), StandardCharsets.UTF_8));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    protected void doStop() throws Exception {\n+        super.doStop();\n+        httpClient.close();", "originalCommit": "d681dd5d29aea54297ab1327a3f93fbd82ba11f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzNzA1Mw==", "url": "https://github.com/apache/camel/pull/3760#discussion_r411537053", "bodyText": "I'm seeing file and seda behave differently there. I think super.doStop() should be first so it logs the stop operation. If the client throws an exception, at least you get the log before.", "author": "atoulme", "createdAt": "2020-04-20T16:54:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2MzgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMjY4MQ==", "url": "https://github.com/apache/camel/pull/3760#discussion_r411212681", "bodyText": "@atoulme it would be nice to use camel case, however it's a little bit tautology for Camel project :)", "author": "dmvolod", "createdAt": "2020-04-20T09:01:37Z", "path": "components/camel-splunk-hec/src/main/java/org/apache/camel/component/splunkhec/SplunkHECConfiguration.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.component.splunkhec;\n+\n+import java.net.UnknownHostException;\n+\n+import org.apache.camel.spi.UriParam;\n+import org.apache.camel.spi.UriParams;\n+import org.apache.camel.util.HostUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@UriParams\n+public class SplunkHECConfiguration {\n+    private static final transient Logger LOG = LoggerFactory.getLogger(SplunkHECConfiguration.class);\n+\n+    @UriParam(label = \"producer\")\n+    private String index = \"camel\";\n+    @UriParam(label = \"producer\")\n+    private String sourceType = \"camel\";\n+    @UriParam(label = \"producer\")\n+    private String source = \"camel\";\n+    @UriParam(label = \"host\")\n+    private String host;\n+    @UriParam(label = \"skiptlsverify\")\n+    private boolean skiptlsverify;", "originalCommit": "d681dd5d29aea54297ab1327a3f93fbd82ba11f1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzOTU1OA==", "url": "https://github.com/apache/camel/pull/3760#discussion_r411539558", "bodyText": "Sure thing. Fixed!", "author": "atoulme", "createdAt": "2020-04-20T16:58:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMjY4MQ=="}], "type": "inlineReview"}, {"oid": "839e9d8cfd2181379dbe5a5a16f0b53294562026", "url": "https://github.com/apache/camel/commit/839e9d8cfd2181379dbe5a5a16f0b53294562026", "message": "address code review comments", "committedDate": "2020-04-20T16:58:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg2NzM4OQ==", "url": "https://github.com/apache/camel/pull/3760#discussion_r411867389", "bodyText": "You need to specify default value in @UriParam when it has a value, also for the ones that has camel above.", "author": "davsclaus", "createdAt": "2020-04-21T04:51:54Z", "path": "components/camel-splunk-hec/src/main/java/org/apache/camel/component/splunkhec/SplunkHECConfiguration.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.component.splunkhec;\n+\n+import java.net.UnknownHostException;\n+\n+import org.apache.camel.spi.UriParam;\n+import org.apache.camel.spi.UriParams;\n+import org.apache.camel.util.HostUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+@UriParams\n+public class SplunkHECConfiguration {\n+    private static final transient Logger LOG = LoggerFactory.getLogger(SplunkHECConfiguration.class);\n+\n+    @UriParam(label = \"producer\")\n+    private String index = \"camel\";\n+    @UriParam(label = \"producer\")\n+    private String sourceType = \"camel\";\n+    @UriParam(label = \"producer\")\n+    private String source = \"camel\";\n+    @UriParam(label = \"producer\")\n+    private String host;\n+    @UriParam(label = \"producer\")\n+    private boolean skipTlsVerify;\n+    @UriParam(label = \"producer\")", "originalCommit": "839e9d8cfd2181379dbe5a5a16f0b53294562026", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTg2NzY2OQ==", "url": "https://github.com/apache/camel/pull/3760#discussion_r411867669", "bodyText": "@UriPath must match the syntax splunk-hec:endpoint/token, eg having 2 UriPath named endpoint and token. Otherwise change the syntax to splunk-hec:endpointUri to match the current @UriPath name.", "author": "davsclaus", "createdAt": "2020-04-21T04:52:58Z", "path": "components/camel-splunk-hec/src/main/java/org/apache/camel/component/splunkhec/SplunkHECEndpoint.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.camel.component.splunkhec;\n+\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+import org.apache.camel.Consumer;\n+import org.apache.camel.Processor;\n+import org.apache.camel.Producer;\n+import org.apache.camel.spi.UriEndpoint;\n+import org.apache.camel.spi.UriParam;\n+import org.apache.camel.spi.UriPath;\n+import org.apache.camel.support.DefaultEndpoint;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * The splunk component allows to publish events in Splunk using the HTTP Event Collector.\n+ */\n+@UriEndpoint(firstVersion = \"3.3.0\", scheme = \"splunk-hec\", title = \"Splunk HEC\", syntax = \"splunk-hec:endpoint/token\", label = \"log,monitoring\")\n+public class SplunkHECEndpoint extends DefaultEndpoint {\n+\n+    private static final Logger LOG = LoggerFactory.getLogger(SplunkHECEndpoint.class);\n+    private static final Pattern URI_PARSER = Pattern.compile(\"splunk-hec\\\\:\\\\/?\\\\/?(\\\\w+):(\\\\d+)/(\\\\w{8}-\\\\w{4}-\\\\w{4}-\\\\w{4}-\\\\w{12})\\\\??.*\");\n+\n+    @UriPath", "originalCommit": "839e9d8cfd2181379dbe5a5a16f0b53294562026", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}