{"pr_number": 3944, "pr_title": "CAMEL-14319: upgrade couchbase java client to 3.0.5", "pr_createdAt": "2020-06-24T11:44:13Z", "pr_url": "https://github.com/apache/camel/pull/3944", "timeline": [{"oid": "c791030e2ca22b2e015648fab38865c6c1466216", "url": "https://github.com/apache/camel/commit/c791030e2ca22b2e015648fab38865c6c1466216", "message": "CAMEL-14319: upgrade couchbase java client to 3.0.5\nrefactor component to work with newer client\nremove options that were removed in newer clients\nadd possibility to specify collection and scope for newer couchbase", "committedDate": "2020-06-24T11:54:03Z", "type": "forcePushed"}, {"oid": "e937fd6f69b894a9459c063a1299eda4277d3720", "url": "https://github.com/apache/camel/commit/e937fd6f69b894a9459c063a1299eda4277d3720", "message": "CAMEL-14319: upgrade couchbase java client to 3.0.5\nrefactor component to work with newer client\nremove options that were removed in newer clients\nadd possibility to specify collection and scope for newer couchbase", "committedDate": "2020-06-24T11:55:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg0MDE5MA==", "url": "https://github.com/apache/camel/pull/3944#discussion_r444840190", "bodyText": "Formatting here is bit troublesome as it shows it big change meanwhile it is formatting", "author": "omarsmak", "createdAt": "2020-06-24T11:55:07Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseComponent.java", "diffHunk": "@@ -1,44 +1,44 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.camel.component.couchbase;\n-\n-import java.util.Map;\n-\n-import org.apache.camel.CamelContext;\n-import org.apache.camel.spi.annotations.Component;\n-import org.apache.camel.support.DefaultComponent;\n-\n-/**\n- * Couchbase component.\n- */\n-@Component(\"couchbase\")\n-public class CouchbaseComponent extends DefaultComponent {\n-\n-    public CouchbaseComponent() {\n-    }\n-\n-    public CouchbaseComponent(CamelContext context) {\n-        super(context);\n-    }\n-\n-    @Override\n-    protected CouchbaseEndpoint createEndpoint(String uri, String remaining, Map<String, Object> parameters) throws Exception {\n-        CouchbaseEndpoint endpoint = new CouchbaseEndpoint(uri, remaining, this);\n-        setProperties(endpoint, parameters);\n-        return endpoint;\n-    }\n-}\n+/*\r", "originalCommit": "c791030e2ca22b2e015648fab38865c6c1466216", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg0MTg3MA==", "url": "https://github.com/apache/camel/pull/3944#discussion_r444841870", "bodyText": "Please retain from loading all statics through the wildcard", "author": "omarsmak", "createdAt": "2020-06-24T11:58:39Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseEndpoint.java", "diffHunk": "@@ -37,21 +41,7 @@\n import org.apache.camel.spi.UriPath;\n import org.apache.camel.support.ScheduledPollEndpoint;\n \n-import static org.apache.camel.component.couchbase.CouchbaseConstants.COUCHBASE_PUT;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.COUCHBASE_URI_ERROR;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_CONSUME_PROCESSED_STRATEGY;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_COUCHBASE_PORT;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_DESIGN_DOCUMENT_NAME;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_MAX_RECONNECT_DELAY;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_OBS_POLL_INTERVAL;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_OBS_TIMEOUT;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_OP_QUEUE_MAX_BLOCK_TIME;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_OP_TIMEOUT;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_PAUSE_BETWEEN_RETRIES;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_PRODUCER_RETRIES;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_READ_BUFFER_SIZE;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_TIMEOUT_EXCEPTION_THRESHOLD;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.DEFAULT_VIEWNAME;\n+import static org.apache.camel.component.couchbase.CouchbaseConstants.*;", "originalCommit": "e937fd6f69b894a9459c063a1299eda4277d3720", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de26c793bd40b02a9abc14d226e9c8614f27e96d", "url": "https://github.com/apache/camel/commit/de26c793bd40b02a9abc14d226e9c8614f27e96d", "message": "CAMEL-14319: upgrade couchbase java client to 3.0.5\nrefactor component to work with newer client\nremove options that were removed in newer clients\nadd possibility to specify collection and scope for newer couchbase", "committedDate": "2020-06-24T12:39:24Z", "type": "forcePushed"}, {"oid": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "url": "https://github.com/apache/camel/commit/39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "message": "CAMEL-14319: upgrade couchbase java client to 3.0.5\nrefactor component to work with newer client\nremove options that were removed in newer clients\nadd possibility to specify collection and scope for newer couchbase", "committedDate": "2020-06-25T05:49:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2NjIxMg==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445366212", "bodyText": "Instead of a default value that is _default. Then why not leave it as null/empty and then use that to know if a custom scope was set or not", "author": "davsclaus", "createdAt": "2020-06-25T07:40:59Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseConsumer.java", "diffHunk": "@@ -16,65 +16,76 @@\n  */\n package org.apache.camel.component.couchbase;\n \n-import com.couchbase.client.CouchbaseClient;\n-import com.couchbase.client.protocol.views.Query;\n-import com.couchbase.client.protocol.views.View;\n-import com.couchbase.client.protocol.views.ViewResponse;\n-import com.couchbase.client.protocol.views.ViewRow;\n+import java.util.List;\n+\n+import com.couchbase.client.java.Bucket;\n+import com.couchbase.client.java.Collection;\n+import com.couchbase.client.java.Scope;\n+import com.couchbase.client.java.view.ViewOptions;\n+import com.couchbase.client.java.view.ViewOrdering;\n+import com.couchbase.client.java.view.ViewResult;\n+import com.couchbase.client.java.view.ViewRow;\n import org.apache.camel.Exchange;\n import org.apache.camel.Processor;\n import org.apache.camel.support.DefaultScheduledPollConsumer;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_DESIGN_DOCUMENT_NAME;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_ID;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_KEY;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_VIEWNAME;\n+import static org.apache.camel.component.couchbase.CouchbaseConstants.*;\n \n public class CouchbaseConsumer extends DefaultScheduledPollConsumer {\n \n     private static final Logger LOG = LoggerFactory.getLogger(CouchbaseConsumer.class);\n \n     private final CouchbaseEndpoint endpoint;\n-    private final CouchbaseClient client;\n-    private final View view;\n-    private final Query query;\n-\n-    public CouchbaseConsumer(CouchbaseEndpoint endpoint, CouchbaseClient client, Processor processor) {\n+    private final Bucket bucket;\n+    private ViewOptions viewOptions;\n+    private Collection collection;\n \n+    public CouchbaseConsumer(CouchbaseEndpoint endpoint, Bucket client, Processor processor) {\n         super(endpoint, processor);\n-        this.client = client;\n+        this.bucket = client;\n         this.endpoint = endpoint;\n-        this.view = client.getView(endpoint.getDesignDocumentName(), endpoint.getViewName());\n-        this.query = new Query();\n+        Scope scope;\n+        if (!endpoint.getScope().equals(DEFAULT_SCOPE)) {", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTUyNzMxOQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445527319", "bodyText": "yeah, that's a valid point. Will do.", "author": "mmelko", "createdAt": "2020-06-25T12:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2NjIxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2NjMxNw==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445366317", "bodyText": "The same as for default scope", "author": "davsclaus", "createdAt": "2020-06-25T07:41:09Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseConsumer.java", "diffHunk": "@@ -16,65 +16,76 @@\n  */\n package org.apache.camel.component.couchbase;\n \n-import com.couchbase.client.CouchbaseClient;\n-import com.couchbase.client.protocol.views.Query;\n-import com.couchbase.client.protocol.views.View;\n-import com.couchbase.client.protocol.views.ViewResponse;\n-import com.couchbase.client.protocol.views.ViewRow;\n+import java.util.List;\n+\n+import com.couchbase.client.java.Bucket;\n+import com.couchbase.client.java.Collection;\n+import com.couchbase.client.java.Scope;\n+import com.couchbase.client.java.view.ViewOptions;\n+import com.couchbase.client.java.view.ViewOrdering;\n+import com.couchbase.client.java.view.ViewResult;\n+import com.couchbase.client.java.view.ViewRow;\n import org.apache.camel.Exchange;\n import org.apache.camel.Processor;\n import org.apache.camel.support.DefaultScheduledPollConsumer;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_DESIGN_DOCUMENT_NAME;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_ID;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_KEY;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_VIEWNAME;\n+import static org.apache.camel.component.couchbase.CouchbaseConstants.*;\n \n public class CouchbaseConsumer extends DefaultScheduledPollConsumer {\n \n     private static final Logger LOG = LoggerFactory.getLogger(CouchbaseConsumer.class);\n \n     private final CouchbaseEndpoint endpoint;\n-    private final CouchbaseClient client;\n-    private final View view;\n-    private final Query query;\n-\n-    public CouchbaseConsumer(CouchbaseEndpoint endpoint, CouchbaseClient client, Processor processor) {\n+    private final Bucket bucket;\n+    private ViewOptions viewOptions;\n+    private Collection collection;\n \n+    public CouchbaseConsumer(CouchbaseEndpoint endpoint, Bucket client, Processor processor) {\n         super(endpoint, processor);\n-        this.client = client;\n+        this.bucket = client;\n         this.endpoint = endpoint;\n-        this.view = client.getView(endpoint.getDesignDocumentName(), endpoint.getViewName());\n-        this.query = new Query();\n+        Scope scope;\n+        if (!endpoint.getScope().equals(DEFAULT_SCOPE)) {\n+            scope = client.scope(endpoint.getScope());\n+        } else {\n+            scope = client.defaultScope();\n+        }\n+\n+        if (!endpoint.getCollection().equals(DEFAULT_COLLECTION)) {", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2Njc4MQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445366781", "bodyText": "See my prev comments about default", "author": "davsclaus", "createdAt": "2020-06-25T07:42:01Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseEndpoint.java", "diffHunk": "@@ -70,6 +71,12 @@\n \n     @UriParam\n     private String bucket;\n+    //\n+    @UriParam(defaultValue = \"_default\")\n+    private String collection = DEFAULT_COLLECTION;", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2NjgzNg==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445366836", "bodyText": "Remove this", "author": "davsclaus", "createdAt": "2020-06-25T07:42:08Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseEndpoint.java", "diffHunk": "@@ -70,6 +71,12 @@\n \n     @UriParam\n     private String bucket;\n+    //", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2NzIzNQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445367235", "bodyText": "Do we know from couchbase what scopes is possible? If its like an enum then we can specify that via @UriParam so we have that information", "author": "davsclaus", "createdAt": "2020-06-25T07:42:52Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseEndpoint.java", "diffHunk": "@@ -225,6 +219,28 @@ public void setPort(int port) {\n         this.port = port;\n     }\n \n+    /**\n+     * The collection to use\n+     */\n+    public String getCollection() {\n+        return this.collection;\n+    }\n+\n+    public void setCollection(String collection) {\n+        this.collection = collection;\n+    }\n+\n+    public String getScope() {\n+        return this.scope;\n+    }\n+\n+    /**\n+     * The scope to use", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTUyNjk2NA==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445526964", "bodyText": "I believe you can create custom scopes with custom name .. so it's definitely not a enum.", "author": "mmelko", "createdAt": "2020-06-25T12:41:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2NzIzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2NzQwOQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445367409", "bodyText": "in milli seconds", "author": "davsclaus", "createdAt": "2020-06-25T07:43:09Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseEndpoint.java", "diffHunk": "@@ -434,98 +450,21 @@ public void setConsumerProcessedStrategy(String consumerProcessedStrategy) {\n         this.consumerProcessedStrategy = consumerProcessedStrategy;\n     }\n \n-    public long getOpTimeOut() {\n-        return opTimeOut;\n+    public long getQueryTimeout() {\n+        return queryTimeout;\n     }\n \n     /**\n      * Define the operation timeout", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2ODI2NQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445368265", "bodyText": "if isDebugEnabled", "author": "davsclaus", "createdAt": "2020-06-25T07:44:47Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseProducer.java", "diffHunk": "@@ -149,21 +151,20 @@ private Boolean setDocument(String id, int expiry, Object obj, PersistTo persist\n \n     private Boolean setDocument(String id, int expiry, Object obj, int retryAttempts, PersistTo persistTo, ReplicateTo replicateTo) throws Exception {\n \n-        OperationFuture<Boolean> result = client.set(id, expiry, obj, persistTo, replicateTo);\n+        UpsertOptions options = UpsertOptions.upsertOptions()\n+                .expiry(Duration.ofSeconds(expiry))\n+                .durability(persistTo, replicateTo)\n+                .timeout(Duration.ofMillis(retryAttempts * producerRetryPause))\n+                .retryStrategy(BestEffortRetryStrategy.withExponentialBackoff(Duration.ofMillis(producerRetryPause), Duration.ofMillis(producerRetryPause), 1));\n+\n         try {\n-            if (!result.get()) {\n-                throw new Exception(\"Unable to save Document. \" + id);\n-            }\n-            return true;\n+            MutationResult result = collection.upsert(id, obj, options);\n+            LOG.debug(result.toString());", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM2ODQzMA==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445368430", "bodyText": "Dont log and throw, just throw", "author": "davsclaus", "createdAt": "2020-06-25T07:45:02Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseProducer.java", "diffHunk": "@@ -149,21 +151,20 @@ private Boolean setDocument(String id, int expiry, Object obj, PersistTo persist\n \n     private Boolean setDocument(String id, int expiry, Object obj, int retryAttempts, PersistTo persistTo, ReplicateTo replicateTo) throws Exception {\n \n-        OperationFuture<Boolean> result = client.set(id, expiry, obj, persistTo, replicateTo);\n+        UpsertOptions options = UpsertOptions.upsertOptions()\n+                .expiry(Duration.ofSeconds(expiry))\n+                .durability(persistTo, replicateTo)\n+                .timeout(Duration.ofMillis(retryAttempts * producerRetryPause))\n+                .retryStrategy(BestEffortRetryStrategy.withExponentialBackoff(Duration.ofMillis(producerRetryPause), Duration.ofMillis(producerRetryPause), 1));\n+\n         try {\n-            if (!result.get()) {\n-                throw new Exception(\"Unable to save Document. \" + id);\n-            }\n-            return true;\n+            MutationResult result = collection.upsert(id, obj, options);\n+            LOG.debug(result.toString());\n         } catch (Exception e) {\n-            if (retryAttempts <= 0) {\n-                throw e;\n-            } else {\n-                LOG.info(\"Unable to save Document, retrying in \" + producerRetryPause + \"ms (\" + retryAttempts + \")\");\n-                Thread.sleep(producerRetryPause);\n-                return setDocument(id, expiry, obj, retryAttempts - 1, persistTo, replicateTo);\n-            }\n+            LOG.error(\"Unable to save Document\");", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM3OTUxOA==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445379518", "bodyText": "Formatting issues. Can you please take a look at your IDE settings perhaps?", "author": "omarsmak", "createdAt": "2020-06-25T08:04:47Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseComponent.java", "diffHunk": "@@ -1,44 +1,44 @@\n-/*\n- * Licensed to the Apache Software Foundation (ASF) under one or more\n- * contributor license agreements.  See the NOTICE file distributed with\n- * this work for additional information regarding copyright ownership.\n- * The ASF licenses this file to You under the Apache License, Version 2.0\n- * (the \"License\"); you may not use this file except in compliance with\n- * the License.  You may obtain a copy of the License at\n- *\n- *      http://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n- */\n-package org.apache.camel.component.couchbase;\n-\n-import java.util.Map;\n-\n-import org.apache.camel.CamelContext;\n-import org.apache.camel.spi.annotations.Component;\n-import org.apache.camel.support.DefaultComponent;\n-\n-/**\n- * Couchbase component.\n- */\n-@Component(\"couchbase\")\n-public class CouchbaseComponent extends DefaultComponent {\n-\n-    public CouchbaseComponent() {\n-    }\n-\n-    public CouchbaseComponent(CamelContext context) {\n-        super(context);\n-    }\n-\n-    @Override\n-    protected CouchbaseEndpoint createEndpoint(String uri, String remaining, Map<String, Object> parameters) throws Exception {\n-        CouchbaseEndpoint endpoint = new CouchbaseEndpoint(uri, remaining, this);\n-        setProperties(endpoint, parameters);\n-        return endpoint;\n-    }\n-}\n+/*\r\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\r\n+ * contributor license agreements.  See the NOTICE file distributed with\r\n+ * this work for additional information regarding copyright ownership.\r\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\r\n+ * (the \"License\"); you may not use this file except in compliance with\r\n+ * the License.  You may obtain a copy of the License at\r\n+ *\r\n+ *      http://www.apache.org/licenses/LICENSE-2.0\r\n+ *\r\n+ * Unless required by applicable law or agreed to in writing, software\r\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\r\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\r\n+ * See the License for the specific language governing permissions and\r\n+ * limitations under the License.\r\n+ */\r\n+package org.apache.camel.component.couchbase;\r\n+\r\n+import java.util.Map;\r\n+\r\n+import org.apache.camel.CamelContext;\r\n+import org.apache.camel.spi.annotations.Component;\r\n+import org.apache.camel.support.DefaultComponent;\r\n+\r\n+/**\r\n+ * Couchbase component.\r\n+ */\r\n+@Component(\"couchbase\")\r\n+public class  CouchbaseComponent extends DefaultComponent {\r", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTUyNDc1MA==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445524750", "bodyText": "Thanks for comments. I'm running it with sourcecheck profile. I will recheck my IDE settings.", "author": "mmelko", "createdAt": "2020-06-25T12:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM3OTUxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM3OTY0NQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445379645", "bodyText": "here as well", "author": "omarsmak", "createdAt": "2020-06-25T08:04:58Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseConstants.java", "diffHunk": "@@ -28,6 +28,8 @@\n     String COUCHBASE_DELETE = \"CCB_DEL\";\n     String DEFAULT_DESIGN_DOCUMENT_NAME = \"beer\";\n     String DEFAULT_VIEWNAME = \"brewery_beers\";\n+    String  DEFAULT_COLLECTION = \"_default\";", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4MDExOQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445380119", "bodyText": "wildcard import. Please avoid it", "author": "omarsmak", "createdAt": "2020-06-25T08:05:45Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseConsumer.java", "diffHunk": "@@ -16,65 +16,76 @@\n  */\n package org.apache.camel.component.couchbase;\n \n-import com.couchbase.client.CouchbaseClient;\n-import com.couchbase.client.protocol.views.Query;\n-import com.couchbase.client.protocol.views.View;\n-import com.couchbase.client.protocol.views.ViewResponse;\n-import com.couchbase.client.protocol.views.ViewRow;\n+import java.util.List;\n+\n+import com.couchbase.client.java.Bucket;\n+import com.couchbase.client.java.Collection;\n+import com.couchbase.client.java.Scope;\n+import com.couchbase.client.java.view.ViewOptions;\n+import com.couchbase.client.java.view.ViewOrdering;\n+import com.couchbase.client.java.view.ViewResult;\n+import com.couchbase.client.java.view.ViewRow;\n import org.apache.camel.Exchange;\n import org.apache.camel.Processor;\n import org.apache.camel.support.DefaultScheduledPollConsumer;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_DESIGN_DOCUMENT_NAME;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_ID;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_KEY;\n-import static org.apache.camel.component.couchbase.CouchbaseConstants.HEADER_VIEWNAME;\n+import static org.apache.camel.component.couchbase.CouchbaseConstants.*;", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTM4MzIyMg==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445383222", "bodyText": "This meant to check if is an empty string, isn't? Then wouldn't be better something like:\nif(!addHosts.isEmpty())", "author": "omarsmak", "createdAt": "2020-06-25T08:11:14Z", "path": "components/camel-couchbase/src/main/java/org/apache/camel/component/couchbase/CouchbaseEndpoint.java", "diffHunk": "@@ -554,37 +493,32 @@ public void setObsTimeout(long obsTimeout) {\n         return uriArray;\n     }\n \n-    private CouchbaseClient createClient() throws IOException, URISyntaxException {\n+    //create from couchbase-client\n+    private Bucket createClient() throws IOException, URISyntaxException {\n         List<URI> hosts = Arrays.asList(makeBootstrapURI());\n+        String connectionString;\n \n-        CouchbaseConnectionFactoryBuilder cfb = new CouchbaseConnectionFactoryBuilder();\n-\n-        if (opTimeOut != DEFAULT_OP_TIMEOUT) {\n-            cfb.setOpTimeout(opTimeOut);\n+        ClusterEnvironment.Builder cfb = ClusterEnvironment.builder();\n+        if (queryTimeout != DEFAULT_QUERY_TIMEOUT) {\n+            cfb.timeoutConfig().queryTimeout(Duration.ofMillis(queryTimeout));\n         }\n-        if (timeoutExceptionThreshold != DEFAULT_TIMEOUT_EXCEPTION_THRESHOLD) {\n-            cfb.setTimeoutExceptionThreshold(timeoutExceptionThreshold);\n-        }\n-        if (readBufferSize != DEFAULT_READ_BUFFER_SIZE) {\n-            cfb.setReadBufferSize(readBufferSize);\n-        }\n-        if (shouldOptimize) {\n-            cfb.setShouldOptimize(true);\n-        }\n-        if (maxReconnectDelay != DEFAULT_MAX_RECONNECT_DELAY) {\n-            cfb.setMaxReconnectDelay(maxReconnectDelay);\n-        }\n-        if (opQueueMaxBlockTime != DEFAULT_OP_QUEUE_MAX_BLOCK_TIME) {\n-            cfb.setOpQueueMaxBlockTime(opQueueMaxBlockTime);\n-        }\n-        if (obsPollInterval != DEFAULT_OBS_POLL_INTERVAL) {\n-            cfb.setObsPollInterval(obsPollInterval);\n-        }\n-        if (obsTimeout != DEFAULT_OBS_TIMEOUT) {\n-            cfb.setObsTimeout(obsTimeout);\n+\n+        ClusterEnvironment env = cfb.build();\n+\n+        String addHosts = hosts.stream()\n+                .map(URI::getHost)\n+                .collect(Collectors.joining(\",\"));\n+\n+        if (!\"\".equals(addHosts)) {", "originalCommit": "39a80cbf011ecc0970d14cc8e3ffbcc7196ffc46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4c33d79680a711414f56ed0a9974ccce4aa9b642", "url": "https://github.com/apache/camel/commit/4c33d79680a711414f56ed0a9974ccce4aa9b642", "message": "CAMEL-14319: upgrade couchbase java client to 3.0.5\nrefactor component to work with newer client\nremove options that were removed in newer clients\nadd possibility to specify collection and scope for newer couchbase", "committedDate": "2020-06-25T13:23:48Z", "type": "commit"}, {"oid": "4c33d79680a711414f56ed0a9974ccce4aa9b642", "url": "https://github.com/apache/camel/commit/4c33d79680a711414f56ed0a9974ccce4aa9b642", "message": "CAMEL-14319: upgrade couchbase java client to 3.0.5\nrefactor component to work with newer client\nremove options that were removed in newer clients\nadd possibility to specify collection and scope for newer couchbase", "committedDate": "2020-06-25T13:23:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU5NjI1OQ==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445596259", "bodyText": "Need to remove this", "author": "davsclaus", "createdAt": "2020-06-25T14:21:43Z", "path": "components/camel-couchbase/src/test/java/org/apache/camel/component/couchbase/CouchbaseProducerTest.java", "diffHunk": "@@ -58,16 +66,21 @@\n     private Message msg;\n \n     @Mock\n-    private OperationFuture<?> response;\n+    private MutationResult response;\n+//    Observable<String> myStringObservable", "originalCommit": "4c33d79680a711414f56ed0a9974ccce4aa9b642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU5NjQyMA==", "url": "https://github.com/apache/camel/pull/3944#discussion_r445596420", "bodyText": "Remove this", "author": "davsclaus", "createdAt": "2020-06-25T14:21:56Z", "path": "components/camel-couchbase/src/test/java/org/apache/camel/component/couchbase/CouchbaseProducerTest.java", "diffHunk": "@@ -107,111 +120,28 @@ public void testMaximumValuesForPersistToAndRepicateTo() throws Exception {\n         producer = new CouchbaseProducer(endpoint, client, 4, 3);\n     }\n \n+    //", "originalCommit": "4c33d79680a711414f56ed0a9974ccce4aa9b642", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}