{"pr_number": 1266, "pr_title": "SAMZA-2452 : Adding internal autosizing related configs", "pr_createdAt": "2020-02-03T19:32:59Z", "pr_url": "https://github.com/apache/samza/pull/1266", "timeline": [{"oid": "ad4685c0f2ba6734f7fd98cfd7b1a7ed8ddb1637", "url": "https://github.com/apache/samza/commit/ad4685c0f2ba6734f7fd98cfd7b1a7ed8ddb1637", "message": "Adding internal autosizing related configs", "committedDate": "2020-02-03T19:30:42Z", "type": "commit"}, {"oid": "fc052c1da6d1ec70c5859e5aa0b73bcacc61cba2", "url": "https://github.com/apache/samza/commit/fc052c1da6d1ec70c5859e5aa0b73bcacc61cba2", "message": "Adding javadoc", "committedDate": "2020-02-03T19:53:26Z", "type": "commit"}, {"oid": "02454631d2c544e7b1119146b81d3df1a6dbe57e", "url": "https://github.com/apache/samza/commit/02454631d2c544e7b1119146b81d3df1a6dbe57e", "message": "Adding missing read for autosizing enabled", "committedDate": "2020-02-03T21:48:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1MjY1NA==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374852654", "bodyText": "Should this use getAutosizingEnabled instead of checking the config directly? Then if getAutosizingEnabled gets changed in the future, this would not change.", "author": "cameronlee314", "createdAt": "2020-02-04T18:42:54Z", "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -143,8 +143,15 @@ public int getAllocatorSleepTime() {\n     }\n   }\n \n+  /**\n+   * Return the value of CLUSTER_MANAGER_MAX_CORES or CONTAINER_MAX_CPU_CORES (in that order) if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_MAX_CORES.\n+   * @return\n+   */\n   public int getNumCores() {\n-    if (containsKey(CLUSTER_MANAGER_MAX_CORES)) {\n+    if (getBoolean(JobConfig.JOB_AUTOSIZING_ENABLED, false) && containsKey(JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_CORES)) {", "originalCommit": "02454631d2c544e7b1119146b81d3df1a6dbe57e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1Mjc2OQ==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374852769", "bodyText": "Same about using getAutosizingEnabled", "author": "cameronlee314", "createdAt": "2020-02-04T18:43:08Z", "path": "samza-core/src/main/java/org/apache/samza/config/ClusterManagerConfig.java", "diffHunk": "@@ -154,8 +161,15 @@ public int getNumCores() {\n     }\n   }\n \n+  /**\n+   * Return the value of CLUSTER_MANAGER_MEMORY_MB or CONTAINER_MAX_MEMORY_MB (in that order) if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_MEMORY_MB.\n+   * @return\n+   */\n   public int getContainerMemoryMb() {\n-    if (containsKey(CLUSTER_MANAGER_MEMORY_MB)) {\n+    if (getBoolean(JobConfig.JOB_AUTOSIZING_ENABLED, false) && containsKey(JobConfig.JOB_AUTOSIZING_CONTAINER_MEMORY_MB)) {", "originalCommit": "02454631d2c544e7b1119146b81d3df1a6dbe57e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1NDA4NQ==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374854085", "bodyText": "Could you please use autosizing instead of autoscaling to keep terminology consistent?", "author": "cameronlee314", "createdAt": "2020-02-04T18:45:35Z", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -165,9 +174,18 @@ public String getCoordinatorSystemNameOrNull() {\n     return Optional.ofNullable(get(JOB_DEFAULT_SYSTEM));\n   }\n \n+  /**\n+   * Return the value of JOB_CONTAINER_COUNT or \"yarn.container.count\" (in that order) if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_COUNT.\n+   * @return\n+   */\n   public int getContainerCount() {\n+    Optional<String> autoscalingContainerCountValue = Optional.ofNullable(get(JOB_AUTOSIZING_CONTAINER_COUNT));", "originalCommit": "02454631d2c544e7b1119146b81d3df1a6dbe57e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1NDY4OQ==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374854689", "bodyText": "Same about autosizing instead of autoscaling.", "author": "cameronlee314", "createdAt": "2020-02-04T18:46:38Z", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -286,8 +304,19 @@ public String getSSPMatcherConfigJobFactoryRegex() {\n     return get(SSP_MATCHER_CONFIG_JOB_FACTORY_REGEX, DEFAULT_SSP_MATCHER_CONFIG_JOB_FACTORY_REGEX);\n   }\n \n+  /**\n+   * Return the value of JOB_CONTAINER_THREAD_POOL_SIZE if autosizing is not enabled,\n+   * otherwise returns the value of JOB_AUTOSIZING_CONTAINER_THREAD_POOL_SIZE.\n+   * @return\n+   */\n   public int getThreadPoolSize() {\n-    return getInt(JOB_CONTAINER_THREAD_POOL_SIZE, 0);\n+    Optional<String> autoscalingContainerThreadPoolSize = Optional.ofNullable(get(", "originalCommit": "02454631d2c544e7b1119146b81d3df1a6dbe57e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1ODgyMg==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374858822", "bodyText": "If someone adds a new autosizing config, then it might not be obvious to remember to update this method, especially since it is a couple hundred lines away from the config key declaration.\nHere are a couple suggestions that might help:\n\nCreate a new enum class in which each autosizing config is a value in the enum. Then, you could use Enum.values() to create a set of autosizing configs. This is nice, because someone only needs to add the enum value, and then the code automatically picks it up.\nCreate a static Set of autosizing keys, and then declare that set as a static variable right next to where you declare the autosizing constants. There is still a chance of forgetting to update the set, but it's at least close in proximity to the declarations.\nChange the implementation of this method to check that the config key matches a prefix (e.g. job.autosizing). It's \"convention\"-y, but then no one will need to update this implementation as long as they follow the prefix pattern.", "author": "cameronlee314", "createdAt": "2020-02-04T18:54:32Z", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -310,6 +339,23 @@ public boolean getDiagnosticsEnabled() {\n     return getBoolean(JOB_DIAGNOSTICS_ENABLED, false);\n   }\n \n+  public boolean getAutosizingEnabled() {\n+    return getBoolean(JOB_AUTOSIZING_ENABLED, false);\n+  }\n+\n+  public boolean isAutosizingConfig(String configParam) {\n+    switch (configParam) {\n+      case JOB_AUTOSIZING_CONTAINER_COUNT:\n+      case JOB_AUTOSIZING_CONTAINER_MAX_CORES:\n+      case JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB:\n+      case JOB_AUTOSIZING_CONTAINER_MEMORY_MB:\n+      case JOB_AUTOSIZING_CONTAINER_THREAD_POOL_SIZE:", "originalCommit": "02454631d2c544e7b1119146b81d3df1a6dbe57e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk2MzQyNg==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374963426", "bodyText": "Chose 3, and added comments and a config prefix variable.", "author": "rmatharu", "createdAt": "2020-02-04T22:37:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDg1ODgyMg=="}], "type": "inlineReview"}, {"oid": "7832f33b54b26fb7d61571fb8f300a06f7deff7c", "url": "https://github.com/apache/samza/commit/7832f33b54b26fb7d61571fb8f300a06f7deff7c", "message": "Addressing review comments", "committedDate": "2020-02-04T22:41:00Z", "type": "commit"}, {"oid": "77b6b331e16408f6215a0c03a64a8128d040744c", "url": "https://github.com/apache/samza/commit/77b6b331e16408f6215a0c03a64a8128d040744c", "message": "Adding shellcommandconfig test", "committedDate": "2020-02-04T22:44:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3MTc1Nw==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374971757", "bodyText": "I think this section is the same as the block above. Seems like the code doesn't match the comment.", "author": "cameronlee314", "createdAt": "2020-02-04T22:58:14Z", "path": "samza-core/src/test/java/org/apache/samza/config/TestJobConfig.java", "diffHunk": "@@ -608,4 +604,42 @@ public void testAutosizingConfig() {\n     Assert.assertEquals(900, clusterManagerConfig.getContainerMemoryMb());\n     Assert.assertEquals(2, clusterManagerConfig.getNumCores());\n   }\n+\n+  @Test\n+  public void testGetTaskOptsAutosizingDisabled() {\n+    ShellCommandConfig shellCommandConfig =\n+        new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n+    assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n+\n+    String taskOpts = \"-Dproperty=value\";\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n+    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());\n+  }\n+\n+  @Test\n+  public void testGetTaskOptsAutosizingEnabled() {\n+    // opts not set, autosizing max heap not set\n+    ShellCommandConfig shellCommandConfig =\n+        new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\")));\n+    assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n+\n+    // opts set, autosizing max heap not set\n+    String taskOpts = \"-Dproperty=value\";\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"true\")));\n+    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());\n+\n+    // opts not set, autosizing max heap set\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\", JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB,\n+            \"1024\")));\n+    assertEquals(Option.apply(\"-Xmx1024m\"), shellCommandConfig.getTaskOpts());\n+\n+    // opts set without -Xmx, autosizing max heap set\n+    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n+        ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"true\", JobConfig.JOB_AUTOSIZING_CONTAINER_MAX_HEAP_MB,\n+            \"1024\")));\n+    assertEquals(Option.apply(\"-Xmx1024m\"), shellCommandConfig.getTaskOpts());", "originalCommit": "77b6b331e16408f6215a0c03a64a8128d040744c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3MzkwOA==", "url": "https://github.com/apache/samza/pull/1266#discussion_r375473908", "bodyText": "I saw your change, but I meant to refer to the lines immediately above this. I think this code block needs to be changed (not removed) to have a non-empty opts that doesn't have an -Xmx param.\nI would also suggest adding a test in which opts has -Xmx but needs to be replaced by the autosizing config.", "author": "cameronlee314", "createdAt": "2020-02-05T19:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk3MTc1Nw=="}], "type": "inlineReview"}, {"oid": "4dd1ef0ea1edbdbdf4237823db4022c44e428e65", "url": "https://github.com/apache/samza/commit/4dd1ef0ea1edbdbdf4237823db4022c44e428e65", "message": "Empty commit to trigger build", "committedDate": "2020-02-05T00:00:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk0MzQ5MQ==", "url": "https://github.com/apache/samza/pull/1266#discussion_r374943491", "bodyText": "nit: typo tthat ake", "author": "abhishekshivanna", "createdAt": "2020-02-04T21:51:53Z", "path": "samza-core/src/main/java/org/apache/samza/config/JobConfig.java", "diffHunk": "@@ -130,6 +130,15 @@\n   public static final String CONTAINER_METADATA_FILENAME_FORMAT = \"%s.metadata\"; // Filename: <containerID>.metadata\n   public static final String CONTAINER_METADATA_DIRECTORY_SYS_PROPERTY = \"samza.log.dir\";\n \n+  // Auto-sizing related configs tthat ake precedence over respective sizing confings job.container.count, etc,", "originalCommit": "02454631d2c544e7b1119146b81d3df1a6dbe57e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3Mjc4MA==", "url": "https://github.com/apache/samza/pull/1266#discussion_r375472780", "bodyText": "It looks like you still have a typo (\"that ake\") after your last change.", "author": "cameronlee314", "createdAt": "2020-02-05T19:50:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDk0MzQ5MQ=="}], "type": "inlineReview"}, {"oid": "972c8225c38dbf9f292078e0d1718990e01c6ee6", "url": "https://github.com/apache/samza/commit/972c8225c38dbf9f292078e0d1718990e01c6ee6", "message": "Addressing review comments", "committedDate": "2020-02-05T19:47:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ3MjMzMQ==", "url": "https://github.com/apache/samza/pull/1266#discussion_r375472331", "bodyText": "I don't think this should be removed. It is actually a different test case (i.e. autosizing is disabled).", "author": "cameronlee314", "createdAt": "2020-02-05T19:49:29Z", "path": "samza-core/src/test/java/org/apache/samza/config/TestJobConfig.java", "diffHunk": "@@ -610,11 +610,6 @@ public void testGetTaskOptsAutosizingDisabled() {\n     ShellCommandConfig shellCommandConfig =\n         new ShellCommandConfig(new MapConfig(ImmutableMap.of(JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n     assertEquals(Option.empty(), shellCommandConfig.getTaskOpts());\n-\n-    String taskOpts = \"-Dproperty=value\";\n-    shellCommandConfig = new ShellCommandConfig(new MapConfig(\n-        ImmutableMap.of(ShellCommandConfig.TASK_JVM_OPTS(), taskOpts, JobConfig.JOB_AUTOSIZING_ENABLED, \"false\")));\n-    assertEquals(Option.apply(taskOpts), shellCommandConfig.getTaskOpts());", "originalCommit": "972c8225c38dbf9f292078e0d1718990e01c6ee6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2e305173fe5a92f515157b96a6353505dce09eed", "url": "https://github.com/apache/samza/commit/2e305173fe5a92f515157b96a6353505dce09eed", "message": "Adding tests for TestJobConfig, fixing typo", "committedDate": "2020-02-07T00:55:39Z", "type": "commit"}]}