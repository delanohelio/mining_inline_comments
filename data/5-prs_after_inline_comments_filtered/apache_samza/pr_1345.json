{"pr_number": 1345, "pr_title": "SAMZA-2506: Inconsistent end of stream semantics in SystemStreamPartitionMetadata", "pr_createdAt": "2020-04-14T20:07:04Z", "pr_url": "https://github.com/apache/samza/pull/1345", "timeline": [{"oid": "7e423d8f0ef1b6ae894c5dd76a51b84c5fedaadc", "url": "https://github.com/apache/samza/commit/7e423d8f0ef1b6ae894c5dd76a51b84c5fedaadc", "message": "fixing in memory system admin offsets in case where stream is terminated by an 'end of stream' message", "committedDate": "2020-03-26T06:08:20Z", "type": "commit"}, {"oid": "83cb9dd515c1994d967060c442b5fe9ff3f3c391", "url": "https://github.com/apache/samza/commit/83cb9dd515c1994d967060c442b5fe9ff3f3c391", "message": "adding end of stream unit test to InMemoryManager", "committedDate": "2020-03-26T08:34:44Z", "type": "commit"}, {"oid": "e38cb0635466470d3585be45a6c733087f9ce24b", "url": "https://github.com/apache/samza/commit/e38cb0635466470d3585be45a6c733087f9ce24b", "message": "modifying initialization of offset vars used to construct SystemStreamPartitionMetadata", "committedDate": "2020-04-09T00:05:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI5NTcwNQ==", "url": "https://github.com/apache/samza/pull/1345#discussion_r415295705", "bodyText": "maybe simplify this to have it default to original values 0, messages.size() - 1, messages.size and only modify in case of the last message being end of stream?", "author": "mynameborat", "createdAt": "2020-04-26T12:11:46Z", "path": "samza-core/src/main/java/org/apache/samza/system/inmemory/InMemoryManager.java", "diffHunk": "@@ -181,12 +181,26 @@ private SystemStreamMetadata constructSystemStreamMetadata(\n             .stream()\n             .collect(Collectors.toMap(entry -> entry.getKey().getPartition(), entry -> {\n                 List<IncomingMessageEnvelope> messages = entry.getValue();\n-                String oldestOffset = messages.isEmpty() ? null : \"0\";\n-                String newestOffset = messages.isEmpty() ? null : String.valueOf(messages.size() - 1);\n-                String upcomingOffset = String.valueOf(messages.size());\n-\n-                return new SystemStreamMetadata.SystemStreamPartitionMetadata(oldestOffset, newestOffset, upcomingOffset);\n-\n+                Integer oldestOffset = null;\n+                Integer newestOffset = null;\n+                int upcomingOffset = 0;", "originalCommit": "e38cb0635466470d3585be45a6c733087f9ce24b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEwODYwOQ==", "url": "https://github.com/apache/samza/pull/1345#discussion_r417108609", "bodyText": "IMO the definition of oldest and newest offset is such that they should be valid pointers to data. In the case where messages is empty or has only a single end of stream message, I think those values would be a misrepresentation.\nupcomingOffset I am less sure of semantically but looking back again at the documentation In SystemStreamPartitionMetadata suggests it should be null as well in the case of an empty stream. It also doesn't really make sense in the context of bounded streams either (in HdfsSystemConsumer, it is returned as null).\nI suggest we init upcomingOffset to null, remove it from being set where there is an end of stream message, and leave the other two as-is.\nThoughts?", "author": "bkonold", "createdAt": "2020-04-29T07:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI5NTcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk2NTU5OQ==", "url": "https://github.com/apache/samza/pull/1345#discussion_r426965599", "bodyText": "@mynameborat is this resolved after the latest diff?", "author": "bkonold", "createdAt": "2020-05-19T00:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTI5NTcwNQ=="}], "type": "inlineReview"}, {"oid": "813e75d5f95bd53867a5761e82e3f2422d63067f", "url": "https://github.com/apache/samza/commit/813e75d5f95bd53867a5761e82e3f2422d63067f", "message": "addressing review comment", "committedDate": "2020-05-05T23:56:35Z", "type": "commit"}]}