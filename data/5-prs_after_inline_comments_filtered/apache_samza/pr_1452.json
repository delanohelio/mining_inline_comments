{"pr_number": 1452, "pr_title": "SAMZA-2611: [AM-HA] heartbeat reestablish causes container's heartbeat thread to die", "pr_createdAt": "2020-12-05T01:39:17Z", "pr_url": "https://github.com/apache/samza/pull/1452", "timeline": [{"oid": "0971470d56105e69f28db68d3cb1c140d1c95864", "url": "https://github.com/apache/samza/commit/0971470d56105e69f28db68d3cb1c140d1c95864", "message": "SAMZA-2611: [AM-HA] heartbeat reestablish causes container's heartbeat thread to die", "committedDate": "2020-12-05T01:30:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3NzY1NA==", "url": "https://github.com/apache/samza/pull/1452#discussion_r536477654", "bodyText": "It will kill the thread and recreate one. I'd suggest instead to proceed with exit code as below except log the error of the exception too.\nRecreating the thread doesn't guarantee that the subsequent thread can recover from the previous error and potentially run into this in a loop of some sorts without any concrete action.", "author": "mynameborat", "createdAt": "2020-12-05T01:46:32Z", "path": "samza-core/src/main/java/org/apache/samza/container/ContainerHeartbeatMonitor.java", "diffHunk": "@@ -92,8 +93,13 @@ public void start() {\n       if (!response.isAlive()) {\n         if (isApplicationMasterHighAvailabilityEnabled) {\n           LOG.warn(\"Failed to establish connection with {}. Checking for new AM\", coordinatorUrl);\n-          if (checkAndEstablishConnectionWithNewAM()) {\n-            return;\n+          try {\n+            if (checkAndEstablishConnectionWithNewAM()) {\n+              return;\n+            }\n+          } catch (Exception e) {\n+            LOG.warn(\"Exception trying to connect with new AM\", e);\n+            throw new SamzaException(e);", "originalCommit": "0971470d56105e69f28db68d3cb1c140d1c95864", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3ODA0MQ==", "url": "https://github.com/apache/samza/pull/1452#discussion_r536478041", "bodyText": "Should be a LOG.error as this is fatal and should be treat as such.", "author": "mynameborat", "createdAt": "2020-12-05T01:48:42Z", "path": "samza-core/src/main/java/org/apache/samza/container/ContainerHeartbeatMonitor.java", "diffHunk": "@@ -92,8 +93,13 @@ public void start() {\n       if (!response.isAlive()) {\n         if (isApplicationMasterHighAvailabilityEnabled) {\n           LOG.warn(\"Failed to establish connection with {}. Checking for new AM\", coordinatorUrl);\n-          if (checkAndEstablishConnectionWithNewAM()) {\n-            return;\n+          try {\n+            if (checkAndEstablishConnectionWithNewAM()) {\n+              return;\n+            }\n+          } catch (Exception e) {\n+            LOG.warn(\"Exception trying to connect with new AM\", e);", "originalCommit": "0971470d56105e69f28db68d3cb1c140d1c95864", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "24eb44691ade8acf574d781a1ea8ae8ed38d3603", "url": "https://github.com/apache/samza/commit/24eb44691ade8acf574d781a1ea8ae8ed38d3603", "message": "address comments", "committedDate": "2020-12-06T20:49:01Z", "type": "commit"}, {"oid": "d2f1a256d40b26536701595a0c5ea92b3974fd0f", "url": "https://github.com/apache/samza/commit/d2f1a256d40b26536701595a0c5ea92b3974fd0f", "message": "fix typo", "committedDate": "2020-12-07T01:19:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzYxMDE5Mw==", "url": "https://github.com/apache/samza/pull/1452#discussion_r537610193", "bodyText": "nit: typo s/cconnection/connection", "author": "mynameborat", "createdAt": "2020-12-07T15:46:07Z", "path": "samza-core/src/main/java/org/apache/samza/container/ContainerHeartbeatMonitor.java", "diffHunk": "@@ -92,17 +93,19 @@ public void start() {\n       if (!response.isAlive()) {\n         if (isApplicationMasterHighAvailabilityEnabled) {\n           LOG.warn(\"Failed to establish connection with {}. Checking for new AM\", coordinatorUrl);\n-          if (checkAndEstablishConnectionWithNewAM()) {\n+          try {\n+            if (checkAndEstablishConnectionWithNewAM()) {\n+              return;\n+            }\n+          } catch (Exception e) {\n+            // On exception in re-establish connection with new AM, force exit.\n+            LOG.error(\"Exception trying to connect with new AM\", e);\n+            forceExit(\"failure in establishing cconnection with new AM\", 0);", "originalCommit": "d2f1a256d40b26536701595a0c5ea92b3974fd0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}