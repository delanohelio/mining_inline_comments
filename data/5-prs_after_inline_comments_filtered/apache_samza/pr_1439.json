{"pr_number": 1439, "pr_title": "SAMZA-2600: Extract constants for string literals used in AM and container", "pr_createdAt": "2020-11-13T01:37:00Z", "pr_url": "https://github.com/apache/samza/pull/1439", "timeline": [{"oid": "c5f3467073d8a96b402f1341c827acbaf9a14615", "url": "https://github.com/apache/samza/commit/c5f3467073d8a96b402f1341c827acbaf9a14615", "message": "SAMZA-2600: Create constants for string literals used in AM and container", "committedDate": "2020-11-13T01:26:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0NzA0MQ==", "url": "https://github.com/apache/samza/pull/1439#discussion_r524347041", "bodyText": "I would suggest extracting the format as a constant and hardcoding some of the format constants instead of doing it the other way.\ne.g.\n  CONTAINER_HEART_BEAT_SERVLET_FORMAT = \"%s\" + \"/containerHeartbeat\";\n  CONTAINER_EXECUTION_ID_PARAM_FORMAT = \"executionContainerId=\" + \"%s\";\n  CONTAINER_HEART_BEAT_ENDPOINT_FORMAT = CONTAINER_HEART_BEAT_SERVLET_FORMAT + CONTAINER_EXECUTION_ID_PARAM_FORMAT\n\nOr some flavor of the above, so that you can reuse the format across the unit tests & other places in code. IMO, having the constants by themselves still forces users to figure out how they come together and repetitive code e.g. \"%s%s?%s=%s\" with readability hit as well.", "author": "mynameborat", "createdAt": "2020-11-16T15:21:28Z", "path": "samza-core/src/main/java/org/apache/samza/container/ContainerHeartbeatClient.java", "diffHunk": "@@ -56,7 +57,8 @@\n \n   public ContainerHeartbeatClient(String coordinatorUrl, String executionEnvContainerId) {\n     this.heartbeatEndpoint =\n-        String.format(\"%scontainerHeartbeat?executionContainerId=%s\", coordinatorUrl, executionEnvContainerId);\n+        String.format(\"%s%s?%s=%s\", coordinatorUrl, CoordinationConstants.CLUSTERBASED_CONTAINER_HEARTBEAT_SERVELET,", "originalCommit": "c5f3467073d8a96b402f1341c827acbaf9a14615", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3NzM1Ng==", "url": "https://github.com/apache/samza/pull/1439#discussion_r524677356", "bodyText": "agree that \"%s%s?%s=%s\" is not readable. Will split as suggested above.\nhowever, the point of the PR is to NOT have this hardcoded in both AM and container code separately.\nhaving them hardcoded separately in AM code and then have it exactly hardcoded in container code is risky imo", "author": "lakshmi-manasa-g", "createdAt": "2020-11-16T22:25:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM0NzA0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1NDYyOQ==", "url": "https://github.com/apache/samza/pull/1439#discussion_r524354629", "bodyText": "I'd also suggest moving this to Yarn specific constants file and remove the ClusterBased prefix as these don't have any implications outside the YARN world as they are all very specific to how YARN operates and aren't used in general samza core orchestration.\n[1] samza.autoscaling.server.url should have gotten cleaned up when we removed the auto-scaling module. We can take this opportunity and rename this configuration to am.tracking.url or something else as this is unused.\n[2] If we want to keep it the way it is for backward compatibility reasons, we should add a comment on how this is being used.\nI am in favor of [1]. wdyt?", "author": "mynameborat", "createdAt": "2020-11-16T15:31:05Z", "path": "samza-core/src/main/java/org/apache/samza/coordinator/CoordinationConstants.java", "diffHunk": "@@ -27,4 +27,7 @@ private CoordinationConstants() {}\n   public static final String APPLICATION_RUNNER_PATH_SUFFIX = \"ApplicationRunnerData\";\n   public static final String RUNID_LOCK_ID = \"runId\";\n   public static final int LOCK_TIMEOUT_MS = 300000;\n+  public static final String CLUSTERBASED_CONTAINER_HEARTBEAT_SERVELET = \"containerHeartbeat\";\n+  public static final String CLUSTERBASED_EXECUTION_ENVIRONMENT_CONTAINER_ID = \"executionContainerId\";\n+  public static final String CLUSTERBASED_COORDINATOR_URL = \"samza.autoscaling.server.url\";", "originalCommit": "c5f3467073d8a96b402f1341c827acbaf9a14615", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY3NzM5Mw==", "url": "https://github.com/apache/samza/pull/1439#discussion_r524677393", "bodyText": "im in favor of [1] too.\nagree about these constants being yarn specific but the components using these components (ex: ContainerHeartbeatClient) are part of samza-core. hence making this a yarn specific file in samza-yarn module will cause circular dependency issues.\nAdditionally, the existing CoordinationConstants file is not labelled standalone specific - although it has only standalone constants. Hence, felt this was a good place to put all constants needed for coordination code", "author": "lakshmi-manasa-g", "createdAt": "2020-11-16T22:25:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1NDYyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDY5OTk5Mw==", "url": "https://github.com/apache/samza/pull/1439#discussion_r524699993", "bodyText": "Let us leave the constants in the same file. I'd still suggest to remove the ClusterBased prefix alone as its only yarn specific and not applicable to a general cluster based deployments like K8s.", "author": "mynameborat", "createdAt": "2020-11-16T22:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDM1NDYyOQ=="}], "type": "inlineReview"}, {"oid": "222225cc29f9cc8c0fab04ba076a6c8336ba2791", "url": "https://github.com/apache/samza/commit/222225cc29f9cc8c0fab04ba076a6c8336ba2791", "message": "address comments", "committedDate": "2020-11-16T23:54:44Z", "type": "commit"}, {"oid": "381cedaaa3f5c7d9c0ed179db3543a6d6b21d922", "url": "https://github.com/apache/samza/commit/381cedaaa3f5c7d9c0ed179db3543a6d6b21d922", "message": "fix coordinator url", "committedDate": "2020-11-17T00:08:00Z", "type": "commit"}, {"oid": "f968931b32be1fb1dd96c05dfc94264a3caa1f5b", "url": "https://github.com/apache/samza/commit/f968931b32be1fb1dd96c05dfc94264a3caa1f5b", "message": "fix heartbeat endpoint string format", "committedDate": "2020-11-17T02:00:01Z", "type": "commit"}, {"oid": "572869f4162de993092250a31f64405eef4a12a6", "url": "https://github.com/apache/samza/commit/572869f4162de993092250a31f64405eef4a12a6", "message": "fix typo", "committedDate": "2020-11-17T05:24:56Z", "type": "commit"}]}