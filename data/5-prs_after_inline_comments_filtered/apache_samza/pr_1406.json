{"pr_number": 1406, "pr_title": "SAMZA-2561: Add config map to DiagnosticsManager", "pr_createdAt": "2020-07-31T16:56:44Z", "pr_url": "https://github.com/apache/samza/pull/1406", "timeline": [{"oid": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "url": "https://github.com/apache/samza/commit/37d9fba55a6cc63e9191c931f33597ea41b8092a", "message": "Add config map to MetricsHeader", "committedDate": "2020-07-31T10:24:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgwNjQwOA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463806408", "bodyText": "Why do we want to add the config to the metric-header?\nThat way the entire config map (potentially 10s of MB of data) will be emitted in every message.\nThis is NOT what we want to do right?\nInstead we want to emit it in the MetricsMessage, but exactly once at container start (first message) not in every message.", "author": "rmatharu", "createdAt": "2020-07-31T20:00:53Z", "path": "samza-core/src/main/java/org/apache/samza/util/DiagnosticsUtil.java", "diffHunk": "@@ -70,7 +70,7 @@ public static void writeMetadataFile(String jobName, String jobId, String contai\n       MetricsHeader metricsHeader =\n           new MetricsHeader(jobName, jobId, \"samza-container-\" + containerId, execEnvContainerId.orElse(\"\"),\n               LocalContainerRunner.class.getName(), Util.getTaskClassVersion(config), Util.getSamzaVersion(),\n-              Util.getLocalHost().getHostName(), System.currentTimeMillis(), System.currentTimeMillis());\n+              Util.getLocalHost().getHostName(), System.currentTimeMillis(), System.currentTimeMillis(), config);", "originalCommit": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg3NzE4Mw==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463877183", "bodyText": "+1 I agree we should only pick the fields we are interested in. I suggest we create a versioned model (JSON serializable) that holds the fields we are interested in.", "author": "abhishekshivanna", "createdAt": "2020-07-31T22:48:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgwNjQwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5MTc0Nw==", "url": "https://github.com/apache/samza/pull/1406#discussion_r465891747", "bodyText": "Removed the config from the MetricsHeader.", "author": "PawasChhokra", "createdAt": "2020-08-05T17:34:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzgwNjQwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1NjExNg==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463856116", "bodyText": "Javadoc?", "author": "rmatharu", "createdAt": "2020-07-31T21:31:47Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -155,6 +158,10 @@ public void addProcessorStopEvents(List<ProcessorStopEvent> stopEventList) {\n     }\n   }\n \n+  public void addConfig(Config config) {", "originalCommit": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5MjcyOA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463892728", "bodyText": "Added.", "author": "PawasChhokra", "createdAt": "2020-08-01T00:07:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1NjExNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1NjI1Mw==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463856253", "bodyText": "See comment above,\nconfig is not required to be in the header.", "author": "rmatharu", "createdAt": "2020-07-31T21:32:12Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -60,17 +62,18 @@\n   private static final String CONTAINER_THREAD_POOL_SIZE_METRIC_NAME = \"containerThreadPoolSize\";\n   private static final String CONTAINER_MODELS_METRIC_NAME = \"containerModels\";\n   private static final String AUTOSIZING_ENABLED_METRIC_NAME = \"autosizingEnabled\";\n+  private static final String CONFIG = \"config\";\n \n   private final MetricsHeader metricsHeader;\n   private final Map<String, Map<String, Object>> metricsMessage;\n \n   public DiagnosticsStreamMessage(String jobName, String jobId, String containerName, String executionEnvContainerId,\n-      String taskClassVersion, String samzaVersion, String hostname, long timestamp, long resetTimestamp) {\n+      String taskClassVersion, String samzaVersion, String hostname, long timestamp, long resetTimestamp, Map<String, String> config) {\n \n     // Create the metricHeader\n     metricsHeader =\n         new MetricsHeader(jobName, jobId, containerName, executionEnvContainerId, DiagnosticsManager.class.getName(),\n-            taskClassVersion, samzaVersion, hostname, timestamp, resetTimestamp);\n+            taskClassVersion, samzaVersion, hostname, timestamp, resetTimestamp, config);", "originalCommit": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5MjcwMQ==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463892701", "bodyText": "Removed.", "author": "PawasChhokra", "createdAt": "2020-08-01T00:07:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1NjI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1Njc0NA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463856744", "bodyText": "Javadoc?", "author": "rmatharu", "createdAt": "2020-07-31T21:33:49Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -228,6 +235,10 @@ public Boolean getAutosizingEnabled() {\n     return (Boolean) getFromMetricsMessage(GROUP_NAME_FOR_DIAGNOSTICS_MANAGER, AUTOSIZING_ENABLED_METRIC_NAME);\n   }\n \n+  public Config getConfig() {", "originalCommit": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5Mjc2OQ==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463892769", "bodyText": "Added.", "author": "PawasChhokra", "createdAt": "2020-08-01T00:08:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1Njc0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1NzAzNg==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463857036", "bodyText": "Because we dont need to add it to the header, we dont need to pass it in here.", "author": "rmatharu", "createdAt": "2020-07-31T21:34:41Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -60,17 +62,18 @@\n   private static final String CONTAINER_THREAD_POOL_SIZE_METRIC_NAME = \"containerThreadPoolSize\";\n   private static final String CONTAINER_MODELS_METRIC_NAME = \"containerModels\";\n   private static final String AUTOSIZING_ENABLED_METRIC_NAME = \"autosizingEnabled\";\n+  private static final String CONFIG = \"config\";\n \n   private final MetricsHeader metricsHeader;\n   private final Map<String, Map<String, Object>> metricsMessage;\n \n   public DiagnosticsStreamMessage(String jobName, String jobId, String containerName, String executionEnvContainerId,\n-      String taskClassVersion, String samzaVersion, String hostname, long timestamp, long resetTimestamp) {\n+      String taskClassVersion, String samzaVersion, String hostname, long timestamp, long resetTimestamp, Map<String, String> config) {", "originalCommit": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5MjY3NA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463892674", "bodyText": "Removed.", "author": "PawasChhokra", "createdAt": "2020-08-01T00:07:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1NzAzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg1NzI3Mw==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463857273", "bodyText": "Not needed", "author": "rmatharu", "createdAt": "2020-07-31T21:35:27Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -237,7 +248,7 @@ public static DiagnosticsStreamMessage convertToDiagnosticsStreamMessage(Metrics\n             metricsSnapshot.getHeader().getContainerName(), metricsSnapshot.getHeader().getExecEnvironmentContainerId(),\n             metricsSnapshot.getHeader().getVersion(), metricsSnapshot.getHeader().getSamzaVersion(),\n             metricsSnapshot.getHeader().getHost(), metricsSnapshot.getHeader().getTime(),\n-            metricsSnapshot.getHeader().getResetTime());\n+            metricsSnapshot.getHeader().getResetTime(), metricsSnapshot.getHeader().getConfig());", "originalCommit": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2MDgzMw==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463860833", "bodyText": "Please add additional configs to make it somewhat representative of the configs that we want to emit.", "author": "rmatharu", "createdAt": "2020-07-31T21:46:49Z", "path": "samza-core/src/test/java/org/apache/samza/diagnostics/TestDiagnosticsManager.java", "diffHunk": "@@ -59,6 +62,7 @@\n   private int numPersistentStores = 2;\n   private int containerNumCores = 2;\n   private boolean autosizingEnabled = false;\n+  private Config config = new MapConfig(ImmutableMap.of(\"job.name\", jobName, \"job.id\", jobId));", "originalCommit": "37d9fba55a6cc63e9191c931f33597ea41b8092a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5ODEwOA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463898108", "bodyText": "Done.", "author": "PawasChhokra", "createdAt": "2020-08-01T00:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg2MDgzMw=="}], "type": "inlineReview"}, {"oid": "35a54c6be7857153a39a15d9368666af979e6c68", "url": "https://github.com/apache/samza/commit/35a54c6be7857153a39a15d9368666af979e6c68", "message": "Address review", "committedDate": "2020-08-01T00:06:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5MzA5Ng==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463893096", "bodyText": "Nit: CONFIG_METRIC_NAME", "author": "rmatharu", "createdAt": "2020-08-01T00:10:11Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -60,6 +62,7 @@\n   private static final String CONTAINER_THREAD_POOL_SIZE_METRIC_NAME = \"containerThreadPoolSize\";\n   private static final String CONTAINER_MODELS_METRIC_NAME = \"containerModels\";\n   private static final String AUTOSIZING_ENABLED_METRIC_NAME = \"autosizingEnabled\";\n+  private static final String CONFIG = \"config\";", "originalCommit": "35a54c6be7857153a39a15d9368666af979e6c68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5NzYxNg==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463897616", "bodyText": "Remove?", "author": "rmatharu", "createdAt": "2020-08-01T00:39:35Z", "path": "samza-core/src/test/java/org/apache/samza/serializers/model/serializers/TestMetricsSnapshotSerdeV2.java", "diffHunk": "@@ -37,8 +37,8 @@\n   @Test\n   public void testSerde() {\n     MetricsHeader metricsHeader =\n-        new MetricsHeader(\"jobName\", \"i001\", \"container 0\", \"test container ID\", \"source\", \"300.14.25.1\", \"1\", \"1\", 1,\n-            1);\n+        new MetricsHeader(\"jobName\", \"i001\", \"container 0\", \"test container ID\",\n+            \"source\", \"300.14.25.1\", \"1\", \"1\", 1, 1);", "originalCommit": "35a54c6be7857153a39a15d9368666af979e6c68", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3NzY1Nw==", "url": "https://github.com/apache/samza/pull/1406#discussion_r465377657", "bodyText": "Removed.", "author": "PawasChhokra", "createdAt": "2020-08-04T23:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5NzYxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5ODA3OA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463898078", "bodyText": "remove?", "author": "rmatharu", "createdAt": "2020-08-01T00:42:57Z", "path": "samza-core/src/test/java/org/apache/samza/metrics/TestMetricsSnapshotReporter.java", "diffHunk": "@@ -35,10 +35,7 @@\n import scala.Some;\n import scala.runtime.AbstractFunction0;\n \n-import static org.mockito.Mockito.mock;\n-import static org.mockito.Mockito.verify;\n-import static org.mockito.Mockito.times;\n-import static org.mockito.Mockito.eq;\n+import static org.mockito.Mockito.*;", "originalCommit": "35a54c6be7857153a39a15d9368666af979e6c68", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f4609991b6ecda65cedf74e5cfc82ab036ae9278", "url": "https://github.com/apache/samza/commit/f4609991b6ecda65cedf74e5cfc82ab036ae9278", "message": "Address review", "committedDate": "2020-08-01T00:43:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5ODM2Mg==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463898362", "bodyText": "config is a non-primitive object, cast to Map<String, String> here before serializing and adding into the map; similar to how containerModels are added above.", "author": "rmatharu", "createdAt": "2020-08-01T00:45:13Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -155,6 +158,14 @@ public void addProcessorStopEvents(List<ProcessorStopEvent> stopEventList) {\n     }\n   }\n \n+  /**\n+   * Add the job's config to the message.\n+   * @param config the config to add.\n+   */\n+  public void addConfig(Config config) {\n+    addToMetricsMessage(GROUP_NAME_FOR_DIAGNOSTICS_MANAGER, CONFIG, config);", "originalCommit": "f4609991b6ecda65cedf74e5cfc82ab036ae9278", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5ODQ3OQ==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463898479", "bodyText": "Since we will serialize as Map<String, String>\ngetFromMetricsMessage will return a Map<String, String>\nthat needs to be converted to Config like this:\nnew MapConfig(getFromMetricsMessage(GROUP_NAME_FOR_DIAGNOSTICS_MANAGER, CONFIG));", "author": "rmatharu", "createdAt": "2020-08-01T00:46:19Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -228,6 +239,14 @@ public Boolean getAutosizingEnabled() {\n     return (Boolean) getFromMetricsMessage(GROUP_NAME_FOR_DIAGNOSTICS_MANAGER, AUTOSIZING_ENABLED_METRIC_NAME);\n   }\n \n+  /**\n+   * This method gets the config of the job from the MetricsMessage.\n+   * @return the config of the job.\n+   */\n+  public Config getConfig() {\n+    return (Config) getFromMetricsMessage(GROUP_NAME_FOR_DIAGNOSTICS_MANAGER, CONFIG);", "originalCommit": "f4609991b6ecda65cedf74e5cfc82ab036ae9278", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3OTExMA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r465379110", "bodyText": "Done.", "author": "PawasChhokra", "createdAt": "2020-08-04T23:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5ODQ3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5ODU3OA==", "url": "https://github.com/apache/samza/pull/1406#discussion_r463898578", "bodyText": "Config does not define an equals method, so not sure how this test is working.", "author": "rmatharu", "createdAt": "2020-08-01T00:47:10Z", "path": "samza-core/src/test/java/org/apache/samza/diagnostics/TestDiagnosticsManager.java", "diffHunk": "@@ -272,6 +278,7 @@ private void validateOutgoingMessageEnvelope(OutgoingMessageEnvelope outgoingMes\n     Assert.assertEquals(containerNumCores, diagnosticsStreamMessage.getContainerNumCores().intValue());\n     Assert.assertEquals(numPersistentStores, diagnosticsStreamMessage.getNumPersistentStores().intValue());\n     Assert.assertEquals(autosizingEnabled, diagnosticsStreamMessage.getAutosizingEnabled());\n+    Assert.assertEquals(config, diagnosticsStreamMessage.getConfig());", "originalCommit": "f4609991b6ecda65cedf74e5cfc82ab036ae9278", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM3Nzg3Ng==", "url": "https://github.com/apache/samza/pull/1406#discussion_r465377876", "bodyText": "This invokes the equals method of MapConfig class.", "author": "PawasChhokra", "createdAt": "2020-08-04T23:04:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzg5ODU3OA=="}], "type": "inlineReview"}, {"oid": "fbddab0ee1935120c20c38de5fdf6b2f97aa89e6", "url": "https://github.com/apache/samza/commit/fbddab0ee1935120c20c38de5fdf6b2f97aa89e6", "message": "Address review", "committedDate": "2020-08-04T23:08:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTM4MzU2NQ==", "url": "https://github.com/apache/samza/pull/1406#discussion_r465383565", "bodyText": "Nit: The method definition could be\npublic void addConfig(Config config) { addToMetricsMessage(GROUP_NAME_FOR_DIAGNOSTICS_MANAGER, CONFIG_METRIC_NAME, (Map<String, String>) config); }\nSo that the cast-to-map logic is encapsulated in this class; and not visible to callers.", "author": "rmatharu", "createdAt": "2020-08-04T23:22:11Z", "path": "samza-core/src/main/scala/org/apache/samza/diagnostics/DiagnosticsStreamMessage.java", "diffHunk": "@@ -155,6 +158,14 @@ public void addProcessorStopEvents(List<ProcessorStopEvent> stopEventList) {\n     }\n   }\n \n+  /**\n+   * Add the job's config to the message.\n+   * @param config the config to add.\n+   */\n+  public void addConfig(Map<String, String> config) {", "originalCommit": "fbddab0ee1935120c20c38de5fdf6b2f97aa89e6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "099c97a1c521d393c42c71db1afb493cff8104f4", "url": "https://github.com/apache/samza/commit/099c97a1c521d393c42c71db1afb493cff8104f4", "message": "Address review", "committedDate": "2020-08-05T17:41:58Z", "type": "commit"}]}