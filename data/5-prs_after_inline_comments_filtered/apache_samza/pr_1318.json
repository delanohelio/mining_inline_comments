{"pr_number": 1318, "pr_title": "SAMZA-2488: Add JobCoordinatorLaunchUtil to handle common logic when launching job coordiantor.", "pr_createdAt": "2020-03-18T00:30:33Z", "pr_url": "https://github.com/apache/samza/pull/1318", "timeline": [{"oid": "4f259cf0607f2fe114b5019962077b6af6e8d494", "url": "https://github.com/apache/samza/commit/4f259cf0607f2fe114b5019962077b6af6e8d494", "message": "Fix typo\n\nFix the issue that getAppMainArgs & getAppMainClass is reversed", "committedDate": "2020-03-11T23:56:34Z", "type": "commit"}, {"oid": "9c9d66ce894cb652d05f2eec2f96b95e8033dced", "url": "https://github.com/apache/samza/commit/9c9d66ce894cb652d05f2eec2f96b95e8033dced", "message": "Merge branch 'master' of https://github.com/kw2542/samza", "committedDate": "2020-03-16T18:35:50Z", "type": "commit"}, {"oid": "64fe311b4c96114d37d857367d807e771c9c5bff", "url": "https://github.com/apache/samza/commit/64fe311b4c96114d37d857367d807e771c9c5bff", "message": "SAMZA-2486: Update TestFileReaderSystemAdmin to use test resource files\n\nSymptom:\nsamza-core:test are randomly failing.\n\nCause:\nTestFileReaderSystemAdmin and TestFileReaderSystemConsumer are creating and deleting the same set of files, when runnig in parallel, FileNotFoundException could happen depending on the timing.\n\nChanges:\n1. Update TestFileReaderSystemAdmin to use test resource files.\n2. Update assert conditions as we removed tailing spaces and newlines in the files.\n3. Keep TestFileReaderSystemConsumer as it is because it is also appending data to test files, thus cannot share to use the same test resource file.\n\nTests:\n./gradlew test\n\nAPI Changes:\nNone\n\nUpgrade Instructions:\nNone\n\nUsage Instructions:\nNone", "committedDate": "2020-03-16T20:55:33Z", "type": "commit"}, {"oid": "79070f075b138df8a06469a2b7c23538249cbae6", "url": "https://github.com/apache/samza/commit/79070f075b138df8a06469a2b7c23538249cbae6", "message": "Ignore txt files in test resources", "committedDate": "2020-03-16T22:42:46Z", "type": "commit"}, {"oid": "41bc509bb68fe64ac6f696df7e086ea020295cfb", "url": "https://github.com/apache/samza/commit/41bc509bb68fe64ac6f696df7e086ea020295cfb", "message": "SAMZA-2488: Add JobCoordinatorLaunchUtil to handle common logic when launching job coordiantor.\n\nIssues: High/Low and Beam are sharing the same logic when launching ClusterBasedJobCoordinator and it is ideal to have them in single place.\n\nChanges: Add JobCoordinatorLaunchUtil which contains the common logic when launching ClusterBasedJobCoordinator.\n\nTests: Unit tests + ./gradlew build\n\nAPI Changes: None\nUpgrade Instructions: None\nUsage Instructions: None", "committedDate": "2020-03-18T00:27:55Z", "type": "commit"}, {"oid": "646fcb060e0c40a00daaf64240995092f3592812", "url": "https://github.com/apache/samza/commit/646fcb060e0c40a00daaf64240995092f3592812", "message": "Fix styles", "committedDate": "2020-03-18T00:29:39Z", "type": "commit"}, {"oid": "6b518d38fa7acb450bf47630e939a18b8b99d1fe", "url": "https://github.com/apache/samza/commit/6b518d38fa7acb450bf47630e939a18b8b99d1fe", "message": "SAMZA-2488: Add JobCoordinatorLaunchUtil to handle common logic when launching job coordiantor.\n\nIssues: High/Low and Beam are sharing the same logic when launching ClusterBasedJobCoordinator and it is ideal to have them in single place.\n\nChanges: Add JobCoordinatorLaunchUtil which contains the common logic when launching ClusterBasedJobCoordinator.\n\nTests: Unit tests + ./gradlew build\n\nAPI Changes: None\nUpgrade Instructions: None\nUsage Instructions: None", "committedDate": "2020-03-18T00:31:31Z", "type": "commit"}, {"oid": "4f42af33564644e4a5cc0d0bcb2a90129bfac3d4", "url": "https://github.com/apache/samza/commit/4f42af33564644e4a5cc0d0bcb2a90129bfac3d4", "message": "Fix styles", "committedDate": "2020-03-18T00:31:31Z", "type": "commit"}, {"oid": "c9b5279da4c3d01687a936d0be26c246a6588ae6", "url": "https://github.com/apache/samza/commit/c9b5279da4c3d01687a936d0be26c246a6588ae6", "message": "Merge branch 'SAMZA-2488' of https://github.com/kw2542/samza into SAMZA-2488", "committedDate": "2020-03-18T00:31:37Z", "type": "commit"}, {"oid": "e8f9f8265e58a3fcf46b5a8a8fe288b179334eff", "url": "https://github.com/apache/samza/commit/e8f9f8265e58a3fcf46b5a8a8fe288b179334eff", "message": "Remove unused unit test", "committedDate": "2020-03-18T00:32:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0ODEzOQ==", "url": "https://github.com/apache/samza/pull/1318#discussion_r394048139", "bodyText": "Please add javadoc to this class, including a note about this will be invoked in both Samza api as well as beam api, so any change needs to be tested in both.", "author": "xinyuiscool", "createdAt": "2020-03-18T00:42:57Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/JobCoordinatorLaunchUtil.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.List;\n+import org.apache.samza.SamzaException;\n+import org.apache.samza.application.SamzaApplication;\n+import org.apache.samza.application.descriptors.ApplicationDescriptor;\n+import org.apache.samza.application.descriptors.ApplicationDescriptorImpl;\n+import org.apache.samza.application.descriptors.ApplicationDescriptorUtil;\n+import org.apache.samza.config.Config;\n+import org.apache.samza.config.JobConfig;\n+import org.apache.samza.coordinator.metadatastore.CoordinatorStreamStore;\n+import org.apache.samza.execution.RemoteJobPlanner;\n+import org.apache.samza.metadatastore.MetadataStore;\n+import org.apache.samza.metrics.MetricsRegistryMap;\n+import org.apache.samza.util.CoordinatorStreamUtil;\n+import org.apache.samza.util.DiagnosticsUtil;\n+\n+\n+public class JobCoordinatorLaunchUtil {", "originalCommit": "e8f9f8265e58a3fcf46b5a8a8fe288b179334eff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1MDI4NQ==", "url": "https://github.com/apache/samza/pull/1318#discussion_r394050285", "bodyText": "Updated", "author": "kw2542", "createdAt": "2020-03-18T00:51:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0ODEzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0ODMwOQ==", "url": "https://github.com/apache/samza/pull/1318#discussion_r394048309", "bodyText": "Could you make a comment about where the metasdatastore will be closed?", "author": "xinyuiscool", "createdAt": "2020-03-18T00:43:41Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/JobCoordinatorLaunchUtil.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.apache.samza.clustermanager;\n+\n+import java.util.List;\n+import org.apache.samza.SamzaException;\n+import org.apache.samza.application.SamzaApplication;\n+import org.apache.samza.application.descriptors.ApplicationDescriptor;\n+import org.apache.samza.application.descriptors.ApplicationDescriptorImpl;\n+import org.apache.samza.application.descriptors.ApplicationDescriptorUtil;\n+import org.apache.samza.config.Config;\n+import org.apache.samza.config.JobConfig;\n+import org.apache.samza.coordinator.metadatastore.CoordinatorStreamStore;\n+import org.apache.samza.execution.RemoteJobPlanner;\n+import org.apache.samza.metadatastore.MetadataStore;\n+import org.apache.samza.metrics.MetricsRegistryMap;\n+import org.apache.samza.util.CoordinatorStreamUtil;\n+import org.apache.samza.util.DiagnosticsUtil;\n+\n+\n+public class JobCoordinatorLaunchUtil {\n+  /**\n+   * Run {@link ClusterBasedJobCoordinator} with full job config.\n+   *\n+   * @param app SamzaApplication to run.\n+   * @param config full job config.\n+   */\n+  @SuppressWarnings(\"rawtypes\")\n+  public static void run(SamzaApplication app, Config config) {\n+    // Execute planning\n+    ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+        appDesc = ApplicationDescriptorUtil.getAppDescriptor(app, config);\n+    RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+    List<JobConfig> jobConfigs = planner.prepareJobs();\n+\n+    if (jobConfigs.size() != 1) {\n+      throw new SamzaException(\"Only support single remote job is supported.\");\n+    }\n+\n+    Config finalConfig = jobConfigs.get(0);\n+\n+    // This needs to be consistent with RemoteApplicationRunner#run where JobRunner#submit to be called instead of JobRunner#run\n+    CoordinatorStreamUtil.writeConfigToCoordinatorStream(finalConfig, true);\n+    DiagnosticsUtil.createDiagnosticsStream(finalConfig);\n+    MetricsRegistryMap metrics = new MetricsRegistryMap();\n+    MetadataStore\n+        metadataStore = new CoordinatorStreamStore(CoordinatorStreamUtil.buildCoordinatorStreamConfig(finalConfig), metrics);\n+    metadataStore.init();", "originalCommit": "e8f9f8265e58a3fcf46b5a8a8fe288b179334eff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA1MDI5Nw==", "url": "https://github.com/apache/samza/pull/1318#discussion_r394050297", "bodyText": "Updated", "author": "kw2542", "createdAt": "2020-03-18T00:51:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDA0ODMwOQ=="}], "type": "inlineReview"}, {"oid": "c8f42bc5d347a6d4dd4b1ac637deda4d344c841a", "url": "https://github.com/apache/samza/commit/c8f42bc5d347a6d4dd4b1ac637deda4d344c841a", "message": "Add javadoc and comments", "committedDate": "2020-03-18T00:51:28Z", "type": "commit"}]}