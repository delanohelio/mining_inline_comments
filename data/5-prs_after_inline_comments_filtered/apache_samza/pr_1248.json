{"pr_number": 1248, "pr_title": "SAMZA-2410: Update ClusterBasedJobCoordinator config retrieval logic from loader.", "pr_createdAt": "2020-01-10T19:09:30Z", "pr_url": "https://github.com/apache/samza/pull/1248", "timeline": [{"oid": "754a2e1dc8c617238a454a6d6edd80c988c799f8", "url": "https://github.com/apache/samza/commit/754a2e1dc8c617238a454a6d6edd80c988c799f8", "message": "SAMZA-2410: Update ClusterBasedJobCoordinator config retrieval logic to read config from loader\n\nDesign:\nhttps://cwiki.apache.org/confluence/display/SAMZA/SEP-23%3A+Simplify+Job+Runner\n\nChanges:\n\n1. Based on the existence of ENV_SUBMISSION_CONFIG, ClusterBasedJobCoordinator will alternatively deserilize ENV_SUBMISSION_CONFIG and load full job config from config loader factory.\n2. Execute planning, create diagnostics stream and persist full job config back to coordinator stream when loading full job config from config loader.\n\nAPI Changes:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\n\nUpgrade Instructions:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\n\nUsage Instructions:\nN/A. This is part of a series PRs, detailed information will be provided in the last/main PR.\n\nTests:\nEnd to end tested with Hello Samza job.", "committedDate": "2020-01-10T19:04:00Z", "type": "commit"}, {"oid": "aa8e1ac3cfb9b870a95c42ea6e5a95db25812910", "url": "https://github.com/apache/samza/commit/aa8e1ac3cfb9b870a95c42ea6e5a95db25812910", "message": "Refactor the common logic to ConfigUtil, which will be used in LocalApplicationRunner as well.", "committedDate": "2020-01-11T00:22:40Z", "type": "commit"}, {"oid": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f", "url": "https://github.com/apache/samza/commit/0d65377e8dacfe79f5a32b6ab196066e8a674e9f", "message": "Remove unused imports", "committedDate": "2020-01-11T00:33:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MjI1OQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365482259", "bodyText": "Do we still need this method to return a list if RemoteApplicationRunner will only ever submit a single job?", "author": "bkonold", "createdAt": "2020-01-11T00:41:20Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,35 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(coordinatorSystemConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(coordinatorSystemConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();", "originalCommit": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NjI3MA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365486270", "bodyText": "Good question, both RemoteApplicationRunner and LocalJobPlanner themselves only works for single-job applications anyway, we may update them, but I think it is better to do it separately. It also relies on our plan to support multi job applications too.", "author": "kw2542", "createdAt": "2020-01-11T01:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MjI1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MzQ0OA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365483448", "bodyText": "s/submissionEnv/submissiongConfig?", "author": "bkonold", "createdAt": "2020-01-11T00:49:10Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +512,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionEnv);", "originalCommit": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NjQ2OA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365486468", "bodyText": "Fixed.", "author": "kw2542", "createdAt": "2020-01-11T01:14:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4MzQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NDcxMg==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365484712", "bodyText": "Why are we merging these config keys in? From what I see these were not being written to the coordinator stream previously but only built and sent along with the submission to the RM", "author": "bkonold", "createdAt": "2020-01-11T00:58:45Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,35 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(coordinatorSystemConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(coordinatorSystemConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();\n+\n+      if (jobConfigs.size() != 1) {\n+        throw new SamzaException(\"Only support single remote job is supported.\");\n+      }\n+\n+      // Merge with default coordinator stream config\n+      config = ConfigUtil.override(jobConfigs.get(0), CoordinatorStreamUtil.buildCoordinatorStreamConfig(jobConfigs.get(0)));", "originalCommit": "0d65377e8dacfe79f5a32b6ab196066e8a674e9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NzA3MQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365487071", "bodyText": "Good question, you are right, we should not need to merge it with the full job config, we only need to build it from the full job config and initialize CoordinatorStreamStore.", "author": "kw2542", "createdAt": "2020-01-11T01:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTQ4NDcxMg=="}], "type": "inlineReview"}, {"oid": "a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b", "url": "https://github.com/apache/samza/commit/a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b", "message": "Update ConfigUtil to handle config overrides, update ClusterBasedJobCoordinator not to merge final config with coordinator stream config to keep consistent with before.", "committedDate": "2020-01-11T01:26:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365990005", "bodyText": "Is it an exceptional case for ConfigLoaderFactory to not be present here?", "author": "bkonold", "createdAt": "2020-01-13T19:37:13Z", "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);\n+    }", "originalCommit": "a7b0d0f6c7b4be861fef8200040e0d8dbd67d30b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MzE4OQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r365993189", "bodyText": "Eventually Yes, but during the migration, there will be cases where jobs are still following the legacy submission flow, but still goes to this new method in code.\nFor example, this util will be called by LocalApplicationRunner too, which will first support both legacy and new flow.", "author": "kw2542", "createdAt": "2020-01-13T19:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA1NTQwNw==", "url": "https://github.com/apache/samza/pull/1248#discussion_r367055407", "bodyText": "The method name loadConfig is a bit misleading if it just might return the config that is passed in. If you still prefer to allow this to succeed when ConfigLoaderFactory is not present, then maybe at least rename the method to help clarify what it might do, so that someone doesn't accidentally call it in an unexpected way.", "author": "cameronlee314", "createdAt": "2020-01-15T19:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MDAyMQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368070021", "bodyText": "Is there something you can do to clarify that this may not actually load any additional configs?", "author": "cameronlee314", "createdAt": "2020-01-17T18:16:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3Njc2NQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368076765", "bodyText": "Updated to disallow the case when ConfigLoaderFactory is not present.", "author": "kw2542", "createdAt": "2020-01-17T18:33:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk5MDAwNQ=="}], "type": "inlineReview"}, {"oid": "86032a6feaa1e25db3e18e18a1dd1f019ec473b7", "url": "https://github.com/apache/samza/commit/86032a6feaa1e25db3e18e18a1dd1f019ec473b7", "message": "Add ticket for clean up", "committedDate": "2020-01-14T20:31:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r366610004", "bodyText": "Should we rename this to something more general now that it won't always be just the coordinator system configs?", "author": "bkonold", "createdAt": "2020-01-14T22:37:53Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -178,9 +185,33 @@\n   public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {", "originalCommit": "86032a6feaa1e25db3e18e18a1dd1f019ec473b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDc3OA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r366610778", "bodyText": "I was planning to rename this variable when cleaning up the legacy flow, but we can choose a generic name in the mid now as well, what do you think?", "author": "kw2542", "createdAt": "2020-01-14T22:39:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxNDIwMA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r366614200", "bodyText": "I think changing it now would be less misleading in the interim. \"jobCoordinatorConfig\"?", "author": "bkonold", "createdAt": "2020-01-14T22:49:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYyNDg4Mw==", "url": "https://github.com/apache/samza/pull/1248#discussion_r366624883", "bodyText": "Renamed to jobCoordinatorConfig and updated the javadoc as well.", "author": "kw2542", "createdAt": "2020-01-14T23:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjYxMDAwNA=="}], "type": "inlineReview"}, {"oid": "c234721851151e9c1c3d192d98b518b59abbba2b", "url": "https://github.com/apache/samza/commit/c234721851151e9c1c3d192d98b518b59abbba2b", "message": "Rename coordinatorSystemConfig to jobCoordinatorConfig to be more generic as it may contain config loader properties instead.", "committedDate": "2020-01-14T23:21:35Z", "type": "commit"}, {"oid": "5d381c46c2b7e55631d744e835feed934f63c27d", "url": "https://github.com/apache/samza/commit/5d381c46c2b7e55631d744e835feed934f63c27d", "message": "Merge branch 'master' of https://github.com/apache/samza into SAMZA-2410", "committedDate": "2020-01-15T00:36:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0Mzc0Mg==", "url": "https://github.com/apache/samza/pull/1248#discussion_r367043742", "bodyText": "Does this need to match the set-up done in JobRunner.run? Maybe it would be good to put a comment in here and in JobRunner to make sure they are consistent. I know it will be cleaned up eventually, but there will be some time in which both flows exist.", "author": "cameronlee314", "createdAt": "2020-01-15T18:44:45Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -172,15 +179,39 @@\n    * Creates a new ClusterBasedJobCoordinator instance from a config. Invoke run() to actually\n    * run the jobcoordinator.\n    *\n-   * @param coordinatorSystemConfig the coordinator stream config that can be used to read the\n-   *                                {@link org.apache.samza.job.model.JobModel} from.\n+   * @param jobCoordinatorConfig job coordinator config that either contains coordinator stream properties\n+   *                             or config loader properties to load full job config.\n    */\n-  public ClusterBasedJobCoordinator(Config coordinatorSystemConfig) {\n+  public ClusterBasedJobCoordinator(Config jobCoordinatorConfig) {\n     metrics = new MetricsRegistryMap();\n \n-    coordinatorStreamStore = new CoordinatorStreamStore(coordinatorSystemConfig, metrics);\n-    coordinatorStreamStore.init();\n-    config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+    JobConfig jobConfig = new JobConfig(jobCoordinatorConfig);\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      // load full job config with ConfigLoader\n+      Config originalConfig = ConfigUtil.loadConfig(jobCoordinatorConfig);\n+\n+      // Execute planning\n+      ApplicationDescriptorImpl<? extends ApplicationDescriptor>\n+          appDesc = ApplicationDescriptorUtil.getAppDescriptor(ApplicationUtil.fromConfig(originalConfig), originalConfig);\n+      RemoteJobPlanner planner = new RemoteJobPlanner(appDesc);\n+      List<JobConfig> jobConfigs = planner.prepareJobs();\n+\n+      if (jobConfigs.size() != 1) {\n+        throw new SamzaException(\"Only support single remote job is supported.\");\n+      }\n+\n+      config = jobConfigs.get(0);\n+      coordinatorStreamStore = new CoordinatorStreamStore(CoordinatorStreamUtil.buildCoordinatorStreamConfig(config), metrics);\n+      coordinatorStreamStore.init();\n+      CoordinatorStreamUtil.writeConfigToCoordinatorStream(config, true);\n+      DiagnosticsUtil.createDiagnosticsStream(config);", "originalCommit": "5d381c46c2b7e55631d744e835feed934f63c27d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzODMwOA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r367138308", "bodyText": "Added a comment", "author": "kw2542", "createdAt": "2020-01-15T22:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0Mzc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r367044694", "bodyText": "Should this check for a blank string instead of just null? It might be easier since it might sometimes be hard to fill in null for an env variable (easier to put the empty string).", "author": "cameronlee314", "createdAt": "2020-01-15T18:46:53Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +510,41 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {", "originalCommit": "5d381c46c2b7e55631d744e835feed934f63c27d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzEzNjEwMQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r367136101", "bodyText": "Good catch. Updated.", "author": "kw2542", "createdAt": "2020-01-15T22:15:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NzAzMQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368067031", "bodyText": "The comment was resolved, but it looks like you are still just checking for null. Did you intend to check for blank string too?", "author": "cameronlee314", "createdAt": "2020-01-17T18:09:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NDQ5OA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368074498", "bodyText": "My bad, changes are lost during updates. Updated again.", "author": "kw2542", "createdAt": "2020-01-17T18:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0NDY5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0OTUxNw==", "url": "https://github.com/apache/samza/pull/1248#discussion_r367049517", "bodyText": "I think the config rewriter sometimes overrides existing configs, so I don't think you want to re-override back to the original.\nDoes the existing flow do this override flow with the original config?", "author": "cameronlee314", "createdAt": "2020-01-15T18:57:12Z", "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = override(ConfigUtil.rewriteConfig(loader.getConfig()), original);", "originalCommit": "5d381c46c2b7e55631d744e835feed934f63c27d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzE0Njk1OA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r367146958", "bodyText": "Good point, we should override the original config with provided overrides and then invoke config rewriters.\nUpdated.", "author": "kw2542", "createdAt": "2020-01-15T22:44:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzA0OTUxNw=="}], "type": "inlineReview"}, {"oid": "a90387a1a7c89abf58ad84875dade3f9fe2e5361", "url": "https://github.com/apache/samza/commit/a90387a1a7c89abf58ad84875dade3f9fe2e5361", "message": "Add extra comments\nOverride config first before applying config rewriters", "committedDate": "2020-01-15T23:54:01Z", "type": "commit"}, {"oid": "c004a97d60e9bff9e5a39328ec9153c014174232", "url": "https://github.com/apache/samza/commit/c004a97d60e9bff9e5a39328ec9153c014174232", "message": "Add unit tests\nRefactor ClusterBasedJobCoordinator to be testable", "committedDate": "2020-01-16T02:26:36Z", "type": "commit"}, {"oid": "4ec226c3359d4e6d0da01ce7bc436b686bc59083", "url": "https://github.com/apache/samza/commit/4ec226c3359d4e6d0da01ce7bc436b686bc59083", "message": "Merge branch 'master' of https://github.com/apache/samza into SAMZA-2410", "committedDate": "2020-01-16T18:13:54Z", "type": "commit"}, {"oid": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "url": "https://github.com/apache/samza/commit/de8ed411e5118dce7ce4f6587379fb29a36495ef", "message": "Fix style issue in test", "committedDate": "2020-01-16T18:48:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NzkxMw==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368067913", "bodyText": "It looks like you already call init in the shared constructor. Please call it only once.", "author": "cameronlee314", "createdAt": "2020-01-17T18:11:13Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {\n+    MetricsRegistryMap metrics = new MetricsRegistryMap();\n+\n+    CoordinatorStreamStore coordinatorStreamStore = new CoordinatorStreamStore(metadataStoreConfig, metrics);\n+    coordinatorStreamStore.init();", "originalCommit": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NzQ1MQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368077451", "bodyText": "Update to call outside constructor as we need it to be initialized before we can read full job config from it in the legacy flow.", "author": "kw2542", "createdAt": "2020-01-17T18:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2NzkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODUyMg==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368068522", "bodyText": "Does this need to be public? If you need in tests, could you make it package private and mark as VisibleForTesting?", "author": "cameronlee314", "createdAt": "2020-01-17T18:12:48Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {", "originalCommit": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3NzY3OA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368077678", "bodyText": "Update to private.", "author": "kw2542", "createdAt": "2020-01-17T18:35:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODUyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODU1MQ==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368068551", "bodyText": "Does this need to be public? If you need in tests, could you make it package private and mark as VisibleForTesting?", "author": "cameronlee314", "createdAt": "2020-01-17T18:12:53Z", "path": "samza-core/src/main/java/org/apache/samza/clustermanager/ClusterBasedJobCoordinator.java", "diffHunk": "@@ -480,20 +485,101 @@ private static void executeRunClusterBasedJobCoordinatorForClass(Class<?> cluste\n    * {@link #main(String[])} so that it can be executed directly or from a separate classloader.\n    */\n   private static void runClusterBasedJobCoordinator(String[] args) {\n-    Config coordinatorSystemConfig;\n     final String coordinatorSystemEnv = System.getenv(ShellCommandConfig.ENV_COORDINATOR_SYSTEM_CONFIG());\n-    try {\n-      //Read and parse the coordinator system config.\n-      LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n-      coordinatorSystemConfig =\n-          new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n-      LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n-    } catch (IOException e) {\n-      LOG.error(\"Exception while reading coordinator stream config\", e);\n-      throw new SamzaException(e);\n+    final String submissionEnv = System.getenv(ShellCommandConfig.ENV_SUBMISSION_CONFIG());\n+\n+    if (submissionEnv != null) {\n+      Config submissionConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing submission config {}\", submissionEnv);\n+        submissionConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(submissionEnv, Config.class));\n+        LOG.info(\"Using the submission config: {}.\", submissionConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading submission config\", e);\n+        throw new SamzaException(e);\n+      }\n+\n+      ClusterBasedJobCoordinator jc = createFromConfigLoader(submissionConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    } else {\n+      // TODO: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+      Config coordinatorSystemConfig;\n+      try {\n+        //Read and parse the coordinator system config.\n+        LOG.info(\"Parsing coordinator system config {}\", coordinatorSystemEnv);\n+        coordinatorSystemConfig =\n+            new MapConfig(SamzaObjectMapper.getObjectMapper().readValue(coordinatorSystemEnv, Config.class));\n+        LOG.info(\"Using the coordinator system config: {}.\", coordinatorSystemConfig);\n+      } catch (IOException e) {\n+        LOG.error(\"Exception while reading coordinator stream config\", e);\n+        throw new SamzaException(e);\n+      }\n+      ClusterBasedJobCoordinator jc = createFromMetadataStore(coordinatorSystemConfig);\n+      jc.run();\n+      LOG.info(\"Finished running ClusterBasedJobCoordinator\");\n+    }\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with coordinator stream config, full job config will be fetched from\n+   * coordinator stream.\n+   *\n+   * @param metadataStoreConfig to initialize {@link MetadataStore}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  // TODO SAMZA-2432: Clean this up once SAMZA-2405 is completed when legacy flow is removed.\n+  public static ClusterBasedJobCoordinator createFromMetadataStore(Config metadataStoreConfig) {\n+    MetricsRegistryMap metrics = new MetricsRegistryMap();\n+\n+    CoordinatorStreamStore coordinatorStreamStore = new CoordinatorStreamStore(metadataStoreConfig, metrics);\n+    coordinatorStreamStore.init();\n+    Config config = CoordinatorStreamUtil.readConfigFromCoordinatorStream(coordinatorStreamStore);\n+\n+    return new ClusterBasedJobCoordinator(metrics, coordinatorStreamStore, config);\n+  }\n+\n+  /**\n+   * Initialize {@link ClusterBasedJobCoordinator} with submission config, full job config will be fetched using\n+   * specified {@link org.apache.samza.config.ConfigLoaderFactory}\n+   *\n+   * @param submissionConfig specifies {@link org.apache.samza.config.ConfigLoaderFactory}\n+   * @return {@link ClusterBasedJobCoordinator}\n+   */\n+  public static ClusterBasedJobCoordinator createFromConfigLoader(Config submissionConfig) {", "originalCommit": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3ODAyNA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368078024", "bodyText": "Update to package private and mark as VisibleForTesting", "author": "kw2542", "createdAt": "2020-01-17T18:36:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA2ODU1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MTg3Mw==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368071873", "bodyText": "Is it practical to do any more-specific validation on the arguments here?", "author": "cameronlee314", "createdAt": "2020-01-17T18:21:00Z", "path": "samza-core/src/test/java/org/apache/samza/clustermanager/TestClusterBasedJobCoordinator.java", "diffHunk": "@@ -198,4 +203,31 @@ public void testRunWithClassLoader() throws Exception {\n     // make sure runClusterBasedJobCoordinator only got called once\n     verifyPrivate(ClusterBasedJobCoordinator.class).invoke(\"runClusterBasedJobCoordinator\", new Object[]{aryEq(args)});\n   }\n+\n+  @Test(expected = SamzaException.class)\n+  public void testCreateFromConfigLoaderWithoutConfigLoaderFactory() {\n+    ClusterBasedJobCoordinator.createFromConfigLoader(new MapConfig());\n+  }\n+\n+  @Test\n+  public void testCreateFromConfigLoader() throws Exception {\n+    // partially mock ClusterBasedJobCoordinator (mock prepareJob method only)\n+    PowerMockito.spy(ClusterBasedJobCoordinator.class);\n+\n+    Map<String, String> config = new HashMap<>();\n+    config.put(ApplicationConfig.APP_CLASS, MockStreamApplication.class.getCanonicalName());\n+    config.put(JobConfig.CONFIG_LOADER_FACTORY, PropertiesConfigLoaderFactory.class.getCanonicalName());\n+    config.put(PropertiesConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX + \"path\",\n+        getClass().getResource(\"/test.properties\").getPath());\n+\n+    PowerMockito.doAnswer(invocation -> invocation.getArgumentAt(0, Config.class))\n+        .when(ClusterBasedJobCoordinator.class, \"prepareJob\", any());\n+    PowerMockito.whenNew(ClusterBasedJobCoordinator.class).withAnyArguments().thenReturn(mock(ClusterBasedJobCoordinator.class));\n+    PowerMockito.whenNew(CoordinatorStreamStore.class).withAnyArguments().thenReturn(mock(CoordinatorStreamStore.class));\n+\n+    ClusterBasedJobCoordinator.createFromConfigLoader(new MapConfig(config));\n+\n+    verifyPrivate(ClusterBasedJobCoordinator.class).invoke(\"prepareJob\", any());\n+    verifyNew(ClusterBasedJobCoordinator.class).withArguments(any(), any(), any());", "originalCommit": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODEwNzUzMg==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368107532", "bodyText": "Updated the unit test have to explicit validation on arguments.", "author": "kw2542", "createdAt": "2020-01-17T19:47:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MTg3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjE3MA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368072170", "bodyText": "Can this just be assertEquals(config, actual)?", "author": "cameronlee314", "createdAt": "2020-01-17T18:21:43Z", "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "diffHunk": "@@ -161,6 +162,31 @@ public void testApplyRewriterClassDoesNotExist() {\n     assertEquals(expectedConfig, ConfigUtil.applyRewriter(new MapConfig(fullConfig), REWRITER_NAME));\n   }\n \n+  @Test\n+  public void testLoadConfigWithoutLoader() {\n+    Map<String, String> config = new HashMap<>();\n+    config.put(JobConfig.JOB_NAME, \"new-test-job\");\n+\n+    Config actual = ConfigUtil.loadConfig(new MapConfig(config));\n+\n+    assertEquals(config.size(), actual.size());\n+    assertEquals(\"new-test-job\", actual.get(JobConfig.JOB_NAME));", "originalCommit": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3OTMxOA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368079318", "bodyText": "Update the unit test to check ConfigException instead as we disallow config w/o loader.", "author": "kw2542", "createdAt": "2020-01-17T18:39:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjE3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjcwNA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368072704", "bodyText": "Should this also test config rewriting and overriding?", "author": "cameronlee314", "createdAt": "2020-01-17T18:23:03Z", "path": "samza-core/src/test/java/org/apache/samza/util/TestConfigUtil.java", "diffHunk": "@@ -161,6 +162,31 @@ public void testApplyRewriterClassDoesNotExist() {\n     assertEquals(expectedConfig, ConfigUtil.applyRewriter(new MapConfig(fullConfig), REWRITER_NAME));\n   }\n \n+  @Test\n+  public void testLoadConfigWithoutLoader() {\n+    Map<String, String> config = new HashMap<>();\n+    config.put(JobConfig.JOB_NAME, \"new-test-job\");\n+\n+    Config actual = ConfigUtil.loadConfig(new MapConfig(config));\n+\n+    assertEquals(config.size(), actual.size());\n+    assertEquals(\"new-test-job\", actual.get(JobConfig.JOB_NAME));\n+  }\n+\n+  @Test\n+  public void testLoadConfigWithLoader() {", "originalCommit": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA4NDMwOA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368084308", "bodyText": "Updated to include both overrides and rewrites.", "author": "kw2542", "createdAt": "2020-01-17T18:51:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MjcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MzE3MA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368073170", "bodyText": "If this is public, can you please add a unit test for it? Or you could make it private.\nYou could also simplify it to only take in one extra argument since that is currently the only way it is used.", "author": "cameronlee314", "createdAt": "2020-01-17T18:24:11Z", "path": "samza-core/src/main/java/org/apache/samza/util/ConfigUtil.java", "diffHunk": "@@ -67,4 +72,42 @@ public static Config applyRewriter(Config config, String rewriterName) {\n     LOG.info(\"Re-writing config with {}\", rewriter);\n     return rewriter.rewrite(rewriterName, config);\n   }\n+\n+  /**\n+   * Load full job config with {@link ConfigLoaderFactory} when present.\n+   *\n+   * @param original config\n+   * @return full job config\n+   */\n+  public static Config loadConfig(Config original) {\n+    JobConfig jobConfig = new JobConfig(original);\n+    Config fullConfig = original;\n+\n+    if (jobConfig.getConfigLoaderFactory().isPresent()) {\n+      ConfigLoaderFactory factory = ReflectionUtil.getObj(jobConfig.getConfigLoaderFactory().get(), ConfigLoaderFactory.class);\n+      ConfigLoader loader = factory.getLoader(original.subset(ConfigLoaderFactory.CONFIG_LOADER_PROPERTIES_PREFIX));\n+      // overrides config loaded with original config, which may contain overridden values.\n+      fullConfig = ConfigUtil.rewriteConfig(override(loader.getConfig(), original));\n+    }\n+\n+    return fullConfig;\n+  }\n+\n+  /**\n+   * Overrides original config with overridden values.\n+   *\n+   * @param original config to be overridden.\n+   * @param overrides overridden values.\n+   * @return the overridden config.\n+   */\n+  @SafeVarargs\n+  public static Config override(Config original, Map<String, String>... overrides) {", "originalCommit": "de8ed411e5118dce7ce4f6587379fb29a36495ef", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3OTUyMA==", "url": "https://github.com/apache/samza/pull/1248#discussion_r368079520", "bodyText": "Updated to private", "author": "kw2542", "createdAt": "2020-01-17T18:39:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODA3MzE3MA=="}], "type": "inlineReview"}, {"oid": "b00cb06351e29501269ac03ca702fba16131590e", "url": "https://github.com/apache/samza/commit/b00cb06351e29501269ac03ca702fba16131590e", "message": "Use StringUtils.isBlank instead of null check", "committedDate": "2020-01-17T18:27:08Z", "type": "commit"}, {"oid": "27210d8aa49b6497400604aab47d722563ff59b4", "url": "https://github.com/apache/samza/commit/27210d8aa49b6497400604aab47d722563ff59b4", "message": "Update", "committedDate": "2020-01-17T18:52:10Z", "type": "commit"}, {"oid": "762fa7de922655c2479e44d8f9470f5944d774c4", "url": "https://github.com/apache/samza/commit/762fa7de922655c2479e44d8f9470f5944d774c4", "message": "Update unit tests", "committedDate": "2020-01-17T19:48:10Z", "type": "commit"}, {"oid": "35f5db240c24b34dd1814930fc4ed6aa56e4b7c3", "url": "https://github.com/apache/samza/commit/35f5db240c24b34dd1814930fc4ed6aa56e4b7c3", "message": "Fix checkstyle in unit test", "committedDate": "2020-01-17T21:03:39Z", "type": "commit"}]}