{"pr_number": 1437, "pr_title": "SAMZA-2598:Kafka clients are not created and closed properly", "pr_createdAt": "2020-11-04T22:08:32Z", "pr_url": "https://github.com/apache/samza/pull/1437", "timeline": [{"oid": "276ed046a57873b038d9256d453df4188ee16b82", "url": "https://github.com/apache/samza/commit/276ed046a57873b038d9256d453df4188ee16b82", "message": "SAMZA-2598:Kafka clients are not created and closed properly", "committedDate": "2020-11-04T20:06:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4Nzg2Ng==", "url": "https://github.com/apache/samza/pull/1437#discussion_r520887866", "bodyText": "preferred way of calling super.finalize should be:\nfinalize() {\ntry {\n.. stop...\n} finally {\nsuper.finalize();\n}\n}", "author": "sborya", "createdAt": "2020-11-10T21:34:14Z", "path": "samza-core/src/main/java/org/apache/samza/coordinator/metadatastore/CoordinatorStreamStore.java", "diffHunk": "@@ -188,6 +188,14 @@ public void flush() {\n     }\n   }\n \n+  @Override", "originalCommit": "276ed046a57873b038d9256d453df4188ee16b82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4OTM0NA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r520889344", "bodyText": "I don't think using finalize is a good idea.\nThis will cause unpredictable performance impact, since each garbage collection may take an arbitrary time now.\nThe services should be stopped as a part of stopped flow, not on garbage collection.", "author": "sborya", "createdAt": "2020-11-10T21:36:57Z", "path": "samza-core/src/main/java/org/apache/samza/coordinator/metadatastore/CoordinatorStreamStore.java", "diffHunk": "@@ -188,6 +188,14 @@ public void flush() {\n     }\n   }\n \n+  @Override\n+  protected void finalize() throws Throwable {", "originalCommit": "276ed046a57873b038d9256d453df4188ee16b82", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f20be45b54b74f6ed07f02a84e63f1b37d48c757", "url": "https://github.com/apache/samza/commit/f20be45b54b74f6ed07f02a84e63f1b37d48c757", "message": "modified to use shutdownhook instead of finalize()", "committedDate": "2020-11-18T01:16:47Z", "type": "commit"}, {"oid": "48dddc0b74b10a52684adfb1732677351ac08945", "url": "https://github.com/apache/samza/commit/48dddc0b74b10a52684adfb1732677351ac08945", "message": "clean up code", "committedDate": "2020-11-18T01:22:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzMjQ2Ng==", "url": "https://github.com/apache/samza/pull/1437#discussion_r525832466", "bodyText": "can we do this.close() ?", "author": "kw2542", "createdAt": "2020-11-18T05:58:22Z", "path": "samza-core/src/main/java/org/apache/samza/coordinator/metadatastore/CoordinatorStreamStore.java", "diffHunk": "@@ -111,6 +111,12 @@ public void init() {\n       systemConsumer.start();\n       systemProducer.register(SOURCE);\n       systemProducer.start();\n+      Runtime.getRuntime().addShutdownHook(new Thread(() -> {\n+        LOG.info(\"CoordinatorStreamStore Shut Down Hook thread is closing kafka clients\");\n+        this.systemProducer.stop();", "originalCommit": "48dddc0b74b10a52684adfb1732677351ac08945", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUzNTA2NA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r526535064", "bodyText": "changed", "author": "MabelYC", "createdAt": "2020-11-19T01:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTgzMjQ2Ng=="}], "type": "inlineReview"}, {"oid": "340af402d51594ea27574c67af24036bd60b67dd", "url": "https://github.com/apache/samza/commit/340af402d51594ea27574c67af24036bd60b67dd", "message": "address comments", "committedDate": "2020-11-19T01:36:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNzAxMQ==", "url": "https://github.com/apache/samza/pull/1437#discussion_r527227011", "bodyText": "Relying on shutdown hooks for lifecycle management of components is not a good idea.\nThe close should be called by whoever created the SystemProducer etc instead. If it's created in this class, this class should have lifecycle methods of it's own, which should be called by the owner of this class.", "author": "prateekm", "createdAt": "2020-11-19T21:53:12Z", "path": "samza-core/src/main/java/org/apache/samza/coordinator/metadatastore/CoordinatorStreamStore.java", "diffHunk": "@@ -111,6 +111,10 @@ public void init() {\n       systemConsumer.start();\n       systemProducer.register(SOURCE);\n       systemProducer.start();\n+      Runtime.getRuntime().addShutdownHook(new Thread(() -> {", "originalCommit": "340af402d51594ea27574c67af24036bd60b67dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI1ODgxNA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r527258814", "bodyText": "+1, shutdown hooks are being executed when JVM exists, it does not seem to fit this scenario. It could be less appropriate compared to finalize() as the warning messages we get from Kafka is emitted in finalize() as well.", "author": "kw2542", "createdAt": "2020-11-19T22:54:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzI2NTIzMg==", "url": "https://github.com/apache/samza/pull/1437#discussion_r527265232", "bodyText": "@kw2542 We shouldn't use finalize either. The Kafka warning shows that we're leaking client references somewhere without closing them. We should try to find and fix the underlying object lifecycle issue first instead of fixing the symptom.", "author": "prateekm", "createdAt": "2020-11-19T23:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMwMzQ0NQ==", "url": "https://github.com/apache/samza/pull/1437#discussion_r527303445", "bodyText": "@kw2542 Just FYI, @MabelYC and I were able to identify the places where we're leaking references in JobCoordinator and LocalApplicationRunner.", "author": "prateekm", "createdAt": "2020-11-20T00:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzMyNjUyOQ==", "url": "https://github.com/apache/samza/pull/1437#discussion_r527326529", "bodyText": "This is awesome!", "author": "kw2542", "createdAt": "2020-11-20T00:58:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNzAxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNzk3Ng==", "url": "https://github.com/apache/samza/pull/1437#discussion_r528027976", "bodyText": "@kw2542 @prateekm  @sborya  Changed to close the clients according to their own lifecycles. Please take a review. Thanks.", "author": "MabelYC", "createdAt": "2020-11-20T23:46:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzIyNzAxMQ=="}], "type": "inlineReview"}, {"oid": "42dcc91a14d0729207cf447cf2c6c9c97c099acd", "url": "https://github.com/apache/samza/commit/42dcc91a14d0729207cf447cf2c6c9c97c099acd", "message": "modifies to close the clients according to lifecycle", "committedDate": "2020-11-20T23:10:04Z", "type": "commit"}, {"oid": "db47dd3db4a9162975363ca17a120aaa9dfd9ae9", "url": "https://github.com/apache/samza/commit/db47dd3db4a9162975363ca17a120aaa9dfd9ae9", "message": "clean up code", "committedDate": "2020-11-20T23:30:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTU4Mg==", "url": "https://github.com/apache/samza/pull/1437#discussion_r528025582", "bodyText": "Won't this cause the current processor to not be stopped?\nDo we also need to stop the metadata store in afterStop()?", "author": "prateekm", "createdAt": "2020-11-20T23:37:21Z", "path": "samza-core/src/main/java/org/apache/samza/runtime/LocalApplicationRunner.java", "diffHunk": "@@ -441,15 +441,24 @@ public void afterStop() {\n \n     @Override\n     public void afterFailure(Throwable t) {\n-      processors.removeIf(pair -> pair.getLeft().equals(processor));\n-\n+      // we need to close associated coordinator metadata store, although the processor failed\n+      processors.forEach(sp -> {", "originalCommit": "db47dd3db4a9162975363ca17a120aaa9dfd9ae9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA0MzE3MA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r528043170", "bodyText": "I think metadata store are closed before calling afterStop().", "author": "MabelYC", "createdAt": "2020-11-21T00:57:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTU4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc5MDczMg==", "url": "https://github.com/apache/samza/pull/1437#discussion_r529790732", "bodyText": "@MabelYC It's not obvious to me how we can guarantee that all metadata stores are always closed. Can you document why you think metadata stores are always closed before calling afterStop?", "author": "prateekm", "createdAt": "2020-11-24T18:27:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTU4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2MTg0MQ==", "url": "https://github.com/apache/samza/pull/1437#discussion_r530061841", "bodyText": "I double checked that the close loop contains some LI specific hookup with offspring. I updated the commit to stop the metadata store in afterStop() to make sure it got closed for sure.", "author": "MabelYC", "createdAt": "2020-11-25T02:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTU4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTk3MQ==", "url": "https://github.com/apache/samza/pull/1437#discussion_r528025971", "bodyText": "Do we know for sure that this method is only called once? If so, do we need to create the checkpoint manager during construction, or can we create it and close it within createResources?", "author": "prateekm", "createdAt": "2020-11-20T23:39:00Z", "path": "samza-core/src/main/java/org/apache/samza/coordinator/MetadataResourceUtil.java", "diffHunk": "@@ -55,6 +55,7 @@ public MetadataResourceUtil(JobModel jobModel, MetricsRegistry metricsRegistry,\n   public void createResources() {\n     if (checkpointManager != null) {\n       checkpointManager.createResources();\n+      checkpointManager.stop();", "originalCommit": "db47dd3db4a9162975363ca17a120aaa9dfd9ae9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA0MzM1OA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r528043358", "bodyText": "I also thought we could create an admin client only to create resources. But i think it is not that good that then we would create two kafka adminClients for the same system in the same manager, and also create another thread. I think it would be better if we only create the clients we really need to create.\nI double checked the method is only called once. And advantages not to create it during construction?", "author": "MabelYC", "createdAt": "2020-11-21T00:58:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4NzY4MA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r529787680", "bodyText": "@MabelYC Sorry, don't understand the first part of your reply. What is that in response to?\nCreating the checkpoint manager in the constructor and stopping it after the first use is :\n\nAsymmetrical. Ideally this class should have lifecycle methods (start/stop) and the checkpoint manager would be stopped there. Also, looks like we don't even start the checkpoint manager?\nMakes an unsafe assumption that the method is only called once. If it was ever called more than once, the second call would fail since the checkpoint manager is already stopped.\n\nIMHO it will be cleaner to create a new checkpoint manager in createResources and close it after use. That way there is no additional overhead as long as it's called once, and its safe if its called more than once.", "author": "prateekm", "createdAt": "2020-11-24T18:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTk3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2MjEyOA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r530062128", "bodyText": "Got it. Updated the pr. Created an adminClient for this function.", "author": "MabelYC", "createdAt": "2020-11-25T02:10:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNTk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNzEwMQ==", "url": "https://github.com/apache/samza/pull/1437#discussion_r528027101", "bodyText": "Is it safe to modify (remove) the map here while iterating over it (foreach)?", "author": "prateekm", "createdAt": "2020-11-20T23:43:08Z", "path": "samza-core/src/main/java/org/apache/samza/runtime/LocalApplicationRunner.java", "diffHunk": "@@ -441,15 +441,24 @@ public void afterStop() {\n \n     @Override\n     public void afterFailure(Throwable t) {\n-      processors.removeIf(pair -> pair.getLeft().equals(processor));\n-\n+      // we need to close associated coordinator metadata store, although the processor failed\n+      processors.forEach(sp -> {\n+        if (sp.getLeft().equals(processor)) {\n+          if (sp.getRight() != null) {\n+            sp.getRight().close();\n+          }\n+          processors.remove(sp);", "originalCommit": "db47dd3db4a9162975363ca17a120aaa9dfd9ae9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODA0MzM2OA==", "url": "https://github.com/apache/samza/pull/1437#discussion_r528043368", "bodyText": "Thanks for pointing this. Changed to remove it after finishing iterating.", "author": "MabelYC", "createdAt": "2020-11-21T00:58:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODAyNzEwMQ=="}], "type": "inlineReview"}, {"oid": "ed0a23092a4f9930a3137c2060ef3817d0b9d53c", "url": "https://github.com/apache/samza/commit/ed0a23092a4f9930a3137c2060ef3817d0b9d53c", "message": "address comments", "committedDate": "2020-11-21T00:57:16Z", "type": "commit"}, {"oid": "1dfe009ea33963e66676deeb5c4804e6ef9664ab", "url": "https://github.com/apache/samza/commit/1dfe009ea33963e66676deeb5c4804e6ef9664ab", "message": "address comments", "committedDate": "2020-11-25T02:08:36Z", "type": "commit"}, {"oid": "126ae084b8399e2975c184006c64ec9fdb166185", "url": "https://github.com/apache/samza/commit/126ae084b8399e2975c184006c64ec9fdb166185", "message": "removed unused code", "committedDate": "2020-11-25T02:15:18Z", "type": "commit"}]}