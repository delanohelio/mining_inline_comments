{"pr_number": 217, "pr_title": "Add resource key validation while parsing", "pr_createdAt": "2020-03-11T08:39:59Z", "pr_url": "https://github.com/linkedin/rest.li/pull/217", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM4NDAzMA==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r391384030", "bodyText": "My last question before giving a ship:\nWhy is this public? Is this used anywhere?", "author": "junchuanwang", "createdAt": "2020-03-12T03:31:08Z", "path": "restli-server/src/main/java/com/linkedin/restli/server/config/ResourceMethodConfigImpl.java", "diffHunk": "@@ -10,15 +10,17 @@\n  *\n  * @author mnchen\n  */\n-class ResourceMethodConfigImpl implements ResourceMethodConfig\n+public class ResourceMethodConfigImpl implements ResourceMethodConfig", "originalCommit": "b2803d65a133fa4dbf5d81c8fce358e0d3984f3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ1NzIyOA==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r391457228", "bodyText": "this is need for RoutingResult default initialization.", "author": "aman1309", "createdAt": "2020-03-12T08:13:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM4NDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc4MjIzOA==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r391782238", "bodyText": "sorry I still didn't quite get why package private is not enough.\nAren't they in the same package? RoutingResult  is in the parent package of ResourceMethodConfigImpl ?", "author": "junchuanwang", "createdAt": "2020-03-12T17:34:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM4NDAzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTc5MDA3NA==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r391790074", "bodyText": "routingresult is not in same package", "author": "aman1309", "createdAt": "2020-03-12T17:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM4NDAzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc1OTUyMQ==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r392759521", "bodyText": "Replying to your comment on the last PR:\n\nResource keys are identifiers for entity on which the resource takes action on.\nthere are two configs here one to validate keys in the path, 2nd in method level config which validates keys in batch requests or resource method argument/params\n\nSo are you saying that the service-level config only determines whether to validate path keys? And the method-level config determines whether to validate the key (either from the path or query param) passed into the resource method invocation? If so, then this naming is confusing and doesn't seem to align with this logic. If my assessment is correct, then a name like RestLiConfig#shouldValidatePathKeys and RestLiMethodConfig#shouldValidateResourceKeys are more intuitive.\nAlso, since these are interfaces meant for public consumption, this should be thoroughly clarified via javadocs on the getters and setters of both configs.", "author": "evanw555", "createdAt": "2020-03-16T02:45:07Z", "path": "restli-server/src/main/java/com/linkedin/restli/server/config/ResourceMethodConfig.java", "diffHunk": "@@ -21,4 +21,9 @@\n    * Config for whether this method will need to validate query parameters.\n    */\n   boolean shouldValidateQueryParams();\n+\n+  /**\n+   * Config for whether this method will need to validate path/resource keys.\n+   */\n+  boolean shouldValidateResourceKeyParams();", "originalCommit": "b2803d65a133fa4dbf5d81c8fce358e0d3984f3d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc1NjExOA==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r393756118", "bodyText": "shouldValidateResourceKeys at all places. updated docs", "author": "aman1309", "createdAt": "2020-03-17T15:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjc1OTUyMQ=="}], "type": "inlineReview"}, {"oid": "c52157a62630edd7c82df9a7b3c513903e4a8d57", "url": "https://github.com/linkedin/rest.li/commit/c52157a62630edd7c82df9a7b3c513903e4a8d57", "message": "Add resource key validation while parsing\nadd tests and fix validate query param", "committedDate": "2020-03-17T15:15:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzc5MTIwMQ==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r393791201", "bodyText": "in pegasus we align method parameters in code style, can you fix this?", "author": "junchuanwang", "createdAt": "2020-03-17T16:03:37Z", "path": "restli-server/src/main/java/com/linkedin/restli/internal/server/util/ArgumentUtils.java", "diffHunk": "@@ -507,16 +559,25 @@ public static Object parseSimplePathKey(final String value,\n     }\n   }\n \n+  public static Object convertSimpleValue(final String value,\n+      final DataSchema schema,", "originalCommit": "c52157a62630edd7c82df9a7b3c513903e4a8d57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5NDYwNA==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r393894604", "bodyText": "nit: this should be pluralized, right? Based on my understanding, there can be multiple keys per method call (e.g. batch method)", "author": "evanw555", "createdAt": "2020-03-17T18:43:03Z", "path": "restli-server/src/main/java/com/linkedin/restli/server/config/ResourceMethodConfig.java", "diffHunk": "@@ -21,4 +21,9 @@\n    * Config for whether this method will need to validate query parameters.\n    */\n   boolean shouldValidateQueryParams();\n+\n+  /**\n+   * Config for whether this method will need to validate path/resource keys.\n+   */\n+  boolean shouldValidateResourceKey();", "originalCommit": "c52157a62630edd7c82df9a7b3c513903e4a8d57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5NTMwNg==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r393895306", "bodyText": "nit: same as other comment.", "author": "evanw555", "createdAt": "2020-03-17T18:44:18Z", "path": "restli-server/src/main/java/com/linkedin/restli/server/config/RestLiMethodConfig.java", "diffHunk": "@@ -19,4 +18,9 @@\n    * Gets whether query parameter validation against its parameter data template is enabled\n    */\n   boolean shouldValidateQueryParams();\n+\n+  /**\n+   * Gets whether resource/path keys validation against its parameter data template is enabled\n+   */\n+  boolean shouldValidateResourceKey();", "originalCommit": "c52157a62630edd7c82df9a7b3c513903e4a8d57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwMjA5Ng==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r394102096", "bodyText": "nit: update this string", "author": "evanw555", "createdAt": "2020-03-18T04:34:18Z", "path": "restli-server/src/main/java/com/linkedin/restli/server/config/ResourceMethodConfigImpl.java", "diffHunk": "@@ -31,26 +33,46 @@ public boolean shouldValidateQueryParams() {\n     return _validateQueryParams;\n   }\n \n+  @Override\n+  public boolean shouldValidateResourceKeys() {\n+    return _validateResourceKeys;\n+  }\n+\n   @Override\n   public String toString()\n   {\n     return \"ResourceMethodConfigImpl{\" +\n-            \"_timeoutMs=\" + _timeoutMs +\n-            '}';\n+          \"_timeoutMs=\" + _timeoutMs +\n+          \", _validateQueryParams=\" + _validateQueryParams +\n+          \", _validateResourceKeyParams=\" + _validateResourceKeys +", "originalCommit": "07d3503cd4b317b40ce156a5080f453aaf4bd303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDEwMjEzMg==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r394102132", "bodyText": "nit: update this variable", "author": "evanw555", "createdAt": "2020-03-18T04:34:31Z", "path": "restli-server/src/main/java/com/linkedin/restli/server/config/RestLiMethodConfigImpl.java", "diffHunk": "@@ -6,11 +6,13 @@\n {\n   private final Map<String, Long> _timeoutMsConfig;\n   private boolean _validateQueryParams;\n+  private boolean _validateResourceKeyParams;", "originalCommit": "07d3503cd4b317b40ce156a5080f453aaf4bd303", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ed716a67c7abfc437a34267dfd1eacb28db1868a", "url": "https://github.com/linkedin/rest.li/commit/ed716a67c7abfc437a34267dfd1eacb28db1868a", "message": "Add resource key validation while parsing", "committedDate": "2020-03-18T06:07:40Z", "type": "commit"}, {"oid": "ed716a67c7abfc437a34267dfd1eacb28db1868a", "url": "https://github.com/linkedin/rest.li/commit/ed716a67c7abfc437a34267dfd1eacb28db1868a", "message": "Add resource key validation while parsing", "committedDate": "2020-03-18T06:07:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQzNDM5OQ==", "url": "https://github.com/linkedin/rest.li/pull/217#discussion_r395434399", "bodyText": "@karthikbalasub  this is code which introduced the bug", "author": "aman1309", "createdAt": "2020-03-20T04:25:50Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/ComplexResourceKey.java", "diffHunk": "@@ -319,16 +356,24 @@ public void makeReadOnly()\n   }\n \n   private static RecordTemplate validateDataMap(DataMap dataMap,\n-                                                TypeSpec<? extends RecordTemplate> spec)\n+                                                TypeSpec<? extends RecordTemplate> spec,\n+                                                boolean enforceValidation)\n   {\n     RecordTemplate recordTemplate = wrapWithSchema(dataMap, spec);\n     // Validate against the class schema with FixupMode.STRING_TO_PRIMITIVE to parse the\n     // strings into the\n     // corresponding primitive types.\n-    ValidateDataAgainstSchema.validate(recordTemplate.data(),\n-                                       recordTemplate.schema(),\n-                                       new ValidationOptions(RequiredMode.CAN_BE_ABSENT_IF_HAS_DEFAULT,\n-                                                             CoercionMode.STRING_TO_PRIMITIVE));\n+    DataSchemaAnnotationValidator validator = new DataSchemaAnnotationValidator(recordTemplate.schema());", "originalCommit": "ed716a67c7abfc437a34267dfd1eacb28db1868a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}