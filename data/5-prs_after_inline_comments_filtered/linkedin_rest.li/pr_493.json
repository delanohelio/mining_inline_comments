{"pr_number": 493, "pr_title": "Fix empty union validation to only allow validation pass when projection in union is present", "pr_createdAt": "2020-12-14T17:31:44Z", "pr_url": "https://github.com/linkedin/rest.li/pull/493", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjczODcwNQ==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542738705", "bodyText": "The schema layer doesn't have the context about it being used in request/response. So using \"response\" here is not a good idea.\nI'd suggest calling this flag \"isPartialSchema\" to indicate this is a partial schema created from projection.\nUpdate the doc to say \"this flag indicates the union schema is a partial representation with a subset of members\" And also say this is for internal use only.", "author": "karthikbalasub", "createdAt": "2020-12-14T20:21:07Z", "path": "data/src/main/java/com/linkedin/data/schema/UnionDataSchema.java", "diffHunk": "@@ -36,6 +36,11 @@\n  */\n public final class UnionDataSchema extends ComplexDataSchema\n {\n+  /**\n+   *\n+   */\n+  private boolean allowEmptyUnionResponse = false;", "originalCommit": "bd549e7ff774cb02c98a1073bdffa10ea99b9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk4OTc5Nw==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542989797", "bodyText": "Ok", "author": "BrianPin", "createdAt": "2020-12-15T02:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjczODcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjczOTE3MA==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542739170", "bodyText": "Comment these are for internal use only.", "author": "karthikbalasub", "createdAt": "2020-12-14T20:21:33Z", "path": "data/src/main/java/com/linkedin/data/schema/UnionDataSchema.java", "diffHunk": "@@ -457,4 +462,14 @@ public static String avroUnionMemberKey(DataSchema schema)\n   private boolean _membersAliased = false;\n \n   private static final Map<String, Integer> _emptyTypesToIndexMap = Collections.emptyMap();\n+\n+  public void setAllowEmptyUnionResponse(boolean allowEmptyUnionResponse)\n+  {\n+    this.allowEmptyUnionResponse = allowEmptyUnionResponse;\n+  }\n+\n+  public boolean isAllowEmptyUnionResponse()", "originalCommit": "bd549e7ff774cb02c98a1073bdffa10ea99b9e66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc0NTQ2Mw==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542745463", "bodyText": "You can remove the part about \"specify member in projection\". It can cause confusion about this error, which if happens means the resource method didn't populate the union field correctly. Using a projection to avoid the error is not the correct way to handle it.", "author": "karthikbalasub", "createdAt": "2020-12-14T20:27:31Z", "path": "data/src/main/java/com/linkedin/data/schema/validation/ValidateDataAgainstSchema.java", "diffHunk": "@@ -526,6 +526,10 @@ else if (_recursive)\n             validate(memberElement, memberSchema, value);\n           }\n         }\n+        else if (!schema.isAllowEmptyUnionResponse())\n+        {\n+          addMessage(element, \"DataMap should have at least one entry for a union type or specify the member in projection\");", "originalCommit": "bd549e7ff774cb02c98a1073bdffa10ea99b9e66", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc0NjY4OA==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542746688", "bodyText": "This should be\nnewMembers.size() < members.size() ?", "author": "karthikbalasub", "createdAt": "2020-12-14T20:28:39Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/util/ProjectionMaskApplier.java", "diffHunk": "@@ -215,6 +215,11 @@ else if (wildcardMask != null)\n \n     UnionDataSchema newUnionDataSchema = new UnionDataSchema();\n     newUnionDataSchema.setMembers(newUnionMembers, errorMessageBuilder);\n+    if (newUnionMembers.size() > 0)", "originalCommit": "bd549e7ff774cb02c98a1073bdffa10ea99b9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk5MTc4Mw==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542991783", "bodyText": "The newMembers.size() < members.size() could be including the case where there is no projection in the union. So I am hesitate to adopt this comment, let me know, Thanks", "author": "BrianPin", "createdAt": "2020-12-15T02:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc0NjY4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3NjAwNw==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r543576007", "bodyText": "Saw your latest comments", "author": "BrianPin", "createdAt": "2020-12-15T18:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc0NjY4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc0ODE3Ng==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542748176", "bodyText": "Add a testcase that projects all union members, it should also fail validation.", "author": "karthikbalasub", "createdAt": "2020-12-14T20:29:57Z", "path": "restli-int-test/src/test/java/com/linkedin/restli/examples/TestEmptyUnionValidation.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+   Copyright (c) 2018 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.restli.examples;\n+\n+import com.linkedin.data.schema.PathSpec;\n+import com.linkedin.r2.RemoteInvocationException;\n+import com.linkedin.restli.client.GetRequest;\n+import com.linkedin.restli.client.Request;\n+import com.linkedin.restli.client.Response;\n+import com.linkedin.restli.client.RestLiResponseException;\n+import com.linkedin.restli.common.BatchCollectionResponse;\n+import com.linkedin.restli.common.HttpStatus;\n+import com.linkedin.restli.examples.greetings.api.ValidateEmptyUnion;\n+import com.linkedin.restli.examples.greetings.api.ValidationDemo;\n+import com.linkedin.restli.examples.greetings.api.ValidationDemoCriteria;\n+import com.linkedin.restli.examples.greetings.client.EmptyUnionRequestBuilders;\n+import com.linkedin.restli.examples.greetings.client.GreetingsBuilders;\n+import com.linkedin.restli.examples.greetings.client.ValidationDemosRequestBuilders;\n+import com.linkedin.restli.server.validation.RestLiValidationFilter;\n+import com.linkedin.restli.test.util.RootBuilderWrapper;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.List;\n+import org.testng.Assert;\n+import org.testng.annotations.AfterClass;\n+import org.testng.annotations.BeforeClass;\n+import org.testng.annotations.DataProvider;\n+import org.testng.annotations.Test;\n+\n+\n+public class TestEmptyUnionValidation extends RestLiIntegrationTest\n+{\n+  @BeforeClass\n+  public void initClass() throws Exception\n+  {\n+    super.init(Collections.singletonList(new RestLiValidationFilter()));\n+  }\n+\n+  @AfterClass\n+  public void shutDown() throws Exception\n+  {\n+    super.shutdown();\n+  }\n+\n+  @Test\n+  public void testUnionEmptyWithProjection() throws RemoteInvocationException\n+  {\n+    ValidateEmptyUnion expected = new ValidateEmptyUnion();\n+    expected.setFoo(new ValidateEmptyUnion.Foo());\n+    List<PathSpec> spec = Collections.singletonList(ValidateEmptyUnion.fields().foo().Fuzz());\n+    EmptyUnionRequestBuilders requestBuilders = new EmptyUnionRequestBuilders();\n+    GetRequest<ValidateEmptyUnion> req = requestBuilders.get().id(1L).fields(spec.toArray(new PathSpec[spec.size()])).build();\n+    ValidateEmptyUnion actual = getClient().sendRequest(req).getResponse().getEntity();\n+    Assert.assertEquals(actual, expected);\n+  }\n+\n+  @Test(expectedExceptions = RestLiResponseException.class)\n+  public void testUnionEmptyWithoutProjection() throws RemoteInvocationException {", "originalCommit": "bd549e7ff774cb02c98a1073bdffa10ea99b9e66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjk5MjI3Nw==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r542992277", "bodyText": "sure, so the criteria will be\nnewUnionMembers.size() > 0 && newUnionMembers.size() < members.size()", "author": "BrianPin", "createdAt": "2020-12-15T02:14:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjc0ODE3Ng=="}], "type": "inlineReview"}, {"oid": "0a3fd63514ce5ca1d71f9a43f67bb30ae95f2eeb", "url": "https://github.com/linkedin/rest.li/commit/0a3fd63514ce5ca1d71f9a43f67bb30ae95f2eeb", "message": "Fix empty union validation from wide open to only open when there is projection", "committedDate": "2020-12-15T02:33:06Z", "type": "commit"}, {"oid": "b197a4b60ac9826d3ed07742e5ba1cf3842bd40b", "url": "https://github.com/linkedin/rest.li/commit/b197a4b60ac9826d3ed07742e5ba1cf3842bd40b", "message": "bump version", "committedDate": "2020-12-15T02:34:39Z", "type": "commit"}, {"oid": "9ae5b6e7c896ac26a8d6c9743da69afa5693b6ce", "url": "https://github.com/linkedin/rest.li/commit/9ae5b6e7c896ac26a8d6c9743da69afa5693b6ce", "message": "address comment to be partial schema validation", "committedDate": "2020-12-15T02:34:44Z", "type": "commit"}, {"oid": "f815580ccc5dbb2a70f0f8fce1442106064e6d45", "url": "https://github.com/linkedin/rest.li/commit/f815580ccc5dbb2a70f0f8fce1442106064e6d45", "message": "address comment about wording", "committedDate": "2020-12-15T02:35:49Z", "type": "commit"}, {"oid": "f815580ccc5dbb2a70f0f8fce1442106064e6d45", "url": "https://github.com/linkedin/rest.li/commit/f815580ccc5dbb2a70f0f8fce1442106064e6d45", "message": "address comment about wording", "committedDate": "2020-12-15T02:35:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIwODEwNQ==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r543208105", "bodyText": "why do you need size > 0 check?\nnewUnionmember size will be zero only if the mask is empty. Which means none of the members were projected. We should treat that as partial projection.\nIt is not possible to create that projection using pathspecs, but someone building the mask map directly can do it.", "author": "karthikbalasub", "createdAt": "2020-12-15T10:04:37Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/util/ProjectionMaskApplier.java", "diffHunk": "@@ -215,6 +215,11 @@ else if (wildcardMask != null)\n \n     UnionDataSchema newUnionDataSchema = new UnionDataSchema();\n     newUnionDataSchema.setMembers(newUnionMembers, errorMessageBuilder);\n+    if (newUnionMembers.size() > 0 && unionDataSchema.getMembers().size() > newUnionMembers.size())", "originalCommit": "f815580ccc5dbb2a70f0f8fce1442106064e6d45", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3MzEwOQ==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r543573109", "bodyText": "For the last sentence, is the following code kind of using pathspecs to create projection?\n    List<PathSpec> spec = Arrays.asList(\n        ValidateEmptyUnion.fields().foo().Fuzz(),\n        ValidateEmptyUnion.fields().foo().Bar());", "author": "BrianPin", "createdAt": "2020-12-15T18:11:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIwODEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzU3NzgwOA==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r543577808", "bodyText": "I meant creating an empty projection for a union., with the following mask map:\n{ \n  foo: {}\n}\n\nusing ValidateEmptyUnion.fields().foo() will result in:\n{\n   foo: 1\n}\n And ValidateEmptyUnion.fields().foo().Fuzz() will result in:\n {\n   foo:  {\n     Fuzz: 1\n   }\n }", "author": "karthikbalasub", "createdAt": "2020-12-15T18:18:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIwODEwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIwODgyMA==", "url": "https://github.com/linkedin/rest.li/pull/493#discussion_r543208820", "bodyText": "2020", "author": "karthikbalasub", "createdAt": "2020-12-15T10:05:33Z", "path": "restli-int-test/src/test/java/com/linkedin/restli/examples/TestEmptyUnionValidation.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+   Copyright (c) 2018 LinkedIn Corp.", "originalCommit": "f815580ccc5dbb2a70f0f8fce1442106064e6d45", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2cf6b674d90373e1a620a44cb05caf05498b3f7e", "url": "https://github.com/linkedin/rest.li/commit/2cf6b674d90373e1a620a44cb05caf05498b3f7e", "message": "Resolve conflict, address comments", "committedDate": "2020-12-15T17:51:09Z", "type": "commit"}, {"oid": "0f4e2a5a49db82014a22827e4184111bf831486a", "url": "https://github.com/linkedin/rest.li/commit/0f4e2a5a49db82014a22827e4184111bf831486a", "message": "Remove the condition of zero projection to be count as partial projection", "committedDate": "2020-12-15T17:58:40Z", "type": "commit"}, {"oid": "c345e0d4a416de0eadb88d25875fb279ddf08bb1", "url": "https://github.com/linkedin/rest.li/commit/c345e0d4a416de0eadb88d25875fb279ddf08bb1", "message": "re-fix the release diff in changelog.md", "committedDate": "2020-12-15T18:15:27Z", "type": "commit"}, {"oid": "263ec89de843263a4271a1613d25c0c9126940f0", "url": "https://github.com/linkedin/rest.li/commit/263ec89de843263a4271a1613d25c0c9126940f0", "message": "fix an int test", "committedDate": "2020-12-15T19:04:15Z", "type": "commit"}]}