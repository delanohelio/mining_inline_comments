{"pr_number": 407, "pr_title": "Update RestLiValidatorFilter and RestLiDataValidator to expose creation of restli validators", "pr_createdAt": "2020-09-03T17:49:36Z", "pr_url": "https://github.com/linkedin/rest.li/pull/407", "timeline": [{"oid": "23a410d23e563ab8c4778134e8747d75a9cec61b", "url": "https://github.com/linkedin/rest.li/commit/23a410d23e563ab8c4778134e8747d75a9cec61b", "message": "Update RestLiValidationFilter to expose an override ability for RestLiDataValidator", "committedDate": "2020-09-03T02:12:42Z", "type": "commit"}, {"oid": "d2b562bc0b882e2b5a635bc3c7f32b787eabb8cd", "url": "https://github.com/linkedin/rest.li/commit/d2b562bc0b882e2b5a635bc3c7f32b787eabb8cd", "message": "Update RestLiValidationFilter to expose an override ability for RestLiDataValidator", "committedDate": "2020-09-03T03:09:21Z", "type": "commit"}, {"oid": "60edd60329a849215390d6118a2d0a892907ff50", "url": "https://github.com/linkedin/rest.li/commit/60edd60329a849215390d6118a2d0a892907ff50", "message": "Merge branch 'master' of github.com:vshwnth2/rest.li", "committedDate": "2020-09-03T03:11:30Z", "type": "commit"}, {"oid": "27acf36d0b35b6100ce276d9a01528b6267f82c1", "url": "https://github.com/linkedin/rest.li/commit/27acf36d0b35b6100ce276d9a01528b6267f82c1", "message": "refactor some logic", "committedDate": "2020-09-03T03:18:00Z", "type": "commit"}, {"oid": "b32cfa1b10b87931b709f295ba38a174af4b5f99", "url": "https://github.com/linkedin/rest.li/commit/b32cfa1b10b87931b709f295ba38a174af4b5f99", "message": "refactor", "committedDate": "2020-09-03T03:20:07Z", "type": "commit"}, {"oid": "ef53f2d6c0c8f7a5cd038edad70d09b20f0f9cec", "url": "https://github.com/linkedin/rest.li/commit/ef53f2d6c0c8f7a5cd038edad70d09b20f0f9cec", "message": "rearranging code", "committedDate": "2020-09-03T03:54:59Z", "type": "commit"}, {"oid": "5fdbfcd33378fdf6c488fc8a3c9518c899fc175a", "url": "https://github.com/linkedin/rest.li/commit/5fdbfcd33378fdf6c488fc8a3c9518c899fc175a", "message": "refactor more", "committedDate": "2020-09-03T04:13:48Z", "type": "commit"}, {"oid": "93f0cd225724d865df0c69f8b2db6f05c19ac4b8", "url": "https://github.com/linkedin/rest.li/commit/93f0cd225724d865df0c69f8b2db6f05c19ac4b8", "message": "fix indent", "committedDate": "2020-09-03T04:14:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE4NDU2Mg==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r483184562", "bodyText": "Why do you need this?\nWould it be cleaner to use Function<DataSchema, Validator> that accepts the validating schema and returns the validator to use?\nOther option is to make it a protected method, which can be overridden.\nprotected Validator getValidatorForOutput(DataSchema validatingSchema);\n\nThis way, the logic to initialize the validator is still within this class.\nAlso, this validator has a separate logic for validating input entities (see validateInputEntity and validatePatch) using the DataValidator inner class. It would be good to handle that also. Something like:\nprotected Validator getValidatorForInput(DataSchema validatingSchema);\n\nIn both cases, if the overriding implementation needs caching, it can do\n {\n    return cache.computeIfAbsent(super.getValidator..(schema));\n  }", "author": "karthikbalasub", "createdAt": "2020-09-03T18:45:17Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataValidator.java", "diffHunk": "@@ -436,6 +437,19 @@ public ValidationResult validateOutput(RecordTemplate dataTemplate, MaskTree pro\n    * @throws IllegalArgumentException if any argument is null or if the provided data template has no data\n    */\n   protected ValidationResult validateOutputAgainstSchema(RecordTemplate dataTemplate, DataSchema validatingSchema)\n+  {\n+    if (validatingSchema == null)\n+    {\n+      throw new IllegalArgumentException(\"Validating schema is null\");\n+    }\n+\n+    return validateOutputAgainstSchema(dataTemplate,\n+        () -> ValidateDataAgainstSchema.validate(dataTemplate.data(), validatingSchema, new ValidationOptions(),\n+            new DataSchemaAnnotationValidator(validatingSchema)));\n+  }\n+\n+  protected ValidationResult validateOutputAgainstSchema(RecordTemplate dataTemplate,\n+      Supplier<ValidationResult> validationResultSupplier)", "originalCommit": "93f0cd225724d865df0c69f8b2db6f05c19ac4b8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzIzMjAzNQ==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r483232035", "bodyText": "In regards to protected Validator getValidatorForOutput(DataSchema validatingSchema);, we would be overriding this in RestLiDataSchemaDataValidator right?\nIn this case, the overridden method would look something like\nprotected Validator getValidatorForOutput(DataSchema validatingSchema) { \n     return _schemaValidator;\n}\n\nIt felt a little strange to me to do something like this, since we are ignoring the input validatingSchema parameter. Perhaps we can check if its == to the class' _validatingSchema and if it is return _schemaValidator, otherwise to create a new one. Thoughts? Essentially something like:\n@Override\n  protected Validator getValidatorForOutput(DataSchema validatingSchema) {\n    if (_validatingSchema.equals(validatingSchema))\n    {\n      return _schemaValidator;\n    }\n    else\n    {\n      return super.getValidatorForOutput(validatingSchema);\n    }\n  }\n\nSimilarly with the first suggestion, it felt strange to ignore schema input. From my understanding of your comment we would essentially have a method in the base class like\n  protected Function<DataSchema, Validator> getValidatorFunction() {\n    return DataSchemaAnnotationValidator::new;\n  }\n\nand override it in RestLiDataSchemaDataValidator with\n  @Override\n  protected Function<DataSchema, Validator> getValidatorFunction() {\n    return schema -> _schemaValidator;\n  }\n\nAgreed it would be great to do a similar thing for getValidatorForInput. Only thing here is the default implementation is new DataValidator(validatingSchema) and DataValidator is a private class in RestLiDataValidator. Is it okay to make it protected so that we have access to it in RestLiDataSchemaDataValidator?", "author": "vshwnth2", "createdAt": "2020-09-03T20:20:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE4NDU2Mg=="}], "type": "inlineReview"}, {"oid": "01ccf2f9e11c41cd0fcdfbb424b758ebcd919336", "url": "https://github.com/linkedin/rest.li/commit/01ccf2f9e11c41cd0fcdfbb424b758ebcd919336", "message": "Refactor code based on comments", "committedDate": "2020-09-03T22:45:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMDgxOA==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r483510818", "bodyText": "nit: this can be DataValidator", "author": "karthikbalasub", "createdAt": "2020-09-04T09:45:36Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataSchemaDataValidator.java", "diffHunk": "@@ -32,6 +34,8 @@\n  */\n public class RestLiDataSchemaDataValidator extends RestLiDataValidator {\n   private final DataSchema _validatingSchema;\n+  private final DataValidator _inputDataValidator;\n+  private final DataSchemaAnnotationValidator _outputSchemaValidator;", "originalCommit": "01ccf2f9e11c41cd0fcdfbb424b758ebcd919336", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMzE5Mg==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r483513192", "bodyText": "This is not going to be useful. The validatingSchema is for output, based on projection.\nand for inputs it would be the resource entity schema or a subset based on patch for partial_update.\nInstead of initializing in the constructor, you should just use getValidatorFor* methods, but cache them after first invocation?\nAlso this validator class is used only for output validation (input uses RestLiDataValidator directly). so you can remove all the input validator logic and remove the override for getValidatorForInput", "author": "karthikbalasub", "createdAt": "2020-09-04T09:50:09Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataSchemaDataValidator.java", "diffHunk": "@@ -53,6 +57,8 @@ public RestLiDataSchemaDataValidator(Annotation[] annotations,\n     }\n \n     _validatingSchema = validatingSchema;\n+    _inputDataValidator = new DataValidator(_validatingSchema);", "originalCommit": "01ccf2f9e11c41cd0fcdfbb424b758ebcd919336", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxNTM2Nw==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r483515367", "bodyText": "I actually don't see the need for changes in this file. The changes in other two classes should be enough to override the validator construction logic.", "author": "karthikbalasub", "createdAt": "2020-09-04T09:54:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc2Njc0MA==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r483766740", "bodyText": "Is the suggestion to sub-class RestLiDataSchemaDataValidator and RestLiDataValidator ourselves in our own implementation and use them in our sub-class of RestLiValidator by overriding createRequestRestLiDataValidator and createResponseRestLiDataValidator?\nFor the output use case, is there a reason we need to do it explicitly via a cache? For each _validatingSchema instantiation, it should be the same DataSchemaAnnotationValidator from my understanding, so it feels that this doesn't have to be done via a cache on an outer layer", "author": "vshwnth2", "createdAt": "2020-09-04T17:43:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NDM3Ng==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484664376", "bodyText": "If you plan to re-use this validator, then we can leave the caching. However, this validator is used only for output validation (maybe the javadoc should be updated to mention this). So you should remove the override for getValidatorForInput.", "author": "karthikbalasub", "createdAt": "2020-09-08T05:49:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMzE5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY2NjQyNw==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484666427", "bodyText": "Removed the override and updated the javadoc", "author": "vshwnth2", "createdAt": "2020-09-08T05:55:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzUxMzE5Mg=="}], "type": "inlineReview"}, {"oid": "080a1da2bad2ffc914c3f8ac458924609576c614", "url": "https://github.com/linkedin/rest.li/commit/080a1da2bad2ffc914c3f8ac458924609576c614", "message": "Remove the input validator override from RestLiDataSchemaDataValidator", "committedDate": "2020-09-08T05:53:05Z", "type": "commit"}, {"oid": "4da09991b7876c6aa611adf79bb74e3d1ed72337", "url": "https://github.com/linkedin/rest.li/commit/4da09991b7876c6aa611adf79bb74e3d1ed72337", "message": "Updated javadocs", "committedDate": "2020-09-08T05:55:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NDI2Mw==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484684263", "bodyText": "I think you meant to say \"{@link RestLiDataValidator}\", same as line 476, 484, 488", "author": "junchuanwang", "createdAt": "2020-09-08T06:41:32Z", "path": "restli-server/src/main/java/com/linkedin/restli/server/validation/RestLiValidationFilter.java", "diffHunk": "@@ -487,4 +467,46 @@ private boolean shouldValidateOnResponse(FilterRequestContext requestContext)\n     future.completeExceptionally(t);\n     return future;\n   }\n+\n+  /**\n+   * Creates a {@link RestLiValidationFilter} to use for validation onRequest.", "originalCommit": "4da09991b7876c6aa611adf79bb74e3d1ed72337", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5MTMwNQ==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484691305", "bodyText": "good catch, thanks", "author": "vshwnth2", "createdAt": "2020-09-08T06:57:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NDI2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NTA3MQ==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484685071", "bodyText": "Sorry can you remind me why this changes from instantiating \"DataValidator\" to \"DataSchemaAnnotationValidator\" now?", "author": "junchuanwang", "createdAt": "2020-09-08T06:43:26Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataValidator.java", "diffHunk": "@@ -608,13 +608,21 @@ private ValidationResult validateInputEntity(RecordTemplate entity)\n     //  the client cannot supply them in a create request, so they should be treated as optional.\n     //  similarly for update requests used as upsert (update to create), they are treated as optional.\n     validationOptions.setTreatOptional(_readOnlyOptionalPredicate);\n-    return ValidateDataAgainstSchema.validate(entity, validationOptions, new DataValidator(entity.schema()));\n+    return ValidateDataAgainstSchema.validate(entity, validationOptions, getValidatorForInput(entity.schema()));\n   }\n \n   private ValidationResult validateOutputEntity(RecordTemplate entity, DataSchema validatingSchema)\n   {\n-    DataSchemaAnnotationValidator validator = new DataSchemaAnnotationValidator(validatingSchema);\n-    return ValidateDataAgainstSchema.validate(entity.data(), validatingSchema, new ValidationOptions(), validator);\n+    return ValidateDataAgainstSchema.validate(entity.data(), validatingSchema, new ValidationOptions(),\n+        getValidatorForOutput(validatingSchema));\n+  }\n+\n+  protected Validator getValidatorForOutput(DataSchema validatingSchema) {\n+    return new DataSchemaAnnotationValidator(validatingSchema);", "originalCommit": "4da09991b7876c6aa611adf79bb74e3d1ed72337", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY5MTU0Nw==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484691547", "bodyText": "both before and after instantiate DataSchemaAnnotationValidator, this just abstracts it out into its own method", "author": "vshwnth2", "createdAt": "2020-09-08T06:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NTA3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM4MjM3NA==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r485382374", "bodyText": "you are right. I previously misunderstood", "author": "junchuanwang", "createdAt": "2020-09-09T07:00:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NTA3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NjA0Mg==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484686042", "bodyText": "nit: I personally think \"getValidatorForOutput\" an incomplete name, it makes more sense to me to say for example \"getValidatorForOutputEntityValidation\"", "author": "junchuanwang", "createdAt": "2020-09-08T06:45:38Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataSchemaDataValidator.java", "diffHunk": "@@ -66,6 +71,24 @@ public ValidationResult validateOutput(RecordTemplate dataTemplate)\n     return super.validateOutputAgainstSchema(dataTemplate, _validatingSchema);\n   }\n \n+  /**\n+   * Validator to use to validate the output.\n+   * The validator is instantiated in the constructor, so directly returns that if input is equal to _validatingSchema.\n+   * @param validatingSchema schema to validate against\n+   * @return validator\n+   */\n+  @Override\n+  protected Validator getValidatorForOutput(DataSchema validatingSchema) {", "originalCommit": "4da09991b7876c6aa611adf79bb74e3d1ed72337", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4ODEwMg==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r484688102", "bodyText": "sounds good, will update", "author": "vshwnth2", "createdAt": "2020-09-08T06:50:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY4NjA0Mg=="}], "type": "inlineReview"}, {"oid": "392396173e1ca5c8b8b939186a814c6990b69e07", "url": "https://github.com/linkedin/rest.li/commit/392396173e1ca5c8b8b939186a814c6990b69e07", "message": "address PR comments", "committedDate": "2020-09-08T07:01:37Z", "type": "commit"}, {"oid": "916535fce5c50d68b5e5b330a78c8025020404bd", "url": "https://github.com/linkedin/rest.li/commit/916535fce5c50d68b5e5b330a78c8025020404bd", "message": "Update validatingSchema check to == to avoid expensive computation", "committedDate": "2020-09-08T21:38:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NjQ2NA==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r485246464", "bodyText": "if the strict pointer equality check is on purpose, please add an inline doc on why it's the case", "author": "idarmans", "createdAt": "2020-09-08T23:17:27Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataSchemaDataValidator.java", "diffHunk": "@@ -66,6 +71,24 @@ public ValidationResult validateOutput(RecordTemplate dataTemplate)\n     return super.validateOutputAgainstSchema(dataTemplate, _validatingSchema);\n   }\n \n+  /**\n+   * Validator to use to validate the output.\n+   * The validator is instantiated in the constructor, so directly returns that if input is equal to _validatingSchema.\n+   * @param validatingSchema schema to validate against\n+   * @return validator\n+   */\n+  @Override\n+  protected Validator getValidatorForOutputEntityValidation(DataSchema validatingSchema) {\n+    if (_validatingSchema == validatingSchema)", "originalCommit": "916535fce5c50d68b5e5b330a78c8025020404bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTM4OTc1OQ==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r485389759", "bodyText": "+1 on Ivan's suggestion", "author": "karthikbalasub", "createdAt": "2020-09-09T07:16:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTI0NjQ2NA=="}], "type": "inlineReview"}, {"oid": "9373e03004f1cc2eae48aa5b2b95657209cd42a6", "url": "https://github.com/linkedin/rest.li/commit/9373e03004f1cc2eae48aa5b2b95657209cd42a6", "message": "Update changelog and add some comments", "committedDate": "2020-09-09T18:21:51Z", "type": "commit"}, {"oid": "7ed86c9a196cf00547b97759b552432515375a8e", "url": "https://github.com/linkedin/rest.li/commit/7ed86c9a196cf00547b97759b552432515375a8e", "message": "Merge branch 'master' into master", "committedDate": "2020-09-09T20:14:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjAwODA1Mg==", "url": "https://github.com/linkedin/rest.li/pull/407#discussion_r486008052", "bodyText": "nit: move braces to newline.", "author": "karthikbalasub", "createdAt": "2020-09-10T01:24:13Z", "path": "restli-common/src/main/java/com/linkedin/restli/common/validation/RestLiDataValidator.java", "diffHunk": "@@ -608,13 +608,21 @@ private ValidationResult validateInputEntity(RecordTemplate entity)\n     //  the client cannot supply them in a create request, so they should be treated as optional.\n     //  similarly for update requests used as upsert (update to create), they are treated as optional.\n     validationOptions.setTreatOptional(_readOnlyOptionalPredicate);\n-    return ValidateDataAgainstSchema.validate(entity, validationOptions, new DataValidator(entity.schema()));\n+    return ValidateDataAgainstSchema.validate(entity, validationOptions, getValidatorForInputEntityValidation(entity.schema()));\n   }\n \n   private ValidationResult validateOutputEntity(RecordTemplate entity, DataSchema validatingSchema)\n   {\n-    DataSchemaAnnotationValidator validator = new DataSchemaAnnotationValidator(validatingSchema);\n-    return ValidateDataAgainstSchema.validate(entity.data(), validatingSchema, new ValidationOptions(), validator);\n+    return ValidateDataAgainstSchema.validate(entity.data(), validatingSchema, new ValidationOptions(),\n+        getValidatorForOutputEntityValidation(validatingSchema));\n+  }\n+\n+  protected Validator getValidatorForOutputEntityValidation(DataSchema validatingSchema) {\n+    return new DataSchemaAnnotationValidator(validatingSchema);\n+  }\n+\n+  protected Validator getValidatorForInputEntityValidation(DataSchema validatingSchema) {\n+    return new DataValidator(validatingSchema);", "originalCommit": "7ed86c9a196cf00547b97759b552432515375a8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c2dc0386d1b1de6f43f33dec127c94eccfe5a5af", "url": "https://github.com/linkedin/rest.li/commit/c2dc0386d1b1de6f43f33dec127c94eccfe5a5af", "message": "fix braces", "committedDate": "2020-09-10T02:11:06Z", "type": "commit"}]}