{"pr_number": 381, "pr_title": "Put extension schemas into the dataTemplate jar under /extensions path", "pr_createdAt": "2020-08-14T00:15:07Z", "pr_url": "https://github.com/linkedin/rest.li/pull/381", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0MjM1MA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470342350", "bodyText": "It would make more sense if it was called validateExtensionSchemas IMO", "author": "evanw555", "createdAt": "2020-08-14T00:49:18Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -1693,6 +1646,34 @@ protected GenerateDataTemplateTask configureDataTemplateGeneration(Project proje\n     prepareLegacySchemasForPublishTask.dependsOn(destroyStaleFiles);\n     dataTemplateJarDepends.add(prepareLegacySchemasForPublishTask);\n \n+    // extension schema directory\n+    File extensionSchemaDir = project.file(getExtensionSchemaPath(project, sourceSet));\n+\n+    if (!SharedFileUtils.getSuffixedFiles(project, extensionSchemaDir, PDL_FILE_SUFFIX).isEmpty()) {\n+      // Validate extension schemas if extension schemas are provided.\n+      ValidateExtensionSchemaTask validateExtensionSchemaTask = project.getTasks()\n+          .create(sourceSet.getTaskName(\"validate\", \"ExtensionSchema\"), ValidateExtensionSchemaTask.class, task -> {", "originalCommit": "4df68aee6e917cf095bd08e6a07c6cf52d801cdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1NzUyMw==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470357523", "bodyText": "fixed", "author": "nickibi", "createdAt": "2020-08-14T01:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0MjM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0MzY4MA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470343680", "bodyText": "So we're only supporting extensions as PDLs from the get-go? Good \ud83d\ude03", "author": "evanw555", "createdAt": "2020-08-14T00:51:14Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -1693,6 +1646,34 @@ protected GenerateDataTemplateTask configureDataTemplateGeneration(Project proje\n     prepareLegacySchemasForPublishTask.dependsOn(destroyStaleFiles);\n     dataTemplateJarDepends.add(prepareLegacySchemasForPublishTask);\n \n+    // extension schema directory\n+    File extensionSchemaDir = project.file(getExtensionSchemaPath(project, sourceSet));\n+\n+    if (!SharedFileUtils.getSuffixedFiles(project, extensionSchemaDir, PDL_FILE_SUFFIX).isEmpty()) {\n+      // Validate extension schemas if extension schemas are provided.\n+      ValidateExtensionSchemaTask validateExtensionSchemaTask = project.getTasks()\n+          .create(sourceSet.getTaskName(\"validate\", \"ExtensionSchema\"), ValidateExtensionSchemaTask.class, task -> {\n+            task.setInputDir(extensionSchemaDir);\n+            task.setResolverPath(\n+                getDataModelConfig(project, sourceSet).plus(project.files(getDataSchemaPath(project, sourceSet))));\n+            task.setClassPath(project.getConfigurations().getByName(\"pegasusPlugin\"));\n+            if (isPropertyTrue(project, ENABLE_ARG_FILE)) {\n+              task.setEnableArgFile(true);\n+            }\n+          });\n+\n+      Task prepareExtensionSchemasForPublishTask = project.getTasks()\n+          .create(sourceSet.getName() + \"CopyExtensionSchemas\", Sync.class, task ->\n+          {\n+            task.from(extensionSchemaDir, syncSpec -> syncSpec.include(\"**/*\" + PDL_FILE_SUFFIX));", "originalCommit": "4df68aee6e917cf095bd08e6a07c6cf52d801cdd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM1MDU4Mg==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470350582", "bodyText": "Yes, this feature is only supported for PDL.", "author": "nickibi", "createdAt": "2020-08-14T01:01:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM0MzY4MA=="}], "type": "inlineReview"}, {"oid": "8572cface14bf50b2065789632647e177022d73b", "url": "https://github.com/linkedin/rest.li/commit/8572cface14bf50b2065789632647e177022d73b", "message": "Put extension schemas into the dataTemplate jar under /extensions path  instead of putting them into the extensionSchema jar", "committedDate": "2020-08-14T01:10:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3OTYzMQ==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470379631", "bodyText": "nit: move \"pegasusPlugin\" to constants", "author": "aman1309", "createdAt": "2020-08-14T02:45:11Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -1693,6 +1646,34 @@ protected GenerateDataTemplateTask configureDataTemplateGeneration(Project proje\n     prepareLegacySchemasForPublishTask.dependsOn(destroyStaleFiles);\n     dataTemplateJarDepends.add(prepareLegacySchemasForPublishTask);\n \n+    // extension schema directory\n+    File extensionSchemaDir = project.file(getExtensionSchemaPath(project, sourceSet));\n+\n+    if (!SharedFileUtils.getSuffixedFiles(project, extensionSchemaDir, PDL_FILE_SUFFIX).isEmpty()) {\n+      // Validate extension schemas if extension schemas are provided.\n+      ValidateExtensionSchemaTask validateExtensionSchemaTask = project.getTasks()\n+          .create(sourceSet.getTaskName(\"validate\", \"ExtensionSchemas\"), ValidateExtensionSchemaTask.class, task -> {\n+            task.setInputDir(extensionSchemaDir);\n+            task.setResolverPath(\n+                getDataModelConfig(project, sourceSet).plus(project.files(getDataSchemaPath(project, sourceSet))));\n+            task.setClassPath(project.getConfigurations().getByName(\"pegasusPlugin\"));", "originalCommit": "8572cface14bf50b2065789632647e177022d73b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzNDkzNA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470934934", "bodyText": "Used constants instead.", "author": "nickibi", "createdAt": "2020-08-15T04:11:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3OTYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNjgxNA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470416814", "bodyText": "I think in rest.li the left curly brace is in next line", "author": "BrianPin", "createdAt": "2020-08-14T05:25:19Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -1693,6 +1646,34 @@ protected GenerateDataTemplateTask configureDataTemplateGeneration(Project proje\n     prepareLegacySchemasForPublishTask.dependsOn(destroyStaleFiles);\n     dataTemplateJarDepends.add(prepareLegacySchemasForPublishTask);\n \n+    // extension schema directory\n+    File extensionSchemaDir = project.file(getExtensionSchemaPath(project, sourceSet));\n+\n+    if (!SharedFileUtils.getSuffixedFiles(project, extensionSchemaDir, PDL_FILE_SUFFIX).isEmpty()) {", "originalCommit": "8572cface14bf50b2065789632647e177022d73b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDcyOTU4OQ==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470729589", "bodyText": "Good catch.", "author": "nickibi", "createdAt": "2020-08-14T16:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNjgxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzNDkzNw==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470934937", "bodyText": "Fixed", "author": "nickibi", "createdAt": "2020-08-15T04:11:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNjgxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNzU2MQ==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470417561", "bodyText": "Question, what is the previous task of task: prepareExtensionSchemasForPublishTask and what is the next task?\nI feel prepare should be part of some task, not itself a task. But let me know if I miss understand something.", "author": "BrianPin", "createdAt": "2020-08-14T05:28:15Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -1693,6 +1646,34 @@ protected GenerateDataTemplateTask configureDataTemplateGeneration(Project proje\n     prepareLegacySchemasForPublishTask.dependsOn(destroyStaleFiles);\n     dataTemplateJarDepends.add(prepareLegacySchemasForPublishTask);\n \n+    // extension schema directory\n+    File extensionSchemaDir = project.file(getExtensionSchemaPath(project, sourceSet));\n+\n+    if (!SharedFileUtils.getSuffixedFiles(project, extensionSchemaDir, PDL_FILE_SUFFIX).isEmpty()) {\n+      // Validate extension schemas if extension schemas are provided.\n+      ValidateExtensionSchemaTask validateExtensionSchemaTask = project.getTasks()\n+          .create(sourceSet.getTaskName(\"validate\", \"ExtensionSchemas\"), ValidateExtensionSchemaTask.class, task -> {\n+            task.setInputDir(extensionSchemaDir);\n+            task.setResolverPath(\n+                getDataModelConfig(project, sourceSet).plus(project.files(getDataSchemaPath(project, sourceSet))));\n+            task.setClassPath(project.getConfigurations().getByName(\"pegasusPlugin\"));\n+            if (isPropertyTrue(project, ENABLE_ARG_FILE)) {\n+              task.setEnableArgFile(true);\n+            }\n+          });\n+\n+      Task prepareExtensionSchemasForPublishTask = project.getTasks()", "originalCommit": "8572cface14bf50b2065789632647e177022d73b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxODExNA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470418114", "bodyText": "I see validateExtensionSchemaTask and copyPdscSchemasTask is the previous task of this one.", "author": "BrianPin", "createdAt": "2020-08-14T05:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNzU2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDkzNDk2Ng==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r470934966", "bodyText": "Discussed offline, not a question any more.", "author": "nickibi", "createdAt": "2020-08-15T04:11:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDQxNzU2MQ=="}], "type": "inlineReview"}, {"oid": "a927a2fa11fdec9076a0496be86cdb6880ca7b9c", "url": "https://github.com/linkedin/rest.li/commit/a927a2fa11fdec9076a0496be86cdb6880ca7b9c", "message": "Put extension schemas into the dataTemplate jar under /extensions path instead of putting them into the extensionSchema jar", "committedDate": "2020-08-15T04:09:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0MDQyMA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r471040420", "bodyText": "There is a hardcoded \"extensions\"  literal in the function getExtensionSchemaPath, I feel it will be left alone if we somehow decide to refactor all the extension schema path to something else. And there is probably somewhere else use the same purpose identifier \"extensions\" , if we can create or find existing identifier that represent \"extensions\" path then it will be ideal.", "author": "BrianPin", "createdAt": "2020-08-15T22:36:52Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -1693,6 +1648,37 @@ protected GenerateDataTemplateTask configureDataTemplateGeneration(Project proje\n     prepareLegacySchemasForPublishTask.dependsOn(destroyStaleFiles);\n     dataTemplateJarDepends.add(prepareLegacySchemasForPublishTask);\n \n+    // extension schema directory\n+    File extensionSchemaDir = project.file(getExtensionSchemaPath(project, sourceSet));\n+\n+    if (!SharedFileUtils.getSuffixedFiles(project, extensionSchemaDir, PDL_FILE_SUFFIX).isEmpty())", "originalCommit": "a927a2fa11fdec9076a0496be86cdb6880ca7b9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0NzA3Mw==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r471047073", "bodyText": "For the first question, are you talking about we should make \"extensions\" as a constant\uff1fI could update it to use constant instead. \"extensions\" directory is like \"pegasus\" directory, we defined how the schema directory will be structured. Also we provide the config to customers, if they prefer to use other directory for extension schemas. I think what you said should not be a problem here.", "author": "nickibi", "createdAt": "2020-08-16T00:16:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0MDQyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0ODA4NQ==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r471048085", "bodyText": "I checked PegasusPlugin, we defined all the \"getDirectoryPath\" methods in this way, e.g pegasus, idl, snapshot etc. For coding style consistent purpose, I would prefer to leave it as-is. We may need to clean the code to use constants all over the places, that should be in a separate PR.", "author": "nickibi", "createdAt": "2020-08-16T00:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0MDQyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0MjI3NA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r471042274", "bodyText": "in gradle, copy and sync task are alike except sync will remove existing files in the destination dir.\nI think maybe in this we should use sync task instead of copy to remove existing data template to keep the destination dir clean?", "author": "BrianPin", "createdAt": "2020-08-15T23:04:43Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -1710,6 +1696,11 @@ protected GenerateDataTemplateTask configureDataTemplateGeneration(Project proje\n               copySpec.eachFile(fileCopyDetails ->\n                   fileCopyDetails.setPath(TRANSLATED_SCHEMAS_DIR + File.separatorChar + fileCopyDetails.getPath())));\n \n+          // Copy all extension schemas as-is into the root extensions directory in the JAR\n+          task.from(publishableExtensionSchemasBuildDir, copySpec ->", "originalCommit": "a927a2fa11fdec9076a0496be86cdb6880ca7b9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0NjQ2Mw==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r471046463", "bodyText": "I thought about removing schemas from destination dir. However, I think for debugging purpose, we should keep the schema in the build dir. So that we clearly know what has been packed in the data template jar.", "author": "nickibi", "createdAt": "2020-08-16T00:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTA0MjI3NA=="}], "type": "inlineReview"}, {"oid": "12d03d284e5a746c22a6fd6df14760d7f50d7a15", "url": "https://github.com/linkedin/rest.li/commit/12d03d284e5a746c22a6fd6df14760d7f50d7a15", "message": "Put extension schemas into the dataTemplate jar under /extensions path instead of putting them into the extensionSchema jar", "committedDate": "2020-08-16T21:58:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE2MzY0MA==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r471163640", "bodyText": "Do you think using this chance you can edit this comment to explain this configuration better? It doesn not look very intuitive to let the user know what classes should be added to this configuration and when they are used (one needs to check the code)", "author": "junchuanwang", "createdAt": "2020-08-16T21:57:13Z", "path": "gradle-plugins/src/main/java/com/linkedin/pegasus/gradle/PegasusPlugin.java", "diffHunk": "@@ -669,7 +671,7 @@ public void apply(Project project)\n     ConfigurationContainer configurations = project.getConfigurations();\n \n     // configuration for getting the required classes to make pegasus call main methods", "originalCommit": "a927a2fa11fdec9076a0496be86cdb6880ca7b9c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE2NDIyOQ==", "url": "https://github.com/linkedin/rest.li/pull/381#discussion_r471164229", "bodyText": "We agree with you the comment is not that intuitive. But it is out of scope of this change. We'd better address it in another PR.", "author": "nickibi", "createdAt": "2020-08-16T22:03:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTE2MzY0MA=="}], "type": "inlineReview"}, {"oid": "2e065b40253be5218caf93d40d86711ef4588172", "url": "https://github.com/linkedin/rest.li/commit/2e065b40253be5218caf93d40d86711ef4588172", "message": "Put extension schemas into the dataTemplate jar under /extensions path instead of putting them into the extensionSchema jar", "committedDate": "2020-08-16T22:31:06Z", "type": "forcePushed"}, {"oid": "63149513e904237b7ce027d4b65b7ecbb1177bef", "url": "https://github.com/linkedin/rest.li/commit/63149513e904237b7ce027d4b65b7ecbb1177bef", "message": "Put extension schemas into the dataTemplate jar under /extensions path instead of putting them into the extensionSchema jar", "committedDate": "2020-08-16T23:45:15Z", "type": "commit"}, {"oid": "63149513e904237b7ce027d4b65b7ecbb1177bef", "url": "https://github.com/linkedin/rest.li/commit/63149513e904237b7ce027d4b65b7ecbb1177bef", "message": "Put extension schemas into the dataTemplate jar under /extensions path instead of putting them into the extensionSchema jar", "committedDate": "2020-08-16T23:45:15Z", "type": "forcePushed"}]}