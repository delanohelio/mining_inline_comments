{"pr_number": 415, "pr_title": "Change D2 call to async in BackupRequestClient", "pr_createdAt": "2020-09-17T17:13:05Z", "pr_url": "https://github.com/linkedin/rest.li/pull/415", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MTAyMw==", "url": "https://github.com/linkedin/rest.li/pull/415#discussion_r490781023", "bodyText": "This is still calling the sync implementation, right?", "author": "ssheng", "createdAt": "2020-09-18T08:18:24Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/clients/BackupRequestsClient.java", "diffHunk": "@@ -195,24 +247,65 @@ public void restRequest(final RestRequest request, final RequestContext requestC\n    */\n   private void updateIfNeeded(String serviceName)\n   {\n-    List<Map<String, Object>> existing = _configs.get(serviceName);\n     try\n     {\n       ServiceProperties serviceProperties = _loadBalancer.getLoadBalancedServiceProperties(serviceName);", "originalCommit": "dae98b22b40b3e96eeb3f228b8c71d2422212c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA4NTY5OQ==", "url": "https://github.com/linkedin/rest.li/pull/415#discussion_r491085699", "bodyText": "I created another method updatedIfNeeded(serviceName, callback) and introduced a configuration. If async is enabled, this path won't be invoked, the async path will be invoked instead. I did not remove the blocking path in the code, the control is from the config.", "author": "rachelhanhan", "createdAt": "2020-09-18T17:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MTAyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzMxNjg3MQ==", "url": "https://github.com/linkedin/rest.li/pull/415#discussion_r493316871", "bodyText": "Got it.", "author": "ssheng", "createdAt": "2020-09-23T08:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MTAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMjc5MQ==", "url": "https://github.com/linkedin/rest.li/pull/415#discussion_r491202791", "bodyText": "We now have 2 copies of getStrategy (one sync one async) with almost identical functionality. Can we just keep the async one? You can always wait the results if sync operation is needed.\nIf necessary, just keep requestAsync and let request to call into requestAsync.", "author": "cx-super", "createdAt": "2020-09-18T21:40:50Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/clients/BackupRequestsClient.java", "diffHunk": "@@ -195,24 +247,65 @@ public void restRequest(final RestRequest request, final RequestContext requestC\n    */\n   private void updateIfNeeded(String serviceName)\n   {\n-    List<Map<String, Object>> existing = _configs.get(serviceName);\n     try\n     {\n       ServiceProperties serviceProperties = _loadBalancer.getLoadBalancedServiceProperties(serviceName);\n-      if (serviceProperties != null)\n-      {\n-        if (existing != serviceProperties.getBackupRequests())\n-        { // reference inequality check\n-          update(serviceName, serviceProperties.getBackupRequests());\n-          _configs.put(serviceName, serviceProperties.getBackupRequests());\n-        }\n-      }\n-    } catch (ServiceUnavailableException e)\n+      updateServiceProperties(serviceName, serviceProperties);\n+    }\n+    catch (ServiceUnavailableException e)\n     {\n       LOG.debug(\"Failed to fetch backup requests strategy \", e);\n     }\n   }\n \n+  private void updateServiceProperties(String serviceName, ServiceProperties serviceProperties)\n+  {\n+    List<Map<String, Object>> existing = _configs.get(serviceName);\n+    if (serviceProperties != null)\n+    {\n+      if (existing != serviceProperties.getBackupRequests())\n+      { // reference inequality check\n+        update(serviceName, serviceProperties.getBackupRequests());\n+        _configs.put(serviceName, serviceProperties.getBackupRequests());\n+      }\n+    }\n+  }\n+\n+  void getStrategy(final String serviceName, final String operation, Callback<Optional<TrackingBackupRequestsStrategy>> callback) {", "originalCommit": "dae98b22b40b3e96eeb3f228b8c71d2422212c42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTI0MjY5Nw==", "url": "https://github.com/linkedin/rest.li/pull/415#discussion_r491242697", "bodyText": "I refactored the code a little bit more for better readability. Yes I have 2 copies of the same logic, because I want to be more cautious and reduce the risk. Most of the common logics have been extracted from the 2 copies though. When we want to clean up the blocking call later, it should be fairly easy to clean them up", "author": "rachelhanhan", "createdAt": "2020-09-19T00:20:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMjc5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTIwMzA5Nw==", "url": "https://github.com/linkedin/rest.li/pull/415#discussion_r491203097", "bodyText": "Ditto -- prefer to have one implementation.", "author": "cx-super", "createdAt": "2020-09-18T21:41:41Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/clients/BackupRequestsClient.java", "diffHunk": "@@ -195,24 +247,65 @@ public void restRequest(final RestRequest request, final RequestContext requestC\n    */\n   private void updateIfNeeded(String serviceName)\n   {\n-    List<Map<String, Object>> existing = _configs.get(serviceName);\n     try\n     {\n       ServiceProperties serviceProperties = _loadBalancer.getLoadBalancedServiceProperties(serviceName);\n-      if (serviceProperties != null)\n-      {\n-        if (existing != serviceProperties.getBackupRequests())\n-        { // reference inequality check\n-          update(serviceName, serviceProperties.getBackupRequests());\n-          _configs.put(serviceName, serviceProperties.getBackupRequests());\n-        }\n-      }\n-    } catch (ServiceUnavailableException e)\n+      updateServiceProperties(serviceName, serviceProperties);\n+    }\n+    catch (ServiceUnavailableException e)\n     {\n       LOG.debug(\"Failed to fetch backup requests strategy \", e);\n     }\n   }\n \n+  private void updateServiceProperties(String serviceName, ServiceProperties serviceProperties)\n+  {\n+    List<Map<String, Object>> existing = _configs.get(serviceName);\n+    if (serviceProperties != null)\n+    {\n+      if (existing != serviceProperties.getBackupRequests())\n+      { // reference inequality check\n+        update(serviceName, serviceProperties.getBackupRequests());\n+        _configs.put(serviceName, serviceProperties.getBackupRequests());\n+      }\n+    }\n+  }\n+\n+  void getStrategy(final String serviceName, final String operation, Callback<Optional<TrackingBackupRequestsStrategy>> callback) {\n+    Callback<None> updatePropertiesCallback = new Callback<None>() {\n+      @Override\n+      public void onError(Throwable e) {\n+        callback.onError(e);\n+      }\n+\n+      @Override\n+      public void onSuccess(None result) {\n+        callback.onSuccess(getStrategyAfterUpdate(serviceName, operation));\n+      }\n+    };\n+\n+    updateIfNeeded(serviceName, updatePropertiesCallback);\n+  }\n+\n+  private void updateIfNeeded(String serviceName, Callback<None> callback)", "originalCommit": "dae98b22b40b3e96eeb3f228b8c71d2422212c42", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d74d042d80119d6bbeb213ee8d46b9337856ece", "url": "https://github.com/linkedin/rest.li/commit/3d74d042d80119d6bbeb213ee8d46b9337856ece", "message": "Change D2 call to async in BackupRequestClient", "committedDate": "2020-09-19T00:10:41Z", "type": "commit"}, {"oid": "760deb3230fe1162133259a07b034395172348ef", "url": "https://github.com/linkedin/rest.li/commit/760deb3230fe1162133259a07b034395172348ef", "message": "Remove unnecessary import", "committedDate": "2020-09-19T00:10:41Z", "type": "commit"}, {"oid": "ab26d55597bd7f2c4eb8661507419293e11d9ec4", "url": "https://github.com/linkedin/rest.li/commit/ab26d55597bd7f2c4eb8661507419293e11d9ec4", "message": "Refactor code for better readability", "committedDate": "2020-09-19T00:13:05Z", "type": "commit"}, {"oid": "ab26d55597bd7f2c4eb8661507419293e11d9ec4", "url": "https://github.com/linkedin/rest.li/commit/ab26d55597bd7f2c4eb8661507419293e11d9ec4", "message": "Refactor code for better readability", "committedDate": "2020-09-19T00:13:05Z", "type": "forcePushed"}, {"oid": "abe40016f70cfacc9c07b240dccdef7a24ae804a", "url": "https://github.com/linkedin/rest.li/commit/abe40016f70cfacc9c07b240dccdef7a24ae804a", "message": "Add single retry for a flaky test", "committedDate": "2020-09-21T17:42:13Z", "type": "commit"}]}