{"pr_number": 299, "pr_title": "Implement Host Override List feature in D2.", "pr_createdAt": "2020-05-18T08:35:37Z", "pr_url": "https://github.com/linkedin/rest.li/pull/299", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgxNTY1NA==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426815654", "bodyText": "Eventhough TargetService hint is deprecated - should we include that int he debug (Host override/TargetService Hint found) until we completely remove the TargetService?", "author": "nizarm", "createdAt": "2020-05-18T18:26:20Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/simple/SimpleLoadBalancer.java", "diffHunk": "@@ -201,16 +210,17 @@ public void getClient(Request request, RequestContext requestContext, Callback<T\n         }\n         else\n         {\n-          _log.debug(\"service hint found, using generic client for target: {}\", targetService);\n-\n-          TransportClient transportClient = _state.getClient(serviceName, targetService.getScheme());\n+          URI target = override == null ? targetService : URI.create(override + service.getPath());\n+          _log.debug(\"Host override found, using generic client for target: {}\", target);", "originalCommit": "63e7e0b8fc42d131f608696637112887c49f5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEyOTg1OA==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427129858", "bodyText": "Added as suggested.", "author": "ssheng", "createdAt": "2020-05-19T08:40:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgxNTY1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgxNjE3OA==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426816178", "bodyText": "Ditto - should we include TargetService in the error until we completely remove the TargetHost?", "author": "nizarm", "createdAt": "2020-05-18T18:27:25Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/simple/SimpleLoadBalancer.java", "diffHunk": "@@ -201,16 +210,17 @@ public void getClient(Request request, RequestContext requestContext, Callback<T\n         }\n         else\n         {\n-          _log.debug(\"service hint found, using generic client for target: {}\", targetService);\n-\n-          TransportClient transportClient = _state.getClient(serviceName, targetService.getScheme());\n+          URI target = override == null ? targetService : URI.create(override + service.getPath());\n+          _log.debug(\"Host override found, using generic client for target: {}\", target);\n+          TransportClient transportClient = _state.getClient(serviceName, target.getScheme());\n           if (transportClient == null)\n           {\n             throw new ServiceUnavailableException(serviceName,\n-                \"PEGA_1001. Cannot find transportClient for service \" + serviceName + \" and scheme: \" + targetService.getScheme()\n-                    + \" with service hint\" + targetService);\n+                \"PEGA_1001. Cannot find transportClient for service \" + serviceName + \" and scheme: \" + target.getScheme()\n+                    + \" with host override \" + target);", "originalCommit": "63e7e0b8fc42d131f608696637112887c49f5fd7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMDI0MQ==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426820241", "bodyText": "Do we need to make sure override variable ends with '/' here, to make sure that servicepath is added as a proper suffix?", "author": "nizarm", "createdAt": "2020-05-18T18:35:38Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/simple/SimpleLoadBalancer.java", "diffHunk": "@@ -201,16 +210,17 @@ public void getClient(Request request, RequestContext requestContext, Callback<T\n         }\n         else\n         {\n-          _log.debug(\"service hint found, using generic client for target: {}\", targetService);\n-\n-          TransportClient transportClient = _state.getClient(serviceName, targetService.getScheme());\n+          URI target = override == null ? targetService : URI.create(override + service.getPath());", "originalCommit": "63e7e0b8fc42d131f608696637112887c49f5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MTY0OQ==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426891649", "bodyText": "Given that override takes precedence, and there are many applications use targetService for now, we probably want to log a warning message here if both present?", "author": "cx-super", "createdAt": "2020-05-18T21:02:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMDI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExMDIxMg==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427110212", "bodyText": "@nizarm's question, unit test shows that we don't have to. I will add another test to test with a '/' at the end.\n@ChaoLinkedIn, I'll address this comment in the comment below.", "author": "ssheng", "createdAt": "2020-05-19T08:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMDI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1MDk1Mg==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427550952", "bodyText": "thanks", "author": "nizarm", "createdAt": "2020-05-19T19:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyMDI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzMjA2OQ==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426832069", "bodyText": "if (this.equals(WILDCARD_KEY)) {\n return true;\n}\n?", "author": "nizarm", "createdAt": "2020-05-18T18:58:29Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/util/HostOverrideList.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.d2.balancer.util;\n+\n+import com.linkedin.util.ArgumentUtil;\n+import java.net.URI;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+\n+/**\n+ * Stores the list of host overrides for cluster and services. The order of the overrides are stored in the same\n+ * order as the additions. Checks for the first match and return the overridden {@link URI}.\n+ */\n+public class HostOverrideList\n+{\n+  private Map<Key, URI> _overrides = new LinkedHashMap<>();\n+\n+  public void addClusterOverride(String cluster, URI uri) {\n+    ArgumentUtil.notNull(cluster, \"cluster\");\n+    ArgumentUtil.notNull(uri, \"uri\");\n+    _overrides.put(new Key(cluster, null), uri);\n+  }\n+\n+  public void addServiceOverride(String service, URI uri) {\n+    ArgumentUtil.notNull(service, \"service\");\n+    ArgumentUtil.notNull(uri, \"uri\");\n+    _overrides.put(new Key(null, service), uri);\n+  }\n+\n+  public void addOverride(URI uri) {\n+    ArgumentUtil.notNull(uri, \"uri\");\n+    _overrides.put(Key.WILDCARD_KEY, uri);\n+  }\n+\n+  /**\n+   * Gets the overridden URI for the given cluster and service.\n+   * @param cluster Cluster name of the override.\n+   * @param service Service name of the override.\n+   * @return The overridden URI for the given cluster and service; {@code null} otherwise.\n+   */\n+  public URI getOverride(String cluster, String service)\n+  {\n+    for (Map.Entry<Key, URI> override : _overrides.entrySet())\n+    {\n+      if (override.getKey().match(cluster, service)) {\n+        return override.getValue();\n+      }\n+    }\n+    return null;\n+  }\n+\n+  /**\n+   * Key implementation of the override map. Key includes a cluster and a service name. If either cluster or\n+   * service is {@code null}, then the null cluster or service is treated as a wildcard.\n+   */\n+  private static class Key {\n+    private static final Key WILDCARD_KEY = new Key(null, null);\n+    private final String _cluster;\n+    private final String _service;\n+\n+    public Key(String cluster, String service) {\n+      _cluster = cluster;\n+      _service = service;\n+    }\n+\n+    /**\n+     * Checks if the provided cluster and service names match this key.\n+     * @param cluster Cluster name to check against.\n+     * @param service Service name to check against.\n+     * @return {@code True} if provided cluster and service name match the key; {@code false} otherwise.\n+     */\n+    public boolean match(String cluster, String service) {\n+      if (_cluster == null && _service == null) {\n+        return true;\n+      }", "originalCommit": "63e7e0b8fc42d131f608696637112887c49f5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwNjM5NQ==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427106395", "bodyText": "Better, I think we can just use ==.", "author": "ssheng", "createdAt": "2020-05-19T08:03:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzMjA2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3NzY1OQ==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426877659", "bodyText": "Can we also have a test with override value with an ending slash URI.create(\"http://override/path/\")", "author": "nizarm", "createdAt": "2020-05-18T20:32:44Z", "path": "d2/src/test/java/com/linkedin/d2/balancer/simple/SimpleLoadBalancerTest.java", "diffHunk": "@@ -623,6 +626,113 @@ public void testGetClient() throws Exception\n     loadBalancer.getClient(uriRequest, requestContextWithHint);\n   }\n \n+  /**\n+   * Tests getClient() when with host override list specified in the request context.\n+   * @throws Exception\n+   */\n+  @Test\n+  public void testGetClientHostOverrideList() throws Exception\n+  {\n+    Map<String, LoadBalancerStrategyFactory<? extends LoadBalancerStrategy>> loadBalancerStrategyFactories =\n+        new HashMap<>();\n+    Map<String, TransportClientFactory> clientFactories = new HashMap<>();\n+    List<String> prioritizedSchemes = new ArrayList<>();\n+\n+    MockStore<ServiceProperties> serviceRegistry = new MockStore<>();\n+    MockStore<ClusterProperties> clusterRegistry = new MockStore<>();\n+    MockStore<UriProperties> uriRegistry = new MockStore<>();\n+\n+    ScheduledExecutorService executorService = new SynchronousExecutorService();\n+\n+    loadBalancerStrategyFactories.put(\"degrader\", new DegraderLoadBalancerStrategyFactoryV3());\n+    clientFactories.put(PropertyKeys.HTTP_SCHEME, new DoNothingClientFactory());\n+\n+    SimpleLoadBalancerState state =\n+        new SimpleLoadBalancerState(executorService,\n+            uriRegistry,\n+            clusterRegistry,\n+            serviceRegistry,\n+            clientFactories,\n+            loadBalancerStrategyFactories);\n+\n+    SimpleLoadBalancer loadBalancer =\n+        new SimpleLoadBalancer(state, 5, TimeUnit.SECONDS, _d2Executor);\n+\n+    FutureCallback<None> balancerCallback = new FutureCallback<None>();\n+    loadBalancer.start(balancerCallback);\n+    balancerCallback.get();\n+\n+    Map<Integer, PartitionData> partitionData = new HashMap<Integer, PartitionData>(1);\n+    partitionData.put(DEFAULT_PARTITION_ID, new PartitionData(1d));\n+    Map<URI, Map<Integer, PartitionData>> uriData = new HashMap<URI, Map<Integer, PartitionData>>(2);\n+    uriData.put(URI.create(\"http://host1/path\"), partitionData);\n+\n+    prioritizedSchemes.add(PropertyKeys.HTTP_SCHEME);\n+\n+    String cluster1 = \"Cluster1\";\n+    String cluster2 = \"Cluster2\";\n+    String service1 = \"service1\";\n+    String service2 = \"service2\";\n+\n+    clusterRegistry.put(cluster1, new ClusterProperties(cluster1, Collections.emptyList(),\n+        Collections.emptyMap(), new HashSet<>(), NullPartitionProperties.getInstance()));\n+\n+    serviceRegistry.put(service1, new ServiceProperties(service1,\n+        cluster1,\n+        \"/service1Path\",\n+        Arrays.asList(\"degrader\"),\n+        Collections.<String,Object>emptyMap(),\n+        null,\n+        null,\n+        prioritizedSchemes,\n+        null));\n+    uriRegistry.put(cluster1, new UriProperties(cluster1, uriData));\n+\n+    URI override = URI.create(\"http://override/path\");", "originalCommit": "63e7e0b8fc42d131f608696637112887c49f5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzExODYyMQ==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427118621", "bodyText": "Turned out the implementation is quite fragile that adding a suffix '' will break the behavior. Given that the normal D2 path leverages the same concatenation. I recommend that we fix that all together in a different PR.", "author": "ssheng", "createdAt": "2020-05-19T08:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3NzY1OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU1NTQyMw==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427555423", "bodyText": "sure", "author": "nizarm", "createdAt": "2020-05-19T19:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg3NzY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MTg5Ng==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426891896", "bodyText": "HostOverrides or HostOverriders?", "author": "cx-super", "createdAt": "2020-05-18T21:03:27Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/util/HostOverrideList.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.d2.balancer.util;\n+\n+import com.linkedin.util.ArgumentUtil;\n+import java.net.URI;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+\n+/**\n+ * Stores the list of host overrides for cluster and services. The order of the overrides are stored in the same\n+ * order as the additions. Checks for the first match and return the overridden {@link URI}.\n+ */\n+public class HostOverrideList", "originalCommit": "63e7e0b8fc42d131f608696637112887c49f5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3NTQ5MA==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427075490", "bodyText": "I wanted the word list to imply order of override. HostOverrides is fine, too, if you feel strong about the naming.", "author": "ssheng", "createdAt": "2020-05-19T07:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MTg5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MzQ5NA==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r426893494", "bodyText": "Since the overrides could be supplied by different app, what if there are conflicts?", "author": "cx-super", "createdAt": "2020-05-18T21:07:08Z", "path": "d2/src/main/java/com/linkedin/d2/balancer/util/HostOverrideList.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+   Copyright (c) 2020 LinkedIn Corp.\n+\n+   Licensed under the Apache License, Version 2.0 (the \"License\");\n+   you may not use this file except in compliance with the License.\n+   You may obtain a copy of the License at\n+\n+       http://www.apache.org/licenses/LICENSE-2.0\n+\n+   Unless required by applicable law or agreed to in writing, software\n+   distributed under the License is distributed on an \"AS IS\" BASIS,\n+   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+   See the License for the specific language governing permissions and\n+   limitations under the License.\n+*/\n+\n+package com.linkedin.d2.balancer.util;\n+\n+import com.linkedin.util.ArgumentUtil;\n+import java.net.URI;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+\n+/**\n+ * Stores the list of host overrides for cluster and services. The order of the overrides are stored in the same\n+ * order as the additions. Checks for the first match and return the overridden {@link URI}.\n+ */\n+public class HostOverrideList\n+{\n+  private Map<Key, URI> _overrides = new LinkedHashMap<>();\n+\n+  public void addClusterOverride(String cluster, URI uri) {\n+    ArgumentUtil.notNull(cluster, \"cluster\");\n+    ArgumentUtil.notNull(uri, \"uri\");\n+    _overrides.put(new Key(cluster, null), uri);", "originalCommit": "63e7e0b8fc42d131f608696637112887c49f5fd7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3NzU2MA==", "url": "https://github.com/linkedin/rest.li/pull/299#discussion_r427077560", "bodyText": "It won't be supplied by different apps since only the current app can add the override. However, it may be supplied by different places in the code. A solution I can think of is having a state of the list such that the first caller can add to the list and seal the list. The second caller will receive an exception adding to a sealed list. Another option is to expose the list contents to the caller so they can decide where to add the override. I don't particularly like either one as both add significant complexity to the logic.", "author": "ssheng", "createdAt": "2020-05-19T07:11:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MzQ5NA=="}], "type": "inlineReview"}, {"oid": "391d0d98947fadeddcdb60e092f29b5d40d84024", "url": "https://github.com/linkedin/rest.li/commit/391d0d98947fadeddcdb60e092f29b5d40d84024", "message": "Implement Host Override List feature in D2.\n\nRequirements\n\nTo support features like Fullstack Hovr, D2 needs to support the following routing override scenarios.\n  1. Route requests going to a given cluster to a specific host.\n  2. Route requests going to a given service to a specific host.\n  3. Provide route overrides for multiple clusters and services.\n\nD2 provides an existing override mechanism called TargetHints. However, TargetHints does not meet the above requirements due to the following restrictions.\nTargetHints does not allow multiple overrides for different clusters and services.\nTargetHints requires users to provide a full URL as opposed to a URL prefix like the D2 announcer. Therefore, we lose the flexibility of appending the service paths for different D2 services.\n\nImplementation\nSimilar to TargetHints, HostOverrideList is also specified and passed through the RequestContext. HostOverrideList allows the user to add an arbitrary number of overrides for different clusters and services. When the request gets to the SimpleLoadBalancer, the implementation will look for the first matching override for the current cluster and service names. The request URI will be rewritten to be the override URI provided.\n  1. hostOverrideList.addClusterOverride(\u201cCluster1\u201d, \u201chttps://host:8080/context/\u201d);\n  2. hostOverrideList.addServiceOverride(\u201cService1\u201d, \u201chttps://host:8080/context/\u201d);\n\nThe provided override URI is a prefix, similar to the announced URI, as opposed to a full URI in the TargetHints mechanism. The service path will be appended to the end of the URI by the SimpleLoadBalancer when the request URI is rewritten. In the above examples, the written URI will be \u201chttps://host:8080/context/service1path\u201d.\n\nTargetHints mechanism will be deprecated. To achieve the original TargetHints behavior, one can add generic override without providing a cluster or service name.\nhostOverrideList.addOverride(\u201chttps://host:8080/context/\u201d);\n\nAddressed Chao and Nizar's comments", "committedDate": "2020-05-20T06:25:07Z", "type": "commit"}, {"oid": "bb27006f7ba5342fc8eafe3b9653ecd6eb80504a", "url": "https://github.com/linkedin/rest.li/commit/bb27006f7ba5342fc8eafe3b9653ecd6eb80504a", "message": "Release version 29.0.1", "committedDate": "2020-05-20T06:28:37Z", "type": "commit"}, {"oid": "bb27006f7ba5342fc8eafe3b9653ecd6eb80504a", "url": "https://github.com/linkedin/rest.li/commit/bb27006f7ba5342fc8eafe3b9653ecd6eb80504a", "message": "Release version 29.0.1", "committedDate": "2020-05-20T06:28:37Z", "type": "forcePushed"}]}