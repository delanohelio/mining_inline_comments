{"pr_number": 3702, "pr_title": "fix: Fix Sniper printer failing to put added import statement on separate line", "pr_createdAt": "2020-11-17T07:42:03Z", "pr_url": "https://github.com/INRIA/spoon/pull/3702", "timeline": [{"oid": "c704a525ac248f510dedcbdea34d442bd9f50904", "url": "https://github.com/INRIA/spoon/commit/c704a525ac248f510dedcbdea34d442bd9f50904", "message": "Add test case to reproduce missing newline issue", "committedDate": "2020-11-17T07:39:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDkzOTYzNg==", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r524939636", "bodyText": "Removed as it interfered with my test case (removed unused imports), and no other test cases actually rely on this functionality. Very unclear why it's here.", "author": "slarse", "createdAt": "2020-11-17T07:42:56Z", "path": "src/test/java/spoon/test/prettyprinter/TestSniperPrinter.java", "diffHunk": "@@ -398,16 +418,7 @@ private void testSniper(String testClass, Consumer<CtType<?>> transformation, Bi\n \tprivate static Launcher createLauncherWithSniperPrinter() {\n \t\tLauncher launcher = new Launcher();\n \t\tlauncher.getEnvironment().setPrettyPrinterCreator(() -> {\n-\t\t\tSniperJavaPrettyPrinter printer = new SniperJavaPrettyPrinter(launcher.getEnvironment());\n-\t\t\tprinter.setPreprocessors(Collections.unmodifiableList(Arrays.<Processor<CtElement>>asList(\n-\t\t\t\t\t//remove unused imports first. Do not add new imports at time when conflicts are not resolved\n-\t\t\t\t\tnew ImportCleaner().setCanAddImports(false),\n-\t\t\t\t\t//solve conflicts, the current imports are relevant too\n-\t\t\t\t\tnew ImportConflictDetector(),\n-\t\t\t\t\t//compute final imports\n-\t\t\t\t\tnew ImportCleaner()\n-\t\t\t)));\n-\t\t\treturn printer;", "originalCommit": "c704a525ac248f510dedcbdea34d442bd9f50904", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "41233be4e25df6ccd4016be3eb6c9c5f0afefecc", "url": "https://github.com/INRIA/spoon/commit/41233be4e25df6ccd4016be3eb6c9c5f0afefecc", "message": "Fix missing newline problem with special case\n\nI'm not satisfied with this solution, there should be a more general solution", "committedDate": "2020-11-17T08:03:21Z", "type": "commit"}, {"oid": "b9328914812e0c9790341d8008b655faedf45b00", "url": "https://github.com/INRIA/spoon/commit/b9328914812e0c9790341d8008b655faedf45b00", "message": "Replace spaces with tabs", "committedDate": "2020-11-17T14:01:58Z", "type": "commit"}, {"oid": "2b1a51fdc1ee2d5852f9fb9c823104e83415f992", "url": "https://github.com/INRIA/spoon/commit/2b1a51fdc1ee2d5852f9fb9c823104e83415f992", "message": "Add test of adding import statement in file with package statement", "committedDate": "2020-11-18T15:13:19Z", "type": "commit"}, {"oid": "8f86367a0b705d673305635205343efa645bf2e3", "url": "https://github.com/INRIA/spoon/commit/8f86367a0b705d673305635205343efa645bf2e3", "message": "Strengthen tests with precondition checks on package", "committedDate": "2020-11-18T15:21:28Z", "type": "commit"}, {"oid": "66ead04815ca599c1f0d8ae182518eb27de2a7af", "url": "https://github.com/INRIA/spoon/commit/66ead04815ca599c1f0d8ae182518eb27de2a7af", "message": "Remove redundant newline", "committedDate": "2020-11-18T15:21:54Z", "type": "commit"}, {"oid": "e670936daa39bf8a5fb4dd748f66b3b36765704c", "url": "https://github.com/INRIA/spoon/commit/e670936daa39bf8a5fb4dd748f66b3b36765704c", "message": "Implement better fix for missing newline between import statements", "committedDate": "2020-11-19T13:30:06Z", "type": "commit"}, {"oid": "889976972eaccbad74867bea8867e773222c7313", "url": "https://github.com/INRIA/spoon/commit/889976972eaccbad74867bea8867e773222c7313", "message": "Fix problem with missing newline after package statement", "committedDate": "2020-11-19T13:47:33Z", "type": "commit"}, {"oid": "84c84e16163ff18611f82c69d5246d642e3fed86", "url": "https://github.com/INRIA/spoon/commit/84c84e16163ff18611f82c69d5246d642e3fed86", "message": "Guard against the package being null", "committedDate": "2020-11-19T14:06:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzMjI4Mw==", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526932283", "bodyText": "This is the only difference here, the rest is just indentation. In combination with the fix in visitCtPackageDeclaration, this fixes newlines after package declarations in the sniper printer.", "author": "slarse", "createdAt": "2020-11-19T14:32:49Z", "path": "src/main/java/spoon/reflect/visitor/DefaultJavaPrettyPrinter.java", "diffHunk": "@@ -1084,14 +1084,20 @@ public void visitCtCompilationUnit(CtCompilationUnit compilationUnit) {\n \t\t\t\t//note: the package-info.java may contain type declarations too\n \t\t\tbreak;\n \t\tcase TYPE_DECLARATION:\n-\t\t\t\tscan(compilationUnit.getPackageDeclaration());\n-\t\t\t\tfor (CtImport imprt : getImports(compilationUnit)) {\n-\t\t\t\t\tscan(imprt);\n-\t\t\t\t\tprinter.writeln();\n-\t\t\t\t}\n-\t\t\t\tfor (CtType<?> t : compilationUnit.getDeclaredTypes()) {\n-\t\t\t\t\tscan(t);\n-\t\t\t\t}\n+\t\t\tscan(compilationUnit.getPackageDeclaration());\n+\n+\t\t\tCtPackage pkg = compilationUnit.getDeclaredPackage();\n+\t\t\tif (pkg != null && !pkg.isUnnamedPackage()) {\n+\t\t\t\tprinter.writeln();\n+\t\t\t}", "originalCommit": "84c84e16163ff18611f82c69d5246d642e3fed86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzMjk0MA==", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526932940", "bodyText": "This is the \"fix in visitCtPackageDeclaration\" I mention.", "author": "slarse", "createdAt": "2020-11-19T14:33:43Z", "path": "src/main/java/spoon/reflect/visitor/DefaultJavaPrettyPrinter.java", "diffHunk": "@@ -1111,7 +1117,7 @@ public void visitCtPackageDeclaration(CtPackageDeclaration packageDeclaration) {\n \t\tCtPackageReference ctPackage = packageDeclaration.getReference();\n \t\telementPrinterHelper.writeComment(ctPackage, CommentOffset.BEFORE);\n \t\tif (!ctPackage.isUnnamedPackage()) {\n-\t\t\telementPrinterHelper.writePackageLine(ctPackage.getQualifiedName());\n+\t\t\telementPrinterHelper.writePackageStatement(ctPackage.getQualifiedName());", "originalCommit": "84c84e16163ff18611f82c69d5246d642e3fed86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzMzc2MA==", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526933760", "bodyText": "This is the special handling of the first import statement. We may need to add more roles here as more problems crop up. Using only the condition fragmentIndex == 0 causes unwanted newlines in if/else statements, and perhaps elsewhere as well.", "author": "slarse", "createdAt": "2020-11-19T14:34:45Z", "path": "src/main/java/spoon/support/sniper/internal/AbstractSourceFragmentPrinter.java", "diffHunk": "@@ -102,6 +102,11 @@ public int update(PrinterEvent event) {\n \t\t\t//so skip printing of this comment\n \t\t\t//comment will be printed at place where it belongs to - together with spaces\n \t\t\treturn -1;\n+\t\t} else if (event.getRole() == CtRole.DECLARED_IMPORT && fragmentIndex == 0) {\n+\t\t\t// this is the first pre-existing import statement, and so we must print all newline\n+\t\t\t// events unconditionally to avoid placing it on the same line as a newly added import\n+\t\t\t// statement. See PR #3702 for details\n+\t\t\tprintStandardSpaces();", "originalCommit": "84c84e16163ff18611f82c69d5246d642e3fed86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjkzNDczMw==", "url": "https://github.com/INRIA/spoon/pull/3702#discussion_r526934733", "bodyText": "Here, I've added the method writePackageStatement, as I did not want to break the previous API by modifying writePackageLine.", "author": "slarse", "createdAt": "2020-11-19T14:35:59Z", "path": "src/main/java/spoon/reflect/visitor/ElementPrinterHelper.java", "diffHunk": "@@ -348,9 +348,20 @@ public void writeImports(Collection<CtImport> imports) {\n \t\t}\n \t}\n \n+\t/**\n+\t * Write a package statement and a newline.\n+\t */\n \tpublic void writePackageLine(String packageQualifiedName) {\n+\t\twritePackageStatement(packageQualifiedName);\n+\t\tprinter.writeln();\n+\t}\n+\n+\t/**\n+\t * Write a package statement.\n+\t */\n+\tpublic void writePackageStatement(String packageQualifiedName) {\n \t\tprinter.writeKeyword(\"package\").writeSpace();\n-\t\twriteQualifiedName(packageQualifiedName).writeSeparator(\";\").writeln();\n+\t\twriteQualifiedName(packageQualifiedName).writeSeparator(\";\");", "originalCommit": "84c84e16163ff18611f82c69d5246d642e3fed86", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}