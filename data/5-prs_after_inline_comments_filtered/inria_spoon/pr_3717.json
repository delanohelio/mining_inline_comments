{"pr_number": 3717, "pr_title": "review: feat: Make sniper printer infer indentation style of compilation unit", "pr_createdAt": "2020-12-03T10:39:04Z", "pr_url": "https://github.com/INRIA/spoon/pull/3717", "timeline": [{"oid": "90a6836ba0f4fdb6cb894322e9a84e74e595f666", "url": "https://github.com/INRIA/spoon/commit/90a6836ba0f4fdb6cb894322e9a84e74e595f666", "message": "Add indentation test case", "committedDate": "2020-12-03T07:26:48Z", "type": "commit"}, {"oid": "d440fcab581e3bb0d4e012f1d308f01b2ef60009", "url": "https://github.com/INRIA/spoon/commit/d440fcab581e3bb0d4e012f1d308f01b2ef60009", "message": "Implement indentation detection", "committedDate": "2020-12-03T10:09:15Z", "type": "commit"}, {"oid": "e69e86129d35230f255de1c2c76bce192e25c99d", "url": "https://github.com/INRIA/spoon/commit/e69e86129d35230f255de1c2c76bce192e25c99d", "message": "Refactor indentation detection", "committedDate": "2020-12-03T10:14:26Z", "type": "commit"}, {"oid": "62d8e113f35992e5e75edb9c96848ed9c3077898", "url": "https://github.com/INRIA/spoon/commit/62d8e113f35992e5e75edb9c96848ed9c3077898", "message": "Move indentation detection to a separate class", "committedDate": "2020-12-03T10:19:29Z", "type": "commit"}, {"oid": "94950414dc53ecac49aec513f11ebbf809d147b6", "url": "https://github.com/INRIA/spoon/commit/94950414dc53ecac49aec513f11ebbf809d147b6", "message": "Define default to be 1 tabs", "committedDate": "2020-12-03T10:36:03Z", "type": "commit"}, {"oid": "34d3ca3e6c1d355dcb03bcf6d1df49f7680aa714", "url": "https://github.com/INRIA/spoon/commit/34d3ca3e6c1d355dcb03bcf6d1df49f7680aa714", "message": "Fix checkstyle errors", "committedDate": "2020-12-03T10:37:58Z", "type": "commit"}, {"oid": "1a7ab79de27d28064aedeab519e08c20d43616b3", "url": "https://github.com/INRIA/spoon/commit/1a7ab79de27d28064aedeab519e08c20d43616b3", "message": "Document setters", "committedDate": "2020-12-03T10:45:58Z", "type": "commit"}, {"oid": "5fb75311858daa6e817c520a27ab653c12810ac8", "url": "https://github.com/INRIA/spoon/commit/5fb75311858daa6e817c520a27ab653c12810ac8", "message": "Add a couple of blank lines for readability", "committedDate": "2020-12-03T11:57:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE2Nzg0NQ==", "url": "https://github.com/INRIA/spoon/pull/3717#discussion_r535167845", "bodyText": "This is the actual thing that overrides the printing of tabs with whatever indentation style is present in the source file. I'm not completely satisfied with this solution as it seems a bit hacky, but I couldn't figure out a better way to do it. Suggestions are welcome.", "author": "slarse", "createdAt": "2020-12-03T12:04:50Z", "path": "src/main/java/spoon/support/sniper/internal/MutableTokenWriter.java", "diffHunk": "@@ -22,8 +22,38 @@\n \tprivate final TokenWriter delegate;\n \tprivate boolean muted = false;\n \n+\t// indentation style to use for new elements\n+\tprivate boolean originSourceUsesTabulations;\n+\tprivate int originSourceTabulationSize;\n+\n \tpublic MutableTokenWriter(Environment env) {\n-\t\tthis.delegate = new DefaultTokenWriter(new PrinterHelper(env));\n+\t\tthis.delegate = new DefaultTokenWriter(new SniperPrinterHelper(env));\n+\t\toriginSourceUsesTabulations = true;\n+\t\toriginSourceTabulationSize = 1;\n+\t}\n+\n+\tprivate class SniperPrinterHelper extends PrinterHelper {\n+\t\tprivate final Environment env;\n+\n+\t\tSniperPrinterHelper(Environment env) {\n+\t\t\tsuper(env);\n+\t\t\tthis.env = env;\n+\t\t}\n+\n+\t\t/**\n+\t\t * We override this method to use the correct style of indentation for new elements.\n+\t\t */\n+\t\t@Override\n+\t\tprotected void autoWriteTabs() {\n+\t\t\tint setTabulationSize = env.getTabulationSize();\n+\t\t\tenv.useTabulations(originSourceUsesTabulations);\n+\t\t\tenv.setTabulationSize(originSourceTabulationSize);\n+\n+\t\t\tsuper.autoWriteTabs();\n+\n+\t\t\tenv.setTabulationSize(setTabulationSize);\n+\t\t\tenv.useTabulations(true);\n+\t\t}", "originalCommit": "5fb75311858daa6e817c520a27ab653c12810ac8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE3Nzc4OQ==", "url": "https://github.com/INRIA/spoon/pull/3717#discussion_r535177789", "bodyText": "The token writer is updated with indentation style for each CU to be printed.", "author": "slarse", "createdAt": "2020-12-03T12:14:45Z", "path": "src/main/java/spoon/support/sniper/SniperJavaPrettyPrinter.java", "diffHunk": "@@ -132,6 +134,12 @@ public void calculate(CtCompilationUnit compilationUnit, List<CtType<?>> types)\n \n \t\t//use line separator of origin source file\n \t\tsetLineSeparator(detectLineSeparator(compilationUnit.getOriginalSourceCode()));\n+\n+\t\t// use indentation style of origin source file for new elements\n+\t\tPair<Integer, Boolean> indentationInfo = IndentationDetector.detectIndentation(compilationUnit);\n+\t\tmutableTokenWriter.setOriginSourceTabulationSize(indentationInfo.getLeft());\n+\t\tmutableTokenWriter.setOriginSourceUsesTabulations(indentationInfo.getRight());", "originalCommit": "5fb75311858daa6e817c520a27ab653c12810ac8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkzNjk4OQ==", "url": "https://github.com/INRIA/spoon/pull/3717#discussion_r535936989", "bodyText": "Could you add a comment about the strategy that you choosed? (Relying on type members).", "author": "nharrand", "createdAt": "2020-12-04T08:56:14Z", "path": "src/main/java/spoon/support/sniper/internal/IndentationDetector.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/**\n+ * SPDX-License-Identifier: (MIT OR CECILL-C)\n+ *\n+ * Copyright (C) 2006-2019 INRIA and contributors\n+ *\n+ * Spoon is available either under the terms of the MIT License (see LICENSE-MIT.txt) of the Cecill-C License (see LICENSE-CECILL-C.txt). You as the user are entitled to choose the terms under which to adopt Spoon.\n+ */\n+package spoon.support.sniper.internal;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import spoon.reflect.declaration.CtCompilationUnit;\n+import spoon.reflect.path.CtRole;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Utility class for detecting the indentation style used in a compilation unit.\n+ */\n+public class IndentationDetector {\n+\n+\tprivate IndentationDetector() {\n+\t}\n+\n+\t/**\n+\t * Detect the indentation style of the given compilation unit as 1, 2 or 4 spaces or tabs.\n+\t *", "originalCommit": "5fb75311858daa6e817c520a27ab653c12810ac8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1d3d5923a4b85d137979930b7f0b4bab46dbf8df", "url": "https://github.com/INRIA/spoon/commit/1d3d5923a4b85d137979930b7f0b4bab46dbf8df", "message": "Clarify indentation detection strategy", "committedDate": "2020-12-04T09:10:29Z", "type": "commit"}]}