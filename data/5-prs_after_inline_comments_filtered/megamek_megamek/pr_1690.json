{"pr_number": 1690, "pr_title": "Check equipment compatibility with motive type when validating vehicles", "pr_createdAt": "2020-02-18T15:32:39Z", "pr_url": "https://github.com/MegaMek/megamek/pull/1690", "timeline": [{"oid": "51b13028c14ac54c0906c11163e9997b09f1763d", "url": "https://github.com/MegaMek/megamek/commit/51b13028c14ac54c0906c11163e9997b09f1763d", "message": "Moved motive type filtering for CV equipment to TestTank for validation.", "committedDate": "2020-02-17T17:01:52Z", "type": "commit"}, {"oid": "7e0b9849bef2a3f034ccc0e80aa78589682c5b02", "url": "https://github.com/MegaMek/megamek/commit/7e0b9849bef2a3f034ccc0e80aa78589682c5b02", "message": "Add motive type validataion for weapons.", "committedDate": "2020-02-18T15:16:39Z", "type": "commit"}, {"oid": "06ec6f8b30e79745897dd2db34ea049214870915", "url": "https://github.com/MegaMek/megamek/commit/06ec6f8b30e79745897dd2db34ea049214870915", "message": "Validate support tank equipment against motive type.", "committedDate": "2020-02-18T15:17:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwNDQ5Mg==", "url": "https://github.com/MegaMek/megamek/pull/1690#discussion_r380804492", "bodyText": "What? VTOLs can't mount rivet guns? That's BS, I demand a refund! ::monocle::", "author": "NickAragua", "createdAt": "2020-02-18T16:56:14Z", "path": "megamek/src/megamek/common/verifier/TestTank.java", "diffHunk": "@@ -451,6 +458,71 @@ public boolean correctEntity(StringBuffer buff, int ammoTechLvl) {\n         return correct;\n     }\n \n+    /**\n+     * Checks whether the equipment is compatible with the vehicle's motive type\n+     *\n+     * @param eq   The equipment to check\n+     * @param mode The vehicle's motive type\n+     * @return     Whether the equipment and motive type are compatible\n+     */\n+    public static boolean legalForMotiveType(EquipmentType eq, EntityMovementMode mode) {\n+        final boolean isNaval = mode.equals(EntityMovementMode.NAVAL)\n+                || mode.equals(EntityMovementMode.HYDROFOIL)\n+                || mode.equals(EntityMovementMode.SUBMARINE);\n+        if (eq instanceof MiscType) {\n+            if (eq.hasFlag(MiscType.F_FLOTATION_HULL)) {\n+                // Per errata, WiGE vehicles automatically include flotation hull\n+                return mode.equals(EntityMovementMode.HOVER) || mode.equals(EntityMovementMode.VTOL);\n+            }\n+            if (eq.hasFlag(MiscType.F_FULLY_AMPHIBIOUS)\n+                    || eq.hasFlag(MiscType.F_LIMITED_AMPHIBIOUS)\n+                    || eq.hasFlag(MiscType.F_BULLDOZER)\n+                    || (eq.hasFlag(MiscType.F_CLUB) && eq.hasSubType(MiscType.S_COMBINE))) {\n+                return mode.equals(EntityMovementMode.WHEELED) || mode.equals(EntityMovementMode.TRACKED);\n+            }\n+            if (eq.hasFlag(MiscType.F_DUNE_BUGGY)) {\n+                return mode.equals(EntityMovementMode.WHEELED);\n+            }\n+            if (eq.hasFlag(MiscType.F_CLUB)\n+                    && eq.hasSubType(MiscType.S_CHAINSAW | MiscType.S_DUAL_SAW | MiscType.S_MINING_DRILL)) {\n+                return mode.equals(EntityMovementMode.WHEELED) || mode.equals(EntityMovementMode.TRACKED)\n+                        || mode.equals(EntityMovementMode.HOVER) || mode.equals(EntityMovementMode.WIGE);\n+            }\n+            if (eq.hasFlag(MiscType.F_MINESWEEPER)) {\n+                return mode.equals(EntityMovementMode.WHEELED) || mode.equals(EntityMovementMode.TRACKED)\n+                    || isNaval;\n+            }\n+            if (eq.hasFlag(MiscType.F_LIFEBOAT)) {\n+                // Need to filter out atmospheric lifeboat\n+                return isNaval && (eq.hasFlag(MiscType.F_TANK_EQUIPMENT) || eq.hasFlag(MiscType.F_SUPPORT_TANK_EQUIPMENT));\n+            }\n+            if (eq.hasFlag(MiscType.F_HEAVY_BRIDGE_LAYER)\n+                    || eq.hasFlag(MiscType.F_MEDIUM_BRIDGE_LAYER)\n+                    || eq.hasFlag(MiscType.F_LIGHT_BRIDGE_LAYER)\n+                    || (eq.hasFlag(MiscType.F_CLUB)\n+                    && eq.hasSubType(MiscType.S_BACKHOE | MiscType.S_ROCK_CUTTER\n+                    | MiscType.S_SPOT_WELDER | MiscType.S_WRECKING_BALL))) {\n+                return !mode.equals(EntityMovementMode.VTOL);\n+            }\n+            if (eq.hasFlag(MiscType.F_CLUB) && eq.hasSubType(MiscType.S_PILE_DRIVER)) {\n+                return !mode.equals(EntityMovementMode.VTOL)\n+                        && !mode.equals(EntityMovementMode.HOVER)\n+                        && !mode.equals(EntityMovementMode.WIGE);\n+            }\n+            if (eq.hasFlag(MiscType.F_AP_POD)) {\n+                return !isNaval;\n+            }\n+        } else if (eq instanceof WeaponType) {\n+            if (((WeaponType) eq).getAmmoType() == AmmoType.T_BPOD) {\n+                return !isNaval;\n+            }\n+            if (((WeaponType) eq).getAmmoType() == AmmoType.T_NAIL_RIVET_GUN) {", "originalCommit": "06ec6f8b30e79745897dd2db34ea049214870915", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwNTUwMQ==", "url": "https://github.com/MegaMek/megamek/pull/1690#discussion_r380805501", "bodyText": "I think it's a total crock that submarines can't have combines. Hello? Kelp forests?", "author": "neoancient", "createdAt": "2020-02-18T16:57:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwNDQ5Mg=="}], "type": "inlineReview"}]}