{"pr_number": 2518, "pr_title": "Issue #2517: Ensure AmmoType::canSwitchToAmmo ignores munition types", "pr_createdAt": "2020-12-18T16:03:21Z", "pr_url": "https://github.com/MegaMek/megamek/pull/2518", "timeline": [{"oid": "339ba576184379750ff895f45fa2603ae18cbd4e", "url": "https://github.com/MegaMek/megamek/commit/339ba576184379750ff895f45fa2603ae18cbd4e", "message": "AmmoType::canSwitchToAmmo should ignore munition type #2517", "committedDate": "2020-12-18T16:00:46Z", "type": "commit"}, {"oid": "d037c18c88ec60976de9b87dd9f04e83c248b19b", "url": "https://github.com/MegaMek/megamek/commit/d037c18c88ec60976de9b87dd9f04e83c248b19b", "message": "Add parentheses where required", "committedDate": "2020-12-18T16:01:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0MjAxOA==", "url": "https://github.com/MegaMek/megamek/pull/2518#discussion_r545942018", "bodyText": "Can't look at it right now, what's the final logic block look like at the bottom that's returned? The one that's like \"(mmlAmmoMatch || lbxAmmoMatch || ammoOfSameType) && !mismatch", "author": "NickAragua", "createdAt": "2020-12-18T16:22:40Z", "path": "megamek/src/megamek/common/AmmoType.java", "diffHunk": "@@ -15897,17 +15897,16 @@ public static boolean canSwitchToAmmo(Mounted weapon, AmmoType otherAmmo) {\n         \n         AmmoType currentAmmoType = (AmmoType) weapon.getLinked().getType();\n         \n-        boolean ammoOfSameType = currentAmmoType.equals(otherAmmo);\n+        boolean ammoOfSameType = currentAmmoType.equalsAmmoTypeOnly(otherAmmo)\n+                && (currentAmmoType.getRackSize() == otherAmmo.getRackSize());\n         \n         // MMLs can swap between different specific ammo types, so we have a special case check here\n-        boolean mmlAmmoMatch = currentAmmoType.getAmmoType() == AmmoType.T_MML &&\n-                otherAmmo.getAmmoType() == AmmoType.T_MML &&\n-                currentAmmoType.getRackSize() == otherAmmo.getRackSize();\n+        boolean mmlAmmoMatch = (currentAmmoType.getAmmoType() == AmmoType.T_MML)\n+                && (otherAmmo.getAmmoType() == AmmoType.T_MML);\n         \n         // LBXs can swap between cluster and slug ammo types\n-        boolean lbxAmmoMatch = currentAmmoType.getAmmoType() == AmmoType.T_AC_LBX &&\n-                otherAmmo.getAmmoType() == AmmoType.T_AC_LBX &&\n-                currentAmmoType.getRackSize() == otherAmmo.getRackSize();\n+        boolean lbxAmmoMatch = (currentAmmoType.getAmmoType() == AmmoType.T_AC_LBX)\n+                && (otherAmmo.getAmmoType() == AmmoType.T_AC_LBX);", "originalCommit": "d037c18c88ec60976de9b87dd9f04e83c248b19b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0NDIxMg==", "url": "https://github.com/MegaMek/megamek/pull/2518#discussion_r545944212", "bodyText": "You can't even view it on GH its too large...oy.\n    /**\n     * Whether the given weapon can switch to the given ammo type\n     * @param weapon The weapon being considered\n     * @param otherAmmo The other ammo type being considered\n     * @return true/false - null arguments or linked ammo bin for the weapon result in false\n     */\n    public static boolean canSwitchToAmmo(Mounted weapon, AmmoType otherAmmo) {\n        if((weapon == null) ||\n                (weapon.getLinked() == null) ||\n                (otherAmmo == null)) {\n            return false;\n        }\n        \n        AmmoType currentAmmoType = (AmmoType) weapon.getLinked().getType();\n        \n        boolean ammoOfSameType = currentAmmoType.equalsAmmoTypeOnly(otherAmmo)\n                && (currentAmmoType.getRackSize() == otherAmmo.getRackSize());\n        \n        // MMLs can swap between different specific ammo types, so we have a special case check here\n        boolean mmlAmmoMatch = (currentAmmoType.getAmmoType() == AmmoType.T_MML)\n                && (otherAmmo.getAmmoType() == AmmoType.T_MML);\n        \n        // LBXs can swap between cluster and slug ammo types\n        boolean lbxAmmoMatch = (currentAmmoType.getAmmoType() == AmmoType.T_AC_LBX)\n                && (otherAmmo.getAmmoType() == AmmoType.T_AC_LBX);\n        \n        boolean caselessLoaded = currentAmmoType.getMunitionType() == AmmoType.M_CASELESS;\n        boolean otherBinCaseless = otherAmmo.getMunitionType() == AmmoType.M_CASELESS;\n        boolean caselessMismatch = caselessLoaded != otherBinCaseless;\n        \n        boolean hasStaticFeed = weapon.hasQuirk(OptionsConstants.QUIRK_WEAP_NEG_STATIC_FEED);\n        boolean staticFeedMismatch = hasStaticFeed && (currentAmmoType.getMunitionType() != otherAmmo.getMunitionType());\n        \n        return (ammoOfSameType || mmlAmmoMatch || lbxAmmoMatch) && !caselessMismatch && !staticFeedMismatch;\n    }", "author": "sixlettervariables", "createdAt": "2020-12-18T16:26:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0MjAxOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0NDQ4MA==", "url": "https://github.com/MegaMek/megamek/pull/2518#discussion_r545944480", "bodyText": "Hell I missed the rack size fix, let me add that back.", "author": "sixlettervariables", "createdAt": "2020-12-18T16:26:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0MjAxOA=="}], "type": "inlineReview"}, {"oid": "19d8efb69f3adc73355dfc124150d5883b2b45c4", "url": "https://github.com/MegaMek/megamek/commit/19d8efb69f3adc73355dfc124150d5883b2b45c4", "message": "Add rack size restrictions on MML/LBX", "committedDate": "2020-12-18T16:28:41Z", "type": "commit"}, {"oid": "4abbd3653f7761eb024e345401242552b611f8bd", "url": "https://github.com/MegaMek/megamek/commit/4abbd3653f7761eb024e345401242552b611f8bd", "message": "Add missing mocks to FireControlTest", "committedDate": "2020-12-18T16:39:30Z", "type": "commit"}]}