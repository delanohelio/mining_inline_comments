{"pr_number": 1723, "pr_title": "Fuel air munitions", "pr_createdAt": "2020-02-28T03:44:45Z", "pr_url": "https://github.com/MegaMek/megamek/pull/1723", "timeline": [{"oid": "e2286ac1f810baf0049a7e78548e11255ae13eba", "url": "https://github.com/MegaMek/megamek/commit/e2286ac1f810baf0049a7e78548e11255ae13eba", "message": "initial work", "committedDate": "2020-02-28T01:16:56Z", "type": "commit"}, {"oid": "fe0fbfad1c97fda26e60a7df333dc0817c186cf7", "url": "https://github.com/MegaMek/megamek/commit/fe0fbfad1c97fda26e60a7df333dc0817c186cf7", "message": "Merge branch 'master' of https://github.com/MegaMek/megamek into fuel_air_munitions", "committedDate": "2020-02-28T01:17:01Z", "type": "commit"}, {"oid": "5d2f4d12be702f3f660099aa899c5c9500588e1b", "url": "https://github.com/MegaMek/megamek/commit/5d2f4d12be702f3f660099aa899c5c9500588e1b", "message": "thar she blows", "committedDate": "2020-02-28T03:23:40Z", "type": "commit"}, {"oid": "7a2406e673065c91b0f054b49906099ceabf84af", "url": "https://github.com/MegaMek/megamek/commit/7a2406e673065c91b0f054b49906099ceabf84af", "message": "Delete FuelAirHandler.java", "committedDate": "2020-02-28T03:44:59Z", "type": "commit"}, {"oid": "9976b26ab1878fc66a9e9bfd316fe529a41cb3d3", "url": "https://github.com/MegaMek/megamek/commit/9976b26ab1878fc66a9e9bfd316fe529a41cb3d3", "message": "improved bot evaluation of bomb blast radii", "committedDate": "2020-02-28T04:05:53Z", "type": "commit"}, {"oid": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "url": "https://github.com/MegaMek/megamek/commit/a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "message": "Merge branch 'fuel_air_munitions' of https://github.com/NickAragua/megamek into fuel_air_munitions", "committedDate": "2020-02-28T04:06:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5ODcxMA==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385498710", "bodyText": "Why make this a variable if it is only used once?", "author": "Windchild292", "createdAt": "2020-02-28T04:07:45Z", "path": "megamek/src/megamek/server/Server.java", "diffHunk": "@@ -35130,6 +35159,8 @@ public void doSinkEntity(Entity en) {\n \n         // get units in hex\n         for (Entity entity : game.getEntitiesVector(coords)) {\n+            boolean entityIsInfantryButNotBattleArmor = (entity instanceof Infantry) && !(entity instanceof BattleArmor);", "originalCommit": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5OTAxNQ==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385499015", "bodyText": "It's actually used twice, on line 35250 and 35263", "author": "NickAragua", "createdAt": "2020-02-28T04:09:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5ODcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5OTE3Nw==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385499177", "bodyText": "My search was off, my bad", "author": "Windchild292", "createdAt": "2020-02-28T04:10:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5ODcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1MzYyMw==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385753623", "bodyText": "You could actually use entity.getUnitType() to do this.", "author": "mkerensky", "createdAt": "2020-02-28T15:19:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5ODcxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5ODk3Ng==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385498976", "bodyText": "Fortress is a comparison to Building.Fortress, Brian's aren't implemented", "author": "Windchild292", "createdAt": "2020-02-28T04:09:20Z", "path": "megamek/src/megamek/server/Server.java", "diffHunk": "@@ -35105,15 +35099,50 @@ public void doSinkEntity(Entity en) {\n             }\n             vPhaseReport.addAll(newReports);\n         }\n+        \n+        boolean isFuelAirBomb = \n+                ammo != null &&\n+                (BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_SMALL ||\n+                BombType.getBombTypeFromInternalName(ammo.getInternalName()) == BombType.B_FAE_LARGE);\n+        \n         Building bldg = game.getBoard().getBuildingAt(coords);\n         int bldgAbsorbs = 0;\n         if ((bldg != null)\n                 && !(flak && (((altitude > hex.terrainLevel(Terrains.BLDG_ELEV))\n                 || (altitude > hex.terrainLevel(Terrains.BRIDGE_ELEV)))))) {\n             bldgAbsorbs = bldg.getAbsorbtion(coords);\n             if (!((ammo != null) && (ammo.getMunitionType() == AmmoType.M_FLECHETTE))) {\n+                int actualDamage = damage;\n+                \n+                if(isFuelAirBomb) {\n+                    // light buildings take 1.5x damage from fuel-air bombs\n+                    if(bldg.getType() == Building.LIGHT) {\n+                        actualDamage = (int) Math.ceil(actualDamage * 1.5);\n+                        \n+                        r = new Report(9991);\n+                        r.indent(1);\n+                        r.subject = killer.getId();\n+                        r.newlines = 1;\n+                        vPhaseReport.addElement(r);\n+                    } \n+\n+                    // armored and \"castle brian\" buildings take .5 damage from fuel-air bombs\n+                    // but I have no idea how to determine if a building is a castle or a brian", "originalCommit": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ5OTM2OA==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385499368", "bodyText": "Missing a space on the for (", "author": "Windchild292", "createdAt": "2020-02-28T04:11:30Z", "path": "megamek/src/megamek/client/bot/princess/WeaponFireInfo.java", "diffHunk": "@@ -459,15 +459,12 @@ private double computeExpectedBombDamage(final Entity shooter,\n             for (final Mounted bomb : shooter.getBombs(BombType.F_GROUND_BOMB)) {\n                 final int damagePerShot = ((BombType) bomb.getType()).getDamagePerShot();\n         \n-                // HE, thunder, laser and inferno bombs just affect the target hex \n+                // some bombs affect a blast radius, so we take that into account\n                 final List<Coords> affectedHexes = new ArrayList<>();\n-                affectedHexes.add(bombedHex);\n                 \n-                // a cluster bomb affects all hexes around the target\n-                if (BombType.B_CLUSTER == ((BombType) bomb.getType()).getBombType()) {\n-                    for (int dir = 0; 5 >= dir; dir++) {\n-                        affectedHexes.add(bombedHex.translated(dir));\n-                    }\n+                int blastRadius = BombType.getBombBlastRadius(bomb.getType().getInternalName()); \n+                for(int radius = 0; radius <= blastRadius; radius++) {", "originalCommit": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc1Nzc1MQ==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385757751", "bodyText": "shortName is used for display to users in contexts where the full name may be too long. It's used particularly on record sheets.", "author": "neoancient", "createdAt": "2020-02-28T15:27:01Z", "path": "megamek/src/megamek/common/BombType.java", "diffHunk": "@@ -394,11 +420,67 @@ private static BombType createClusterBomb() {\n \t\t        .setISApproximate(false, false, false, false, false)\n \t\t        .setClanAdvancement(DATE_PS, DATE_PS, DATE_PS, DATE_NONE, DATE_NONE)\n \t\t        .setClanApproximate(false, false, false, false, false);\n+\t\t\n+\t\tblastRadius.put(BombType.getBombInternalName(BombType.B_CLUSTER), 1);\n \n \t\treturn bomb;\n \t}\n \n-\t// TODO Fuel-Air Bombs (See IO 165)\n+\tprivate static BombType createSmallFuelAirBomb() {\n+        BombType bomb = new BombType();\n+\n+        bomb.name = \"Fuel-Air Bomb (Small)\";\n+        bomb.shortName = \"FAEBomb_s\";", "originalCommit": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2MTMyMQ==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385761321", "bodyText": "thinAtmo is always false here.", "author": "neoancient", "createdAt": "2020-02-28T15:32:40Z", "path": "megamek/src/megamek/common/weapons/BombAttackHandler.java", "diffHunk": "@@ -269,4 +278,98 @@ public boolean handle(IGame.Phase phase, Vector<Report> vPhaseReport) {\n \n         return false;\n     }\n+    \n+    public static void processFuelAirDamage(Coords center, EquipmentType bombType, Entity attacker, Vector<Report> vPhaseReport, Server server) {\n+        IGame game = attacker.getGame();\n+        // sanity check: if this attack is happening in vacuum through very thin atmo, add that to the phase report and terminate early \n+        boolean notEnoughAtmo = game.getBoard().inSpace() ||\n+                game.getPlanetaryConditions().getAtmosphere() <= PlanetaryConditions.ATMO_TRACE;\n+        \n+        if(notEnoughAtmo) {\n+            Report r = new Report(9986);\n+            r.indent(1);\n+            r.subject = attacker.getId();\n+            r.newlines = 1;\n+            vPhaseReport.addElement(r);\n+            return;\n+        }\n+        \n+        boolean thinAtmo = game.getPlanetaryConditions().getAtmosphere() == PlanetaryConditions.ATMO_THIN;\n+        int[] radiusChart = { 5, 10, 20, 30 };\n+        int bombRadius = BombType.getBombBlastRadius(bombType.getInternalName());\n+        \n+        if(thinAtmo) {\n+            Report r = new Report(9990);\n+            r.indent(1);\n+            r.subject = attacker.getId();\n+            r.newlines = 1;\n+            vPhaseReport.addElement(r);\n+            return;\n+        }\n+        \n+        Vector<Integer> alreadyHit = new Vector<>();\n+        \n+        // assemble collection of hexes at ranges 0 to radius\n+        // for each hex, invoke artilleryDamageHex, with the damage set according to this:\n+        //      radius chart \n+        //      (divided by half, round up for thin atmo)\n+        //      not here, but in artilleryDamageHex, make sure to 2x damage for infantry outside of building\n+        //      not here, but in artilleryDamageHex, make sure to 1.5x damage for light building or unit with armor BAR < 10\n+        //      not here, but in artilleryDamageHex, make sure to .5x damage for \"castle brian\" or \"armored\" building\n+        // if any attacked unit is infantry or BA, roll 2d6 + current distance. Inf dies on 9-, BA dies on 7-\n+        for(int damageBracket = bombRadius, distFromCenter = 0; damageBracket >= 0; damageBracket--, distFromCenter++) {\n+            Set<Coords> donut = BotGeometry.getHexDonut(center, distFromCenter);\n+            for(Coords coords : donut) {\n+                int damage = radiusChart[damageBracket];\n+                if(thinAtmo) {", "originalCommit": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NTQ4Mg==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385765482", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (entityIsInfantryButNotBattleArmor) {\n          \n          \n            \n                        if (entity.isConventionalInfantry()) {", "author": "neoancient", "createdAt": "2020-02-28T15:39:21Z", "path": "megamek/src/megamek/server/Server.java", "diffHunk": "@@ -35216,19 +35247,25 @@ public void doSinkEntity(Entity en) {\n             }\n \n             // convention infantry take x2 damage from AE weapons\n-            if ((entity instanceof Infantry) && !(entity instanceof BattleArmor)) {\n+            if (entityIsInfantryButNotBattleArmor) {", "originalCommit": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc2NTc5Mg==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385765792", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                if (hex.containsTerrain(Terrains.FORTIFIED) && entityIsInfantryButNotBattleArmor) {\n          \n          \n            \n                                if (hex.containsTerrain(Terrains.FORTIFIED) && entity.isConventionalInfantry()) {", "author": "neoancient", "createdAt": "2020-02-28T15:39:47Z", "path": "megamek/src/megamek/server/Server.java", "diffHunk": "@@ -35216,19 +35247,25 @@ public void doSinkEntity(Entity en) {\n             }\n \n             // convention infantry take x2 damage from AE weapons\n-            if ((entity instanceof Infantry) && !(entity instanceof BattleArmor)) {\n+            if (entityIsInfantryButNotBattleArmor) {\n                 hits *= 2;\n+                \n+                // if it's fuel-air, we take even more damage!\n+                if(isFuelAirBomb) {\n+                    hits *= 2;\n+                }\n             }\n             boolean specialCaseFlechette = false;\n \n             // Entity/ammo specific damage modifiers\n             if (ammo != null) {\n                 if (ammo.getMunitionType() == AmmoType.M_CLUSTER) {\n-                    if (hex.containsTerrain(Terrains.FORTIFIED) && (entity instanceof Infantry)\n-                            && !(entity instanceof BattleArmor)) {\n+                    if (hex.containsTerrain(Terrains.FORTIFIED) && entityIsInfantryButNotBattleArmor) {", "originalCommit": "a0138b48b2ce460ad8e7ef1cd28a59b31b57de21", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c200b1dfd3106439272276b48b61124bfb5cef03", "url": "https://github.com/MegaMek/megamek/commit/c200b1dfd3106439272276b48b61124bfb5cef03", "message": "code review changes", "committedDate": "2020-02-29T01:43:30Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk5MTYyMQ==", "url": "https://github.com/MegaMek/megamek/pull/1723#discussion_r385991621", "bodyText": "Maybe use capital letter instead of lowercase here? l, 1, I, and | can be annoying to tell the difference between them, but L is easy to tell.", "author": "Windchild292", "createdAt": "2020-02-29T02:08:18Z", "path": "megamek/src/megamek/common/BombType.java", "diffHunk": "@@ -458,7 +458,7 @@ private static BombType createLargeFuelAirBomb() {\n         BombType bomb = new BombType();\n \n         bomb.name = \"Fuel-Air Bomb (Large)\";\n-        bomb.shortName = \"FAEBomb_l\";\n+        bomb.shortName = \"FAE Bomb (l)\";", "originalCommit": "c200b1dfd3106439272276b48b61124bfb5cef03", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7f55c533f056790053ef6a86906dc3a4b42445f4", "url": "https://github.com/MegaMek/megamek/commit/7f55c533f056790053ef6a86906dc3a4b42445f4", "message": "text adjustment", "committedDate": "2020-03-02T02:27:43Z", "type": "commit"}]}