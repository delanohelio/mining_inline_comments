{"pr_number": 2135, "pr_title": "Unit sprites in the Combat Log", "pr_createdAt": "2020-08-12T10:32:36Z", "pr_url": "https://github.com/MegaMek/megamek/pull/2135", "timeline": [{"oid": "cff3b7ac6e38e1f11dbe79337875b5bd73b3d130", "url": "https://github.com/MegaMek/megamek/commit/cff3b7ac6e38e1f11dbe79337875b5bd73b3d130", "message": "Added entity image to report and enabled displaying Base64 sources", "committedDate": "2020-08-11T10:44:05Z", "type": "commit"}, {"oid": "bc3509e58afbeebdca38141154be27e4aef0e709", "url": "https://github.com/MegaMek/megamek/commit/bc3509e58afbeebdca38141154be27e4aef0e709", "message": "Implemented image caching and enabled camo for units in the report dialogue", "committedDate": "2020-08-12T02:03:02Z", "type": "commit"}, {"oid": "24add1256b2ac19da51e5acd990d835e2e024a72", "url": "https://github.com/MegaMek/megamek/commit/24add1256b2ac19da51e5acd990d835e2e024a72", "message": "Updated reports so that the images will not show on log items that have been indented more than once", "committedDate": "2020-08-12T09:19:45Z", "type": "commit"}, {"oid": "9e533857b10bca0bc6061667f2fe7d6ae64e3394", "url": "https://github.com/MegaMek/megamek/commit/9e533857b10bca0bc6061667f2fe7d6ae64e3394", "message": "Fix for potential null reference", "committedDate": "2020-08-12T10:53:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzEzMA==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469303130", "bodyText": "Why not use the TilesetManager class instead of basically rolling your own implementation of it? It's present in the BoardView class and contains pretty much all of the information you could need.", "author": "NickAragua", "createdAt": "2020-08-12T14:30:22Z", "path": "megamek/src/megamek/client/Client.java", "diffHunk": "@@ -161,6 +129,15 @@\n \n     public Map<String, Client> bots = new TreeMap<String, Client>(StringUtil.stringComparator());\n \n+    //get the image data\n+    private MechTileset mechTileset = new MechTileset(Configuration.unitImagesDir());", "originalCommit": "9e533857b10bca0bc6061667f2fe7d6ae64e3394", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTU1NTQ0MQ==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469555441", "bodyText": "Initially I was having trouble getting an image to show, so after I got it working initially I just kept building around it. Now that I have a better understand of how it works, I'll definitely go back and do it that way and address the other changes as well.", "author": "Krashner", "createdAt": "2020-08-12T21:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzEzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzU4Mg==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469303582", "bodyText": "This class needs a standard megamek header comment.", "author": "NickAragua", "createdAt": "2020-08-12T14:31:00Z", "path": "megamek/src/megamek/client/ui/swing/util/BASE64ImageView.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package megamek.client.ui.swing.util;", "originalCommit": "9e533857b10bca0bc6061667f2fe7d6ae64e3394", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2Nzc1MQ==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470367751", "bodyText": "I think we usually put the header comment above the imports.", "author": "NickAragua", "createdAt": "2020-08-14T01:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzU4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwMzg1Mw==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469303853", "bodyText": "Let's put a javadoc-style comment on the class and any public-facing methods.", "author": "NickAragua", "createdAt": "2020-08-12T14:31:24Z", "path": "megamek/src/megamek/client/ui/swing/util/BASE64ImageView.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package megamek.client.ui.swing.util;\n+\n+import javax.imageio.ImageIO;\n+import javax.swing.text.Element;\n+import javax.swing.text.html.HTML;\n+import javax.swing.text.html.ImageView;\n+import java.awt.*;\n+import java.awt.image.BufferedImage;\n+import java.io.ByteArrayInputStream;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.util.Base64;\n+import java.util.Dictionary;\n+import java.util.Hashtable;\n+\n+public class BASE64ImageView extends ImageView {", "originalCommit": "9e533857b10bca0bc6061667f2fe7d6ae64e3394", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTMwNDEzNA==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r469304134", "bodyText": "\"Copyright\" header, javadoc comment on class and public-facing methods.", "author": "NickAragua", "createdAt": "2020-08-12T14:31:46Z", "path": "megamek/src/megamek/client/ui/swing/util/BASE64ToolKit.java", "diffHunk": "@@ -0,0 +1,33 @@\n+package megamek.client.ui.swing.util;\n+\n+import javax.swing.text.*;\n+import javax.swing.text.html.HTML;\n+import javax.swing.text.html.HTMLEditorKit;\n+\n+public class BASE64ToolKit extends HTMLEditorKit {", "originalCommit": "9e533857b10bca0bc6061667f2fe7d6ae64e3394", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "61a939b5208920a3a7db5bb6b293e530baaa5677", "url": "https://github.com/MegaMek/megamek/commit/61a939b5208920a3a7db5bb6b293e530baaa5677", "message": "Added more comments, new method to get sprites, better sprite placement and an advanced option to toggle the feature on/off", "committedDate": "2020-08-13T13:02:53Z", "type": "commit"}, {"oid": "6cdf9aa3a5700408b65320e2640fba6639e725b3", "url": "https://github.com/MegaMek/megamek/commit/6cdf9aa3a5700408b65320e2640fba6639e725b3", "message": "Added wrecks to log, fixed occasionally blank log on load", "committedDate": "2020-08-13T22:18:08Z", "type": "commit"}, {"oid": "a1271d093bc0f5651034dab336ccd774e8c4173b", "url": "https://github.com/MegaMek/megamek/commit/a1271d093bc0f5651034dab336ccd774e8c4173b", "message": "Fix for possible null reference", "committedDate": "2020-08-13T22:49:49Z", "type": "commit"}, {"oid": "c686dac7a3d696222ddcb2709b10b8d4bffbe16a", "url": "https://github.com/MegaMek/megamek/commit/c686dac7a3d696222ddcb2709b10b8d4bffbe16a", "message": "Fix for possible null reference", "committedDate": "2020-08-13T23:22:23Z", "type": "commit"}, {"oid": "eaeca8e10873579b66ec758503987f7568ef298e", "url": "https://github.com/MegaMek/megamek/commit/eaeca8e10873579b66ec758503987f7568ef298e", "message": "Fix for possuble null entity refererence", "committedDate": "2020-08-13T23:24:46Z", "type": "commit"}, {"oid": "4135e3e536685e6254d7f9d551507a86b983dbe1", "url": "https://github.com/MegaMek/megamek/commit/4135e3e536685e6254d7f9d551507a86b983dbe1", "message": "Merge branch 'combatLogSprites' of https://github.com/Krashner/megamek into combatLogSprites", "committedDate": "2020-08-13T23:26:14Z", "type": "commit"}, {"oid": "b613715a6f674c68b10210479f2a34c2dee7883d", "url": "https://github.com/MegaMek/megamek/commit/b613715a6f674c68b10210479f2a34c2dee7883d", "message": "Removed useless null check", "committedDate": "2020-08-13T23:47:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM2NzE1OQ==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470367159", "bodyText": "Let's get rid of this commented out method.", "author": "NickAragua", "createdAt": "2020-08-14T01:50:31Z", "path": "megamek/src/megamek/client/Client.java", "diffHunk": "@@ -274,6 +245,14 @@ protected void updateConnection() {\n         }\n     }\n \n+    private BoardView1 bv;\n+    public void setBoardView(BoardView1 bv){\n+        this.bv = bv;\n+    }\n+\n+    //public getBoardView(){", "originalCommit": "b613715a6f674c68b10210479f2a34c2dee7883d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MTg1Mw==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470371853", "bodyText": "I'm fairly certain that the TilesetManager has its own caching mechanism. I don't think you need to have a separate caching mechanism here.", "author": "NickAragua", "createdAt": "2020-08-14T02:11:09Z", "path": "megamek/src/megamek/client/Client.java", "diffHunk": "@@ -1125,7 +1115,85 @@ public String receiveReport(Vector<Report> v) {\n         for (Report r : v) {\n             report.append(r.getText());\n         }\n-        return report.toString();\n+\n+        Set<Integer> set = new HashSet<Integer>();\n+        //find id stored in spans and extract it\n+        Pattern p = Pattern.compile(\"<s(.*?)n>\");\n+        Matcher m = p.matcher(report.toString());\n+\n+        //add all instances to a hashset to prevent duplicates\n+        while(m.find()){\n+            String cleanedText = m.group(1).replaceAll(\"\\\\D\", \"\");\n+            if(cleanedText.length() > 0) {\n+                set.add(Integer.parseInt(cleanedText));\n+            }\n+        }\n+\n+        String updatedReport = report.toString();\n+        //loop through the hashset of unique ids and replace the ids with img tags\n+        for (int i : set) {\n+            if(getCachedImageData(i) != null) {\n+                updatedReport = updatedReport.replace(\"<span id='\" +i + \"'></span>\", getCachedImageData(i));\n+            }\n+        }\n+        return updatedReport;\n+    }\n+\n+    /**\n+     * get img tag for unit id\n+     */\n+    private String getCachedImageData(int id){\n+        if(imgCache == null || !imgCache.containsKey(id)) {\n+            return null;\n+        }\n+        return imgCache.get(id);\n+    }\n+\n+    /**\n+     * Hashtable for storing image tags containing base64Text src\n+     */\n+    private void cacheImageData(Entity entity){", "originalCommit": "b613715a6f674c68b10210479f2a34c2dee7883d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDYwMTIxOQ==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470601219", "bodyText": "I looked at that, but I'm storing strings after the image is encoded as a Base64 string and put into an <img> tag. the data looks something like the following, but just quite a bit longer.\n<img src='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADgAAAAwCAYAAABE1blzAAALvkl...'>\nI do actually use TilesetManager's image cache when I call imageFor though. Perhaps I should rename cacheImageData so that it doesn't sound like I'm just recaching the images?", "author": "Krashner", "createdAt": "2020-08-14T12:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MTg1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDc1MTY5Mw==", "url": "https://github.com/MegaMek/megamek/pull/2135#discussion_r470751693", "bodyText": "Now that I look at it again, I get what you're doing.", "author": "NickAragua", "createdAt": "2020-08-14T17:14:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDM3MTg1Mw=="}], "type": "inlineReview"}, {"oid": "7b643fff3ee0c73a753fe88ea503c65a1b05475e", "url": "https://github.com/MegaMek/megamek/commit/7b643fff3ee0c73a753fe88ea503c65a1b05475e", "message": "Removed commented function, moved copyright comments and renamed function", "committedDate": "2020-08-14T15:43:01Z", "type": "commit"}]}