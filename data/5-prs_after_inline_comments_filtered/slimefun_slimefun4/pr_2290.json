{"pr_number": 2290, "pr_title": "Performance improvements on TickerTask <Tested>", "pr_createdAt": "2020-09-05T16:21:00Z", "pr_url": "https://github.com/Slimefun/Slimefun4/pull/2290", "timeline": [{"oid": "766fb75d6253231b09bcabbfbbc0168f9b99a205", "url": "https://github.com/Slimefun/Slimefun4/commit/766fb75d6253231b09bcabbfbbc0168f9b99a205", "message": "Performance improvements on TickerTask", "committedDate": "2020-09-05T16:17:39Z", "type": "commit"}, {"oid": "e04bce24f1f62e34d990f394a20fd94f05e51133", "url": "https://github.com/Slimefun/Slimefun4/commit/e04bce24f1f62e34d990f394a20fd94f05e51133", "message": "Added my friend whom helped me as author", "committedDate": "2020-09-05T16:24:44Z", "type": "commit"}, {"oid": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "url": "https://github.com/Slimefun/Slimefun4/commit/e682760c87cba8a9f7d5f478bdadddde6d81c918", "message": "Update CHANGELOG.md", "committedDate": "2020-09-05T20:06:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDAxMg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984012", "bodyText": "No need to mark this parameter as final really.", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:11:08Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -57,66 +74,169 @@\n      *            The instance of our {@link SlimefunPlugin}\n      */\n     public void start(@Nonnull SlimefunPlugin plugin) {\n+\n         this.tickRate = SlimefunPlugin.getCfg().getInt(\"URID.custom-ticker-delay\");\n \n         BukkitScheduler scheduler = plugin.getServer().getScheduler();\n-        scheduler.runTaskTimerAsynchronously(plugin, this, 100L, tickRate);\n+        scheduler.runTaskLater(plugin, this, 100L);\n     }\n \n-    /**\n-     * This method resets this {@link TickerTask} to run again.\n-     */\n-    public void reset() {\n-        running = false;\n+    @Override \n+    public final void run() {\n+\n+        // This should not happen. Only case where this may happen is if this task is scheduled or started multiple times.\n+        if (running) {\n+            return;\n+        }\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Don't overload the Bukkit scheduler with a thousand runnables. It doesn't like that. This way, we can spread the\n+        // time cost over several game ticks and adapt ticker rate to server performance.\n+        final ArrayBlockingQueue<Runnable> syncTasks = new ArrayBlockingQueue<>(32);\n+\n+        // Iterate over the ticker tasks. Process the asynchronous ones on the Bukkit async task thread, and queue the sync\n+        // tasks to the queue.\n+        Bukkit.getScheduler().runTaskAsynchronously(\n+                SlimefunPlugin.instance(),\n+                () -> this.tick(syncTasks)\n+        );\n+\n+        // Process the synchronous ticker tasks on the main thread.\n+        processSyncTasks(syncTasks);\n     }\n \n-    @Override\n-    public void run() {\n+    private void processSyncTasks(final @Nonnull BlockingQueue<Runnable> tasks) {", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4ODM3OQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483988379", "bodyText": "It is needed. We use it in a lambda which requires it as final.", "author": "LinoxGH", "createdAt": "2020-09-05T20:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDAxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDA0MzgyNg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r484043826", "bodyText": "Ah okay, can you at least put the annotation before the final then?", "author": "TheBusyBiscuit", "createdAt": "2020-09-06T09:06:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDAxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDA1Mw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984053", "bodyText": "This magic number should definitely be a static final constant for easier tweaking.", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:11:35Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -57,66 +74,169 @@\n      *            The instance of our {@link SlimefunPlugin}\n      */\n     public void start(@Nonnull SlimefunPlugin plugin) {\n+\n         this.tickRate = SlimefunPlugin.getCfg().getInt(\"URID.custom-ticker-delay\");\n \n         BukkitScheduler scheduler = plugin.getServer().getScheduler();\n-        scheduler.runTaskTimerAsynchronously(plugin, this, 100L, tickRate);\n+        scheduler.runTaskLater(plugin, this, 100L);\n     }\n \n-    /**\n-     * This method resets this {@link TickerTask} to run again.\n-     */\n-    public void reset() {\n-        running = false;\n+    @Override \n+    public final void run() {\n+\n+        // This should not happen. Only case where this may happen is if this task is scheduled or started multiple times.\n+        if (running) {\n+            return;\n+        }\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Don't overload the Bukkit scheduler with a thousand runnables. It doesn't like that. This way, we can spread the\n+        // time cost over several game ticks and adapt ticker rate to server performance.\n+        final ArrayBlockingQueue<Runnable> syncTasks = new ArrayBlockingQueue<>(32);\n+\n+        // Iterate over the ticker tasks. Process the asynchronous ones on the Bukkit async task thread, and queue the sync\n+        // tasks to the queue.\n+        Bukkit.getScheduler().runTaskAsynchronously(\n+                SlimefunPlugin.instance(),\n+                () -> this.tick(syncTasks)\n+        );\n+\n+        // Process the synchronous ticker tasks on the main thread.\n+        processSyncTasks(syncTasks);\n     }\n \n-    @Override\n-    public void run() {\n+    private void processSyncTasks(final @Nonnull BlockingQueue<Runnable> tasks) {\n+\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Let's not lag the main thread. Spikes suck. Steady time usage is much better.\n+        long endNs = System.nanoTime() + 1_500_000L;\n+\n         try {\n-            // If this method is actually still running... DON'T\n-            if (running) {\n-                return;\n+            while (endNs > System.nanoTime()) {\n+\n+                // Don't wait on an empty queue for too long.\n+                long s = System.nanoTime();\n+                Runnable r = tasks.poll(250_000L, TimeUnit.NANOSECONDS);", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDA4NA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984084", "bodyText": "Please give your variable a more meaningful name.", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:11:48Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -57,66 +74,169 @@\n      *            The instance of our {@link SlimefunPlugin}\n      */\n     public void start(@Nonnull SlimefunPlugin plugin) {\n+\n         this.tickRate = SlimefunPlugin.getCfg().getInt(\"URID.custom-ticker-delay\");\n \n         BukkitScheduler scheduler = plugin.getServer().getScheduler();\n-        scheduler.runTaskTimerAsynchronously(plugin, this, 100L, tickRate);\n+        scheduler.runTaskLater(plugin, this, 100L);\n     }\n \n-    /**\n-     * This method resets this {@link TickerTask} to run again.\n-     */\n-    public void reset() {\n-        running = false;\n+    @Override \n+    public final void run() {\n+\n+        // This should not happen. Only case where this may happen is if this task is scheduled or started multiple times.\n+        if (running) {\n+            return;\n+        }\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Don't overload the Bukkit scheduler with a thousand runnables. It doesn't like that. This way, we can spread the\n+        // time cost over several game ticks and adapt ticker rate to server performance.\n+        final ArrayBlockingQueue<Runnable> syncTasks = new ArrayBlockingQueue<>(32);\n+\n+        // Iterate over the ticker tasks. Process the asynchronous ones on the Bukkit async task thread, and queue the sync\n+        // tasks to the queue.\n+        Bukkit.getScheduler().runTaskAsynchronously(\n+                SlimefunPlugin.instance(),\n+                () -> this.tick(syncTasks)\n+        );\n+\n+        // Process the synchronous ticker tasks on the main thread.\n+        processSyncTasks(syncTasks);\n     }\n \n-    @Override\n-    public void run() {\n+    private void processSyncTasks(final @Nonnull BlockingQueue<Runnable> tasks) {\n+\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Let's not lag the main thread. Spikes suck. Steady time usage is much better.\n+        long endNs = System.nanoTime() + 1_500_000L;\n+\n         try {\n-            // If this method is actually still running... DON'T\n-            if (running) {\n-                return;\n+            while (endNs > System.nanoTime()) {\n+\n+                // Don't wait on an empty queue for too long.\n+                long s = System.nanoTime();", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDA5OQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984099", "bodyText": "Please give your variable a more meaningful name.", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:11:57Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -57,66 +74,169 @@\n      *            The instance of our {@link SlimefunPlugin}\n      */\n     public void start(@Nonnull SlimefunPlugin plugin) {\n+\n         this.tickRate = SlimefunPlugin.getCfg().getInt(\"URID.custom-ticker-delay\");\n \n         BukkitScheduler scheduler = plugin.getServer().getScheduler();\n-        scheduler.runTaskTimerAsynchronously(plugin, this, 100L, tickRate);\n+        scheduler.runTaskLater(plugin, this, 100L);\n     }\n \n-    /**\n-     * This method resets this {@link TickerTask} to run again.\n-     */\n-    public void reset() {\n-        running = false;\n+    @Override \n+    public final void run() {\n+\n+        // This should not happen. Only case where this may happen is if this task is scheduled or started multiple times.\n+        if (running) {\n+            return;\n+        }\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Don't overload the Bukkit scheduler with a thousand runnables. It doesn't like that. This way, we can spread the\n+        // time cost over several game ticks and adapt ticker rate to server performance.\n+        final ArrayBlockingQueue<Runnable> syncTasks = new ArrayBlockingQueue<>(32);\n+\n+        // Iterate over the ticker tasks. Process the asynchronous ones on the Bukkit async task thread, and queue the sync\n+        // tasks to the queue.\n+        Bukkit.getScheduler().runTaskAsynchronously(\n+                SlimefunPlugin.instance(),\n+                () -> this.tick(syncTasks)\n+        );\n+\n+        // Process the synchronous ticker tasks on the main thread.\n+        processSyncTasks(syncTasks);\n     }\n \n-    @Override\n-    public void run() {\n+    private void processSyncTasks(final @Nonnull BlockingQueue<Runnable> tasks) {\n+\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Let's not lag the main thread. Spikes suck. Steady time usage is much better.\n+        long endNs = System.nanoTime() + 1_500_000L;\n+\n         try {\n-            // If this method is actually still running... DON'T\n-            if (running) {\n-                return;\n+            while (endNs > System.nanoTime()) {\n+\n+                // Don't wait on an empty queue for too long.\n+                long s = System.nanoTime();\n+                Runnable r = tasks.poll(250_000L, TimeUnit.NANOSECONDS);", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDE0OA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984148", "bodyText": "What's with the two empty lines here...?", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:12:38Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -136,7 +256,9 @@ private void tickChunk(@Nonnull Set<BlockTicker> tickers, @Nonnull String chunk)\n         }\n     }\n \n-    private void tickLocation(@Nonnull Set<BlockTicker> tickers, @Nonnull Location l) {\n+    private void tickLocation(@Nonnull List<BlockTicker> tickers, @Nonnull Location l, @Nonnull BlockingQueue<Runnable> syncTasks) {\n+\n+", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDk4MA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984980", "bodyText": "Traces from removes debug messages", "author": "LinoxGH", "createdAt": "2020-09-05T20:23:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDE4MQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984181", "bodyText": "Why are you printing a stacktrace here...?", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:12:57Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -215,12 +341,28 @@ public void halt() {\n \n     @ParametersAreNonnullByDefault\n     public void queueMove(Location from, Location to) {\n-        movingQueue.put(from, to);\n+        // This collection is iterated over in a different thread. Need to lock it.\n+        new Throwable().printStackTrace();", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDk1Nw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984957", "bodyText": "This is from debugging. I just forgot to remove it", "author": "LinoxGH", "createdAt": "2020-09-05T20:23:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDE4NQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984185", "bodyText": "Why are you printing a stacktrace here...?", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:13:01Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -215,12 +341,28 @@ public void halt() {\n \n     @ParametersAreNonnullByDefault\n     public void queueMove(Location from, Location to) {\n-        movingQueue.put(from, to);\n+        // This collection is iterated over in a different thread. Need to lock it.\n+        new Throwable().printStackTrace();\n+        queueLock.readLock().lock();\n+        try {\n+            movingQueue.put(from, to);\n+        }\n+        finally {\n+            queueLock.readLock().unlock();\n+        }\n     }\n \n     @ParametersAreNonnullByDefault\n     public void queueDelete(Location l, boolean destroy) {\n-        deletionQueue.put(l, destroy);\n+        // This collection is iterated over in a different thread. Need to lock it.\n+        new Throwable().printStackTrace();", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDkzMg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984932", "bodyText": "Oops that's from debugging", "author": "LinoxGH", "createdAt": "2020-09-05T20:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDIxOQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483984219", "bodyText": "Also is it really sensible to re-use the same lock for moving and deleting operations?", "author": "TheBusyBiscuit", "createdAt": "2020-09-05T20:13:49Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -215,12 +341,28 @@ public void halt() {\n \n     @ParametersAreNonnullByDefault\n     public void queueMove(Location from, Location to) {\n-        movingQueue.put(from, to);\n+        // This collection is iterated over in a different thread. Need to lock it.\n+        new Throwable().printStackTrace();\n+        queueLock.readLock().lock();\n+        try {\n+            movingQueue.put(from, to);\n+        }\n+        finally {\n+            queueLock.readLock().unlock();\n+        }\n     }\n \n     @ParametersAreNonnullByDefault\n     public void queueDelete(Location l, boolean destroy) {\n-        deletionQueue.put(l, destroy);\n+        // This collection is iterated over in a different thread. Need to lock it.\n+        new Throwable().printStackTrace();\n+        queueLock.readLock().lock();\n+        try {\n+            deletionQueue.put(l, destroy);\n+        }\n+        finally {\n+            queueLock.readLock().unlock();", "originalCommit": "e682760c87cba8a9f7d5f478bdadddde6d81c918", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4OTAyMg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r483989022", "bodyText": "Since we lock and then unlock in finally blocks the lock won't be used by both of them at the same time. Also there's no need for a 2nd one.", "author": "LinoxGH", "createdAt": "2020-09-05T20:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4NDIxOQ=="}], "type": "inlineReview"}, {"oid": "e151997012265d38eca125055e36cb1399c37ca8", "url": "https://github.com/Slimefun/Slimefun4/commit/e151997012265d38eca125055e36cb1399c37ca8", "message": "Did the requested changes.", "committedDate": "2020-09-05T21:15:44Z", "type": "commit"}, {"oid": "bcecc2b989babcb8b7767f080825c26c7703e866", "url": "https://github.com/Slimefun/Slimefun4/commit/bcecc2b989babcb8b7767f080825c26c7703e866", "message": "Downdate CHANGELOG.md", "committedDate": "2020-09-05T21:17:10Z", "type": "commit"}, {"oid": "d4e6a0c66c4c83a109ad953ff44ade511db344d3", "url": "https://github.com/Slimefun/Slimefun4/commit/d4e6a0c66c4c83a109ad953ff44ade511db344d3", "message": "Add files via upload", "committedDate": "2020-09-05T21:50:45Z", "type": "commit"}, {"oid": "dbefef85dedd188e96788e7dad3dc435c8fe4788", "url": "https://github.com/Slimefun/Slimefun4/commit/dbefef85dedd188e96788e7dad3dc435c8fe4788", "message": "Did another requested change.", "committedDate": "2020-09-06T12:04:12Z", "type": "commit"}, {"oid": "27ed3dd737368044545f4cae4f0c59ce150ea56d", "url": "https://github.com/Slimefun/Slimefun4/commit/27ed3dd737368044545f4cae4f0c59ce150ea56d", "message": "Merge pull request #2 from LinoxGH/patch-3\n\nPatch 3", "committedDate": "2020-09-09T13:51:06Z", "type": "commit"}, {"oid": "c481bce699d77d820dadd4c139abdad40bff6b19", "url": "https://github.com/Slimefun/Slimefun4/commit/c481bce699d77d820dadd4c139abdad40bff6b19", "message": "Fixed a typo.", "committedDate": "2020-09-09T13:55:59Z", "type": "commit"}, {"oid": "c4f3390f2205d010b53ad68187a8337275bd604c", "url": "https://github.com/Slimefun/Slimefun4/commit/c4f3390f2205d010b53ad68187a8337275bd604c", "message": "Fixed an error occuring on disable.", "committedDate": "2020-09-11T19:54:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NTQxMQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r487265411", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!SlimefunPlugin.isEnabled()) {\n          \n          \n            \n                    if (!SlimefunPlugin.instance().isEnabled()) {", "author": "poma123", "createdAt": "2020-09-11T20:07:02Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -92,6 +92,10 @@ public final void run() {\n         if (!Bukkit.isPrimaryThread()) {\n             return;\n         }\n+        \n+        if (!SlimefunPlugin.isEnabled()) {", "originalCommit": "c4f3390f2205d010b53ad68187a8337275bd604c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxNDQ0OA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r487314448", "bodyText": "instance() is nullable. So a static isEnabled() method might be a good idea, check if it isnt null and then do the normal isEnabled call.", "author": "TheBusyBiscuit", "createdAt": "2020-09-11T22:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NTQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxNTM2NA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r487315364", "bodyText": "instance will never be null, because before we set it to null, we cancel tasks anyway.", "author": "LinoxGH", "createdAt": "2020-09-11T22:19:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NTQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTA0Mw==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r487321043", "bodyText": "Cancelling will only cancel the scheduling of new tasks, it won't terminate tasks which have already been started. And since this is running asynchronously, it may run just in time when instance is null and tasks have already been cancelled.", "author": "TheBusyBiscuit", "createdAt": "2020-09-11T22:41:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NTQxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQwNzUxMQ==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r487407511", "bodyText": "Cancelling will only cancel the scheduling of new tasks, it won't terminate tasks which have already been started. And since this is running asynchronously, it may run just in time when instance is null and tasks have already been cancelled.\n\nThis isn't run asynchronously.", "author": "LinoxGH", "createdAt": "2020-09-12T13:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzI2NTQxMQ=="}], "type": "inlineReview"}, {"oid": "657242081b7073b972ba2e9b80a37d80b0a3e17a", "url": "https://github.com/Slimefun/Slimefun4/commit/657242081b7073b972ba2e9b80a37d80b0a3e17a", "message": "Fixed build failing", "committedDate": "2020-09-11T20:22:39Z", "type": "commit"}, {"oid": "a2e6fc4b6b62ced6944588799f6acdc36bcce718", "url": "https://github.com/Slimefun/Slimefun4/commit/a2e6fc4b6b62ced6944588799f6acdc36bcce718", "message": "Better handling of tickertask on plugin disable.", "committedDate": "2020-09-11T21:32:27Z", "type": "commit"}, {"oid": "f7c21a147a9eba66697eebb24f124ffc9205c9d5", "url": "https://github.com/Slimefun/Slimefun4/commit/f7c21a147a9eba66697eebb24f124ffc9205c9d5", "message": "Oops isEnabled() isn't static.", "committedDate": "2020-09-11T21:38:45Z", "type": "commit"}, {"oid": "00312855651830f3ed317a97355114b29cc588e7", "url": "https://github.com/Slimefun/Slimefun4/commit/00312855651830f3ed317a97355114b29cc588e7", "message": "Merge pull request #5 from Slimefun/master\n\nUpdate code.", "committedDate": "2020-09-20T15:12:30Z", "type": "commit"}, {"oid": "c648d421685b1def8df05cd762961acb476a01c1", "url": "https://github.com/Slimefun/Slimefun4/commit/c648d421685b1def8df05cd762961acb476a01c1", "message": "Merge branch 'master' into TickerTask", "committedDate": "2020-09-20T15:22:42Z", "type": "commit"}, {"oid": "506a9870114687c83489d64660850102603db017", "url": "https://github.com/Slimefun/Slimefun4/commit/506a9870114687c83489d64660850102603db017", "message": "Fixed a failed merge conflict resolving.", "committedDate": "2020-09-20T15:27:25Z", "type": "commit"}, {"oid": "7c7dd45e57790caab14ba165987515f275bebe51", "url": "https://github.com/Slimefun/Slimefun4/commit/7c7dd45e57790caab14ba165987515f275bebe51", "message": "This isn't supposed to be here...", "committedDate": "2020-09-20T15:31:39Z", "type": "commit"}, {"oid": "9ec37a3c33fab299420ab644c2e743420ba626f8", "url": "https://github.com/Slimefun/Slimefun4/commit/9ec37a3c33fab299420ab644c2e743420ba626f8", "message": "Merge branch 'master' into TickerTask", "committedDate": "2020-09-22T20:20:11Z", "type": "commit"}, {"oid": "d22ef76479ea6af4473a5480359c81a77df5ff21", "url": "https://github.com/Slimefun/Slimefun4/commit/d22ef76479ea6af4473a5480359c81a77df5ff21", "message": "Merge branch 'master' into TickerTask", "committedDate": "2020-09-29T19:19:22Z", "type": "commit"}, {"oid": "4f77d40bec8ed64f96b87d09a40f67aa4b7a1867", "url": "https://github.com/Slimefun/Slimefun4/commit/4f77d40bec8ed64f96b87d09a40f67aa4b7a1867", "message": "Merge branch 'master' into TickerTask", "committedDate": "2020-10-08T12:58:41Z", "type": "commit"}, {"oid": "36fd40b7016f49897b05e074de2726eb9d1cd7b4", "url": "https://github.com/Slimefun/Slimefun4/commit/36fd40b7016f49897b05e074de2726eb9d1cd7b4", "message": "Fixed build errors.", "committedDate": "2020-10-08T13:42:49Z", "type": "commit"}, {"oid": "833859a796cc1702ec38666b5b4c1425c35f403f", "url": "https://github.com/Slimefun/Slimefun4/commit/833859a796cc1702ec38666b5b4c1425c35f403f", "message": "Some refactoring.", "committedDate": "2020-10-11T05:53:08Z", "type": "commit"}, {"oid": "8e46260d0ead3c409d82bf254346e7433959a267", "url": "https://github.com/Slimefun/Slimefun4/commit/8e46260d0ead3c409d82bf254346e7433959a267", "message": "Merge branch 'master' into TickerTask", "committedDate": "2020-10-18T02:07:00Z", "type": "commit"}, {"oid": "3b87a2c7ad989e94d0d05949e1ce74ff4b96c365", "url": "https://github.com/Slimefun/Slimefun4/commit/3b87a2c7ad989e94d0d05949e1ce74ff4b96c365", "message": "Merge branch 'master' into TickerTask", "committedDate": "2020-11-30T20:57:58Z", "type": "commit"}, {"oid": "9bbca8641d7a1e6acefa631331d89603486b809b", "url": "https://github.com/Slimefun/Slimefun4/commit/9bbca8641d7a1e6acefa631331d89603486b809b", "message": "Fixed compilation errors? I sincerely hope so...", "committedDate": "2020-12-14T21:44:12Z", "type": "commit"}, {"oid": "92adef1840394850bf009512b307cdb68d76cb49", "url": "https://github.com/Slimefun/Slimefun4/commit/92adef1840394850bf009512b307cdb68d76cb49", "message": "Reverted the changes of last couple commits.", "committedDate": "2020-12-14T21:55:45Z", "type": "commit"}, {"oid": "8e013ae6631b9f86873e0006c87e59eda1d4c947", "url": "https://github.com/Slimefun/Slimefun4/commit/8e013ae6631b9f86873e0006c87e59eda1d4c947", "message": "Added enable/disable ticker methods.", "committedDate": "2020-12-14T22:25:16Z", "type": "commit"}, {"oid": "8f7c3f5e61283fdca13c066c4af0eb8248b7ef52", "url": "https://github.com/Slimefun/Slimefun4/commit/8f7c3f5e61283fdca13c066c4af0eb8248b7ef52", "message": "Added back isReserved method.", "committedDate": "2020-12-14T22:27:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg3NjExNA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r542876114", "bodyText": ":NotLikeThis:", "author": "TheBusyBiscuit", "createdAt": "2020-12-14T22:30:46Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -333,8 +424,8 @@ public void enableTicker(@Nonnull Location l) {\n     public void disableTicker(@Nonnull Location l) {\n         Validate.notNull(l, \"Location cannot be null!\");\n \n-        ChunkPosition chunk = new ChunkPosition(l.getWorld(), l.getBlockX() >> 4, l.getBlockZ() >> 4);\n-        Set<Location> locations = tickingLocations.get(chunk);\n+        String chunk = l.getWorld().getName() + \";\" + l.getChunk().getX() + \";\" + l.getChunk().getZ();\n+        Set<Location> locations = activeTickers.get(chunk);", "originalCommit": "8f7c3f5e61283fdca13c066c4af0eb8248b7ef52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg5Mzg1Mg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r542893852", "bodyText": "I don't have time to non-fatal or beauty changes. Feel free to do it yourself though.", "author": "LinoxGH", "createdAt": "2020-12-14T22:48:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mjg3NjExNA=="}], "type": "inlineReview"}, {"oid": "b80222b6f53801a72d24469309ec1c82406dc22e", "url": "https://github.com/Slimefun/Slimefun4/commit/b80222b6f53801a72d24469309ec1c82406dc22e", "message": "Fixed compilation errors.", "committedDate": "2020-12-14T22:39:09Z", "type": "commit"}, {"oid": "fb4ee72d802fa8c8069f89013dadbeefe39491b4", "url": "https://github.com/Slimefun/Slimefun4/commit/fb4ee72d802fa8c8069f89013dadbeefe39491b4", "message": "Merge branch 'master' into TickerTask", "committedDate": "2021-01-24T18:02:17Z", "type": "commit"}, {"oid": "adcac17e7ba142873d261107a79851ae1ba3d8f2", "url": "https://github.com/Slimefun/Slimefun4/commit/adcac17e7ba142873d261107a79851ae1ba3d8f2", "message": "Fixed TickerTask implementation and re-implemented Position based logic", "committedDate": "2021-04-27T10:40:50Z", "type": "commit"}, {"oid": "0ba4fcf0d5e554f18d56af9173301f3a847dae10", "url": "https://github.com/Slimefun/Slimefun4/commit/0ba4fcf0d5e554f18d56af9173301f3a847dae10", "message": "Re-added missing method", "committedDate": "2021-04-27T10:42:17Z", "type": "commit"}, {"oid": "f78f7e2f0694b3e5df16ff177bd8c4dec5dc4b95", "url": "https://github.com/Slimefun/Slimefun4/commit/f78f7e2f0694b3e5df16ff177bd8c4dec5dc4b95", "message": "Merge branch 'master' of https://github.com/Slimefun/Slimefun4 into TickerTask", "committedDate": "2021-04-27T11:15:28Z", "type": "commit"}, {"oid": "fb3f552eaf4cd2ebe9e4558bd5761b0a2a084601", "url": "https://github.com/Slimefun/Slimefun4/commit/fb3f552eaf4cd2ebe9e4558bd5761b0a2a084601", "message": "Updated changelog", "committedDate": "2021-04-27T11:16:02Z", "type": "commit"}, {"oid": "9a78e88a991180ad8073bfe39b3adcadded470da", "url": "https://github.com/Slimefun/Slimefun4/commit/9a78e88a991180ad8073bfe39b3adcadded470da", "message": "Re-added missing Validate checks", "committedDate": "2021-04-27T11:17:49Z", "type": "commit"}, {"oid": "23ce90ac3a24cd977fdac7106ee64829209b1d36", "url": "https://github.com/Slimefun/Slimefun4/commit/23ce90ac3a24cd977fdac7106ee64829209b1d36", "message": "Refactoring", "committedDate": "2021-04-27T11:35:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTEzMjQwMg==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r621132402", "bodyText": "cant these if's be combined with &&", "author": "J3fftw1", "createdAt": "2021-04-27T11:49:32Z", "path": "src/main/java/io/github/thebusybiscuit/slimefun4/implementation/tasks/TickerTask.java", "diffHunk": "@@ -68,76 +128,162 @@ public void start(@Nonnull SlimefunPlugin plugin) {\n         this.tickRate = SlimefunPlugin.getCfg().getInt(\"URID.custom-ticker-delay\");\n \n         BukkitScheduler scheduler = plugin.getServer().getScheduler();\n-        scheduler.runTaskTimerAsynchronously(plugin, this, 100L, tickRate);\n+        scheduler.runTaskLater(plugin, this, 100L);\n     }\n \n-    /**\n-     * This method resets this {@link TickerTask} to run again.\n-     */\n-    private void reset() {\n-        running = false;\n+    @Override\n+    public final void run() {\n+        /*\n+         * This should only happen when the plugin gets disabled and the\n+         * task is already running.\n+         * Process all sync tasks before returning, blocking the main thread until\n+         * the task is complete.\n+         */\n+        if (running) {\n+            processSyncTasks();\n+            return;\n+        }\n+\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        /*\n+         * Iterate over the ticker tasks.\n+         * Process the asynchronous ones on the new thread\n+         * and queue the sync tasks to the queue.\n+         */\n+        new Thread(this::tick, \"Slimefun Async Ticker Thread\").start();\n+\n+        // Process the synchronous ticker tasks on the main thread.\n+        processSyncTasks();\n     }\n \n-    @Override\n-    public void run() {\n+    private void processSyncTasks() {\n+        if (!Bukkit.isPrimaryThread()) {\n+            return;\n+        }\n+\n+        // Let's not lag the main thread. Spikes suck. Steady time usage is much better.\n+        long endNs = System.nanoTime() + MAX_TICK_NS;\n+\n         try {\n-            // If this method is actually still running... DON'T\n-            if (running) {\n-                return;\n+            while (endNs > System.nanoTime() || !SlimefunPlugin.instance().isEnabled()) {\n+                // Don't wait on an empty queue for too long.\n+                Runnable task = syncTasks.poll(MAX_POLL_NS, TimeUnit.NANOSECONDS);\n+\n+                if (task == null) {\n+                    if (SlimefunPlugin.instance().isEnabled()) {", "originalCommit": "23ce90ac3a24cd977fdac7106ee64829209b1d36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTEzOTU2OA==", "url": "https://github.com/Slimefun/Slimefun4/pull/2290#discussion_r621139568", "bodyText": "No...", "author": "TheBusyBiscuit", "createdAt": "2021-04-27T11:59:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMTEzMjQwMg=="}], "type": "inlineReview"}, {"oid": "58fc013f4af4a1c4f1462ef89d0200ffac48ab40", "url": "https://github.com/Slimefun/Slimefun4/commit/58fc013f4af4a1c4f1462ef89d0200ffac48ab40", "message": "Added a re-useable Executor", "committedDate": "2021-04-27T12:22:27Z", "type": "commit"}]}