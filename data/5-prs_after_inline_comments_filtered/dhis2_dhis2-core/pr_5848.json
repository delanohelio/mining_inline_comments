{"pr_number": 5848, "pr_title": "feat: ProgramInstance pre-heater", "pr_createdAt": "2020-07-14T07:03:40Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5848", "timeline": [{"oid": "0a2a7f9418c217602f78eb701e251294d4919912", "url": "https://github.com/dhis2/dhis2-core/commit/0a2a7f9418c217602f78eb701e251294d4919912", "message": "feat: ProgramInstance pre-heater\n\nA new pre-heater responsible for pre-loading Program Instances for\nevents that do not have the enrollment field set.\nThe Program Instances are then evaluated during the validation stage.\n\nref: TECH-402 (https://jira.dhis2.org/browse/TECH-402)", "committedDate": "2020-07-14T07:02:09Z", "type": "commit"}, {"oid": "f3ec92fb23590e899435527adee34dc10bdc8227", "url": "https://github.com/dhis2/dhis2-core/commit/f3ec92fb23590e899435527adee34dc10bdc8227", "message": "fix: compilation error", "committedDate": "2020-07-14T09:05:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNzAyMg==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454217022", "bodyText": "typo: size -> side?", "author": "netroms", "createdAt": "2020-07-14T09:13:01Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/ProgramInstanceStore.java", "diffHunk": "@@ -138,4 +139,26 @@\n      * @param programInstance the ProgramInstance to delete.\n      */\n     void hardDelete( ProgramInstance programInstance );\n+\n+    /**\n+     * Executes a query to fetch all {@see ProgramInstance} matching the\n+     * Program/TrackedEntityInstance list.\n+     *\n+     * Resulting SQL query:\n+     *\n+     * <pre>{@code\n+     *  select programinstanceid, programid, trackedentityinstanceid\n+     *      from programinstance\n+     *      where (programid = 726 and trackedentityinstanceid = 19 and status = 'ACTIVE')\n+     *         or (programid = 726 and trackedentityinstanceid = 18 and status = 'ACTIVE')\n+     *         or (programid = 726 and trackedentityinstanceid = 17 and status = 'ACTIVE')\n+     * }</pre>\n+     *\n+     * @param programTeiPair a List of Pair, where the left size is a {@see Program}", "originalCommit": "f3ec92fb23590e899435527adee34dc10bdc8227", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyNTI2Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454225263", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-07-14T09:27:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNzAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNzMzNg==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454217336", "bodyText": "left -> right?", "author": "netroms", "createdAt": "2020-07-14T09:13:36Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/program/ProgramInstanceStore.java", "diffHunk": "@@ -138,4 +139,26 @@\n      * @param programInstance the ProgramInstance to delete.\n      */\n     void hardDelete( ProgramInstance programInstance );\n+\n+    /**\n+     * Executes a query to fetch all {@see ProgramInstance} matching the\n+     * Program/TrackedEntityInstance list.\n+     *\n+     * Resulting SQL query:\n+     *\n+     * <pre>{@code\n+     *  select programinstanceid, programid, trackedentityinstanceid\n+     *      from programinstance\n+     *      where (programid = 726 and trackedentityinstanceid = 19 and status = 'ACTIVE')\n+     *         or (programid = 726 and trackedentityinstanceid = 18 and status = 'ACTIVE')\n+     *         or (programid = 726 and trackedentityinstanceid = 17 and status = 'ACTIVE')\n+     * }</pre>\n+     *\n+     * @param programTeiPair a List of Pair, where the left size is a {@see Program}\n+     *        and the left side is a {@see TrackedEntityInstance}", "originalCommit": "f3ec92fb23590e899435527adee34dc10bdc8227", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyNTMxNg==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454225316", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-07-14T09:27:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxNzMzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxODY0Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454218646", "bodyText": "Does it make sense to send in null here? Might it be better to not allow null, since null might indicate a bug? Use checkNotNull and cast a np?", "author": "netroms", "createdAt": "2020-07-14T09:15:42Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/program/hibernate/HibernateProgramInstanceStore.java", "diffHunk": "@@ -328,6 +330,39 @@ public void hardDelete( ProgramInstance programInstance )\n         getSession().delete( programInstance );\n     }\n \n+    @Override\n+    public List<ProgramInstance> getByProgramAndTrackedEntityInstance(\n+        List<Pair<Program, TrackedEntityInstance>> programTeiPair, ProgramStatus programStatus )\n+    {\n+        if ( programTeiPair == null || programTeiPair.isEmpty() )", "originalCommit": "f3ec92fb23590e899435527adee34dc10bdc8227", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIyNjkyOQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454226929", "bodyText": "Good point, fixed", "author": "luciano-fiandesio", "createdAt": "2020-07-14T09:30:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDIxODY0Ng=="}], "type": "inlineReview"}, {"oid": "ace59d625e16c2883ac20d32f88c681d72ee3f3c", "url": "https://github.com/dhis2/dhis2-core/commit/ace59d625e16c2883ac20d32f88c681d72ee3f3c", "message": "chore: code review fixes", "committedDate": "2020-07-14T09:29:49Z", "type": "commit"}, {"oid": "ba2bbf2e07bd1f65caeb1e04dcd1ce65370c7a25", "url": "https://github.com/dhis2/dhis2-core/commit/ba2bbf2e07bd1f65caeb1e04dcd1ce65370c7a25", "message": "fix: handle NPE in preheat hook", "committedDate": "2020-07-14T09:49:22Z", "type": "commit"}, {"oid": "e62bcedaeb5c5b8c3a550e76961acb68ca002cb6", "url": "https://github.com/dhis2/dhis2-core/commit/e62bcedaeb5c5b8c3a550e76961acb68ca002cb6", "message": "chore: formatting", "committedDate": "2020-07-14T10:23:46Z", "type": "commit"}, {"oid": "d4aa7e0d126657c341427c44cb7d9b2800b044ea", "url": "https://github.com/dhis2/dhis2-core/commit/d4aa7e0d126657c341427c44cb7d9b2800b044ea", "message": "fix: use enrollment uid to fetch an enrollment", "committedDate": "2020-07-14T10:32:33Z", "type": "commit"}, {"oid": "615f9676329046c954fa4cbe07234273980b001a", "url": "https://github.com/dhis2/dhis2-core/commit/615f9676329046c954fa4cbe07234273980b001a", "message": "* refactored EventCountValidationHook.java into PreCheckDataRelationsValidationHook.java", "committedDate": "2020-07-14T12:13:08Z", "type": "commit"}, {"oid": "daa5a970e0c93301ca4cbc676731dcbb1e846fa9", "url": "https://github.com/dhis2/dhis2-core/commit/daa5a970e0c93301ca4cbc676731dcbb1e846fa9", "message": "chore: renamed method", "committedDate": "2020-07-14T12:23:22Z", "type": "commit"}, {"oid": "c07b9f0658356e7b60659651ee989460e50e1be8", "url": "https://github.com/dhis2/dhis2-core/commit/c07b9f0658356e7b60659651ee989460e50e1be8", "message": "fix: removed todo, fixed one test, ignored another", "committedDate": "2020-07-14T13:02:03Z", "type": "commit"}, {"oid": "88b69c7c9d78d6eaf767a96c9b44f18f933fa510", "url": "https://github.com/dhis2/dhis2-core/commit/88b69c7c9d78d6eaf767a96c9b44f18f933fa510", "message": "chore: removed unused import", "committedDate": "2020-07-14T13:35:22Z", "type": "commit"}, {"oid": "e7f0f0de208eea76280eb69f45d329c6ae63fc4c", "url": "https://github.com/dhis2/dhis2-core/commit/e7f0f0de208eea76280eb69f45d329c6ae63fc4c", "message": "chore: address sonarqube issue", "committedDate": "2020-07-14T14:47:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMzgyMw==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454903823", "bodyText": "key->value?", "author": "netroms", "createdAt": "2020-07-15T09:04:44Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/preheat/TrackerPreheat.java", "diffHunk": "@@ -131,10 +131,12 @@\n     private Map<TrackerIdScheme, Map<String, Relationship>> relationships = new EnumMap<>( TrackerIdScheme.class );\n \n     /**\n-     *\n+     * A Map of event uid and preheated {@see ProgramInstance}. The key is a List,", "originalCommit": "88b69c7c9d78d6eaf767a96c9b44f18f933fa510", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwNjUzOQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r454906539", "bodyText": "Fixed", "author": "luciano-fiandesio", "createdAt": "2020-07-15T09:09:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkwMzgyMw=="}], "type": "inlineReview"}, {"oid": "ba9b9d076f0497f9f456794c391f28072c0c07fd", "url": "https://github.com/dhis2/dhis2-core/commit/ba9b9d076f0497f9f456794c391f28072c0c07fd", "message": "chore: fix Javadoc", "committedDate": "2020-07-15T09:08:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ1ODEwMg==", "url": "https://github.com/dhis2/dhis2-core/pull/5848#discussion_r461458102", "bodyText": "Any reason why this is Ignored?", "author": "stian-sandvold", "createdAt": "2020-07-28T09:47:34Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/test/java/org/hisp/dhis/tracker/validation/EventImportValidationTest.java", "diffHunk": "@@ -605,6 +596,7 @@ public void testTeiNotEnrolled()\n     }\n \n     @Test\n+    @Ignore", "originalCommit": "ba9b9d076f0497f9f456794c391f28072c0c07fd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}