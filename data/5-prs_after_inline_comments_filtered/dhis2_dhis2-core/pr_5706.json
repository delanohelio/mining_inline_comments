{"pr_number": 5706, "pr_title": "feat: support enabling/disabling audit logging/database", "pr_createdAt": "2020-06-09T11:02:00Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5706", "timeline": [{"oid": "d330329bbf97a5f085497f797dd9c72f6c249613", "url": "https://github.com/dhis2/dhis2-core/commit/d330329bbf97a5f085497f797dd9c72f6c249613", "message": "fix: inject ObjectMapper instead of RenderService in TrackerAuditConsumer", "committedDate": "2020-06-09T10:14:47Z", "type": "commit"}, {"oid": "df4e9b5643741fc078a8a046e7ae5b0332efd46d", "url": "https://github.com/dhis2/dhis2-core/commit/df4e9b5643741fc078a8a046e7ae5b0332efd46d", "message": "fix: adds configuration props for enabling/disabling logging/persistence  in the audit consumer", "committedDate": "2020-06-09T10:23:23Z", "type": "commit"}, {"oid": "5bb37d3f1d2459e2fe6f394d3f420eecc3d244db", "url": "https://github.com/dhis2/dhis2-core/commit/5bb37d3f1d2459e2fe6f394d3f420eecc3d244db", "message": "feat: support enabling disabling globally audit logging/database", "committedDate": "2020-06-09T11:00:25Z", "type": "commit"}, {"oid": "743a972292ebcb8f10e4cea8d1e2257346c2e14a", "url": "https://github.com/dhis2/dhis2-core/commit/743a972292ebcb8f10e4cea8d1e2257346c2e14a", "message": "fix: don't serialize audit data if its already string", "committedDate": "2020-06-09T11:04:06Z", "type": "commit"}, {"oid": "e81410ef4253a987d34850ae01946a91288c9bd3", "url": "https://github.com/dhis2/dhis2-core/commit/e81410ef4253a987d34850ae01946a91288c9bd3", "message": "chore: clean up old audit logger configuration", "committedDate": "2020-06-09T11:14:36Z", "type": "commit"}, {"oid": "0315ee2cc73a336a794dc3e8ba6a0786c431f424", "url": "https://github.com/dhis2/dhis2-core/commit/0315ee2cc73a336a794dc3e8ba6a0786c431f424", "message": "refactor: move out common pieces from AuditConsumers into AbstractAuditConsumer, moves consumers from legacy to consumers package", "committedDate": "2020-06-09T12:35:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3ODYyNA==", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437378624", "bodyText": "Use DhisConfigurationProvider#isEnabled to check if \"on\".", "author": "larshelge", "createdAt": "2020-06-09T12:37:28Z", "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/AggregateAuditConsumer.java", "diffHunk": "@@ -28,38 +28,42 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import com.fasterxml.jackson.annotation.JsonProperty;\n-import com.fasterxml.jackson.dataformat.xml.annotation.JacksonXmlProperty;\n-import com.fasterxml.jackson.dataformat.xml.annotation.JacksonXmlRootElement;\n-import org.hisp.dhis.common.DxfNamespaces;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import lombok.extern.slf4j.Slf4j;\n+import org.hisp.dhis.artemis.Topics;\n+import org.hisp.dhis.audit.AbstractAuditConsumer;\n+import org.hisp.dhis.audit.AuditService;\n+import org.hisp.dhis.external.conf.ConfigurationKey;\n+import org.hisp.dhis.external.conf.DhisConfigurationProvider;\n+import org.springframework.jms.annotation.JmsListener;\n+import org.springframework.stereotype.Component;\n+\n+import javax.jms.TextMessage;\n+import java.util.Objects;\n \n /**\n- * @author Morten Olav Hansen <mortenoh@gmail.com>\n+ * A Aggregate object consumer.\n  */\n-@JacksonXmlRootElement( localName = \"metadataAudit\", namespace = DxfNamespaces.DXF_2_0 )\n-public class MetadataAudit\n+@Slf4j\n+@Component\n+public class AggregateAuditConsumer\n+    extends AbstractAuditConsumer\n {\n-    private boolean log;\n-\n-    public MetadataAudit()\n-    {\n-    }\n-\n-    public MetadataAudit( boolean log )\n+    public AggregateAuditConsumer(\n+        AuditService auditService,\n+        ObjectMapper objectMapper,\n+        DhisConfigurationProvider dhisConfig )\n     {\n-        this.log = log;\n-    }\n+        this.auditService = auditService;\n+        this.objectMapper = objectMapper;\n \n-    @JsonProperty\n-    @JacksonXmlProperty( namespace = DxfNamespaces.DXF_2_0 )\n-    public boolean isLog()\n-    {\n-        return log;\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"on\" );", "originalCommit": "0315ee2cc73a336a794dc3e8ba6a0786c431f424", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM3ODczOA==", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437378738", "bodyText": "Use DhisConfigurationProvider#isEnabled to check if \"on\".", "author": "larshelge", "createdAt": "2020-06-09T12:37:40Z", "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/MetadataAuditConsumer.java", "diffHunk": "@@ -67,42 +59,13 @@ public MetadataAuditConsumer(\n         this.auditService = auditService;\n         this.objectMapper = objectMapper;\n \n-        this.metadataAuditLog = Objects.equals( dhisConfig.getProperty( ConfigurationKey.METADATA_AUDIT_LOG ), \"on\" );\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"on\" );", "originalCommit": "0315ee2cc73a336a794dc3e8ba6a0786c431f424", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "05c71549b5646dddf2658a07fbec83d61e98d691", "url": "https://github.com/dhis2/dhis2-core/commit/05c71549b5646dddf2658a07fbec83d61e98d691", "message": "fix: use dhisConfig.isEnabled(..) to check audit logging/database config", "committedDate": "2020-06-09T12:45:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzM5MzEzOA==", "url": "https://github.com/dhis2/dhis2-core/pull/5706#discussion_r437393138", "bodyText": "Use getPropertyOrDefault.", "author": "larshelge", "createdAt": "2020-06-09T12:59:02Z", "path": "dhis-2/dhis-services/dhis-service-audit-consumer/src/main/java/org/hisp/dhis/audit/consumers/TrackerAuditConsumer.java", "diffHunk": "@@ -28,60 +28,43 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import java.io.IOException;\n-\n-import javax.jms.TextMessage;\n-\n+import com.fasterxml.jackson.databind.ObjectMapper;\n import org.hisp.dhis.artemis.Topics;\n-import org.hisp.dhis.artemis.audit.Audit;\n-import org.hisp.dhis.audit.AuditConsumer;\n+import org.hisp.dhis.audit.AbstractAuditConsumer;\n import org.hisp.dhis.audit.AuditService;\n-import org.hisp.dhis.render.RenderService;\n+import org.hisp.dhis.external.conf.ConfigurationKey;\n+import org.hisp.dhis.external.conf.DhisConfigurationProvider;\n import org.springframework.jms.annotation.JmsListener;\n import org.springframework.stereotype.Component;\n \n-import lombok.extern.slf4j.Slf4j;\n+import javax.jms.TextMessage;\n+import java.util.Objects;\n \n /**\n- * Tracker audits consumer.\n+ * Tracker audit consumer.\n  *\n  * @author Morten Olav Hansen <morten@dhis2.org>\n  */\n-@Slf4j\n @Component\n-public class TrackerAuditConsumer implements AuditConsumer\n+public class TrackerAuditConsumer\n+    extends AbstractAuditConsumer\n {\n-    private final AuditService auditService;\n-    private final RenderService renderService;\n-\n     public TrackerAuditConsumer(\n-        AuditService auditService, RenderService renderService )\n+        AuditService auditService,\n+        ObjectMapper objectMapper,\n+        DhisConfigurationProvider dhisConfig )\n     {\n         this.auditService = auditService;\n-        this.renderService = renderService;\n+        this.objectMapper = objectMapper;\n+\n+        // for legacy reasons we are overriding the default here and using \"off\" for tracking logger (we don't have a specific key for tracker logger)\n+        this.isAuditLogEnabled = Objects.equals( dhisConfig.getProperty( ConfigurationKey.AUDIT_LOGGER ), \"off\" );", "originalCommit": "05c71549b5646dddf2658a07fbec83d61e98d691", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "87c995ba7271660e8c5aff271cff7ac7848ac25c", "url": "https://github.com/dhis2/dhis2-core/commit/87c995ba7271660e8c5aff271cff7ac7848ac25c", "message": "fix: use getPropertyOrDefault to enable/disable audit log for tracker", "committedDate": "2020-06-09T12:59:05Z", "type": "commit"}]}