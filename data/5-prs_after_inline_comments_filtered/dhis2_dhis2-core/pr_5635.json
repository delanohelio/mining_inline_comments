{"pr_number": 5635, "pr_title": "fix: block deletion of DE used in report tables [DHIS2-7043]", "pr_createdAt": "2020-05-25T10:28:08Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5635", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEwMjg0Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5635#discussion_r433102847", "bodyText": "Here we get all data dimensions with dependencies.", "author": "enricocolasante", "createdAt": "2020-06-01T08:20:21Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/common/BaseAnalyticalObject.java", "diffHunk": "@@ -273,7 +277,8 @@ public boolean removeDataDimensionItem( DimensionalItemObject object )\n     {\n         if ( object != null && DataDimensionItem.DATA_DIMENSION_CLASSES.contains( object.getClass() ) )\n         {\n-            return dataDimensionItems.remove( DataDimensionItem.create( object ) );\n+            return dataDimensionItems\n+                .removeAll( DataDimensionItem.createWithDependencies( object, dataDimensionItems ) );", "originalCommit": "3d990c37ddeded10fc8f6147f54f23628460ada3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "91712ca8bf9fd690be0d3dbafbcab465a5dbe57b", "url": "https://github.com/dhis2/dhis2-core/commit/91712ca8bf9fd690be0d3dbafbcab465a5dbe57b", "message": "fix: delete data element operandd from data dimension when deleting DE", "committedDate": "2020-06-01T08:23:18Z", "type": "forcePushed"}, {"oid": "9556607baac10be974791520ba55cb9a6ce53138", "url": "https://github.com/dhis2/dhis2-core/commit/9556607baac10be974791520ba55cb9a6ce53138", "message": "fix: block deletion of DE used in report tables [DHIS2-7043]", "committedDate": "2020-06-11T13:21:00Z", "type": "commit"}, {"oid": "a02eb950c044ed06805c01701c5397edf3f3070e", "url": "https://github.com/dhis2/dhis2-core/commit/a02eb950c044ed06805c01701c5397edf3f3070e", "message": "fix: delete data element operandd from data dimension when deleting DE", "committedDate": "2020-06-11T13:21:32Z", "type": "commit"}, {"oid": "e68011d285cf644f6fe4442c9091cd4b4da93e7d", "url": "https://github.com/dhis2/dhis2-core/commit/e68011d285cf644f6fe4442c9091cd4b4da93e7d", "message": "Rename flyway script with free id", "committedDate": "2020-06-11T13:22:33Z", "type": "commit"}, {"oid": "e68011d285cf644f6fe4442c9091cd4b4da93e7d", "url": "https://github.com/dhis2/dhis2-core/commit/e68011d285cf644f6fe4442c9091cd4b4da93e7d", "message": "Rename flyway script with free id", "committedDate": "2020-06-11T13:22:33Z", "type": "forcePushed"}, {"oid": "5b966af64027e61ef6d63fce90c4cf49d1c20803", "url": "https://github.com/dhis2/dhis2-core/commit/5b966af64027e61ef6d63fce90c4cf49d1c20803", "message": "Remove manual saving of data element operand in importer", "committedDate": "2020-06-17T14:11:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNzA5Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/5635#discussion_r441607096", "bodyText": "@vietnguyen In order to make the deletion work, we need to remove this save.\nIs this going to create any other problem?", "author": "enricocolasante", "createdAt": "2020-06-17T14:52:18Z", "path": "dhis-2/dhis-services/dhis-service-dxf2/src/main/java/org/hisp/dhis/dxf2/metadata/DefaultAnalyticalObjectImportHandler.java", "diffHunk": "@@ -84,7 +84,6 @@ private void handleDataDimensionItems( Session session, Schema schema, BaseAnaly\n             if ( dataDimensionItem.getDataElementOperand() != null )\n             {\n                 preheatService.connectReferences( dataDimensionItem.getDataElementOperand(), bundle.getPreheat(), bundle.getPreheatIdentifier() );", "originalCommit": "5b966af64027e61ef6d63fce90c4cf49d1c20803", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjE4NTgxMg==", "url": "https://github.com/dhis2/dhis2-core/pull/5635#discussion_r442185812", "bodyText": "@enricocolasante  I'm not sure, this code has been in the class AnalyticObjectBundleHook  for a long time before it was moved to DefaultAnalyticObjectImportHandle so that it can be reused in different places.\nI guess removing this save function would cause issues for the importer. Because DataElementOperand  is EmbeddedObject.\nYou can try and check if this test is ok  ( need to add some more asserts to check if the dataElementOperands are imported correctly ) MetadataImportServiceTest.testImportEmbeddedObjectWithSkipSharingIsTrue", "author": "vietnguyen", "createdAt": "2020-06-18T12:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNzA5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjIwMTEwMg==", "url": "https://github.com/dhis2/dhis2-core/pull/5635#discussion_r442201102", "bodyText": "I updated the test and the import works correctly.\nDataElemenentOperand is an embedded object but in in this case is not treated as one because of the hibernate mapping.", "author": "enricocolasante", "createdAt": "2020-06-18T12:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwNzA5Ng=="}], "type": "inlineReview"}, {"oid": "38e7287c827bb0c33cc06308e90dbea399c026a4", "url": "https://github.com/dhis2/dhis2-core/commit/38e7287c827bb0c33cc06308e90dbea399c026a4", "message": "Merge remote-tracking branch 'origin/master' into DHIS2-7043", "committedDate": "2020-06-18T07:20:30Z", "type": "commit"}, {"oid": "f8d19281dab0c4804f93e57310bc17df227fbdf2", "url": "https://github.com/dhis2/dhis2-core/commit/f8d19281dab0c4804f93e57310bc17df227fbdf2", "message": "Add test to verify that operand is imported correctly", "committedDate": "2020-06-18T12:48:34Z", "type": "commit"}]}