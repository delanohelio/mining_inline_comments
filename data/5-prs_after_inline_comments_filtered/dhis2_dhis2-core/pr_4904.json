{"pr_number": 4904, "pr_title": "fix: (2.33.2) Malformed Image on download from data entry", "pr_createdAt": "2020-02-20T12:31:44Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/4904", "timeline": [{"oid": "7cc989f86fb3d7a889ba255f4f663b465db7a268", "url": "https://github.com/dhis2/dhis2-core/commit/7cc989f86fb3d7a889ba255f4f663b465db7a268", "message": "fix: Malformed Image on download from data entry", "committedDate": "2020-02-20T12:29:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3ODI1MA==", "url": "https://github.com/dhis2/dhis2-core/pull/4904#discussion_r381978250", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            response.setContentLength((int)contentLength);\n          \n          \n            \n                            response.setContentLength( (int)contentLength );", "author": "stian-sandvold", "createdAt": "2020-02-20T12:50:10Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/DataValueController.java", "diffHunk": "@@ -576,9 +576,16 @@ public void getDataValueFile(\n         setNoStore( response );\n         try\n         {\n-            InputStream file = fileResourceService.getFileResourceContent( fileResource );\n-            response.setContentLength( file.available() );\n-            IOUtils.copy( file, response.getOutputStream() );\n+            long contentLength = fileResourceService.copyFileResourceContent( fileResource, response.getOutputStream() );\n+\n+            if ( contentLength <= Integer.MAX_VALUE )\n+            {\n+                response.setContentLength((int)contentLength);", "originalCommit": "7cc989f86fb3d7a889ba255f4f663b465db7a268", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3ODM1OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/4904#discussion_r381978359", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            response.addHeader(\"Content-Length\", Long.toString(contentLength));\n          \n          \n            \n                            response.addHeader( \"Content-Length\", Long.toString( contentLength ) );", "author": "stian-sandvold", "createdAt": "2020-02-20T12:50:23Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/DataValueController.java", "diffHunk": "@@ -576,9 +576,16 @@ public void getDataValueFile(\n         setNoStore( response );\n         try\n         {\n-            InputStream file = fileResourceService.getFileResourceContent( fileResource );\n-            response.setContentLength( file.available() );\n-            IOUtils.copy( file, response.getOutputStream() );\n+            long contentLength = fileResourceService.copyFileResourceContent( fileResource, response.getOutputStream() );\n+\n+            if ( contentLength <= Integer.MAX_VALUE )\n+            {\n+                response.setContentLength((int)contentLength);\n+            }\n+            else\n+            {\n+                response.addHeader(\"Content-Length\", Long.toString(contentLength));", "originalCommit": "7cc989f86fb3d7a889ba255f4f663b465db7a268", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3da88475e96d8686ab3f8ac3f74f458767c04846", "url": "https://github.com/dhis2/dhis2-core/commit/3da88475e96d8686ab3f8ac3f74f458767c04846", "message": "Update dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/DataValueController.java\n\nCo-Authored-By: Stian Sandvold <stian@dhis2.org>", "committedDate": "2020-02-20T12:54:18Z", "type": "commit"}, {"oid": "f77cad4f5c6396fdce53ba4037ff46f18cdfe1fd", "url": "https://github.com/dhis2/dhis2-core/commit/f77cad4f5c6396fdce53ba4037ff46f18cdfe1fd", "message": "Update dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/DataValueController.java\n\nCo-Authored-By: Stian Sandvold <stian@dhis2.org>", "committedDate": "2020-02-20T12:54:28Z", "type": "commit"}]}