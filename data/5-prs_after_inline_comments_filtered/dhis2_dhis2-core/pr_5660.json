{"pr_number": 5660, "pr_title": "feat: (DHIS2-7734) add parameter to restrict associated orgunits to strictly capture scope for categoryOptions [master]", "pr_createdAt": "2020-06-03T14:47:28Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5660", "timeline": [{"oid": "a976635667071290a69759a8783d5fee835d4214", "url": "https://github.com/dhis2/dhis2-core/commit/a976635667071290a69759a8783d5fee835d4214", "message": "Initial Commit", "committedDate": "2020-04-30T21:02:40Z", "type": "commit"}, {"oid": "cd6b1ba1ed54040af273910c15e72f415163c7b5", "url": "https://github.com/dhis2/dhis2-core/commit/cd6b1ba1ed54040af273910c15e72f415163c7b5", "message": "Merge branch 'master' into DHIS2-7734-master", "committedDate": "2020-05-06T08:50:22Z", "type": "commit"}, {"oid": "d78a1bba5966855727da2f24d5b2b15cf93a2a65", "url": "https://github.com/dhis2/dhis2-core/commit/d78a1bba5966855727da2f24d5b2b15cf93a2a65", "message": "Add org unit childrens as well", "committedDate": "2020-05-07T08:11:53Z", "type": "commit"}, {"oid": "e9234771d6e16afc26368e9ef24d149facb64e1f", "url": "https://github.com/dhis2/dhis2-core/commit/e9234771d6e16afc26368e9ef24d149facb64e1f", "message": "Merge branch 'master' into DHIS2-7734-master", "committedDate": "2020-05-14T09:43:00Z", "type": "commit"}, {"oid": "fa8f184fb48f792e62456fc8750808e3a9e7490c", "url": "https://github.com/dhis2/dhis2-core/commit/fa8f184fb48f792e62456fc8750808e3a9e7490c", "message": "Modified to use single disjunction for org unit filtering in Query object", "committedDate": "2020-06-02T08:36:38Z", "type": "commit"}, {"oid": "b0786be0827d217affbdf665e64ffbd34e93c288", "url": "https://github.com/dhis2/dhis2-core/commit/b0786be0827d217affbdf665e64ffbd34e93c288", "message": "Added postprocessing method to remove associated orgunits that are not part of the capture scope", "committedDate": "2020-06-03T01:07:16Z", "type": "commit"}, {"oid": "5b9716af3570710ca93cf087045f257e75386063", "url": "https://github.com/dhis2/dhis2-core/commit/5b9716af3570710ca93cf087045f257e75386063", "message": "Merge branch 'master' into DHIS2-7734-master", "committedDate": "2020-06-03T01:07:42Z", "type": "commit"}, {"oid": "96e287bccf434c9ea28e661e8a074ae6d87e9ea9", "url": "https://github.com/dhis2/dhis2-core/commit/96e287bccf434c9ea28e661e8a074ae6d87e9ea9", "message": "Merge branch 'master' into DHIS2-7734-master", "committedDate": "2020-06-03T14:44:59Z", "type": "commit"}, {"oid": "580abb0f5c5a1e5008b9b9adb14ff5d836117272", "url": "https://github.com/dhis2/dhis2-core/commit/580abb0f5c5a1e5008b9b9adb14ff5d836117272", "message": "fix cognitive complexity suggested by sonar", "committedDate": "2020-06-03T17:44:01Z", "type": "commit"}, {"oid": "6819948e5a32550eb475e601f0c25d3c55be59ce", "url": "https://github.com/dhis2/dhis2-core/commit/6819948e5a32550eb475e601f0c25d3c55be59ce", "message": "Merge branch 'master' into DHIS2-7734-master", "committedDate": "2020-06-09T17:16:38Z", "type": "commit"}, {"oid": "99e2ef4fcc318842a51b513c77c719dcf3c04d62", "url": "https://github.com/dhis2/dhis2-core/commit/99e2ef4fcc318842a51b513c77c719dcf3c04d62", "message": "Modified parameter name to restrictToCaptureScope", "committedDate": "2020-06-09T19:03:18Z", "type": "commit"}, {"oid": "df7e833723de17cae5cb43a28418294f4a1579df", "url": "https://github.com/dhis2/dhis2-core/commit/df7e833723de17cae5cb43a28418294f4a1579df", "message": "Minor sonar qube fix", "committedDate": "2020-06-09T19:25:10Z", "type": "commit"}, {"oid": "d18b91b4aca797abf549266ded716841b9c11ab8", "url": "https://github.com/dhis2/dhis2-core/commit/d18b91b4aca797abf549266ded716841b9c11ab8", "message": "fix cached count when restrictToCaptureScope parameter is added", "committedDate": "2020-06-10T08:16:30Z", "type": "commit"}, {"oid": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "url": "https://github.com/dhis2/dhis2-core/commit/022d31468958ca980b23e573cabe0cd8ce7c8c9e", "message": "Merge branch 'master' into DHis2-7734-master", "committedDate": "2020-06-10T08:16:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NjYxMA==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986610", "bodyText": "style, space in paranthesis", "author": "stian-sandvold", "createdAt": "2020-06-10T09:25:42Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();\n \n+            if ( user != null )\n+            {\n+                handleCaptureScopeOuFiltering( schema, user, query.addDisjunction() );\n+            }\n+        }\n         return query;\n     }\n \n+    private void handleCaptureScopeOuFiltering(Schema schema, User user, Disjunction disjunction)", "originalCommit": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4Njc2Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986767", "bodyText": "style, space in paranthesis", "author": "stian-sandvold", "createdAt": "2020-06-10T09:25:56Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryService.java", "diffHunk": "@@ -117,7 +117,13 @@ public Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order>\n     @Override\n     public Query getQueryFromUrl(Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Junction.Type rootJunction ) throws QueryParserException\n     {\n-        Query query = queryParser.parse( klass, filters, rootJunction );\n+        return getQueryFromUrl( klass, filters, orders, pagination, rootJunction, false );\n+    }\n+\n+    @Override\n+    public Query getQueryFromUrl(Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Junction.Type rootJunction, boolean restrictToCaptureScope ) throws QueryParserException", "originalCommit": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4Njk1Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437986956", "bodyText": "Too much space in paranthesis", "author": "stian-sandvold", "createdAt": "2020-06-10T09:26:14Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryParser.java", "diffHunk": "@@ -58,4 +60,7 @@\n     Property getProperty( Schema schema, String path ) throws QueryParserException;\n \n     Restriction getRestriction( Schema schema, String path, String operator, Object arg ) throws QueryParserException;\n+\n+    Query parse( Class<?> klass, List<String> filters, Type rootJunction, boolean restrictToCaptureScope  )", "originalCommit": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzk4NzA5MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r437987091", "bodyText": "Too much space in paranthesis", "author": "stian-sandvold", "createdAt": "2020-06-10T09:26:27Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/QueryService.java", "diffHunk": "@@ -80,4 +81,7 @@\n     Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination) throws QueryParserException;\n \n     Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders ) throws QueryParserException;\n+\n+    Query getQueryFromUrl( Class<?> klass, List<String> filters, List<Order> orders, Pagination pagination, Type rootJunction, boolean restrictToCaptureScope  )", "originalCommit": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NTIzMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r438075231", "bodyText": "Try not to have too many levels of nesting, if the option is not there, you can quickly jump out", "author": "mortenoh", "createdAt": "2020-06-10T12:15:23Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/category/CategoryOptionController.java", "diffHunk": "@@ -39,7 +50,41 @@\n  */\n @Controller\n @RequestMapping( value = CategoryOptionSchemaDescriptor.API_ENDPOINT )\n-public class CategoryOptionController\n-    extends AbstractCrudController<CategoryOption>\n+public class CategoryOptionController extends AbstractCrudController<CategoryOption>\n {\n+    @Autowired\n+    private CurrentUserService currentUserService;\n+\n+    @Autowired\n+    private OrganisationUnitService organisationUnitService;\n+\n+    @Override\n+    protected void postProcessResponseEntities( List<CategoryOption> entityList, WebOptions options, Map<String, String> parameters )\n+    {\n+\n+        if ( \"true\".equalsIgnoreCase( options.getOptions().get( \"restrictToCaptureScope\" ) ) )", "originalCommit": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcxNTQyMg==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440715422", "bodyText": "Isnt that happening here? if the option doesnt exist or is false, the control flow doesnt get into the if construct and jumps out. Is that OK?", "author": "ameenhere", "createdAt": "2020-06-16T09:30:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NTIzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2OTEzNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440769135", "bodyText": "I mean, if you jump (return) out immediately, you don't need to nest the next lines", "author": "mortenoh", "createdAt": "2020-06-16T11:07:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3NTIzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTUxNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r438085515", "bodyText": "Isn't the user already available in query.getUser() ? why do you need to refetch current user here?", "author": "mortenoh", "createdAt": "2020-06-10T12:33:38Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/query/DefaultQueryParser.java", "diffHunk": "@@ -97,10 +118,34 @@ public Query parse( Class<?> klass, List<String> filters, Junction.Type rootJunc\n                 query.add( getRestriction( schema, split[0], split[1], null ) );\n             }\n         }\n+        \n+        if ( restrictToCaptureScope && schema.haveProperty( ORGANISATION_UNITS ) )\n+        {\n+            User user = currentUserService.getCurrentUser();", "originalCommit": "022d31468958ca980b23e573cabe0cd8ce7c8c9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDcwMTgyMw==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440701823", "bodyText": "Not at this point. This is the part where the Query object is created. The user is yet to be injected into it. But we can add it to the Query object here then if that makes more sense?", "author": "ameenhere", "createdAt": "2020-06-16T09:07:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDc2ODMxOQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5660#discussion_r440768319", "bodyText": "Ok, thats fine then, just leave it as it is", "author": "mortenoh", "createdAt": "2020-06-16T11:05:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA4NTUxNQ=="}], "type": "inlineReview"}, {"oid": "4cf00ee5b174ec74708f8cce5fac9d8fe4e8b0d8", "url": "https://github.com/dhis2/dhis2-core/commit/4cf00ee5b174ec74708f8cce5fac9d8fe4e8b0d8", "message": "Merge branch 'master' into DHIS2-7734-master", "committedDate": "2020-06-16T09:05:37Z", "type": "commit"}, {"oid": "088618a8dfdc274fce82a5f19da6ce2fa83a83a5", "url": "https://github.com/dhis2/dhis2-core/commit/088618a8dfdc274fce82a5f19da6ce2fa83a83a5", "message": "Added review comment changes", "committedDate": "2020-06-16T09:25:41Z", "type": "commit"}, {"oid": "355d662b2da1f5c6ae05cda4a84ce1abb7677d19", "url": "https://github.com/dhis2/dhis2-core/commit/355d662b2da1f5c6ae05cda4a84ce1abb7677d19", "message": "Merge branch 'master' into DHIS2-7734-master", "committedDate": "2020-06-16T10:53:13Z", "type": "commit"}, {"oid": "3232f1830749a3488a635de4b6fb08079e91a754", "url": "https://github.com/dhis2/dhis2-core/commit/3232f1830749a3488a635de4b6fb08079e91a754", "message": "Review comments", "committedDate": "2020-06-16T12:46:25Z", "type": "commit"}]}