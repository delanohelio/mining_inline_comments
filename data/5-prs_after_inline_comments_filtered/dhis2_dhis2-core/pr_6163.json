{"pr_number": 6163, "pr_title": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it", "pr_createdAt": "2020-09-16T15:14:10Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6163", "timeline": [{"oid": "3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "url": "https://github.com/dhis2/dhis2-core/commit/3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "message": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it", "committedDate": "2020-09-16T15:15:09Z", "type": "commit"}, {"oid": "3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "url": "https://github.com/dhis2/dhis2-core/commit/3fa0c8c4ae3128efe8e03f4dbc68655bdda42964", "message": "fix: [DHIS2-9023] Block programStage deletion when a program rule is linked to it", "committedDate": "2020-09-16T15:15:09Z", "type": "forcePushed"}, {"oid": "6f752745e476d1421f775ef5044315ab564d954a", "url": "https://github.com/dhis2/dhis2-core/commit/6f752745e476d1421f775ef5044315ab564d954a", "message": "Fix sonar code smells", "committedDate": "2020-09-16T15:45:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjA0MA==", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492556040", "bodyText": "Minor: Might be slightly more compact and avoid to stream twice, like this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Override\n          \n          \n            \n                public String allowDeleteProgramStage( ProgramStage programStage )\n          \n          \n            \n                {\n          \n          \n            \n                    List<ProgramRule> programRuleVariables = programRuleService\n          \n          \n            \n                        .getProgramRule( programStage.getProgram() )\n          \n          \n            \n                        .stream()\n          \n          \n            \n                        .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n          \n          \n            \n                        .collect( Collectors.toList() );\n          \n          \n            \n            \n          \n          \n            \n                    if ( programRuleVariables.isEmpty() )\n          \n          \n            \n                    {\n          \n          \n            \n                        return null;\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    return programRuleVariables.stream()\n          \n          \n            \n                        .map( BaseIdentifiableObject::getName )\n          \n          \n            \n                        .collect( Collectors.joining( \", \" ) );\n          \n          \n            \n                }\n          \n          \n            \n                @Override\n          \n          \n            \n                public String allowDeleteProgramStage( ProgramStage programStage )\n          \n          \n            \n                {\n          \n          \n            \n                    String programRuleVariables = programRuleService\n          \n          \n            \n                        .getProgramRule( programStage.getProgram() )\n          \n          \n            \n                        .stream()\n          \n          \n            \n                        .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n          \n          \n            \n                        .map( BaseIdentifiableObject::getName )\n          \n          \n            \n                        .collect( Collectors.joining( \", \" ) );\n          \n          \n            \n            \n          \n          \n            \n                    return StringUtils.isBlank( programRuleVariables ) ? null : programRuleVariables;\n          \n          \n            \n                }", "author": "gnespolino", "createdAt": "2020-09-22T08:23:26Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleDeletionHandler.java", "diffHunk": "@@ -72,4 +78,31 @@ public void deleteProgram( Program program )\n             programRuleService.deleteProgramRule( programRule );\n         }\n     }\n+\n+    @Override\n+    public String allowDeleteProgramStage( ProgramStage programStage )\n+    {\n+        List<ProgramRule> programRuleVariables = programRuleService\n+            .getProgramRule( programStage.getProgram() )\n+            .stream()\n+            .filter( pr -> isLinkedToProgramStage( programStage, pr ) )\n+            .collect( Collectors.toList() );\n+\n+        if ( programRuleVariables.isEmpty() )\n+        {\n+            return null;\n+        }\n+\n+        return programRuleVariables.stream()\n+            .map( BaseIdentifiableObject::getName )\n+            .collect( Collectors.joining( \", \" ) );\n+    }", "originalCommit": "6f752745e476d1421f775ef5044315ab564d954a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjU2NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492556565", "bodyText": "Same comment as before.", "author": "gnespolino", "createdAt": "2020-09-22T08:24:18Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleVariableDeletionHandler.java", "diffHunk": "@@ -61,6 +67,25 @@ protected String getClassName()\n     {\n         return ProgramRuleVariable.class.getSimpleName();\n     }\n+\n+    @Override\n+    public String allowDeleteProgramStage( ProgramStage programStage )\n+    {\n+        List<ProgramRuleVariable> programRuleVariables = programRuleVariableService\n+            .getProgramRuleVariable( programStage.getProgram() )\n+            .stream()\n+            .filter( prv -> Objects.equals( prv.getProgramStage(), programStage ) )\n+            .collect( Collectors.toList() );\n+\n+        if ( programRuleVariables.isEmpty() )\n+        {\n+            return null;\n+        }\n+\n+        return programRuleVariables.stream()\n+            .map( BaseIdentifiableObject::getName )\n+            .collect( Collectors.joining( \", \" ) );\n+    }", "originalCommit": "6f752745e476d1421f775ef5044315ab564d954a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MDA0MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6163#discussion_r492570041", "bodyText": "Done", "author": "enricocolasante", "createdAt": "2020-09-22T08:45:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU1NjU2NQ=="}], "type": "inlineReview"}, {"oid": "4bef0e4db734072ae447ebb1758a099f600f8c23", "url": "https://github.com/dhis2/dhis2-core/commit/4bef0e4db734072ae447ebb1758a099f600f8c23", "message": "Update dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/ProgramRuleDeletionHandler.java\n\nCo-authored-by: Giuseppe Nespolino <gnespolino@users.noreply.github.com>", "committedDate": "2020-09-22T08:28:22Z", "type": "commit"}, {"oid": "06026774dfacdce202d249e63bb053ffc9937111", "url": "https://github.com/dhis2/dhis2-core/commit/06026774dfacdce202d249e63bb053ffc9937111", "message": "Code review fixes", "committedDate": "2020-09-22T08:44:24Z", "type": "commit"}]}