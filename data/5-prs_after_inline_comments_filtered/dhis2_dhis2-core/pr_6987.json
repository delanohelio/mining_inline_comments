{"pr_number": 6987, "pr_title": "Dhis2 10093  - New Tracker Importer GET endpoints", "pr_createdAt": "2020-12-23T17:57:48Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6987", "timeline": [{"oid": "fb5bcfdf60cc39a5d13b984cedcb461910a04605", "url": "https://github.com/dhis2/dhis2-core/commit/fb5bcfdf60cc39a5d13b984cedcb461910a04605", "message": "feat: DHIS2-10093 renamed TrackerController.java", "committedDate": "2020-12-23T13:05:57Z", "type": "commit"}, {"oid": "b6e78bbee1408e66562e0cc25ca0699e313b2fbb", "url": "https://github.com/dhis2/dhis2-core/commit/b6e78bbee1408e66562e0cc25ca0699e313b2fbb", "message": "feat: DHIS2-10093 added mappers, GET /tracker and GET /tracker/{id} endpoints", "committedDate": "2020-12-23T17:54:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcxNjU5Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r549716592", "bodyText": "I wonder if we could \"merge\" this interface with org.hisp.dhis.tracker.preheat.mappers.PreheatMapper. Perhaps one interface named TrackerEntityMapper. These two interfaces now are doing more or less the same thing.", "author": "luciano-fiandesio", "createdAt": "2020-12-29T14:05:27Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/domain/mapper/DomainMapper.java", "diffHunk": "@@ -0,0 +1,45 @@\n+package org.hisp.dhis.tracker.domain.mapper;\n+\n+/*\n+ *  Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ *  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ *  ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ *  WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ *  DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ *  ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ *  (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ *  LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ *  ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ *  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ *  SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ *\n+ */\n+\n+import java.util.Collection;\n+import java.util.stream.Collectors;\n+\n+public interface DomainMapper<FROM, TO>", "originalCommit": "b6e78bbee1408e66562e0cc25ca0699e313b2fbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5Mzg5Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r551293893", "bodyText": "PreheatMapper has one only generic \"T\", while in these cases we need 2 <FROM, TO>. Maybe we might say that a PreheatMapper is just a DomainMapper<T, T>.", "author": "gnespolino", "createdAt": "2021-01-04T12:40:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcxNjU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcxOTE4Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r549719183", "bodyText": "You can remove these two exceptions: no longer thrown", "author": "luciano-fiandesio", "createdAt": "2020-12-29T14:13:04Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/event/TrackedEntityInstanceController.java", "diffHunk": "@@ -390,10 +346,11 @@ public void queryTrackedEntityInstancesCsv( TrackedEntityInstanceCriteria criter\n         throws WebMessageException,", "originalCommit": "b6e78bbee1408e66562e0cc25ca0699e313b2fbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5NTIxMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r551295211", "bodyText": "done, ty", "author": "gnespolino", "createdAt": "2021-01-04T12:43:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcxOTE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcxOTU5Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r549719596", "bodyText": "Note that the header goes between the package declaration and thee import", "author": "luciano-fiandesio", "createdAt": "2020-12-29T14:14:21Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerControllerSupport.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*", "originalCommit": "b6e78bbee1408e66562e0cc25ca0699e313b2fbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5NDg1MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r551294851", "bodyText": "ty, fixed", "author": "gnespolino", "createdAt": "2021-01-04T12:42:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcxOTU5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcyMTQxMw==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r549721413", "bodyText": "No public?", "author": "luciano-fiandesio", "createdAt": "2020-12-29T14:19:06Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerExportController.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package org.hisp.dhis.webapi.controller.tracker;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import static org.hisp.dhis.webapi.controller.tracker.TrackerControllerSupport.RESOURCE_PATH;\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+import java.util.Collection;\n+import java.util.List;\n+\n+import org.hisp.dhis.common.Pager;\n+import org.hisp.dhis.dxf2.events.trackedentity.TrackedEntityInstanceService;\n+import org.hisp.dhis.trackedentity.TrackedEntityInstanceQueryParams;\n+import org.hisp.dhis.tracker.domain.TrackedEntity;\n+import org.hisp.dhis.tracker.domain.mapper.TrackedEntityMapper;\n+import org.hisp.dhis.tracker.domain.web.PagingWrapper;\n+import org.hisp.dhis.webapi.controller.event.TrackedEntityInstanceCriteria;\n+import org.hisp.dhis.webapi.controller.event.mapper.TrackedEntityCriteriaMapper;\n+import org.hisp.dhis.webapi.service.ContextService;\n+import org.hisp.dhis.webapi.service.TrackedEntityInstanceSupportService;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import lombok.RequiredArgsConstructor;\n+\n+@RestController\n+@RequestMapping( value = RESOURCE_PATH )\n+@RequiredArgsConstructor\n+public class TrackerExportController\n+{\n+    private final ContextService contextService;\n+\n+    private final TrackedEntityCriteriaMapper criteriaMapper;\n+\n+    private final TrackedEntityInstanceService trackedEntityInstanceService;\n+\n+    private final TrackedEntityMapper trackedEntityMapper;\n+\n+    private final TrackedEntityInstanceSupportService trackedEntityInstanceSupportService;\n+\n+    @GetMapping( produces = APPLICATION_JSON_VALUE )\n+    PagingWrapper<TrackedEntity> getInstances( TrackedEntityInstanceCriteria criteria )", "originalCommit": "b6e78bbee1408e66562e0cc25ca0699e313b2fbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI5NjE2Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r551296163", "bodyText": "it's not necessary to have public visibility for a controller method since Spring will be able to invoke it anyway. Ideally lower visibility is better. Also since test is in same package it will be visible from testing classes. If there's a valid point to make it public I can change it.", "author": "gnespolino", "createdAt": "2021-01-04T12:45:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcyMTQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcyMjM1NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r549722355", "bodyText": "@stian-sandvold I think we can now rename this method to getTrackedEntityInstances and remove the 2?", "author": "luciano-fiandesio", "createdAt": "2020-12-29T14:22:06Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/tracker/TrackerExportController.java", "diffHunk": "@@ -0,0 +1,101 @@\n+package org.hisp.dhis.webapi.controller.tracker;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import static org.hisp.dhis.webapi.controller.tracker.TrackerControllerSupport.RESOURCE_PATH;\n+import static org.springframework.http.MediaType.APPLICATION_JSON_VALUE;\n+\n+import java.util.Collection;\n+import java.util.List;\n+\n+import org.hisp.dhis.common.Pager;\n+import org.hisp.dhis.dxf2.events.trackedentity.TrackedEntityInstanceService;\n+import org.hisp.dhis.trackedentity.TrackedEntityInstanceQueryParams;\n+import org.hisp.dhis.tracker.domain.TrackedEntity;\n+import org.hisp.dhis.tracker.domain.mapper.TrackedEntityMapper;\n+import org.hisp.dhis.tracker.domain.web.PagingWrapper;\n+import org.hisp.dhis.webapi.controller.event.TrackedEntityInstanceCriteria;\n+import org.hisp.dhis.webapi.controller.event.mapper.TrackedEntityCriteriaMapper;\n+import org.hisp.dhis.webapi.service.ContextService;\n+import org.hisp.dhis.webapi.service.TrackedEntityInstanceSupportService;\n+import org.springframework.web.bind.annotation.GetMapping;\n+import org.springframework.web.bind.annotation.PathVariable;\n+import org.springframework.web.bind.annotation.RequestMapping;\n+import org.springframework.web.bind.annotation.RequestParam;\n+import org.springframework.web.bind.annotation.RestController;\n+\n+import lombok.RequiredArgsConstructor;\n+\n+@RestController\n+@RequestMapping( value = RESOURCE_PATH )\n+@RequiredArgsConstructor\n+public class TrackerExportController\n+{\n+    private final ContextService contextService;\n+\n+    private final TrackedEntityCriteriaMapper criteriaMapper;\n+\n+    private final TrackedEntityInstanceService trackedEntityInstanceService;\n+\n+    private final TrackedEntityMapper trackedEntityMapper;\n+\n+    private final TrackedEntityInstanceSupportService trackedEntityInstanceSupportService;\n+\n+    @GetMapping( produces = APPLICATION_JSON_VALUE )\n+    PagingWrapper<TrackedEntity> getInstances( TrackedEntityInstanceCriteria criteria )\n+    {\n+        List<String> fields = contextService.getFieldsFromRequest();\n+\n+        TrackedEntityInstanceQueryParams queryParams = criteriaMapper.map( criteria );\n+\n+        Collection<TrackedEntity> trackedEntityInstances = trackedEntityMapper\n+            .fromCollection( trackedEntityInstanceService.getTrackedEntityInstances2( queryParams,", "originalCommit": "b6e78bbee1408e66562e0cc25ca0699e313b2fbb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTUyODAzNg==", "url": "https://github.com/dhis2/dhis2-core/pull/6987#discussion_r551528036", "bodyText": "Done, even if some tests need to be rewritten in a different way since some of them won't run on H2 database now.", "author": "gnespolino", "createdAt": "2021-01-04T19:43:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0OTcyMjM1NQ=="}], "type": "inlineReview"}, {"oid": "27c3859035015c6b56df68c0fcea56724f131c87", "url": "https://github.com/dhis2/dhis2-core/commit/27c3859035015c6b56df68c0fcea56724f131c87", "message": "feat: DHIS2-10093 peer review, minor changes, removed legacy getTrackedEntityInstances method", "committedDate": "2021-01-04T18:30:22Z", "type": "commit"}, {"oid": "111b35951cc4ba413a3d804be1c3af013274c163", "url": "https://github.com/dhis2/dhis2-core/commit/111b35951cc4ba413a3d804be1c3af013274c163", "message": "feat: DHIS2-10093 added trackedEntities path segment to export controller, controller class renamed", "committedDate": "2021-01-05T10:22:25Z", "type": "commit"}]}