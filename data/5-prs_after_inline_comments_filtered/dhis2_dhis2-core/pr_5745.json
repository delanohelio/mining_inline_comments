{"pr_number": 5745, "pr_title": "fix: Invalid weekly period year reference", "pr_createdAt": "2020-06-15T10:35:32Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5745", "timeline": [{"oid": "1cf9eb8b4184cb55425af11836740803c052ed0e", "url": "https://github.com/dhis2/dhis2-core/commit/1cf9eb8b4184cb55425af11836740803c052ed0e", "message": "fix: Invalid weekly period year reference\n\nThis fix corrects an error during the `_periodstructure` generation process. The process assigns the wrong year to a week Period.\n\nExample: `2019-12-31`\nThe week of `2019-12-31`, according to the ISO calendar system, belongs to 2020, since 4 or more days of that week fall in 2020.\n\nIn order to handle all Weekly Period types uniformly, 3 days are added to a Weekly Period type start date.\n\nExample:\n\n| Weekly Type     | Example Date | Date -> Start Date -> + 3             |\n|-----------------|--------------|---------------------------------------|\n| Standard        | 2019-12-31   | -> 2019-12-31 +3 = 2020-01-03 = 2020  |\n| Weekly Saturday | 2019-12-31   | -> 2019-12-28 + 3 = 2019-12-31 = 2019 |\n| Weekly Sunday   | 2019-12-31   | -> 2019-12-29 + 3 = 2020-01-01 = 2020 |\n| Weekly Thursday | 2019-12-31   | -> 2019-12-26 + 3 = 2019-12-29 = 2019 |\n| Weekly Wed      | 2019-12-31   | -> 2019-12-25 + 3 = 2019-12-28 = 2019 |\n\nref: DHIS2-5990", "committedDate": "2020-06-15T10:33:45Z", "type": "commit"}, {"oid": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319", "url": "https://github.com/dhis2/dhis2-core/commit/6c0ce36e09aa39e0d0da22e2ebfe962f85924319", "message": "chore: address sonar issue", "committedDate": "2020-06-15T11:10:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0MDc1MA==", "url": "https://github.com/dhis2/dhis2-core/pull/5745#discussion_r440240750", "bodyText": "Looks great.\nMy only concern here is our famous Calendar system. I think we need to retrieve the current calendar and use that when determining the year? We can check with Morten H.", "author": "larshelge", "createdAt": "2020-06-15T15:01:21Z", "path": "dhis-2/dhis-services/dhis-service-administration/src/main/java/org/hisp/dhis/resourcetable/table/PeriodResourceTable.java", "diffHunk": "@@ -140,4 +142,20 @@ public String getCreateTempTableStatement()\n \n         return Lists.newArrayList( sql );\n     }\n+    \n+    private int resolveYearFromPeriod( Period period )\n+    {\n+        // Weekly type has to be treated separately from other Period types.\n+        // In order to handle all weekly types uniformly, 3 days are added to the week start day and\n+        // the year of the modified start date is used as reference year for the Period\n+\n+        if ( WeeklyAbstractPeriodType.class.isAssignableFrom( period.getPeriodType().getClass() ) )\n+        {\n+            return new DateTime( period.getStartDate().getTime() ).plusDays( 3 ).getYear();", "originalCommit": "6c0ce36e09aa39e0d0da22e2ebfe962f85924319", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3NDUwMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5745#discussion_r440274501", "bodyText": "Ok, thanks, I'll add Morten to the reviewers", "author": "luciano-fiandesio", "createdAt": "2020-06-15T15:49:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0MDc1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI3Njg2Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5745#discussion_r440276867", "bodyText": "When it comes to weeks we currently don't do much considerations for other calendars, mostly because they normally don't have properly defined weeks etc... so i think this is fine (for now at least lets just do ISO weeks for all calendars)", "author": "mortenoh", "createdAt": "2020-06-15T15:53:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0MDc1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI4MTg0Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/5745#discussion_r440281842", "bodyText": "Just to be clear, if you want to add support you can simply get the calendar, check if iso (then do what you did), if not.. you can get year from the the calendar instance, but generally we have not been considering weeks for other calendars (we might want to do better, but its hard when week periods are not defined in their calendar)\n@abyot might have something to add about the Ethiopian calendar", "author": "mortenoh", "createdAt": "2020-06-15T16:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDI0MDc1MA=="}], "type": "inlineReview"}]}