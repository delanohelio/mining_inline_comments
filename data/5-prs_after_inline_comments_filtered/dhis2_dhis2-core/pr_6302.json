{"pr_number": 6302, "pr_title": "Dhis2 9667 program rule variables duplicate name", "pr_createdAt": "2020-09-30T14:55:14Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/6302", "timeline": [{"oid": "eb84da6e8cf2c82df5ada2fd76822d37702c4adc", "url": "https://github.com/dhis2/dhis2-core/commit/eb84da6e8cf2c82df5ada2fd76822d37702c4adc", "message": "fix: program rule names and program rule variable names check for duplicate now does not fail on update", "committedDate": "2020-09-30T12:23:25Z", "type": "commit"}, {"oid": "7b5e5ca95579faca559742c39d4c6f3df749d6f8", "url": "https://github.com/dhis2/dhis2-core/commit/7b5e5ca95579faca559742c39d4c6f3df749d6f8", "message": "fix: Flyway migration to normalize a situation where different rules and rule variables under the same program could have the same names", "committedDate": "2020-09-30T14:52:15Z", "type": "commit"}, {"oid": "cab0c0dc8068bdd30491575b9c37782449e10b58", "url": "https://github.com/dhis2/dhis2-core/commit/cab0c0dc8068bdd30491575b9c37782449e10b58", "message": "fix: Flyway migration enhancement to reduce duplicated code and generate a list of affected rules at the end of migration", "committedDate": "2020-10-01T12:07:40Z", "type": "commit"}, {"oid": "47e187d4133c242a6f89496c30ecb99061f5253c", "url": "https://github.com/dhis2/dhis2-core/commit/47e187d4133c242a6f89496c30ecb99061f5253c", "message": "fix: Flyway migration minor method naming fix", "committedDate": "2020-10-01T12:17:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NDM4Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6302#discussion_r498664382", "bodyText": "extra newline", "author": "ameenhere", "createdAt": "2020-10-02T07:46:55Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v36/V2_36_1__normalize_program_rule_variable_names_for_duplicates.java", "diffHunk": "@@ -0,0 +1,218 @@\n+package org.hisp.dhis.db.migration.v36;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import static org.hisp.dhis.db.migration.v36.V2_36_1__normalize_program_rule_variable_names_for_duplicates.ProgramRuleMigrationUtils.findAvailableName;\n+\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * @author Giuseppe Nespolino <g.nespolino@gmail.com>\n+ */\n+@Slf4j\n+public class V2_36_1__normalize_program_rule_variable_names_for_duplicates\n+    extends BaseJavaMigration\n+{\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        Collection<String> affectedRules = getCandidates( context.getConnection() ).stream()\n+            .map( candidate -> renameOccurrencesWithSuffix( candidate, context.getConnection() ) )\n+            .collect( Collectors.toSet() )\n+            .stream()\n+            .flatMap( Collection::stream )\n+            .collect( Collectors.toSet() );\n+\n+        if ( !affectedRules.isEmpty() )\n+        {\n+            log.warn(\n+                \"The following rules have variables whose names were formerly duplicated by some other variables. \" +\n+                    \"Some of the following rules might not work as expected after this migration, please review them: \"\n+                    + affectedRules );\n+        }\n+\n+    }\n+\n+    private List<Pair<Long, String>> getCandidates( Connection connection )\n+        throws SQLException\n+    {\n+\n+        final String candidateDetectionSql = \"SELECT programid, name\" +\n+            \" FROM programrulevariable \" +\n+            \" group by programid, name \" +\n+            \" having count(*) > 1\";\n+\n+        List<Pair<Long, String>> candidates = new ArrayList<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( candidateDetectionSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+                long programId = rs.getLong( \"programid\" );\n+                String programRuleVariableName = rs.getString( \"name\" );\n+\n+                candidates.add( Pair.of( programId, programRuleVariableName ) );\n+            }\n+        }\n+        return candidates;\n+    }\n+\n+    @SneakyThrows\n+    private Collection<String> renameOccurrencesWithSuffix( Pair<Long, String> candidate, Connection connection )\n+    {\n+        Long programId = candidate.getLeft();\n+        String variableName = candidate.getRight();\n+\n+        final String programRulesVariableToRenameSql = \"SELECT uid, name\" +\n+            \" FROM programrulevariable where programid = \" + programId +\n+            \" AND name like '\" + variableName + \"%'\";\n+\n+        Map<String, String> uidWithNewNames = new HashMap<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( programRulesVariableToRenameSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+", "originalCommit": "47e187d4133c242a6f89496c30ecb99061f5253c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY2NDU2Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/6302#discussion_r498664563", "bodyText": "extra new line", "author": "ameenhere", "createdAt": "2020-10-02T07:47:18Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v36/V2_36_1__normalize_program_rule_variable_names_for_duplicates.java", "diffHunk": "@@ -0,0 +1,218 @@\n+package org.hisp.dhis.db.migration.v36;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import static org.hisp.dhis.db.migration.v36.V2_36_1__normalize_program_rule_variable_names_for_duplicates.ProgramRuleMigrationUtils.findAvailableName;\n+\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * @author Giuseppe Nespolino <g.nespolino@gmail.com>\n+ */\n+@Slf4j\n+public class V2_36_1__normalize_program_rule_variable_names_for_duplicates\n+    extends BaseJavaMigration\n+{\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        Collection<String> affectedRules = getCandidates( context.getConnection() ).stream()\n+            .map( candidate -> renameOccurrencesWithSuffix( candidate, context.getConnection() ) )\n+            .collect( Collectors.toSet() )\n+            .stream()\n+            .flatMap( Collection::stream )\n+            .collect( Collectors.toSet() );\n+\n+        if ( !affectedRules.isEmpty() )\n+        {\n+            log.warn(\n+                \"The following rules have variables whose names were formerly duplicated by some other variables. \" +\n+                    \"Some of the following rules might not work as expected after this migration, please review them: \"\n+                    + affectedRules );\n+        }\n+\n+    }\n+\n+    private List<Pair<Long, String>> getCandidates( Connection connection )\n+        throws SQLException\n+    {\n+\n+        final String candidateDetectionSql = \"SELECT programid, name\" +\n+            \" FROM programrulevariable \" +\n+            \" group by programid, name \" +\n+            \" having count(*) > 1\";\n+\n+        List<Pair<Long, String>> candidates = new ArrayList<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( candidateDetectionSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+                long programId = rs.getLong( \"programid\" );\n+                String programRuleVariableName = rs.getString( \"name\" );\n+\n+                candidates.add( Pair.of( programId, programRuleVariableName ) );\n+            }\n+        }\n+        return candidates;\n+    }\n+\n+    @SneakyThrows\n+    private Collection<String> renameOccurrencesWithSuffix( Pair<Long, String> candidate, Connection connection )\n+    {\n+        Long programId = candidate.getLeft();\n+        String variableName = candidate.getRight();\n+\n+        final String programRulesVariableToRenameSql = \"SELECT uid, name\" +\n+            \" FROM programrulevariable where programid = \" + programId +\n+            \" AND name like '\" + variableName + \"%'\";\n+\n+        Map<String, String> uidWithNewNames = new HashMap<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( programRulesVariableToRenameSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+\n+                uidWithNewNames.put( rs.getString( \"uid\" ), rs.getString( \"name\" ) );\n+", "originalCommit": "47e187d4133c242a6f89496c30ecb99061f5253c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4NjAyMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/6302#discussion_r498686021", "bodyText": "I would suggest to have some comments in different parts of this file indicating the different steps in the migrations. Like (This is just an example, you will know better)\n\nIdentifying the programrulevariable with duplicate names.\nFor each duplicate, check if there are similar/existing names already in the programrulevariable table....\n3.........and so on.\n\nJust to make it easy to understand in one reading rather than trying to go through all the streams and methods to verify what exactly is being done.\nEven a detailed javadoc for each of the methods here might also suffice.", "author": "ameenhere", "createdAt": "2020-10-02T08:32:07Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v36/V2_36_1__normalize_program_rule_variable_names_for_duplicates.java", "diffHunk": "@@ -0,0 +1,218 @@\n+package org.hisp.dhis.db.migration.v36;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import static org.hisp.dhis.db.migration.v36.V2_36_1__normalize_program_rule_variable_names_for_duplicates.ProgramRuleMigrationUtils.findAvailableName;\n+\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+import java.util.function.BiFunction;\n+import java.util.stream.Collectors;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * @author Giuseppe Nespolino <g.nespolino@gmail.com>\n+ */\n+@Slf4j\n+public class V2_36_1__normalize_program_rule_variable_names_for_duplicates\n+    extends BaseJavaMigration\n+{\n+", "originalCommit": "47e187d4133c242a6f89496c30ecb99061f5253c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4NzE1Mg==", "url": "https://github.com/dhis2/dhis2-core/pull/6302#discussion_r498687152", "bodyText": "extra newline", "author": "ameenhere", "createdAt": "2020-10-02T08:34:17Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v36/V2_36_2__normalize_program_rule_names_for_duplicates.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package org.hisp.dhis.db.migration.v36;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import static org.hisp.dhis.db.migration.v36.V2_36_1__normalize_program_rule_variable_names_for_duplicates.ProgramRuleMigrationUtils.findAvailableName;\n+import static org.hisp.dhis.db.migration.v36.V2_36_1__normalize_program_rule_variable_names_for_duplicates.ProgramRuleMigrationUtils.renameAll;\n+\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * @author Giuseppe Nespolino <g.nespolino@gmail.com>\n+ */\n+@Slf4j\n+public class V2_36_2__normalize_program_rule_names_for_duplicates\n+    extends BaseJavaMigration\n+{\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        getCandidates( context.getConnection() )\n+            .forEach( candidate -> renameOccurrencesWithSuffix( candidate, context.getConnection() ) );\n+    }\n+\n+    private List<Pair<Long, String>> getCandidates( Connection connection )\n+        throws SQLException\n+    {\n+\n+        final String candidateDetectionSql = \"SELECT programid, name\" +\n+            \" FROM programrule \" +\n+            \" group by programid, name \" +\n+            \" having count(*) > 1\";\n+\n+        List<Pair<Long, String>> candidates = new ArrayList<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( candidateDetectionSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+                candidates.add( Pair.of( rs.getLong( \"programid\" ), rs.getString( \"name\" ) ) );\n+            }\n+        }\n+        return candidates;\n+    }\n+\n+    @SneakyThrows\n+    private void renameOccurrencesWithSuffix( Pair<Long, String> candidate, Connection connection )\n+    {\n+        Long programId = candidate.getLeft();\n+        String ruleName = candidate.getRight();\n+\n+        final String programRulesToRenameSql = \"SELECT uid, name\" +\n+            \" FROM programrule where programid = \" + programId +\n+            \" AND name like '\" + ruleName + \"%'\";\n+\n+        Map<String, String> uidWithNewNames = new HashMap<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( programRulesToRenameSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+", "originalCommit": "47e187d4133c242a6f89496c30ecb99061f5253c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODY4NzIwMg==", "url": "https://github.com/dhis2/dhis2-core/pull/6302#discussion_r498687202", "bodyText": "extra newline", "author": "ameenhere", "createdAt": "2020-10-02T08:34:23Z", "path": "dhis-2/dhis-support/dhis-support-db-migration/src/main/java/org/hisp/dhis/db/migration/v36/V2_36_2__normalize_program_rule_names_for_duplicates.java", "diffHunk": "@@ -0,0 +1,120 @@\n+package org.hisp.dhis.db.migration.v36;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import static org.hisp.dhis.db.migration.v36.V2_36_1__normalize_program_rule_variable_names_for_duplicates.ProgramRuleMigrationUtils.findAvailableName;\n+import static org.hisp.dhis.db.migration.v36.V2_36_1__normalize_program_rule_variable_names_for_duplicates.ProgramRuleMigrationUtils.renameAll;\n+\n+import java.sql.Connection;\n+import java.sql.ResultSet;\n+import java.sql.SQLException;\n+import java.sql.Statement;\n+import java.util.ArrayList;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import org.apache.commons.lang3.tuple.Pair;\n+import org.flywaydb.core.api.migration.BaseJavaMigration;\n+import org.flywaydb.core.api.migration.Context;\n+\n+import lombok.SneakyThrows;\n+import lombok.extern.slf4j.Slf4j;\n+\n+/**\n+ * @author Giuseppe Nespolino <g.nespolino@gmail.com>\n+ */\n+@Slf4j\n+public class V2_36_2__normalize_program_rule_names_for_duplicates\n+    extends BaseJavaMigration\n+{\n+\n+    @Override\n+    public void migrate( Context context )\n+        throws Exception\n+    {\n+        getCandidates( context.getConnection() )\n+            .forEach( candidate -> renameOccurrencesWithSuffix( candidate, context.getConnection() ) );\n+    }\n+\n+    private List<Pair<Long, String>> getCandidates( Connection connection )\n+        throws SQLException\n+    {\n+\n+        final String candidateDetectionSql = \"SELECT programid, name\" +\n+            \" FROM programrule \" +\n+            \" group by programid, name \" +\n+            \" having count(*) > 1\";\n+\n+        List<Pair<Long, String>> candidates = new ArrayList<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( candidateDetectionSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+                candidates.add( Pair.of( rs.getLong( \"programid\" ), rs.getString( \"name\" ) ) );\n+            }\n+        }\n+        return candidates;\n+    }\n+\n+    @SneakyThrows\n+    private void renameOccurrencesWithSuffix( Pair<Long, String> candidate, Connection connection )\n+    {\n+        Long programId = candidate.getLeft();\n+        String ruleName = candidate.getRight();\n+\n+        final String programRulesToRenameSql = \"SELECT uid, name\" +\n+            \" FROM programrule where programid = \" + programId +\n+            \" AND name like '\" + ruleName + \"%'\";\n+\n+        Map<String, String> uidWithNewNames = new HashMap<>();\n+\n+        try (final Statement stmt = connection.createStatement();\n+            final ResultSet rs = stmt.executeQuery( programRulesToRenameSql ))\n+        {\n+            while ( rs.next() )\n+            {\n+\n+                uidWithNewNames.put( rs.getString( \"uid\" ), rs.getString( \"name\" ) );\n+", "originalCommit": "47e187d4133c242a6f89496c30ecb99061f5253c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bbc08565c79d348aecb005526b5673eb7b0e7ce8", "url": "https://github.com/dhis2/dhis2-core/commit/bbc08565c79d348aecb005526b5673eb7b0e7ce8", "message": "fix: applocating Peer Review suggestions", "committedDate": "2020-10-02T09:08:17Z", "type": "commit"}]}