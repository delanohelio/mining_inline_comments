{"pr_number": 5953, "pr_title": "feat: Convert security XML config to Java annotation config", "pr_createdAt": "2020-08-18T17:11:25Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5953", "timeline": [{"oid": "9b2dcdcaed81e1043986c24741c2d5a8828260b3", "url": "https://github.com/dhis2/dhis2-core/commit/9b2dcdcaed81e1043986c24741c2d5a8828260b3", "message": "feat: Convert xml based config files to java annotation based config\n\nConvert all .xml spring config files to Java config classes using spring @Configuration instead (except Struts bean.xml config files).\nConvert web.xml files to use Java bases classes extending WebApplicationInitializer.\nRemove support for OpenID ver. 1 (this is for preparing for OIDC support later).\nMigrate some filters to use @WebFilter configuration.\nUpgrade Spring, Spring Security, Struts and more depenendices to latest versions.\nAdd maven-enforcer rules to enforce better dependency controll.\nAdd exclusions for overlapping and clashing dependencies.", "committedDate": "2020-08-18T17:10:02Z", "type": "commit"}, {"oid": "e70a8b53edfdb704d9f6ea9d2497921abd812b4a", "url": "https://github.com/dhis2/dhis2-core/commit/e70a8b53edfdb704d9f6ea9d2497921abd812b4a", "message": "feat: Convert xml based config files to java annotation based config\n\nFix broken unit tests, add missing deps. to ldap.", "committedDate": "2020-08-19T08:46:54Z", "type": "commit"}, {"oid": "fb96b87d894f2066b3096e7110f186f7399ccd27", "url": "https://github.com/dhis2/dhis2-core/commit/fb96b87d894f2066b3096e7110f186f7399ccd27", "message": "feat: Convert xml based config files to java annotation based config\n\nRemove usage of DhisTest in the web layer", "committedDate": "2020-08-19T12:10:15Z", "type": "commit"}, {"oid": "bd16e9195f59b18cf7649048613c3a973bfff51a", "url": "https://github.com/dhis2/dhis2-core/commit/bd16e9195f59b18cf7649048613c3a973bfff51a", "message": "feat: Convert xml based config files to java annotation based config\n\nSome doc and minor cleanup of unused code and commented code.", "committedDate": "2020-08-19T16:25:50Z", "type": "commit"}, {"oid": "0744b67652dce96828d106f0256c440ca9d50992", "url": "https://github.com/dhis2/dhis2-core/commit/0744b67652dce96828d106f0256c440ca9d50992", "message": "Merge branch 'master' of github.com:dhis2/dhis2-core into DHIS2-9150", "committedDate": "2020-08-19T16:26:06Z", "type": "commit"}, {"oid": "8d86d02aa57e1115740b31527d2c6f1f1f382ba8", "url": "https://github.com/dhis2/dhis2-core/commit/8d86d02aa57e1115740b31527d2c6f1f1f382ba8", "message": "Merge branch 'master' of github.com:dhis2/dhis2-core into DHIS2-9150", "committedDate": "2020-08-21T09:16:02Z", "type": "commit"}, {"oid": "d283c6a133c19842eb46b1de4bd0e157aaabe34d", "url": "https://github.com/dhis2/dhis2-core/commit/d283c6a133c19842eb46b1de4bd0e157aaabe34d", "message": "feat: Convert xml based config files to java annotation based config\n\n* Fixed wrong config for opens session in view\n* Added default user startup task populator, removed old automatic accces provider system\n* Added authority provider config for struts\n* removed ununsed dep.", "committedDate": "2020-08-22T08:57:50Z", "type": "commit"}, {"oid": "219fc7154eae8cfd4cf5adf8c353dc36b18ec2c1", "url": "https://github.com/dhis2/dhis2-core/commit/219fc7154eae8cfd4cf5adf8c353dc36b18ec2c1", "message": "Merge branch 'master' of github.com:dhis2/dhis2-core into DHIS2-9150", "committedDate": "2020-08-24T03:47:38Z", "type": "commit"}, {"oid": "29c4a7e42f889dd76104de18ad99f7d0825ca4f6", "url": "https://github.com/dhis2/dhis2-core/commit/29c4a7e42f889dd76104de18ad99f7d0825ca4f6", "message": "feat: Convert xml based config files to java annotation based config\n\n* Downgrade Hibernate back to 5.2.17", "committedDate": "2020-08-24T05:13:53Z", "type": "commit"}, {"oid": "01c9475aa14db6e85f2cf5030f13a9900a2c2713", "url": "https://github.com/dhis2/dhis2-core/commit/01c9475aa14db6e85f2cf5030f13a9900a2c2713", "message": "feat: Convert xml based config files to java annotation based config\n\n* Disable broken e2e test", "committedDate": "2020-08-24T11:33:38Z", "type": "commit"}, {"oid": "6f2c18982831d36a1f8c3d789e4e26de74acaca4", "url": "https://github.com/dhis2/dhis2-core/commit/6f2c18982831d36a1f8c3d789e4e26de74acaca4", "message": "feat: Convert xml based config files to java annotation based config\n\n* Revert DefaultAuditObjectFactory change", "committedDate": "2020-08-24T12:00:57Z", "type": "commit"}, {"oid": "e771f7bcf0c576a2adb71906d827a64aafbe80b9", "url": "https://github.com/dhis2/dhis2-core/commit/e771f7bcf0c576a2adb71906d827a64aafbe80b9", "message": "feat: Convert xml based config files to java annotation based config\n\n* Added back custom entry point for form based entry to bypass web/form if a custom header is present.", "committedDate": "2020-08-24T12:31:25Z", "type": "commit"}, {"oid": "c266323263a7d5a2974048c8490612306a3c073e", "url": "https://github.com/dhis2/dhis2-core/commit/c266323263a7d5a2974048c8490612306a3c073e", "message": "feat: Convert xml based config files to java annotation based config\n\n* Reenable web-apps module...", "committedDate": "2020-08-25T03:57:04Z", "type": "commit"}, {"oid": "68e0effede34bfb9d88e900cad671cd912a5f084", "url": "https://github.com/dhis2/dhis2-core/commit/68e0effede34bfb9d88e900cad671cd912a5f084", "message": "Merge branch 'master' of github.com:dhis2/dhis2-core into DHIS2-9150", "committedDate": "2020-08-25T04:05:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMjIwOA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476302208", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:14:27Z", "path": "dhis-2/dhis-web/dhis-web-api-test/src/test/java/org/hisp/dhis/webapi/MvcTestConfig.java", "diffHunk": "@@ -0,0 +1,163 @@\n+package org.hisp.dhis.webapi;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMzQ4MA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476303480", "bodyText": "Is the parameter injection of User not supported anymore?", "author": "mortenoh", "createdAt": "2020-08-25T09:16:40Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/controller/AbstractCrudController.java", "diffHunk": "@@ -218,8 +218,10 @@\n     @RequestMapping( method = RequestMethod.GET )\n     public @ResponseBody RootNode getObjectList(\n         @RequestParam Map<String, String> rpParameters, OrderParams orderParams,\n-        HttpServletResponse response, User currentUser ) throws QueryParserException\n+        HttpServletResponse response) throws QueryParserException\n     {\n+        User currentUser = currentUserService.getCurrentUser();", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzNzc0Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476437743", "bodyText": "Yes, I tried to figure out this but really could not find where this is configured. Do you have any idea about where this is defined?", "author": "netroms", "createdAt": "2020-08-25T13:13:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ2Mzk3OA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476463978", "bodyText": "You can find this under the mvc package in dhis-web-api, it also has argument resolvers for DhisApiVersion etc.\nCurrentUserHandlerMethodArgumentResolver", "author": "mortenoh", "createdAt": "2020-08-25T13:50:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwMzQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNTU4Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476305586", "bodyText": "Code style, use  { }", "author": "mortenoh", "createdAt": "2020-08-25T09:19:57Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/mvc/CustomRequestMappingHandlerMapping.java", "diffHunk": "@@ -86,8 +86,10 @@ protected RequestMappingInfo getMappingForMethod( Method method, Class<?> handle\n                 {\n                     if ( !pattern.startsWith( version.getVersionString() ) )\n                     {\n-                        if ( pattern.startsWith( \"/\" ) ) patterns.add( \"/\" + version.getVersion() + pattern );\n-                        else patterns.add( \"/\" + version.getVersion() + \"/\" + pattern );\n+                        if ( pattern.startsWith( \"/\" ) )\n+                            patterns.add( \"/\" + version.getVersion() + pattern );\n+                        else", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNjI4OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476306289", "bodyText": "No need for @Autowired if using constructor injection (since spring 4.3)", "author": "mortenoh", "createdAt": "2020-08-25T09:21:02Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/oprovider/DhisOauthAuthenticationProvider.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package org.hisp.dhis.webapi.oprovider;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.SerializationUtils;\n+import org.hisp.dhis.security.SecurityService;\n+import org.hisp.dhis.security.oauth2.DefaultClientDetailsUserDetailsService;\n+import org.hisp.dhis.user.UserService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.security.authentication.BadCredentialsException;\n+import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\n+import org.springframework.security.authentication.dao.DaoAuthenticationProvider;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.AuthenticationException;\n+import org.springframework.security.core.userdetails.UserDetails;\n+import org.springframework.security.crypto.password.NoOpPasswordEncoder;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * @author Henning H\u00e5konsen\n+ */\n+@Slf4j\n+@Component\n+public class DhisOauthAuthenticationProvider extends DaoAuthenticationProvider\n+{\n+    @Autowired\n+    private UserService userService;\n+\n+    @Autowired\n+    private SecurityService securityService;\n+\n+    @Autowired\n+    DefaultClientDetailsUserDetailsService defaultClientDetailsUserDetailsService;\n+\n+    @Autowired", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNjY1Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476306653", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:21:39Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/security/SecurityWebApplicationInitializer.java", "diffHunk": "@@ -0,0 +1,11 @@\n+package org.hisp.dhis.webapi.security;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNjg0Mw==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476306843", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:21:55Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/security/config/AuthenticationProviderConfig.java", "diffHunk": "@@ -0,0 +1,99 @@\n+package org.hisp.dhis.webapi.security.config;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNzExNQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476307115", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:22:23Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/security/config/DhisWebApiWebSecurityConfig.java", "diffHunk": "@@ -0,0 +1,256 @@\n+package org.hisp.dhis.webapi.security.config;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNzc5Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476307797", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:23:34Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/security/config/PasswordEncoderConfig.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package org.hisp.dhis.webapi.security.config;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwNzg5Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476307897", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:23:47Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/security/config/WebMvcConfig.java", "diffHunk": "@@ -0,0 +1,160 @@\n+package org.hisp.dhis.webapi.security.config;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwODUyMw==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476308523", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:24:43Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/servlet/DhisWebApiWebAppInitializer.java", "diffHunk": "@@ -0,0 +1,89 @@\n+package org.hisp.dhis.webapi.servlet;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwOTQ3MA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476309470", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:26:13Z", "path": "dhis-2/dhis-web/dhis-web-commons/src/main/java/org/hisp/dhis/security/config/AuthoritiesProviderConfig.java", "diffHunk": "@@ -0,0 +1,97 @@\n+package org.hisp.dhis.security.config;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMwOTc3OA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476309778", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:26:45Z", "path": "dhis-2/dhis-web/dhis-web-commons/src/main/java/org/hisp/dhis/security/config/DhisWebCommonsWebSecurityConfig.java", "diffHunk": "@@ -0,0 +1,297 @@\n+package org.hisp.dhis.security.config;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjMxMDM3MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476310371", "bodyText": "Copyright", "author": "mortenoh", "createdAt": "2020-08-25T09:27:43Z", "path": "dhis-2/dhis-web/dhis-web-commons/src/main/java/org/hisp/dhis/servlet/DhisWebCommonsWebAppInitializer.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package org.hisp.dhis.servlet;\n+", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxMTY3Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476411676", "bodyText": "Remove?", "author": "larshelge", "createdAt": "2020-08-25T12:32:41Z", "path": "dhis-2/dhis-services/dhis-service-core/src/main/java/org/hisp/dhis/security/spring2fa/TwoFactorAuthenticationProvider.java", "diffHunk": "@@ -28,42 +28,47 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n+import lombok.extern.slf4j.Slf4j;\n import org.apache.commons.lang3.SerializationUtils;\n import org.apache.commons.lang3.StringUtils;\n import org.apache.commons.validator.routines.LongValidator;\n import org.hisp.dhis.security.SecurityService;\n import org.hisp.dhis.security.SecurityUtils;\n import org.hisp.dhis.user.UserCredentials;\n import org.hisp.dhis.user.UserService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n import org.springframework.security.authentication.BadCredentialsException;\n import org.springframework.security.authentication.LockedException;\n import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\n import org.springframework.security.authentication.dao.DaoAuthenticationProvider;\n import org.springframework.security.core.Authentication;\n import org.springframework.security.core.AuthenticationException;\n+import org.springframework.security.core.userdetails.UserDetailsService;\n+import org.springframework.security.crypto.password.PasswordEncoder;\n import org.springframework.security.web.authentication.preauth.PreAuthenticatedCredentialsNotFoundException;\n-\n-import lombok.extern.slf4j.Slf4j;\n+import org.springframework.stereotype.Component;\n \n /**\n  * @author Henning H\u00e5konsen\n  */\n @Slf4j\n-public class TwoFactorAuthenticationProvider\n-    extends DaoAuthenticationProvider\n+@Component\n+public class TwoFactorAuthenticationProvider extends DaoAuthenticationProvider\n {\n+    @Autowired\n     private UserService userService;\n \n-    public void setUserService( UserService userService )\n-    {\n-        this.userService = userService;\n-    }\n-\n+    @Autowired\n     private SecurityService securityService;\n \n-    public void setSecurityService( SecurityService securityService )\n+    @Autowired\n+    public TwoFactorAuthenticationProvider( @Qualifier( \"userDetailsService\" ) UserDetailsService detailsService,\n+        PasswordEncoder passwordEncoder )\n     {\n-        this.securityService = securityService;\n+//        super();", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNTE2Ng==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476415166", "bodyText": "Add \"private\" modifier.", "author": "larshelge", "createdAt": "2020-08-25T12:38:42Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/oprovider/DhisOauthAuthenticationProvider.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package org.hisp.dhis.webapi.oprovider;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.SerializationUtils;\n+import org.hisp.dhis.security.SecurityService;\n+import org.hisp.dhis.security.oauth2.DefaultClientDetailsUserDetailsService;\n+import org.hisp.dhis.user.UserService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.security.authentication.BadCredentialsException;\n+import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\n+import org.springframework.security.authentication.dao.DaoAuthenticationProvider;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.AuthenticationException;\n+import org.springframework.security.core.userdetails.UserDetails;\n+import org.springframework.security.crypto.password.NoOpPasswordEncoder;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * @author Henning H\u00e5konsen\n+ */\n+@Slf4j\n+@Component\n+public class DhisOauthAuthenticationProvider extends DaoAuthenticationProvider\n+{\n+    @Autowired\n+    private UserService userService;\n+\n+    @Autowired\n+    private SecurityService securityService;\n+\n+    @Autowired\n+    DefaultClientDetailsUserDetailsService defaultClientDetailsUserDetailsService;", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNTQxMQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476415411", "bodyText": "Does two-factor still work?\nIf yes, remove commented code?", "author": "larshelge", "createdAt": "2020-08-25T12:39:03Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/oprovider/DhisOauthAuthenticationProvider.java", "diffHunk": "@@ -0,0 +1,155 @@\n+package org.hisp.dhis.webapi.oprovider;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.commons.lang3.SerializationUtils;\n+import org.hisp.dhis.security.SecurityService;\n+import org.hisp.dhis.security.oauth2.DefaultClientDetailsUserDetailsService;\n+import org.hisp.dhis.user.UserService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.security.authentication.BadCredentialsException;\n+import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;\n+import org.springframework.security.authentication.dao.DaoAuthenticationProvider;\n+import org.springframework.security.core.Authentication;\n+import org.springframework.security.core.AuthenticationException;\n+import org.springframework.security.core.userdetails.UserDetails;\n+import org.springframework.security.crypto.password.NoOpPasswordEncoder;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * @author Henning H\u00e5konsen\n+ */\n+@Slf4j\n+@Component\n+public class DhisOauthAuthenticationProvider extends DaoAuthenticationProvider\n+{\n+    @Autowired\n+    private UserService userService;\n+\n+    @Autowired\n+    private SecurityService securityService;\n+\n+    @Autowired\n+    DefaultClientDetailsUserDetailsService defaultClientDetailsUserDetailsService;\n+\n+    @Autowired\n+    public DhisOauthAuthenticationProvider( @Qualifier( \"defaultClientDetailsUserDetailsService\" ) DefaultClientDetailsUserDetailsService detailsService )\n+    {\n+//        super();\n+        setUserDetailsService( detailsService );\n+        setPasswordEncoder( NoOpPasswordEncoder.getInstance() );\n+        this.defaultClientDetailsUserDetailsService = detailsService;\n+    }\n+\n+    @Override\n+    public Authentication authenticate( Authentication auth )\n+        throws AuthenticationException\n+    {\n+        log.info( String.format( \"OldOauthAuthenticationProvider Login attempt: %s\", auth.getName() ) );\n+\n+        String username = auth.getName();\n+\n+        UserDetails userCredentials = getUserDetailsService().loadUserByUsername( username );\n+\n+        if ( userCredentials == null )\n+        {\n+            throw new BadCredentialsException( \"Invalid username or password\" );\n+        }\n+\n+        // Initialize all required properties of user credentials since these will become detached\n+\n+//        userCredentials.getAllAuthorities();\n+//\n+//        // -------------------------------------------------------------------------\n+//        // Check two-factor authentication\n+//        // -------------------------------------------------------------------------\n+//\n+//        if ( userCredentials.isTwoFA() )\n+//        {\n+//            TwoFactorWebAuthenticationDetails authDetails =\n+//                (TwoFactorWebAuthenticationDetails) auth.getDetails();\n+//\n+//            // -------------------------------------------------------------------------\n+//            // Check whether account is locked due to multiple failed login attempts\n+//            // -------------------------------------------------------------------------\n+//\n+//            if ( authDetails == null )", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0OTU5NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476449595", "bodyText": "Yes, two factor works but only via form login. This provider is for oauth2 access token login", "author": "netroms", "createdAt": "2020-08-25T13:30:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNTQxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNjA2NA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476416064", "bodyText": "Handle this. Do we need it? Remove commented code if not.", "author": "larshelge", "createdAt": "2020-08-25T12:40:06Z", "path": "dhis-2/dhis-web/dhis-web-api/src/main/java/org/hisp/dhis/webapi/security/config/DhisWebApiWebSecurityConfig.java", "diffHunk": "@@ -0,0 +1,256 @@\n+package org.hisp.dhis.webapi.security.config;\n+\n+import org.hisp.dhis.security.oauth2.DefaultClientDetailsService;\n+import org.hisp.dhis.webapi.filter.CorsFilter;\n+import org.hisp.dhis.webapi.filter.CustomAuthenticationFilter;\n+import org.hisp.dhis.webapi.oprovider.DhisOauthAuthenticationProvider;\n+import org.hisp.dhis.webapi.security.DHIS2BasicAuthenticationEntryPoint;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Import;\n+import org.springframework.context.annotation.Primary;\n+import org.springframework.core.annotation.Order;\n+import org.springframework.security.access.expression.SecurityExpressionHandler;\n+import org.springframework.security.authentication.AuthenticationManager;\n+import org.springframework.security.config.annotation.SecurityConfigurerAdapter;\n+import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;\n+import org.springframework.security.config.annotation.authentication.configurers.userdetails.DaoAuthenticationConfigurer;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.config.http.SessionCreationPolicy;\n+import org.springframework.security.oauth2.config.annotation.configurers.ClientDetailsServiceConfigurer;\n+import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerConfigurer;\n+import org.springframework.security.oauth2.config.annotation.web.configuration.AuthorizationServerEndpointsConfiguration;\n+import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerEndpointsConfigurer;\n+import org.springframework.security.oauth2.config.annotation.web.configurers.AuthorizationServerSecurityConfigurer;\n+import org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationManager;\n+import org.springframework.security.oauth2.provider.authentication.OAuth2AuthenticationProcessingFilter;\n+import org.springframework.security.oauth2.provider.code.JdbcAuthorizationCodeServices;\n+import org.springframework.security.oauth2.provider.endpoint.FrameworkEndpointHandlerMapping;\n+import org.springframework.security.oauth2.provider.error.OAuth2AccessDeniedHandler;\n+import org.springframework.security.oauth2.provider.error.OAuth2AuthenticationEntryPoint;\n+import org.springframework.security.oauth2.provider.expression.OAuth2WebSecurityExpressionHandler;\n+import org.springframework.security.oauth2.provider.token.DefaultTokenServices;\n+import org.springframework.security.oauth2.provider.token.ResourceServerTokenServices;\n+import org.springframework.security.oauth2.provider.token.TokenStore;\n+import org.springframework.security.oauth2.provider.token.store.JdbcTokenStore;\n+import org.springframework.security.web.AuthenticationEntryPoint;\n+import org.springframework.security.web.DefaultSecurityFilterChain;\n+import org.springframework.security.web.FilterInvocation;\n+import org.springframework.security.web.access.AccessDeniedHandler;\n+import org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;\n+import org.springframework.security.web.authentication.www.BasicAuthenticationFilter;\n+\n+import javax.sql.DataSource;\n+\n+/**\n+ * @author Morten Svan\u00e6s <msvanaes@dhis2.org>\n+ */\n+@Configuration\n+@Order( 1999 )\n+public class DhisWebApiWebSecurityConfig\n+{\n+    @Autowired\n+    public DataSource dataSource;\n+\n+    /**\n+     * This configuration class is responsible for setting up the OAuth2 /token endpoint and /authorize endpoint.\n+     * This config is a modification of the config that is automatically enabled by using the @EnableAuthorizationServer annotation.\n+     * The spring-security-oauth2 project is deprecated but as of now 19. August 2020 there is still no other alternative ready.\n+     * The candidate for replacing this is: https://github.com/spring-projects-experimental/spring-authorization-server\n+     */\n+    @Configuration\n+    @Order( 1001 )\n+    @Import( { AuthorizationServerEndpointsConfiguration.class, AuthorizationServerEndpointsConfiguration.class } )\n+    public class OAuth2SecurityConfig extends WebSecurityConfigurerAdapter implements AuthorizationServerConfigurer\n+    {\n+        @Autowired\n+        private AuthorizationServerEndpointsConfiguration endpoints;\n+\n+        @Autowired\n+        private DhisOauthAuthenticationProvider dhisOauthAuthenticationProvider;\n+\n+        @Override\n+        protected void configure( HttpSecurity http )\n+            throws Exception\n+        {\n+            AuthorizationServerSecurityConfigurer configurer = new AuthorizationServerSecurityConfigurer();\n+            FrameworkEndpointHandlerMapping handlerMapping = endpoints.oauth2EndpointHandlerMapping();\n+            http.setSharedObject( FrameworkEndpointHandlerMapping.class, handlerMapping );\n+\n+            configure( configurer );\n+            http.apply( configurer );\n+\n+            // This is the only endpoint we need to configure.\n+            // The /authorize endpoint is only accessible AFTER you have logged in,\n+            // you will be redirected to the form login if you try accessing it without being authenticated.\n+            String tokenEndpointPath = handlerMapping.getServletPath( \"/oauth/token\" );\n+\n+            http\n+                .authorizeRequests()\n+                .antMatchers( tokenEndpointPath ).fullyAuthenticated()\n+                .and()\n+                .requestMatchers()\n+                .antMatchers( tokenEndpointPath )\n+                .and()\n+                .sessionManagement().sessionCreationPolicy( SessionCreationPolicy.NEVER );\n+\n+            http.apply( new AuthorizationServerAuthenticationManagerConfigurer() );\n+        }\n+\n+        private class AuthorizationServerAuthenticationManagerConfigurer\n+            extends SecurityConfigurerAdapter<DefaultSecurityFilterChain, HttpSecurity>\n+        {\n+            @Override\n+            public void init( HttpSecurity builder )\n+                throws Exception\n+            {\n+                // This is a quirk to remove the default DaoAuthenticationConfigurer,\n+                // that gets automatically assigned in the AuthorizationServerSecurityConfigurer.\n+                // We only want ONE authentication provider (our own...)\n+                AuthenticationManagerBuilder authBuilder = builder\n+                    .getSharedObject( AuthenticationManagerBuilder.class );\n+                authBuilder.removeConfigurer( DaoAuthenticationConfigurer.class );\n+                authBuilder.authenticationProvider( dhisOauthAuthenticationProvider );\n+            }\n+        }\n+\n+        @Override\n+        public void configure( AuthorizationServerSecurityConfigurer security )\n+            throws Exception\n+        {\n+        }\n+\n+        @Override\n+        public void configure( ClientDetailsServiceConfigurer configurer )\n+            throws Exception\n+        {\n+        }\n+\n+        @Bean( \"authorizationCodeServices\" )\n+        public JdbcAuthorizationCodeServices jdbcAuthorizationCodeServices()\n+        {\n+            return new JdbcAuthorizationCodeServices( dataSource );\n+        }\n+\n+        @Override\n+        public void configure( final AuthorizationServerEndpointsConfigurer endpoints )\n+            throws Exception\n+        {\n+            endpoints\n+                .prefix( \"/uaa\" )\n+                .authorizationCodeServices( jdbcAuthorizationCodeServices() )\n+                .tokenStore( tokenStore() )\n+                .authenticationManager( authenticationManager() );\n+        }\n+    }\n+\n+    @Bean\n+    public TokenStore tokenStore()\n+    {\n+        return new JdbcTokenStore( dataSource );\n+    }\n+\n+    @Bean( \"tokenService1\" )\n+    @Primary\n+    public DefaultTokenServices tokenServices()\n+    {\n+        final DefaultTokenServices defaultTokenServices = new DefaultTokenServices();\n+        defaultTokenServices.setTokenStore( tokenStore() );\n+        defaultTokenServices.setSupportRefreshToken( true );\n+        return defaultTokenServices;\n+    }\n+\n+    /**\n+     * This configuration class is responsible for setting up the /api endpoints\n+     */\n+    @Configuration\n+    @Order( 1100 )\n+    public static class ApiWebSecurityConfigurationAdapter extends WebSecurityConfigurerAdapter\n+    {\n+        @Autowired\n+        @Qualifier( \"tokenService1\" )\n+        public ResourceServerTokenServices tokenServices;\n+\n+        @Autowired\n+        @Qualifier( \"defaultClientDetailsService\" )\n+        DefaultClientDetailsService clientDetailsService;\n+\n+        final private SecurityExpressionHandler<FilterInvocation> expressionHandler = new OAuth2WebSecurityExpressionHandler();\n+\n+        final private AuthenticationEntryPoint authenticationEntryPoint = new OAuth2AuthenticationEntryPoint();\n+\n+        final private AccessDeniedHandler accessDeniedHandler = new OAuth2AccessDeniedHandler();\n+\n+        final private String resourceId = \"oauth2-resource\";\n+\n+        /**\n+         * This AuthenticationManager is responsible for authorizing access, refresh and code\n+         * OAuth2 tokens from the /token and /authorize endpoints.\n+         * It is used only by the OAuth2AuthenticationProcessingFilter.\n+         */\n+        private AuthenticationManager oauthAuthenticationManager( HttpSecurity http )\n+        {\n+            OAuth2AuthenticationManager oauthAuthenticationManager = new OAuth2AuthenticationManager();\n+            oauthAuthenticationManager.setResourceId( resourceId );\n+            oauthAuthenticationManager.setTokenServices( tokenServices );\n+            oauthAuthenticationManager.setClientDetailsService( clientDetailsService );\n+\n+            return oauthAuthenticationManager;\n+        }\n+\n+        protected void configure( HttpSecurity http )\n+            throws Exception\n+        {\n+            AuthenticationManager oauthAuthenticationManager = oauthAuthenticationManager( http );\n+            OAuth2AuthenticationProcessingFilter resourcesServerFilter = new OAuth2AuthenticationProcessingFilter();\n+            resourcesServerFilter.setAuthenticationEntryPoint( authenticationEntryPoint );\n+            resourcesServerFilter.setAuthenticationManager( oauthAuthenticationManager );\n+\n+//            if (eventPublisher != null) {", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNzg2NA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476417864", "bodyText": "Is this replaced by other config somewhere?", "author": "larshelge", "createdAt": "2020-08-25T12:43:10Z", "path": "dhis-2/dhis-web/dhis-web-commons/src/main/java/org/hisp/dhis/configuration/SecureCookieConfiguration.java", "diffHunk": "@@ -1,76 +0,0 @@\n-package org.hisp.dhis.configuration;\n-\n-/*\n- * Copyright (c) 2004-2020, University of Oslo\n- * All rights reserved.\n- *\n- * Redistribution and use in source and binary forms, with or without\n- * modification, are permitted provided that the following conditions are met:\n- * Redistributions of source code must retain the above copyright notice, this\n- * list of conditions and the following disclaimer.\n- *\n- * Redistributions in binary form must reproduce the above copyright notice,\n- * this list of conditions and the following disclaimer in the documentation\n- * and/or other materials provided with the distribution.\n- * Neither the name of the HISP project nor the names of its contributors may\n- * be used to endorse or promote products derived from this software without\n- * specific prior written permission.\n- *\n- * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n- * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n- * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n- * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n- * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n- * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n- * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n- * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n- * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n- * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n- */\n-\n-import javax.servlet.ServletContext;\n-import javax.servlet.ServletException;\n-\n-import lombok.extern.slf4j.Slf4j;\n-import org.hisp.dhis.external.conf.ConfigurationKey;\n-import org.hisp.dhis.external.conf.DefaultDhisConfigurationProvider;\n-import org.hisp.dhis.external.conf.DhisConfigurationProvider;\n-import org.hisp.dhis.external.location.DefaultLocationManager;\n-import org.springframework.web.WebApplicationInitializer;\n-\n-/**\n- * Configures cookies to be secure if the {@link ConfigurationKey#SERVER_HTTPS_ONLY} is enabled.\n- *\n- * @author Lars Helge Overland\n- */\n-@Slf4j\n-public class SecureCookieConfiguration", "originalCommit": "68e0effede34bfb9d88e900cad671cd912a5f084", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1NTI5Nw==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476455297", "bodyText": "Yes, this now is controlled in DhisWebApiWebAppInitializer", "author": "netroms", "createdAt": "2020-08-25T13:38:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNzg2NA=="}], "type": "inlineReview"}, {"oid": "4dd494d2e93292a7a651ad4bcaf9b6c0931bf5f5", "url": "https://github.com/dhis2/dhis2-core/commit/4dd494d2e93292a7a651ad4bcaf9b6c0931bf5f5", "message": "feat: Convert xml based config files to java annotation based config\n\n* Fix review comments", "committedDate": "2020-08-25T13:58:23Z", "type": "commit"}, {"oid": "c1f606f57b52c2c6dab63090a488a92461f25d93", "url": "https://github.com/dhis2/dhis2-core/commit/c1f606f57b52c2c6dab63090a488a92461f25d93", "message": "feat: Convert xml based config files to java annotation based config\n\n* Add CurrentUserHandlerMethodArgumentResolver", "committedDate": "2020-08-25T14:22:12Z", "type": "commit"}, {"oid": "7a8dc7fd1201ec093e801c837a85c05ce4e70e0c", "url": "https://github.com/dhis2/dhis2-core/commit/7a8dc7fd1201ec093e801c837a85c05ce4e70e0c", "message": "Merge branch 'master' of github.com:dhis2/dhis2-core into DHIS2-9150", "committedDate": "2020-08-25T14:23:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5MjM3NA==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476492374", "bodyText": "Handle commented code.", "author": "larshelge", "createdAt": "2020-08-25T14:27:25Z", "path": "dhis-2/dhis-web/dhis-web-api-test/src/test/java/org/hisp/dhis/webapi/DhisWebSpringTest.java", "diffHunk": "@@ -66,21 +69,24 @@\n \n import static org.springframework.restdocs.mockmvc.MockMvcRestDocumentation.document;\n import static org.springframework.restdocs.mockmvc.MockMvcRestDocumentation.documentationConfiguration;\n-import static org.springframework.restdocs.operation.preprocess.Preprocessors.*;\n+import static org.springframework.restdocs.operation.preprocess.Preprocessors.preprocessRequest;\n+import static org.springframework.restdocs.operation.preprocess.Preprocessors.preprocessResponse;\n+import static org.springframework.restdocs.operation.preprocess.Preprocessors.prettyPrint;\n \n /**\n  * @author Morten Olav Hansen <mortenoh@gmail.com>\n  */\n @RunWith( SpringRunner.class )\n @WebAppConfiguration\n-@ContextConfiguration(classes = WebTestConfiguration.class)\n-@ActiveProfiles(\"test-h2\")\n+@ContextConfiguration( classes = { MvcTestConfig.class, WebTestConfiguration.class } )\n+@ActiveProfiles( \"test-h2\" )\n @Transactional\n public abstract class DhisWebSpringTest\n     extends DhisConvenienceTest\n {\n-    @Autowired\n-    protected FilterChainProxy filterChainProxy;\n+    // MvcTestConfig.class,\n+//    @Autowired\n+//    protected FilterChainProxy filterChainProxy;", "originalCommit": "7a8dc7fd1201ec093e801c837a85c05ce4e70e0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ5MjUxOQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5953#discussion_r476492519", "bodyText": "Handle commented code.", "author": "larshelge", "createdAt": "2020-08-25T14:27:38Z", "path": "dhis-2/dhis-web/dhis-web-api-test/src/test/java/org/hisp/dhis/webapi/DhisWebSpringTest.java", "diffHunk": "@@ -102,24 +108,30 @@\n     @Rule\n     public JUnitRestDocumentation restDocumentation = new JUnitRestDocumentation( \"target/generated-snippets\" );\n \n+\n     @Before\n-    public void setup() throws Exception\n+    public void setup()\n+        throws Exception\n     {\n+\n         userService = _userService;\n         CharacterEncodingFilter characterEncodingFilter = new CharacterEncodingFilter();\n         characterEncodingFilter.setEncoding( \"UTF-8\" );\n         characterEncodingFilter.setForceEncoding( true );\n         mvc = MockMvcBuilders.webAppContextSetup( webApplicationContext )\n-            .addFilters( characterEncodingFilter, new ShallowEtagHeaderFilter(), filterChainProxy )\n+//            .addFilters( characterEncodingFilter, new ShallowEtagHeaderFilter(), filterChainProxy )", "originalCommit": "7a8dc7fd1201ec093e801c837a85c05ce4e70e0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ee23ee5d895fa1b8b744981abc6faf09202d7c81", "url": "https://github.com/dhis2/dhis2-core/commit/ee23ee5d895fa1b8b744981abc6faf09202d7c81", "message": "feat: Convert xml based config files to java annotation based config\n\n* Remove deprecated org.olap4j.impl.ArrayMap usage", "committedDate": "2020-08-25T14:35:55Z", "type": "commit"}]}