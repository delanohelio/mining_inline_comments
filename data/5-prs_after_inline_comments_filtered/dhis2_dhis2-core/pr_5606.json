{"pr_number": 5606, "pr_title": "refactor: Removing duplication of code in the call of rule engine [DHIS2-7310]", "pr_createdAt": "2020-05-18T11:10:41Z", "pr_url": "https://github.com/dhis2/dhis2-core/pull/5606", "timeline": [{"oid": "c266acccce43c17bd596c2054fae792b104f6e45", "url": "https://github.com/dhis2/dhis2-core/commit/c266acccce43c17bd596c2054fae792b104f6e45", "message": "refactor: Removing duplication of code in the call of rule engine [DHIS2-7310", "committedDate": "2020-05-18T12:06:07Z", "type": "forcePushed"}, {"oid": "503654d3809f752a68d48ada2d67df4678d565b9", "url": "https://github.com/dhis2/dhis2-core/commit/503654d3809f752a68d48ada2d67df4678d565b9", "message": "refactor: Removing duplication of code rule engine call [DHIS2-7310", "committedDate": "2020-05-19T06:49:02Z", "type": "commit"}, {"oid": "503654d3809f752a68d48ada2d67df4678d565b9", "url": "https://github.com/dhis2/dhis2-core/commit/503654d3809f752a68d48ada2d67df4678d565b9", "message": "refactor: Removing duplication of code rule engine call [DHIS2-7310", "committedDate": "2020-05-19T06:49:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgwNDQ0NA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r427804444", "bodyText": "Don't use * wildcard imports.", "author": "larshelge", "createdAt": "2020-05-20T07:43:04Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/ProgramRuleEngine.java", "diffHunk": "@@ -30,20 +30,16 @@\n \n import static com.google.common.base.Preconditions.checkNotNull;\n \n-import java.util.ArrayList;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Map;\n-import java.util.regex.Matcher;\n-import java.util.regex.Pattern;\n+import java.util.*;", "originalCommit": "503654d3809f752a68d48ada2d67df4678d565b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "url": "https://github.com/dhis2/dhis2-core/commit/425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "message": "Fix imports", "committedDate": "2020-05-20T08:28:34Z", "type": "commit"}, {"oid": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "url": "https://github.com/dhis2/dhis2-core/commit/425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "message": "Fix imports", "committedDate": "2020-05-20T08:28:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyNTY1NA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428025654", "bodyText": "Would be good to have a Javadoc on the interface methods to explain what \"evaluate\" means and which effects are run", "author": "luciano-fiandesio", "createdAt": "2020-05-20T13:48:34Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/programrule/engine/ProgramRuleEngineService.java", "diffHunk": "@@ -28,19 +28,15 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import org.hisp.dhis.rules.models.RuleEffect;\n-\n import java.util.List;\n \n+import org.hisp.dhis.rules.models.RuleEffect;\n+\n /**\n  * Created by zubair@dhis2.org on 23.10.17.\n  */\n public interface ProgramRuleEngineService\n {\n-    List<RuleEffect> evaluateEnrollment( String enrollmentUid );\n-\n-    List<RuleEffect> evaluateEvent( String eventUid );\n-\n     List<RuleEffect> evaluateEnrollmentAndRunEffects( long enrollment );", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAyODkxNw==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428028917", "bodyText": "There are a number of unused methods  in this class, perhaps we can clean them up?\nList<Rule> toMappedProgramRules( Program program );\n\nRule toMappedProgramRule( ProgramRule programRule );\n\nList<RuleVariable> toMappedProgramRuleVariables( Program program );", "author": "luciano-fiandesio", "createdAt": "2020-05-20T13:52:29Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/programrule/engine/ProgramRuleEntityMapperService.java", "diffHunk": "@@ -52,7 +53,7 @@\n     List<Rule> toMappedProgramRules();", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzMjM2MQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428032361", "bodyText": "In general, using Optional as method argument is considered a bad practice (kind of controversial). Also read Java 10 docs: https://docs.oracle.com/javase/10/docs/api/java/util/Optional.html\n\nOptional is primarily intended for use as a method return type where there is a clear need to represent \"no result,\" and where using null is likely to cause errors. A variable whose type is Optional should never itself be null; it should always point to an Optional instance.", "author": "luciano-fiandesio", "createdAt": "2020-05-20T13:56:35Z", "path": "dhis-2/dhis-api/src/main/java/org/hisp/dhis/programrule/engine/ProgramRuleEntityMapperService.java", "diffHunk": "@@ -88,13 +89,8 @@\n      *\n      * @return A list of mapped events for the list of DHIS events.\n      */\n-    List<RuleEvent> toMappedRuleEvents( Set<ProgramStageInstance> programStageInstances, ProgramStageInstance psiToEvaluate );\n-\n-    /**\n-     * @param programStageInstances list of events\n-     * @return A list of mapped events for the list of DHIS events.\n-     */\n-    List<RuleEvent> toMappedRuleEvents( Set<ProgramStageInstance> programStageInstances );\n+    List<RuleEvent> toMappedRuleEvents( Set<ProgramStageInstance> programStageInstances,\n+        Optional<ProgramStageInstance> psiToEvaluate );", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY3ODU1OQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428678559", "bodyText": "I can simply remove it and make it nullable, it is not pretty either, but I will not pass Optional as a parameter.\nAnyway, we can discuss more about it", "author": "enricocolasante", "createdAt": "2020-05-21T14:15:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzMjM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzMzkxNw==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428033917", "bodyText": "I think that some docs would be good here: what's old and new?", "author": "luciano-fiandesio", "createdAt": "2020-05-20T13:58:15Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/config/ProgramRuleConfig.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.hisp.dhis.programrule.config;\n+\n+/*\n+ * Copyright (c) 2004-2020, University of Oslo\n+ * All rights reserved.\n+ *\n+ * Redistribution and use in source and binary forms, with or without\n+ * modification, are permitted provided that the following conditions are met:\n+ * Redistributions of source code must retain the above copyright notice, this\n+ * list of conditions and the following disclaimer.\n+ *\n+ * Redistributions in binary form must reproduce the above copyright notice,\n+ * this list of conditions and the following disclaimer in the documentation\n+ * and/or other materials provided with the distribution.\n+ * Neither the name of the HISP project nor the names of its contributors may\n+ * be used to endorse or promote products derived from this software without\n+ * specific prior written permission.\n+ *\n+ * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS \"AS IS\" AND\n+ * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED\n+ * WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE\n+ * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR\n+ * ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES\n+ * (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES;\n+ * LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON\n+ * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n+ * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS\n+ * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n+ */\n+\n+import org.hisp.dhis.constant.ConstantService;\n+import org.hisp.dhis.organisationunit.OrganisationUnitGroupService;\n+import org.hisp.dhis.programrule.ProgramRuleVariableService;\n+import org.hisp.dhis.programrule.engine.*;\n+import org.hisp.dhis.user.CurrentUserService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+\n+/**\n+ * @author Enrico Colasante\n+ */\n+@Configuration( \"ruleEngineConfig\" )\n+public class ProgramRuleConfig\n+{\n+    @Autowired\n+    private ProgramRuleEntityMapperService programRuleEntityMapperService;\n+\n+    @Autowired\n+    private ProgramRuleVariableService programRuleVariableService;\n+\n+    @Autowired\n+    private OrganisationUnitGroupService organisationUnitGroupService;\n+\n+    @Autowired\n+    private RuleVariableInMemoryMap inMemoryMap;\n+\n+    @Autowired\n+    private CurrentUserService currentUserService;\n+\n+    @Autowired\n+    private ConstantService constantService;\n+\n+    @Bean( \"oldRuleEngine\" )\n+    public ProgramRuleEngine oldRuleEngine( OldImplementableRuleService oldImplementableRuleService )", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY3OTA3OA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428679078", "bodyText": "I need to find good names for them as well.\nI am thinking", "author": "enricocolasante", "createdAt": "2020-05-21T14:16:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzMzkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzNTEwNA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428035104", "bodyText": "(minor) The loop:\nfor ( RuleEffect effect : ruleEffects )\n        {\n            ruleActionImplementers.stream().filter( i -> i.accept( effect.ruleAction() ) ).forEach( i -> {\n                log.debug( String.format( \"Invoking action implementer: %s\", i.getClass().getSimpleName() ) );\n\n                i.implement( effect, psi );\n            } );\n        }\n\nis duplicated in the same class, can it be refactored to avoid duplication?", "author": "luciano-fiandesio", "createdAt": "2020-05-20T13:59:41Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/DefaultProgramRuleEngineService.java", "diffHunk": "@@ -82,12 +85,18 @@ public DefaultProgramRuleEngineService( ProgramRuleEngine programRuleEngine,\n     public List<RuleEffect> evaluateEnrollmentAndRunEffects( long programInstanceId )\n     {\n         ProgramInstance programInstance = programInstanceService.getProgramInstance( programInstanceId );\n-        List<RuleEffect> ruleEffects = getRuleEffects( programInstance );\n+\n+        if ( programInstance == null )\n+        {\n+            return Lists.newArrayList();\n+        }\n+\n+        List<RuleEffect> ruleEffects = getRuleEffects( programInstance, Optional.empty(),\n+            programInstance.getProgramStageInstances() );\n \n         for ( RuleEffect effect : ruleEffects )\n         {\n-            ruleActionImplementers.stream().filter( i -> i.accept( effect.ruleAction() ) ).forEach( i ->\n-            {\n+            ruleActionImplementers.stream().filter( i -> i.accept( effect.ruleAction() ) ).forEach( i -> {", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY2MTgxOA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428661818", "bodyText": "It is duplicated but it is slightly different because the implement method is called one time for ProgramInstance and another time for ProgramStageInstance.\nI will eventually refactor it to avoid this duplication, just not yet.", "author": "enricocolasante", "createdAt": "2020-05-21T13:47:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODAzNTEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0MzQ2NQ==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428043465", "bodyText": "We try to stick to constructor based injection, using this \"template\":\nimport static com.google.common.base.Preconditions.checkNotNull;\n\npublic OldImplementableRuleService( ProgramRuleService programRuleService )\n    {\n        checkNotNull( programRuleService );\n        this.programRuleService = programRuleService;\n    }", "author": "luciano-fiandesio", "createdAt": "2020-05-20T14:10:13Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/OldImplementableRuleService.java", "diffHunk": "@@ -28,48 +26,37 @@\n  * SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n  */\n \n-import javax.annotation.Nonnull;\n+package org.hisp.dhis.programrule.engine;\n \n-import org.apache.commons.jexl2.JexlException;\n-import org.hisp.dhis.commons.util.DebugUtils;\n-import org.hisp.dhis.commons.util.ExpressionUtils;\n-import org.hisp.dhis.rules.RuleExpressionEvaluator;\n-import org.springframework.stereotype.Component;\n+import java.util.List;\n \n-import lombok.extern.slf4j.Slf4j;\n+import org.hisp.dhis.program.Program;\n+import org.hisp.dhis.programrule.ProgramRule;\n+import org.hisp.dhis.programrule.ProgramRuleActionType;\n+import org.hisp.dhis.programrule.ProgramRuleService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n \n-/**\n- * Created by zubair@dhis2.org on 11.10.17.\n- */\n-@Slf4j\n-@Component( \"org.hisp.dhis.programrule.engine.ProgramRuleExpressionEvaluator\" )\n-public class ProgramRuleExpressionEvaluator implements RuleExpressionEvaluator\n+@Component\n+public class OldImplementableRuleService implements ImplementableRuleService\n {\n-    /**\n-     * Return string value of boolean output. False will be returned in case\n-     * of wrongly created expression\n-     *\n-     * @param expression to be evaluated.\n-     * @return string value of boolean true/false.\n-     */\n+    @Autowired\n+    private ProgramRuleService programRuleService;", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0NDQyOA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428044428", "bodyText": "Same consideration as before regarding Optional as method param", "author": "luciano-fiandesio", "createdAt": "2020-05-20T14:11:17Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/ProgramRuleEngine.java", "diffHunk": "@@ -88,108 +75,65 @@\n \n     private final ConstantService constantService;\n \n+    private final ImplementableRuleService implementableRuleService;\n+\n     public ProgramRuleEngine( ProgramRuleEntityMapperService programRuleEntityMapperService,\n-        ProgramRuleExpressionEvaluator programRuleExpressionEvaluator, ProgramRuleService programRuleService,\n         ProgramRuleVariableService programRuleVariableService,\n         OrganisationUnitGroupService organisationUnitGroupService, RuleVariableInMemoryMap inMemoryMap,\n-        CurrentUserService currentUserService, ConstantService constantService )\n+        CurrentUserService currentUserService, ConstantService constantService,\n+        ImplementableRuleService implementableRuleService )\n     {\n \n         checkNotNull( programRuleEntityMapperService );\n-        checkNotNull( programRuleExpressionEvaluator );\n-        checkNotNull( programRuleService );\n         checkNotNull( programRuleVariableService );\n         checkNotNull( organisationUnitGroupService );\n         checkNotNull( currentUserService );\n         checkNotNull( inMemoryMap );\n         checkNotNull( constantService );\n+        checkNotNull( implementableRuleService );\n \n         this.programRuleEntityMapperService = programRuleEntityMapperService;\n-        this.programRuleExpressionEvaluator = programRuleExpressionEvaluator;\n-        this.programRuleService = programRuleService;\n         this.programRuleVariableService = programRuleVariableService;\n         this.organisationUnitGroupService = organisationUnitGroupService;\n         this.inMemoryMap = inMemoryMap;\n         this.currentUserService = currentUserService;\n         this.constantService = constantService;\n+        this.implementableRuleService = implementableRuleService;\n     }\n \n-    public List<RuleEffect> evaluateEnrollment(ProgramInstance enrollment )\n+    public List<RuleEffect> evaluate( ProgramInstance enrollment, Optional<ProgramStageInstance> programStageInstance,", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0NjMyMA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428046320", "bodyText": "Why do we need to open a transaction here? It seems that all the dependencies open their own TX?\nAlso, I noticed that the class DefaultProgramRuleService uses a class level @Transactional annotation, which open a read/write TX also for get only method. I know it's outside the scope of this PR, but perhaps we can fix it.", "author": "luciano-fiandesio", "createdAt": "2020-05-20T14:13:42Z", "path": "dhis-2/dhis-services/dhis-service-program-rule/src/main/java/org/hisp/dhis/programrule/engine/ProgramRuleEngine.java", "diffHunk": "@@ -52,32 +52,19 @@\n import org.hisp.dhis.rules.models.*;\n import org.hisp.dhis.user.CurrentUserService;\n import org.hisp.dhis.user.UserAuthorityGroup;\n-import org.springframework.stereotype.Component;\n import org.springframework.transaction.annotation.Transactional;\n \n-import lombok.extern.slf4j.Slf4j;\n-\n /**\n  * Created by zubair@dhis2.org on 11.10.17.\n  */\n @Slf4j\n @Transactional( readOnly = true )", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODA0OTc4OA==", "url": "https://github.com/dhis2/dhis2-core/pull/5606#discussion_r428049788", "bodyText": "(minor) Missing javadoc, either remove the @param or fill the missing info", "author": "luciano-fiandesio", "createdAt": "2020-05-20T14:17:50Z", "path": "dhis-2/dhis-services/dhis-service-tracker/src/main/java/org/hisp/dhis/tracker/TrackerProgramRuleService.java", "diffHunk": "@@ -42,20 +44,23 @@\n public interface TrackerProgramRuleService\n {\n     /**\n-     * It feeds in enrollments given in {@link TrackerBundle} into rule engine and return a map of provided enrollments and\n-     * their associated rule effects which are returned by rule engine.\n+     * It feeds in enrollments given in {@link TrackerBundle} into rule engine and\n+     * return a map of provided enrollments and their associated rule effects which\n+     * are returned by rule engine.\n      *\n-     * @param trackerBundle\n+     * @param enrollments", "originalCommit": "425dcad30eaf4394c7cbf33614d2f2bd40ba2c27", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}