{"pr_number": 1662, "pr_title": "Periodic Transactions garbage collection", "pr_createdAt": "2020-04-14T21:25:04Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1662", "timeline": [{"oid": "e2de2fff676dc09baa81941a3ef0e133fad21f79", "url": "https://github.com/fcrepo/fcrepo/commit/e2de2fff676dc09baa81941a3ef0e133fad21f79", "message": "Cleanup closed transactions on a regular basis, but only if they have expired. This will also expire and rollback stale transactions", "committedDate": "2020-04-14T21:09:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NjAxNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1662#discussion_r408476017", "bodyText": "Don't we remove the transaction as soon as it is committed or rolled back?", "author": "whikloj", "createdAt": "2020-04-14T22:36:16Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/TransactionManagerImpl.java", "diffHunk": "@@ -52,10 +54,32 @@\n     private EventAccumulator eventAccumulator;\n \n     TransactionManagerImpl() {\n-        transactions = new HashMap<>();\n+        transactions = new ConcurrentHashMap<>();\n     }\n \n-    // TODO Add a timer to periodically rollback and cleanup expired transaction?\n+    /**\n+     * Periodically scan for closed transactions for cleanup\n+     */\n+    @Scheduled(fixedDelayString = \"#{systemProperties['fcrepo.session.timeout'] ?: 180000}\")\n+    public void cleanupClosedTransactions() {\n+        final var txIt = transactions.entrySet().iterator();\n+        while (txIt.hasNext()) {\n+            final var txEntry = txIt.next();\n+            final var tx = txEntry.getValue();\n+\n+            // Cleanup if transaction is closed and past its expiration time\n+            if (tx.isCommitted() || tx.isRolledBack()) {", "originalCommit": "e2de2fff676dc09baa81941a3ef0e133fad21f79", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NjkxOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1662#discussion_r408476918", "bodyText": "I see now that we are hanging on to transaction regardless of state until the clean up period. Just wondering if there is any value to having those transactions that have been actively committed or rolled back?", "author": "whikloj", "createdAt": "2020-04-14T22:38:43Z", "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/TransactionManagerImplTest.java", "diffHunk": "@@ -88,8 +97,108 @@ public void testGetTransactionWithInvalidID() {\n     }\n \n     @Test(expected = TransactionRuntimeException.class)\n-    public void testGetExpiredTransaction() {\n+    public void testGetExpiredTransaction() throws Exception {\n         testTx.expire();\n-        testTxManager.get(testTx.getId());\n+        try {\n+            testTxManager.get(testTx.getId());\n+        } finally {\n+            // Make sure rollback is triggered\n+            verify(psSession).rollback();\n+        }\n+    }\n+\n+    @Test\n+    public void testCleanupClosedTransactions() {\n+        System.setProperty(TransactionImpl.TIMEOUT_SYSTEM_PROPERTY, \"10000\");\n+\n+        final var commitTx = testTxManager.create();\n+        commitTx.commit();\n+        final var continuingTx = testTxManager.create();\n+        final var rollbackTx = testTxManager.create();\n+        rollbackTx.rollback();\n+\n+        // verify that transactions retrievable before cleanup\n+        try {\n+            testTxManager.get(commitTx.getId());\n+            fail(\"Transaction must be committed\");\n+        } catch(final TransactionClosedException e) {\n+            //expected\n+        }\n+        try {\n+            testTxManager.get(rollbackTx.getId());\n+            fail(\"Transaction must be rolled back\");\n+        } catch(final TransactionClosedException e) {\n+            //expected\n+        }\n+\n+        assertNotNull(\"Continuing transaction must be present\",\n+                testTxManager.get(continuingTx.getId()));\n+\n+        testTxManager.cleanupClosedTransactions();\n+\n+        // Verify that the closed transactions are stick around since they haven't expired yet", "originalCommit": "e2de2fff676dc09baa81941a3ef0e133fad21f79", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc0MTI5Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1662#discussion_r409741292", "bodyText": "If there are multiple clients using the same transaction it might be helpful to be able to check the status, which we aren't disallowing at the moment. Figured it'd be good to have a consistent window for being able to look up what happened to a transaction", "author": "bbpennel", "createdAt": "2020-04-16T17:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ3NjkxOA=="}], "type": "inlineReview"}, {"oid": "28c1061752b45e8a7d6b645b59f4503781cf4ead", "url": "https://github.com/fcrepo/fcrepo/commit/28c1061752b45e8a7d6b645b59f4503781cf4ead", "message": "Add sleep", "committedDate": "2020-04-21T13:15:57Z", "type": "commit"}]}