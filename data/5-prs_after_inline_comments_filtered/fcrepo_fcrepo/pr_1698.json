{"pr_number": 1698, "pr_title": "start work centralizing config props and add fcrepo.home", "pr_createdAt": "2020-06-11T13:22:38Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1698", "timeline": [{"oid": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "url": "https://github.com/fcrepo/fcrepo/commit/e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "message": "start work centralizing config props", "committedDate": "2020-06-11T13:09:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNTUwOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438825509", "bodyText": "Have you tested these with IntelliJ and Eclipse? It would be good to get @bbpennel 's sign-off.", "author": "awoods", "createdAt": "2020-06-11T14:24:33Z", "path": "fcrepo-configs/src/main/java/org/fcrepo/config/FedoraPropsConfig.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * General Fedora properties\n+ */\n+@Configuration\n+public class FedoraPropsConfig {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(FedoraPropsConfig.class);\n+\n+    private static final String DATA_DIR = \"data\";\n+\n+    @Value(\"${fcrepo.home:fcrepo}\")\n+    private Path fedoraHome;\n+\n+    @Value(\"#{fedoraPropsConfig.fedoraHome.resolve('\" + DATA_DIR + \"')}\")", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1MjE3OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438852178", "bodyText": "Have not tested in Eclipse", "author": "pwinckles", "createdAt": "2020-06-11T15:02:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNTUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzE4Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438827183", "bodyText": "Please add @author javadoc... and ideally, @since 2020-06-11.\nOur checkstyle used to enforce the @author... not sure why that is no longer working, hmm.", "author": "awoods", "createdAt": "2020-06-11T14:26:52Z", "path": "fcrepo-configs/src/main/java/org/fcrepo/config/FedoraPropsConfig.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * General Fedora properties\n+ */", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg2MjczMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438862732", "bodyText": "Also, I learned that @since is supposed to list the first version the class was added so you can tell when it became part of the codebase. I used to list date, but now am trying to stick @since 6.0.0 in new ones. \ud83e\udd37", "author": "whikloj", "createdAt": "2020-06-11T15:17:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzE4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTUzOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438885539", "bodyText": "done", "author": "pwinckles", "createdAt": "2020-06-11T15:44:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzE4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzI5MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438827290", "bodyText": "Please add @author javadoc... and ideally, @since 2020-06-11.", "author": "awoods", "createdAt": "2020-06-11T14:27:02Z", "path": "fcrepo-configs/src/main/java/org/fcrepo/config/OcflPropsConfig.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * Fedora's OCFL related configuration properties", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTY0Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438885646", "bodyText": "done", "author": "pwinckles", "createdAt": "2020-06-11T15:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzkzNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438827936", "bodyText": "Normally I do not like the logs to be too chatty... but these three messages are important to see at startup.\nCan you change them to LOGGER.info()?", "author": "awoods", "createdAt": "2020-06-11T14:27:54Z", "path": "fcrepo-configs/src/main/java/org/fcrepo/config/OcflPropsConfig.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.fcrepo.config;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Configuration;\n+\n+import javax.annotation.PostConstruct;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+\n+/**\n+ * Fedora's OCFL related configuration properties\n+ */\n+@Configuration\n+public class OcflPropsConfig {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(OcflPropsConfig.class);\n+\n+    private static final String OCFL_STAGING = \"staging\";\n+    private static final String OCFL_ROOT = \"ocfl-root\";\n+    private static final String OCFL_TEMP = \"ocfl-temp\";\n+\n+    @Value(\"${fcrepo.ocfl.staging:#{fedoraPropsConfig.fedoraData.resolve('\" + OCFL_STAGING + \"')}}\")\n+    private Path fedoraOcflStaging;\n+\n+    @Value(\"${fcrepo.ocfl.root:#{fedoraPropsConfig.fedoraData.resolve('\" + OCFL_ROOT + \"')}}\")\n+    private Path ocflRepoRoot;\n+\n+    @Value(\"${fcrepo.ocfl.temp:#{fedoraPropsConfig.fedoraData.resolve('\" + OCFL_TEMP + \"')}}\")\n+    private Path ocflTemp;\n+\n+    @PostConstruct\n+    private void postConstruct() throws IOException {\n+        LOGGER.debug(\"Fedora staging: {}\", fedoraOcflStaging);", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTc1Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438885756", "bodyText": "done", "author": "pwinckles", "createdAt": "2020-06-11T15:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgyNzkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMDE1MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438830150", "bodyText": "Would it make sense to define this constant statically on OcflPropsConfig.java?", "author": "awoods", "createdAt": "2020-06-11T14:30:49Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -57,28 +54,20 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n \n-    private static String origStorageRootDir;\n-    private static String origWorkDir;\n+    private static final String OCFL_ROOT_PROP = \"fcrepo.ocfl.root\";", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTgzNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438885836", "bodyText": "done", "author": "pwinckles", "createdAt": "2020-06-11T15:44:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMDE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMDk4OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438830989", "bodyText": "Is there a potential need to reset the value of this property to what it was before this test?", "author": "awoods", "createdAt": "2020-06-11T14:32:01Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -57,28 +54,20 @@\n \n     private static final Logger LOGGER = LoggerFactory.getLogger(RebuildIT.class);\n \n-    private static String origStorageRootDir;\n-    private static String origWorkDir;\n+    private static final String OCFL_ROOT_PROP = \"fcrepo.ocfl.root\";\n \n     private OcflRepository ocflRepository;\n \n     private IndexBuilder indexBuilder;\n \n     @BeforeClass\n     public static void beforeClass() {\n-        // Save the pre-test System Property values\n-        origStorageRootDir = getProperty(OCFL_STORAGE_ROOT_DIR_KEY);\n-        origWorkDir = getProperty(OCFL_WORK_DIR_KEY);\n-\n-        System.setProperty(OCFL_STORAGE_ROOT_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");\n-        System.setProperty(OCFL_WORK_DIR_KEY, \"target/test-classes/test-rebuild-ocfl/ocfl-work\");\n+        System.setProperty(OCFL_ROOT_PROP, \"target/test-classes/test-rebuild-ocfl/ocfl-root\");\n     }\n \n     @AfterClass\n     public static void afterClass() {\n-        // Restore pre-test System Property values\n-        System.setProperty(OCFL_STORAGE_ROOT_DIR_KEY, origStorageRootDir);\n-        System.setProperty(OCFL_WORK_DIR_KEY, origWorkDir);\n+        System.clearProperty(OCFL_ROOT_PROP);", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg1Mjg1Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438852856", "bodyText": "Since the default is to NOT have that property set, any test that is setting the property should clear it when they're done.", "author": "pwinckles", "createdAt": "2020-06-11T15:03:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzMDk4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzOTc4MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438839780", "bodyText": "Maybe reduce this logging to debug, in favor of the cleaner output of OcflPropsConfig.", "author": "awoods", "createdAt": "2020-06-11T14:44:46Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DefaultOCFLObjectSessionFactory.java", "diffHunk": "@@ -52,39 +56,36 @@\n     @Value(\"${fcrepo.autoversioning.enabled:true}\")\n     private boolean autoVersioningEnabled;\n \n-    private File ocflStagingDir;\n+    private final Path ocflStagingDir;\n \n     @Inject\n     private MutableOcflRepository ocflRepository;\n \n-    /**\n-     * Default Constructor.  You can set the ocfl staging, storage root, and work directories by setting the following\n-     * system properties: fcrepo.ocfl.staging.dir, fcrepo.ocfl.storage.root.dir, and  fcrepo.ocfl.work.dir.  If these\n-     * are not set, default directories will be created in java.io.tmpdir.\n-     */\n-    public DefaultOCFLObjectSessionFactory() {\n-        this(new OCFLConstants().getStagingDir());\n-    }\n-\n     /**\n      * Constructor\n      *\n      * @param ocflStagingDir     The OCFL staging directory\n      */\n-    public DefaultOCFLObjectSessionFactory(final File ocflStagingDir) {\n+    @Autowired\n+    public DefaultOCFLObjectSessionFactory(\n+            @Value(\"#{ocflPropsConfig.fedoraOcflStaging}\")\n+            final Path ocflStagingDir) {\n         LOGGER.info(\"Fedora OCFL persistence staging directory:\\n- {}\",", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NTk5OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438885999", "bodyText": "done", "author": "pwinckles", "createdAt": "2020-06-11T15:45:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODgzOTc4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0MDYyMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438840620", "bodyText": "Maybe reduce this logging to debug, in favor of the cleaner output of OcflPropsConfig.", "author": "awoods", "createdAt": "2020-06-11T14:45:54Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtils.java", "diffHunk": "@@ -385,15 +386,16 @@ public static String mintOCFLObjectId(final String fedoraIdentifier) {\n      * @param ocflWorkDir The ocfl work directory\n      * @return the repository\n      */\n-    public static MutableOcflRepository createRepository(final File ocflStorageRootDir, final File ocflWorkDir) {\n-        ocflStorageRootDir.mkdirs();\n-        ocflWorkDir.mkdirs();\n+    public static MutableOcflRepository createRepository(final Path ocflStorageRootDir, final Path ocflWorkDir)\n+            throws IOException {\n+        Files.createDirectories(ocflStorageRootDir);\n+        Files.createDirectories(ocflWorkDir);\n \n         log.info(\"Fedora OCFL persistence directories:\\n- {}\\n- {}\", ocflStorageRootDir, ocflWorkDir);", "originalCommit": "e3ff5fa7c0790358dd9b9e057869c20582ae09b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg4NjExOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1698#discussion_r438886119", "bodyText": "done", "author": "pwinckles", "createdAt": "2020-06-11T15:45:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODg0MDYyMA=="}], "type": "inlineReview"}, {"oid": "4ef95b8152e9a7e9f69620cde8a44a1d0e3644e9", "url": "https://github.com/fcrepo/fcrepo/commit/4ef95b8152e9a7e9f69620cde8a44a1d0e3644e9", "message": "pr comments", "committedDate": "2020-06-11T15:42:37Z", "type": "commit"}]}