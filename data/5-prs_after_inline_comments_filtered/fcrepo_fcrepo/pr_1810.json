{"pr_number": 1810, "pr_title": "Alter ETag based on contained resources", "pr_createdAt": "2020-11-18T05:31:36Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1810", "timeline": [{"oid": "99c9a9777d85efcce0f5fca9b46f5259b978147f", "url": "https://github.com/fcrepo/fcrepo/commit/99c9a9777d85efcce0f5fca9b46f5259b978147f", "message": "Use a last modified containment instead of a hash of contained resources", "committedDate": "2020-11-20T22:48:24Z", "type": "forcePushed"}, {"oid": "9701cd98084752071169fd8e39d85c9e27831f55", "url": "https://github.com/fcrepo/fcrepo/commit/9701cd98084752071169fd8e39d85c9e27831f55", "message": "Use datetime instead of timestamp", "committedDate": "2020-11-25T20:01:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDgxOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1810#discussion_r531030819", "bodyText": "This code is only relevant when loading a container, correct? If so, I think we should only do this lookup when necessary.\nThis code would also be a good candidate for caching in the future.", "author": "pwinckles", "createdAt": "2020-11-26T13:30:59Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/models/ResourceFactoryImpl.java", "diffHunk": "@@ -193,14 +194,18 @@ private FedoraResource instantiateResource(final String transactionId,\n         }\n     }\n \n-    private void populateResourceHeaders(final FedoraResourceImpl resc, final ResourceHeaders headers,\n-                                         final Instant version) {\n+    private void populateResourceHeaders(final String transactionId, final FedoraResourceImpl resc,\n+                                         final ResourceHeaders headers, final Instant version) {\n         resc.setCreatedBy(headers.getCreatedBy());\n         resc.setCreatedDate(headers.getCreatedDate());\n         resc.setLastModifiedBy(headers.getLastModifiedBy());\n         resc.setLastModifiedDate(headers.getLastModifiedDate());\n         resc.setParentId(headers.getParent());\n-        resc.setEtag(headers.getStateToken());\n+        final Instant containmentUpdated = containmentIndex.containmentLastUpdated(transactionId, resc.getFedoraId());", "originalCommit": "9701cd98084752071169fd8e39d85c9e27831f55", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMzE3OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1810#discussion_r531033178", "bodyText": "I'm guessing that there will be similar code to this for membership? It might be nice to abstract the etag computation out into its own class, but you don't necessarily need to do so here.", "author": "pwinckles", "createdAt": "2020-11-26T13:35:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTA4MTQzMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1810#discussion_r531081432", "bodyText": "One of the reasons I liked the previous implementation is that if the containment didn't change then neither did the eTag. But this was more consistent across DBs. Perhaps we just need to stream all containment and generate a hash in code rather than trying to do it in the database.", "author": "whikloj", "createdAt": "2020-11-26T14:53:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzMDgxOQ=="}], "type": "inlineReview"}, {"oid": "30b22e3f6e5cc81395e2a6b3f7fad016286a11ab", "url": "https://github.com/fcrepo/fcrepo/commit/30b22e3f6e5cc81395e2a6b3f7fad016286a11ab", "message": "Check end_time to get correct last updated after reindex.", "committedDate": "2020-11-26T19:49:36Z", "type": "forcePushed"}, {"oid": "15f29428e2d7d58cde74610eb3c6d48897c4abd3", "url": "https://github.com/fcrepo/fcrepo/commit/15f29428e2d7d58cde74610eb3c6d48897c4abd3", "message": "Alter ETag based on contained resources", "committedDate": "2020-11-27T18:44:19Z", "type": "commit"}, {"oid": "38fbd4c8401b5a397cd6856e8e285e8935850f48", "url": "https://github.com/fcrepo/fcrepo/commit/38fbd4c8401b5a397cd6856e8e285e8935850f48", "message": "Use a last modified containment instead of a hash of contained resources", "committedDate": "2020-11-27T18:45:10Z", "type": "commit"}, {"oid": "3d292cdc076c6dd9cc3a6f188a2e49f90f8a6238", "url": "https://github.com/fcrepo/fcrepo/commit/3d292cdc076c6dd9cc3a6f188a2e49f90f8a6238", "message": "Use datetime instead of timestamp", "committedDate": "2020-11-27T18:45:15Z", "type": "commit"}, {"oid": "3797d63ab87d57d42d5c8d0c62593969c60c8f68", "url": "https://github.com/fcrepo/fcrepo/commit/3797d63ab87d57d42d5c8d0c62593969c60c8f68", "message": "Check end_time to get correct last updated after reindex.", "committedDate": "2020-11-27T18:45:15Z", "type": "commit"}, {"oid": "6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "url": "https://github.com/fcrepo/fcrepo/commit/6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "message": "Only query for containment on Containers", "committedDate": "2020-11-27T18:45:15Z", "type": "commit"}, {"oid": "6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "url": "https://github.com/fcrepo/fcrepo/commit/6fae73ad0f4986fe49abbfd3e4a6c5b183b6bf9d", "message": "Only query for containment on Containers", "committedDate": "2020-11-27T18:45:15Z", "type": "forcePushed"}]}