{"pr_number": 1765, "pr_title": "Make ghost nodes immutable - FCREPO-3256", "pr_createdAt": "2020-10-06T14:03:53Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1765", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2ODk0NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r500568945", "bodyText": "Maybe change \"immutable node\" to \"immutable resource\"?", "author": "awoods", "createdAt": "2020-10-06T20:14:58Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraLdp.java", "diffHunk": "@@ -404,6 +405,10 @@ public Response createOrReplaceObjectRdf(\n             //}\n         }\n \n+        if (isGhostNode(transaction(), fedoraId)) {\n+            throw new GhostNodeException(\"Resource path \" + externalPath() + \" is an immutable node.\");", "originalCommit": "fa46232ca6f8f4f74deecef52dddd5666abd2de5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3MjAzOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r500572038", "bodyText": "This seems more like a method that would be on FedoraResource than ResourceFactory.\n..such as isAcl() and isMemento().", "author": "awoods", "createdAt": "2020-10-06T20:20:52Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/models/ResourceFactory.java", "diffHunk": "@@ -112,4 +112,17 @@ public FedoraResource getResource(final String transactionId, final FedoraId fed\n      * @return Stream of child resources\n      */\n     public Stream<FedoraResource> getChildren(final String transactionId, final FedoraId resourceId);\n+\n+    /**\n+     * Is the resource a \"ghost node\". Ghost nodes are defined as a resource that does not exist, but whose URI is part\n+     * of the URI of another resource? For example:\n+     *\n+     * http://localhost/rest/a/b - does exist\n+     * http://localhost/rest/a - does not exist and is therefore a ghost node.\n+     *\n+     * @param transaction The transaction\n+     * @param resourceId Identifier of the resource\n+     * @return Whether the resource does not exist, but has\n+     */\n+    public boolean isGhostNode(final Transaction transaction, final FedoraId resourceId);", "originalCommit": "fa46232ca6f8f4f74deecef52dddd5666abd2de5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk5OTM0Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r500999343", "bodyText": "The use of isGhostNode in the mintNewPid, seems to make adding this method to FedoraResource make less sense. Alternatively I can move the actual check down to the AbstractService which also has access to the ContainmentIndex.", "author": "whikloj", "createdAt": "2020-10-07T13:11:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3MjAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAwNTIzOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r501005239", "bodyText": "Actually the use of isGhostNode in the mintNewPid means this needs to exist here, because in that case we don't fail we just mint a new pid. So I think the current location is best and the use of ResourceFactory is just because we don't Inject the ContainmentIndex to the Http layer.", "author": "whikloj", "createdAt": "2020-10-07T13:19:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3MjAzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3Mzc5MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r500573791", "bodyText": "Maybe as a separate clean-up task, this interface should normalize on using ID or Id. Currently it is a complete mix.", "author": "awoods", "createdAt": "2020-10-06T20:24:15Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/ContainmentIndex.java", "diffHunk": "@@ -124,4 +124,11 @@\n      */\n     void reset();\n \n+    /**\n+     * Find whether there are any resources that starts with the ID provided.\n+     * @param txID The transaction id, or null if no transaction.\n+     * @param fedoraId The ID to use to look for other IDs.\n+     * @return Are there any matching IDs.\n+     */\n+    boolean hasResourcesStartingWith(final String txID, final FedoraId fedoraId);", "originalCommit": "fa46232ca6f8f4f74deecef52dddd5666abd2de5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTAwMTIyOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r501001228", "bodyText": "I'll clean it up now.", "author": "whikloj", "createdAt": "2020-10-07T13:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3Mzc5MQ=="}], "type": "inlineReview"}, {"oid": "724325e82e96115d6ba483c966c956dd14fbce5a", "url": "https://github.com/fcrepo/fcrepo/commit/724325e82e96115d6ba483c966c956dd14fbce5a", "message": "Make ghost nodes immutable - FCREPO-3256", "committedDate": "2020-10-07T18:38:02Z", "type": "commit"}, {"oid": "0266dc575e830e53ac6609a89739380d4d4b0fff", "url": "https://github.com/fcrepo/fcrepo/commit/0266dc575e830e53ac6609a89739380d4d4b0fff", "message": "Code review", "committedDate": "2020-10-07T18:38:02Z", "type": "commit"}, {"oid": "222a8983b242eaf526cda668e3eec33a47ccca30", "url": "https://github.com/fcrepo/fcrepo/commit/222a8983b242eaf526cda668e3eec33a47ccca30", "message": "One last javadoc", "committedDate": "2020-10-07T18:38:02Z", "type": "commit"}, {"oid": "c7a04639480f9ed71e013e16d1f075b625d086b0", "url": "https://github.com/fcrepo/fcrepo/commit/c7a04639480f9ed71e013e16d1f075b625d086b0", "message": "Add method to ContainmentIndexMetrics", "committedDate": "2020-10-07T18:40:52Z", "type": "commit"}, {"oid": "c7a04639480f9ed71e013e16d1f075b625d086b0", "url": "https://github.com/fcrepo/fcrepo/commit/c7a04639480f9ed71e013e16d1f075b625d086b0", "message": "Add method to ContainmentIndexMetrics", "committedDate": "2020-10-07T18:40:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNDE5MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r501304191", "bodyText": "Very minor: one last fedoraID", "author": "awoods", "createdAt": "2020-10-07T20:54:59Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/ContainmentIndex.java", "diffHunk": "@@ -105,23 +105,30 @@\n     /**\n      * Check if the resourceID exists in the containment index. Which should mean it exists.\n      *\n-     * @param txID The transaction id, or null if no transaction\n+     * @param txId The transaction id, or null if no transaction\n      * @param fedoraID The resource's FedoraId.\n      * @return True if it is in the index.\n      */\n-    boolean resourceExists(final String txID, final FedoraId fedoraID);\n+    boolean resourceExists(final String txId, final FedoraId fedoraID);", "originalCommit": "c7a04639480f9ed71e013e16d1f075b625d086b0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNjEwNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1765#discussion_r501306107", "bodyText": "Doh \ud83e\udd26", "author": "whikloj", "createdAt": "2020-10-07T20:58:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMwNDE5MQ=="}], "type": "inlineReview"}, {"oid": "825ed063828d28ebaa5a2f0c2f5e18b75b3e01b0", "url": "https://github.com/fcrepo/fcrepo/commit/825ed063828d28ebaa5a2f0c2f5e18b75b3e01b0", "message": "Last ID", "committedDate": "2020-10-07T21:02:41Z", "type": "commit"}, {"oid": "0f766bb5ab8f84647cf3894ca7abce51d591f58c", "url": "https://github.com/fcrepo/fcrepo/commit/0f766bb5ab8f84647cf3894ca7abce51d591f58c", "message": "Refactor ResourceFactory", "committedDate": "2020-10-07T22:34:49Z", "type": "commit"}]}