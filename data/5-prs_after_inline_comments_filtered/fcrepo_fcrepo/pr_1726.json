{"pr_number": 1726, "pr_title": "Implements rdf_type parameter and output field in simple search.", "pr_createdAt": "2020-07-16T21:25:52Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1726", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MjM5Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r458242396", "bodyText": "This method is huge, is it possible to split any of this functionality out into submethods?", "author": "pwinckles", "createdAt": "2020-07-21T16:47:40Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -209,20 +261,73 @@ public void addUpdateIndex(final ResourceHeaders resourceHeaders) {\n         final var txId = UUID.randomUUID().toString();\n         executeInDbTransaction(txId, status -> {\n             try {\n+                final var rdfTypes = new ArrayList<String>();", "originalCommit": "16d29d6d5de56e8eaa8799faf0af391b5045d89f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MDczNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r459070735", "bodyText": "yes good idea.", "author": "dbernstein", "createdAt": "2020-07-22T20:42:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0MjM5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTEwNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r458249106", "bodyText": "Table and column names can be constants", "author": "pwinckles", "createdAt": "2020-07-21T16:58:10Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -209,20 +261,73 @@ public void addUpdateIndex(final ResourceHeaders resourceHeaders) {\n         final var txId = UUID.randomUUID().toString();\n         executeInDbTransaction(txId, status -> {\n             try {\n+                final var rdfTypes = new ArrayList<String>();\n+                rdfTypes.add(resourceHeaders.getInteractionModel());\n+                final var fedoraResource = resourceFactory.getResource(FedoraId.create(fullId)).getDescription();\n+                fedoraResource.getTriples().forEach(triple -> {\n+                    if (triple.getPredicate().getURI().equals(\"http://www.w3.org/1999/02/22-rdf-syntax-ns#type\")) {\n+                        final var rdfTypeUri = triple.getObject().getURI();\n+                        rdfTypes.add(rdfTypeUri);\n+                    }\n+                });\n+\n+                final var jdbcInsertRdfTypes = new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate());\n+                jdbcInsertRdfTypes.withTableName(\"search_rdf_type\").usingGeneratedKeyColumns(", "originalCommit": "16d29d6d5de56e8eaa8799faf0af391b5045d89f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MDgzOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r459070839", "bodyText": "will do.", "author": "dbernstein", "createdAt": "2020-07-22T20:42:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTQwMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r458249403", "bodyText": "Is there a reason you're using getTriples() instead of getTypes()?", "author": "pwinckles", "createdAt": "2020-07-21T16:58:38Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -209,20 +261,73 @@ public void addUpdateIndex(final ResourceHeaders resourceHeaders) {\n         final var txId = UUID.randomUUID().toString();\n         executeInDbTransaction(txId, status -> {\n             try {\n+                final var rdfTypes = new ArrayList<String>();\n+                rdfTypes.add(resourceHeaders.getInteractionModel());\n+                final var fedoraResource = resourceFactory.getResource(FedoraId.create(fullId)).getDescription();\n+                fedoraResource.getTriples().forEach(triple -> {", "originalCommit": "16d29d6d5de56e8eaa8799faf0af391b5045d89f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MTIxOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r459071219", "bodyText": "I didn't realize the user types are provided as well - looks like getTypes() is a better choice.", "author": "dbernstein", "createdAt": "2020-07-22T20:43:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTQwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTYzNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r458249634", "bodyText": "Is this string already defined as a constant anywhere else?", "author": "pwinckles", "createdAt": "2020-07-21T16:59:03Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -209,20 +261,73 @@ public void addUpdateIndex(final ResourceHeaders resourceHeaders) {\n         final var txId = UUID.randomUUID().toString();\n         executeInDbTransaction(txId, status -> {\n             try {\n+                final var rdfTypes = new ArrayList<String>();\n+                rdfTypes.add(resourceHeaders.getInteractionModel());\n+                final var fedoraResource = resourceFactory.getResource(FedoraId.create(fullId)).getDescription();\n+                fedoraResource.getTriples().forEach(triple -> {\n+                    if (triple.getPredicate().getURI().equals(\"http://www.w3.org/1999/02/22-rdf-syntax-ns#type\")) {", "originalCommit": "16d29d6d5de56e8eaa8799faf0af391b5045d89f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI0OTk4OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r458249988", "bodyText": "Could use constants here too.", "author": "pwinckles", "createdAt": "2020-07-21T16:59:35Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -209,20 +261,73 @@ public void addUpdateIndex(final ResourceHeaders resourceHeaders) {\n         final var txId = UUID.randomUUID().toString();\n         executeInDbTransaction(txId, status -> {\n             try {\n+                final var rdfTypes = new ArrayList<String>();\n+                rdfTypes.add(resourceHeaders.getInteractionModel());\n+                final var fedoraResource = resourceFactory.getResource(FedoraId.create(fullId)).getDescription();\n+                fedoraResource.getTriples().forEach(triple -> {\n+                    if (triple.getPredicate().getURI().equals(\"http://www.w3.org/1999/02/22-rdf-syntax-ns#type\")) {\n+                        final var rdfTypeUri = triple.getObject().getURI();\n+                        rdfTypes.add(rdfTypeUri);\n+                    }\n+                });\n+\n+                final var jdbcInsertRdfTypes = new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate());\n+                jdbcInsertRdfTypes.withTableName(\"search_rdf_type\").usingGeneratedKeyColumns(\n+                        \"id\");\n+\n+                final var rdfTypeIds = new ArrayList<Long>();\n+                for (var rdfTypeUri : rdfTypes) {\n+                    final var typeParams = new MapSqlParameterSource();\n+                    typeParams.addValue(\"rdf_type_uri\", rdfTypeUri);\n+                    final var results = jdbcTemplate.queryForList(\"select id from search_rdf_type where \" +\n+                                    \"rdf_type_uri = :rdf_type_uri\",\n+                            typeParams);\n+\n+\n+                    if (CollectionUtils.isEmpty(results)) {\n+                        final Number key = jdbcInsertRdfTypes.executeAndReturnKey(typeParams);\n+                        rdfTypeIds.add(key.longValue());\n+                    } else {\n+                        rdfTypeIds.add((long) results.get(0).get(\"id\"));\n+                    }\n+                }\n \n                 final var params = new MapSqlParameterSource();\n                 params.addValue(FEDORA_ID_PARAM, fullId);\n                 params.addValue(MODIFIED_PARAM, new Timestamp(resourceHeaders.getLastModifiedDate().toEpochMilli()));\n                 params.addValue(MIME_TYPE_PARAM, resourceHeaders.getMimeType());\n                 params.addValue(CONTENT_SIZE_PARAM, resourceHeaders.getContentSize());\n-                final String sql;\n-                if (result.size() > 0) {\n-                    //update\n+                final var exists = result.size() > 0;\n+                final Long resourcePrimaryKey;\n+                if (exists) {\n+                    resourcePrimaryKey = (Long) result.get(0).get(\"id\");\n                     jdbcTemplate.update(UPDATE_INDEX_SQL, params);\n+                    //delete rdf_type associations\n+                    final var deleteParams = new MapSqlParameterSource();\n+                    deleteParams.addValue(\"resource_id\", resourcePrimaryKey);\n+                    jdbcTemplate.update(DELETE_RDF_TYPE_ASSOCIATIONS,\n+                            deleteParams);\n                 } else {\n                     params.addValue(CREATED_PARAM, new Timestamp(resourceHeaders.getCreatedDate().toEpochMilli()));\n-                    jdbcTemplate.update(INSERT_INTO_INDEX_SQL, params);\n+                    final var jdbcInsertResource =\n+                            new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate()).usingGeneratedKeyColumns(\n+                                    \"id\");\n+                    resourcePrimaryKey =\n+                            jdbcInsertResource.withTableName(SIMPLE_SEARCH_TABLE).executeAndReturnKey(params)\n+                                    .longValue();\n                 }\n+\n+                //add rdf type associations\n+                final var jdbcInsertRdfTypeAssociations = new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate());\n+                jdbcInsertRdfTypeAssociations.withTableName(\"search_resource_rdf_type\").usingGeneratedKeyColumns(", "originalCommit": "16d29d6d5de56e8eaa8799faf0af391b5045d89f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "17bed0ccf1a544e67a7de0be031e7993507f5d5b", "url": "https://github.com/fcrepo/fcrepo/commit/17bed0ccf1a544e67a7de0be031e7993507f5d5b", "message": "Addresses changes requested in PR review.", "committedDate": "2020-07-29T19:51:05Z", "type": "forcePushed"}, {"oid": "e0201d7c2c930c2c5327fd62b1277158aab87e2e", "url": "https://github.com/fcrepo/fcrepo/commit/e0201d7c2c930c2c5327fd62b1277158aab87e2e", "message": "Addresses changes requested in PR review.", "committedDate": "2020-07-29T21:18:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5NjgxMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465696812", "bodyText": "I see now what you were talking about a couple days ago. All of these branching getResource calls are quite ugly. Because the underlying code already handles null transaction ids, it might just be better to allow getResource(null, fedoraId) for the sake not having to write these statements everywhere.", "author": "pwinckles", "createdAt": "2020-08-05T12:41:16Z", "path": "fcrepo-auth-webac/src/main/java/org/fcrepo/auth/webac/WebACAuthorizingRealm.java", "diffHunk": "@@ -234,17 +233,22 @@ public boolean supports(final AuthenticationToken token) {\n     }\n \n     private FedoraResource getResourceOrParentFromPath(final FedoraId fedoraId) {\n+        final var tx = transaction();\n+        final var txId = tx == null || tx.isCommitted() ? null : tx.getId();\n+\n         try {\n             log.debug(\"Testing FedoraResource for {}\", fedoraId.getFullIdPath());\n-            return this.resourceFactory.getResource(transaction(), fedoraId);\n+\n+            return txId != null ? this.resourceFactory.getResource(txId, fedoraId) :", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2ODY0Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r466068646", "bodyText": "Agreed.  I will fix.", "author": "dbernstein", "createdAt": "2020-08-05T23:59:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5NjgxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5ODczMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465698730", "bodyText": "I believe you could add this method to a TransactionUtils class in fcrepo-kernel-api. Then, if you allowed null tx ids, ResourceFactory calls could be simplified to something like resourceFactory.getResource(TransactionUtils.openTxId(transaction), fedoraId).", "author": "pwinckles", "createdAt": "2020-08-05T12:44:32Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraBaseResource.java", "diffHunk": "@@ -116,4 +118,8 @@ protected Transaction transaction() {\n         }\n         return transaction;\n     }\n+\n+    protected String txtIdIfUncommittedOrNull(final Transaction tx) {", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA2ODczNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r466068734", "bodyText": "Yes - excellent idea. Will do.", "author": "dbernstein", "createdAt": "2020-08-06T00:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY5ODczMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwNTQzMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465705432", "bodyText": "This code can be replaced using this enum: https://github.com/fcrepo4/fcrepo4/blob/main/fcrepo-common/src/main/java/org/fcrepo/common/db/DbPlatform.java", "author": "pwinckles", "createdAt": "2020-08-05T12:55:24Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -95,72 +119,62 @@\n     @Inject\n     private PlatformTransactionManager platformTransactionManager;\n \n+    @Inject\n+    private ResourceFactory resourceFactory;\n+\n     /**\n      * Setup database table and connection\n      */\n     @PostConstruct\n     public void setup() {\n-        LOGGER.debug(\"Applying ddl: {}\", DDL);\n+        final var ddl = lookupDdl();\n+        LOGGER.debug(\"Applying ddl: {}\", ddl);\n         DatabasePopulatorUtils.execute(\n-                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + DDL)),\n+                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + ddl)),\n                 this.dataSource);\n         this.jdbcTemplate = getNamedParameterJdbcTemplate();\n     }\n \n+    private String getDdlKey() {", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcwNzQzOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465707438", "bodyText": "whereClauses should be defined as List", "author": "pwinckles", "createdAt": "2020-08-05T12:58:35Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -197,32 +217,98 @@ public SearchResult doSearch(final SearchParameters parameters) throws InvalidQu\n         return new SearchResult(items, pagination);\n     }\n \n+    private void addWhereClause(final int paramCount, final MapSqlParameterSource parameterSource,\n+                                final ArrayList<String> whereClauses,", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxMjUyOA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465712528", "bodyText": "The String id is used in a number of places and could be a constant for consistency", "author": "pwinckles", "createdAt": "2020-08-05T13:07:06Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -231,6 +317,46 @@ public void addUpdateIndex(final ResourceHeaders resourceHeaders) {\n         });\n     }\n \n+    private void insertRdfTypeAssociations(final List<Long> rdfTypeIds, final Long resourceId) {\n+        //add rdf type associations\n+        final var jdbcInsertRdfTypeAssociations = new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate());\n+        jdbcInsertRdfTypeAssociations.withTableName(SEARCH_RESOURCE_RDF_TYPE_TABLE).usingGeneratedKeyColumns(\n+                \"id\");\n+        for (var rdfTypeId : rdfTypeIds) {\n+            final var assocParams = new MapSqlParameterSource();\n+            assocParams.addValue(RESOURCE_ID_PARAM, resourceId);\n+            assocParams.addValue(RDF_TYPE_ID_PARAM, rdfTypeId);\n+            jdbcInsertRdfTypeAssociations.execute(assocParams);\n+        }\n+    }\n+\n+    private void deleteRdfTypeAssociations(final Long resourceId) {\n+        final var deleteParams = new MapSqlParameterSource();\n+        deleteParams.addValue(RESOURCE_ID_PARAM, resourceId);\n+        jdbcTemplate.update(DELETE_RDF_TYPE_ASSOCIATIONS,\n+                deleteParams);\n+    }\n+\n+    private ArrayList<Long> findOrCreateRdfTypesInDb(final List<URI> rdfTypes) {\n+        final var jdbcInsertRdfTypes = new SimpleJdbcInsert(this.jdbcTemplate.getJdbcTemplate());\n+        jdbcInsertRdfTypes.withTableName(SEARCH_RDF_TYPE_TABLE).usingGeneratedKeyColumns(\n+                \"id\");", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxNDk5NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465714995", "bodyText": "Minor note, only change if you're inclined, but this could be rewritten as:\nreturn List.of(\n    togglePostgresTriggers(SEARCH_RESOURCE_RDF_TYPE_TABLE, enable),\n    togglePostgresTriggers(SEARCH_RDF_TYPE_TABLE, enable),\n    togglePostgresTriggers(SIMPLE_SEARCH_TABLE, enable),\n);", "author": "pwinckles", "createdAt": "2020-08-05T13:11:02Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -252,7 +378,51 @@ public void removeFromIndex(final FedoraId fedoraId) {\n \n     @Override\n     public void reset() {\n-        jdbcTemplate.update(\"TRUNCATE TABLE \" + SIMPLE_SEARCH_TABLE, Collections.EMPTY_MAP);\n+        final var builder = new StringBuilder();\n+\n+        try {\n+            final var conn = this.dataSource.getConnection();\n+            final var statement = conn.createStatement();\n+            for (var sql : toggleForeignKeyChecks(false)) {\n+                statement.addBatch(sql);\n+            }\n+            statement.addBatch(truncateTable(SEARCH_RESOURCE_RDF_TYPE_TABLE));\n+            statement.addBatch(truncateTable(SIMPLE_SEARCH_TABLE));\n+            statement.addBatch(truncateTable(SEARCH_RDF_TYPE_TABLE));\n+            for (var sql : toggleForeignKeyChecks(true)) {\n+                statement.addBatch(sql);\n+            }\n+            statement.executeBatch();\n+        } catch (SQLException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    private List<String> toggleForeignKeyChecks(final boolean enable) {\n+\n+        if (isPostgres()) {\n+            final var statements = new ArrayList<String>();", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxNjMwNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465716306", "bodyText": "Similarly, using Arrays.asList() is worse than List.of() in just about every case, except if you're converting an array into a list, and even then Arrays.asList() can have unexpected behavior if you don't treat the resulting list as immutable.", "author": "pwinckles", "createdAt": "2020-08-05T13:13:12Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -252,7 +378,51 @@ public void removeFromIndex(final FedoraId fedoraId) {\n \n     @Override\n     public void reset() {\n-        jdbcTemplate.update(\"TRUNCATE TABLE \" + SIMPLE_SEARCH_TABLE, Collections.EMPTY_MAP);\n+        final var builder = new StringBuilder();\n+\n+        try {\n+            final var conn = this.dataSource.getConnection();\n+            final var statement = conn.createStatement();\n+            for (var sql : toggleForeignKeyChecks(false)) {\n+                statement.addBatch(sql);\n+            }\n+            statement.addBatch(truncateTable(SEARCH_RESOURCE_RDF_TYPE_TABLE));\n+            statement.addBatch(truncateTable(SIMPLE_SEARCH_TABLE));\n+            statement.addBatch(truncateTable(SEARCH_RDF_TYPE_TABLE));\n+            for (var sql : toggleForeignKeyChecks(true)) {\n+                statement.addBatch(sql);\n+            }\n+            statement.executeBatch();\n+        } catch (SQLException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    private List<String> toggleForeignKeyChecks(final boolean enable) {\n+\n+        if (isPostgres()) {\n+            final var statements = new ArrayList<String>();\n+            statements.add(togglePostgresTriggers(SEARCH_RESOURCE_RDF_TYPE_TABLE, enable));\n+            statements.add(togglePostgresTriggers(SEARCH_RDF_TYPE_TABLE, enable));\n+            statements.add(togglePostgresTriggers(SIMPLE_SEARCH_TABLE, enable));\n+            return statements;\n+        } else {\n+            return Arrays.asList(\"SET FOREIGN_KEY_CHECKS = \" + (enable ? 1 : 0) + \";\");", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTcxNzM3OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r465717378", "bodyText": "You should store this value as a field in the setup() method rather than looking it up every time.", "author": "pwinckles", "createdAt": "2020-08-05T13:14:56Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -252,7 +378,51 @@ public void removeFromIndex(final FedoraId fedoraId) {\n \n     @Override\n     public void reset() {\n-        jdbcTemplate.update(\"TRUNCATE TABLE \" + SIMPLE_SEARCH_TABLE, Collections.EMPTY_MAP);\n+        final var builder = new StringBuilder();\n+\n+        try {\n+            final var conn = this.dataSource.getConnection();\n+            final var statement = conn.createStatement();\n+            for (var sql : toggleForeignKeyChecks(false)) {\n+                statement.addBatch(sql);\n+            }\n+            statement.addBatch(truncateTable(SEARCH_RESOURCE_RDF_TYPE_TABLE));\n+            statement.addBatch(truncateTable(SIMPLE_SEARCH_TABLE));\n+            statement.addBatch(truncateTable(SEARCH_RDF_TYPE_TABLE));\n+            for (var sql : toggleForeignKeyChecks(true)) {\n+                statement.addBatch(sql);\n+            }\n+            statement.executeBatch();\n+        } catch (SQLException throwables) {\n+            throwables.printStackTrace();\n+        }\n+    }\n+\n+    private List<String> toggleForeignKeyChecks(final boolean enable) {\n+\n+        if (isPostgres()) {\n+            final var statements = new ArrayList<String>();\n+            statements.add(togglePostgresTriggers(SEARCH_RESOURCE_RDF_TYPE_TABLE, enable));\n+            statements.add(togglePostgresTriggers(SEARCH_RDF_TYPE_TABLE, enable));\n+            statements.add(togglePostgresTriggers(SIMPLE_SEARCH_TABLE, enable));\n+            return statements;\n+        } else {\n+            return Arrays.asList(\"SET FOREIGN_KEY_CHECKS = \" + (enable ? 1 : 0) + \";\");\n+        }\n+    }\n+\n+    private boolean isPostgres() {\n+        return getDdlKey().equals(POSTGRESQL_KEY);", "originalCommit": "dbab1196f7dc2f8978e4fb0aa57cf3aca0f4e1a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1e078f675d597f522943933061373acb7c7b483e", "url": "https://github.com/fcrepo/fcrepo/commit/1e078f675d597f522943933061373acb7c7b483e", "message": "Addresses second round of PR feedback.", "committedDate": "2020-08-06T23:31:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MTM5MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467171390", "bodyText": "It seems like every call to ResourceFactory.getResource() outside of org.fcrepo.kernel.impl.models goes through TransactionUtils.openTxId(transaction) or an equivalent implementation.\nWould it make sense to add back in a ResourceFactory.getResource(Transaction tx, FedoraId resourceId) signature which does TransactionUtils.openTxId internally and calls the getResource(String txId, FedoraId resourceId) rather than calling TransactionUtils.openTxId everywhere?", "author": "bbpennel", "createdAt": "2020-08-07T17:23:20Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraBaseResource.java", "diffHunk": "@@ -71,28 +71,17 @@ protected HttpIdentifierConverter identifierConverter() {\n         return identifierConverter;\n     }\n \n-    protected FedoraResource getFedoraResource(final FedoraId fedoraId) throws PathNotFoundException {\n-        return this.resourceFactory.getResource(fedoraId);\n-    }\n-\n     /**\n      * Gets a fedora resource by id. Uses the provided transaction if it is uncommitted,\n      * or uses a new transaction.\n      *\n      * @param transaction the fedora transaction\n-     * @param fedoraId identifier of the resource\n+     * @param fedoraId    identifier of the resource\n      * @return the requested FedoraResource\n      */\n-    protected FedoraResource getFedoraResource(final Transaction transaction, final FedoraId fedoraId) {\n-        try {\n-            if (transaction.isCommitted()) {\n-                return getFedoraResource(fedoraId);\n-            } else {\n-                return resourceFactory.getResource(transaction, fedoraId);\n-            }\n-        } catch (final PathNotFoundException e) {\n-            throw new PathNotFoundRuntimeException(e);\n-        }\n+    protected FedoraResource getFedoraResource(final Transaction transaction, final FedoraId fedoraId)\n+            throws PathNotFoundException {\n+            return resourceFactory.getResource(TransactionUtils.openTxId(transaction), fedoraId);", "originalCommit": "1e078f675d597f522943933061373acb7c7b483e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NTY4NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467185684", "bodyText": "Yes if not for the fact that IndexBuilderImpl does not have access to a Transaction but rather interacts directly with the  fcrepo-persistence-ocfl layer directly.  Consequently DbSearchIndexImpl doesn't want to deal in Transaction Objects, but does need to know about the transaction in which the rebuild is taking place.  @pwinckles  was in favor of removing the dependency of the Transaction from the ResourceFactory API since it encumbers the interface without providing a commensurate benefit.", "author": "dbernstein", "createdAt": "2020-08-07T17:52:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MTM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NTc4MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467185781", "bodyText": "@bbpennel ^^", "author": "dbernstein", "createdAt": "2020-08-07T17:52:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MTM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4OTg1NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467189854", "bodyText": "Oh - I think I misunderstood you.", "author": "dbernstein", "createdAt": "2020-08-07T18:00:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MTM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5MDIwOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467190209", "bodyText": "You're saying simply add the other signature and use where appropriate yes?", "author": "dbernstein", "createdAt": "2020-08-07T18:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MTM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5Mzc1Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467193752", "bodyText": "Right, there'd be multiple getResource signatures, one would take a Transaction, another would take a txId. Other parts of the application would call them where appropriate and then getResource would internally do the null and committed check, since that seems to be a requirement everywhere that a transaction object is used. doesResourceExist could do the same thing if that's valuable, but I didn't investigate that one closely. The benefit would be that a cleaner usage and we'd be less likely to forget that when using a transaction we have to do those checks on it since it'd be centralized.", "author": "bbpennel", "createdAt": "2020-08-07T18:09:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MTM5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzIwNTM1Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467205357", "bodyText": "That makes sense to me", "author": "dbernstein", "createdAt": "2020-08-07T18:34:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3MTM5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3NDg5MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467174890", "bodyText": "should this be txIdIfUncommittedOrNull rather than txtId?", "author": "bbpennel", "createdAt": "2020-08-07T17:30:13Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/AbstractService.java", "diffHunk": "@@ -238,8 +238,6 @@ private Statement createDefaultAccessToStatement(final String authSubject) {\n                         createResource(currentResourcePath));\n     }\n \n-    protected String txId(final Transaction tx) {\n-        return tx == null ? null : tx.getId();\n-    }\n-\n-}\n+    protected String txtIdIfUncommittedOrNull(final Transaction tx) {", "originalCommit": "1e078f675d597f522943933061373acb7c7b483e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE4NjA1NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467186054", "bodyText": "This should be removed I believe.", "author": "dbernstein", "createdAt": "2020-08-07T17:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3NDg5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE5NDUzMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r467194532", "bodyText": "I thought I saw it being referenced a few places, but if the extra getResource(Transaction tx...) is added then this should be unneeded", "author": "bbpennel", "createdAt": "2020-08-07T18:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE3NDg5MA=="}], "type": "inlineReview"}, {"oid": "8f188773216855478f1aa51f752a028292c056c3", "url": "https://github.com/fcrepo/fcrepo/commit/8f188773216855478f1aa51f752a028292c056c3", "message": "Implements rdf_type parameter and output field in simple search.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3378", "committedDate": "2020-08-10T15:50:39Z", "type": "commit"}, {"oid": "0bdc79bf1d85c5af07e4adf52a0b283d3965e801", "url": "https://github.com/fcrepo/fcrepo/commit/0bdc79bf1d85c5af07e4adf52a0b283d3965e801", "message": "Addresses changes requested in PR review.", "committedDate": "2020-08-10T15:50:39Z", "type": "commit"}, {"oid": "ceae2c5ad38049295a87d6fcfe26470ce1afb312", "url": "https://github.com/fcrepo/fcrepo/commit/ceae2c5ad38049295a87d6fcfe26470ce1afb312", "message": "Fixes broken tests introduced after rebase.", "committedDate": "2020-08-10T15:50:39Z", "type": "commit"}, {"oid": "d0f92e9a7e978046e484d042181a55778d6617e0", "url": "https://github.com/fcrepo/fcrepo/commit/d0f92e9a7e978046e484d042181a55778d6617e0", "message": "Fixes rdf_type indexing by removing Transaction from the ResourceFactory interface\nand replacing it with transactionId. This update also changed the semantics of ResourceFactory insofar as\nyou must call the transaction-aware methods only if you have a transaction id that represents an uncommitted\ntransaction. For read only calls, you must must the read only methods.", "committedDate": "2020-08-10T15:51:25Z", "type": "commit"}, {"oid": "6ac2e7df587f0bf68b3c15cbaf535f23e3bf372c", "url": "https://github.com/fcrepo/fcrepo/commit/6ac2e7df587f0bf68b3c15cbaf535f23e3bf372c", "message": "Addresses second round of PR feedback.", "committedDate": "2020-08-10T15:51:25Z", "type": "commit"}, {"oid": "887a2ce3fe95ca455ee067ceffaf7a74e2baebf1", "url": "https://github.com/fcrepo/fcrepo/commit/887a2ce3fe95ca455ee067ceffaf7a74e2baebf1", "message": "Round 3:  adds back in the ResourceFactory.getResource(Transaction, FedoraId) signature while\npreserving the  new  ResourceFactory.getResource(String, FedoraId) signature per Ben\nPennell's feedback.", "committedDate": "2020-08-10T15:51:26Z", "type": "commit"}, {"oid": "0abf922a4e36c43732337fe8246904c81347c52c", "url": "https://github.com/fcrepo/fcrepo/commit/0abf922a4e36c43732337fe8246904c81347c52c", "message": "Removes unused imports.", "committedDate": "2020-08-10T15:58:42Z", "type": "commit"}, {"oid": "0abf922a4e36c43732337fe8246904c81347c52c", "url": "https://github.com/fcrepo/fcrepo/commit/0abf922a4e36c43732337fe8246904c81347c52c", "message": "Removes unused imports.", "committedDate": "2020-08-10T15:58:42Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODEzMDcxMQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r468130711", "bodyText": "this line is indented too much", "author": "bbpennel", "createdAt": "2020-08-10T19:27:14Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraBaseResource.java", "diffHunk": "@@ -71,28 +71,17 @@ protected HttpIdentifierConverter identifierConverter() {\n         return identifierConverter;\n     }\n \n-    protected FedoraResource getFedoraResource(final FedoraId fedoraId) throws PathNotFoundException {\n-        return this.resourceFactory.getResource(fedoraId);\n-    }\n-\n     /**\n      * Gets a fedora resource by id. Uses the provided transaction if it is uncommitted,\n      * or uses a new transaction.\n      *\n      * @param transaction the fedora transaction\n-     * @param fedoraId identifier of the resource\n+     * @param fedoraId    identifier of the resource\n      * @return the requested FedoraResource\n      */\n-    protected FedoraResource getFedoraResource(final Transaction transaction, final FedoraId fedoraId) {\n-        try {\n-            if (transaction.isCommitted()) {\n-                return getFedoraResource(fedoraId);\n-            } else {\n-                return resourceFactory.getResource(transaction, fedoraId);\n-            }\n-        } catch (final PathNotFoundException e) {\n-            throw new PathNotFoundRuntimeException(e);\n-        }\n+    protected FedoraResource getFedoraResource(final Transaction transaction, final FedoraId fedoraId)\n+            throws PathNotFoundException {\n+            return resourceFactory.getResource(transaction, fedoraId);", "originalCommit": "0abf922a4e36c43732337fe8246904c81347c52c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MDU4Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r469250587", "bodyText": "Seems like this and all the other instances modified in this class could be reverted back to just passing in the mockTransaction", "author": "bbpennel", "createdAt": "2020-08-12T13:16:01Z", "path": "fcrepo-auth-webac/src/test/java/org/fcrepo/auth/webac/WebACFilterTest.java", "diffHunk": "@@ -174,10 +174,11 @@ public void setupRequest() throws Exception {\n \n         when(mockTransactionManager.get(transactionId)).thenReturn(mockTransaction);\n \n-        when(mockResourceFactory.getResource(mockTransaction, testChildId))\n+        when(mockResourceFactory.getResource(mockTransaction.getId(), testChildId))", "originalCommit": "1ad120aa37180d1efc76213065119187fcc890ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MTY3NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r469251675", "bodyText": "Would it make sense to also add back in the doesResourceExist(Transaction tx, ...) signature, which internally calls doesResourceExist(String txId, ...)?", "author": "bbpennel", "createdAt": "2020-08-12T13:17:47Z", "path": "fcrepo-http-api/src/main/java/org/fcrepo/http/api/FedoraBaseResource.java", "diffHunk": "@@ -101,7 +90,7 @@ protected FedoraResource getFedoraResource(final Transaction transaction, final\n      * @return Returns true if an object with the provided id exists\n      */\n     protected boolean doesResourceExist(final Transaction transaction, final FedoraId fedoraId) {\n-        return resourceFactory.doesResourceExist(transaction, fedoraId);\n+        return resourceFactory.doesResourceExist(TransactionUtils.openTxId(transaction), fedoraId);", "originalCommit": "1ad120aa37180d1efc76213065119187fcc890ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1MzIyMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r469253223", "bodyText": "Seems like this and the other getResource(mockTransaction.getId() calls can be reverted to just getResource(mockTransaction if that is more accurate to the real usage", "author": "bbpennel", "createdAt": "2020-08-12T13:20:03Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/http/api/FedoraLdpTest.java", "diffHunk": "@@ -1310,15 +1312,15 @@ public void testCreateNewBinaryWithChecksumSHAandMD5() throws MalformedRdfExcept\n     @Test(expected = CannotCreateResourceException.class)\n     public void testLDPRNotImplemented() throws Exception {\n         final var resource = setResource(Container.class);\n-        when(resourceFactory.getResource(mockTransaction, pathId.resolve(\"x\"))).thenReturn(resource);\n+        when(resourceFactory.getResource(mockTransaction.getId(), pathId.resolve(\"x\"))).thenReturn(resource);", "originalCommit": "1ad120aa37180d1efc76213065119187fcc890ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1NTM4Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r469255387", "bodyText": "Seems like all the factory.getResource(mockTx.getId(), ... in this test could be reverted back to factory.getResource(mockTx, ...", "author": "bbpennel", "createdAt": "2020-08-12T13:23:12Z", "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/models/ResourceFactoryImplTest.java", "diffHunk": "@@ -208,7 +208,7 @@ public void getResource_BasicContainer_WithParent() throws Exception {\n \n         when(psSession.getHeaders(parentId, null)).thenReturn(parentHeaders);\n \n-        final var resc = factory.getResource(mockTx, fedoraId);\n+        final var resc = factory.getResource(mockTx.getId(), fedoraId);", "originalCommit": "1ad120aa37180d1efc76213065119187fcc890ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI3NzM3OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r473277378", "bodyText": "I don't think these ones got reverted", "author": "bbpennel", "createdAt": "2020-08-19T19:45:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1NTM4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI4MTA0Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r473281047", "bodyText": "They should be good now.", "author": "dbernstein", "createdAt": "2020-08-19T19:52:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTI1NTM4Nw=="}], "type": "inlineReview"}, {"oid": "2bfe486c7a8c3b2927a5b2f48c503e4ba897f8d1", "url": "https://github.com/fcrepo/fcrepo/commit/2bfe486c7a8c3b2927a5b2f48c503e4ba897f8d1", "message": "Fixes problem with rdf_type conditions in search.\nNow rdf_type=*<term>*,  rdf_type=*<term>, and rdf_type=<term> (no wildcards)\nshould work as advertised.", "committedDate": "2020-08-17T17:35:32Z", "type": "commit"}, {"oid": "2bfe486c7a8c3b2927a5b2f48c503e4ba897f8d1", "url": "https://github.com/fcrepo/fcrepo/commit/2bfe486c7a8c3b2927a5b2f48c503e4ba897f8d1", "message": "Fixes problem with rdf_type conditions in search.\nNow rdf_type=*<term>*,  rdf_type=*<term>, and rdf_type=<term> (no wildcards)\nshould work as advertised.", "committedDate": "2020-08-17T17:35:32Z", "type": "forcePushed"}, {"oid": "9fc866142677b14ea10a9892522662dd609cfb81", "url": "https://github.com/fcrepo/fcrepo/commit/9fc866142677b14ea10a9892522662dd609cfb81", "message": "Addresses postgres query issue.", "committedDate": "2020-08-17T20:38:52Z", "type": "commit"}, {"oid": "cc68512d436892d8624aab2785b97e733cd4f35d", "url": "https://github.com/fcrepo/fcrepo/commit/cc68512d436892d8624aab2785b97e733cd4f35d", "message": "Addresses Ben Pennel's PR feedback.", "committedDate": "2020-08-19T19:45:39Z", "type": "forcePushed"}, {"oid": "305c01b277c431885804ed9b27dad7d09f420c62", "url": "https://github.com/fcrepo/fcrepo/commit/305c01b277c431885804ed9b27dad7d09f420c62", "message": "Addresses Ben Pennel's PR feedback.", "committedDate": "2020-08-19T19:50:07Z", "type": "commit"}, {"oid": "305c01b277c431885804ed9b27dad7d09f420c62", "url": "https://github.com/fcrepo/fcrepo/commit/305c01b277c431885804ed9b27dad7d09f420c62", "message": "Addresses Ben Pennel's PR feedback.", "committedDate": "2020-08-19T19:50:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzk3NTkxMg==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r473975912", "bodyText": "This value will never change at runtime. It would be better to just construct the query once on setup.", "author": "pwinckles", "createdAt": "2020-08-20T13:31:46Z", "path": "fcrepo-search-impl/src/main/java/org/fcrepo/search/impl/DbSearchIndexImpl.java", "diffHunk": "@@ -95,72 +126,66 @@\n     @Inject\n     private PlatformTransactionManager platformTransactionManager;\n \n+    @Inject\n+    private ResourceFactory resourceFactory;\n+\n+    private DbPlatform dbPlatForm;\n+\n     /**\n      * Setup database table and connection\n      */\n     @PostConstruct\n     public void setup() {\n-        LOGGER.debug(\"Applying ddl: {}\", DDL);\n+        this.dbPlatForm = DbPlatform.fromDataSource(this.dataSource);\n+        final var ddl = lookupDdl();\n+        LOGGER.debug(\"Applying ddl: {}\", ddl);\n         DatabasePopulatorUtils.execute(\n-                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + DDL)),\n+                new ResourceDatabasePopulator(new DefaultResourceLoader().getResource(\"classpath:\" + ddl)),\n                 this.dataSource);\n         this.jdbcTemplate = getNamedParameterJdbcTemplate();\n     }\n \n+    private String lookupDdl() {\n+        return DDL_MAP.get(dbPlatForm);\n+    }\n+\n     private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n         return new NamedParameterJdbcTemplate(this.dataSource);\n     }\n \n     @Override\n     public SearchResult doSearch(final SearchParameters parameters) throws InvalidQueryException {\n         //translate parameters into a SQL query\n-        var paramCount = 1;\n-\n         final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n         final var whereClauses = new ArrayList<String>();\n-        for (Condition condition : parameters.getConditions()) {\n-            final var field = condition.getField();\n-            final var operation = condition.getOperator();\n-            var object = condition.getObject();\n-            if ((field.equals(FEDORA_ID) || field.equals(MIME_TYPE)) &&\n-                    condition.getOperator().equals(Condition.Operator.EQ)) {\n-                if (!object.equals(\"*\")) {\n-                    final var paramName = \"param\" + paramCount++;\n-                    if (object.contains(\"*\")) {\n-                        object = object.replace(\"*\", \"%\");\n-                        whereClauses.add(field + \" like :\" + paramName);\n-                    } else {\n-                        whereClauses.add(field + \" = :\" + paramName);\n-                    }\n-                    parameterSource.addValue(paramName, object);\n-                }\n-            } else if (field.equals(Condition.Field.CREATED) || field.equals(Condition.Field.MODIFIED)) {\n-                //parse date\n-                try {\n-                    final var instant = InstantParser.parse(object);\n-                    final var paramName = \"param\" + paramCount++;\n-                    whereClauses.add(field + \" \" + operation.getStringValue() + \" :\" + paramName);\n-                    parameterSource.addValue(paramName, new Timestamp(instant.toEpochMilli()), Types.TIMESTAMP);\n-                } catch (Exception ex) {\n-                    throw new InvalidQueryException(ex.getMessage());\n-                }\n-            } else if (field.equals(CONTENT_SIZE)) {\n-                try {\n-                    final var paramName = \"param\" + paramCount++;\n-                    whereClauses.add(field + \" \" + operation.getStringValue() +\n-                            \" :\" + paramName);\n-                    parameterSource.addValue(paramName, Long.parseLong(object), Types.INTEGER);\n-                } catch (Exception ex) {\n-                    throw new InvalidQueryException(ex.getMessage());\n-                }\n-            } else {\n-                throw new InvalidQueryException(\"Condition not supported: \\\"\" + condition + \"\\\"\");\n-            }\n+        final var conditions = parameters.getConditions();\n+        for (int i = 0; i < conditions.size(); i++) {\n+            addWhereClause(i, parameterSource, whereClauses, conditions.get(i));\n         }\n \n         final var fields = parameters.getFields().stream().map(x -> x.toString()).collect(Collectors.toList());\n+        final boolean containsRDFTypeField = fields.contains(RDF_TYPE.toString());\n+        if (containsRDFTypeField) {\n+            whereClauses.add(\"s.id = r.resource_id\");\n+            whereClauses.add(\"r.resource_id = r_filter.resource_id\");\n+        }\n+\n         final var sql =\n-                new StringBuilder(\"SELECT \" + String.join(\",\", fields) + \" FROM \" + SIMPLE_SEARCH_TABLE);\n+                new StringBuilder(\"SELECT \" + String.join(\",\", fields) + \" FROM \" + SIMPLE_SEARCH_TABLE + \" s\");\n+\n+        if (containsRDFTypeField) {\n+            final var rdf_type_tables = RDF_TYPE_TABLE.replace(GROUP_CONCAT_FUNCTION,", "originalCommit": "305c01b277c431885804ed9b27dad7d09f420c62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAwOTk5OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1726#discussion_r474009998", "bodyText": "Up around L117 you need to clear the search index if there's an exception during the rebuild.", "author": "pwinckles", "createdAt": "2020-08-20T14:06:03Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -181,6 +182,14 @@ private void indexOcflObject(final String ocflId, final String txId, final OcflO\n                 fedoraToOcflObjectIndex.addMapping(txId, fedoraIdentifier, rootFedoraIdentifier, ocflId);\n                 LOGGER.debug(\"Rebuilt fedora-to-ocfl object index entry for {}\", fedoraIdentifier);\n             });\n+\n+            headersList.forEach(headers -> {\n+                if (!headers.isDeleted()) {\n+                    searchIndex.addUpdateIndex(txId, headers);", "originalCommit": "305c01b277c431885804ed9b27dad7d09f420c62", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6202ec9c645bb4670ac323e2413190348175c7ef", "url": "https://github.com/fcrepo/fcrepo/commit/6202ec9c645bb4670ac323e2413190348175c7ef", "message": "ensures search index is reset on index rebuild error\nand ensures the rdf type tables sql string is built on initialization.", "committedDate": "2020-08-21T21:14:10Z", "type": "commit"}, {"oid": "66203b93128dc4940a34c9602cd2200bfc917459", "url": "https://github.com/fcrepo/fcrepo/commit/66203b93128dc4940a34c9602cd2200bfc917459", "message": "Merge branch 'main' into fcrepo-3378", "committedDate": "2020-08-22T01:58:16Z", "type": "commit"}, {"oid": "8ff254a353c252f06b697671456128b8cf9a149c", "url": "https://github.com/fcrepo/fcrepo/commit/8ff254a353c252f06b697671456128b8cf9a149c", "message": "fix connection leak", "committedDate": "2020-08-24T15:16:18Z", "type": "commit"}]}