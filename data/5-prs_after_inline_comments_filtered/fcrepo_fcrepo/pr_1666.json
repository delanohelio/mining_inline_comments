{"pr_number": 1666, "pr_title": "Change delete to remove data files and set headers to deleted.", "pr_createdAt": "2020-04-24T15:32:13Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1666", "timeline": [{"oid": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "url": "https://github.com/fcrepo/fcrepo/commit/1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "message": "Change delete to remove data files and set headers to deleted.", "committedDate": "2020-04-24T15:24:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY3NTcwNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414675704", "bodyText": "For whatever reason, Java hid what you're looking for at ZoneOffset.UTC.", "author": "pwinckles", "createdAt": "2020-04-24T15:43:48Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/exception/TombstoneException.java", "diffHunk": "@@ -32,22 +38,26 @@\n \n     private final String uri;\n \n+    private static DateTimeFormatter isoFormatter = ISO_INSTANT.withZone(ZoneId.of(\"UTC\"));", "originalCommit": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NTc1Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414685756", "bodyText": "Not a problem with this PR, but making changes to the headers file was on the back of my mind recently. Should this file be versioned or do we expect it to never really change once F6 is released? What is the impact of adding/removing properties later?", "author": "pwinckles", "createdAt": "2020-04-24T15:58:00Z", "path": "fcrepo-persistence-common/src/main/java/org/fcrepo/persistence/common/ResourceHeadersImpl.java", "diffHunk": "@@ -62,6 +62,8 @@\n \n     private boolean objectRoot;\n \n+    private boolean deleted;", "originalCommit": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4MzY0MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414783641", "bodyText": "As long as you set a sensible default in the ResourceHeadersImpl then I think we are good. For instance, in this case if you stand up a F6 create an object. Then stop F6, build this PR and stand it up again the headers for those existing objects (not having the key) should be \"delete\":false. As for removing properties, that would probably require us to list them as an ignored property.", "author": "whikloj", "createdAt": "2020-04-24T18:37:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NTc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NzQwNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414687405", "bodyText": "Why are you rethrowing the exception message without its stacktrace? It makes debugging much harder.", "author": "pwinckles", "createdAt": "2020-04-24T16:00:16Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc.getCause().getMessage());", "originalCommit": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4Mzg1MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414783850", "bodyText": "fair point", "author": "whikloj", "createdAt": "2020-04-24T18:37:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDY4NzQwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTU5OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414731599", "bodyText": "Is it possible for a path to have a . that is unrelated to a file extension?", "author": "pwinckles", "createdAt": "2020-04-24T17:10:36Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc.getCause().getMessage());\n+            }\n         } else {\n             final var relativeSubPath = relativizeSubpath(fedoraResourceRoot, operation.getResourceId());\n             final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath);\n-            final var headers = readHeaders(objectSession, ocflSubPath);\n-            final var filePath = resolveExtensions(ocflSubPath,\n-                    !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel())\n-            );\n-            objectSession.delete(filePath);\n+            final var headers = (ResourceHeadersImpl) readHeaders(objectSession, ocflSubPath);\n+            final boolean isRdf = !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel());\n+            final var filePath = resolveExtensions(ocflSubPath, isRdf);\n+            deletePath(filePath, objectSession, headers);\n+            if (!isRdf) {\n+                // Delete the description too.\n+                final var descPath = resolveExtensions(ocflSubPath + \"-description\", true);\n+                deletePath(descPath, objectSession);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Simple utility to delete a path's files and mark them as deleted in the headers file.\n+     * @param path Path to delete\n+     * @param session Session to delete the path in.\n+     */\n+    private void deletePath(final String path, final OCFLObjectSession session) throws PersistentStorageException{\n+        // readHeaders and writeHeaders need the subpath where as delete needs the file name. So remove any extensions.\n+        final var no_extension = (path.contains(\".\") ? path.substring(0, path.indexOf(\".\")) : path);", "originalCommit": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc4OTUzNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414789536", "bodyText": "unsure, we could have something that removes only specific extensions?", "author": "whikloj", "createdAt": "2020-04-24T18:47:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTU5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDgzNzk5Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414837993", "bodyText": "I would suggest creating a JIRA to address this issue separately.", "author": "dbernstein", "createdAt": "2020-04-24T20:17:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDczMTU5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0NTEwMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414745100", "bodyText": "Would acls need to be deleted here too? I know we aren't writing any yet. Just asking out of curiosity.", "author": "pwinckles", "createdAt": "2020-04-24T17:32:24Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc.getCause().getMessage());\n+            }\n         } else {\n             final var relativeSubPath = relativizeSubpath(fedoraResourceRoot, operation.getResourceId());\n             final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath);\n-            final var headers = readHeaders(objectSession, ocflSubPath);\n-            final var filePath = resolveExtensions(ocflSubPath,\n-                    !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel())\n-            );\n-            objectSession.delete(filePath);\n+            final var headers = (ResourceHeadersImpl) readHeaders(objectSession, ocflSubPath);\n+            final boolean isRdf = !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel());\n+            final var filePath = resolveExtensions(ocflSubPath, isRdf);\n+            deletePath(filePath, objectSession, headers);\n+            if (!isRdf) {\n+                // Delete the description too.\n+                final var descPath = resolveExtensions(ocflSubPath + \"-description\", true);", "originalCommit": "1d062a1a746f79fe5e4c391be1a6332c35fa85a0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc5MDY1Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r414790653", "bodyText": "Yes, I think that would need to be checked for. As an ACL is not required we'd need to check for its existence and delete.", "author": "whikloj", "createdAt": "2020-04-24T18:49:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDc0NTEwMA=="}], "type": "inlineReview"}, {"oid": "37caf788372ac9608dc3dfa95e5145488d13fd9d", "url": "https://github.com/fcrepo/fcrepo/commit/37caf788372ac9608dc3dfa95e5145488d13fd9d", "message": "Use ZoneOffset and persist exception", "committedDate": "2020-04-24T19:39:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTc3ODg5Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1666#discussion_r415778892", "bodyText": "I think you might want to call ResourceHeadersUtil.touchModificationHeaders() here instead of directly setting the lastModifiedDate.", "author": "pwinckles", "createdAt": "2020-04-27T12:42:51Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/DeleteResourcePersister.java", "diffHunk": "@@ -52,16 +57,68 @@ public void persist(final OCFLPersistentStorageSession session, final ResourceOp\n         final var objectSession = session.findOrCreateSession(mapping.getOcflObjectId());\n         log.debug(\"Deleting {} from {}\", resourceId, mapping.getOcflObjectId());\n         if (fedoraResourceRoot.equals(resourceId)) {\n-            // We are at the root of the object.\n-            objectSession.deleteObject();\n+            // We are at the root of the object, so delete all the data files.\n+            try {\n+                objectSession.listHeadSubpaths().filter(p -> !isSidecarSubpath(p)).forEach(\n+                        p -> deletePathWrapped(p, objectSession));\n+            } catch (final PersistentStorageRuntimeException exc) {\n+                // Rethrow the exception as a checked exception\n+                throw new PersistentStorageException(exc);\n+            }\n         } else {\n             final var relativeSubPath = relativizeSubpath(fedoraResourceRoot, operation.getResourceId());\n             final var ocflSubPath = resolveOCFLSubpath(fedoraResourceRoot, relativeSubPath);\n-            final var headers = readHeaders(objectSession, ocflSubPath);\n-            final var filePath = resolveExtensions(ocflSubPath,\n-                    !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel())\n-            );\n-            objectSession.delete(filePath);\n+            final var headers = (ResourceHeadersImpl) readHeaders(objectSession, ocflSubPath);\n+            final boolean isRdf = !Objects.equals(NON_RDF_SOURCE.toString(), headers.getInteractionModel());\n+            final var filePath = resolveExtensions(ocflSubPath, isRdf);\n+            deletePath(filePath, objectSession, headers);\n+            if (!isRdf) {\n+                // Delete the description too.\n+                final var descPath = resolveExtensions(ocflSubPath + \"-description\", true);\n+                deletePath(descPath, objectSession);\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Simple utility to delete a path's files and mark them as deleted in the headers file.\n+     * @param path Path to delete\n+     * @param session Session to delete the path in.\n+     */\n+    private void deletePath(final String path, final OCFLObjectSession session) throws PersistentStorageException{\n+        // readHeaders and writeHeaders need the subpath where as delete needs the file name. So remove any extensions.\n+        final var no_extension = (path.contains(\".\") ? path.substring(0, path.indexOf(\".\")) : path);\n+        final var headers = (ResourceHeadersImpl) readHeaders(session, no_extension);\n+        deletePath(path, session, headers);\n+    }\n+\n+    /**\n+     * Simple utility to delete a path's files and mark them as deleted in the headers file.\n+     * @param path Path to delete\n+     * @param session Session to delete the path in.\n+     * @param headers The headers for the file.\n+     * @throws PersistentStorageException if can't read, write or delete a file.\n+     */\n+    private void deletePath(final String path, final OCFLObjectSession session, final ResourceHeadersImpl headers)\n+        throws PersistentStorageException {\n+        session.delete(path);\n+        headers.setDeleted(true);\n+        headers.setLastModifiedDate(Instant.now());", "originalCommit": "37caf788372ac9608dc3dfa95e5145488d13fd9d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5efe7ed2e394ae5a058c440225384261b730f67b", "url": "https://github.com/fcrepo/fcrepo/commit/5efe7ed2e394ae5a058c440225384261b730f67b", "message": "Use utility", "committedDate": "2020-04-27T14:44:37Z", "type": "commit"}, {"oid": "f0e9a6da753f5f9b845458884ca301b74b2125b0", "url": "https://github.com/fcrepo/fcrepo/commit/f0e9a6da753f5f9b845458884ca301b74b2125b0", "message": "Tag tickets", "committedDate": "2020-04-27T14:55:26Z", "type": "commit"}]}