{"pr_number": 1647, "pr_title": "Implement containment triples service", "pr_createdAt": "2020-03-18T19:06:50Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1647", "timeline": [{"oid": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "url": "https://github.com/fcrepo/fcrepo/commit/f92d9f8f9411e9b475cbe88d357c871b0141d24a", "message": "Implement containment triples service and wire index into Create/Delete services.", "committedDate": "2020-03-18T18:53:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwMTA4NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395001085", "bodyText": "ensurePrefix() doesn't need to be called three times here and on L149-L152, does it?", "author": "pwinckles", "createdAt": "2020-03-19T12:50:33Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImpl.java", "diffHunk": "@@ -81,14 +82,20 @@ public String perform(final String txId, final String userPrincipal, final Strin\n                         final boolean isContained, final String contentType, final String filename,\n                         final Long contentSize, final List<String> linkHeaders, final Collection<URI> digest,\n                         final InputStream requestBody, final ExternalContent externalContent) {\n+        final String[] parts = splitSlug(txId, ensurePrefix(fedoraId), slug);\n+        // If we found an existing resource in the Slug, then that is our parent.\n+        final String normalizedFedoraId = (parts[0] != null) ? addToIdentifier(ensurePrefix(fedoraId), parts[0]) :\n+                    ensurePrefix(fedoraId);", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyMDgwMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395020800", "bodyText": "No, I was trying to avoid defining another fedora id variable. I thought it was getting a little crowded, but I can do that.", "author": "whikloj", "createdAt": "2020-03-19T13:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwMTA4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwNDE5NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395004194", "bodyText": "This is similar logic to the AbstractService.findExistingAncestor(), yeah?\nThis is just a comment, and should definitely not be addressed in this PR, but the code base just keeps piling up more and more code that manipulates fedora ids as strings (checking prefixes, splitting on /, checking suffixes, etc). Ideally, all of this code would go away, and there would just be a single object that represents a fedora resource id. Then, if you needed to iterate its parts for some reason, you could just ask it for an iterator. And there would no longer be a need for the constant verification of what state the string is in. Does it have a prefix? Does it have a suffix? Does it have a trailing slash?", "author": "pwinckles", "createdAt": "2020-03-19T12:56:19Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImpl.java", "diffHunk": "@@ -253,4 +260,37 @@ private String getResourcePath(final PersistentStorageSession pSession, final St\n     private List<Link> getLinkHeaders(final List<String> headers) {\n         return headers == null ? null : headers.stream().map(p -> Link.valueOf(p)).collect(Collectors.toList());\n     }\n+\n+    /**\n+     * Add this pairing to the containment index.\n+     * @param txId The transaction ID or null if no transaction.\n+     * @param parentId The parent ID or null if repository root.\n+     * @param id The child ID.\n+     */\n+    private void addToContainmentIndex(final String txId, final String parentId, final String id) {\n+        containmentIndex.addContainedBy(txId, ensurePrefix(parentId), ensurePrefix(id));\n+    }\n+\n+    /**\n+     * If the Slug has a forward slash then check that part of it is not an existing resource.\n+     * @param txID The current transaction id.\n+     * @param parent The fedora ID passed in with the slug.\n+     * @param slug The slug.\n+     * @return Array with the parent and slug.\n+     */\n+    private String[] splitSlug(final String txID, final String parent, final String slug) {", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyNTY4MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395025681", "bodyText": "I agree that this is somewhat similar except that a Slug could be the full path or just part of one, but is not an ID.\nI'm not a fan of the current compound slug behaviour (ie. the following are equivalent)\nPOST http://localhost:8080/rest/A Slug: B\nPOST http://localhost:8080/rest Slug: A/B\n\nbut I was trying to avoid changing that behaviour. I can try defering some of this to the existing findExistingAncestor method.", "author": "whikloj", "createdAt": "2020-03-19T13:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwNDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyOTQ1OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395029458", "bodyText": "This is a niave question, but, outside of the HTTP layer, is there a reason that the code shouldn't interact with those two ids the same? That is to say regardless of the format of the request, the HTTP layer produces a consistent internal fedora id and the rest of the service doesn't need to care about if the slug was B or A/B?", "author": "pwinckles", "createdAt": "2020-03-19T13:37:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwNDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA1NzUxNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395057514", "bodyText": "Basically because we need access to the persistence layer to check for object existence and that is in the kernel level. So we have to pass the information down. I guess we could stick the Slug on the end of the fedoraId.\nMy concern is in a deep Slug (ie. B/C/D) POSTed to A, would I change the fedoraId to A/B/C and the Slug to D? Because technically if B and C don't exist I need to create them too. Maybe not a huge issue, but something to consider.", "author": "whikloj", "createdAt": "2020-03-19T14:15:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwNDE5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI5MDIxMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395290213", "bodyText": "@pwinckles I refactored this function and how it is called a bit, see if this makes it better.", "author": "whikloj", "createdAt": "2020-03-19T20:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAwNDE5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAxMDgzNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395010835", "bodyText": "Isn't this removing the resource from the actual containment index, rather than staging it to be removed with the transaction is committed? Is this what we want?", "author": "pwinckles", "createdAt": "2020-03-19T13:07:41Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -278,24 +313,55 @@ public void removeContainedBy(final Transaction tx, final FedoraResource parent,\n         }\n     }\n \n+    @Override\n+    public void removeResource(final String txID, final String resourceID) {\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+        parameterSource.addValue(\"child\", resourceID);\n+        if (txID != null) {\n+            parameterSource.addValue(\"transactionId\", txID);\n+            final boolean addedInTxn = !jdbcTemplate.queryForList(IS_CHILD_ADDED_IN_TRANSACTION_NO_PARENT,\n+                    parameterSource).isEmpty();\n+            if (addedInTxn) {\n+                jdbcTemplate.update(UNDO_INSERT_CHILD_IN_TRANSACTION_NO_PARENT, parameterSource);\n+            } else {\n+                final String parent = getContainedBy(txID, resourceID);\n+                if (parent != null) {\n+                    LOGGER.debug(\"Removing containment relationship between parent ({}) and child ({})\", parent,\n+                            resourceID);\n+                    parameterSource.addValue(\"parent\", parent);\n+                    jdbcTemplate.update(DELETE_CHILD_IN_TRANSACTION, parameterSource);\n+                }\n+            }\n+        } else {\n+            jdbcTemplate.update(DELETE_ALL_RESOURCE, parameterSource);", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyMzg0Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395023842", "bodyText": "If there is no transaction then this is the path. We could also not allow this to be used without a transaction, but I was following the existing semantics. In my mind, this probably would never happen, but I don't know.", "author": "whikloj", "createdAt": "2020-03-19T13:28:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAxMDgzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAyNjA4Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395026086", "bodyText": "Ah, fair enough.", "author": "pwinckles", "createdAt": "2020-03-19T13:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTAxMDgzNQ=="}], "type": "inlineReview"}, {"oid": "82668e2b057b8fc1a92343109cb49f7c1f431db0", "url": "https://github.com/fcrepo/fcrepo/commit/82668e2b057b8fc1a92343109cb49f7c1f431db0", "message": "Expand column sizes, clean up slug handling and ancestor searching", "committedDate": "2020-03-19T20:03:19Z", "type": "commit"}, {"oid": "ab3fe8dde1737c3e76fb742cae7e5f2b0a1a24d8", "url": "https://github.com/fcrepo/fcrepo/commit/ab3fe8dde1737c3e76fb742cae7e5f2b0a1a24d8", "message": "Remove addition of newline", "committedDate": "2020-03-19T20:05:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE4OTE3NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395189175", "bodyText": "@param resource The fedora container resource in which children resources are contained", "author": "awoods", "createdAt": "2020-03-19T17:14:37Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/services/ContainmentTriplesService.java", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to DuraSpace under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional information\n+ * regarding copyright ownership.\n+ *\n+ * DuraSpace licenses this file to you under the Apache License,\n+ * Version 2.0 (the \"License\"); you may not use this file except in\n+ * compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.fcrepo.kernel.api.services;\n+\n+import java.util.stream.Stream;\n+\n+import org.apache.jena.graph.Triple;\n+import org.fcrepo.kernel.api.Transaction;\n+import org.fcrepo.kernel.api.models.FedoraResource;\n+\n+/**\n+ * Provides containment triples.\n+ *\n+ * @author whikloj\n+ * @since 6.0.0\n+ */\n+public interface ContainmentTriplesService {\n+\n+    /**\n+     * Retrieve the containment triples.\n+     *\n+     * @param tx The transaction or null if none.\n+     * @param resource The fedora resource", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NjA5Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395196093", "bodyText": "No change requested here, but I have created the following JIRA: https://jira.lyrasis.org/browse/FCREPO-3254", "author": "awoods", "createdAt": "2020-03-19T17:25:01Z", "path": "fcrepo-kernel-api/src/main/java/org/fcrepo/kernel/api/ContainmentIndex.java", "diffHunk": "@@ -36,25 +36,31 @@\n      * @param fedoraResource The containing fedora resource\n      * @return A stream of contained identifiers\n      */\n-    Stream<String> getContainedBy(Transaction tx, FedoraResource fedoraResource);\n+    Stream<String> getContains(Transaction tx, FedoraResource fedoraResource);\n+\n+    /**\n+     * Return the ID of the containing resource for resourceID.\n+     * @param txID The transaction. If no transaction, null is okay.\n+     * @param resourceID The resource to find the containing resource.\n+     * @return The id of the containing resource or null if none found.\n+     */\n+    String getContainedBy(String txID, final String resourceID);", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzgxNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395197815", "bodyText": "Is there any risk that this method would be called with an external ID (http://localhost...)?", "author": "awoods", "createdAt": "2020-03-19T17:27:34Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/functions/FedoraIdUtils.java", "diffHunk": "@@ -36,6 +38,18 @@ public static String addToIdentifier(final String oldId, final String newIdPart)\n         return oldId + (oldId.endsWith(\"/\") ? \"\" : \"/\") + newIdPart;\n     }\n \n+    /**\n+     * Ensure the ID has the info:fedora/ prefix.\n+     * @param id the identifier, if null assume repository root (info:fedora/)\n+     * @return the identifier with the info:fedora/ prefix.\n+     */\n+    public static String ensurePrefix(final String id) {\n+        if (id == null) {\n+            return FEDORA_ID_PREFIX;\n+        }\n+        return id.startsWith(FEDORA_ID_PREFIX) ? id : FEDORA_ID_PREFIX + id;", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY1MDgzOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395650839", "bodyText": "I would hope not, but that could be better handled with FCREPO-3254 (new FedoraID class)", "author": "whikloj", "createdAt": "2020-03-20T13:53:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE5NzgxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwMTUxNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395201514", "bodyText": "Can we remove testParent and just use idIterator in lines 123 and 124 below?", "author": "awoods", "createdAt": "2020-03-19T17:33:00Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/AbstractService.java", "diffHunk": "@@ -102,14 +107,22 @@ protected String determineInteractionModel(final List<String> linkTypes,\n \n     /**\n      * Find the closest ancestor using a Fedora ID.\n+     * @param txID The current transaction or null if none.\n      * @param fedoraId The fedora ID to check\n      * @return The ancestor ID or null if root\n      */\n-    protected String findExistingAncestor(final String fedoraId) {\n-        // Remove the ID prefix as it can include a /\n-        final String removePrefix = fedoraId.substring(FEDORA_ID_PREFIX.length());\n-        if (removePrefix.contains(\"/\")) {\n-            return FEDORA_ID_PREFIX + removePrefix.substring(0, removePrefix.lastIndexOf(\"/\"));\n+    protected String findExistingAncestor(final String txID, final String fedoraId) {\n+        final String parent = containmentIndex.getContainedBy(txID, fedoraId);\n+        if (parent != null) {\n+            return parent;\n+        }\n+        String idIterator = fedoraId;\n+        while (idIterator.contains(\"/\")) {\n+            final String testParent = fedoraId.substring(0, idIterator.lastIndexOf(\"/\"));", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwNjM3Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395206376", "bodyText": "Can we remove testParent and just use slugIterator in lines 287 and 288 below?", "author": "awoods", "createdAt": "2020-03-19T17:40:25Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImpl.java", "diffHunk": "@@ -253,4 +260,37 @@ private String getResourcePath(final PersistentStorageSession pSession, final St\n     private List<Link> getLinkHeaders(final List<String> headers) {\n         return headers == null ? null : headers.stream().map(p -> Link.valueOf(p)).collect(Collectors.toList());\n     }\n+\n+    /**\n+     * Add this pairing to the containment index.\n+     * @param txId The transaction ID or null if no transaction.\n+     * @param parentId The parent ID or null if repository root.\n+     * @param id The child ID.\n+     */\n+    private void addToContainmentIndex(final String txId, final String parentId, final String id) {\n+        containmentIndex.addContainedBy(txId, ensurePrefix(parentId), ensurePrefix(id));\n+    }\n+\n+    /**\n+     * If the Slug has a forward slash then check that part of it is not an existing resource.\n+     * @param txID The current transaction id.\n+     * @param parent The fedora ID passed in with the slug.\n+     * @param slug The slug.\n+     * @return Array with the parent and slug.\n+     */\n+    private String[] splitSlug(final String txID, final String parent, final String slug) {\n+        if (slug != null && slug.contains(\"/\")) {\n+            String slugIterator = slug;\n+            while (slugIterator.contains(\"/\")) {\n+                final String testParent = slug.substring(0, slugIterator.lastIndexOf(\"/\"));", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwODU1MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395208551", "bodyText": "Can we change the variable name from normalizedFedoraId? ..maybe something like closestAncestorFedoraId?", "author": "awoods", "createdAt": "2020-03-19T17:43:41Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImpl.java", "diffHunk": "@@ -81,14 +82,20 @@ public String perform(final String txId, final String userPrincipal, final Strin\n                         final boolean isContained, final String contentType, final String filename,\n                         final Long contentSize, final List<String> linkHeaders, final Collection<URI> digest,\n                         final InputStream requestBody, final ExternalContent externalContent) {\n+        final String[] parts = splitSlug(txId, ensurePrefix(fedoraId), slug);\n+        // If we found an existing resource in the Slug, then that is our parent.\n+        final String normalizedFedoraId = (parts[0] != null) ? addToIdentifier(ensurePrefix(fedoraId), parts[0]) :", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIwODc1Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395208757", "bodyText": "Can we change the variable name from normalizedFedoraId? ..maybe something like closestAncestorFedoraId?", "author": "awoods", "createdAt": "2020-03-19T17:44:00Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImpl.java", "diffHunk": "@@ -138,13 +146,19 @@ private String createDescription(final PersistentStorageSession pSession, final\n     @Override\n     public String perform(final String txId, final String userPrincipal, final String fedoraId, final String slug,\n             final boolean isContained, final List<String> linkHeaders, final Model model) {\n+        final String[] parts = splitSlug(txId, ensurePrefix(fedoraId), slug);\n+        // If we found an existing resource in the Slug, then that is our parent.\n+        final String normalizedFedoraId = (parts[0] != null) ? addToIdentifier(ensurePrefix(fedoraId), parts[0]) :", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyMTMxNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395221317", "bodyText": "As a meta-comment, mixing PUT and POST in this method makes for convoluted logic. I would suggest that we split out the two scenarios... as a follow-on ticket.", "author": "awoods", "createdAt": "2020-03-19T18:04:36Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImpl.java", "diffHunk": "@@ -81,14 +82,20 @@ public String perform(final String txId, final String userPrincipal, final Strin\n                         final boolean isContained, final String contentType, final String filename,\n                         final Long contentSize, final List<String> linkHeaders, final Collection<URI> digest,\n                         final InputStream requestBody, final ExternalContent externalContent) {\n+        final String[] parts = splitSlug(txId, ensurePrefix(fedoraId), slug);", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2OTUyOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395669529", "bodyText": "I tried that in the initial phase of this service and it was hard. But I am open to a fresh set of eyes giving it a go.", "author": "whikloj", "createdAt": "2020-03-20T14:23:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTIyMTMxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4MzUxMQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395283511", "bodyText": "Does the order matter here? For example, if the deletion takes place before the addition?", "author": "awoods", "createdAt": "2020-03-19T19:55:21Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -224,19 +247,32 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n             // not in a transaction\n             children = jdbcTemplate.queryForList(SELECT_CHILDREN, parameterSource, String.class);\n         }\n+        LOGGER.debug(\"getChildren for {} in transaction {} found {} children\", fedoraId, transactionId,\n+                children.size());\n         return children.stream();\n     }\n \n     @Override\n-    public Stream<String> getContainedBy(final Transaction tx, final FedoraResource fedoraResource) {\n+    public Stream<String> getContains(final Transaction tx, final FedoraResource fedoraResource) {\n         final String txId = (tx != null) ? tx.getId() : null;\n         return getChildren(fedoraResource.getId(), txId);\n     }\n \n     @Override\n-    public void addContainedBy(final Transaction tx, final FedoraResource parent, final FedoraResource child) {\n-        final String txID = tx != null ? tx.getId() : null;\n-        addContainedBy(txID, parent.getId(), child.getId());\n+    public String getContainedBy(final String txID, final String resourceID) {\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+        parameterSource.addValue(\"child\", resourceID);\n+        final List<String> parentID;\n+        if (txID != null) {\n+            parameterSource.addValue(\"transactionId\", txID);\n+            final String currentResourceQuery = PARENT_EXISTS +\n+                    \" UNION \" + PARENT_EXISTS_ADDITIONS +", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2MTEwNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395661106", "bodyText": "No, the eventual query is all records from the main table for the resource and transaction table with \"add\" unless they are in the transaction table with \"delete\"", "author": "whikloj", "createdAt": "2020-03-20T14:10:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4MzUxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY3NzU3Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395677573", "bodyText": "..and it does not matter if the \"delete\" preceded the \"add\"?", "author": "awoods", "createdAt": "2020-03-20T14:34:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4MzUxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY5ODAwMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395698000", "bodyText": "No, because it isn't actually a delete. Its an EXCEPT.\n\nEXCEPT\nReturns any distinct values from the query left of the EXCEPT operator. Those values return as long the right query doesn't return those values as well.", "author": "whikloj", "createdAt": "2020-03-20T15:04:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4MzUxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcwMjc5Mg==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395702792", "bodyText": "Sorry the DELETEs and ADDs make it seem like an update where it is just a complex query. So we need to do the UNION and then the EXCEPT.", "author": "whikloj", "createdAt": "2020-03-20T15:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4MzUxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTI4NjkyOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395286929", "bodyText": "It may be helpful to include the txId in the log message.", "author": "awoods", "createdAt": "2020-03-19T20:01:45Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -278,24 +313,55 @@ public void removeContainedBy(final Transaction tx, final FedoraResource parent,\n         }\n     }\n \n+    @Override\n+    public void removeResource(final String txID, final String resourceID) {\n+        final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n+        parameterSource.addValue(\"child\", resourceID);\n+        if (txID != null) {\n+            parameterSource.addValue(\"transactionId\", txID);\n+            final boolean addedInTxn = !jdbcTemplate.queryForList(IS_CHILD_ADDED_IN_TRANSACTION_NO_PARENT,\n+                    parameterSource).isEmpty();\n+            if (addedInTxn) {\n+                jdbcTemplate.update(UNDO_INSERT_CHILD_IN_TRANSACTION_NO_PARENT, parameterSource);\n+            } else {\n+                final String parent = getContainedBy(txID, resourceID);\n+                if (parent != null) {\n+                    LOGGER.debug(\"Removing containment relationship between parent ({}) and child ({})\", parent,\n+                            resourceID);\n+                    parameterSource.addValue(\"parent\", parent);\n+                    jdbcTemplate.update(DELETE_CHILD_IN_TRANSACTION, parameterSource);\n+                }\n+            }\n+        } else {\n+            jdbcTemplate.update(DELETE_ALL_RESOURCE, parameterSource);\n+        }\n+    }\n+\n     @Override\n     public void commitTransaction(final Transaction tx) {\n         if (tx != null) {\n             final String txId = tx.getId();\n+            final TransactionTemplate transactionTemplate = new TransactionTemplate(platformTransactionManager);\n             final MapSqlParameterSource parameterSource = new MapSqlParameterSource();\n             parameterSource.addValue(\"transactionId\", txId);\n-            final DefaultTransactionDefinition paramTransactionDefinition = new DefaultTransactionDefinition();\n-            final TransactionStatus status = platformTransactionManager.getTransaction(paramTransactionDefinition);\n-            try {\n-                jdbcTemplate.update(COMMIT_ADD_RECORDS, parameterSource);\n-                jdbcTemplate.update(COMMIT_DELETE_RECORDS, parameterSource);\n-                jdbcTemplate.update(COMMIT_CLEANUP, parameterSource);\n-                platformTransactionManager.commit(status);\n-            } catch (Exception e) {\n-                platformTransactionManager.rollback(status);\n-                LOGGER.warn(\"Unable to commit containment index transaction: {}\", e.getMessage());\n-                throw new RepositoryRuntimeException(\"Unable to commit containment index transaction\", e);\n-            }\n+            // Seemingly setting the name ensures that we don't re-use a transaction.\n+            transactionTemplate.setName(\"tx-\" + txId);\n+            transactionTemplate.setPropagationBehavior(TransactionTemplate.PROPAGATION_REQUIRED);\n+            transactionTemplate.execute(\n+                new TransactionCallbackWithoutResult() {\n+                    protected void doInTransactionWithoutResult(final TransactionStatus status) {\n+                        try {\n+                            jdbcTemplate.update(COMMIT_DELETE_RECORDS, parameterSource);\n+                            jdbcTemplate.update(COMMIT_ADD_RECORDS, parameterSource);\n+                            jdbcTemplate.update(COMMIT_CLEANUP, parameterSource);\n+                        } catch (Exception e) {\n+                            status.setRollbackOnly();\n+                            LOGGER.warn(\"Unable to commit containment index transaction: {}\", e.getMessage());", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1MzIyNQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395353225", "bodyText": "Minor: so we keep the code in line with basic Java conventions, please change to: cleanupList", "author": "awoods", "createdAt": "2020-03-19T22:24:21Z", "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImplTest.java", "diffHunk": "@@ -140,47 +162,70 @@\n \n     private static final Collection<URI> DIGESTS = singleton(URI.create(\"urn:sha1:12345abced\"));\n \n+    private static final List<String> cleanup_list = new ArrayList<>() ;", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTM1NDU3Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1647#discussion_r395354577", "bodyText": "Any reason to keep these commented lines around?", "author": "awoods", "createdAt": "2020-03-19T22:27:59Z", "path": "fcrepo-kernel-impl/src/test/java/org/fcrepo/kernel/impl/services/CreateResourceServiceImplTest.java", "diffHunk": "@@ -365,35 +430,40 @@ public void testWithSlugExistsBinary() throws Exception {\n \n         final var descOperation = getOperation(operations, CreateRdfSourceOperation.class);\n         assertEquals(persistedId + \"/fcr:metadata\", descOperation.getResourceId());\n+        when(fedoraResource.getId()).thenReturn(fedoraId);\n+        assertEquals(2, containmentIndex.getContains(transaction, fedoraResource).count());\n     }\n \n     @Test\n     public void testWithSlugDoesntExistsRdf() throws Exception {\n-        final String fedoraId = UUID.randomUUID().toString();\n+        final String fedoraId = ensurePrefix(UUID.randomUUID().toString());\n         final String childId = addToIdentifier(fedoraId, \"testSlug\");\n         when(psSession.getHeaders(fedoraId, null)).thenReturn(resourceHeaders);\n         when(psSession.getHeaders(childId, null)).thenThrow(PersistentItemNotFoundException.class);\n         when(resourceHeaders.getInteractionModel()).thenReturn(BASIC_CONTAINER.toString());\n         final String newID = createResourceService.perform(TX_ID, USER_PRINCIPAL, fedoraId, \"testSlug\", true, null,\n                 model);\n-\n+        cleanup_list.add(fedoraId);\n         verify(psSession).persist(operationCaptor.capture());\n         final var operation = (CreateRdfSourceOperation) operationCaptor.getValue();\n         assertEquals(childId, operation.getResourceId());\n         assertEquals(fedoraId, operation.getParentId());\n         assertEquals(childId, newID);\n+        when(fedoraResource.getId()).thenReturn(fedoraId);\n+        assertEquals(1, containmentIndex.getContains(transaction, fedoraResource).count());\n     }\n \n     @Test\n     public void testWithSlugDoesntExistsBinary() throws Exception {\n-        final String fedoraId = UUID.randomUUID().toString();\n+        final String fedoraId = ensurePrefix(UUID.randomUUID().toString());\n         final var childId = addToIdentifier(fedoraId, \"testSlug\");\n         when(psSession.getHeaders(fedoraId, null)).thenReturn(resourceHeaders);\n-        when(psSession.getHeaders(childId, null)).thenThrow(PersistentItemNotFoundException.class);\n+        //containmentIndex.addContainedBy(null, ensurePrefix(fedoraId));", "originalCommit": "f92d9f8f9411e9b475cbe88d357c871b0141d24a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5e33f9273faab8499b0c3d93071a19eb3cde84b8", "url": "https://github.com/fcrepo/fcrepo/commit/5e33f9273faab8499b0c3d93071a19eb3cde84b8", "message": "Code review", "committedDate": "2020-03-20T14:17:29Z", "type": "commit"}]}