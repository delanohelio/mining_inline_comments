{"pr_number": 1788, "pr_title": "Memento containment", "pr_createdAt": "2020-11-05T14:56:06Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1788", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r518136846", "bodyText": "Would getResouceId() not do what you want here?", "author": "pwinckles", "createdAt": "2020-11-05T15:27:03Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -325,21 +377,27 @@ private NamedParameterJdbcTemplate getNamedParameterJdbcTemplate() {\n \n     @Override\n     public Stream<String> getContains(final String txId, final FedoraId fedoraId) {\n-        final String resourceId = fedoraId.getFullId();\n+        final String resourceId = fedoraId.isMemento() ? fedoraId.getBaseId() : fedoraId.getFullId();", "originalCommit": "a11a415c0446162bd51a3cbf7f374bc18e369e0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NDY5OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r520884699", "bodyText": "getResourceId() handles ACLs and NonRdfSourceDescriptions, but not Mementos.", "author": "whikloj", "createdAt": "2020-11-10T21:28:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg5MDI3MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r520890271", "bodyText": "But, the output of getResourceId can never contain a memento because it constructs an id based on the baseId.", "author": "pwinckles", "createdAt": "2020-11-10T21:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM5NjExNg==", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r522396116", "bodyText": "I understand, I can change this.", "author": "whikloj", "createdAt": "2020-11-12T20:17:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzNjg0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzOTgxOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r518139819", "bodyText": "Since mementos have second level granularity, perhaps it would make sense to truncate to the second?", "author": "pwinckles", "createdAt": "2020-11-05T15:31:04Z", "path": "fcrepo-kernel-impl/src/main/java/org/fcrepo/kernel/impl/ContainmentIndexImpl.java", "diffHunk": "@@ -591,4 +660,18 @@ public void setDataSource(final DataSource dataSource) {\n         this.dataSource = dataSource;\n     }\n \n+    /**\n+     * Format an instant to a timestamp without milliseconds, due to precision\n+     * issues with memento datetimes.\n+     * @param instant\n+     * @return the timestamp\n+     */\n+    private Timestamp formatInstant(final Instant instant) {\n+        if (instant == null) {\n+            return null;\n+        }\n+        final var timestamp = Timestamp.from(instant);\n+        timestamp.setNanos(0);", "originalCommit": "a11a415c0446162bd51a3cbf7f374bc18e369e0e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDg4NjAwNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r520886007", "bodyText": "Is that not what this is doing? Setting the nanoseconds to 0? Perhaps @bbpennel could help as I stole this from his code", "author": "whikloj", "createdAt": "2020-11-10T21:30:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzOTgxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTU0MzA5NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1788#discussion_r521543094", "bodyText": "I see. It reads as if it's truncating to milliseconds, but I see now that it's just removing all fractions of a second.", "author": "pwinckles", "createdAt": "2020-11-11T18:03:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODEzOTgxOQ=="}], "type": "inlineReview"}, {"oid": "82358bba38c2a0d6e0896208ebcd6365d5eea038", "url": "https://github.com/fcrepo/fcrepo/commit/82358bba38c2a0d6e0896208ebcd6365d5eea038", "message": "Stop MariaDB setting timestamp to current time", "committedDate": "2020-11-10T21:25:24Z", "type": "forcePushed"}, {"oid": "5de3e62688b0e539097547d7eff1875e90630469", "url": "https://github.com/fcrepo/fcrepo/commit/5de3e62688b0e539097547d7eff1875e90630469", "message": "First pass at memento containment", "committedDate": "2020-11-12T19:49:36Z", "type": "commit"}, {"oid": "fc4be6dce9acff805af74147a2663e330bc6f94c", "url": "https://github.com/fcrepo/fcrepo/commit/fc4be6dce9acff805af74147a2663e330bc6f94c", "message": "Stop MariaDB setting timestamp to current time", "committedDate": "2020-11-12T19:49:45Z", "type": "commit"}, {"oid": "fc4be6dce9acff805af74147a2663e330bc6f94c", "url": "https://github.com/fcrepo/fcrepo/commit/fc4be6dce9acff805af74147a2663e330bc6f94c", "message": "Stop MariaDB setting timestamp to current time", "committedDate": "2020-11-12T19:49:45Z", "type": "forcePushed"}, {"oid": "7cbb9f610d4eec4fd881a594fdb9bfcacc953516", "url": "https://github.com/fcrepo/fcrepo/commit/7cbb9f610d4eec4fd881a594fdb9bfcacc953516", "message": "Use getResourceId()", "committedDate": "2020-11-12T20:34:43Z", "type": "commit"}]}