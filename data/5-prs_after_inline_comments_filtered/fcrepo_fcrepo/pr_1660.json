{"pr_number": 1660, "pr_title": "Refactors the index rebuild routine to include containment relationships.", "pr_createdAt": "2020-04-09T22:02:13Z", "pr_url": "https://github.com/fcrepo/fcrepo/pull/1660", "timeline": [{"oid": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "url": "https://github.com/fcrepo/fcrepo/commit/e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247", "committedDate": "2020-04-09T22:36:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzgxNw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406513817", "bodyText": "Containment Index now uses FedoraIds for this method, so you'll need to generate them.", "author": "whikloj", "createdAt": "2020-04-09T22:33:21Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -77,10 +95,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n+                                final var fedoraId = headers.getId();\n+                                fedoraIds.add(fedoraId);\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n                                 }\n+\n+                                if(!fedoraId.equals(rootFedoraId)) {\n+                                    var parentId = headers.getParent();\n+\n+                                    if( parentId == null) {\n+                                        if (!fedoraId.endsWith(FCR_METADATA) &&\n+                                            !fedoraId.endsWith(FCR_ACL) &&\n+                                            !fedoraId.endsWith(FCR_VERSIONS)) {\n+                                            parentId = FEDORA_ID_PREFIX;\n+                                        }\n+                                    }\n+\n+                                    if (parentId != null) {\n+                                        this.containmentIndex.addContainedBy(txId, parentId, headers.getId());", "originalCommit": "26690e265f10644c9eb3cde78f3ee55955e5ebd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzE2OA==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406867168", "bodyText": "Cool I will fix.", "author": "dbernstein", "createdAt": "2020-04-10T17:45:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxMzgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxODU4NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406518584", "bodyText": "If you create fedoraId as a FedoraId then you could use fedoraId.isRepositoryRoot() here.", "author": "whikloj", "createdAt": "2020-04-09T22:48:10Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -77,10 +95,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n+                                final var fedoraId = headers.getId();\n+                                fedoraIds.add(fedoraId);\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n                                 }\n+\n+                                if (!fedoraId.equals(rootFedoraId)) {", "originalCommit": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzI5OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406867299", "bodyText": "I'll definitely do that.", "author": "dbernstein", "createdAt": "2020-04-10T17:45:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxODU4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxODc3NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406518774", "bodyText": "Probably don't need to re-define this string here.", "author": "whikloj", "createdAt": "2020-04-09T22:48:45Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -60,7 +72,13 @@ public void rebuild() {\n \n         LOGGER.info(\"Initiating index rebuild.\");\n         fedoraToOCFLObjectIndex.reset();\n+        final var transaction = transactionManager.create();\n+        final var txId = transaction.getId();\n+        final var rootFedoraId = FEDORA_ID_PREFIX;", "originalCommit": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzM1NA==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406867354", "bodyText": "valid point.", "author": "dbernstein", "createdAt": "2020-04-10T17:46:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxODc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxOTg5Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406519896", "bodyText": "I don't think TimeMaps get persisted to OCFL.", "author": "whikloj", "createdAt": "2020-04-09T22:52:20Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -77,10 +95,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n+                                final var fedoraId = headers.getId();\n+                                fedoraIds.add(fedoraId);\n                                 if (headers.isArchivalGroup()) {\n                                     rootId.set(headers.getId());\n                                 }\n+\n+                                if (!fedoraId.equals(rootFedoraId)) {\n+                                    var parentId = headers.getParent();\n+\n+                                    if (parentId == null) {\n+                                        if (!fedoraId.endsWith(FCR_METADATA) &&\n+                                                !fedoraId.endsWith(FCR_ACL) &&\n+                                                !fedoraId.endsWith(FCR_VERSIONS)) {", "originalCommit": "e69540fa2ae8c12a5c8496d9f6e8e560ef06d9bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjg2NzQ2NQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r406867465", "bodyText": "Yes that's true. I'll pull that out.", "author": "dbernstein", "createdAt": "2020-04-10T17:46:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjUxOTg5Ng=="}], "type": "inlineReview"}, {"oid": "f554c17a8adf57f21d0611d75144f787d3b8d1a7", "url": "https://github.com/fcrepo/fcrepo/commit/f554c17a8adf57f21d0611d75144f787d3b8d1a7", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247", "committedDate": "2020-04-14T05:56:32Z", "type": "commit"}, {"oid": "f554c17a8adf57f21d0611d75144f787d3b8d1a7", "url": "https://github.com/fcrepo/fcrepo/commit/f554c17a8adf57f21d0611d75144f787d3b8d1a7", "message": "Refactors the index rebuild routine to include containment relationships.\n\nResolves: https://jira.lyrasis.org/browse/FCREPO-3247", "committedDate": "2020-04-14T05:56:32Z", "type": "forcePushed"}, {"oid": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "url": "https://github.com/fcrepo/fcrepo/commit/2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "message": "Address feedback.", "committedDate": "2020-04-14T17:09:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4Nzk1Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408387957", "bodyText": "What are the other 3 new ids that it should be returning? Should we be testing that they are present like the previous ones?", "author": "bbpennel", "createdAt": "2020-04-14T19:39:25Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -108,22 +117,55 @@ public void testRebuildOCFL() {\n             ocflRepository.listObjectIds().forEach(id -> LOGGER.debug(\"Object id: {}\", id));\n         }\n \n-        // Test directly against the underlying OCFL repository\n-        Assert.assertEquals(4, ocflRepository.listObjectIds().count());\n-        Assert.assertTrue(\"Should contain object with id: binary\", ocflRepository.containsObject(\"binary\"));\n-        Assert.assertTrue(\"Should contain object with id: test\", ocflRepository.containsObject(\"test\"));\n-        Assert.assertTrue(\"Should contain object with id: test_child\", ocflRepository.containsObject(\"test_child\"));\n-        Assert.assertFalse(\"Should NOT contain object with id: junk\", ocflRepository.containsObject(\"junk\"));\n+        assertEquals(7, ocflRepository.listObjectIds().count());", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE0MDI5MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409140291", "bodyText": "sure.", "author": "dbernstein", "createdAt": "2020-04-15T21:19:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM4Nzk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5MzYwOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408393609", "bodyText": "reformat into separate lines. Also add short description of flag parameter", "author": "bbpennel", "createdAt": "2020-04-14T19:50:02Z", "path": "fcrepo-persistence-common/src/main/java/org/fcrepo/persistence/common/ResourceHeadersImpl.java", "diffHunk": "@@ -240,4 +242,19 @@ public void setArchivalGroup(final boolean flag) {\n     public boolean isArchivalGroup() {\n         return archivalGroup;\n     }\n+\n+    /**\n+     *\n+     * @param flag\n+     */\n+    public void setObjectRoot(final boolean flag) { this.objectRoot = flag; }", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5Mzc0Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408393743", "bodyText": "space after if", "author": "bbpennel", "createdAt": "2020-04-14T19:50:14Z", "path": "fcrepo-persistence-common/src/main/java/org/fcrepo/persistence/common/ResourceHeadersImpl.java", "diffHunk": "@@ -240,4 +242,19 @@ public void setArchivalGroup(final boolean flag) {\n     public boolean isArchivalGroup() {\n         return archivalGroup;\n     }\n+\n+    /**\n+     *\n+     * @param flag\n+     */\n+    public void setObjectRoot(final boolean flag) { this.objectRoot = flag; }\n+\n+    @Override\n+    public boolean isObjectRoot() {\n+        if(isArchivalGroup()) {", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5ODcxMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408398713", "bodyText": "the parent id should already be getting set by the call to newResourceHeaders I think? this this line can probably be removed", "author": "bbpennel", "createdAt": "2020-04-14T19:59:03Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractRDFSourcePersister.java", "diffHunk": "@@ -103,6 +105,8 @@ private ResourceHeaders populateHeaders(final OCFLObjectSession objSession, fina\n                     createOperation.getInteractionModel());\n             touchCreationHeaders(headers, operation.getUserPrincipal(), timeWritten);\n             headers.setArchivalGroup(createOperation.isArchivalGroup());\n+            headers.setParent(createOperation.getParentId());", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE0NTg3OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409145879", "bodyText": "\ud83d\udc4d", "author": "dbernstein", "createdAt": "2020-04-15T21:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM5ODcxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTEwMA==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408401100", "bodyText": "Just curious, what triggered the upgrade from FedoraToOCFLObjectIndexUtilImpl to IndexBuilderImpl? Maybe the javadoc for the class should describe what kind of index builder this is versus the interface?", "author": "bbpennel", "createdAt": "2020-04-14T20:03:25Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -18,43 +18,50 @@\n package org.fcrepo.persistence.ocfl.impl;\n \n import edu.wisc.library.ocfl.api.OcflRepository;\n+import org.fcrepo.kernel.api.ContainmentIndex;\n+import org.fcrepo.kernel.api.TransactionManager;\n import org.fcrepo.kernel.api.exception.RepositoryRuntimeException;\n+import org.fcrepo.kernel.api.identifiers.FedoraId;\n import org.fcrepo.persistence.api.exceptions.PersistentStorageException;\n import org.fcrepo.persistence.ocfl.api.FedoraToOCFLObjectIndex;\n-import org.fcrepo.persistence.ocfl.api.FedoraToOCFLObjectIndexUtil;\n+import org.fcrepo.persistence.ocfl.api.IndexBuilder;\n import org.fcrepo.persistence.ocfl.api.OCFLObjectSessionFactory;\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n import org.springframework.stereotype.Component;\n \n import javax.inject.Inject;\n import java.util.ArrayList;\n-import java.util.Objects;\n import java.util.concurrent.atomic.AtomicReference;\n \n import static java.lang.String.format;\n \n-import static org.fcrepo.kernel.api.RdfLexicon.FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI;\n import static org.fcrepo.persistence.common.ResourceHeaderSerializationUtils.deserializeHeaders;\n import static org.fcrepo.persistence.ocfl.impl.OCFLPersistentStorageUtils.isSidecarSubpath;\n \n /**\n- * An implementation of {@link FedoraToOCFLObjectIndexUtil}\n+ * An implementation of {@link IndexBuilder}\n  *\n  * @author dbernstein\n  * @since 6.0.0\n  */\n @Component\n-public class FedoraToOCFLObjectIndexUtilImpl implements FedoraToOCFLObjectIndexUtil {\n+public class IndexBuilderImpl implements IndexBuilder {", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1NTc5Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409055796", "bodyText": "Sure - I changed the name because it builds the FedoraToOCFL as well as the containment relationships now.", "author": "dbernstein", "createdAt": "2020-04-15T18:42:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTEwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1NzU0Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409157547", "bodyText": "Updated the javadoc of both the interface and concrete class.", "author": "dbernstein", "createdAt": "2020-04-15T21:55:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTY2Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408401663", "bodyText": "Nothing happens between these two log statements. Are they both needed, or is there something missing here?", "author": "bbpennel", "createdAt": "2020-04-14T20:04:19Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -63,7 +70,12 @@ public void rebuild() {\n \n         LOGGER.info(\"Initiating index rebuild.\");\n         fedoraToOCFLObjectIndex.reset();\n+        final var transaction = transactionManager.create();\n+        final var txId = transaction.getId();\n+        LOGGER.info(\"Resetting ContaintmentIndex...\");", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgzMDg1Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408830857", "bodyText": "The fedoraToOCFLObjectIndex.reset(); clears the index and deletes the file on disk if is exists.", "author": "whikloj", "createdAt": "2020-04-15T13:14:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg2NDA3Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408864076", "bodyText": "Okay, LOGGER.info(\"Resetting ContaintmentIndex...\"); should probably happen before fedoraToOCFLObjectIndex.reset(); in that case, otherwise its coming a little on the late side :)", "author": "bbpennel", "createdAt": "2020-04-15T13:59:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg2OTAzMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408869033", "bodyText": "Ohhhhh sorry I was looking at the top LOGGER.info(\"Initiating index rebuild.\");, on the main page it didn't show the below LOGGER.info().\nPlease disregard this comment, it appears that both the fedoraToOcflIndex and containment index is rebuilt at the same time. So additional log statements are probably not necessary.", "author": "whikloj", "createdAt": "2020-04-15T14:05:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTY2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1NzY4Ng==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409157686", "bodyText": "Removed useless log messages.", "author": "dbernstein", "createdAt": "2020-04-15T21:56:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQwMTY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMTYyNA==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408421624", "bodyText": "Maybe we can address this later, but if a file exists in an archival group, but is neither the root nor has a defined parent, we should be able to determine a parent id based on the file hierarchy. This would be the case for non-fedora ocfl, and at some point we might want to make the parent implicit within archival groups (that's come up on a few calls)", "author": "bbpennel", "createdAt": "2020-04-14T20:40:48Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImpl.java", "diffHunk": "@@ -80,14 +92,28 @@ public void rebuild() {\n                             //we're only interested in sidecar subpaths\n                             try {\n                                 final var headers = deserializeHeaders(objSession.read(subpath));\n-                                fedoraIds.add(headers.getId());\n-                                if (headers.isArchivalGroup()) {\n+                                final var fedoraId = FedoraId.create(headers.getId());\n+                                fedoraIds.add(fedoraId.getFullId());\n+                                if (headers.isArchivalGroup() || headers.isObjectRoot()) {\n                                     rootId.set(headers.getId());\n-                                } else if (Objects.equals(headers.getInteractionModel(),\n-                                        FEDORA_NON_RDF_SOURCE_DESCRIPTION_URI)) {\n-                                    rootId.set(headers.getParent());\n                                 }\n-                            } catch (final PersistentStorageException e) {\n+\n+                                if (!fedoraId.isRepositoryRoot()) {\n+                                    var parentId = headers.getParent();\n+\n+                                    if (parentId == null) {\n+                                        if (headers.isObjectRoot()) {", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1NzA0OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409057049", "bodyText": "Yes - let's address in the non-fedora generated case.", "author": "dbernstein", "createdAt": "2020-04-15T18:44:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMTYyNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MDg1Mw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409060853", "bodyText": "https://jira.lyrasis.org/browse/FCREPO-3277", "author": "dbernstein", "createdAt": "2020-04-15T18:51:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyMTYyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyOTk2OQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408429969", "bodyText": "assertIndexContains actually seems to verify what the ocfl object id assigned to an id is, rather than whether it is in the index or not. Maybe the name of the method could be updated to clarify its purpose? assertHasOcflId or something. I was having a hard time understanding what this assertion was checking.", "author": "bbpennel", "createdAt": "2020-04-14T20:56:12Z", "path": "fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/IndexBuilderImplTest.java", "diffHunk": "@@ -127,51 +152,57 @@ public void rebuildWhenRepoContainsNonArchivalGroupObject() throws Exception {\n         assertIndexDoesNotContain(resource1);\n         assertIndexDoesNotContain(resource2);\n \n-        util.rebuild();\n+        indexBuilder.rebuild();\n \n         assertIndexContains(\"resource1\", resource1);", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1NzU0MQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409057541", "bodyText": "Sure - I'll fix that.", "author": "dbernstein", "createdAt": "2020-04-15T18:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQyOTk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzMTk1Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408431957", "bodyText": "Maybe this could be for later, but it'd be good to verify that a rebuild works with ghost nodes.", "author": "bbpennel", "createdAt": "2020-04-14T20:59:58Z", "path": "fcrepo-http-api/src/test/java/org/fcrepo/integration/http/api/RebuildIT.java", "diffHunk": "@@ -108,22 +117,55 @@ public void testRebuildOCFL() {\n             ocflRepository.listObjectIds().forEach(id -> LOGGER.debug(\"Object id: {}\", id));\n         }\n \n-        // Test directly against the underlying OCFL repository\n-        Assert.assertEquals(4, ocflRepository.listObjectIds().count());\n-        Assert.assertTrue(\"Should contain object with id: binary\", ocflRepository.containsObject(\"binary\"));\n-        Assert.assertTrue(\"Should contain object with id: test\", ocflRepository.containsObject(\"test\"));\n-        Assert.assertTrue(\"Should contain object with id: test_child\", ocflRepository.containsObject(\"test_child\"));\n-        Assert.assertFalse(\"Should NOT contain object with id: junk\", ocflRepository.containsObject(\"junk\"));\n+        assertEquals(7, ocflRepository.listObjectIds().count());\n+        assertTrue(\"Should contain object with id: binary\", ocflRepository.containsObject(\"binary\"));\n+        assertTrue(\"Should contain object with id: test\", ocflRepository.containsObject(\"test\"));\n+        assertTrue(\"Should contain object with id: test_child\", ocflRepository.containsObject(\"test_child\"));\n+        assertFalse(\"Should NOT contain object with id: junk\", ocflRepository.containsObject(\"junk\"));\n     }\n \n     @Test\n-    public void testRebuildWebapp() {\n+    public void testRebuildWebapp() throws Exception {", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA1OTIxMw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409059213", "bodyText": "https://jira.lyrasis.org/browse/FCREPO-3276", "author": "dbernstein", "createdAt": "2020-04-15T18:48:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzMTk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNDQwOQ==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r408434409", "bodyText": "It would be good to have a test somewhere that verifies this new behavior, maybe in CreateNonRdfSourcePersisterTest. An integration test would be nice since it'd make sure that a blank subpath gets generated, but that might not be practical at the moment, not sure.", "author": "bbpennel", "createdAt": "2020-04-14T21:04:34Z", "path": "fcrepo-persistence-ocfl/src/main/java/org/fcrepo/persistence/ocfl/impl/AbstractNonRdfSourcePersister.java", "diffHunk": "@@ -108,7 +108,8 @@ protected void persistNonRDFSource(final ResourceOperation operation,\n         }\n \n         // Write resource headers\n-        final var headers = populateHeaders(objectSession, subpath, nonRdfSourceOperation, outcome);\n+        final var headers = populateHeaders(objectSession, subpath, nonRdfSourceOperation, outcome,\n+                fedoraSubpath == \"\");", "originalCommit": "2c9f9a7fa4ac6475ea0debbe82da78ff9b36b8b2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2MjY5MA==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409062690", "bodyText": "I'll take a look.", "author": "dbernstein", "createdAt": "2020-04-15T18:54:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNDQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE1NzI5Nw==", "url": "https://github.com/fcrepo/fcrepo/pull/1660#discussion_r409157297", "bodyText": "A unit test explicitly covers it here: https://github.com/fcrepo4/fcrepo4/blob/master/fcrepo-persistence-ocfl/src/test/java/org/fcrepo/persistence/ocfl/impl/OCFLPersistentStorageUtilsTest.java#L91.", "author": "dbernstein", "createdAt": "2020-04-15T21:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNDQwOQ=="}], "type": "inlineReview"}, {"oid": "13d577030b8041e6e4b3bb5abe2a2fde96e1f8bc", "url": "https://github.com/fcrepo/fcrepo/commit/13d577030b8041e6e4b3bb5abe2a2fde96e1f8bc", "message": "Addresses remaining feedback on https://github.com/fcrepo4/fcrepo4/pull/1660", "committedDate": "2020-04-15T22:39:42Z", "type": "commit"}]}