{"pr_number": 1628, "pr_title": "Download sources for the masses", "pr_createdAt": "2020-12-09T21:13:06Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNjcyNw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r543316727", "bodyText": "Missing copyright header", "author": "testforstephen", "createdAt": "2020-12-15T12:53:29Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/MavenPropertiesIdentifier.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.eclipse.jdt.ls.core.internal;", "originalCommit": "8d699751aaebc5fa470683d4e316e0b2693c1f95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0MTI5Ng==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r543341296", "bodyText": "Since this file is only used by MavenSourceDownloader, how about moving it to the package org.eclipse.jdt.ls.core.internal.managers?", "author": "testforstephen", "createdAt": "2020-12-15T13:29:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNjcyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2MzYzOA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r551563638", "bodyText": "Added header and moved to internal.managers.", "author": "rgrunber", "createdAt": "2021-01-04T20:55:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMxNjcyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0NjA0Ng==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r543346046", "bodyText": "Looks like MavenPropertiesIdentifier and MavenCentralIdentifier share some common interface, how about extracting to an interface such as IMavenArtifactIdentifier?\npublic interface IMavenArtifactIdentifier {\n    public ArtifactKey identify(IPath path, IProgressMonitor monitor);\n\n    public ArtifactKey identify(File file, IProgressMonitor monitor);\n}", "author": "testforstephen", "createdAt": "2020-12-15T13:36:35Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/MavenPropertiesIdentifier.java", "diffHunk": "@@ -0,0 +1,72 @@\n+package org.eclipse.jdt.ls.core.internal;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.Enumeration;\n+import java.util.Properties;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipFile;\n+\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.m2e.core.embedder.ArtifactKey;\n+\n+\n+public class MavenPropertiesIdentifier {", "originalCommit": "8d699751aaebc5fa470683d4e316e0b2693c1f95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTU2MzQxNQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r551563415", "bodyText": "Done. We can use public ArtifactKey identify(IPath path, IProgressMonitor monitor); in both cases. I've switched some of the methods in the implementation to private to make it more obvious what is API and what are internal helpers.", "author": "rgrunber", "createdAt": "2021-01-04T20:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzM0NjA0Ng=="}], "type": "inlineReview"}, {"oid": "112110bac02b0601cd4ae4ce05baf7a0c28e8643", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/112110bac02b0601cd4ae4ce05baf7a0c28e8643", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\n- Create IMavenArtifactIdentifier to be implemented by\n  MavenPropertiesIdentifier and MavenCentralIdentifier\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>", "committedDate": "2021-01-04T20:35:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA4Mjc3Mw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r553082773", "bodyText": "Need a PR in the client side to expose the new preference key.", "author": "testforstephen", "createdAt": "2021-01-07T03:01:13Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/preferences/Preferences.java", "diffHunk": "@@ -129,6 +129,11 @@\n \t * Preference key to enable/disable downloading Maven source artifacts.\n \t */\n \tpublic static final String MAVEN_DOWNLOAD_SOURCES = \"java.maven.downloadSources\";\n+\t/**\n+\t * Preference key to enable/disable downloading source artifacts for Eclipse\n+\t * projects.\n+\t */\n+\tpublic static final String ECLIPSE_DOWNLOAD_SOURCES = \"java.eclipse.downloadSources\";", "originalCommit": "112110bac02b0601cd4ae4ce05baf7a0c28e8643", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYwODY3NA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r553608674", "bodyText": "I'm not sure if this is something we want to expose, simply because it looks like there's other cases where we don't, and I suspect it's because we want the feature to always be on. @fbricon , let me know your thoughts.\nFor MavenBuildSupport, and InvisibleProjectBuildSupport, discoverSource(..) seems to always execute if called.\nFor EclipseBuildSupport, discoverSource(..) only executes if \"java.eclipse.downloadSources\" is true.\nSo if Maven source downloading always works, then what does \"java.maven.downloadSources\" do ? Well, it looks like it's only used in MavenProjectImporter#importToWorkspace(..) to determine if all sources are downloaded on import, but it doesn't prevent on-demand downloading.\nIn other words, it seems like the intent is to always download sources for on-demand cases (eg. on hover, or go-to definition). If so, do we even need a \"java.eclipse.downloadSources\" ? It would only be useful if we needed to configure source downloading on initial import of an Eclipse project, but we don't support that yet.", "author": "rgrunber", "createdAt": "2021-01-07T21:49:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA4Mjc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzYyMTAwNA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r553621004", "bodyText": "we need to keep it disabled by default (for eclipse projects) and expose a preference, because, when enabled, it'll change .classpath files by adding absolute paths to source files.\nInvisble projects need to have the feature enabled regardless of this preference", "author": "fbricon", "createdAt": "2021-01-07T22:12:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA4Mjc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDAwODM5MQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r554008391", "bodyText": "Makes sense, we should avoid messing with \"user-controlled\" .classpath if possibe. I'll expose the option in vscode-java and have it disabled by default.", "author": "rgrunber", "createdAt": "2021-01-08T15:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA4Mjc3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MjQwOA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r554082408", "bodyText": "Exposed property in redhat-developer/vscode-java#1758", "author": "rgrunber", "createdAt": "2021-01-08T17:19:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzA4Mjc3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MTYzMw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r554081633", "bodyText": "Ran into a potential issue here. For Eclipse projects, classpath entries can be relative also :\n<classpathentry kind=\"lib\" path=\"lib/remark.jar\"/> , which resolves to a path (workspace-relative) of /$project/lib/remark.jar here, and ultimately fails. I think getLocation() resolves the absolute path the way we want so I'll try that.", "author": "rgrunber", "createdAt": "2021-01-08T17:17:58Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/MavenSourceDownloader.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 Red Hat Inc. and others.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License 2.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-2.0\n+ *\n+ * SPDX-License-Identifier: EPL-2.0\n+ *\n+ * Contributors:\n+ *     Red Hat Inc. - initial API and implementation\n+ *******************************************************************************/\n+package org.eclipse.jdt.ls.core.internal.managers;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+import org.eclipse.core.resources.IFile;\n+import org.eclipse.core.resources.ResourcesPlugin;\n+import org.eclipse.core.runtime.CoreException;\n+import org.eclipse.core.runtime.IPath;\n+import org.eclipse.core.runtime.IProgressMonitor;\n+import org.eclipse.jdt.core.IClassFile;\n+import org.eclipse.jdt.core.IJavaElement;\n+import org.eclipse.jdt.core.IPackageFragmentRoot;\n+import org.eclipse.jdt.ls.core.internal.JobHelpers;\n+import org.eclipse.m2e.core.embedder.ArtifactKey;\n+import org.eclipse.m2e.jdt.IClasspathManager;\n+import org.eclipse.m2e.jdt.MavenJdtPlugin;\n+import org.eclipse.m2e.jdt.internal.BuildPathManager;\n+\n+import com.google.common.cache.Cache;\n+import com.google.common.cache.CacheBuilder;\n+\n+/**\n+ * {@link ISourceDownloader} implementation based on m2e's\n+ * {@link IClasspathManager}' source download facilities.\n+ *\n+ * @author Fred Bricon\n+ *\n+ */\n+public class MavenSourceDownloader implements ISourceDownloader {\n+\n+\tprivate static Cache<String, Boolean> downloadRequestsCache = CacheBuilder.newBuilder().maximumSize(100).expireAfterWrite(1, TimeUnit.HOURS).build();\n+\tprivate static final int MAX_TIME_MILLIS = 3000;\n+\n+\t@Override\n+\tpublic void discoverSource(IClassFile classFile, IProgressMonitor monitor) throws CoreException {\n+\t\tif (classFile == null) {\n+\t\t\treturn;\n+\t\t}\n+\t\tIJavaElement element = classFile;\n+\t\twhile (element.getParent() != null) {\n+\t\t\telement = element.getParent();\n+\t\t\tif (element instanceof IPackageFragmentRoot) {\n+\t\t\t\tfinal IPackageFragmentRoot fragment = (IPackageFragmentRoot) element;\n+\t\t\t\tIPath attachmentPath = fragment.getSourceAttachmentPath();\n+\t\t\t\tif (attachmentPath != null && !attachmentPath.isEmpty() && attachmentPath.toFile().exists()) {\n+\t\t\t\t\tbreak;\n+\t\t\t\t}\n+\t\t\t\tif (fragment.isArchive()) {\n+\t\t\t\t\tIFile file = ResourcesPlugin.getWorkspace().getRoot().getFile(fragment.getPath());\n+\t\t\t\t\tIPath path = file.getFullPath();", "originalCommit": "112110bac02b0601cd4ae4ce05baf7a0c28e8643", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDE4MDYxNQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1628#discussion_r554180615", "bodyText": "Resolved this.", "author": "rgrunber", "createdAt": "2021-01-08T20:41:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NDA4MTYzMw=="}], "type": "inlineReview"}, {"oid": "10aa622f589b692faccdea98389d34c042ee5a1e", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/10aa622f589b692faccdea98389d34c042ee5a1e", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\n- Create IMavenArtifactIdentifier to be implemented by\n  MavenPropertiesIdentifier and MavenCentralIdentifier\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>", "committedDate": "2021-01-08T20:34:11Z", "type": "commit"}, {"oid": "10aa622f589b692faccdea98389d34c042ee5a1e", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/10aa622f589b692faccdea98389d34c042ee5a1e", "message": "Download sources for the masses\n\n- Fixes redhat-developer/vscode-java#1664\n- Download maven-central artifact's sources on-demand\n\nSigned-off-by: Fred Bricon <fbricon@gmail.com>\n[rgrunber@redhat.com]: Fix testDynamicSourceLookups()\n- Move testcase from HoverHandlerTest to InvisibleProjectBuildSupportTest\n- Set up the external library after project import to mimic approach\n  in other invisible projects\n- Create IMavenArtifactIdentifier to be implemented by\n  MavenPropertiesIdentifier and MavenCentralIdentifier\nSigned-off-by: Roland Grunberg <rgrunber@redhat.com>", "committedDate": "2021-01-08T20:34:11Z", "type": "forcePushed"}]}