{"pr_number": 1445, "pr_title": "Support refactoring when renaming or moving files", "pr_createdAt": "2020-05-15T09:44:33Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2OTM2OQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426069369", "bodyText": "instead of using an intermediary IPath[] array, you can still manipulate the stream, filter the file paths, map to ICompilationUnits ...", "author": "fbricon", "createdAt": "2020-05-15T22:13:41Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -129,49 +149,129 @@ private static WorkspaceEdit computePackageRenameEdit(FileRenameEvent[] renameEv\n \t\tfor (FileRenameEvent event : renameEvents) {\n \t\t\tIPath oldLocation = ResourceUtils.filePathFromURI(event.oldUri);\n \t\t\tIPath newLocation = ResourceUtils.filePathFromURI(event.newUri);\n-\t\t\tfor (SourcePath sourcePath : sourcePaths) {\n-\t\t\t\tIPath sourceLocation = Path.fromOSString(sourcePath.path);\n-\t\t\t\tIPath sourceEntry = Path.fromOSString(sourcePath.classpathEntry);\n-\t\t\t\tif (sourceLocation.isPrefixOf(oldLocation)) {\n-\t\t\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tIJavaProject javaProject = ProjectUtils.getJavaProject(sourcePath.projectName);\n-\t\t\t\t\t\tif (javaProject == null) {\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tIPackageFragmentRoot packageRoot = javaProject.findPackageFragmentRoot(sourceEntry);\n-\t\t\t\t\t\tif (packageRoot == null) {\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tString oldPackageName = String.join(\".\", oldLocation.makeRelativeTo(sourceLocation).segments());\n-\t\t\t\t\t\tString newPackageName = String.join(\".\", newLocation.makeRelativeTo(sourceLocation).segments());\n-\t\t\t\t\t\tIPackageFragment oldPackageFragment = packageRoot.getPackageFragment(oldPackageName);\n-\t\t\t\t\t\tif (oldPackageFragment != null && !oldPackageFragment.isDefaultPackage() && oldPackageFragment.getResource() != null) {\n-\t\t\t\t\t\t\toldPackageFragment.getResource().refreshLocal(IResource.DEPTH_INFINITE, null);\n-\t\t\t\t\t\t\tif (oldPackageFragment.exists()) {\n-\t\t\t\t\t\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n-\t\t\t\t\t\t\t\t\tWorkspaceEdit edit = getRenameEdit(oldPackageFragment, newPackageName, pm);\n-\t\t\t\t\t\t\t\t\troot[0] = ChangeUtil.mergeChanges(root[0], edit, true);\n-\t\t\t\t\t\t\t\t}, oldPackageFragment.getSchedulingRule(), IResource.NONE, renameMonitor);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} catch (CoreException e) {\n-\t\t\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the package rename update\", e);\n-\t\t\t\t\t} finally {\n-\t\t\t\t\t\trenameMonitor.done();\n+\t\t\tIPackageFragment oldPackageFragment = resolvePackageFragment(oldLocation, sourcePaths);\n+\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n+\t\t\ttry {\n+\t\t\t\tif (oldPackageFragment != null && !oldPackageFragment.isDefaultPackage() && oldPackageFragment.getResource() != null) {\n+\t\t\t\t\tString oldPackageName = oldPackageFragment.getElementName();\n+\t\t\t\t\tint lastDot = oldPackageName.lastIndexOf(\".\");\n+\t\t\t\t\tString newPackageName = lastDot < 0 ? newLocation.lastSegment() :\n+\t\t\t\t\t\toldPackageName.subSequence(0, lastDot + 1) + newLocation.lastSegment();\n+\t\t\t\t\toldPackageFragment.getResource().refreshLocal(IResource.DEPTH_INFINITE, null);\n+\t\t\t\t\tif (oldPackageFragment.exists()) {\n+\t\t\t\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n+\t\t\t\t\t\t\tWorkspaceEdit edit = getRenameEdit(oldPackageFragment, newPackageName, pm);\n+\t\t\t\t\t\t\troot[0] = ChangeUtil.mergeChanges(root[0], edit, true);\n+\t\t\t\t\t\t}, oldPackageFragment.getSchedulingRule(), IResource.NONE, renameMonitor);\n \t\t\t\t\t}\n-\n-\t\t\t\t\tbreak;\n \t\t\t\t}\n+\t\t\t} catch (CoreException e) {\n+\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the package rename update\", e);\n+\t\t\t} finally {\n+\t\t\t\trenameMonitor.done();\n \t\t\t}\n \t\t}\n \n \t\tsubmonitor.done();\n \t\treturn ChangeUtil.hasChanges(root[0]) ? root[0] : null;\n \t}\n \n+\tprivate static WorkspaceEdit computeMoveEdit(FileRenameEvent[] moveEvents, SourcePath[] sourcePaths, IProgressMonitor monitor) {\n+\t\tIPath[] newPaths = Stream.of(moveEvents).map(event -> ResourceUtils.filePathFromURI(event.newUri)).toArray(IPath[]::new);\n+\t\tIPath destinationPath = getLongestCommonPath(newPaths);\n+\t\tif (destinationPath == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tIPackageFragment destinationPackage = resolvePackageFragment(destinationPath, sourcePaths);\n+\t\tif (destinationPackage == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tList<IJavaElement> javaElements = new ArrayList<>();\n+\t\tIPath[] oldPaths = Stream.of(moveEvents).map(event -> ResourceUtils.filePathFromURI(event.oldUri)).toArray(IPath[]::new);", "originalCommit": "723dca239e2e70fee87471b5a0442e7b9c81fc6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2Njk5Nw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426666997", "bodyText": "good suggestion.", "author": "testforstephen", "createdAt": "2020-05-18T14:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2OTM2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2OTUzOA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426069538", "bodyText": "is it possible for a cu to not be on its own project's classpath?", "author": "fbricon", "createdAt": "2020-05-15T22:14:15Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -129,49 +149,129 @@ private static WorkspaceEdit computePackageRenameEdit(FileRenameEvent[] renameEv\n \t\tfor (FileRenameEvent event : renameEvents) {\n \t\t\tIPath oldLocation = ResourceUtils.filePathFromURI(event.oldUri);\n \t\t\tIPath newLocation = ResourceUtils.filePathFromURI(event.newUri);\n-\t\t\tfor (SourcePath sourcePath : sourcePaths) {\n-\t\t\t\tIPath sourceLocation = Path.fromOSString(sourcePath.path);\n-\t\t\t\tIPath sourceEntry = Path.fromOSString(sourcePath.classpathEntry);\n-\t\t\t\tif (sourceLocation.isPrefixOf(oldLocation)) {\n-\t\t\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tIJavaProject javaProject = ProjectUtils.getJavaProject(sourcePath.projectName);\n-\t\t\t\t\t\tif (javaProject == null) {\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tIPackageFragmentRoot packageRoot = javaProject.findPackageFragmentRoot(sourceEntry);\n-\t\t\t\t\t\tif (packageRoot == null) {\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tString oldPackageName = String.join(\".\", oldLocation.makeRelativeTo(sourceLocation).segments());\n-\t\t\t\t\t\tString newPackageName = String.join(\".\", newLocation.makeRelativeTo(sourceLocation).segments());\n-\t\t\t\t\t\tIPackageFragment oldPackageFragment = packageRoot.getPackageFragment(oldPackageName);\n-\t\t\t\t\t\tif (oldPackageFragment != null && !oldPackageFragment.isDefaultPackage() && oldPackageFragment.getResource() != null) {\n-\t\t\t\t\t\t\toldPackageFragment.getResource().refreshLocal(IResource.DEPTH_INFINITE, null);\n-\t\t\t\t\t\t\tif (oldPackageFragment.exists()) {\n-\t\t\t\t\t\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n-\t\t\t\t\t\t\t\t\tWorkspaceEdit edit = getRenameEdit(oldPackageFragment, newPackageName, pm);\n-\t\t\t\t\t\t\t\t\troot[0] = ChangeUtil.mergeChanges(root[0], edit, true);\n-\t\t\t\t\t\t\t\t}, oldPackageFragment.getSchedulingRule(), IResource.NONE, renameMonitor);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} catch (CoreException e) {\n-\t\t\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the package rename update\", e);\n-\t\t\t\t\t} finally {\n-\t\t\t\t\t\trenameMonitor.done();\n+\t\t\tIPackageFragment oldPackageFragment = resolvePackageFragment(oldLocation, sourcePaths);\n+\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n+\t\t\ttry {\n+\t\t\t\tif (oldPackageFragment != null && !oldPackageFragment.isDefaultPackage() && oldPackageFragment.getResource() != null) {\n+\t\t\t\t\tString oldPackageName = oldPackageFragment.getElementName();\n+\t\t\t\t\tint lastDot = oldPackageName.lastIndexOf(\".\");\n+\t\t\t\t\tString newPackageName = lastDot < 0 ? newLocation.lastSegment() :\n+\t\t\t\t\t\toldPackageName.subSequence(0, lastDot + 1) + newLocation.lastSegment();\n+\t\t\t\t\toldPackageFragment.getResource().refreshLocal(IResource.DEPTH_INFINITE, null);\n+\t\t\t\t\tif (oldPackageFragment.exists()) {\n+\t\t\t\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n+\t\t\t\t\t\t\tWorkspaceEdit edit = getRenameEdit(oldPackageFragment, newPackageName, pm);\n+\t\t\t\t\t\t\troot[0] = ChangeUtil.mergeChanges(root[0], edit, true);\n+\t\t\t\t\t\t}, oldPackageFragment.getSchedulingRule(), IResource.NONE, renameMonitor);\n \t\t\t\t\t}\n-\n-\t\t\t\t\tbreak;\n \t\t\t\t}\n+\t\t\t} catch (CoreException e) {\n+\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the package rename update\", e);\n+\t\t\t} finally {\n+\t\t\t\trenameMonitor.done();\n \t\t\t}\n \t\t}\n \n \t\tsubmonitor.done();\n \t\treturn ChangeUtil.hasChanges(root[0]) ? root[0] : null;\n \t}\n \n+\tprivate static WorkspaceEdit computeMoveEdit(FileRenameEvent[] moveEvents, SourcePath[] sourcePaths, IProgressMonitor monitor) {\n+\t\tIPath[] newPaths = Stream.of(moveEvents).map(event -> ResourceUtils.filePathFromURI(event.newUri)).toArray(IPath[]::new);\n+\t\tIPath destinationPath = getLongestCommonPath(newPaths);\n+\t\tif (destinationPath == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tIPackageFragment destinationPackage = resolvePackageFragment(destinationPath, sourcePaths);\n+\t\tif (destinationPackage == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tList<IJavaElement> javaElements = new ArrayList<>();\n+\t\tIPath[] oldPaths = Stream.of(moveEvents).map(event -> ResourceUtils.filePathFromURI(event.oldUri)).toArray(IPath[]::new);\n+\t\tfor (int i = 0; i < oldPaths.length; i++) {\n+\t\t\tif (oldPaths[i].toFile().isFile()) {\n+\t\t\t\tICompilationUnit cu = JDTUtils.resolveCompilationUnit(moveEvents[i].oldUri);\n+\t\t\t\tif (cu != null && cu.getJavaProject() != null && cu.getJavaProject().isOnClasspath(cu)) {", "originalCommit": "723dca239e2e70fee87471b5a0442e7b9c81fc6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2OTY3MA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426669670", "bodyText": "yes, should support it. at least, should update the package declaration.\nCurrently it has some prerequisite to make it work. That is the non-classpath cu needs to be a workingcopy. So need extra step to become workingcopy first.", "author": "testforstephen", "createdAt": "2020-05-18T14:31:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2OTUzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2OTg1OA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426069858", "bodyText": "looks like something that belongs to a utility class, that could even deserve specific unit tests", "author": "fbricon", "createdAt": "2020-05-15T22:15:27Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -129,49 +149,129 @@ private static WorkspaceEdit computePackageRenameEdit(FileRenameEvent[] renameEv\n \t\tfor (FileRenameEvent event : renameEvents) {\n \t\t\tIPath oldLocation = ResourceUtils.filePathFromURI(event.oldUri);\n \t\t\tIPath newLocation = ResourceUtils.filePathFromURI(event.newUri);\n-\t\t\tfor (SourcePath sourcePath : sourcePaths) {\n-\t\t\t\tIPath sourceLocation = Path.fromOSString(sourcePath.path);\n-\t\t\t\tIPath sourceEntry = Path.fromOSString(sourcePath.classpathEntry);\n-\t\t\t\tif (sourceLocation.isPrefixOf(oldLocation)) {\n-\t\t\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n-\t\t\t\t\ttry {\n-\t\t\t\t\t\tIJavaProject javaProject = ProjectUtils.getJavaProject(sourcePath.projectName);\n-\t\t\t\t\t\tif (javaProject == null) {\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tIPackageFragmentRoot packageRoot = javaProject.findPackageFragmentRoot(sourceEntry);\n-\t\t\t\t\t\tif (packageRoot == null) {\n-\t\t\t\t\t\t\tbreak;\n-\t\t\t\t\t\t}\n-\n-\t\t\t\t\t\tString oldPackageName = String.join(\".\", oldLocation.makeRelativeTo(sourceLocation).segments());\n-\t\t\t\t\t\tString newPackageName = String.join(\".\", newLocation.makeRelativeTo(sourceLocation).segments());\n-\t\t\t\t\t\tIPackageFragment oldPackageFragment = packageRoot.getPackageFragment(oldPackageName);\n-\t\t\t\t\t\tif (oldPackageFragment != null && !oldPackageFragment.isDefaultPackage() && oldPackageFragment.getResource() != null) {\n-\t\t\t\t\t\t\toldPackageFragment.getResource().refreshLocal(IResource.DEPTH_INFINITE, null);\n-\t\t\t\t\t\t\tif (oldPackageFragment.exists()) {\n-\t\t\t\t\t\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n-\t\t\t\t\t\t\t\t\tWorkspaceEdit edit = getRenameEdit(oldPackageFragment, newPackageName, pm);\n-\t\t\t\t\t\t\t\t\troot[0] = ChangeUtil.mergeChanges(root[0], edit, true);\n-\t\t\t\t\t\t\t\t}, oldPackageFragment.getSchedulingRule(), IResource.NONE, renameMonitor);\n-\t\t\t\t\t\t\t}\n-\t\t\t\t\t\t}\n-\t\t\t\t\t} catch (CoreException e) {\n-\t\t\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the package rename update\", e);\n-\t\t\t\t\t} finally {\n-\t\t\t\t\t\trenameMonitor.done();\n+\t\t\tIPackageFragment oldPackageFragment = resolvePackageFragment(oldLocation, sourcePaths);\n+\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n+\t\t\ttry {\n+\t\t\t\tif (oldPackageFragment != null && !oldPackageFragment.isDefaultPackage() && oldPackageFragment.getResource() != null) {\n+\t\t\t\t\tString oldPackageName = oldPackageFragment.getElementName();\n+\t\t\t\t\tint lastDot = oldPackageName.lastIndexOf(\".\");\n+\t\t\t\t\tString newPackageName = lastDot < 0 ? newLocation.lastSegment() :\n+\t\t\t\t\t\toldPackageName.subSequence(0, lastDot + 1) + newLocation.lastSegment();\n+\t\t\t\t\toldPackageFragment.getResource().refreshLocal(IResource.DEPTH_INFINITE, null);\n+\t\t\t\t\tif (oldPackageFragment.exists()) {\n+\t\t\t\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n+\t\t\t\t\t\t\tWorkspaceEdit edit = getRenameEdit(oldPackageFragment, newPackageName, pm);\n+\t\t\t\t\t\t\troot[0] = ChangeUtil.mergeChanges(root[0], edit, true);\n+\t\t\t\t\t\t}, oldPackageFragment.getSchedulingRule(), IResource.NONE, renameMonitor);\n \t\t\t\t\t}\n-\n-\t\t\t\t\tbreak;\n \t\t\t\t}\n+\t\t\t} catch (CoreException e) {\n+\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the package rename update\", e);\n+\t\t\t} finally {\n+\t\t\t\trenameMonitor.done();\n \t\t\t}\n \t\t}\n \n \t\tsubmonitor.done();\n \t\treturn ChangeUtil.hasChanges(root[0]) ? root[0] : null;\n \t}\n \n+\tprivate static WorkspaceEdit computeMoveEdit(FileRenameEvent[] moveEvents, SourcePath[] sourcePaths, IProgressMonitor monitor) {\n+\t\tIPath[] newPaths = Stream.of(moveEvents).map(event -> ResourceUtils.filePathFromURI(event.newUri)).toArray(IPath[]::new);\n+\t\tIPath destinationPath = getLongestCommonPath(newPaths);\n+\t\tif (destinationPath == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tIPackageFragment destinationPackage = resolvePackageFragment(destinationPath, sourcePaths);\n+\t\tif (destinationPackage == null) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tList<IJavaElement> javaElements = new ArrayList<>();\n+\t\tIPath[] oldPaths = Stream.of(moveEvents).map(event -> ResourceUtils.filePathFromURI(event.oldUri)).toArray(IPath[]::new);\n+\t\tfor (int i = 0; i < oldPaths.length; i++) {\n+\t\t\tif (oldPaths[i].toFile().isFile()) {\n+\t\t\t\tICompilationUnit cu = JDTUtils.resolveCompilationUnit(moveEvents[i].oldUri);\n+\t\t\t\tif (cu != null && cu.getJavaProject() != null && cu.getJavaProject().isOnClasspath(cu)) {\n+\t\t\t\t\tjavaElements.add(cu);\n+\t\t\t\t}\n+\t\t\t}\n+\t\t}\n+\n+\t\tif (javaElements.isEmpty()) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tIReorgDestination packageDestination = ReorgDestinationFactory.createDestination(destinationPackage);\n+\t\tWorkspaceEdit[] root = new WorkspaceEdit[1];\n+\t\ttry {\n+\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n+\t\t\t\troot[0] = MoveHandler.move(new IResource[0], javaElements.toArray(new IJavaElement[0]), packageDestination, true, pm);\n+\t\t\t}, monitor);\n+\t\t} catch (CoreException e) {\n+\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the move update\", e);\n+\t\t}\n+\n+\t\treturn ChangeUtil.hasChanges(root[0]) ? root[0] : null;\n+\t}\n+\n+\tprivate static IPath getLongestCommonPath(IPath[] paths) {", "originalCommit": "723dca239e2e70fee87471b5a0442e7b9c81fc6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY3MDA2OA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426670068", "bodyText": "done. Moved to ResourceUtils, and added unit test.", "author": "testforstephen", "createdAt": "2020-05-18T14:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2OTg1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3MzM3Ng==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426073376", "bodyText": "can be moved inside the if block", "author": "fbricon", "createdAt": "2020-05-15T22:28:10Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -215,10 +332,11 @@ private static ICompilationUnit createCompilationUnit(ICompilationUnit unit) {\n \t\t\tunit.getResource().refreshLocal(IResource.DEPTH_ONE, new NullProgressMonitor());\n \t\t\tif (unit.getResource().exists()) {\n \t\t\t\tIJavaElement parent = unit.getParent();\n-\t\t\t\tif (parent instanceof IPackageFragment) {\n-\t\t\t\t\tIPackageFragment pkg = (IPackageFragment) parent;\n+\t\t\t\tif (parent instanceof PackageFragment) {\n+\t\t\t\t\tPackageFragment pkg = (PackageFragment) parent;", "originalCommit": "723dca239e2e70fee87471b5a0442e7b9c81fc6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3MzQ5Mw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426073493", "bodyText": "can be merged with the enclosing if", "author": "fbricon", "createdAt": "2020-05-15T22:28:42Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -215,10 +332,11 @@ private static ICompilationUnit createCompilationUnit(ICompilationUnit unit) {\n \t\t\tunit.getResource().refreshLocal(IResource.DEPTH_ONE, new NullProgressMonitor());\n \t\t\tif (unit.getResource().exists()) {\n \t\t\t\tIJavaElement parent = unit.getParent();\n-\t\t\t\tif (parent instanceof IPackageFragment) {\n-\t\t\t\t\tIPackageFragment pkg = (IPackageFragment) parent;\n+\t\t\t\tif (parent instanceof PackageFragment) {\n+\t\t\t\t\tPackageFragment pkg = (PackageFragment) parent;\n \t\t\t\t\tif (JavaModelManager.determineIfOnClasspath(unit.getResource(), unit.getJavaProject()) != null) {", "originalCommit": "723dca239e2e70fee87471b5a0442e7b9c81fc6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3NDU1OQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426074559", "bodyText": "why would this change?", "author": "fbricon", "createdAt": "2020-05-15T22:32:46Z", "path": "org.eclipse.jdt.ls.tests/src/org/eclipse/jdt/ls/core/internal/handlers/MoveHandlerTest.java", "diffHunk": "@@ -163,7 +163,7 @@ public void testMoveFile() throws JavaModelException, BadLocationException {\n \t\tassertNotNull(refactorEdit);\r\n \t\tassertNotNull(refactorEdit.edit);\r\n \t\tList<Either<TextDocumentEdit, ResourceOperation>> changes = refactorEdit.edit.getDocumentChanges();\r\n-\t\tassertEquals(4, changes.size());\r\n+\t\tassertEquals(3, changes.size());\r", "originalCommit": "723dca239e2e70fee87471b5a0442e7b9c81fc6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjEzMDY4Mg==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r426130682", "bodyText": "The move refactoring code generates some empty textEdit operation, for example, insert empty string at the same location. I refined the ChangeUtils utility to filter out such empty operations. That's why you see the changes list is shorter.", "author": "testforstephen", "createdAt": "2020-05-16T08:03:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA3NDU1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIzNDM2NQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r448234365", "bodyText": "I think we should remove this   Objects.equals(oldPath.removeLastSegments(1), newPath.removeLastSegments(1).\nIf i want to  rename package  jdt.pkg1 to  com.pkg1,  then   because \"Objects.equals(oldPath.removeLastSegments(1), newPath.removeLastSegments(1)\" ,   isFolderRenameEvent will return false.", "author": "kuafuwang", "createdAt": "2020-07-01T09:23:26Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -200,6 +300,23 @@ private static boolean isFolderRenameEvent(FileRenameEvent event) {\n \t\treturn (oldPath.toFile().isDirectory() || newPath.toFile().isDirectory()) && Objects.equals(oldPath.removeLastSegments(1), newPath.removeLastSegments(1));", "originalCommit": "723dca239e2e70fee87471b5a0442e7b9c81fc6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODI1NzUwOQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r508257509", "bodyText": "When you are renaming package jdt.pkg1 to com.pkg1, it's equivalent to rename package jdt to com from the LSP perspective. The file uri won't contain the sub package in the path when you rename a parent package.", "author": "testforstephen", "createdAt": "2020-10-20T07:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIzNDM2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MTY0MDAzMw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r581640033", "bodyText": "Take a look at the use case to rename package from 'jdt.pkg1' to 'com.pkg1', it's a sensible use case. The latest commit has fixed this case.", "author": "testforstephen", "createdAt": "2021-02-24T05:39:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODIzNDM2NQ=="}], "type": "inlineReview"}, {"oid": "faa7b9db644fb45d0d58bc43fefd077ebd6ddd57", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/faa7b9db644fb45d0d58bc43fefd077ebd6ddd57", "message": "Support move files\n\nSigned-off-by: Jinbo Wang <jinbwan@microsoft.com>", "committedDate": "2020-10-19T09:25:16Z", "type": "forcePushed"}, {"oid": "6a42fb3ad0c88d39088c5e5517b13483e7b4813f", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/6a42fb3ad0c88d39088c5e5517b13483e7b4813f", "message": "Support refactoring when renaming or moving files\n\nSigned-off-by: Jinbo Wang <jinbwan@microsoft.com>", "committedDate": "2021-02-24T04:23:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NDU2NTExMQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r584565111", "bodyText": "Since we are resolving the old uri now, will this if block be hit?", "author": "jdneo", "createdAt": "2021-03-01T09:37:16Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -52,22 +59,64 @@\n \n public class FileEventHandler {\n \n-\tpublic static WorkspaceEdit handleRenameFiles(FileRenameParams params, IProgressMonitor monitor) {\n+\tpublic static WorkspaceEdit handleWillRenameFiles(FileRenameParams params, IProgressMonitor monitor) {\n \t\tif (params.files == null || params.files.isEmpty()) {\n \t\t\treturn null;\n \t\t}\n \n-\t\tFileRenameEvent[] files = params.files.stream().filter(event -> isFileNameRenameEvent(event)).toArray(FileRenameEvent[]::new);\n-\t\tif (files.length == 0) {\n+\t\tFileRenameEvent[] renameFiles = new FileRenameEvent[0];\n+\t\tFileRenameEvent[] renameFolders = new FileRenameEvent[0];\n+\t\tFileRenameEvent[] moveFiles = new FileRenameEvent[0];\n+\t\tif (params.files.size() == 1) {\n+\t\t\tFileRenameEvent renameEvent = params.files.get(0);\n+\t\t\tif (isFileNameRenameEvent(renameEvent)) {\n+\t\t\t\trenameFiles = new FileRenameEvent[] { renameEvent };\n+\t\t\t} else if (isFolderRenameEvent(renameEvent)) {\n+\t\t\t\trenameFolders = new FileRenameEvent[] { renameEvent };\n+\t\t\t} else if (isMoveEvent(renameEvent)) {\n+\t\t\t\tmoveFiles = new FileRenameEvent[] { renameEvent };\n+\t\t\t}\n+\t\t} else {\n+\t\t\tmoveFiles = params.files.stream().filter(event -> isMoveEvent(event)).toArray(FileRenameEvent[]::new);\n+\t\t}\n+\n+\t\tif (renameFiles.length == 0 && renameFolders.length == 0 && moveFiles.length == 0) {\n+\t\t\treturn null;\n+\t\t}\n+\n+\t\tSourcePath[] sourcePaths = getSourcePaths();\n+\t\tif (sourcePaths == null || sourcePaths.length == 0) {\n \t\t\treturn null;\n \t\t}\n \n-\t\tSubMonitor submonitor = SubMonitor.convert(monitor, \"Computing rename updates...\", 100 * files.length);\n \t\tWorkspaceEdit root = null;\n-\t\tfor (FileRenameEvent event : files) {\n+\t\tSubMonitor submonitor = SubMonitor.convert(monitor, \"Computing rename updates...\", renameFiles.length + renameFolders.length + moveFiles.length);\n+\t\tif (renameFiles.length > 0) {\n+\t\t\tWorkspaceEdit edit = computeFileRenameEdit(renameFiles, submonitor.split(renameFiles.length));\n+\t\t\troot = ChangeUtil.mergeChanges(root, edit, true);\n+\t\t}\n+\n+\t\tif (renameFolders.length > 0) {\n+\t\t\tWorkspaceEdit edit = computePackageRenameEdit(renameFolders, sourcePaths, submonitor.split(renameFolders.length));\n+\t\t\troot = ChangeUtil.mergeChanges(root, edit, true);\n+\t\t}\n+\n+\t\tif (moveFiles.length > 0) {\n+\t\t\tWorkspaceEdit edit = computeMoveEdit(moveFiles, sourcePaths, submonitor.split(moveFiles.length));\n+\t\t\troot = ChangeUtil.mergeChanges(root, edit, true);\n+\t\t}\n+\n+\t\tsubmonitor.done();\n+\t\treturn ChangeUtil.hasChanges(root) ? root : null;\n+\t}\n+\n+\tprivate static WorkspaceEdit computeFileRenameEdit(FileRenameEvent[] renameEvents, IProgressMonitor monitor) {\n+\t\tSubMonitor submonitor = SubMonitor.convert(monitor, \"Computing file rename updates...\", 100 * renameEvents.length);\n+\t\tWorkspaceEdit root = null;\n+\t\tfor (FileRenameEvent event : renameEvents) {\n \t\t\tString oldUri = event.oldUri;\n \t\t\tString newUri = event.newUri;\n-\t\t\tICompilationUnit unit = JDTUtils.resolveCompilationUnit(newUri);\n+\t\t\tICompilationUnit unit = JDTUtils.resolveCompilationUnit(oldUri);\n \t\t\tSubMonitor splitedMonitor = submonitor.split(100);\n \t\t\ttry {\n \t\t\t\tif (unit != null && !unit.exists()) {", "originalCommit": "6a42fb3ad0c88d39088c5e5517b13483e7b4813f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTI0MDk2MQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1445#discussion_r585240961", "bodyText": "pass the monitor as the param?", "author": "jdneo", "createdAt": "2021-03-02T04:23:18Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/handlers/FileEventHandler.java", "diffHunk": "@@ -105,73 +154,148 @@ public void run(IProgressMonitor monitor) throws CoreException {\n \t\treturn root;\n \t}\n \n-\tpublic static WorkspaceEdit handleWillRenameFiles(FileRenameParams params, IProgressMonitor monitor) {\n-\t\tif (params.files == null || params.files.isEmpty()) {\n-\t\t\treturn null;\n+\tprivate static WorkspaceEdit computePackageRenameEdit(FileRenameEvent[] renameEvents, SourcePath[] sourcePaths, IProgressMonitor monitor) {\n+\t\tWorkspaceEdit[] root = new WorkspaceEdit[1];\n+\t\tSubMonitor submonitor = SubMonitor.convert(monitor, \"Computing package rename updates...\", 100 * renameEvents.length);\n+\t\tfor (FileRenameEvent event : renameEvents) {\n+\t\t\tIPath oldLocation = ResourceUtils.filePathFromURI(event.oldUri);\n+\t\t\tIPath newLocation = ResourceUtils.filePathFromURI(event.newUri);\n+\t\t\tIPackageFragment oldPackageFragment = resolvePackageFragment(oldLocation, sourcePaths);\n+\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n+\t\t\ttry {\n+\t\t\t\tif (oldPackageFragment != null && !oldPackageFragment.isDefaultPackage() && oldPackageFragment.getResource() != null) {\n+\t\t\t\t\tString newPackageName = resolvePackageName(newLocation, sourcePaths);\n+\t\t\t\t\tif (newPackageName == null) {\n+\t\t\t\t\t\tcontinue;\n+\t\t\t\t\t}\n+\n+\t\t\t\t\toldPackageFragment.getResource().refreshLocal(IResource.DEPTH_INFINITE, null);\n+\t\t\t\t\tif (oldPackageFragment.exists()) {\n+\t\t\t\t\t\tResourcesPlugin.getWorkspace().run((pm) -> {\n+\t\t\t\t\t\t\tWorkspaceEdit edit = getRenameEdit(oldPackageFragment, newPackageName, pm);\n+\t\t\t\t\t\t\troot[0] = ChangeUtil.mergeChanges(root[0], edit, true);\n+\t\t\t\t\t\t}, oldPackageFragment.getSchedulingRule(), IResource.NONE, renameMonitor);\n+\t\t\t\t\t}\n+\t\t\t\t}\n+\t\t\t} catch (CoreException e) {\n+\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to compute the package rename update\", e);\n+\t\t\t} finally {\n+\t\t\t\trenameMonitor.done();\n+\t\t\t}\n \t\t}\n \n-\t\tFileRenameEvent[] renamefolders = params.files.stream().filter(event -> isFolderRenameEvent(event)).toArray(FileRenameEvent[]::new);\n-\t\tif (renamefolders.length == 0) {\n+\t\tsubmonitor.done();\n+\t\treturn ChangeUtil.hasChanges(root[0]) ? root[0] : null;\n+\t}\n+\n+\tprivate static WorkspaceEdit computeMoveEdit(FileRenameEvent[] moveEvents, SourcePath[] sourcePaths, IProgressMonitor monitor) {\n+\t\tIPath[] newPaths = Stream.of(moveEvents).map(event -> ResourceUtils.filePathFromURI(event.newUri)).toArray(IPath[]::new);\n+\t\tIPath destinationPath = ResourceUtils.getLongestCommonPath(newPaths);\n+\t\tif (destinationPath == null) {\n \t\t\treturn null;\n \t\t}\n \n-\t\tSourcePath[] sourcePaths = getSourcePaths();\n-\t\tif (sourcePaths == null || sourcePaths.length == 0) {\n+\t\t// Verify all files are moving to the same destination.\n+\t\tfor (FileRenameEvent event : moveEvents) {\n+\t\t\tIPath oldPath = ResourceUtils.filePathFromURI(event.oldUri);\n+\t\t\tIPath expectedNewPath = destinationPath.append(oldPath.lastSegment());\n+\t\t\tIPath actualNewPath = ResourceUtils.filePathFromURI(event.newUri);\n+\t\t\tif (!Objects.equals(expectedNewPath, actualNewPath)) {\n+\t\t\t\tJavaLanguageServerPlugin.logError(\"Failed to compute move refactoring because the files are not moving to the same destination \" + destinationPath.toOSString());\n+\t\t\t\treturn null;\n+\t\t\t}\n+\t\t}\n+\n+\t\tIPackageFragment destinationPackage = resolvePackageFragment(destinationPath, sourcePaths);\n+\t\tif (destinationPackage == null) {\n \t\t\treturn null;\n \t\t}\n \n-\t\treturn computePackageRenameEdit(renamefolders, sourcePaths, monitor);\n-\t}\n+\t\t// formatter:off\n+\t\tICompilationUnit[] cus = Stream.of(moveEvents)\n+\t\t\t.filter(event -> {\n+\t\t\t\tIPath oldPath = ResourceUtils.filePathFromURI(event.oldUri);\n+\t\t\t\treturn oldPath != null && oldPath.toFile().isFile();\n+\t\t\t}).map(event -> JDTUtils.resolveCompilationUnit(event.oldUri))\n+\t\t\t.filter(cu -> cu != null && cu.getJavaProject() != null)\n+\t\t\t.toArray(ICompilationUnit[]::new);\n+\t\t// formatter:on\n+\t\tList<ICompilationUnit> nonClasspathCus = new ArrayList<>();\n+\t\tfor (ICompilationUnit unit : cus) {\n+\t\t\tif (!unit.getJavaProject().isOnClasspath(unit)) {\n+\t\t\t\tnonClasspathCus.add(unit);\n+\t\t\t}\n+\t\t}\n \n-\tprivate static WorkspaceEdit computePackageRenameEdit(FileRenameEvent[] renameEvents, SourcePath[] sourcePaths, IProgressMonitor monitor) {\n \t\tWorkspaceEdit[] root = new WorkspaceEdit[1];\n-\t\tSubMonitor submonitor = SubMonitor.convert(monitor, \"Computing package rename updates...\", 100 * renameEvents.length);\n-\t\tfor (FileRenameEvent event : renameEvents) {\n-\t\t\tIPath oldLocation = ResourceUtils.filePathFromURI(event.oldUri);\n-\t\t\tIPath newLocation = ResourceUtils.filePathFromURI(event.newUri);\n-\t\t\tfor (SourcePath sourcePath : sourcePaths) {\n-\t\t\t\tIPath sourceLocation = Path.fromOSString(sourcePath.path);\n-\t\t\t\tIPath sourceEntry = Path.fromOSString(sourcePath.classpathEntry);\n-\t\t\t\tif (sourceLocation.isPrefixOf(oldLocation)) {\n-\t\t\t\t\tSubMonitor renameMonitor = submonitor.split(100);\n+\t\tif (cus.length > 0) {\n+\t\t\ttry {\n+\t\t\t\t// For the cu that's not on the project's classpath, need to become workingcopy first,\n+\t\t\t\t// otherwise invoking cu.getBuffer() will throw exception.\n+\t\t\t\tfor (ICompilationUnit cu : nonClasspathCus) {\n+\t\t\t\t\tcu.becomeWorkingCopy(null);", "originalCommit": "6a42fb3ad0c88d39088c5e5517b13483e7b4813f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e8c692fd7dfd00fc603b4c8e7bee4430fb82504", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/3e8c692fd7dfd00fc603b4c8e7bee4430fb82504", "message": "Remove the unnecessary createCompilationUnit logic\n\nSigned-off-by: Jinbo Wang <jinbwan@microsoft.com>", "committedDate": "2021-03-02T07:42:17Z", "type": "forcePushed"}, {"oid": "53720c6af030f9589504f42e4f9a53c39a574607", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/53720c6af030f9589504f42e4f9a53c39a574607", "message": "Support refactoring when renaming or moving files\n\nSigned-off-by: Jinbo Wang <jinbwan@microsoft.com>", "committedDate": "2021-03-22T01:43:49Z", "type": "commit"}, {"oid": "be0fd0aace10306bc8b07d87d4491b77241c86b8", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/be0fd0aace10306bc8b07d87d4491b77241c86b8", "message": "Adopt lsp4j interfaces to handle willRenameFiles event\n\nSigned-off-by: Jinbo Wang <jinbwan@microsoft.com>", "committedDate": "2021-03-22T04:17:03Z", "type": "commit"}, {"oid": "be0fd0aace10306bc8b07d87d4491b77241c86b8", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/be0fd0aace10306bc8b07d87d4491b77241c86b8", "message": "Adopt lsp4j interfaces to handle willRenameFiles event\n\nSigned-off-by: Jinbo Wang <jinbwan@microsoft.com>", "committedDate": "2021-03-22T04:17:03Z", "type": "forcePushed"}]}