{"pr_number": 1617, "pr_title": "Gradle Project hasn't been updated properly", "pr_createdAt": "2020-11-26T21:10:42Z", "pr_url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0MzQ3MA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r532443470", "bodyText": "When vmInstall or gradle home changed, the force flag will be true. Is it necessary to update all projects?", "author": "testforstephen", "createdAt": "2020-11-30T09:12:09Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleBuildSupport.java", "diffHunk": "@@ -79,7 +79,11 @@ public void update(IProject project, boolean force, IProgressMonitor monitor) th\n \t\t\t\tBuildConfiguration buildConfiguration = GradleProjectImporter.getBuildConfiguration(Paths.get(projectPath));\n \t\t\t\tgradleBuild = GradleCore.getWorkspace().createBuild(buildConfiguration);\n \t\t\t}\n-\t\t\tif (isRoot) {\n+\t\t\tFile buildFile = project.getFile(GradleProjectImporter.BUILD_GRADLE_DESCRIPTOR).getLocation().toFile();\n+\t\t\tFile settingsFile = project.getFile(GradleProjectImporter.SETTINGS_GRADLE_DESCRIPTOR).getLocation().toFile();\n+\t\t\tboolean shouldUpdate = (buildFile.exists() && JavaLanguageServerPlugin.getDigestStore().updateDigest(buildFile.toPath()))\n+\t\t\t\t\t|| (settingsFile.exists() && JavaLanguageServerPlugin.getDigestStore().updateDigest(settingsFile.toPath()));\n+\t\t\tif (force || isRoot || shouldUpdate) {", "originalCommit": "227e1e36bbe8ad648da8bbc228323436d1475e42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjc5ODY3Mw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r532798673", "bodyText": "Yes, it is. See https://github.com/eclipse/eclipse.jdt.ls/blob/master/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/MavenBuildSupport.java#L89", "author": "snjeza", "createdAt": "2020-11-30T18:10:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0MzQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA3NzAwOA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r533077008", "bodyText": "I'm not worried about this commit can fix the outdated dependencies issue. But this fix looks like in conflict with your previous PR #1467.\nWhen i tried this commit in springboot, and changed the user setting \"java.import.gradle.java.home\", i see lots of synchronization jobs are triggered.", "author": "testforstephen", "createdAt": "2020-12-01T05:11:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0MzQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzUzNjczNw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r533536737", "bodyText": "When i tried this commit in springboot, and changed the user setting \"java.import.gradle.java.home\", i see lots of synchronization jobs are triggered.\n\nThey have to be synchronized.", "author": "snjeza", "createdAt": "2020-12-01T16:12:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0MzQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyOTczMA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r533829730", "bodyText": "Could you please explain the reason? I assume when you're synchronizing the gradle root project, all projects under it will be updated and no need to synchronize each subproject again. Please correct me if it's not right.", "author": "testforstephen", "createdAt": "2020-12-02T01:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0MzQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzg2NDQ2OA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r533864468", "bodyText": "You are right. I have updated the PR.", "author": "snjeza", "createdAt": "2020-12-02T03:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQ0MzQ3MA=="}], "type": "inlineReview"}, {"oid": "2ba43a60b1291b7044cd84c8ff98b6038365f27f", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/2ba43a60b1291b7044cd84c8ff98b6038365f27f", "message": "Gradle Project hasn't been updated properly\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-11-30T18:06:29Z", "type": "forcePushed"}, {"oid": "32814bb39eebb51541d0fa00cc73eb344c2830eb", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/32814bb39eebb51541d0fa00cc73eb344c2830eb", "message": "Gradle Project hasn't been updated properly\n\n- https://github.com/redhat-developer/vscode-java/issues/1714\n- https://github.com/redhat-developer/vscode-java/issues/1463\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-12-01T16:07:50Z", "type": "forcePushed"}, {"oid": "71f3fcc66fac7d8d240edf1cc1f1a57a6df53287", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/71f3fcc66fac7d8d240edf1cc1f1a57a6df53287", "message": "Gradle Project hasn't been updated properly\n\n- https://github.com/redhat-developer/vscode-java/issues/1714\n- https://github.com/redhat-developer/vscode-java/issues/1463\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-12-02T03:01:00Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDAzNDk1Nw==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r544034957", "bodyText": "this.fileNames = fileNames == null ? new ArrayList<>() : Arrays.asList(fileNames);", "author": "testforstephen", "createdAt": "2020-12-16T06:42:46Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/BasicFileDetector.java", "diffHunk": "@@ -55,21 +55,30 @@\n \tprivate static final Set<FileVisitOption> FOLLOW_LINKS_OPTION = EnumSet.of(FileVisitOption.FOLLOW_LINKS);\n \tprivate List<Path> directories;\n \tprivate Path rootDir;\n-\tprivate String fileName;\n+\tprivate List<String> fileNames;\n \tprivate int maxDepth = 5;\n \tprivate boolean includeNested = true;\n \tprivate Set<String> exclusions = new LinkedHashSet<>(1);\n \n \t/**\n-\t * Constructs a new BasicFileDetector for the given root directory, searching for a fileName.\n-\t * By default, the search depth is limited to 5. Sub-directories of a found directory will be walked through.\n-\t * The \".metadata\" folder is excluded.\n-\t * @param rootDir the root directory to search for files\n-\t * @param fileName the name of the file to search\n+\t * Constructs a new BasicFileDetector for the given root directory, searching\n+\t * for fileNames. By default, the search depth is limited to 5. Sub-directories\n+\t * of a found directory will be walked through. The \".metadata\" folder is\n+\t * excluded.\n+\t *\n+\t * @param rootDir\n+\t *            the root directory to search for files\n+\t * @param fileNames\n+\t *            the names of the file to search\n \t */\n-\tpublic BasicFileDetector(Path rootDir, String fileName) {\n+\tpublic BasicFileDetector(Path rootDir, String... fileNames) {\n \t\tthis.rootDir = rootDir;\n-\t\tthis.fileName = fileName;\n+\t\tthis.fileNames = new ArrayList<>();\n+\t\tif (fileNames != null) {\n+\t\t\tfor (String fileName : fileNames) {\n+\t\t\t\tthis.fileNames.add(fileName);\n+\t\t\t}\n+\t\t}", "originalCommit": "71f3fcc66fac7d8d240edf1cc1f1a57a6df53287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4Mzc2OA==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r544483768", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2020-12-16T17:25:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDAzNDk1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA5MjkwNQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r544092905", "bodyText": "For gradle projects, it currently only updates the digest in this place (GradleBuildSupport#update).  It's supposed to store the digest as well when GradleProjectImporter finishes importing the gradle project into the workspace for the first time.\nSee the code snippet.\nhttps://github.com/eclipse/eclipse.jdt.ls/blob/master/org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleProjectImporter.java#L122\n\tpublic void importToWorkspace(IProgressMonitor monitor) throws CoreException {\n\t\tif (!applies(monitor)) {\n\t\t\treturn;\n\t\t}\n\t\tint projectSize = directories.size();\n\t\tSubMonitor subMonitor = SubMonitor.convert(monitor, projectSize + 1);\n\t\tsubMonitor.setTaskName(IMPORTING_GRADLE_PROJECTS);\n\t\tJavaLanguageServerPlugin.logInfo(IMPORTING_GRADLE_PROJECTS);\n\t\tsubMonitor.worked(1);\n\t\tdirectories.forEach(d -> importDir(d, subMonitor.newChild(1)));\n\n\t\t// ===>Insert the logic to store the digest for the imported gradle projects.\n\t\tProjectUtils.getGradleProjects().forEach(project -> {\n\t\t\tFile buildFile = project.getFile(BUILD_GRADLE_DESCRIPTOR).getLocation().toFile();\n\t\t\tFile settingsFile = project.getFile(SETTINGS_GRADLE_DESCRIPTOR).getLocation().toFile();\n\t\t\ttry {\n\t\t\t\tif (buildFile.exists()) {\n\t\t\t\t\tJavaLanguageServerPlugin.getDigestStore().updateDigest(buildFile.toPath());\n\t\t\t\t}\n\t\t\t\tif (settingsFile.exists()) {\n\t\t\t\t\tJavaLanguageServerPlugin.getDigestStore().updateDigest(settingsFile.toPath());\n\t\t\t\t}\n\t\t\t} catch (CoreException e) {\n\t\t\t\tJavaLanguageServerPlugin.logException(\"Failed to update digest for gradle build file\", e);\n\t\t\t}\n\t\t});\n\n\t\tsubMonitor.done();\n\t}", "author": "testforstephen", "createdAt": "2020-12-16T08:11:25Z", "path": "org.eclipse.jdt.ls.core/src/org/eclipse/jdt/ls/core/internal/managers/GradleBuildSupport.java", "diffHunk": "@@ -79,7 +79,11 @@ public void update(IProject project, boolean force, IProgressMonitor monitor) th\n \t\t\t\tBuildConfiguration buildConfiguration = GradleProjectImporter.getBuildConfiguration(Paths.get(projectPath));\n \t\t\t\tgradleBuild = GradleCore.getWorkspace().createBuild(buildConfiguration);\n \t\t\t}\n-\t\t\tif (isRoot) {\n+\t\t\tFile buildFile = project.getFile(GradleProjectImporter.BUILD_GRADLE_DESCRIPTOR).getLocation().toFile();\n+\t\t\tFile settingsFile = project.getFile(GradleProjectImporter.SETTINGS_GRADLE_DESCRIPTOR).getLocation().toFile();\n+\t\t\tboolean shouldUpdate = (buildFile.exists() && JavaLanguageServerPlugin.getDigestStore().updateDigest(buildFile.toPath()))\n+\t\t\t\t\t|| (settingsFile.exists() && JavaLanguageServerPlugin.getDigestStore().updateDigest(settingsFile.toPath()));\n+\t\t\tif (isRoot || shouldUpdate) {", "originalCommit": "71f3fcc66fac7d8d240edf1cc1f1a57a6df53287", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ4NDA3NQ==", "url": "https://github.com/eclipse/eclipse.jdt.ls/pull/1617#discussion_r544484075", "bodyText": "Fixed.", "author": "snjeza", "createdAt": "2020-12-16T17:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDA5MjkwNQ=="}], "type": "inlineReview"}, {"oid": "1c77a2c42e0afae37b7c9210d123428189c27237", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/1c77a2c42e0afae37b7c9210d123428189c27237", "message": "Gradle Project hasn't been updated properly\n\n- https://github.com/redhat-developer/vscode-java/issues/1714\n- https://github.com/redhat-developer/vscode-java/issues/1463\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-12-16T17:24:13Z", "type": "commit"}, {"oid": "1c77a2c42e0afae37b7c9210d123428189c27237", "url": "https://github.com/eclipse/eclipse.jdt.ls/commit/1c77a2c42e0afae37b7c9210d123428189c27237", "message": "Gradle Project hasn't been updated properly\n\n- https://github.com/redhat-developer/vscode-java/issues/1714\n- https://github.com/redhat-developer/vscode-java/issues/1463\n\nSigned-off-by: Snjezana Peco <snjezana.peco@redhat.com>", "committedDate": "2020-12-16T17:24:13Z", "type": "forcePushed"}]}