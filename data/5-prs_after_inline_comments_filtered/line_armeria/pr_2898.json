{"pr_number": 2898, "pr_title": "Decorate all services with MetricCollectingService when integrates with Spring Boot", "pr_createdAt": "2020-07-15T02:58:46Z", "pr_url": "https://github.com/line/armeria/pull/2898", "timeline": [{"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "url": "https://github.com/line/armeria/commit/6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "message": "Attach missing MetricCollectingService decorator globally if ArmeriaSettings.enableMetrics is true", "committedDate": "2020-07-15T03:33:20Z", "type": "commit"}, {"oid": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "url": "https://github.com/line/armeria/commit/6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "message": "Attach missing MetricCollectingService decorator globally if ArmeriaSettings.enableMetrics is true", "committedDate": "2020-07-15T03:33:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw==", "url": "https://github.com/line/armeria/pull/2898#discussion_r454799747", "bodyText": "You don't need to set service tag. :-)\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/metric/MeterIdPrefixFunction.java\n    \n    \n        Lines 108 to 111\n      in\n      7f3295f\n    \n    \n    \n    \n\n        \n          \n           final String serviceName = log.serviceName(); \n        \n\n        \n          \n           if (serviceName != null) { \n        \n\n        \n          \n               tagListBuilder.add(Tag.of(\"service\", serviceName)); \n        \n\n        \n          \n           }", "author": "ikhoon", "createdAt": "2020-07-15T05:25:13Z", "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -147,6 +148,11 @@ public static void configureServerWithArmeriaSettings(ServerBuilder server, Arme\n                     DropwizardSupport.addExposition(settings, server, meterRegistry);\n                 }\n             }\n+\n+            server.decorator(MetricCollectingService.newDecorator(\n+                    MeterIdPrefixFunction.ofDefault(\"armeria.server\")\n+                                         .andThen((registry, log, meterIdPrefix) -> meterIdPrefix.withTags(\n+                                                 \"service\", log.serviceName()))));", "originalCommit": "6dcc935ea4705ac38a5db58ec2912297c6ff6c8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDgwMzEyOA==", "url": "https://github.com/line/armeria/pull/2898#discussion_r454803128", "bodyText": "I think we should remove the following method to avoid duplicate collecting.\n\n  \n    \n      armeria/spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java\n    \n    \n        Lines 339 to 349\n      in\n      8c9c81f\n    \n    \n    \n    \n\n        \n          \n           private static HttpService setupMetricCollectingService( \n        \n\n        \n          \n                   HttpService service, AbstractServiceRegistrationBean<?, ?, ?, ?> bean, \n        \n\n        \n          \n                   @Nullable MeterIdPrefixFunctionFactory meterIdPrefixFunctionFactory) { \n        \n\n        \n          \n               requireNonNull(service, \"service\"); \n        \n\n        \n          \n               requireNonNull(bean, \"bean\"); \n        \n\n        \n          \n            \n        \n\n        \n          \n               if (meterIdPrefixFunctionFactory == null) { \n        \n\n        \n          \n                   return service; \n        \n\n        \n          \n               } \n        \n\n        \n          \n               return service.decorate(metricCollectingServiceDecorator(bean, meterIdPrefixFunctionFactory)); \n        \n\n        \n          \n           }", "author": "ikhoon", "createdAt": "2020-07-15T05:36:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg4NDY3Ng==", "url": "https://github.com/line/armeria/pull/2898#discussion_r454884676", "bodyText": "Oops, I missed this comment. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-15T08:33:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDc5OTc0Nw=="}], "type": "inlineReview"}, {"oid": "503584210c8534bf614e7ab41c33c7eb167e8107", "url": "https://github.com/line/armeria/commit/503584210c8534bf614e7ab41c33c7eb167e8107", "message": "Remove `service` tag", "committedDate": "2020-07-15T06:08:41Z", "type": "commit"}, {"oid": "14eaf4e977bf9e22e5b20deb8ed6e954f5191b59", "url": "https://github.com/line/armeria/commit/14eaf4e977bf9e22e5b20deb8ed6e954f5191b59", "message": "Remove setupMetricCollectingService", "committedDate": "2020-07-16T12:01:06Z", "type": "commit"}, {"oid": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "url": "https://github.com/line/armeria/commit/4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "message": "Remove MeterIdPrefixFUnctionFactory from Server bean dependency graph", "committedDate": "2020-07-20T09:40:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzIyOTIwMw==", "url": "https://github.com/line/armeria/pull/2898#discussion_r457229203", "bodyText": "Could you remove this method?", "author": "minwoox", "createdAt": "2020-07-20T09:43:12Z", "path": "spring/boot2-autoconfigure/src/main/java/com/linecorp/armeria/internal/spring/ArmeriaConfigurationUtil.java", "diffHunk": "@@ -336,18 +328,6 @@ public static void configureAnnotatedServices(\n         }\n     }\n \n-    private static HttpService setupMetricCollectingService(\n-            HttpService service, AbstractServiceRegistrationBean<?, ?, ?, ?> bean,\n-            @Nullable MeterIdPrefixFunctionFactory meterIdPrefixFunctionFactory) {\n-        requireNonNull(service, \"service\");\n-        requireNonNull(bean, \"bean\");\n-\n-        if (meterIdPrefixFunctionFactory == null) {\n-            return service;\n-        }\n-        return service.decorate(metricCollectingServiceDecorator(bean, meterIdPrefixFunctionFactory));\n-    }\n-\n     private static Function<? super HttpService, MetricCollectingService> metricCollectingServiceDecorator(", "originalCommit": "4a6d0f4f70a45e863081fa501ac77b3dbf13a34a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9fff23a0caaf80ef658ebb132b24e6731e4034cd", "url": "https://github.com/line/armeria/commit/9fff23a0caaf80ef658ebb132b24e6731e4034cd", "message": "more cleanup", "committedDate": "2020-07-20T09:45:01Z", "type": "commit"}, {"oid": "0cd224f83eb27cfdd323934619e22e2e98bbc03b", "url": "https://github.com/line/armeria/commit/0cd224f83eb27cfdd323934619e22e2e98bbc03b", "message": "cleanup", "committedDate": "2020-07-21T00:22:16Z", "type": "commit"}]}