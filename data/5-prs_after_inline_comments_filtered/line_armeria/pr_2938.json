{"pr_number": 2938, "pr_title": "Support grpc-web-text", "pr_createdAt": "2020-07-27T06:17:27Z", "pr_url": "https://github.com/line/armeria/pull/2938", "timeline": [{"oid": "27f704e51def8b7812d3a970c5948a607c809f08", "url": "https://github.com/line/armeria/commit/27f704e51def8b7812d3a970c5948a607c809f08", "message": "Support grpc-web-text\nMotivation:\nCurrently, we only support grpc-web, not grpc-web-text.\nIt would be nice if we support both.\n\nModifications:\n- `ArmeriaMessageFramer` and `ArmeriaMessageDeframer` now takes the additional boolean flag which indicates encoding decoding base64\n- Add gRPC-web it test with akka-grpc\n  - The official grpc-java does not support grpc-web so we use akka-grpc for it testing\n\nResult:\n- You can now use grpc-web-text using Armeria client and server.", "committedDate": "2020-07-27T06:16:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460670672", "bodyText": "I believe this won't work if a message spans across HTTP/2 frames since we'll terminate a base64 decode in the middle. It's where I gave up on this ;)", "author": "anuraaga", "createdAt": "2020-07-27T06:24:16Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageDeframer.java", "diffHunk": "@@ -276,8 +279,15 @@ public void deframe(HttpData data, boolean endOfStream) {\n         if (dataLength != 0) {\n             final ByteBuf buf = data.byteBuf();\n             assert unprocessed != null;\n-            unprocessed.add(buf);\n-            unprocessedBytes += dataLength;\n+            if (decodeBase64) {\n+                final ByteBuf decoded = Unpooled.wrappedBuffer(Base64.getDecoder().decode(buf.nioBuffer()));", "originalCommit": "27f704e51def8b7812d3a970c5948a607c809f08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MTMyMw==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460671323", "bodyText": "Oops, I thought the encoded message does not span across the frames. Let me check how Akka is doing this. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-27T06:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NTA0Ng==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460675046", "bodyText": "Time to write a stateful decoder? \ud83d\ude06", "author": "trustin", "createdAt": "2020-07-27T06:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NTQyMA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460675420", "bodyText": "I guess so. \ud83d\ude05  Let me think a bit more about how to solve this. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-27T06:37:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwNDkzOQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460704939", "bodyText": "@anuraaga Should I also consider the case in which the padding is in the middle of a frame? I think there's no such implementations, but just wanted to make sure. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-27T07:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwNzUyMA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460707520", "bodyText": "I think it can definitely happen, especially when a decorator decides to split frames.", "author": "trustin", "createdAt": "2020-07-27T07:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcwNzc1Nw==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460707757", "bodyText": "Ah yeah both cases for sure", "author": "anuraaga", "createdAt": "2020-07-27T07:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDcxMjg4Mg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460712882", "bodyText": "\ud83d\ude31", "author": "minwoox", "createdAt": "2020-07-27T08:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI2MDk1MA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r461260950", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-28T01:19:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3MDY3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NTgzNw==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460675837", "bodyText": "Curious if we need to check against the decoded data or the encoded data.", "author": "trustin", "createdAt": "2020-07-27T06:38:32Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageFramer.java", "diffHunk": "@@ -188,10 +206,7 @@ private ByteBuf write(ByteBuf message, boolean compressed, boolean webTrailers)\n         final int messageLength = message.readableBytes();\n         if (maxOutboundMessageSize >= 0 && messageLength > maxOutboundMessageSize) {\n             message.release();\n-            throw new ArmeriaStatusException(\n-                    StatusCodes.RESOURCE_EXHAUSTED,\n-                    String.format(\"message too large %d > %d\", messageLength,\n-                                  maxOutboundMessageSize));\n+            throw newMessageTooLargeException(messageLength);", "originalCommit": "27f704e51def8b7812d3a970c5948a607c809f08", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NjY5Mg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r460676692", "bodyText": "We were checking the size of compressed data when compressing which means the actual size. So I followed it by checking the size of encoded data. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-27T06:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDY3NTgzNw=="}], "type": "inlineReview"}, {"oid": "df843290a24d1aa0a5970963e4077d90f51eed94", "url": "https://github.com/line/armeria/commit/df843290a24d1aa0a5970963e4077d90f51eed94", "message": "Support spanned encoded data", "committedDate": "2020-07-28T01:12:50Z", "type": "commit"}, {"oid": "c13c6c234d5712460774a8d26f61cb2d627d63cc", "url": "https://github.com/line/armeria/commit/c13c6c234d5712460774a8d26f61cb2d627d63cc", "message": "Optimize base 64 decoder thanks to @trustin", "committedDate": "2020-07-28T08:59:43Z", "type": "commit"}, {"oid": "0f4edb06a23e08370899c9f579f1de6055e18388", "url": "https://github.com/line/armeria/commit/0f4edb06a23e08370899c9f579f1de6055e18388", "message": "Revert GrpcWebUtil", "committedDate": "2020-07-28T09:34:10Z", "type": "commit"}, {"oid": "a340f2d648c35b33566c93f56bff5f496beb4adb", "url": "https://github.com/line/armeria/commit/a340f2d648c35b33566c93f56bff5f496beb4adb", "message": "Update rpc gradle", "committedDate": "2020-07-28T09:40:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMTI5MA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462001290", "bodyText": "Could use Netty's Base64", "author": "trustin", "createdAt": "2020-07-29T02:30:26Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageFramer.java", "diffHunk": "@@ -137,10 +142,23 @@ public HttpData writePayload(ByteBuf message, boolean webTrailers) {\n             } else {\n                 buf = writeUncompressed(message, webTrailers);\n             }\n+\n+            final ByteBuf maybeEncodedBuf;\n+            if (encodeBase64) {\n+                final ByteBuffer base64Encoded = Base64.getEncoder().encode(buf.nioBuffer());", "originalCommit": "a340f2d648c35b33566c93f56bff5f496beb4adb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwOTQyNQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462009425", "bodyText": "Ah Thanks. \ud83d\ude05", "author": "minwoox", "createdAt": "2020-07-29T03:01:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMTI5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMTUyMA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462001520", "bodyText": "Could be simplified into return HttpData.wrap(maybeEncodedBuf).withEndOfStream(webTrailers);", "author": "trustin", "createdAt": "2020-07-29T02:31:12Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageFramer.java", "diffHunk": "@@ -137,10 +142,23 @@ public HttpData writePayload(ByteBuf message, boolean webTrailers) {\n             } else {\n                 buf = writeUncompressed(message, webTrailers);\n             }\n+\n+            final ByteBuf maybeEncodedBuf;\n+            if (encodeBase64) {\n+                final ByteBuffer base64Encoded = Base64.getEncoder().encode(buf.nioBuffer());\n+                buf.release();\n+                if (maxOutboundMessageSize >= 0 && base64Encoded.remaining() > maxOutboundMessageSize) {\n+                    throw newMessageTooLargeException(base64Encoded.remaining());\n+                }\n+                maybeEncodedBuf = Unpooled.wrappedBuffer(base64Encoded);\n+            } else {\n+                maybeEncodedBuf = buf;\n+            }\n+\n             if (webTrailers) {\n-                return HttpData.wrap(buf).withEndOfStream();\n+                return HttpData.wrap(maybeEncodedBuf).withEndOfStream();\n             }\n-            return HttpData.wrap(buf);\n+            return HttpData.wrap(maybeEncodedBuf);", "originalCommit": "a340f2d648c35b33566c93f56bff5f496beb4adb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwOTQ3NQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462009475", "bodyText": "Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-29T03:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMTUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjU1Mg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462002552", "bodyText": "How about using a boolean flag and check it in the finally block instead?\nboolean success = false;\ntry {\n    ...\n    success = true;\n    return dest;\n} finally {\n    if (!success) { dest.release(); }\n    src.release();\n}", "author": "trustin", "createdAt": "2020-07-29T02:35:06Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/Base64Decoder.java", "diffHunk": "@@ -0,0 +1,159 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.grpc.protocol;\n+\n+import java.util.Base64;\n+\n+import javax.annotation.Nullable;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.util.ByteProcessor;\n+\n+/**\n+ * A stateful Base64decoder. Unlike {@link Base64#getDecoder()}, this decoder does not end when it meets\n+ * padding('='), but continues to decode until the end of the {@link ByteBuf} given by\n+ * {@link #decode(ByteBuf)}. If the {@link ByteBuf} does not have necessary 4 bytes to decode as 3 bytes,\n+ * it stores the remained bytes and prepend them to the next {@link #decode(ByteBuf)} and decode together.\n+ */\n+final class Base64Decoder implements ByteProcessor {\n+\n+    // Forked from https://github.com/netty/netty/blob/netty-4.1.51.Final/codec\n+    // /src/main/java/io/netty/handler/codec/base64/Base64.java\n+\n+    private static final byte WHITE_SPACE_ENC = -5; // Indicates white space in encoding\n+\n+    private static final byte EQUALS_SIGN_ENC = -1; // Indicates equals sign in encoding\n+\n+    private static final byte[] DECODABET = {\n+            -9, -9, -9, -9, -9, -9,\n+            -9, -9, -9, // Decimal  0 -  8\n+            -5, -5, // Whitespace: Tab and Linefeed\n+            -9, -9, // Decimal 11 - 12\n+            -5, // Whitespace: Carriage Return\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, // Decimal 14 - 26\n+            -9, -9, -9, -9, -9, // Decimal 27 - 31\n+            -5, // Whitespace: Space\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, // Decimal 33 - 42\n+            62, // Plus sign at decimal 43\n+            -9, -9, -9, // Decimal 44 - 46\n+            63, // Slash at decimal 47\n+            52, 53, 54, 55, 56, 57, 58, 59, 60, 61, // Numbers zero through nine\n+            -9, -9, -9, // Decimal 58 - 60\n+            -1, // Equals sign at decimal 61\n+            -9, -9, -9, // Decimal 62 - 64\n+            0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, // Letters 'A' through 'N'\n+            14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, // Letters 'O' through 'Z'\n+            -9, -9, -9, -9, -9, -9, // Decimal 91 - 96\n+            26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, // Letters 'a' through 'm'\n+            39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, // Letters 'n' through 'z'\n+            -9, -9, -9, -9, -9, // Decimal 123 - 127\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 128 - 140\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 141 - 153\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 154 - 166\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 167 - 179\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 180 - 192\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 193 - 205\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 206 - 218\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 219 - 231\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 232 - 244\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9              // Decimal 245 - 255\n+    };\n+\n+    private final ByteBufAllocator allocator;\n+    @Nullable\n+    private ByteBuf dest;\n+    private final byte[] last3 = new byte[3]; // The 4th byte is stored in a local variable.\n+    private int pos;\n+\n+    Base64Decoder(ByteBufAllocator allocator) {\n+        this.allocator = allocator;\n+    }\n+\n+    ByteBuf decode(ByteBuf src) {\n+        final ByteBuf dest = allocator.buffer(decodedBufferSize(src.readableBytes()));\n+        this.dest = dest;\n+        try {\n+            src.forEachByte(this);\n+            return dest;\n+        } catch (Throwable t) {\n+            dest.release();\n+            throw t;", "originalCommit": "a340f2d648c35b33566c93f56bff5f496beb4adb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwOTU3Ng==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462009576", "bodyText": "That's a good suggestion.", "author": "minwoox", "createdAt": "2020-07-29T03:01:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMjU1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzE3OQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462003179", "bodyText": "Would you mind adding a test case for two concatenated base64 strings with paddings? e.g. 123456==123456==", "author": "trustin", "createdAt": "2020-07-29T02:37:44Z", "path": "grpc-protocol/src/test/java/com/linecorp/armeria/common/grpc/protocol/Base64DecoderTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.grpc.protocol;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.charset.Charset;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.Base64;\n+import java.util.List;\n+import java.util.Random;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.PooledByteBufAllocator;\n+import io.netty.buffer.Unpooled;\n+\n+class Base64DecoderTest {", "originalCommit": "a340f2d648c35b33566c93f56bff5f496beb4adb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwOTgyNw==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462009827", "bodyText": "I believe that this case will produce such a case, but let me add one for clarification. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-29T03:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzE3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzg2Mw==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462003863", "bodyText": "Does this fail or just do nothing? If the latter, how about 'this has no effect if ..' ?", "author": "trustin", "createdAt": "2020-07-29T02:40:28Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -77,9 +78,8 @@\n      * work. If {@link GrpcUnsafeBufferUtil#releaseBuffer(Object, RequestContext)} is not called, the memory\n      * will be leaked.\n      *\n-     * <p>Due to the limited lifetime of {@link RequestContext} for blocking and async clients, this option\n-     * is only really useful in conjunction with streaming clients. Even when using unary methods, it is\n-     * recommended to use a streaming stub for easy access to the {@link RequestContext}.\n+     * <p>Note that this isn't working if the payloads are compressed or the {@link SerializationFormat} is\n+     * {@link GrpcSerializationFormats#PROTO_WEB_TEXT}.", "originalCommit": "a340f2d648c35b33566c93f56bff5f496beb4adb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwOTk5Ng==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462009996", "bodyText": "Let me use this has no effect if ... phrase, thanks!", "author": "minwoox", "createdAt": "2020-07-29T03:03:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwMzg2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwNDIxMg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462004212", "bodyText": "How about adding @throws to the Javadoc?", "author": "trustin", "createdAt": "2020-07-29T02:41:46Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcWebUtil.java", "diffHunk": "@@ -73,8 +77,15 @@\n      * }</pre>\n      */\n     @Nullable\n-    public static HttpHeaders parseTrailers(HttpData response) {\n+    public static HttpHeaders parseTrailers(ClientRequestContext ctx, HttpData response) {\n+        requireNonNull(ctx, \"ctx\");\n         requireNonNull(response, \"response\");\n+        final SerializationFormat serializationFormat =\n+                ctx.log().ensureAvailable(RequestLogProperty.SCHEME).scheme().serializationFormat();", "originalCommit": "a340f2d648c35b33566c93f56bff5f496beb4adb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAxMDg0Mg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462010842", "bodyText": "Added. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-29T03:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAwNDIxMg=="}], "type": "inlineReview"}, {"oid": "fbfe8c584a58a3c562d0649c1005879d0e2baf0d", "url": "https://github.com/line/armeria/commit/fbfe8c584a58a3c562d0649c1005879d0e2baf0d", "message": "Address the comments by @trustin", "committedDate": "2020-07-29T03:29:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MjAzNA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462042034", "bodyText": "Could we release the buffers at the finally block, so that any exceptions do not leak the buffers?", "author": "trustin", "createdAt": "2020-07-29T05:11:14Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageFramer.java", "diffHunk": "@@ -145,20 +143,19 @@ public HttpData writePayload(ByteBuf message, boolean webTrailers) {\n \n             final ByteBuf maybeEncodedBuf;\n             if (encodeBase64) {\n-                final ByteBuffer base64Encoded = Base64.getEncoder().encode(buf.nioBuffer());\n+                final ByteBuf base64Encoded = Base64.encode(buf);\n                 buf.release();", "originalCommit": "fbfe8c584a58a3c562d0649c1005879d0e2baf0d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MjI2NQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462042265", "bodyText": "Method name? \ud83d\ude06", "author": "trustin", "createdAt": "2020-07-29T05:12:09Z", "path": "grpc-protocol/src/test/java/com/linecorp/armeria/common/grpc/protocol/Base64DecoderTest.java", "diffHunk": "@@ -29,34 +28,51 @@\n import io.netty.buffer.ByteBuf;\n import io.netty.buffer.PooledByteBufAllocator;\n import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.base64.Base64;\n \n class Base64DecoderTest {\n \n-    private static final byte[][] EMPTY_BYTES = new byte[0][0];\n+    private static final ByteBuf[] EMPTY_BYTE_BUF = new ByteBuf[0];\n+\n+    @Test\n+    void aaa() {", "originalCommit": "fbfe8c584a58a3c562d0649c1005879d0e2baf0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MTYzMQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462051631", "bodyText": "\ud83d\ude40", "author": "minwoox", "createdAt": "2020-07-29T05:44:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MjI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MjYwOA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462042608", "bodyText": "Is this should not or do not need to? It'd be nice if nothing bad happens the releaseBuffer() is called.", "author": "trustin", "createdAt": "2020-07-29T05:13:27Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientOptions.java", "diffHunk": "@@ -78,8 +78,9 @@\n      * work. If {@link GrpcUnsafeBufferUtil#releaseBuffer(Object, RequestContext)} is not called, the memory\n      * will be leaked.\n      *\n-     * <p>Note that this isn't working if the payloads are compressed or the {@link SerializationFormat} is\n-     * {@link GrpcSerializationFormats#PROTO_WEB_TEXT}.\n+     * <p>Note that this has no effect if the payloads are compressed or the {@link SerializationFormat} is\n+     * {@link GrpcSerializationFormats#PROTO_WEB_TEXT}, so you should not call", "originalCommit": "fbfe8c584a58a3c562d0649c1005879d0e2baf0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MzMzNg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462043336", "bodyText": "It raises an exception if it's called.\nLet me just return boolean instead of raising an exception. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-29T05:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MjYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MjcxNw==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462042717", "bodyText": "A user did not specify RequestLogProperty, so please rephrase it.", "author": "trustin", "createdAt": "2020-07-29T05:13:53Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcWebUtil.java", "diffHunk": "@@ -75,6 +76,9 @@\n      *                })))\n      *        .build(MyGrpcStub.class);\n      * }</pre>\n+     *\n+     * @throws RequestLogAvailabilityException if the specified {@link RequestLogProperty#SCHEME} is not\n+     *                                         available yet.", "originalCommit": "fbfe8c584a58a3c562d0649c1005879d0e2baf0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA1MTY4OA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462051688", "bodyText": "Oops fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-29T05:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA0MjcxNw=="}], "type": "inlineReview"}, {"oid": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "url": "https://github.com/line/armeria/commit/f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "message": "Address the comments by @trustin", "committedDate": "2020-07-29T05:44:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODk3OA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462108978", "bodyText": "Add Netty licence?", "author": "ikhoon", "createdAt": "2020-07-29T07:54:58Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/Base64Decoder.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */", "originalCommit": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2NjczMw==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462166733", "bodyText": "Oops Added.", "author": "minwoox", "createdAt": "2020-07-29T09:31:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwODk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEyNzY1NQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462127655", "bodyText": "Thanks!", "author": "ikhoon", "createdAt": "2020-07-29T08:26:37Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcWebUtil.java", "diffHunk": "@@ -62,19 +68,30 @@\n      * <pre>{@code\n      * Clients.builder(grpcServerUri)\n      *        .decorator(RetryingClient.newDecorator(\n-     *                RetryRuleWithContent.onResponse(response -> {\n+     *                RetryRuleWithContent.onResponse((ctx, response) -> {", "originalCommit": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNDgxOA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462134818", "bodyText": "Don't we need to improve the error message at line 348?\ne.g. serializationFormat.uriTxt() + \" trailers malformed...\"", "author": "ikhoon", "createdAt": "2020-07-29T08:37:58Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaClientCall.java", "diffHunk": "@@ -319,7 +320,7 @@ public synchronized void setMessageCompression(boolean enabled) {\n \n     @Override\n     public void messageRead(DeframedMessage message) {\n-        if (isGrpcWeb && message.type() >> 7 == 1) {\n+        if (GrpcSerializationFormats.isGrpcWeb(serializationFormat) && message.type() >> 7 == 1) {", "originalCommit": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2OTMzMg==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462169332", "bodyText": "Fixed Thanks!", "author": "minwoox", "createdAt": "2020-07-29T09:35:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNDgxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNTgxMA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462135810", "bodyText": "nit: Use consitent word? grpcWebText vs webText?", "author": "ikhoon", "createdAt": "2020-07-29T08:39:46Z", "path": "grpc/src/main/java/com/linecorp/armeria/internal/client/grpc/ArmeriaClientCall.java", "diffHunk": "@@ -358,13 +359,14 @@ public void messageRead(DeframedMessage message) {\n         }\n \n         try {\n-            final O msg = marshaller.deserializeResponse(message);\n+            final boolean webText = GrpcSerializationFormats.isGrpcWebText(serializationFormat);", "originalCommit": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE3MDE2MQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462170161", "bodyText": "I think it's okay unless the different names are used in a method. But Let me change to use grpcWebText. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-29T09:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzNTgxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEzODI4OQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462138289", "bodyText": "Ditto: grpcWebText vs webText? \ud83d\ude09", "author": "ikhoon", "createdAt": "2020-07-29T08:44:18Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ArmeriaServerCall.java", "diffHunk": "@@ -375,8 +373,10 @@ public void messageRead(DeframedMessage message) {\n             }\n         }\n \n+        final boolean webText = GrpcSerializationFormats.isGrpcWebText(serializationFormat);", "originalCommit": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d9cad5f55f5501ef557576c87f884ce537d44d4", "url": "https://github.com/line/armeria/commit/9d9cad5f55f5501ef557576c87f884ce537d44d4", "message": "Support all serialization formats by default", "committedDate": "2020-07-29T09:17:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2MTA3NQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462161075", "bodyText": "Changed to support all GrpcSerializationFormats by default because there's no regression on performance and @ikhoon sometimes forgets about specifying JSON format when he's doing some test. \ud83e\udd23  /cc @anuraaga", "author": "minwoox", "createdAt": "2020-07-29T09:21:44Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -65,7 +65,7 @@\n public final class GrpcServiceBuilder {\n \n     private static final Set<SerializationFormat> DEFAULT_SUPPORTED_SERIALIZATION_FORMATS =\n-            ImmutableSet.of(GrpcSerializationFormats.PROTO, GrpcSerializationFormats.PROTO_WEB);\n+            GrpcSerializationFormats.values();", "originalCommit": "9d9cad5f55f5501ef557576c87f884ce537d44d4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2MTcxOA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462161718", "bodyText": "Could you enable all gRPC protocols by default?\nMost of Armeria users use gRPC-Java and com.google.protobuf.Message. Armeria can encode and decode the messages by default.\nEven though Armeria does not support ScalaPB JSON by default. \ud83d\ude05\nAny thoughts? @anuraaga", "author": "ikhoon", "createdAt": "2020-07-29T09:22:47Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -65,7 +65,9 @@\n public final class GrpcServiceBuilder {\n \n     private static final Set<SerializationFormat> DEFAULT_SUPPORTED_SERIALIZATION_FORMATS =\n-            ImmutableSet.of(GrpcSerializationFormats.PROTO, GrpcSerializationFormats.PROTO_WEB);\n+            ImmutableSet.of(GrpcSerializationFormats.PROTO,\n+                            GrpcSerializationFormats.PROTO_WEB,\n+                            GrpcSerializationFormats.PROTO_WEB_TEXT);", "originalCommit": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2NjcyMA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462166720", "bodyText": "Oops... Ditto \ud83e\udd23", "author": "ikhoon", "createdAt": "2020-07-29T09:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2MTcxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2NzYxNQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462167615", "bodyText": "Does a user need to check the return value? I guess it will be usually fire-and-forget.\nIf we ever return something, I think we need to distinguish between non-existent buffer and release() returning false.", "author": "trustin", "createdAt": "2020-07-29T09:32:33Z", "path": "grpc/src/main/java/com/linecorp/armeria/unsafe/grpc/GrpcUnsafeBufferUtil.java", "diffHunk": "@@ -57,16 +57,24 @@ public static void storeBuffer(ByteBuf buf, Object message, RequestContext ctx)\n \n     /**\n      * Releases the {@link ByteBuf} backing the specified {@link Message}.\n+     *\n+     * @return {@code true} if and only if the reference count of the stored {@link ByteBuf} became {@code 0}.\n+     *         This will return {@code false} if the reference count does not become {@code 0} or,\n+     *         {@link #storeBuffer(ByteBuf, Object, RequestContext)} has not been called for the specified\n+     *         message and {@link RequestContext}.\n      */\n-    public static void releaseBuffer(Object message, RequestContext ctx) {\n+    @CheckReturnValue\n+    public static boolean releaseBuffer(Object message, RequestContext ctx) {", "originalCommit": "f8c00aeb45cde3fdf31d12e6b7d5fe74210427ff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE3NDMzOA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462174338", "bodyText": "Changed to do nothing if there's no stored buffer. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-07-29T09:44:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE2NzYxNQ=="}], "type": "inlineReview"}, {"oid": "9b5fb9b3b247d8d1f91503ac4f9753b21c581aa4", "url": "https://github.com/line/armeria/commit/9b5fb9b3b247d8d1f91503ac4f9753b21c581aa4", "message": "Address comments by @ikhoon", "committedDate": "2020-07-29T09:37:55Z", "type": "commit"}, {"oid": "70a7fbdb056e8b400e4e38bbeede1e098307c0e1", "url": "https://github.com/line/armeria/commit/70a7fbdb056e8b400e4e38bbeede1e098307c0e1", "message": "Release silently", "committedDate": "2020-07-29T09:43:15Z", "type": "commit"}, {"oid": "6478d30059fc0af124857e1d9abe01d2878aed3b", "url": "https://github.com/line/armeria/commit/6478d30059fc0af124857e1d9abe01d2878aed3b", "message": "Update documenation", "committedDate": "2020-07-29T10:16:12Z", "type": "commit"}, {"oid": "fb738fd6e82f357ac00eeecb048959ded7536f02", "url": "https://github.com/line/armeria/commit/fb738fd6e82f357ac00eeecb048959ded7536f02", "message": "Use scala 2.13", "committedDate": "2020-07-30T03:26:20Z", "type": "commit"}, {"oid": "1f35298f75a4871f5a31d91e5af6e8c994b1e1a0", "url": "https://github.com/line/armeria/commit/1f35298f75a4871f5a31d91e5af6e8c994b1e1a0", "message": "Use scala version in flag", "committedDate": "2020-07-30T03:43:22Z", "type": "commit"}, {"oid": "30da9cf5b641fe80034601b0aa944d0987b987be", "url": "https://github.com/line/armeria/commit/30da9cf5b641fe80034601b0aa944d0987b987be", "message": "Merge branch 'master' into grpc-web-text", "committedDate": "2020-07-30T03:55:05Z", "type": "commit"}, {"oid": "d13089d228833abf634c2ec4d2d49f2a89a7c888", "url": "https://github.com/line/armeria/commit/d13089d228833abf634c2ec4d2d49f2a89a7c888", "message": "Merge branch 'master' into grpc-web-text", "committedDate": "2020-07-30T04:15:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMzI4NA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462723284", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * A stateful Base64decoder. Unlike {@link Base64#getDecoder()}, this decoder does not end when it meets\n          \n          \n            \n             * A stateful Base64decoder. Unlike {@link io.netty.handler.codec.base64.Base64Decoder}, this decoder does not end when it meets\n          \n      \n    \n    \n  \n\nImportant to describe the difference in this fork, not behavior vs JDK.", "author": "anuraaga", "createdAt": "2020-07-30T04:11:13Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/Base64Decoder.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Written by Robert Harder and released to the public domain, as explained at\n+ * http://creativecommons.org/licenses/publicdomain\n+ */\n+package com.linecorp.armeria.common.grpc.protocol;\n+\n+import java.util.Base64;\n+\n+import javax.annotation.Nullable;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.util.ByteProcessor;\n+\n+/**\n+ * A stateful Base64decoder. Unlike {@link Base64#getDecoder()}, this decoder does not end when it meets", "originalCommit": "30da9cf5b641fe80034601b0aa944d0987b987be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMzU1NA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462723554", "bodyText": "Why do we ignore white space, that seems like malformed base64?", "author": "anuraaga", "createdAt": "2020-07-30T04:12:28Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/Base64Decoder.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Copyright 2012 The Netty Project\n+ *\n+ * The Netty Project licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+/*\n+ * Written by Robert Harder and released to the public domain, as explained at\n+ * http://creativecommons.org/licenses/publicdomain\n+ */\n+package com.linecorp.armeria.common.grpc.protocol;\n+\n+import java.util.Base64;\n+\n+import javax.annotation.Nullable;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.ByteBufAllocator;\n+import io.netty.util.ByteProcessor;\n+\n+/**\n+ * A stateful Base64decoder. Unlike {@link Base64#getDecoder()}, this decoder does not end when it meets\n+ * padding('='), but continues to decode until the end of the {@link ByteBuf} given by\n+ * {@link #decode(ByteBuf)}. If the {@link ByteBuf} does not have necessary 4 bytes to decode as 3 bytes,\n+ * it stores the remained bytes and prepend them to the next {@link #decode(ByteBuf)} and decode together.\n+ */\n+final class Base64Decoder implements ByteProcessor {\n+\n+    // Forked from https://github.com/netty/netty/blob/netty-4.1.51.Final/codec\n+    // /src/main/java/io/netty/handler/codec/base64/Base64.java\n+\n+    private static final byte WHITE_SPACE_ENC = -5; // Indicates white space in encoding\n+\n+    private static final byte EQUALS_SIGN_ENC = -1; // Indicates equals sign in encoding\n+\n+    private static final byte[] DECODABET = {\n+            -9, -9, -9, -9, -9, -9,\n+            -9, -9, -9, // Decimal  0 -  8\n+            -5, -5, // Whitespace: Tab and Linefeed\n+            -9, -9, // Decimal 11 - 12\n+            -5, // Whitespace: Carriage Return\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, // Decimal 14 - 26\n+            -9, -9, -9, -9, -9, // Decimal 27 - 31\n+            -5, // Whitespace: Space\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, // Decimal 33 - 42\n+            62, // Plus sign at decimal 43\n+            -9, -9, -9, // Decimal 44 - 46\n+            63, // Slash at decimal 47\n+            52, 53, 54, 55, 56, 57, 58, 59, 60, 61, // Numbers zero through nine\n+            -9, -9, -9, // Decimal 58 - 60\n+            -1, // Equals sign at decimal 61\n+            -9, -9, -9, // Decimal 62 - 64\n+            0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, // Letters 'A' through 'N'\n+            14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, // Letters 'O' through 'Z'\n+            -9, -9, -9, -9, -9, -9, // Decimal 91 - 96\n+            26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, // Letters 'a' through 'm'\n+            39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, // Letters 'n' through 'z'\n+            -9, -9, -9, -9, -9, // Decimal 123 - 127\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 128 - 140\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 141 - 153\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 154 - 166\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 167 - 179\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 180 - 192\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 193 - 205\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 206 - 218\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 219 - 231\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9,     // Decimal 232 - 244\n+            -9, -9, -9, -9, -9, -9, -9, -9, -9, -9, -9              // Decimal 245 - 255\n+    };\n+\n+    private final ByteBufAllocator allocator;\n+    @Nullable\n+    private ByteBuf dest;\n+    private final byte[] last3 = new byte[3]; // The 4th byte is stored in a local variable.\n+    private int pos;\n+\n+    Base64Decoder(ByteBufAllocator allocator) {\n+        this.allocator = allocator;\n+    }\n+\n+    ByteBuf decode(ByteBuf src) {\n+        final ByteBuf dest = allocator.buffer(decodedBufferSize(src.readableBytes()));\n+        this.dest = dest;\n+        boolean success = false;\n+        try {\n+            src.forEachByte(this);\n+            success = true;\n+            return dest;\n+        } finally {\n+            if (!success) {\n+                dest.release();\n+            }\n+            src.release();\n+        }\n+    }\n+\n+    private int decodedBufferSize(int len) {\n+        return (len + pos) / 4 * 3;\n+    }\n+\n+    @Override\n+    public boolean process(byte value) throws Exception {\n+        final byte decodedByte = DECODABET[value & 0xFF];\n+        if (decodedByte < WHITE_SPACE_ENC) {\n+            throw new IllegalArgumentException(\n+                    \"invalid Base64 input character: \" + (short) (value & 0xFF) + \" (decimal)\");\n+        }\n+\n+        // White space, Equals sign or better\n+        if (decodedByte < EQUALS_SIGN_ENC) {\n+            // Ignore the white space.", "originalCommit": "30da9cf5b641fe80034601b0aa944d0987b987be", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyNTk1OA==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462725958", "bodyText": "Let me raise an exception. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-30T04:22:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyMzU1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyNDY4MQ==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462724681", "bodyText": "I don't think we should generate test cases randomly, it's very hard to be convinced this class is actually a complete test for base64, can you write a more concrete, easy to reason about test suite? Of course this is a big reason I didn't want to implement it :)", "author": "anuraaga", "createdAt": "2020-07-30T04:17:18Z", "path": "grpc-protocol/src/test/java/com/linecorp/armeria/common/grpc/protocol/Base64DecoderTest.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.grpc.protocol;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+\n+import java.nio.charset.Charset;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Random;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import io.netty.buffer.ByteBuf;\n+import io.netty.buffer.PooledByteBufAllocator;\n+import io.netty.buffer.Unpooled;\n+import io.netty.handler.codec.base64.Base64;\n+\n+class Base64DecoderTest {\n+\n+    private static final ByteBuf[] EMPTY_BYTE_BUF = new ByteBuf[0];\n+\n+    @Test\n+    void decodeConcatenatedBufsWithPadding() {\n+        final String str = \"abcd\"; // YWJjZA==\n+        final ByteBuf buf = Unpooled.wrappedBuffer(str.getBytes());\n+        final ByteBuf encoded1 = Base64.encode(buf);\n+        buf.readerIndex(0);\n+        final ByteBuf encoded2 = Base64.encode(buf);\n+        final ByteBuf concatenated = Unpooled.wrappedBuffer(encoded1, encoded2); // YWJjZA==YWJjZA==\n+        final Base64Decoder base64Decoder = new Base64Decoder(PooledByteBufAllocator.DEFAULT);\n+        final ByteBuf decoded = base64Decoder.decode(concatenated);\n+        assertThat(decoded.toString(Charset.defaultCharset())).isEqualTo(\"abcdabcd\");\n+        decoded.release();\n+    }\n+\n+    @Test\n+    void decodeMultipleEncodedBytes() {\n+        final String str = \"abcdefghijklmnopqrstuvwxyzabcdefghijklmnopqrstuvwxyz1234567890\";\n+        final byte[] bytes = str.getBytes();\n+        final List<ByteBuf> fragments = fragmentRandomly(bytes);\n+        final int half = fragments.size() / 2;\n+        final ByteBuf first =\n+                Unpooled.wrappedBuffer(fragments.subList(0, half).toArray(EMPTY_BYTE_BUF));\n+        final ByteBuf second =\n+                Unpooled.wrappedBuffer(fragments.subList(half, fragments.size()).toArray(EMPTY_BYTE_BUF));\n+        final Base64Decoder base64Decoder = new Base64Decoder(PooledByteBufAllocator.DEFAULT);\n+        final ByteBuf decodedFirst = base64Decoder.decode(first);\n+        final ByteBuf decodedSecond = base64Decoder.decode(second);\n+        assertThat(Unpooled.wrappedBuffer(decodedFirst, decodedSecond).toString(Charset.defaultCharset()))\n+                .isEqualTo(str);\n+        decodedFirst.release();\n+        decodedSecond.release();\n+    }\n+\n+    private static List<ByteBuf> fragmentRandomly(byte[] bytes) {", "originalCommit": "d13089d228833abf634c2ec4d2d49f2a89a7c888", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyNTM0Ng==", "url": "https://github.com/line/armeria/pull/2938#discussion_r462725346", "bodyText": "I'm working on a PR that supports compression and decoding base64 in GrpcWebUtil.\nLet me work on this in that PR. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-30T04:20:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjcyNDY4MQ=="}], "type": "inlineReview"}]}