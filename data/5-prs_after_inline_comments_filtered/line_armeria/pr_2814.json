{"pr_number": 2814, "pr_title": "Update gRPC-Java to 1.30.0", "pr_createdAt": "2020-06-18T08:28:50Z", "pr_url": "https://github.com/line/armeria/pull/2814", "timeline": [{"oid": "05be143acb6fa159e9e5a911c4776b63a31580bd", "url": "https://github.com/line/armeria/commit/05be143acb6fa159e9e5a911c4776b63a31580bd", "message": "Update gRPC-Java to 1.30.0\n\nMotivation:\n\ngRPC-Java [1.30.0](https://github.com/grpc/grpc-java/releases/tag/v1.30.0) has been released\nWe need a workaround for `ProtoReflectionService`. Because it does not implement `InternalNotifyOnServerBuild` anymore.\nSee https://github.com/grpc/grpc-java/pull/6967 #2806\nIt is a temporary workaround until upstream handles https://github.com/grpc/grpc-java/issues/7138.\n\nMotivations:\n\n- Upgrade gRPC to 1.30.0 from 1.29.0\n- Add ProtoReflectionServiceInterceptor that injects dummy server to\n  gRPC context.\n\nResult:\n\nYou can run gRPC 1.30.0 with Armeria server.\nFixes #2806", "committedDate": "2020-06-18T08:27:37Z", "type": "commit"}, {"oid": "b642ec4c12526bbd0c868f899bee58bd212b8924", "url": "https://github.com/line/armeria/commit/b642ec4c12526bbd0c868f899bee58bd212b8924", "message": "Add test dependencies for gRPC integration test", "committedDate": "2020-06-18T08:38:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTAyMg==", "url": "https://github.com/line/armeria/pull/2814#discussion_r442065022", "bodyText": "How about creating eagerly?", "author": "trustin", "createdAt": "2020-06-18T08:41:28Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ProtoReflectionServiceInterceptor.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.grpc;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Function;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import io.grpc.Context;\n+import io.grpc.Contexts;\n+import io.grpc.InternalServer;\n+import io.grpc.Metadata;\n+import io.grpc.Server;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCall.Listener;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.ServerServiceDefinition;\n+\n+final class ProtoReflectionServiceInterceptor implements ServerInterceptor {\n+\n+    static final ProtoReflectionServiceInterceptor INSTANCE = new ProtoReflectionServiceInterceptor();\n+\n+    @Nullable\n+    private static Server dummyServer;\n+\n+    private ProtoReflectionServiceInterceptor() {}\n+\n+    @Override\n+    public <I, O> Listener<I> interceptCall(ServerCall<I, O> call, Metadata headers,\n+                                            ServerCallHandler<I, O> next) {\n+        if (dummyServer == null) {\n+            synchronized (INSTANCE) {\n+                dummyServer = newDummyServer();\n+            }\n+        }", "originalCommit": "b642ec4c12526bbd0c868f899bee58bd212b8924", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NzcwOQ==", "url": "https://github.com/line/armeria/pull/2814#discussion_r442067709", "bodyText": "Oh, I think we can create the dummy server when serviceAdded(...) is called and use that in this interceptor.", "author": "ikhoon", "createdAt": "2020-06-18T08:45:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTE0OA==", "url": "https://github.com/line/armeria/pull/2814#discussion_r442065148", "bodyText": "Instead of adding here, can't we add in the same place we called notifyOnBuild before so we can use the static server config instead of request context?", "author": "anuraaga", "createdAt": "2020-06-18T08:41:39Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/GrpcServiceBuilder.java", "diffHunk": "@@ -107,11 +107,13 @@ public GrpcServiceBuilder addService(ServerServiceDefinition service) {\n      */\n     public GrpcServiceBuilder addService(BindableService bindableService) {\n         if (bindableService instanceof ProtoReflectionService) {\n-            checkState(protoReflectionService == null,\n+            checkState(!isProtoReflectionServiceSet,\n                        \"Attempting to add a ProtoReflectionService but one is already present. \" +\n                        \"ProtoReflectionService must only be added once.\");\n-            protoReflectionService = (ProtoReflectionService) bindableService;\n-        }\n+            isProtoReflectionServiceSet = true;\n+            return addService(ServerInterceptors.intercept(bindableService,", "originalCommit": "b642ec4c12526bbd0c868f899bee58bd212b8924", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTg1NA==", "url": "https://github.com/line/armeria/pull/2814#discussion_r442065854", "bodyText": "Ah nevermind guess we can't add more services there :)", "author": "anuraaga", "createdAt": "2020-06-18T08:42:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTE0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA3NjE0Mg==", "url": "https://github.com/line/armeria/pull/2814#discussion_r442076142", "bodyText": "The creation logic is moved back to FramedGrpcService. \ud83d\ude00", "author": "ikhoon", "createdAt": "2020-06-18T08:58:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NTE0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NzIwOA==", "url": "https://github.com/line/armeria/pull/2814#discussion_r442067208", "bodyText": "Ah - is this supposed to be static? If so this interceptor can be static too, and yeah back to the idea we can call ProtoReflectionServiceInterceptor.addServerConfig() where we used to call notifyOnBuild", "author": "anuraaga", "createdAt": "2020-06-18T08:44:51Z", "path": "grpc/src/main/java/com/linecorp/armeria/server/grpc/ProtoReflectionServiceInterceptor.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.server.grpc;\n+\n+import static com.google.common.collect.ImmutableMap.toImmutableMap;\n+\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Function;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.server.ServiceRequestContext;\n+\n+import io.grpc.Context;\n+import io.grpc.Contexts;\n+import io.grpc.InternalServer;\n+import io.grpc.Metadata;\n+import io.grpc.Server;\n+import io.grpc.ServerCall;\n+import io.grpc.ServerCall.Listener;\n+import io.grpc.ServerCallHandler;\n+import io.grpc.ServerInterceptor;\n+import io.grpc.ServerServiceDefinition;\n+\n+final class ProtoReflectionServiceInterceptor implements ServerInterceptor {\n+\n+    static final ProtoReflectionServiceInterceptor INSTANCE = new ProtoReflectionServiceInterceptor();\n+\n+    @Nullable\n+    private static Server dummyServer;", "originalCommit": "b642ec4c12526bbd0c868f899bee58bd212b8924", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA4MTc3Mg==", "url": "https://github.com/line/armeria/pull/2814#discussion_r442081772", "bodyText": "Replied at #2814 (comment)", "author": "ikhoon", "createdAt": "2020-06-18T09:07:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjA2NzIwOA=="}], "type": "inlineReview"}, {"oid": "ba212c75658486f29e8fded0c2a758cd53107d7c", "url": "https://github.com/line/armeria/commit/ba212c75658486f29e8fded0c2a758cd53107d7c", "message": "Address comments by @trustin / Build a dummy server when service is added", "committedDate": "2020-06-18T08:56:06Z", "type": "commit"}, {"oid": "29664c758663284b4ee34d279d324e9f58e3cffb", "url": "https://github.com/line/armeria/commit/29664c758663284b4ee34d279d324e9f58e3cffb", "message": "Address comments by @trustin / Remove static dummy server", "committedDate": "2020-06-18T12:19:12Z", "type": "commit"}, {"oid": "0b0565d3de1dca0fc0d6385e44b87c85a27c2f22", "url": "https://github.com/line/armeria/commit/0b0565d3de1dca0fc0d6385e44b87c85a27c2f22", "message": "Update protobuf to 3.12.0", "committedDate": "2020-06-18T13:08:40Z", "type": "commit"}, {"oid": "055af992bc2839e79858bc9050ee47e42aaaa3ab", "url": "https://github.com/line/armeria/commit/055af992bc2839e79858bc9050ee47e42aaaa3ab", "message": "Checkstyle", "committedDate": "2020-06-18T14:06:02Z", "type": "commit"}]}