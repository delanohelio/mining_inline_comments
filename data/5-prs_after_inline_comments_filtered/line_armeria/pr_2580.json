{"pr_number": 2580, "pr_title": "Specify why on `Closed{Session,Stream}Exception`", "pr_createdAt": "2020-03-13T09:18:17Z", "pr_url": "https://github.com/line/armeria/pull/2580", "timeline": [{"oid": "b589be06783df8e9c55e5aaf69944241993d76d9", "url": "https://github.com/line/armeria/commit/b589be06783df8e9c55e5aaf69944241993d76d9", "message": "Specify why on `Closed{Session,Stream}Exception`\n\nMotivation:\n\nIt is sometimes hard to know why a connection or a stream has been\nclosed or reset.\n\nModifications:\n\n- Allow a user specify a message or a cause when creating a\n  `Closed{Session,Stream}Exception`.\n- Specify a message or a cause when creating `Closed{Session,Stream}Exception`\n  when applicable.\n- Removed redundant instantiation of `ClosedSessionException`s.\n- Fixed a bug where `ClosedSessionException` is raised when\n  `ClosedStreamException` is expected.\n\nResult:\n\n- More information when diagnosing a `Closed{Session,Stream}Exception`\n- Fixed a bug where `ClosedSessionException` is raised when\n  `ClosedStreamException` is expected.", "committedDate": "2020-03-13T09:16:42Z", "type": "commit"}, {"oid": "9b40ef7e9c724f687cd25b9195d645627911233f", "url": "https://github.com/line/armeria/commit/9b40ef7e9c724f687cd25b9195d645627911233f", "message": "Miscellaneous: Use `toString()` instead of `getMessage()` to show the cause type", "committedDate": "2020-03-13T09:30:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExOTMyMA==", "url": "https://github.com/line/armeria/pull/2580#discussion_r392119320", "bodyText": "Is there any chance that the previousCause is not suppressible?", "author": "minwoox", "createdAt": "2020-03-13T09:36:35Z", "path": "core/src/main/java/com/linecorp/armeria/client/HttpSessionHandler.java", "diffHunk": "@@ -322,34 +324,53 @@ public void channelInactive(ChannelHandlerContext ctx) throws Exception {\n             channelPool.connect(channel.remoteAddress(), H1C, sessionPromise);\n         } else {\n             // Fail all pending responses.\n-            final Throwable throwable;\n-            if (ctx.channel().hasAttr(PENDING_EXCEPTION)) {\n-                throwable = ctx.channel().attr(PENDING_EXCEPTION).get();\n+            final HttpResponseDecoder responseDecoder = this.responseDecoder;\n+            final Throwable pendingException;\n+            if (responseDecoder != null && responseDecoder.hasUnfinishedResponses()) {\n+                pendingException = getPendingException(ctx);\n+                responseDecoder.failUnfinishedResponses(pendingException);\n             } else {\n-                throwable = ClosedSessionException.get();\n+                pendingException = null;\n             }\n-            failUnfinishedResponses(throwable);\n+\n             // Cancel the timeout and reject the sessionPromise just in case the connection has been closed\n             // even before the session protocol negotiation is done.\n             sessionTimeoutFuture.cancel(false);\n-            sessionPromise.tryFailure(throwable);\n+            if (!sessionPromise.isDone()) {\n+                sessionPromise.tryFailure(pendingException != null ? pendingException\n+                                                                   : getPendingException(ctx));\n+            }\n         }\n     }\n \n     @Override\n     public void exceptionCaught(ChannelHandlerContext ctx, Throwable cause) throws Exception {\n+        setPendingException(ctx, new ClosedSessionException(cause));\n         Exceptions.logIfUnexpected(logger, channel, protocol(), cause);\n-        if (channel.isActive()) {\n+        if (!(cause instanceof IOException)) {\n             ctx.close();\n+        } else {\n+            // Netty will close the connection automatically on an IOException.\n         }\n     }\n \n-    private void failUnfinishedResponses(Throwable e) {\n-        final HttpResponseDecoder responseDecoder = this.responseDecoder;\n-        if (responseDecoder == null) {\n-            return;\n+    private static Throwable getPendingException(ChannelHandlerContext ctx) {\n+        if (ctx.channel().hasAttr(PENDING_EXCEPTION)) {\n+            return ctx.channel().attr(PENDING_EXCEPTION).get();\n         }\n \n-        responseDecoder.failUnfinishedResponses(e);\n+        return ClosedSessionException.get();\n+    }\n+\n+    static void setPendingException(ChannelHandlerContext ctx, Throwable cause) {\n+        final Attribute<Throwable> attr = ctx.channel().attr(PENDING_EXCEPTION);\n+        final Throwable previousCause = attr.get();\n+        if (previousCause == null) {\n+            attr.set(cause);\n+        } else if (previousCause != cause) {\n+            previousCause.addSuppressed(cause);", "originalCommit": "9b40ef7e9c724f687cd25b9195d645627911233f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzNTYwOA==", "url": "https://github.com/line/armeria/pull/2580#discussion_r392135608", "bodyText": "It's possible but we need to preserve the type of the original exception, such as UnprocessedRequestException.", "author": "trustin", "createdAt": "2020-03-13T10:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExOTMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEzODg4OQ==", "url": "https://github.com/line/armeria/pull/2580#discussion_r392138889", "bodyText": "Yes couldn't think of that. \ud83d\ude05", "author": "minwoox", "createdAt": "2020-03-13T10:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExOTMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE0MTc0MA==", "url": "https://github.com/line/armeria/pull/2580#discussion_r392141740", "bodyText": "Now just logging, instead of suppressing.", "author": "trustin", "createdAt": "2020-03-13T10:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjExOTMyMA=="}], "type": "inlineReview"}, {"oid": "de02516c8ccb8adcf8cb3479b35de371c49867cf", "url": "https://github.com/line/armeria/commit/de02516c8ccb8adcf8cb3479b35de371c49867cf", "message": "No need to log when exception is propagated / Do not suppress but log", "committedDate": "2020-03-13T10:20:13Z", "type": "commit"}, {"oid": "a7ffa5c9c637323451a2ad4325a61eee7d3c98fc", "url": "https://github.com/line/armeria/commit/a7ffa5c9c637323451a2ad4325a61eee7d3c98fc", "message": "Fix test", "committedDate": "2020-03-13T10:25:22Z", "type": "commit"}]}