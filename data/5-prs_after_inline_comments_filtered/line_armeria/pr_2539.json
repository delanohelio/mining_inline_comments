{"pr_number": 2539, "pr_title": "Fix StreamMessage to handle abort() correctly", "pr_createdAt": "2020-02-27T11:57:50Z", "pr_url": "https://github.com/line/armeria/pull/2539", "timeline": [{"oid": "29a99e716733e33177ae01f74313ac8e49f5aa16", "url": "https://github.com/line/armeria/commit/29a99e716733e33177ae01f74313ac8e49f5aa16", "message": "Fix StreamMessage to handle abort() correctly\nMotivation:\nLet's see following example:\n```java\nStreamMessageAndWriter<Object> stream = new DefaultStreamMessage<>();\nstream.write(data);\nstream.close();\nstream.subscribe(mySubscriber);\nstream.abort();\n```\nIn this case, `onError()` or `onComplete()`, which `onNext(data)` is called previousle, should be called. But, currently, just `onComplete()` is invoked.\n\nModifications:\n- If `StreamMessage.abort()` or `cancel()` is called, the `StreamMessage` handles the subscriber with the event and ignores the `close()` call.\n\nResult:\n- You now get `AbortedStreamException` error when the stream is aborted after closed.", "committedDate": "2020-02-27T11:45:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzUzNA==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385083534", "bodyText": "The request is not subscribed but aborted in HttpServerHandler so the cause is changed.\nShould I change not to log this exception when the request is not subscribed? \ud83e\udd14", "author": "minwoox", "createdAt": "2020-02-27T12:01:45Z", "path": "core/src/test/java/com/linecorp/armeria/server/HttpServerHandlerTest.java", "diffHunk": "@@ -103,6 +104,6 @@ void httpResponseExceptionIsNotLoggedAsRequestCause() {\n         await().untilAsserted(() -> {\n             assertThat(logHolder.get().requestHeaders().path()).isEqualTo(\"/httpResponseException\");\n         });\n-        assertThat(logHolder.get().requestCause()).isNull();\n+        assertThat(logHolder.get().requestCause()).isInstanceOf(AbortedStreamException.class);", "originalCommit": "29a99e716733e33177ae01f74313ac8e49f5aa16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIwNzI4MA==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385207280", "bodyText": "Hmm. Most GET request handler will not subscribe at all. Perhaps we should handle the case where it is certain that request (or response) body will be empty?", "author": "trustin", "createdAt": "2020-02-27T16:06:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTIxMTMyNQ==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385211325", "bodyText": "However, such logic isn't part of the StreamMessage implementations. Could be done in the places that call abort()?", "author": "trustin", "createdAt": "2020-02-27T16:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzUzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQ2MDk0Mg==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385460942", "bodyText": "Perhaps we should handle the case where it is certain that request (or response) body will be empty?\n\nThat's a nice idea. EmptyFixedStreamMessage works in the same way. Let me make a change for that. Thanks!", "author": "minwoox", "createdAt": "2020-02-28T01:16:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzUzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NDQyNQ==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385084425", "bodyText": "So the concept now is that, whatever the event which changes to the CLEANUP state, will notify to the subscriber with it.", "author": "minwoox", "createdAt": "2020-02-27T12:03:44Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -361,8 +384,9 @@ private boolean notifyAwaitDemandFuture() {\n     }\n \n     private void handleCloseEvent(SubscriptionImpl subscription, CloseEvent o) {\n-        setState(State.OPEN, State.CLEANUP);\n-        notifySubscriberOfCloseEvent(subscription, o);\n+        if (setState(State.CLOSED, State.CLEANUP)) {", "originalCommit": "29a99e716733e33177ae01f74313ac8e49f5aa16", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzQ3NQ==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385083475", "bodyText": "Question mark?", "author": "trustin", "createdAt": "2020-02-27T12:01:37Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -216,13 +240,12 @@ private void cancelOrAbort(Throwable cause) {\n \n         switch (state) {\n             case CLOSED:\n-                // close() has been called before cancel(). There's no need to push a CloseEvent,\n-                // but we need to ensure the completionFuture is notified and any pending objects\n-                // are removed.\n+                // close() has been called before cancel() or abort() is called.\n+                // We just push the new CloseEvent so that SUCCESSFUL_CLOSE, which was pushed by close(), is\n+                // ignored and cancel() or abort() call works?", "originalCommit": "29a99e716733e33177ae01f74313ac8e49f5aa16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NzU0Mg==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385087542", "bodyText": "-_-;", "author": "minwoox", "createdAt": "2020-02-27T12:10:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4MzQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NDcxOQ==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385084719", "bodyText": "cause could be instantiated only when necessary.", "author": "trustin", "createdAt": "2020-02-27T12:04:24Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -402,6 +426,41 @@ private boolean setState(State oldState, State newState) {\n     }\n \n     private void cleanup() {\n-        cleanupQueue(subscription, queue);\n+        final Throwable cause = ClosedStreamException.get();", "originalCommit": "29a99e716733e33177ae01f74313ac8e49f5aa16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4Nzk5OQ==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385087999", "bodyText": "Ah fixed. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-02-27T12:11:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NDcxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NjcwOA==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385086708", "bodyText": "// Just skip SUCCESSFUL_CLOSE because being in cleanup() means one of the following:\n// - All elements have been consumed already\n// - cancel() or abort() has been invoked after successful close().", "author": "trustin", "createdAt": "2020-02-27T12:08:42Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -402,6 +426,41 @@ private boolean setState(State oldState, State newState) {\n     }\n \n     private void cleanup() {\n-        cleanupQueue(subscription, queue);\n+        final Throwable cause = ClosedStreamException.get();\n+        for (;;) {\n+            final Object e = queue.poll();\n+            if (e == null) {\n+                break;\n+            }\n+\n+            try {\n+                // Just skip SUCCESSFUL_CLOSE because cancel() or abort() is called so\n+                // we need to handle the subscriber with the event.", "originalCommit": "29a99e716733e33177ae01f74313ac8e49f5aa16", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4Nzc3Mg==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385087772", "bodyText": "It's a lot better. Thanks!", "author": "minwoox", "createdAt": "2020-02-27T12:10:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA4NjcwOA=="}], "type": "inlineReview"}, {"oid": "94f83c268ed1058de89b594dff2812e72a416162", "url": "https://github.com/line/armeria/commit/94f83c268ed1058de89b594dff2812e72a416162", "message": "Address comments by @trustin", "committedDate": "2020-02-27T12:22:00Z", "type": "commit"}, {"oid": "8c6160b002bcc0e4acca8a7d75978fa7df6028e5", "url": "https://github.com/line/armeria/commit/8c6160b002bcc0e4acca8a7d75978fa7df6028e5", "message": "Lazy init cause", "committedDate": "2020-02-27T12:29:11Z", "type": "commit"}, {"oid": "a15371d5807b349c7c6202feb782cbab38d468f2", "url": "https://github.com/line/armeria/commit/a15371d5807b349c7c6202feb782cbab38d468f2", "message": "Fix indent", "committedDate": "2020-02-27T12:31:40Z", "type": "commit"}, {"oid": "06871eabb2a67fd8e9334f779fcf315a270a1d65", "url": "https://github.com/line/armeria/commit/06871eabb2a67fd8e9334f779fcf315a270a1d65", "message": "Add continue", "committedDate": "2020-02-27T12:35:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5ODk3OQ==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385098979", "bodyText": "There was a bug here. we should continue here. \ud83d\ude31", "author": "minwoox", "createdAt": "2020-02-27T12:36:14Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java", "diffHunk": "@@ -171,36 +170,6 @@ T prepareObjectForNotification(SubscriptionImpl subscription, T o) {\n         return o;\n     }\n \n-    /**\n-     * Helper method for the common case of cleaning up all elements in a queue when shutting down the stream.\n-     */\n-    void cleanupQueue(SubscriptionImpl subscription, Queue<Object> queue) {\n-        final Throwable cause = ClosedStreamException.get();\n-        for (;;) {\n-            final Object e = queue.poll();\n-            if (e == null) {\n-                break;\n-            }\n-\n-            try {\n-                if (e instanceof CloseEvent) {\n-                    notifySubscriberOfCloseEvent(subscription, (CloseEvent) e);\n-                    continue;\n-                }\n-\n-                if (e instanceof CompletableFuture) {\n-                    ((CompletableFuture<?>) e).completeExceptionally(cause);\n-                }", "originalCommit": "06871eabb2a67fd8e9334f779fcf315a270a1d65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a02e9cac4426a5fcda9b1201ba18ecceae20ccc", "url": "https://github.com/line/armeria/commit/1a02e9cac4426a5fcda9b1201ba18ecceae20ccc", "message": "call onComplete when stream message is empty", "committedDate": "2020-02-28T05:43:42Z", "type": "commit"}, {"oid": "869836191c85920c28bc055a80a26362336299a9", "url": "https://github.com/line/armeria/commit/869836191c85920c28bc055a80a26362336299a9", "message": "Fix", "committedDate": "2020-02-28T05:47:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUyMDY3OQ==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385520679", "bodyText": "Could be private?", "author": "ikhoon", "createdAt": "2020-02-28T06:01:53Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -194,44 +215,56 @@ private void doRequest(long n) {\n \n     @Override\n     void cancel() {\n-        cancelOrAbort(CancelledSubscriptionException.get());\n+        if (setState(State.OPEN, State.CLEANUP) || setState(State.CLOSED, State.CLEANUP)) {\n+            // It the state was CLOSED, close() or close(cause) has been called before cancel() or abort()\n+            // is called. We just ignore the previously pushed event and deal with CANCELLED_CLOSE.\n+            final SubscriptionImpl subscription = this.subscription;\n+            assert subscription != null;\n+            notifySubscriberOfCloseEvent(subscription, CANCELLED_CLOSE);\n+        }\n     }\n \n-    @Override\n     void notifySubscriberOfCloseEvent(SubscriptionImpl subscription, CloseEvent event) {\n-        // Always called from the subscriber thread.\n+        if (subscription.needsDirectInvocation()) {\n+            notifySubscriberOfCloseEvent0(subscription, event);\n+        } else {\n+            subscription.executor().execute(() -> notifySubscriberOfCloseEvent0(subscription, event));\n+        }\n+    }\n+\n+    void notifySubscriberOfCloseEvent0(SubscriptionImpl subscription, CloseEvent event) {", "originalCommit": "869836191c85920c28bc055a80a26362336299a9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUyMDc5Nw==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385520797", "bodyText": "Could be private?", "author": "ikhoon", "createdAt": "2020-02-28T06:02:32Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/DefaultStreamMessage.java", "diffHunk": "@@ -194,44 +215,56 @@ private void doRequest(long n) {\n \n     @Override\n     void cancel() {\n-        cancelOrAbort(CancelledSubscriptionException.get());\n+        if (setState(State.OPEN, State.CLEANUP) || setState(State.CLOSED, State.CLEANUP)) {\n+            // It the state was CLOSED, close() or close(cause) has been called before cancel() or abort()\n+            // is called. We just ignore the previously pushed event and deal with CANCELLED_CLOSE.\n+            final SubscriptionImpl subscription = this.subscription;\n+            assert subscription != null;\n+            notifySubscriberOfCloseEvent(subscription, CANCELLED_CLOSE);\n+        }\n     }\n \n-    @Override\n     void notifySubscriberOfCloseEvent(SubscriptionImpl subscription, CloseEvent event) {", "originalCommit": "869836191c85920c28bc055a80a26362336299a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUyMjE3Nw==", "url": "https://github.com/line/armeria/pull/2539#discussion_r385522177", "bodyText": "Fixed. :)", "author": "minwoox", "createdAt": "2020-02-28T06:09:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUyMDc5Nw=="}], "type": "inlineReview"}, {"oid": "9678bfcf808b76f87f20d3755f0840addadd4e0e", "url": "https://github.com/line/armeria/commit/9678bfcf808b76f87f20d3755f0840addadd4e0e", "message": "Add private", "committedDate": "2020-02-28T06:08:49Z", "type": "commit"}]}