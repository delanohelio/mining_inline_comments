{"pr_number": 2993, "pr_title": "Fix leaks in tests of DynamicBehaviorHandler and others", "pr_createdAt": "2020-08-13T04:19:17Z", "pr_url": "https://github.com/line/armeria/pull/2993", "timeline": [{"oid": "271b4dc653a564251600e12858ecf1d07261a548", "url": "https://github.com/line/armeria/commit/271b4dc653a564251600e12858ecf1d07261a548", "message": "Fix leaks in tests of DynamicBehaviorHandler and others\n\nMotivation:\n\nDynamicBehaviorHandler could cause unexpected leak problem base on the following scenario:\n1. Tests related to socks are finished successfully.\n2. The socks decoder tries to pass the remain `ByteBuf`s to a next handler.\n3. A test that is not related to socks changes a handler logic via DYNAMIC_HANDLER.setXXX().\n4. The data produced in 2) is passed to the handler made in 3).\n5. The new handler produces ClassCastException when receiving unexpected messages.\n\n```java\njava.lang.ClassCastException:\n  class io.netty.buffer.AdvancedLeakAwareByteBuf cannot be cast to\n  class io.netty.handler.codec.http.HttpRequest (io.netty.buffer.AdvancedLeakAwareByteBuf and io.netty.handler.codec.http.HttpRequest are in unnamed module of loader 'app')\n at com.linecorp.armeria.client.proxy.ProxyClientIntegrationTest.lambda$testHttpProxyUpgradeRequestFailure$0(ProxyClientIntegrationTest.java:387)\n```\n\nModifications:\n\n- Rename DynamicBehaviorHandler to SimpleChannelHandler and remove `@Shareable`\n- Add `SimpleChannelHandlerFactory` for creating a ChannelHandler easily.\n- Create `ChannelHandler` for every connection instead of mutating `DYNAMIC_BEHAVIOR` in proxy tests.\n- Miscellaneous\n  - Close `ClientFatory`s where they are not closed in test cases.\n\nResult:\n\n- Clean up various leaks in test cases", "committedDate": "2020-08-13T04:18:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY4ODcxNg==", "url": "https://github.com/line/armeria/pull/2993#discussion_r469688716", "bodyText": "Can't use closeAsync?", "author": "minwoox", "createdAt": "2020-08-13T04:24:42Z", "path": "spring/boot2-autoconfigure/src/test/java/com/linecorp/armeria/spring/LocalArmeriaPortHttpsTest.java", "diffHunk": "@@ -66,6 +69,11 @@ private String newUrl(String scheme) {\n         return scheme + \"://127.0.0.1:\" + port;\n     }\n \n+    @AfterClass\n+    public static void closeClientFactory() {\n+        CompletableFuture.runAsync(clientFactory::close);", "originalCommit": "271b4dc653a564251600e12858ecf1d07261a548", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY5NTMzMw==", "url": "https://github.com/line/armeria/pull/2993#discussion_r469695333", "bodyText": "Fixed. \ud83d\ude09", "author": "ikhoon", "createdAt": "2020-08-13T04:51:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTY4ODcxNg=="}], "type": "inlineReview"}, {"oid": "39aced01c08d368bc9a915e70b2cdc8901cbafcd", "url": "https://github.com/line/armeria/commit/39aced01c08d368bc9a915e70b2cdc8901cbafcd", "message": "Use 'clientFactory.closeAsync()' where possible", "committedDate": "2020-08-13T04:49:22Z", "type": "commit"}, {"oid": "0470d345401eee686848bb26d4c3973ccca0d220", "url": "https://github.com/line/armeria/commit/0470d345401eee686848bb26d4c3973ccca0d220", "message": "Revert changed in HttpClientMaxConcurrentStreamTest", "committedDate": "2020-08-13T04:56:46Z", "type": "commit"}, {"oid": "a40b4265188a18b1bc0275f4b6df69406e48f160", "url": "https://github.com/line/armeria/commit/a40b4265188a18b1bc0275f4b6df69406e48f160", "message": "Add default handler", "committedDate": "2020-08-13T05:55:29Z", "type": "commit"}, {"oid": "5166954f7f2abb9fd468ef2040204b507513c21f", "url": "https://github.com/line/armeria/commit/5166954f7f2abb9fd468ef2040204b507513c21f", "message": "Make SimpleChannelHandler public", "committedDate": "2020-08-13T07:29:21Z", "type": "commit"}]}