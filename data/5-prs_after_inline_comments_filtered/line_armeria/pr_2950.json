{"pr_number": 2950, "pr_title": "Fix a bug where gRPC message deframer is closed before writing respon\u2026", "pr_createdAt": "2020-07-30T14:58:12Z", "pr_url": "https://github.com/line/armeria/pull/2950", "timeline": [{"oid": "eb4e892c88f7b832a8ced34ed2ce3b91ace4ec94", "url": "https://github.com/line/armeria/commit/eb4e892c88f7b832a8ced34ed2ce3b91ace4ec94", "message": "Fix a bug where gRPC message deframer is closed before writing responses.\n\nMotivation:\n\n`HttpStreamReader.apply(Void, Throwable)` is called when a request is complete.\nIt tries to close the message deframer when the deframer is not closed or closing.\nBut this condition is not valid because the response could not be started yet.\n\nMotifications:\n- Let close a message deframer when it completes if closeDeframer is called.\n\nResult:\n\n- A gRPC-Kotlin sever handles blocking tasks with Coroutine properly\n- Fixes #2947", "committedDate": "2020-07-30T14:46:38Z", "type": "commit"}, {"oid": "804118184be9d656db7622d188f80fd8786e7871", "url": "https://github.com/line/armeria/commit/804118184be9d656db7622d188f80fd8786e7871", "message": "Clean up", "committedDate": "2020-07-30T15:06:44Z", "type": "commit"}, {"oid": "034a76e98209f6958c34e4cc505f948fd4449994", "url": "https://github.com/line/armeria/commit/034a76e98209f6958c34e4cc505f948fd4449994", "message": "Revert test case", "committedDate": "2020-07-30T15:13:29Z", "type": "commit"}, {"oid": "bfaa5714be7f047412b75c255843d3c1bc878856", "url": "https://github.com/line/armeria/commit/bfaa5714be7f047412b75c255843d3c1bc878856", "message": "Remove blank line", "committedDate": "2020-07-30T15:53:37Z", "type": "commit"}, {"oid": "0b3af6ff68fa974c83b5d57c57e292fdeecc6828", "url": "https://github.com/line/armeria/commit/0b3af6ff68fa974c83b5d57c57e292fdeecc6828", "message": "Update comment", "committedDate": "2020-07-31T05:18:05Z", "type": "commit"}, {"oid": "f4f0f82c26b68a761869fc80eb35bb289b954557", "url": "https://github.com/line/armeria/commit/f4f0f82c26b68a761869fc80eb35bb289b954557", "message": "Merge branch 'master' into lazy-close-deframer", "committedDate": "2020-08-03T03:33:57Z", "type": "commit"}, {"oid": "cda1795086dfba1005447948e817e342fa3571f4", "url": "https://github.com/line/armeria/commit/cda1795086dfba1005447948e817e342fa3571f4", "message": "Add 'inHalfClose' flag for scheduling a close event", "committedDate": "2020-08-03T03:51:25Z", "type": "commit"}, {"oid": "134612dee59f914f39d69738c0d645e9553e20d2", "url": "https://github.com/line/armeria/commit/134612dee59f914f39d69738c0d645e9553e20d2", "message": "Fix typo", "committedDate": "2020-08-03T03:53:51Z", "type": "commit"}, {"oid": "838703b0987e525b1bc8805d2e0021eb1fdc6037", "url": "https://github.com/line/armeria/commit/838703b0987e525b1bc8805d2e0021eb1fdc6037", "message": "Close ArmeriaClientCall when a gRPC client consumes all messages", "committedDate": "2020-08-03T08:31:12Z", "type": "commit"}, {"oid": "9f65fefa9d127f6b916299c7a708aa866b3af429", "url": "https://github.com/line/armeria/commit/9f65fefa9d127f6b916299c7a708aa866b3af429", "message": "Clean up", "committedDate": "2020-08-03T08:36:08Z", "type": "commit"}, {"oid": "36bbd9af2aa546f6bb2d03a8d13eaf8b87aa1b57", "url": "https://github.com/line/armeria/commit/36bbd9af2aa546f6bb2d03a8d13eaf8b87aa1b57", "message": "Update test case", "committedDate": "2020-08-03T08:42:11Z", "type": "commit"}, {"oid": "1cab4c5582708ea73347dbb9262ea61c1d7370b3", "url": "https://github.com/line/armeria/commit/1cab4c5582708ea73347dbb9262ea61c1d7370b3", "message": "Add more test cases", "committedDate": "2020-08-03T08:48:30Z", "type": "commit"}, {"oid": "2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f", "url": "https://github.com/line/armeria/commit/2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f", "message": "Address comments by @minwoox", "committedDate": "2020-08-03T09:02:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5ODQ5MQ==", "url": "https://github.com/line/armeria/pull/2950#discussion_r464298491", "bodyText": "Shouldn't we do this after cleanup the resources? which means at the end of this method?", "author": "minwoox", "createdAt": "2020-08-03T09:27:15Z", "path": "grpc-protocol/src/main/java/com/linecorp/armeria/common/grpc/protocol/ArmeriaMessageDeframer.java", "diffHunk": "@@ -317,6 +328,12 @@ public void closeWhenComplete() {\n      */\n     @Override\n     public void close() {\n+        if (whenClosed == null) {\n+            whenClosed = CLOSED_FUTURE;\n+        } else {\n+            whenClosed.doComplete();", "originalCommit": "2dc2cb2389c4dc3581ad2b2d7cbbc6d34434391f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM2NDA2OQ==", "url": "https://github.com/line/armeria/pull/2950#discussion_r464364069", "bodyText": "Fixed. :-)", "author": "ikhoon", "createdAt": "2020-08-03T11:50:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI5ODQ5MQ=="}], "type": "inlineReview"}, {"oid": "038573fd80f2055c0ef6f3158ffea5a0d41c1a64", "url": "https://github.com/line/armeria/commit/038573fd80f2055c0ef6f3158ffea5a0d41c1a64", "message": "Address comments by @minwoox", "committedDate": "2020-08-03T11:49:58Z", "type": "commit"}]}