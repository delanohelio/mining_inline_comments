{"pr_number": 3152, "pr_title": "Fix a bug where preflight request is handled by the irrelevant routeD\u2026", "pr_createdAt": "2020-11-03T12:53:22Z", "pr_url": "https://github.com/line/armeria/pull/3152", "timeline": [{"oid": "69f7dcf9c0d1556059715e66feb9fa89ba31fa6d", "url": "https://github.com/line/armeria/commit/69f7dcf9c0d1556059715e66feb9fa89ba31fa6d", "message": "Fix a bug where preflight request is handled by the irrelavant routeDecorator\nMotivation:\nRelated https://github.com/openzipkin/zipkin/pull/3239 and #3120\nThe preflight request should not be handled by the routeDecorator() if it's irrelevant.\n\nModifications:\n- Add `Route#apply(RoutingContext,boolean)` which takes an additional `routeDecoratingService` boolean parameter\n  - `DefaultRoute` does not modify `RoutingContext` and returns empty `RoutingResult` if the `RoutingContext` is not matched.\n\nResult:\n- You now get FORBIDDEN status if your service does not handle preflight requests regardless of the routeDecorator.", "committedDate": "2020-11-03T12:40:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MTY1MQ==", "url": "https://github.com/line/armeria/pull/3152#discussion_r516671651", "bodyText": "How about:\nIf {@code true}, an {@link HttpStatusException} will not be\n{@linkplain ...#deferStatusException... deferred} and {@linkplain ... preflight request}\nwill not be handled by this {@link Route}.", "author": "trustin", "createdAt": "2020-11-03T13:39:10Z", "path": "core/src/main/java/com/linecorp/armeria/server/Route.java", "diffHunk": "@@ -61,7 +61,35 @@ static RouteBuilder builder() {\n      * @see RouteBuilder#matchesHeaders(Iterable)\n      * @see RouteBuilder#matchesParams(Iterable)\n      */\n-    RoutingResult apply(RoutingContext routingCtx);\n+    default RoutingResult apply(RoutingContext routingCtx) {\n+        return apply(routingCtx, false);\n+    }\n+\n+    /**\n+     * Matches the specified {@link RoutingContext} and extracts the path parameters from it if exists.\n+     *\n+     * @param routingCtx a context to find the {@link HttpService}\n+     * @param routeDecoratingService tells whether this method is called in {@link RouteDecoratingService}.\n+     *                               If it's {@code true},\n+     *                               {@link RoutingContext#deferStatusException(HttpStatusException)} is not\n+     *                               set and {@link RoutingContext#isCorsPreflight() preflight request} is\n+     *                               not handled by this {@link Route}.", "originalCommit": "69f7dcf9c0d1556059715e66feb9fa89ba31fa6d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MzY0OQ==", "url": "https://github.com/line/armeria/pull/3152#discussion_r516673649", "bodyText": "RouteDecoratingService is an implementation detail; you're not supposed to mention it here. Javadoc will not hyperlink.\nHow about:\n@param isRouteDecorator {@code true} if this method is called for route decorators. \n                        {@code false} if this method is called for services.", "author": "trustin", "createdAt": "2020-11-03T13:42:10Z", "path": "core/src/main/java/com/linecorp/armeria/server/Route.java", "diffHunk": "@@ -61,7 +61,35 @@ static RouteBuilder builder() {\n      * @see RouteBuilder#matchesHeaders(Iterable)\n      * @see RouteBuilder#matchesParams(Iterable)\n      */\n-    RoutingResult apply(RoutingContext routingCtx);\n+    default RoutingResult apply(RoutingContext routingCtx) {\n+        return apply(routingCtx, false);\n+    }\n+\n+    /**\n+     * Matches the specified {@link RoutingContext} and extracts the path parameters from it if exists.\n+     *\n+     * @param routingCtx a context to find the {@link HttpService}\n+     * @param routeDecoratingService tells whether this method is called in {@link RouteDecoratingService}.", "originalCommit": "69f7dcf9c0d1556059715e66feb9fa89ba31fa6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2MjA3OQ==", "url": "https://github.com/line/armeria/pull/3152#discussion_r517062079", "bodyText": "Thanks fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-11-04T02:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3MzY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3NTIwMA==", "url": "https://github.com/line/armeria/pull/3152#discussion_r516675200", "bodyText": "Better deprecating and removing all references to this method?", "author": "trustin", "createdAt": "2020-11-03T13:44:31Z", "path": "core/src/main/java/com/linecorp/armeria/server/Route.java", "diffHunk": "@@ -61,7 +61,35 @@ static RouteBuilder builder() {\n      * @see RouteBuilder#matchesHeaders(Iterable)\n      * @see RouteBuilder#matchesParams(Iterable)\n      */\n-    RoutingResult apply(RoutingContext routingCtx);\n+    default RoutingResult apply(RoutingContext routingCtx) {", "originalCommit": "69f7dcf9c0d1556059715e66feb9fa89ba31fa6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzA2MjAyMg==", "url": "https://github.com/line/armeria/pull/3152#discussion_r517062022", "bodyText": "That's a good suggestion. Fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-11-04T02:21:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY3NTIwMA=="}], "type": "inlineReview"}, {"oid": "adad5da052dc9c509ede581ac45c3f53676ce898", "url": "https://github.com/line/armeria/commit/adad5da052dc9c509ede581ac45c3f53676ce898", "message": "Address comments by @trustin", "committedDate": "2020-11-04T02:23:02Z", "type": "commit"}, {"oid": "ef9883b71d915ad4237012da5ae65157d5b8150f", "url": "https://github.com/line/armeria/commit/ef9883b71d915ad4237012da5ae65157d5b8150f", "message": "Fix", "committedDate": "2020-11-04T02:24:47Z", "type": "commit"}]}