{"pr_number": 2875, "pr_title": "Hide over-exposed public APIs", "pr_createdAt": "2020-07-06T10:30:53Z", "pr_url": "https://github.com/line/armeria/pull/2875", "timeline": [{"oid": "d8b19fdb4a92a5657fbb869f6ca57c96971e45a6", "url": "https://github.com/line/armeria/commit/d8b19fdb4a92a5657fbb869f6ca57c96971e45a6", "message": "Hide over-expossed public APIs\n\nMotivation:\n\nChecked our public and internal API that has `public` modifier. See #2360\n\nModifications:\n\n- Mark public API with `@Deprecation` if it could be hided.\n- Move internal public API to non-internal package and remove public modifier if possible.\n- Deprecate\n  - `ArmeriaClientHttpConnector` has been deprecated in favor of\n    `ArmeriaClientAutoConfiguration.clientHttpConnector(List, DataBufferFactoryWrapper)`\n  - `ArmeriaWebServer` has been deprecated in favor of\n    `ArmeriaReactiveWebServerFactory.getWebServer(HttpHandler)`\n  - `ConnectionPoolLoggingListener` has been deprecated in favor of\n    `ConnectionPoolListener.loggingListener(...)`\n  - `Routers.ofCompostieService(...)` has been deprecated without a replacement.\n    Because `CompositeService` has beed deprecated already in #2740\n  - `StickyEndpointSelectionStrategy` has beed deprecated in favor of\n    `EndpointSelectionStrategy.sticky(ToLongFunction)`\n  - `TTextProtocol` has been deprecated in favor of\n    `TTextProtocolFactory.getProtocol(TTransport)`\n\nResult:\n\nHide implementation details", "committedDate": "2020-07-06T10:29:59Z", "type": "commit"}, {"oid": "50f68506c09f0c9f4cbf546da2381bf0a4b20046", "url": "https://github.com/line/armeria/commit/50f68506c09f0c9f4cbf546da2381bf0a4b20046", "message": "Clean up", "committedDate": "2020-07-06T10:36:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3MTg3MQ==", "url": "https://github.com/line/armeria/pull/2875#discussion_r450571871", "bodyText": "logging()?", "author": "trustin", "createdAt": "2020-07-07T02:07:31Z", "path": "core/src/main/java/com/linecorp/armeria/client/ConnectionPoolListener.java", "diffHunk": "@@ -33,6 +35,21 @@ static ConnectionPoolListener noop() {\n         return ConnectionPoolListenerAdapter.NOOP;\n     }\n \n+    /**\n+     * Returns a {@link ConnectionPoolListener} that logs the connection pool events.\n+     */\n+    static ConnectionPoolListener loggingListener() {", "originalCommit": "50f68506c09f0c9f4cbf546da2381bf0a4b20046", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3ODQ0NA==", "url": "https://github.com/line/armeria/pull/2875#discussion_r450578444", "bodyText": "\ud83d\udc4d", "author": "minwoox", "createdAt": "2020-07-07T02:32:54Z", "path": "core/src/main/java/com/linecorp/armeria/common/util/CompositeException.java", "diffHunk": "@@ -75,7 +75,7 @@\n      * list of suppressed exceptions.\n      * @param exceptions the Throwables to have as initially suppressed exceptions\n      *\n-     * @throws IllegalArgumentException if <code>exceptions</code> is empty.\n+     * @throws IllegalArgumentException if {@code exceptions} is empty.", "originalCommit": "50f68506c09f0c9f4cbf546da2381bf0a4b20046", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU3ODQ2Ng==", "url": "https://github.com/line/armeria/pull/2875#discussion_r450578466", "bodyText": "Thanks!", "author": "minwoox", "createdAt": "2020-07-07T02:33:03Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/StreamMessageDrainer.java", "diffHunk": "@@ -1,81 +0,0 @@\n-/*\n- * Copyright 2019 LINE Corporation\n- *\n- * LINE Corporation licenses this file to you under the Apache License,\n- * version 2.0 (the \"License\"); you may not use this file except in compliance\n- * with the License. You may obtain a copy of the License at:\n- *\n- *   https://www.apache.org/licenses/LICENSE-2.0\n- *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n- * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n- * License for the specific language governing permissions and limitations\n- * under the License.\n- */\n-\n-package com.linecorp.armeria.common.stream;\n-\n-import java.util.List;\n-import java.util.concurrent.CompletableFuture;\n-\n-import javax.annotation.Nullable;\n-\n-import org.reactivestreams.Subscriber;\n-import org.reactivestreams.Subscription;\n-\n-import com.google.common.collect.ImmutableList;\n-import com.google.common.collect.ImmutableList.Builder;\n-\n-import com.linecorp.armeria.common.util.EventLoopCheckingFuture;\n-\n-import io.netty.util.ReferenceCountUtil;\n-\n-final class StreamMessageDrainer<T> implements Subscriber<T> {", "originalCommit": "50f68506c09f0c9f4cbf546da2381bf0a4b20046", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MDAzOA==", "url": "https://github.com/line/armeria/pull/2875#discussion_r450580038", "bodyText": "It seems like we have one more constructor to deprecate at line 85.", "author": "minwoox", "createdAt": "2020-07-07T02:39:53Z", "path": "spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaClientHttpConnector.java", "diffHunk": "@@ -58,7 +65,11 @@ public ArmeriaClientHttpConnector() {\n      * {@link ArmeriaClientConfigurator} and the default {@link DataBufferFactoryWrapper}.\n      *\n      * @param configurator the configurator to be used to build an {@link WebClient}\n+     *\n+     * @deprecated Use\n+     *             {@link ArmeriaClientAutoConfiguration#clientHttpConnector(List, DataBufferFactoryWrapper)}.\n      */\n+    @Deprecated\n     public ArmeriaClientHttpConnector(ArmeriaClientConfigurator configurator) {", "originalCommit": "50f68506c09f0c9f4cbf546da2381bf0a4b20046", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MDM5NQ==", "url": "https://github.com/line/armeria/pull/2875#discussion_r450580395", "bodyText": "Should we add a static method to ArmeriaClientAutoConfiguration that takes no parameters?", "author": "minwoox", "createdAt": "2020-07-07T02:41:14Z", "path": "spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaClientHttpConnector.java", "diffHunk": "@@ -48,7 +51,11 @@\n     /**\n      * Creates an {@link ArmeriaClientHttpConnector} with the default {@link ArmeriaClientConfigurator} and\n      * {@link DataBufferFactoryWrapper}.\n+     *\n+     * @deprecated Use\n+     *             {@link ArmeriaClientAutoConfiguration#clientHttpConnector(List, DataBufferFactoryWrapper)}.", "originalCommit": "50f68506c09f0c9f4cbf546da2381bf0a4b20046", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4OTExMw==", "url": "https://github.com/line/armeria/pull/2875#discussion_r450589113", "bodyText": "ArmeriaClientAutoConfiguration is a configuration bean. I don't think we need to offer another bean for ClientHttpConnector with @Qualifier. \ud83e\udd14", "author": "ikhoon", "createdAt": "2020-07-07T03:17:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MDM5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4OTgyMA==", "url": "https://github.com/line/armeria/pull/2875#discussion_r450589820", "bodyText": "Ah, we don't. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-07-07T03:21:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDU4MDM5NQ=="}], "type": "inlineReview"}, {"oid": "3ab7f446c4ca7d9f22c6f975d9bda430ad34d0a1", "url": "https://github.com/line/armeria/commit/3ab7f446c4ca7d9f22c6f975d9bda430ad34d0a1", "message": "Address comments by @minwoox and @trustin", "committedDate": "2020-07-07T03:19:34Z", "type": "commit"}, {"oid": "6eda002560625f2b2745d81f30aabab384751b52", "url": "https://github.com/line/armeria/commit/6eda002560625f2b2745d81f30aabab384751b52", "message": "Checkstyle", "committedDate": "2020-07-08T02:48:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MTU2MQ==", "url": "https://github.com/line/armeria/pull/2875#discussion_r451251561", "bodyText": "Would you mind reverting this so that #2882 has no conflict?", "author": "trustin", "createdAt": "2020-07-08T02:49:51Z", "path": "core/src/main/java/com/linecorp/armeria/common/HttpRequestDuplicator.java", "diffHunk": "@@ -43,9 +43,9 @@\n  * after all subscriptions are done. If you want to stop publishing and clean up the resources immediately,\n  * call {@link #abort()}. If you do none of these, memory leak might happen.</p>\n  *\n- * <p>If you subscribe to the {@linkplain #duplicate() duplicated http request} with the\n- * {@link SubscriptionOption#WITH_POOLED_OBJECTS}, the published elements can be shared across\n- * {@link Subscriber}s. So do not manipulate the data unless you copy them.\n+ * <p>If you subscribe to the {@linkplain #duplicate() duplicated http request} using the\n+ * {@link PooledStreamMessage#subscribeWithPooledObjects(Subscriber)} or its variants, the published elements\n+ * can be shared across {@link Subscriber}s. So do not manipulate the data unless you copy them.", "originalCommit": "6eda002560625f2b2745d81f30aabab384751b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MTYyMw==", "url": "https://github.com/line/armeria/pull/2875#discussion_r451251623", "bodyText": "Ditto", "author": "trustin", "createdAt": "2020-07-08T02:50:03Z", "path": "core/src/main/java/com/linecorp/armeria/common/HttpResponseDuplicator.java", "diffHunk": "@@ -43,9 +43,9 @@\n  * after all subscriptions are done. If you want to stop publishing and clean up the resources immediately,\n  * call {@link #abort()}. If you do none of these, memory leak might happen.</p>\n  *\n- * <p>If you subscribe to the {@linkplain #duplicate() duplicated http response} with the\n- * {@link SubscriptionOption#WITH_POOLED_OBJECTS}, the published elements can be shared across\n- * {@link Subscriber}s. So do not manipulate the data unless you copy them.\n+ * <p>If you subscribe to the {@linkplain #duplicate() duplicated http response} using the\n+ * {@link PooledStreamMessage#subscribeWithPooledObjects(Subscriber)} or its variants, the published elements\n+ * can be shared across {@link Subscriber}s. So do not manipulate the data unless you copy them.", "originalCommit": "6eda002560625f2b2745d81f30aabab384751b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MTcxNQ==", "url": "https://github.com/line/armeria/pull/2875#discussion_r451251715", "bodyText": "Ditto", "author": "trustin", "createdAt": "2020-07-08T02:50:22Z", "path": "core/src/main/java/com/linecorp/armeria/common/stream/StreamMessageDuplicator.java", "diffHunk": "@@ -45,9 +46,9 @@\n  * after all subscriptions are done. If you want to stop publishing and clean up the resources immediately,\n  * call {@link #abort()}. If you do none of these, memory leak might happen.</p>\n  *\n- * <p>If you subscribe to the {@linkplain #duplicate() duplicated stream message} with the\n- * {@link SubscriptionOption#WITH_POOLED_OBJECTS}, the published elements can be shared across\n- * {@link Subscriber}s. So do not manipulate the data unless you copy them.\n+ * <p>If you subscribe to the {@linkplain #duplicate() duplicated stream message} using the\n+ * {@link PooledStreamMessage#subscribeWithPooledObjects(Subscriber)} or its variants, the published elements\n+ * can be shared across {@link Subscriber}s. So do not manipulate the data unless you copy them.", "originalCommit": "6eda002560625f2b2745d81f30aabab384751b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MTkzMQ==", "url": "https://github.com/line/armeria/pull/2875#discussion_r451251931", "bodyText": "This class is actually meant for use by users as well. e.g. A user might want to check if a certain host has no support for H2.", "author": "trustin", "createdAt": "2020-07-08T02:51:16Z", "path": "core/src/main/java/com/linecorp/armeria/internal/client/SessionProtocolNegotiationCache.java", "diffHunk": "@@ -14,7 +14,7 @@\n  * under the License.\n  */\n \n-package com.linecorp.armeria.client;\n+package com.linecorp.armeria.internal.client;", "originalCommit": "6eda002560625f2b2745d81f30aabab384751b52", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MzAzMw==", "url": "https://github.com/line/armeria/pull/2875#discussion_r451253033", "bodyText": "Ah I see, Let me revert this.", "author": "ikhoon", "createdAt": "2020-07-08T02:55:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MTkzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTI1MjE5Nw==", "url": "https://github.com/line/armeria/pull/2875#discussion_r451252197", "bodyText": "\ud83d\ude47", "author": "trustin", "createdAt": "2020-07-08T02:51:57Z", "path": "core/src/main/java/com/linecorp/armeria/server/file/HttpFileAttributes.java", "diffHunk": "@@ -28,7 +29,7 @@\n /**\n  * The attributes of an {@link HttpFile}.\n  *\n- * @see HttpFile#readAttributes()\n+ * @see HttpFile#readAttributes(Executor)", "originalCommit": "6eda002560625f2b2745d81f30aabab384751b52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "fc1f302e3eb278951d1b20c3142f247a46f9a30c", "url": "https://github.com/line/armeria/commit/fc1f302e3eb278951d1b20c3142f247a46f9a30c", "message": "Address comments by @trustin", "committedDate": "2020-07-08T03:16:10Z", "type": "commit"}, {"oid": "6c1af7e2aa3aae4e9e18ef79e4184d0e8de95895", "url": "https://github.com/line/armeria/commit/6c1af7e2aa3aae4e9e18ef79e4184d0e8de95895", "message": "Add super to `ToLongFunction`", "committedDate": "2020-07-08T03:21:26Z", "type": "commit"}]}