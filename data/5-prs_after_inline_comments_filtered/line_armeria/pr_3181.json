{"pr_number": 3181, "pr_title": "Fix a bug where HealthCheckedEndpointGroup.endpoints() is not set", "pr_createdAt": "2020-11-16T13:22:04Z", "pr_url": "https://github.com/line/armeria/pull/3181", "timeline": [{"oid": "9c8e805b7589e97bd24be16411525383e37a033e", "url": "https://github.com/line/armeria/commit/9c8e805b7589e97bd24be16411525383e37a033e", "message": "Fix a bug wheren HealthCheckedEndpointGroup.endpoints() is not set\nMotivation:\nWhen `EndpointGroup.orElse(...)` is used and the endpoint group is wrapped by `HealthCheckedEndpointGroup`,\nthere's a chance that endpoints are not set forever in this situation:\n1. `OrELseEndpointGroup.whenReady()` is completed with the second endpoint group.\n2. The first `EndpointGroup.setEndpoints(...)` are called.\n3. `HealthCheckedEndpointGroup` is created.\nIn this case, the health check reqeusts are sent to the second endpoint group to filter unhealthy endpoints.\nHowever, because `OrELseEndpointGroup.endpoints()` returns the endpoint group in first, there's always no matching.\n\nModifications:\n- Use `delegate.endpoint()` instead of `delegate.whenReady().join()`.\n\nResult:\n- `HealthCheckedEndpointGroup.endpoints()` now returns healthy endpoints when `EndpointGroup.orElse(...)` is used.", "committedDate": "2020-11-16T13:20:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4ODIxMg==", "url": "https://github.com/line/armeria/pull/3181#discussion_r524788212", "bodyText": "Seems it is better to leave a comment the reason why we cannot use the result of delegate.whenReady().join()?", "author": "imasahiro", "createdAt": "2020-11-17T00:08:36Z", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckedEndpointGroup.java", "diffHunk": "@@ -139,7 +139,8 @@ public static HealthCheckedEndpointGroupBuilder builder(EndpointGroup delegate,\n \n         clientOptions.factory().whenClosed().thenRun(this::closeAsync);\n         delegate.addListener(this::updateCandidates);\n-        updateCandidates(delegate.whenReady().join());\n+        delegate.whenReady().join();\n+        updateCandidates(delegate.endpoints());", "originalCommit": "9c8e805b7589e97bd24be16411525383e37a033e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDgxNDgwMA==", "url": "https://github.com/line/armeria/pull/3181#discussion_r524814800", "bodyText": "Added. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-11-17T00:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4ODIxMg=="}], "type": "inlineReview"}, {"oid": "121d3a3ca2b7ebd252b2499a5c68247efc3105e1", "url": "https://github.com/line/armeria/commit/121d3a3ca2b7ebd252b2499a5c68247efc3105e1", "message": "Add comments", "committedDate": "2020-11-17T00:55:57Z", "type": "commit"}, {"oid": "752623c40c010e531c83fa52370a0ce4f138a4ff", "url": "https://github.com/line/armeria/commit/752623c40c010e531c83fa52370a0ce4f138a4ff", "message": "Add LazyList", "committedDate": "2020-11-17T03:40:15Z", "type": "commit"}, {"oid": "135ed0195dace011a64b855b9ac89b9f15bc5b90", "url": "https://github.com/line/armeria/commit/135ed0195dace011a64b855b9ac89b9f15bc5b90", "message": "Fix", "committedDate": "2020-11-17T03:42:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkzNjgzOQ==", "url": "https://github.com/line/armeria/pull/3181#discussion_r525936839", "bodyText": "How about extends Guava's ForwardingList instead of implementing List?\nI think we can reduce the overall code size with the same result. \ud83d\ude09\nFor example:\nfinal class LazyList<E> extends ForwardingList<E> {\n    @Override\n    protected List<E> delegate() {\n        final List<E> delegate = this.delegate;\n        if (delegate != null) {\n            return delegate;\n        }\n\n        final List<E> supplied = ImmutableList.copyOf(delegateSupplier.get());\n        if (delegateUpdater.compareAndSet(this, null, supplied)) {\n            return supplied;\n        } else {\n            return this.delegate;\n        }\n    }\n\n    // Override unwanted methods\n    @Override\n    public void add(int index, E element) {\n        throw new UnsupportedOperationException();\n    }\n    ...\n}", "author": "ikhoon", "createdAt": "2020-11-18T09:29:52Z", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/LazyList.java", "diffHunk": "@@ -0,0 +1,240 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.endpoint;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.ListIterator;\n+import java.util.concurrent.atomic.AtomicReferenceFieldUpdater;\n+import java.util.function.Supplier;\n+\n+import javax.annotation.Nullable;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+final class LazyList<E> implements List<E> {", "originalCommit": "135ed0195dace011a64b855b9ac89b9f15bc5b90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk0MTc2MQ==", "url": "https://github.com/line/armeria/pull/3181#discussion_r525941761", "bodyText": "That's a good suggestion. \ud83d\udc4d", "author": "minwoox", "createdAt": "2020-11-18T09:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkzNjgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU1ODE3Mw==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526558173", "bodyText": "@ikhoon Fixed. \ud83d\ude09\nFYI, I didn't override the mutable methods because they throw exceptions in the implementation anyway.", "author": "minwoox", "createdAt": "2020-11-19T02:49:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkzNjgzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU2MTEyNA==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526561124", "bodyText": "FYI, I didn't override the mutable methods because they throw exceptions in the implementation anyway.\n\nAh. you are right. \ud83e\udd23", "author": "ikhoon", "createdAt": "2020-11-19T02:59:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkzNjgzOQ=="}], "type": "inlineReview"}, {"oid": "f4a5963db80a30d6892d023799f640a64e2c1f36", "url": "https://github.com/line/armeria/commit/f4a5963db80a30d6892d023799f640a64e2c1f36", "message": "Address the comment by @ikhoon", "committedDate": "2020-11-19T02:48:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4NDM0Nw==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526584347", "bodyText": "Flaky -> Race?\nCould you add a Javadoc that explains what race condition this test tries to test?", "author": "trustin", "createdAt": "2020-11-19T04:19:18Z", "path": "core/src/test/java/com/linecorp/armeria/client/endpoint/healthcheck/HealthCheckEndpointGroupFlakyTest.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.client.endpoint.healthcheck;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.awaitility.Awaitility.await;\n+\n+import java.util.concurrent.TimeUnit;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.RegisterExtension;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+import com.linecorp.armeria.client.WebClient;\n+import com.linecorp.armeria.client.endpoint.DynamicEndpointGroup;\n+import com.linecorp.armeria.client.endpoint.EndpointGroup;\n+import com.linecorp.armeria.common.HttpResponse;\n+import com.linecorp.armeria.common.HttpStatus;\n+import com.linecorp.armeria.common.SessionProtocol;\n+import com.linecorp.armeria.server.ServerBuilder;\n+import com.linecorp.armeria.server.healthcheck.HealthCheckService;\n+import com.linecorp.armeria.testing.junit5.server.ServerExtension;\n+\n+class HealthCheckEndpointGroupFlakyTest {", "originalCommit": "f4a5963db80a30d6892d023799f640a64e2c1f36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYxMTU1Nw==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526611557", "bodyText": "Added. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-11-19T05:56:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4NDM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4NDUwNw==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526584507", "bodyText": "Could you add a comment about why we're not using EventLoopCheckingFuture here?", "author": "trustin", "createdAt": "2020-11-19T04:19:49Z", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/DynamicEndpointGroup.java", "diffHunk": "@@ -52,8 +51,9 @@\n     private final AtomicReference<EndpointSelector> selector = new AtomicReference<>();\n     private volatile List<Endpoint> endpoints = UNINITIALIZED_ENDPOINTS;\n     private final Lock endpointsLock = new ReentrantLock();\n-    private final CompletableFuture<List<Endpoint>> initialEndpointsFuture =\n-            new EventLoopCheckingFuture<>();\n+\n+    private final CompletableFuture<Void> initialEndpointsSet = new CompletableFuture<>();", "originalCommit": "f4a5963db80a30d6892d023799f640a64e2c1f36", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYxMTY4Nw==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526611687", "bodyText": "Changed to use EventLoopCheckingFuture for all dynamic endpoint group. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-11-19T05:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4NDUwNw=="}], "type": "inlineReview"}, {"oid": "42023b74c93e8fcebee8486582d1e6e3c13c1a4a", "url": "https://github.com/line/armeria/commit/42023b74c93e8fcebee8486582d1e6e3c13c1a4a", "message": "Address the comment by @trustin", "committedDate": "2020-11-19T05:54:30Z", "type": "commit"}, {"oid": "25196e1d9b302568fdcafac2a8b17d20fcdb3e4b", "url": "https://github.com/line/armeria/commit/25196e1d9b302568fdcafac2a8b17d20fcdb3e4b", "message": "Use thenAccept", "committedDate": "2020-11-19T06:09:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYxODQ2Nw==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526618467", "bodyText": "What happens if the future returned by anyOf() completes exceptionally?", "author": "trustin", "createdAt": "2020-11-19T06:17:33Z", "path": "core/src/main/java/com/linecorp/armeria/client/endpoint/CompositeEndpointGroup.java", "diffHunk": "@@ -67,11 +68,12 @@\n             });\n         }\n \n-        initialEndpointsFuture =\n-                CompletableFuture.anyOf(this.endpointGroups.stream()\n-                                                           .map(EndpointGroup::whenReady)\n-                                                           .toArray(CompletableFuture[]::new))\n-                                 .thenApply(unused -> endpoints());\n+        CompletableFuture.anyOf(this.endpointGroups.stream()\n+                                                   .map(EndpointGroup::whenReady)\n+                                                   .toArray(CompletableFuture[]::new))\n+                         .thenAccept(unused -> {\n+                             initialEndpointsFuture.complete(new LazyList<>(this::endpoints));", "originalCommit": "25196e1d9b302568fdcafac2a8b17d20fcdb3e4b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMTQ2Mg==", "url": "https://github.com/line/armeria/pull/3181#discussion_r526621462", "bodyText": "Thanks fixed. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-11-19T06:25:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYxODQ2Nw=="}], "type": "inlineReview"}, {"oid": "80d52bdf96de321e16f0da155962af0ded53fd2f", "url": "https://github.com/line/armeria/commit/80d52bdf96de321e16f0da155962af0ded53fd2f", "message": "Address comment by @trustin", "committedDate": "2020-11-19T06:25:11Z", "type": "commit"}, {"oid": "99ed0c1c2edf6e30d905e6c9a9c504f5293f0945", "url": "https://github.com/line/armeria/commit/99ed0c1c2edf6e30d905e6c9a9c504f5293f0945", "message": "cleanup", "committedDate": "2020-11-19T06:29:59Z", "type": "commit"}, {"oid": "023d6d7ed2c7cf518e63141698559e5584201c13", "url": "https://github.com/line/armeria/commit/023d6d7ed2c7cf518e63141698559e5584201c13", "message": "Checkstyle", "committedDate": "2020-11-19T08:53:42Z", "type": "commit"}, {"oid": "46f8060f1464572918fe5d317d0b89b9cfe751a0", "url": "https://github.com/line/armeria/commit/46f8060f1464572918fe5d317d0b89b9cfe751a0", "message": "Fix check style", "committedDate": "2020-11-19T09:47:19Z", "type": "commit"}]}