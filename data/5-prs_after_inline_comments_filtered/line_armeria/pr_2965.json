{"pr_number": 2965, "pr_title": "Ignore CancelledSubscription when handling HTTP HEAD", "pr_createdAt": "2020-08-03T14:17:24Z", "pr_url": "https://github.com/line/armeria/pull/2965", "timeline": [{"oid": "108010745f9118a00a597319cd07cc9af6538900", "url": "https://github.com/line/armeria/commit/108010745f9118a00a597319cd07cc9af6538900", "message": "Fix not to propagate CancelledSubscription when handling HTTP HEAD", "committedDate": "2020-08-03T14:20:11Z", "type": "forcePushed"}, {"oid": "5f71647c5c65981825b4982d3f09b44472099ade", "url": "https://github.com/line/armeria/commit/5f71647c5c65981825b4982d3f09b44472099ade", "message": "Fix not to generate CancelledSubscription when handling HTTP HEAD", "committedDate": "2020-08-03T14:21:13Z", "type": "forcePushed"}, {"oid": "ef164fc58b2396e2848bb74f6d5e59cf2ca6c61b", "url": "https://github.com/line/armeria/commit/ef164fc58b2396e2848bb74f6d5e59cf2ca6c61b", "message": "Fix not to generate CancelledSubscription when handling HTTP HEAD", "committedDate": "2020-08-03T14:23:20Z", "type": "forcePushed"}, {"oid": "a2b7f3cb48a0194ffa870531b1454a087e02d037", "url": "https://github.com/line/armeria/commit/a2b7f3cb48a0194ffa870531b1454a087e02d037", "message": "Fix not to generate CancelledSubscription when handling HTTP HEAD", "committedDate": "2020-08-04T02:06:44Z", "type": "commit"}, {"oid": "a2b7f3cb48a0194ffa870531b1454a087e02d037", "url": "https://github.com/line/armeria/commit/a2b7f3cb48a0194ffa870531b1454a087e02d037", "message": "Fix not to generate CancelledSubscription when handling HTTP HEAD", "committedDate": "2020-08-04T02:06:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc2NDIwNw==", "url": "https://github.com/line/armeria/pull/2965#discussion_r464764207", "bodyText": "I wanted to assert that HttpWebHandlerAdapter#handleUnresolvedError is never invoked due to CancelledSubscriptionException,\nbut couldn't find an appropriate way to test it...\n(I looked for a way to test logEvent of HttpWebHandlerAdapter's log, but failed to do that)\nIt would be very helpful if I can get some advices here", "author": "eunchan-kim", "createdAt": "2020-08-04T02:37:08Z", "path": "spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ReactiveWebServerLoadBalancerInteropTest.java", "diffHunk": "@@ -46,46 +54,91 @@\n     static class TestConfiguration {\n         @RestController\n         static class TestController {\n-            @GetMapping(\"/api/ping\")\n+            @GetMapping(\"/controller/api/ping\")\n             Mono<String> ping() {\n                 return Mono.just(\"PONG\");\n             }\n         }\n+\n+        @Bean\n+        RouterFunction<ServerResponse> routerFunction() {\n+            return route(GET(\"/router/api/poke\"), request -> ok().build())\n+                    .and(route(HEAD(\"/router/api/poke\"), request -> ok().build()))\n+                    .and(route(HEAD(\"/router/api/ping\"), request -> ok().body(fromValue(\"PONG\"))));\n+        }\n     }\n \n     @LocalServerPort\n     int port;\n \n     @Test\n-    void get() throws Exception {\n-        try (Socket s = new Socket(NetUtil.LOCALHOST4, port)) {\n-            s.setSoTimeout(10000);\n-            final InputStream in = s.getInputStream();\n-            final OutputStream out = s.getOutputStream();\n-            out.write(\"GET /api/ping HTTP/1.0\\r\\n\\r\\n\".getBytes(StandardCharsets.US_ASCII));\n-\n-            // Should not be chunked.\n-            assertThat(new String(ByteStreams.toByteArray(in))).isEqualTo(\n-                    \"HTTP/1.1 200 OK\\r\\n\" +\n-                    \"content-type: text/plain;charset=UTF-8\\r\\n\" +\n-                    \"content-length: 4\\r\\n\\r\\n\" +\n-                    \"PONG\");\n-        }\n+    void getToController() throws Exception {\n+        // TODO: Need to assert that CancelledSubscriptionException is not propagated to HttpWebHandlerAdapter", "originalCommit": "a2b7f3cb48a0194ffa870531b1454a087e02d037", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4MzM1MQ==", "url": "https://github.com/line/armeria/pull/2965#discussion_r464783351", "bodyText": "GET and HEAD request can have a body, although it's not used often, so this fix is not correct. We should perhaps touch the WebFlux side.", "author": "trustin", "createdAt": "2020-08-04T03:53:50Z", "path": "core/src/main/java/com/linecorp/armeria/server/HttpResponseSubscriber.java", "diffHunk": "@@ -155,9 +155,7 @@ public void onNext(HttpObject o) {\n                     }\n                     merged = headers;\n                 } else {\n-                    if (req.method() == HttpMethod.HEAD) {\n-                        endOfStream = true;", "originalCommit": "a2b7f3cb48a0194ffa870531b1454a087e02d037", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4NDM0NQ==", "url": "https://github.com/line/armeria/pull/2965#discussion_r464784345", "bodyText": "Ah, never mind.", "author": "trustin", "createdAt": "2020-08-04T03:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4MzM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgwNzA1NA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r464807054", "bodyText": "Oh I couldn't get the relation between\n\nGET and HEAD request can have a body\n\nand this fix...\nCould you explain about this a little bit more?\nI thought whether a HEAD request has a body or not does not matter\nbecause it's about handling response for HEAD - cancel subscription for response when response publishes body.\nOh I missed your new comment \ud83d\ude05", "author": "eunchan-kim", "createdAt": "2020-08-04T05:25:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4MzM1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDg2NDMzNA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r464864334", "bodyText": "No worries. My bad \ud83d\ude05", "author": "trustin", "createdAt": "2020-08-04T07:48:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDc4MzM1MQ=="}], "type": "inlineReview"}, {"oid": "3f646e85b50d016b6e665c1ec6f3f5ca061b67f4", "url": "https://github.com/line/armeria/commit/3f646e85b50d016b6e665c1ec6f3f5ca061b67f4", "message": "Additional test cases for HEAD with H1C and H2C", "committedDate": "2020-08-05T07:59:54Z", "type": "commit"}, {"oid": "6cfdf9ce11972a763669357d8ed96d4ea4ed9711", "url": "https://github.com/line/armeria/commit/6cfdf9ce11972a763669357d8ed96d4ea4ed9711", "message": "Let ArmeriaServerHttpResponse ignore CancelledSubscriptionException", "committedDate": "2020-08-05T08:00:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTY2OA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r465635668", "bodyText": "Don't we need to check ctx.request().method() == HttpMethod.HEAD?", "author": "ikhoon", "createdAt": "2020-08-05T10:43:24Z", "path": "spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaServerHttpResponse.java", "diffHunk": "@@ -287,7 +287,18 @@ public HttpHeaders getHeaders() {\n         final HttpResponse response = HttpResponse.of(buildResponseHeaders());\n         future.complete(response);\n         logger.debug(\"{} Response future has been completed with an HttpResponse\", ctx);\n-        return Mono.fromFuture(response.whenComplete());\n+\n+        final CompletableFuture<Void> monoFuture = new CompletableFuture<>();\n+        response.whenComplete().handle((unused, cause1) -> {\n+            if (cause1 != null && !(cause1 instanceof CancelledSubscriptionException)) {\n+                monoFuture.completeExceptionally(cause1);\n+            } else {\n+                // ignore CancelledSubscriptionException created when handling HTTP HEAD request", "originalCommit": "6cfdf9ce11972a763669357d8ed96d4ea4ed9711", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTY0MDU3NA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r465640574", "bodyText": "I will check HEAD too!", "author": "eunchan-kim", "createdAt": "2020-08-05T10:53:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5NzAzNw==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466097037", "bodyText": "Had chat with @minwoox and I realized that HEAD is not to be checked here.\n@eunchan-kim Sorry for the wrong direction. Could you remove ctx.request().method() == HttpMethod.HEAD condition. \ud83d\ude47\u200d\u2642\ufe0f", "author": "ikhoon", "createdAt": "2020-08-06T01:44:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjA5OTMxOQ==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466099319", "bodyText": "No problem.\nBTW, could you share the backgrounds of this?\n\nI realized that HEAD is not to be checked here.\n\n(I think it would be same reason with that of not checking HEAD at write method...)", "author": "eunchan-kim", "createdAt": "2020-08-06T01:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjExMDQ1NA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466110454", "bodyText": "The cancel signal is used when a Subscriber wants to clean up resources and it does not need data anymore. The publisher doesn't propagate a CancelledSubscriptionException to Subscribe.onError(Throwable). CancelledSubscriptionException is used internally to indicate that a stream has been cancelled via whenComplete().\n\n  \n    \n      armeria/core/src/main/java/com/linecorp/armeria/common/stream/AbstractStreamMessage.java\n    \n    \n        Lines 279 to 282\n      in\n      0bb591d\n    \n    \n    \n    \n\n        \n          \n           if (subscription.notifyCancellation || !(cause instanceof CancelledSubscriptionException)) { \n        \n\n        \n          \n               subscriber.onError(cause); \n        \n\n        \n          \n           } \n        \n\n        \n          \n           completionFuture.completeExceptionally(cause); \n        \n    \n  \n\n\nSo the CancelledSubscriptionException from the whenComplete() could be ignored.", "author": "ikhoon", "createdAt": "2020-08-06T02:35:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTY2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjExMjM4OA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466112388", "bodyText": "thanks for explanation! \ud83d\udc4d", "author": "eunchan-kim", "createdAt": "2020-08-06T02:42:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYzNTY2OA=="}], "type": "inlineReview"}, {"oid": "27fb366d5ec7cb22de93409e40e3affde411b00b", "url": "https://github.com/line/armeria/commit/27fb366d5ec7cb22de93409e40e3affde411b00b", "message": "Let ArmeriaServerHttpResponse ignore CancelledSubscriptionException for HEAD", "committedDate": "2020-08-05T11:09:22Z", "type": "forcePushed"}, {"oid": "6e0dbc34e9a617176eb1027e3355e5a8f2e43163", "url": "https://github.com/line/armeria/commit/6e0dbc34e9a617176eb1027e3355e5a8f2e43163", "message": "Let ArmeriaServerHttpResponse ignore CancelledSubscriptionException for HEAD", "committedDate": "2020-08-05T11:10:57Z", "type": "forcePushed"}, {"oid": "23d8ff8fbd9ce1f446fe94a6e98d73f93ab2013d", "url": "https://github.com/line/armeria/commit/23d8ff8fbd9ce1f446fe94a6e98d73f93ab2013d", "message": "Let ArmeriaServerHttpResponse ignore CancelledSubscriptionException", "committedDate": "2020-08-06T02:35:31Z", "type": "forcePushed"}, {"oid": "e028eee0def72a380bac1ce16f27d4d2138bb6fc", "url": "https://github.com/line/armeria/commit/e028eee0def72a380bac1ce16f27d4d2138bb6fc", "message": "Let ArmeriaServerHttpResponse ignore CancelledSubscriptionException", "committedDate": "2020-08-06T03:03:11Z", "type": "commit"}, {"oid": "e028eee0def72a380bac1ce16f27d4d2138bb6fc", "url": "https://github.com/line/armeria/commit/e028eee0def72a380bac1ce16f27d4d2138bb6fc", "message": "Let ArmeriaServerHttpResponse ignore CancelledSubscriptionException", "committedDate": "2020-08-06T03:03:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjExOTcxNQ==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466119715", "bodyText": "nit: extra space in { }.", "author": "minwoox", "createdAt": "2020-08-06T03:12:22Z", "path": "spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaServerHttpResponseTest.java", "diffHunk": "@@ -171,6 +172,30 @@ void returnHeadersAndBody() throws Exception {\n         await().until(() -> httpResponse.whenComplete().isDone());\n     }\n \n+    @Test\n+    void ignoreCancelledSubscriptionException() throws Exception {\n+        final ServiceRequestContext ctx = ServiceRequestContext.of(HttpRequest.of(HttpMethod.HEAD, \"/\"));\n+\n+        final CompletableFuture<HttpResponse> future = new CompletableFuture<>();\n+        final ArmeriaServerHttpResponse response = response(ctx, future);\n+\n+        response.setStatusCode(HttpStatus.OK);\n+        response.getHeaders().add(\"Armeria\", \"awesome\");\n+        assertThat(future.isDone()).isFalse();\n+\n+        StepVerifier.create(Mono.defer(response::setComplete))\n+                    .then(() -> {\n+                        try {\n+                            // throw CancelledSubscriptionException as HttpResponseSubscriber\n+                            // cancels subscription for HTTP HEAD\n+                            final HttpResponse httpResponse = future.get();\n+                            httpResponse.whenComplete()\n+                                        .completeExceptionally(CancelledSubscriptionException.get());\n+                        } catch (Throwable ignored) { }", "originalCommit": "e028eee0def72a380bac1ce16f27d4d2138bb6fc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEyMzY1Nw==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466123657", "bodyText": "when I make it as {} Checkstype fails with\n WhitespaceAround: '{' is not followed by whitespace. Empty blocks may only be represented as {} when not part of a multi-block statement (4.1.3) [WhitespaceAround]\n\nlet me just make it as\n} catch (Throwable ignored) {\n}\n\n(or current way is fine?)", "author": "eunchan-kim", "createdAt": "2020-08-06T03:28:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjExOTcxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjEyMzkxMg==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466123912", "bodyText": "Oops, didn't know about it. \ud83d\ude05", "author": "minwoox", "createdAt": "2020-08-06T03:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjExOTcxNQ=="}], "type": "inlineReview"}, {"oid": "b65b3c956fdf34c7c6a5fa4a2cd5466b3d3bab81", "url": "https://github.com/line/armeria/commit/b65b3c956fdf34c7c6a5fa4a2cd5466b3d3bab81", "message": "Add new line to unused catch block", "committedDate": "2020-08-06T05:05:10Z", "type": "forcePushed"}, {"oid": "77a5352d064068810aa13cc35653d869c0980f9e", "url": "https://github.com/line/armeria/commit/77a5352d064068810aa13cc35653d869c0980f9e", "message": "Add newline to unused catch block", "committedDate": "2020-08-06T05:26:06Z", "type": "commit"}, {"oid": "77a5352d064068810aa13cc35653d869c0980f9e", "url": "https://github.com/line/armeria/commit/77a5352d064068810aa13cc35653d869c0980f9e", "message": "Add newline to unused catch block", "committedDate": "2020-08-06T05:26:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1Mzc3Mg==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466153772", "bodyText": "nit: Could use HttpHeaderNames.CONTENT_LENGTH", "author": "ikhoon", "createdAt": "2020-08-06T05:25:51Z", "path": "spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ReactiveWebServerLoadBalancerInteropTest.java", "diffHunk": "@@ -46,46 +62,91 @@\n     static class TestConfiguration {\n         @RestController\n         static class TestController {\n-            @GetMapping(\"/api/ping\")\n+            @GetMapping(\"/controller/api/ping\")\n             Mono<String> ping() {\n                 return Mono.just(\"PONG\");\n             }\n         }\n+\n+        @Bean\n+        RouterFunction<ServerResponse> routerFunction() {\n+            return route(GET(\"/router/api/ping\"), request -> ok().body(fromValue(\"PONG\")))\n+                    .and(route(HEAD(\"/router/api/ping\"), request -> ok().body(fromValue(\"PONG\")))\n+                    .and(route(HEAD(\"/router/api/poke\"), request -> ok().build())));\n+        }\n     }\n \n     @LocalServerPort\n     int port;\n \n-    @Test\n-    void get() throws Exception {\n-        try (Socket s = new Socket(NetUtil.LOCALHOST4, port)) {\n-            s.setSoTimeout(10000);\n-            final InputStream in = s.getInputStream();\n-            final OutputStream out = s.getOutputStream();\n-            out.write(\"GET /api/ping HTTP/1.0\\r\\n\\r\\n\".getBytes(StandardCharsets.US_ASCII));\n-\n-            // Should not be chunked.\n-            assertThat(new String(ByteStreams.toByteArray(in))).isEqualTo(\n-                    \"HTTP/1.1 200 OK\\r\\n\" +\n-                    \"content-type: text/plain;charset=UTF-8\\r\\n\" +\n-                    \"content-length: 4\\r\\n\\r\\n\" +\n-                    \"PONG\");\n-        }\n+    Logger httpWebHandlerAdapterLogger;\n+    final ListAppender<ILoggingEvent> logAppender = new ListAppender<>();\n+\n+    @BeforeEach\n+    public void attachAppender() {\n+        httpWebHandlerAdapterLogger = (Logger) LoggerFactory.getLogger(HttpWebHandlerAdapter.class);\n+        logAppender.start();\n+        httpWebHandlerAdapterLogger.addAppender(logAppender);\n     }\n \n-    @Test\n-    void head() throws Exception {\n-        try (Socket s = new Socket(NetUtil.LOCALHOST4, port)) {\n-            s.setSoTimeout(10000);\n-            final InputStream in = s.getInputStream();\n-            final OutputStream out = s.getOutputStream();\n-            out.write(\"HEAD /api/ping HTTP/1.0\\r\\n\\r\\n\".getBytes(StandardCharsets.US_ASCII));\n-\n-            // Should neither be chunked nor have content.\n-            assertThat(new String(ByteStreams.toByteArray(in))).isEqualTo(\n-                    \"HTTP/1.1 200 OK\\r\\n\" +\n-                    \"content-type: text/plain;charset=UTF-8\\r\\n\" +\n-                    \"content-length: 4\\r\\n\\r\\n\");\n+    @AfterEach\n+    public void detachAppender() {\n+        httpWebHandlerAdapterLogger.detachAppender(logAppender);\n+        logAppender.list.clear();\n+    }\n+\n+    @ParameterizedTest\n+    @CsvSource({\n+            \"H1C, /controller/api/ping\",\n+            \"H2C, /router/api/ping\"\n+    })\n+    void testGet(SessionProtocol sessionProtocol, String path) {\n+        final String uri = sessionProtocol.uriText() + \"://127.0.0.1:\" + port;\n+        final WebClient webClient = WebClient.of(uri);\n+        final AggregatedHttpResponse res = webClient.get(path).aggregate().join();\n+\n+        assertThat(res.status()).isSameAs(HttpStatus.OK);\n+        assertThat(res.contentType()).isSameAs(MediaType.PLAIN_TEXT_UTF_8);\n+        assertThat(res.headers().get(\"content-length\")).isEqualTo(\"4\");\n+        assertThat(res.content().toStringUtf8()).isEqualTo(\"PONG\");\n+        assertNoErrorLogByHttpWebHandlerAdapter();\n+    }\n+\n+    @ParameterizedTest\n+    @CsvSource({\n+            \"H1C, /controller/api/ping, 4\",\n+            \"H2C, /controller/api/ping, 4\",\n+            \"H1C, /router/api/ping, 4\",\n+            \"H2C, /router/api/ping, 4\",\n+            \"H2C, /router/api/poke, 0\",\n+            \"H1C, /router/api/poke, 0\"\n+    })\n+    void testHead(SessionProtocol sessionProtocol, String path, int contentLength) {\n+        final String uri = sessionProtocol.uriText() + \"://127.0.0.1:\" + port;\n+        final WebClient webClient = WebClient.of(uri);\n+        final AggregatedHttpResponse res = webClient.head(path).aggregate().join();\n+\n+        assertThat(res.status()).isSameAs(HttpStatus.OK);\n+        assertThat(res.content().isEmpty()).isTrue();\n+\n+        if (contentLength > 0) {\n+            assertThat(res.contentType()).isSameAs(MediaType.PLAIN_TEXT_UTF_8);\n+            assertThat(res.headers().get(\"content-length\")).isEqualTo(String.valueOf(contentLength));", "originalCommit": "b65b3c956fdf34c7c6a5fa4a2cd5466b3d3bab81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NDIzMQ==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466154231", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .hasSize(0);\n          \n          \n            \n                            .isEmpty();", "author": "ikhoon", "createdAt": "2020-08-06T05:27:32Z", "path": "spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ReactiveWebServerLoadBalancerInteropTest.java", "diffHunk": "@@ -46,46 +62,91 @@\n     static class TestConfiguration {\n         @RestController\n         static class TestController {\n-            @GetMapping(\"/api/ping\")\n+            @GetMapping(\"/controller/api/ping\")\n             Mono<String> ping() {\n                 return Mono.just(\"PONG\");\n             }\n         }\n+\n+        @Bean\n+        RouterFunction<ServerResponse> routerFunction() {\n+            return route(GET(\"/router/api/ping\"), request -> ok().body(fromValue(\"PONG\")))\n+                    .and(route(HEAD(\"/router/api/ping\"), request -> ok().body(fromValue(\"PONG\")))\n+                    .and(route(HEAD(\"/router/api/poke\"), request -> ok().build())));\n+        }\n     }\n \n     @LocalServerPort\n     int port;\n \n-    @Test\n-    void get() throws Exception {\n-        try (Socket s = new Socket(NetUtil.LOCALHOST4, port)) {\n-            s.setSoTimeout(10000);\n-            final InputStream in = s.getInputStream();\n-            final OutputStream out = s.getOutputStream();\n-            out.write(\"GET /api/ping HTTP/1.0\\r\\n\\r\\n\".getBytes(StandardCharsets.US_ASCII));\n-\n-            // Should not be chunked.\n-            assertThat(new String(ByteStreams.toByteArray(in))).isEqualTo(\n-                    \"HTTP/1.1 200 OK\\r\\n\" +\n-                    \"content-type: text/plain;charset=UTF-8\\r\\n\" +\n-                    \"content-length: 4\\r\\n\\r\\n\" +\n-                    \"PONG\");\n-        }\n+    Logger httpWebHandlerAdapterLogger;\n+    final ListAppender<ILoggingEvent> logAppender = new ListAppender<>();\n+\n+    @BeforeEach\n+    public void attachAppender() {\n+        httpWebHandlerAdapterLogger = (Logger) LoggerFactory.getLogger(HttpWebHandlerAdapter.class);\n+        logAppender.start();\n+        httpWebHandlerAdapterLogger.addAppender(logAppender);\n     }\n \n-    @Test\n-    void head() throws Exception {\n-        try (Socket s = new Socket(NetUtil.LOCALHOST4, port)) {\n-            s.setSoTimeout(10000);\n-            final InputStream in = s.getInputStream();\n-            final OutputStream out = s.getOutputStream();\n-            out.write(\"HEAD /api/ping HTTP/1.0\\r\\n\\r\\n\".getBytes(StandardCharsets.US_ASCII));\n-\n-            // Should neither be chunked nor have content.\n-            assertThat(new String(ByteStreams.toByteArray(in))).isEqualTo(\n-                    \"HTTP/1.1 200 OK\\r\\n\" +\n-                    \"content-type: text/plain;charset=UTF-8\\r\\n\" +\n-                    \"content-length: 4\\r\\n\\r\\n\");\n+    @AfterEach\n+    public void detachAppender() {\n+        httpWebHandlerAdapterLogger.detachAppender(logAppender);\n+        logAppender.list.clear();\n+    }\n+\n+    @ParameterizedTest\n+    @CsvSource({\n+            \"H1C, /controller/api/ping\",\n+            \"H2C, /router/api/ping\"\n+    })\n+    void testGet(SessionProtocol sessionProtocol, String path) {\n+        final String uri = sessionProtocol.uriText() + \"://127.0.0.1:\" + port;\n+        final WebClient webClient = WebClient.of(uri);\n+        final AggregatedHttpResponse res = webClient.get(path).aggregate().join();\n+\n+        assertThat(res.status()).isSameAs(HttpStatus.OK);\n+        assertThat(res.contentType()).isSameAs(MediaType.PLAIN_TEXT_UTF_8);\n+        assertThat(res.headers().get(\"content-length\")).isEqualTo(\"4\");\n+        assertThat(res.content().toStringUtf8()).isEqualTo(\"PONG\");\n+        assertNoErrorLogByHttpWebHandlerAdapter();\n+    }\n+\n+    @ParameterizedTest\n+    @CsvSource({\n+            \"H1C, /controller/api/ping, 4\",\n+            \"H2C, /controller/api/ping, 4\",\n+            \"H1C, /router/api/ping, 4\",\n+            \"H2C, /router/api/ping, 4\",\n+            \"H2C, /router/api/poke, 0\",\n+            \"H1C, /router/api/poke, 0\"\n+    })\n+    void testHead(SessionProtocol sessionProtocol, String path, int contentLength) {\n+        final String uri = sessionProtocol.uriText() + \"://127.0.0.1:\" + port;\n+        final WebClient webClient = WebClient.of(uri);\n+        final AggregatedHttpResponse res = webClient.head(path).aggregate().join();\n+\n+        assertThat(res.status()).isSameAs(HttpStatus.OK);\n+        assertThat(res.content().isEmpty()).isTrue();\n+\n+        if (contentLength > 0) {\n+            assertThat(res.contentType()).isSameAs(MediaType.PLAIN_TEXT_UTF_8);\n+            assertThat(res.headers().get(\"content-length\")).isEqualTo(String.valueOf(contentLength));\n         }\n+        assertNoErrorLogByHttpWebHandlerAdapter();\n+    }\n+\n+    private void assertNoErrorLogByHttpWebHandlerAdapter() {\n+        // Example error log for CancelledSubscriptionException by HttpWebHandlerAdapter:\n+        //\n+        // Error [com.linecorp.armeria.common.stream.CancelledSubscriptionException] for\n+        // HTTP HEAD \"/router/api/poke\", but ServerHttpResponse already committed (200 OK)\n+        final String errorLogSubString =\n+                \"Error [com.linecorp.armeria.common.stream.CancelledSubscriptionException] for HTTP HEAD\";\n+        assertThat(logAppender.list\n+                           .stream()\n+                           .filter(event -> event.getFormattedMessage().contains(errorLogSubString))\n+                           .collect(Collectors.toList()))\n+                .hasSize(0);", "originalCommit": "77a5352d064068810aa13cc35653d869c0980f9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NDU4NA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466154584", "bodyText": "Could simplify with:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(future.isDone()).isFalse();\n          \n          \n            \n                    assertThat(future).isNotDone();", "author": "ikhoon", "createdAt": "2020-08-06T05:28:40Z", "path": "spring/boot2-webflux-autoconfigure/src/test/java/com/linecorp/armeria/spring/web/reactive/ArmeriaServerHttpResponseTest.java", "diffHunk": "@@ -171,6 +172,31 @@ void returnHeadersAndBody() throws Exception {\n         await().until(() -> httpResponse.whenComplete().isDone());\n     }\n \n+    @Test\n+    void ignoreCancelledSubscriptionException() throws Exception {\n+        final ServiceRequestContext ctx = ServiceRequestContext.of(HttpRequest.of(HttpMethod.HEAD, \"/\"));\n+\n+        final CompletableFuture<HttpResponse> future = new CompletableFuture<>();\n+        final ArmeriaServerHttpResponse response = response(ctx, future);\n+\n+        response.setStatusCode(HttpStatus.OK);\n+        response.getHeaders().add(\"Armeria\", \"awesome\");\n+        assertThat(future.isDone()).isFalse();", "originalCommit": "77a5352d064068810aa13cc35653d869c0980f9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE1NjQ3NA==", "url": "https://github.com/line/armeria/pull/2965#discussion_r466156474", "bodyText": "nit: Indent?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Mono.fromFuture(response.whenComplete())\n          \n          \n            \n                            .onErrorResume(CancelledSubscriptionException.class, e -> Mono.empty());\n          \n          \n            \n                    return Mono.fromFuture(response.whenComplete())\n          \n          \n            \n                               .onErrorResume(CancelledSubscriptionException.class, e -> Mono.empty());", "author": "ikhoon", "createdAt": "2020-08-06T05:34:55Z", "path": "spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaServerHttpResponse.java", "diffHunk": "@@ -287,7 +287,9 @@ public HttpHeaders getHeaders() {\n         final HttpResponse response = HttpResponse.of(buildResponseHeaders());\n         future.complete(response);\n         logger.debug(\"{} Response future has been completed with an HttpResponse\", ctx);\n-        return Mono.fromFuture(response.whenComplete());\n+\n+        return Mono.fromFuture(response.whenComplete())\n+                .onErrorResume(CancelledSubscriptionException.class, e -> Mono.empty());", "originalCommit": "77a5352d064068810aa13cc35653d869c0980f9e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "345db8923c2da120e791930a418c21ac660ad76f", "url": "https://github.com/line/armeria/commit/345db8923c2da120e791930a418c21ac660ad76f", "message": "Apply comments", "committedDate": "2020-08-06T05:57:59Z", "type": "commit"}, {"oid": "345db8923c2da120e791930a418c21ac660ad76f", "url": "https://github.com/line/armeria/commit/345db8923c2da120e791930a418c21ac660ad76f", "message": "Apply comments", "committedDate": "2020-08-06T05:57:59Z", "type": "forcePushed"}]}