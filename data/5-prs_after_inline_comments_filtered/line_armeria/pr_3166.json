{"pr_number": 3166, "pr_title": "Fix route decorator evaluation order", "pr_createdAt": "2020-11-09T14:34:26Z", "pr_url": "https://github.com/line/armeria/pull/3166", "timeline": [{"oid": "a5dfc56a0dff89a5cc8d9a5c045a98e04bcc86b2", "url": "https://github.com/line/armeria/commit/a5dfc56a0dff89a5cc8d9a5c045a98e04bcc86b2", "message": "Fix route decorator evaluation order", "committedDate": "2020-11-09T14:27:43Z", "type": "commit"}, {"oid": "ce82ebfe0977eaca33cb9eaac305535036648e3f", "url": "https://github.com/line/armeria/commit/ce82ebfe0977eaca33cb9eaac305535036648e3f", "message": "Fix order `configureServerWithArmeriaSettings`", "committedDate": "2020-11-10T09:53:26Z", "type": "commit"}, {"oid": "31c00bec6c842a3139547fb8fa9fbff81daaf60b", "url": "https://github.com/line/armeria/commit/31c00bec6c842a3139547fb8fa9fbff81daaf60b", "message": "Fix test", "committedDate": "2020-11-10T09:53:37Z", "type": "commit"}, {"oid": "a10bea7da1ebfe0bdbfe72738ff3e7b7a61a5ecd", "url": "https://github.com/line/armeria/commit/a10bea7da1ebfe0bdbfe72738ff3e7b7a61a5ecd", "message": "Replace `ArrayList` to `LinkedList`", "committedDate": "2020-11-12T01:19:18Z", "type": "commit"}, {"oid": "bdcff46cf373d5fbb97a02dd53490ada5d47a2dc", "url": "https://github.com/line/armeria/commit/bdcff46cf373d5fbb97a02dd53490ada5d47a2dc", "message": "Refactor", "committedDate": "2020-11-12T11:13:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4MzU0NQ==", "url": "https://github.com/line/armeria/pull/3166#discussion_r523983545", "bodyText": "Shouldn't we update the decorator ordering instead of updating the test parameters? Returning public on .../private/... doesn't sound right to me.", "author": "trustin", "createdAt": "2020-11-16T08:54:22Z", "path": "core/src/test/java/com/linecorp/armeria/server/RouteDecoratingTest.java", "diffHunk": "@@ -187,7 +187,7 @@ void decorateInOrder(String path, List<Integer> orders) {\n             \"/api/admin/1, , 401, \",\n             \"/assets/index.html, , 200, \",\n             \"/assets/resources/index.html, , 200, public\",\n-            \"/assets/resources/private/profile.jpg, , 200, private\",\n+            \"/assets/resources/private/profile.jpg, , 200, public\",", "originalCommit": "bdcff46cf373d5fbb97a02dd53490ada5d47a2dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA0MjY1OQ==", "url": "https://github.com/line/armeria/pull/3166#discussion_r524042659", "bodyText": "Yes, I fixed the order. \ud83d\udc4d", "author": "heowc", "createdAt": "2020-11-16T09:47:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4MzU0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4NDY5Mw==", "url": "https://github.com/line/armeria/pull/3166#discussion_r523984693", "bodyText": "How about moving this sentence before .decorator() for readability?", "author": "trustin", "createdAt": "2020-11-16T08:55:23Z", "path": "core/src/test/java/com/linecorp/armeria/server/logging/ContentPreviewingServiceTest.java", "diffHunk": "@@ -71,16 +71,16 @@ protected void configure(ServerBuilder sb) throws Exception {\n                            return HttpResponse.of(responseHeaders,\n                                                   HttpData.ofUtf8(\"Hello \" + aggregated.contentUtf8() + '!'));\n                        }));\n+            sb.decorator(\"/beforeEncoding\", ContentPreviewingService.newDecorator(100));\n             sb.decorator(\"/beforeEncoding\", EncodingService.builder()\n                                                            .minBytesToForceChunkedEncoding(1)\n                                                            .newDecorator());\n-            sb.decorator(\"/beforeEncoding\", ContentPreviewingService.newDecorator(100));\n             sb.service(\"/beforeEncoding\", httpService);", "originalCommit": "bdcff46cf373d5fbb97a02dd53490ada5d47a2dc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA0MzE2NA==", "url": "https://github.com/line/armeria/pull/3166#discussion_r524043164", "bodyText": "I fixed \ud83d\udc4d", "author": "heowc", "createdAt": "2020-11-16T09:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk4NDY5Mw=="}], "type": "inlineReview"}, {"oid": "229bf1f02623084414a6b32f0b1e4bd5bccd61b6", "url": "https://github.com/line/armeria/commit/229bf1f02623084414a6b32f0b1e4bd5bccd61b6", "message": "Address comments by @trustin", "committedDate": "2020-11-16T09:45:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc2NTMzMA==", "url": "https://github.com/line/armeria/pull/3166#discussion_r525765330", "bodyText": "How about using LinkedList.addFirst(...)?\nCould you add The specified decorator(s) is/are executed in reverse order of the insertion. to the Javadoc of ServerBuilder.decorator(...) and VirtualHostBuilder.decorator(...)?", "author": "ikhoon", "createdAt": "2020-11-18T04:02:48Z", "path": "core/src/main/java/com/linecorp/armeria/server/VirtualHostBuilder.java", "diffHunk": "@@ -591,7 +592,7 @@ VirtualHostBuilder addServiceConfigSetters(ServiceConfigSetters serviceConfigSet\n     }\n \n     VirtualHostBuilder addRouteDecoratingService(RouteDecoratingService routeDecoratingService) {\n-        routeDecoratingServices.add(routeDecoratingService);\n+        routeDecoratingServices.add(0, routeDecoratingService);", "originalCommit": "229bf1f02623084414a6b32f0b1e4bd5bccd61b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA4NDk5MQ==", "url": "https://github.com/line/armeria/pull/3166#discussion_r526084991", "bodyText": "How about using LinkedList.addFirst(...)?\n\nSound good to me! \ud83d\udc4d\n\nCould you add The specified decorator(s) is/are executed in reverse order of the insertion. to the Javadoc of ServerBuilder.decorator(...) and VirtualHostBuilder.decorator(...)?\n\nIt seems a bit insufficient to add only to the mentioned point. Or is it enough? \ud83e\udd14\n\n{ServerBuilder|VirtualHostBuilder}.routeDecorator(...)\n{ServerBuilder|VirtualHostBuilder}.decoratorUnder(...)\n\nShouldn't we add it here too? What do you think?", "author": "heowc", "createdAt": "2020-11-18T13:25:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc2NTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEwOTM2Mw==", "url": "https://github.com/line/armeria/pull/3166#discussion_r526109363", "bodyText": "It looks good to add to routeDecorator and decoratorUnder too. :)", "author": "ikhoon", "createdAt": "2020-11-18T14:01:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc2NTMzMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjEzMjk1Ng==", "url": "https://github.com/line/armeria/pull/3166#discussion_r526132956", "bodyText": "I fixed \ud83d\udc4d", "author": "heowc", "createdAt": "2020-11-18T14:32:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTc2NTMzMA=="}], "type": "inlineReview"}, {"oid": "fcbced63ff421f17489c19173f24423017b9c0ce", "url": "https://github.com/line/armeria/commit/fcbced63ff421f17489c19173f24423017b9c0ce", "message": "Address comments by @ikhoon", "committedDate": "2020-11-18T13:26:31Z", "type": "commit"}, {"oid": "4c2812cd57216e71aa3de8ed1dcfdd6aa3eb6022", "url": "https://github.com/line/armeria/commit/4c2812cd57216e71aa3de8ed1dcfdd6aa3eb6022", "message": "Address comments by @ikhoon", "committedDate": "2020-11-18T14:32:16Z", "type": "commit"}, {"oid": "deabd4f160e7c3b2a313aa3ae8d7b606a7932fdf", "url": "https://github.com/line/armeria/commit/deabd4f160e7c3b2a313aa3ae8d7b606a7932fdf", "message": "Fix javadoc", "committedDate": "2020-11-20T10:11:42Z", "type": "commit"}, {"oid": "833c6346c82d84346b39056a9f8092c307aedaa5", "url": "https://github.com/line/armeria/commit/833c6346c82d84346b39056a9f8092c307aedaa5", "message": "Address comments by @minwoox", "committedDate": "2020-11-20T10:36:54Z", "type": "commit"}]}