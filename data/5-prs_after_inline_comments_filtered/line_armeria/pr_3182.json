{"pr_number": 3182, "pr_title": "Support io_uring", "pr_createdAt": "2020-11-16T23:41:14Z", "pr_url": "https://github.com/line/armeria/pull/3182", "timeline": [{"oid": "7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593", "url": "https://github.com/line/armeria/commit/7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593", "message": "Support io_uring", "committedDate": "2020-11-16T23:38:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDc4OTk0NQ==", "url": "https://github.com/line/armeria/pull/3182#discussion_r524789945", "bodyText": "useIoUring to follow the convention?", "author": "trustin", "createdAt": "2020-11-17T00:10:17Z", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -168,6 +169,8 @@\n     private static final boolean HAS_WSLENV = System.getenv(\"WSLENV\") != null;\n     private static final boolean USE_EPOLL = getBoolean(\"useEpoll\", isEpollAvailable(),\n                                                         value -> isEpollAvailable() || !value);\n+    private static final boolean USE_IOURING = getBoolean(\"useIOUring\", false,", "originalCommit": "7d6bd978f0fefd2f65fe7f4d135e64b7c9c26593", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c1fc853c396ddd4597ef5540ec24cc4fda652fc3", "url": "https://github.com/line/armeria/commit/c1fc853c396ddd4597ef5540ec24cc4fda652fc3", "message": "fix typo", "committedDate": "2020-11-17T00:18:01Z", "type": "commit"}, {"oid": "a0d7e80affc3ee050db47e49626dac8983961d24", "url": "https://github.com/line/armeria/commit/a0d7e80affc3ee050db47e49626dac8983961d24", "message": "Add Flags.defaultTransportType()", "committedDate": "2020-11-17T01:05:52Z", "type": "commit"}, {"oid": "65bbf81a1e35b489d3ad465fa3362626198e1ba2", "url": "https://github.com/line/armeria/commit/65bbf81a1e35b489d3ad465fa3362626198e1ba2", "message": "Merge branch 'master' into io_uring", "committedDate": "2020-11-17T01:07:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDAyOA==", "url": "https://github.com/line/armeria/pull/3182#discussion_r524840028", "bodyText": "Better removing default?", "author": "trustin", "createdAt": "2020-11-17T02:14:19Z", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -482,11 +533,26 @@ public static String requestContextStorageProvider() {\n      *\n      * <p>This flag is enabled by default for supported platforms. Specify the\n      * {@code -Dcom.linecorp.armeria.useEpoll=false} JVM option to disable it.\n+     *\n+     * @deprecated Use {@link #defaultTransportType()} and {@code -Dcom.linecorp.armeria.transportType=epoll}.\n      */\n+    @Deprecated\n     public static boolean useEpoll() {\n         return USE_EPOLL;\n     }\n \n+    /**\n+     * Returns the {@link TransportType} that will be used for socket I/O in Armeria.\n+     *\n+     * <p>The default value of this flag is {@link #DEFAULT_TRANSPORT_TYPE_SPEC}, which retains\n+     * the transport type of socket I/O API which Armeria will be used.\n+     * Specify the {@code -Dcom.linecorp.armeria.transportType=<nio|epoll|io_uring>} JVM option to override\n+     * the default.</p>\n+     */\n+    public static TransportType defaultTransportType() {", "originalCommit": "65bbf81a1e35b489d3ad465fa3362626198e1ba2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MDU4NQ==", "url": "https://github.com/line/armeria/pull/3182#discussion_r524840585", "bodyText": "How about removing _SPEC? It's just transport name.", "author": "trustin", "createdAt": "2020-11-17T02:16:12Z", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -169,6 +171,22 @@\n     private static final boolean HAS_WSLENV = System.getenv(\"WSLENV\") != null;\n     private static final boolean USE_EPOLL = getBoolean(\"useEpoll\", isEpollAvailable(),\n                                                         value -> isEpollAvailable() || !value);\n+\n+    private static final String DEFAULT_TRANSPORT_TYPE_SPEC = USE_EPOLL ? \"epoll\" : \"nio\";\n+    private static final String TRANSPORT_TYPE_SPEC = getNormalized(\"transportType\",\n+                                                                    DEFAULT_TRANSPORT_TYPE_SPEC,", "originalCommit": "65bbf81a1e35b489d3ad465fa3362626198e1ba2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDg0MTIzMg==", "url": "https://github.com/line/armeria/pull/3182#discussion_r524841232", "bodyText": "... this flag is {@code \"epoll\"} in Linux and {@code \"nio\"} for other operations systems.\nSpecify ...\n\n('... which retains' doesn't seem to add anything new, so I think we can remove it.)", "author": "trustin", "createdAt": "2020-11-17T02:18:30Z", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -482,11 +533,26 @@ public static String requestContextStorageProvider() {\n      *\n      * <p>This flag is enabled by default for supported platforms. Specify the\n      * {@code -Dcom.linecorp.armeria.useEpoll=false} JVM option to disable it.\n+     *\n+     * @deprecated Use {@link #defaultTransportType()} and {@code -Dcom.linecorp.armeria.transportType=epoll}.\n      */\n+    @Deprecated\n     public static boolean useEpoll() {\n         return USE_EPOLL;\n     }\n \n+    /**\n+     * Returns the {@link TransportType} that will be used for socket I/O in Armeria.\n+     *\n+     * <p>The default value of this flag is {@link #DEFAULT_TRANSPORT_TYPE_SPEC}, which retains", "originalCommit": "65bbf81a1e35b489d3ad465fa3362626198e1ba2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e96b03bfb52f6e98bc9a003f0d84e24c4ff7d1e", "url": "https://github.com/line/armeria/commit/3e96b03bfb52f6e98bc9a003f0d84e24c4ff7d1e", "message": "address comment", "committedDate": "2020-11-17T02:41:15Z", "type": "commit"}, {"oid": "b75ed474d84ee20e55bb1421f8ae32a594366b7a", "url": "https://github.com/line/armeria/commit/b75ed474d84ee20e55bb1421f8ae32a594366b7a", "message": "make io_uring optionalImplementation", "committedDate": "2020-11-17T02:42:41Z", "type": "commit"}, {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77", "url": "https://github.com/line/armeria/commit/f8013ed7f6d31e56617650befba0686715e7dc77", "message": "fix checkstyle", "committedDate": "2020-11-18T08:43:32Z", "type": "commit"}, {"oid": "f8013ed7f6d31e56617650befba0686715e7dc77", "url": "https://github.com/line/armeria/commit/f8013ed7f6d31e56617650befba0686715e7dc77", "message": "fix checkstyle", "committedDate": "2020-11-18T08:43:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjUzNTcwMw==", "url": "https://github.com/line/armeria/pull/3182#discussion_r526535703", "bodyText": "can remove this line?", "author": "minwoox", "createdAt": "2020-11-19T01:39:26Z", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -384,9 +410,30 @@\n                     logger.info(\"/dev/epoll not available: ?\");\n                 }\n             }\n-        } else if (USE_EPOLL) {\n-            logger.info(\"Using /dev/epoll\");\n         }\n+        TransportType type = null;\n+        switch (TRANSPORT_TYPE_NAME) {\n+            case \"io_uring\":\n+                if (isIoUringAvailable()) {\n+                    logger.info(\"Using io_uring\");\n+                    type = TransportType.IO_URING;\n+                }\n+                // fallthrough\n+            case \"epoll\":\n+                if (isEpollAvailable() && type == null) {\n+                    logger.info(\"Using /dev/epoll\");\n+                    type = TransportType.EPOLL;\n+                }\n+                // fallthrough\n+            case \"nio\":", "originalCommit": "f8013ed7f6d31e56617650befba0686715e7dc77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MTg0NA==", "url": "https://github.com/line/armeria/pull/3182#discussion_r526541844", "bodyText": "Shouldn't we access this IOUring class using reflection in case the dependency is not on the classpath when a user uses it?", "author": "minwoox", "createdAt": "2020-11-19T01:58:23Z", "path": "core/src/main/java/com/linecorp/armeria/common/Flags.java", "diffHunk": "@@ -373,6 +391,14 @@\n     private static final boolean VALIDATE_HEADERS = getBoolean(\"validateHeaders\", true);\n \n     static {\n+        if (!isIoUringAvailable()) {\n+            final Throwable cause = IOUring.unavailabilityCause();", "originalCommit": "f8013ed7f6d31e56617650befba0686715e7dc77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMTQ2Mw==", "url": "https://github.com/line/armeria/pull/3182#discussion_r526621463", "bodyText": "How about just adding it as a required dependency? It shouldn't be that large I guess. (120KB)", "author": "trustin", "createdAt": "2020-11-19T06:25:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU0MTg0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjYyMjI0Mg==", "url": "https://github.com/line/armeria/pull/3182#discussion_r526622242", "bodyText": "Could we remove this method now that we can just use Flags.transportType()?", "author": "trustin", "createdAt": "2020-11-19T06:28:10Z", "path": "core/src/main/java/com/linecorp/armeria/common/util/TransportType.java", "diffHunk": "@@ -76,11 +84,7 @@\n      * Returns the available {@link TransportType}.\n      */\n     public static TransportType detectTransportType() {", "originalCommit": "f8013ed7f6d31e56617650befba0686715e7dc77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8d27aeb6684d57f8ac9acf0130942396a25615f", "url": "https://github.com/line/armeria/commit/f8d27aeb6684d57f8ac9acf0130942396a25615f", "message": "address comments", "committedDate": "2020-11-20T02:16:51Z", "type": "commit"}, {"oid": "259603ec3a46b316af5d3ad8af8b1cd146c31819", "url": "https://github.com/line/armeria/commit/259603ec3a46b316af5d3ad8af8b1cd146c31819", "message": "merge TransportType.isSupported(EventLoop) into isSupported(EventLoopGroup)", "committedDate": "2020-11-20T04:06:42Z", "type": "commit"}]}