{"pr_number": 2864, "pr_title": "Allow a request to schedule timeout in nanoseconds precision", "pr_createdAt": "2020-07-02T00:35:42Z", "pr_url": "https://github.com/line/armeria/pull/2864", "timeline": [{"oid": "215b7ba6aa2ca83399b6090de43661f1aeec79c6", "url": "https://github.com/line/armeria/commit/215b7ba6aa2ca83399b6090de43661f1aeec79c6", "message": "Allow a request to schedule timeout in nanoseconds precision\n\nMotivation:\n\na gRPC client sends a request timeout in nanoseconds using `grpc-timeout` header field.\nArmeria server converts it milliseconds internally.\nNanoseconds and microseconds precision will be dropped because of this conversion.\n\nLet's say a gRPC timeout value is `10,900,000ns`.\nBefore sending a request, the upstream gRPC client schedules a timeout in nanoseconds.\nHowever, the Armeria server schedules a timeout in 10ms(without decimal point).\n\nThe server will cancel a request earlier than the upstream client.\nThis is not a critical problem in the real world because of network time.\nBut we can reduce unexpected failures in `ArmeriaGrpcServerInteropTest.deadlineExceeded()`\nSee #2812\n\nModifications:\n\n- Make DefalutTimeoutController schedule a timeout in nanoseconds.\n- Remove deprecated timeout API in {Service,Client}RequestContext\n  - extend{Request,Response}TimeoutMillis(long) and extend{Request,Response}Timeout(Duration)\n  - set{Request,Reponse}TimeoutAfterMillis(long) and set{Request,Response}TimeoutAfter(Duration)\n  - set{Request,Reponse}TimeoutAtMillis(long) and set{Request,Reponse}TimeoutAt(Duration)\n\nResult:\n\n- You can now schedule a request timeout in nanoseconds using:\n  - ServiceRequestContext.setRequestTimeout(TimeoutMode, Duration)\n  - ClientRequestContext.setReponseTimeout(TimeoutMode, Duration)\n- Respect the nanoseconds precision of a `grpc-timeout`.\n- Fixes #2812", "committedDate": "2020-07-02T00:33:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4NzgzNw==", "url": "https://github.com/line/armeria/pull/2864#discussion_r448687837", "bodyText": "How about adding Nanos suffix to all methods that accept a long duration?", "author": "trustin", "createdAt": "2020-07-02T00:46:14Z", "path": "core/src/main/java/com/linecorp/armeria/internal/common/TimeoutController.java", "diffHunk": "@@ -26,36 +26,36 @@\n public interface TimeoutController {\n \n     /**\n-     * Schedules a new timeout with the specified {@code timeoutMillis}.\n+     * Schedules a new timeout with the specified {@code timeoutNanos}.\n      * If a timeout is scheduled already, this method will not start a new timeout.\n      *\n-     * @param timeoutMillis a positive time amount value in milliseconds.\n+     * @param timeoutNanos a positive time amount value in nanoseconds.\n      * @return {@code true} if the timeout is scheduled.\n      *         {@code false} if the timeout has been scheduled, triggered already\n      *         or a timeout cannot be scheduled, e.g. request or response has been handled already.\n      */\n-    boolean scheduleTimeout(long timeoutMillis);\n+    boolean scheduleTimeout(long timeoutNanos);", "originalCommit": "215b7ba6aa2ca83399b6090de43661f1aeec79c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcwNTI4OA==", "url": "https://github.com/line/armeria/pull/2864#discussion_r448705288", "bodyText": "+1 That makes the names clearer", "author": "ikhoon", "createdAt": "2020-07-02T01:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY4NzgzNw=="}], "type": "inlineReview"}, {"oid": "bcee7c1c000ebcb82da9f44471417eb4fd1299fb", "url": "https://github.com/line/armeria/commit/bcee7c1c000ebcb82da9f44471417eb4fd1299fb", "message": "Address comments by @trustin + checkstyle", "committedDate": "2020-07-02T03:52:33Z", "type": "commit"}, {"oid": "9ebd100c1395f3b48df7a461353725e2389da437", "url": "https://github.com/line/armeria/commit/9ebd100c1395f3b48df7a461353725e2389da437", "message": "Fix flakyness", "committedDate": "2020-07-02T04:09:46Z", "type": "commit"}, {"oid": "57cc2fad6111b210790d48ab79b06d3c40785509", "url": "https://github.com/line/armeria/commit/57cc2fad6111b210790d48ab79b06d3c40785509", "message": "Fix flaky", "committedDate": "2020-07-02T04:35:19Z", "type": "commit"}]}