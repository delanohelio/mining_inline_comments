{"pr_number": 2376, "pr_title": "Generalize gRPC stub factory lookup mechanism", "pr_createdAt": "2020-01-06T07:51:38Z", "pr_url": "https://github.com/line/armeria/pull/2376", "timeline": [{"oid": "47e0a93e6cce8f0d79ac20330be39e67370d3ad6", "url": "https://github.com/line/armeria/commit/47e0a93e6cce8f0d79ac20330be39e67370d3ad6", "message": "Generalize gRPC stub factory lookup mechanism\n\nMotivation:\n\n`GrpcClientFactory` currently assumes that the stub factory methods\nare always one of `newStub()`, `newBlockingStub()` and `newAsyncStub()`.\n\nHowever, by using a plugin like `grpc-reactor`, the stub factory method\ncan be `newReactorStub()`\n\nModifications:\n\n- Generalize the stub factory lookup mechanism in `GrpcClientFactory`.\n- Miscellaneous:\n  - Clean-up `logback-test.xml` so that the log messages from Project\n    Reactor are logged.\n\nResult:\n\nPartial support for the gRPC client stubs generated with `grpc-reactor`.", "committedDate": "2020-01-06T07:47:11Z", "type": "commit"}, {"oid": "9ca6d5ee3aff694355e165e15763c2b9e88ef180", "url": "https://github.com/line/armeria/commit/9ca6d5ee3aff694355e165e15763c2b9e88ef180", "message": "Clean-up", "committedDate": "2020-01-06T07:53:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4OTE3Mw==", "url": "https://github.com/line/armeria/pull/2376#discussion_r363189173", "bodyText": "Cool check :)", "author": "anuraaga", "createdAt": "2020-01-06T07:56:37Z", "path": "grpc/src/main/java/com/linecorp/armeria/client/grpc/GrpcClientFactory.java", "diffHunk": "@@ -101,61 +102,78 @@\n         final SerializationFormat serializationFormat = scheme.serializationFormat();\n         final Class<?> stubClass = clientType.getEnclosingClass();\n         if (stubClass == null) {\n-            throw new IllegalArgumentException(\"Client type not a gRPC client stub class, \" +\n-                                               \"should be something like ServiceNameGrpc.ServiceNameXXStub: \" +\n-                                               clientType);\n-        }\n-        final Method newStubMethod;\n-        final Method newBlockingStubMethod;\n-        final Method newFutureStubMethod;\n-        try {\n-            newStubMethod = stubClass.getDeclaredMethod(\"newStub\", Channel.class);\n-            newBlockingStubMethod = stubClass.getDeclaredMethod(\"newBlockingStub\", Channel.class);\n-            newFutureStubMethod = stubClass.getDeclaredMethod(\"newFutureStub\", Channel.class);\n-        } catch (NoSuchMethodException e) {\n-            throw new IllegalArgumentException(\"Client type not a gRPC client stub class, \" +\n-                                               \"should be something like ServiceNameGrpc.ServiceNameXXStub: \" +\n-                                               clientType, e);\n-        }\n-        final Method createClientMethod;\n-        if (newStubMethod.getReturnType() == clientType) {\n-            createClientMethod = newStubMethod;\n-        } else if (newBlockingStubMethod.getReturnType() == clientType) {\n-            createClientMethod = newBlockingStubMethod;\n-        } else if (newFutureStubMethod.getReturnType() == clientType) {\n-            createClientMethod = newFutureStubMethod;\n-        } else {\n-            throw new IllegalArgumentException(\"Client type not a gRPC client stub class, \" +\n-                                               \"should be something like ServiceNameGrpc.ServiceNameXXStub: \" +\n-                                               clientType);\n+            throw newUnknownClientTypeException(clientType);\n         }\n \n-        final HttpClient httpClient = newHttpClient(uri, scheme, options);\n+        final Method stubFactoryMethod = findStubFactoryMethod(clientType, stubClass);\n \n         final MessageMarshaller jsonMarshaller =\n                 GrpcSerializationFormats.isJson(serializationFormat) ?\n                 GrpcJsonUtil.jsonMarshaller(\n                         stubMethods(stubClass),\n                         options.getOrElse(GrpcClientOptions.JSON_MARSHALLER_CUSTOMIZER, NO_OP)) : null;\n+\n         final ArmeriaChannel channel = new ArmeriaChannel(\n                 ClientBuilderParams.of(this,\n                                        Strings.isNullOrEmpty(uri.getPath()) ? rootPathUri(uri) : uri,\n                                        clientType, options),\n-                httpClient,\n+                newHttpClient(uri, scheme, options),\n                 meterRegistry(),\n                 scheme.sessionProtocol(),\n                 endpoint,\n                 serializationFormat,\n                 jsonMarshaller);\n \n         try {\n-            // Verified createClientMethod.getReturnType == clientType\n+            // Verified stubFactoryMethod.getReturnType() == clientType in findStubFactoryMethod().\n             @SuppressWarnings(\"unchecked\")\n-            final T stub = (T) createClientMethod.invoke(null, channel);\n+            final T stub = (T) stubFactoryMethod.invoke(null, channel);\n             return stub;\n         } catch (IllegalAccessException | InvocationTargetException e) {\n-            throw new IllegalStateException(\"Could not create stub through reflection.\", e);\n+            throw new IllegalStateException(\"Could not create a gRPC stub through reflection.\", e);\n+        }\n+    }\n+\n+    private static <T> Method findStubFactoryMethod(Class<T> clientType, Class<?> stubClass) {\n+        Method newStubMethod = null;\n+        for (Method method : stubClass.getDeclaredMethods()) {\n+            final int methodModifiers = method.getModifiers();\n+            if (!(Modifier.isPublic(methodModifiers) && Modifier.isStatic(methodModifiers))) {\n+                // Must be public and static.\n+                continue;\n+            }\n+\n+            final String methodName = method.getName();\n+            if (!(methodName.startsWith(\"new\") && methodName.endsWith(\"Stub\"))) {", "originalCommit": "9ca6d5ee3aff694355e165e15763c2b9e88ef180", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}