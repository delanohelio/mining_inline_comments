{"pr_number": 3064, "pr_title": "Fix a bug where wrong exception is propagated to WebFlux `WebClient`", "pr_createdAt": "2020-09-16T14:34:36Z", "pr_url": "https://github.com/line/armeria/pull/3064", "timeline": [{"oid": "600cf10d9aa138dedf9e95d1bbd1e4d5754468f3", "url": "https://github.com/line/armeria/commit/600cf10d9aa138dedf9e95d1bbd1e4d5754468f3", "message": "Fix a bug where wrong exception is propagated to WebFlux `WebClient`\nMotivation:\nCurrently, we propagate the exception from the `HttpRequest` to WebFlux `WebClent`.\nHowever, this causes some unexpected behaviour such as progating `CancelledSubscriptionException`\ninstead `FailFastException` when `RetyringClient` is used.\nWe should rather propgate the exception from `HttpResponse`.\n\nModification:\n- Progate the exception from `HttpResponse` not from `HttpRequest`.\n\nResult:\n- You now see the proper exception from WebFlux `WebClient`.", "committedDate": "2020-09-16T14:33:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NTIyNQ==", "url": "https://github.com/line/armeria/pull/3064#discussion_r489985225", "bodyText": "Don't we need to complete Mono lazily? If then, how about?\nMono.fromFuture(request.whenComplete())\n    .onErrorResume(unused -> Mono.empty())", "author": "ikhoon", "createdAt": "2020-09-17T05:48:26Z", "path": "spring/boot2-webflux-autoconfigure/src/main/java/com/linecorp/armeria/spring/web/reactive/ArmeriaClientHttpRequest.java", "diffHunk": "@@ -141,7 +141,7 @@ public DataBufferFactory bufferFactory() {\n             assert request == null : request;\n             request = supplier.get();\n             future.complete(client.execute(request));\n-            return Mono.fromFuture(request.whenComplete());\n+            return Mono.empty();", "originalCommit": "600cf10d9aa138dedf9e95d1bbd1e4d5754468f3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDYzMzM2NA==", "url": "https://github.com/line/armeria/pull/3064#discussion_r490633364", "bodyText": "If so, we cannot get the response until the request is complete which means that we cannot use bidi streaming request.\nSo the Mono should not depend on whether the request is complete or not. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-09-18T00:28:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NTIyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY0NzQ4MA==", "url": "https://github.com/line/armeria/pull/3064#discussion_r490647480", "bodyText": "Ah... I see. Let's leave as it is.", "author": "ikhoon", "createdAt": "2020-09-18T01:23:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTk4NTIyNQ=="}], "type": "inlineReview"}]}