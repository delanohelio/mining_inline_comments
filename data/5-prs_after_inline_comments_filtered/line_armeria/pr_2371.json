{"pr_number": 2371, "pr_title": "Replace `Optional` with a nullable value", "pr_createdAt": "2020-01-04T16:13:04Z", "pr_url": "https://github.com/line/armeria/pull/2371", "timeline": [{"oid": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "url": "https://github.com/line/armeria/commit/99bcff5748ca8165a0e27efd34d067bf176abeb5", "message": "Replace `Optional` with a nullable value\n\nMotivation:\n\nThe early API such as `Scheme.tryParse()` and `Server.activePort()`\nreturns an `Optional` while more recent APIs just return `null`.\n\nGiven that `Optional` tends to make user code verbose and JDK will not\nmake `Optional` a value type due to backward compatibility, I think it's\nbetter just using a nullable value in our API.\n\nModifications:\n\n- Replace all `Optional` usages with `@Nullable`.\n- Add `MediaType.charset(Charset defaultCharset)` because\n  `MediaType.charset().orElse(UTF_8)` seems pretty common.\n\nResult:\n\n- Fixes #2362\n- (Breaking) Our public API does not expose `Optional` anymore.", "committedDate": "2020-01-04T16:09:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTc0Mg==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363069742", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return the object of the specified {@code type} if found. {@code null} if not found.\n          \n          \n            \n                 * @return the object of the specified {@code type} if found, or {@code null} if not found.\n          \n      \n    \n    \n  \n\nWhile we're here", "author": "anuraaga", "createdAt": "2020-01-05T05:01:19Z", "path": "core/src/main/java/com/linecorp/armeria/client/Client.java", "diffHunk": "@@ -59,22 +57,22 @@\n      *                             .decorator(LoggingClient.newDecorator())\n      *                             .build();\n      *\n-     * LoggingClient unwrapped = client.as(LoggingClient.class).get();\n+     * LoggingClient unwrapped = client.as(LoggingClient.class);\n      *\n      * // You can also use Clients.unwrap(), which is useful especially for\n      * // Thrift and gRPC where the client object does not implement the 'as()' method.\n-     * LoggingClient unwrapped2 = Clients.unwrap(client, LoggingClient.class).get();\n+     * LoggingClient unwrapped2 = Clients.unwrap(client, LoggingClient.class);\n      * }</pre>\n      *\n      * @param type the type of the object to return\n-     * @return the object of the specified {@code type} if found. {@link Optional#empty()} if not found.\n+     * @return the object of the specified {@code type} if found. {@code null} if not found.", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTc0OQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363069749", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return the object of the specified {@code type} if found. {@code null} if not found.\n          \n          \n            \n                 * @return the object of the specified {@code type} if found, or {@code null} if not found.", "author": "anuraaga", "createdAt": "2020-01-05T05:01:30Z", "path": "core/src/main/java/com/linecorp/armeria/client/ClientFactory.java", "diffHunk": "@@ -254,26 +254,27 @@ static void disableShutdownHook() {\n      *                             .decorator(LoggingClient.newDecorator())\n      *                             .build();\n      *\n-     * LoggingClient unwrapped = clientFactory.unwrap(client, LoggingClient.class).get();\n+     * LoggingClient unwrapped = clientFactory.unwrap(client, LoggingClient.class);\n      *\n      * // If the client implements Unwrappable, you can just use the 'as()' method.\n-     * LoggingClient unwrapped2 = client.as(LoggingClient.class).get();\n+     * LoggingClient unwrapped2 = client.as(LoggingClient.class);\n      * }</pre>\n      *\n      * @param client the client object\n      * @param type the type of the object to return\n-     * @return the object of the specified {@code type} if found. {@link Optional#empty()} if not found.\n+     * @return the object of the specified {@code type} if found. {@code null} if not found.", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTc3Nw==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363069777", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return the object of the specified {@code type} if found. {@code null} if not found.\n          \n          \n            \n                 * @return the object of the specified {@code type} if found, or {@code null} if not found.", "author": "anuraaga", "createdAt": "2020-01-05T05:01:55Z", "path": "core/src/main/java/com/linecorp/armeria/client/Clients.java", "diffHunk": "@@ -587,26 +588,27 @@ private static ClientBuilderParams builderParams(Object client) {\n      *                             .decorator(LoggingClient.newDecorator())\n      *                             .build();\n      *\n-     * LoggingClient unwrapped = Clients.unwrap(client, LoggingClient.class).get();\n+     * LoggingClient unwrapped = Clients.unwrap(client, LoggingClient.class);\n      *\n      * // If the client implements Unwrappable, you can just use the 'as()' method.\n-     * LoggingClient unwrapped2 = client.as(LoggingClient.class).get();\n+     * LoggingClient unwrapped2 = client.as(LoggingClient.class);\n      * }</pre>\n      *\n      * @param type the type of the object to return\n-     * @return the object of the specified {@code type} if found. {@link Optional#empty()} if not found.\n+     * @return the object of the specified {@code type} if found. {@code null} if not found.", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTg0Mw==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363069843", "bodyText": "I think I saw this pattern in another PR and found it a bit weird, and now am reconsidering it again. Is it clearer to use throw newInvalidSchemeException(uri) so it's easy to see that this line is throwing an exception, without much change in verbosity (actually guess less characters / bytecode)?", "author": "anuraaga", "createdAt": "2020-01-05T05:04:29Z", "path": "core/src/main/java/com/linecorp/armeria/common/AbstractRequestContextBuilder.java", "diffHunk": "@@ -149,6 +139,27 @@ protected AbstractRequestContextBuilder(boolean server, RpcRequest rpcReq, URI u\n         query = pathAndQuery.query();\n     }\n \n+    private static SessionProtocol getSessionProtocol(URI uri) {\n+        final String schemeStr = uri.getScheme();\n+        if (schemeStr != null && schemeStr.indexOf('+') < 0) {\n+            final SessionProtocol parsed = SessionProtocol.find(schemeStr);\n+            if (parsed == null) {\n+                return reportInvalidScheme(uri);", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4NTI3OQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363185279", "bodyText": "Fixed :-)", "author": "trustin", "createdAt": "2020-01-06T07:37:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTk2OQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363069969", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return the object of the specified {@code type} if found. {@code null} if not found.\n          \n          \n            \n                 * @return the object of the specified {@code type} if found, or {@code null} if not found.", "author": "anuraaga", "createdAt": "2020-01-05T05:08:51Z", "path": "core/src/main/java/com/linecorp/armeria/server/Service.java", "diffHunk": "@@ -69,12 +68,12 @@ default void serviceAdded(ServiceConfig cfg) throws Exception {}\n      * }</pre>\n      *\n      * @param type the type of the object to return\n-     * @return the object of the specified {@code type} if found. {@link Optional#empty()} if not found.\n+     * @return the object of the specified {@code type} if found. {@code null} if not found.", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTk3MQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363069971", "bodyText": "Feels a bit odd to have two Return / @return in a single javadoc.", "author": "anuraaga", "createdAt": "2020-01-05T05:09:12Z", "path": "core/src/main/java/com/linecorp/armeria/server/Server.java", "diffHunk": "@@ -171,11 +170,12 @@ public String defaultHostname() {\n      * Returns the primary {@link ServerPort} that this {@link Server} is listening to. This method is useful\n      * when a {@link Server} listens to only one {@link ServerPort}.\n      *\n-     * @return {@link Optional#empty()} if this {@link Server} did not start\n+     * @return {@code null} if this {@link Server} did not start", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4NTI0Nw==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363185247", "bodyText": "Seems to me that the Javadoc body gets too long if I move what's written in @return..", "author": "trustin", "createdAt": "2020-01-06T07:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA2OTk3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MDAwOQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363070009", "bodyText": "Here especially, I'd expect just , or {@code null}... inlined with the first line.", "author": "anuraaga", "createdAt": "2020-01-05T05:10:42Z", "path": "tomcat/src/main/java/com/linecorp/armeria/server/tomcat/TomcatServiceConfig.java", "diffHunk": "@@ -106,10 +106,11 @@ Path docBase() {\n     /**\n      * Returns the path to the root directory of a web application inside a JAR/WAR.\n      *\n-     * @return {@link Optional#empty()} if {@link #docBase()} is not a JAR/WAR file\n+     * @return {@code null} if {@link #docBase()} is not a JAR/WAR file", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MDA3OQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363070079", "bodyText": "I think IntelliJ refactor might have un-static imported the assertions. Though is migrating to junit5 also the time to migrate to assertj? ;)", "author": "anuraaga", "createdAt": "2020-01-05T05:12:08Z", "path": "thrift/src/test/java/com/linecorp/armeria/client/thrift/ThriftOverHttpClientTServletIntegrationTest.java", "diffHunk": "@@ -191,20 +189,20 @@ public static void destroyServer() throws Exception {\n         });\n     }\n \n-    @Before\n-    public void setUp() {\n+    @BeforeEach\n+    void setUp() {\n         SessionProtocolNegotiationCache.clear();\n         sendConnectionClose.set(false);\n     }\n \n     @Test\n-    public void sendHelloViaHttp1() throws Exception {\n+    void sendHelloViaHttp1() throws Exception {\n         final AtomicReference<SessionProtocol> sessionProtocol = new AtomicReference<>();\n         final HelloService.Iface client = newSchemeCapturingClient(http1uri(HTTP), sessionProtocol);\n \n         for (int i = 0; i <= MAX_RETRIES; i++) {\n             try {\n-                assertEquals(\"Hello, old world!\", client.hello(\"old world\"));\n+                Assertions.assertEquals(\"Hello, old world!\", client.hello(\"old world\"));", "originalCommit": "99bcff5748ca8165a0e27efd34d067bf176abeb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE4NTA2NA==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363185064", "bodyText": "Fixed :-)", "author": "trustin", "createdAt": "2020-01-06T07:36:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzA3MDA3OQ=="}], "type": "inlineReview"}, {"oid": "aae37f1c105276e588b0d66e710959a14f9a3866", "url": "https://github.com/line/armeria/commit/aae37f1c105276e588b0d66e710959a14f9a3866", "message": "Address the comments from @anuraaga", "committedDate": "2020-01-06T07:17:57Z", "type": "commit"}, {"oid": "59ade1bb065bf03ed8025f7d1c9c031895585d7c", "url": "https://github.com/line/armeria/commit/59ade1bb065bf03ed8025f7d1c9c031895585d7c", "message": "Use AssertJ's `Assertions` instead of Jupiter's", "committedDate": "2020-01-06T07:36:11Z", "type": "commit"}, {"oid": "f1e7c60d04dfff396b7d34fd43e58a621089ae23", "url": "https://github.com/line/armeria/commit/f1e7c60d04dfff396b7d34fd43e58a621089ae23", "message": "Indentation", "committedDate": "2020-01-06T07:39:08Z", "type": "commit"}, {"oid": "dd7303466a06387625536e9861af07daa2cdf0ab", "url": "https://github.com/line/armeria/commit/dd7303466a06387625536e9861af07daa2cdf0ab", "message": "throw -> return", "committedDate": "2020-01-06T07:54:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI0NDU2MQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363244561", "bodyText": "Let's make this consistent. or {@code null} otherwise.", "author": "minwoox", "createdAt": "2020-01-06T10:49:09Z", "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/EventCounter.java", "diffHunk": "@@ -28,16 +28,16 @@\n     /**\n      * Counts success events.\n      *\n-     * @return An {@link Optional} containing the current {@link EventCount} if it has been updated,\n-     *         or else an empty {@link Optional}.\n+     * @return the current {@link EventCount} if it has been updated, or else {@code null}.", "originalCommit": "dd7303466a06387625536e9861af07daa2cdf0ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI4NDAxOQ==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363284019", "bodyText": "Fixed", "author": "trustin", "createdAt": "2020-01-06T13:01:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI0NDU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI0NDYxNg==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363244616", "bodyText": "ditto", "author": "minwoox", "createdAt": "2020-01-06T10:49:20Z", "path": "core/src/main/java/com/linecorp/armeria/client/circuitbreaker/EventCounter.java", "diffHunk": "@@ -28,16 +28,16 @@\n     /**\n      * Counts success events.\n      *\n-     * @return An {@link Optional} containing the current {@link EventCount} if it has been updated,\n-     *         or else an empty {@link Optional}.\n+     * @return the current {@link EventCount} if it has been updated, or else {@code null}.\n      */\n-    Optional<EventCount> onSuccess();\n+    @Nullable\n+    EventCount onSuccess();\n \n     /**\n      * Counts failure events.\n      *\n-     * @return An {@link Optional} containing the current {@link EventCount} if it has been updated,\n-     *         or else an empty {@link Optional}.\n+     * @return the current {@link EventCount} if it has been updated, or else {@code null}.", "originalCommit": "dd7303466a06387625536e9861af07daa2cdf0ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI0NDY3OA==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363244678", "bodyText": "ditto", "author": "minwoox", "createdAt": "2020-01-06T10:49:32Z", "path": "core/src/main/java/com/linecorp/armeria/client/retry/Backoff.java", "diffHunk": "@@ -146,12 +145,12 @@ static Backoff of(String specification) {\n      *\n      * @param type the type of the desired {@link Backoff}\n      * @return the {@link Backoff} which is an instance of {@code type} if this {@link Backoff}\n-     *         decorated such a {@link Backoff}. {@link Optional#empty()} otherwise.\n+     *         decorated such a {@link Backoff}. {@code null} otherwise.", "originalCommit": "dd7303466a06387625536e9861af07daa2cdf0ab", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI0NTI2Mw==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363245263", "bodyText": "indentation?", "author": "minwoox", "createdAt": "2020-01-06T10:51:10Z", "path": "core/src/main/java/com/linecorp/armeria/common/MediaType.java", "diffHunk": "@@ -648,31 +667,49 @@ public String subtype() {\n     }\n \n     /**\n-     * Returns an optional charset for the value of the charset parameter if it is specified.\n+     * Returns a {@link Charset} for the value of the charset parameter if it is specified.\n+     *\n+     * @return the {@link Charset}, or {@code null} if the charset parameter is not specified.\n      *\n      * @throws IllegalStateException if multiple charset values have been set for this media type\n      * @throws IllegalCharsetNameException if a charset value is present, but illegal\n      * @throws UnsupportedCharsetException if a charset value is present, but no support is available\n      *     in this instance of the Java virtual machine\n      */\n-    public Optional<Charset> charset() {\n+    @Nullable\n+    public Charset charset() {\n         // racy single-check idiom, this is safe because Optional is immutable.\n-        Optional<Charset> local = parsedCharset;\n+        Charset local = parsedCharset;\n         if (local == null) {\n             String value = null;\n-            local = Optional.empty();\n+            local = NO_CHARSET;\n             for (String currentValue : parameters.get(CHARSET_ATTRIBUTE)) {\n                 if (value == null) {\n                     value = currentValue;\n-                    local = Optional.of(Charset.forName(value));\n+                    local = Charset.forName(value);\n                 } else if (!value.equals(currentValue)) {\n                     throw new IllegalStateException(\n                             \"Multiple charset values defined: \" + value + \", \" + currentValue);\n                 }\n             }\n             parsedCharset = local;\n         }\n-        return local;\n+        return local != NO_CHARSET ? local : null;\n+    }\n+\n+    /**\n+     * Returns a {@link Charset} for the value of the charset parameter if it is specified.\n+     *\n+     * @return the {@link Charset}, or {@code defaultCharset} if the charset parameter is not specified.\n+     *\n+     * @throws IllegalStateException if multiple charset values have been set for this media type\n+     * @throws IllegalCharsetNameException if a charset value is present, but illegal\n+     * @throws UnsupportedCharsetException if a charset value is present, but no support is available\n+     *     in this instance of the Java virtual machine", "originalCommit": "dd7303466a06387625536e9861af07daa2cdf0ab", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI4NDA5OA==", "url": "https://github.com/line/armeria/pull/2371#discussion_r363284098", "bodyText": "Fixed, although it was forked from Guava :-)", "author": "trustin", "createdAt": "2020-01-06T13:02:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzI0NTI2Mw=="}], "type": "inlineReview"}, {"oid": "9b02e3659ca0b7dc09fc2724ff6c25fcb7892449", "url": "https://github.com/line/armeria/commit/9b02e3659ca0b7dc09fc2724ff6c25fcb7892449", "message": "Address the comments from @minwoox", "committedDate": "2020-01-06T13:01:34Z", "type": "commit"}, {"oid": "81ca60bb7c9bfc24d1effad6bc1a9a34582d2531", "url": "https://github.com/line/armeria/commit/81ca60bb7c9bfc24d1effad6bc1a9a34582d2531", "message": "Merge branch 'master' into bye_bye_optional", "committedDate": "2020-01-06T13:05:22Z", "type": "commit"}]}