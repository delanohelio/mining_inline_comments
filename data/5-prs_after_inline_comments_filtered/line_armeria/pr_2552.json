{"pr_number": 2552, "pr_title": "Revamp ZooKeeper{EndpointGroupBuilder, UpdatingListenerBuilder}", "pr_createdAt": "2020-03-05T06:06:08Z", "pr_url": "https://github.com/line/armeria/pull/2552", "timeline": [{"oid": "1ec874c9f497b35588c27cb1430eebef5c43efbe", "url": "https://github.com/line/armeria/commit/1ec874c9f497b35588c27cb1430eebef5c43efbe", "message": "Revamp ZooKeeper{EndpointGroupBuilder, UpdatingListenerBuilder}\n\nMotivation:\n\nA `CuratorFramework` is created internally when building `ZooKeeperEndpointGroup` and `ZooKeeperUpdatingListner`\nif a user specifies a ZooKeeper connection string.\nWays of customizing `CuratorFramework` are different between `ZooKeeperUpdatingListner` and `ZooKeeperEndpointGroupBuilder`\nIt will confuse the user who uses both of them.\n\nModifications:\n\n- Add `AbstractCuratorFrameworkFactoryBuilder` for sharing common\n  methods when configuring `CuratorFramework`\n- Remove `ZooKeeperDefaults` and merge the configures into AbstractCuratorFrameworkFactoryBuilder\n- Migrate Zookeeper test code to JUnit5\n  - Add `ZooKeeperInstanceExtension`\n  - Fork `TemporaryFolder` from CentralDogma\n  - Clean test code\n- Deprecate `ZooKeeperUpdatingListener.nodeValueCodec` in favor of\n  `ZooKeeperUpdatingListener.codec`\n\nResult:\n\nImprove API consistency", "committedDate": "2020-03-05T06:05:40Z", "type": "commit"}, {"oid": "a5eccd4f96b54a5ddefd3e7cedd533cdc1d872df", "url": "https://github.com/line/armeria/commit/a5eccd4f96b54a5ddefd3e7cedd533cdc1d872df", "message": "Revert wrong commit", "committedDate": "2020-03-05T06:06:55Z", "type": "commit"}, {"oid": "dfc6a54998a193be4387cf61ae23ec180b33952c", "url": "https://github.com/line/armeria/commit/dfc6a54998a193be4387cf61ae23ec180b33952c", "message": "Clean up", "committedDate": "2020-03-05T06:15:33Z", "type": "commit"}, {"oid": "efbbecbabe43a917f46581efd89bdcbda386b071", "url": "https://github.com/line/armeria/commit/efbbecbabe43a917f46581efd89bdcbda386b071", "message": "Fix checkstyle", "committedDate": "2020-03-05T06:49:05Z", "type": "commit"}, {"oid": "4dcc9f3011a04961de4630a83e491e8540f97f50", "url": "https://github.com/line/armeria/commit/4dcc9f3011a04961de4630a83e491e8540f97f50", "message": "Move AbstractCuratorFrameworkFactoryBuilder from 'internal.common.zookeeper' to 'common.zookeeper'", "committedDate": "2020-03-05T08:05:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MDk0Mw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388150943", "bodyText": "We have this on line 40 as well. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-03-05T08:51:26Z", "path": "zookeeper/src/main/java/com/linecorp/armeria/server/zookeeper/ZooKeeperUpdatingListenerBuilder.java", "diffHunk": "@@ -53,20 +51,16 @@\n  * <pre>{@code\n  * ZooKeeperUpdatingListener listener =\n  *     ZooKeeperUpdatingListener.builder(curatorFramework, \"/myProductionEndpoints\")\n- *                              .nodeValueCodec(NodeValueCodec.DEFAULT)\n+ *                              .codec(NodeValueCodec.DEFAULT)", "originalCommit": "4dcc9f3011a04961de4630a83e491e8540f97f50", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MjE4MQ==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388152181", "bodyText": "Is there any reason that you deprecated this? because it seems fine to me. \ud83d\ude09", "author": "minwoox", "createdAt": "2020-03-05T08:53:53Z", "path": "zookeeper/src/main/java/com/linecorp/armeria/server/zookeeper/ZooKeeperUpdatingListenerBuilder.java", "diffHunk": "@@ -80,129 +74,97 @@\n      */\n     ZooKeeperUpdatingListenerBuilder(CuratorFramework client, String zNodePath) {\n         this.client = requireNonNull(client, \"client\");\n-        connectionStr = null;\n         this.zNodePath = requireNonNull(zNodePath, \"zNodePath\");\n         checkArgument(!this.zNodePath.isEmpty(), \"zNodePath can't be empty\");\n     }\n \n     /**\n      * Creates a {@link ZooKeeperUpdatingListenerBuilder} with a ZooKeeper connection string and a zNode path.\n      *\n-     * @param connectionStr the ZooKeeper connection string\n+     * @param zkConnectionStr the ZooKeeper connection string\n      * @param zNodePath the ZooKeeper node to register\n      */\n-    ZooKeeperUpdatingListenerBuilder(String connectionStr, String zNodePath) {\n-        this.connectionStr = requireNonNull(connectionStr, \"connectionStr\");\n-        checkArgument(!this.connectionStr.isEmpty(), \"connectionStr can't be empty\");\n+    ZooKeeperUpdatingListenerBuilder(String zkConnectionStr, String zNodePath) {\n+        super(requireNonNull(zkConnectionStr, \"zkConnectionStr\"));\n+        client = null;\n         this.zNodePath = requireNonNull(zNodePath, \"zNodePath\");\n         checkArgument(!this.zNodePath.isEmpty(), \"zNodePath can't be empty\");\n     }\n \n-    private void ensureInternalClient() {\n-        checkState(client == null,\n-                   \"This method is allowed only when created with a connection string.\");\n-    }\n-\n     /**\n-     * Sets the connect timeout.\n-     *\n-     * @param connectTimeout the connect timeout\n-     *\n-     * @throws IllegalStateException if this builder is constructed with\n-     *                               {@link ZooKeeperUpdatingListener#builder(CuratorFramework, String)}\n-     */\n-    public ZooKeeperUpdatingListenerBuilder connectTimeout(Duration connectTimeout) {\n-        requireNonNull(connectTimeout, \"connectTimeout\");\n-        checkArgument(!connectTimeout.isZero() && !connectTimeout.isNegative(),\n-                      \"connectTimeout: %s (expected: > 0)\", connectTimeout);\n-        return connectTimeoutMillis(connectTimeout.toMillis());\n-    }\n-\n-    /**\n-     * Sets the connect timeout (in ms). (default: {@value ZooKeeperDefaults#DEFAULT_CONNECT_TIMEOUT_MS})\n-     *\n-     * @param connectTimeoutMillis the connect timeout\n-     *\n-     * @throws IllegalStateException if this builder is constructed with\n-     *                               {@link ZooKeeperUpdatingListener#builder(CuratorFramework, String)}\n-     */\n-    public ZooKeeperUpdatingListenerBuilder connectTimeoutMillis(long connectTimeoutMillis) {\n-        ensureInternalClient();\n-        checkArgument(connectTimeoutMillis > 0,\n-                      \"connectTimeoutMillis: %s (expected: > 0)\", connectTimeoutMillis);\n-        this.connectTimeoutMillis = Ints.saturatedCast(connectTimeoutMillis);\n-        return this;\n-    }\n-\n-    /**\n-     * Sets the session timeout.\n-     *\n-     * @param sessionTimeout the session timeout\n-     *\n-     * @throws IllegalStateException if this builder is constructed with\n-     *                               {@link ZooKeeperUpdatingListener#builder(CuratorFramework, String)}\n-     */\n-    public ZooKeeperUpdatingListenerBuilder sessionTimeout(Duration sessionTimeout) {\n-        requireNonNull(sessionTimeout, \"sessionTimeout\");\n-        checkArgument(!sessionTimeout.isZero() && !sessionTimeout.isNegative(),\n-                      \"sessionTimeout: %s (expected: > 0)\", sessionTimeout);\n-        return sessionTimeoutMillis(sessionTimeout.toMillis());\n-    }\n-\n-    /**\n-     * Sets the session timeout (in ms). (default: {@value ZooKeeperDefaults#DEFAULT_SESSION_TIMEOUT_MS})\n-     *\n-     * @param sessionTimeoutMillis the session timeout\n+     * Sets the {@link Endpoint} to register. If not set, the current host name is used automatically.\n      *\n-     * @throws IllegalStateException if this builder is constructed with\n-     *                               {@link ZooKeeperUpdatingListener#builder(CuratorFramework, String)}\n+     * @param endpoint the {@link Endpoint} to register\n      */\n-    public ZooKeeperUpdatingListenerBuilder sessionTimeoutMillis(long sessionTimeoutMillis) {\n-        ensureInternalClient();\n-        checkArgument(sessionTimeoutMillis > 0,\n-                      \"sessionTimeoutMillis: %s (expected: > 0)\", sessionTimeoutMillis);\n-        this.sessionTimeoutMillis = Ints.saturatedCast(sessionTimeoutMillis);\n+    public ZooKeeperUpdatingListenerBuilder endpoint(Endpoint endpoint) {\n+        this.endpoint = requireNonNull(endpoint, \"endpoint\");\n         return this;\n     }\n \n     /**\n-     * Sets the {@link Endpoint} to register. If not set, the current host name is used automatically.\n+     * Sets the {@link NodeValueCodec} to encode or decode ZooKeeper data.\n      *\n-     * @param endpoint the {@link Endpoint} to register\n+     * @param nodeValueCodec the {@link NodeValueCodec} instance to use\n      */\n-    public ZooKeeperUpdatingListenerBuilder endpoint(Endpoint endpoint) {\n-        this.endpoint = requireNonNull(endpoint, \"endpoint\");\n+    public ZooKeeperUpdatingListenerBuilder codec(NodeValueCodec nodeValueCodec) {\n+        this.nodeValueCodec = requireNonNull(nodeValueCodec, \"nodeValueCodec\");\n         return this;\n     }\n \n     /**\n      * Sets the {@link NodeValueCodec} to encode or decode ZooKeeper data.\n      *\n      * @param nodeValueCodec the {@link NodeValueCodec} instance to use\n+     *\n+     * @deprecated Use {@link #codec(NodeValueCodec)}\n      */\n+    @Deprecated\n     public ZooKeeperUpdatingListenerBuilder nodeValueCodec(NodeValueCodec nodeValueCodec) {", "originalCommit": "4dcc9f3011a04961de4630a83e491e8540f97f50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5MzM4MQ==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388193381", "bodyText": "Itself is fine for me too. But we use codec(NodeValueCodec nodeValueCodec) as a method name in ZooKeeperEndpointGroupBuilder\n\n  \n    \n      armeria/zookeeper/src/main/java/com/linecorp/armeria/client/zookeeper/ZooKeeperEndpointGroupBuilder.java\n    \n    \n        Lines 80 to 86\n      in\n      6f21290\n    \n    \n    \n    \n\n        \n          \n               /** \n        \n\n        \n          \n                * Sets the {@link NodeValueCodec} of the {@link ZooKeeperEndpointGroup}. \n        \n\n        \n          \n                */ \n        \n\n        \n          \n               public ZooKeeperEndpointGroupBuilder codec(NodeValueCodec nodeValueCodec) { \n        \n\n        \n          \n                   this.nodeValueCodec = requireNonNull(nodeValueCodec, \"nodeValueCodec\"); \n        \n\n        \n          \n                   return this; \n        \n\n        \n          \n               } \n        \n    \n  \n\n\nI'm not strong here, however I think it would be better to offer consistent APIs. :-)", "author": "ikhoon", "createdAt": "2020-03-05T10:08:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4NTI3Mw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388285273", "bodyText": "+1 for using codec() for consistency.", "author": "trustin", "createdAt": "2020-03-05T13:16:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MDY3Nw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388680677", "bodyText": "Then, how about moving this up and add the getter for this?", "author": "minwoox", "createdAt": "2020-03-06T02:18:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc0NTIzMw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388745233", "bodyText": "Then, how about moving this up and add the getter for this?\n\nI thought about this idea too. However, the NodeValueCodec is only used for encoding and decoding Endpoints. AbstractCuratorFrameworkBuilder is an internal API, so I'm not strong here :-)", "author": "ikhoon", "createdAt": "2020-03-06T07:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1Njg2MQ==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388756861", "bodyText": "Ah yes, its name was AbstractCuratorFrameworkBuilder. \ud83d\ude09\nFor me, it's weird that the subclasses of an abstract builder have the same property setter respectively.\nPerhaps it's better to use composition here? I'm not strong this as well. \ud83d\ude06", "author": "minwoox", "createdAt": "2020-03-06T07:55:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MjE4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc2MTk1NQ==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388761955", "bodyText": "Well never mind. I was actually thinking to change the name of the builder to something else but it was hard. \ud83d\ude09 So I guess I'm fine as it is.", "author": "minwoox", "createdAt": "2020-03-06T08:10:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1MjE4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1NTE3Ng==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388155176", "bodyText": "How about adding this class to the extension?", "author": "minwoox", "createdAt": "2020-03-05T08:59:32Z", "path": "zookeeper/src/test/java/com/linecorp/armeria/common/zookeeper/ZooKeeperTestUtil.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.zookeeper;\n+\n+import java.io.IOException;\n+import java.net.InetSocketAddress;\n+import java.net.ServerSocket;\n+import java.util.Random;\n+import java.util.Set;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import com.google.common.collect.ImmutableSet;\n+\n+import com.linecorp.armeria.client.Endpoint;\n+\n+public final class ZooKeeperTestUtil {", "originalCommit": "4dcc9f3011a04961de4630a83e491e8540f97f50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE5NjkzNw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388196937", "bodyText": "That's a good suggestion. This is my considering point. I thought generating random Endpoints is not related to ZooKeeperInstanceExtension.\nI'd like to listen to other folks' opinions too. :-)", "author": "ikhoon", "createdAt": "2020-03-05T10:14:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1NTE3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4NjY0Mg==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388286642", "bodyText": "I prefer keeping ZooKeeperInstanceExtension generic enough just in case we reuse it somewhere else or someone else fork it in their projects.", "author": "trustin", "createdAt": "2020-03-05T13:18:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1NTE3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc1NzI0NA==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388757244", "bodyText": "That makes sense. \ud83d\ude04", "author": "minwoox", "createdAt": "2020-03-06T07:56:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODE1NTE3Ng=="}], "type": "inlineReview"}, {"oid": "f59672f6196b9dabbdb5f0ddcde5cc03c3e43698", "url": "https://github.com/line/armeria/commit/f59672f6196b9dabbdb5f0ddcde5cc03c3e43698", "message": "Address comments by @minwoox / Fix Javadoc", "committedDate": "2020-03-05T10:20:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MzIwOA==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388283208", "bodyText": "ImmutableList.builder()", "author": "trustin", "createdAt": "2020-03-05T13:12:14Z", "path": "zookeeper/src/main/java/com/linecorp/armeria/common/zookeeper/AbstractCuratorFrameworkBuilder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.zookeeper;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.time.Duration;\n+import java.util.function.Consumer;\n+\n+import javax.annotation.Nullable;\n+\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.framework.CuratorFrameworkFactory.Builder;\n+import org.apache.curator.retry.ExponentialBackoffRetry;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Ints;\n+\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * A skeletal builder implementation for {@link CuratorFramework}.\n+ */\n+@UnstableApi\n+public class AbstractCuratorFrameworkBuilder {\n+\n+    private static final int DEFAULT_CONNECT_TIMEOUT_MILLIS = 1000;\n+    private static final int DEFAULT_SESSION_TIMEOUT_MILLIS = 10000;\n+    private static final ExponentialBackoffRetry DEFAULT_RETRY_POLICY =\n+            new ExponentialBackoffRetry(DEFAULT_CONNECT_TIMEOUT_MILLIS, 3);\n+\n+    @Nullable\n+    private final CuratorFrameworkFactory.Builder clientBuilder;\n+    @Nullable\n+    private final ImmutableList.Builder<Consumer<? super Builder>> customizers;\n+\n+    /**\n+     * Creates a new instance with the specified {@code zkConnectionStr}.\n+     */\n+    protected AbstractCuratorFrameworkBuilder(String zkConnectionStr) {\n+        checkArgument(!zkConnectionStr.isEmpty(), \"zkConnectionStr can't be empty\");\n+        clientBuilder = CuratorFrameworkFactory.builder()\n+                                               .connectString(zkConnectionStr)\n+                                               .connectionTimeoutMs(DEFAULT_CONNECT_TIMEOUT_MILLIS)\n+                                               .sessionTimeoutMs(DEFAULT_SESSION_TIMEOUT_MILLIS)\n+                                               .retryPolicy(DEFAULT_RETRY_POLICY);\n+        customizers = new ImmutableList.Builder<>();", "originalCommit": "f59672f6196b9dabbdb5f0ddcde5cc03c3e43698", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc0Mzk5Nw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388743997", "bodyText": "Oops..", "author": "ikhoon", "createdAt": "2020-03-06T07:13:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MzIwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MzI4Nw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388283287", "bodyText": "Missing period", "author": "trustin", "createdAt": "2020-03-05T13:12:23Z", "path": "zookeeper/src/main/java/com/linecorp/armeria/common/zookeeper/AbstractCuratorFrameworkBuilder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.zookeeper;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.time.Duration;\n+import java.util.function.Consumer;\n+\n+import javax.annotation.Nullable;\n+\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.framework.CuratorFrameworkFactory.Builder;\n+import org.apache.curator.retry.ExponentialBackoffRetry;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Ints;\n+\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * A skeletal builder implementation for {@link CuratorFramework}.\n+ */\n+@UnstableApi\n+public class AbstractCuratorFrameworkBuilder {\n+\n+    private static final int DEFAULT_CONNECT_TIMEOUT_MILLIS = 1000;\n+    private static final int DEFAULT_SESSION_TIMEOUT_MILLIS = 10000;\n+    private static final ExponentialBackoffRetry DEFAULT_RETRY_POLICY =\n+            new ExponentialBackoffRetry(DEFAULT_CONNECT_TIMEOUT_MILLIS, 3);\n+\n+    @Nullable\n+    private final CuratorFrameworkFactory.Builder clientBuilder;\n+    @Nullable\n+    private final ImmutableList.Builder<Consumer<? super Builder>> customizers;\n+\n+    /**\n+     * Creates a new instance with the specified {@code zkConnectionStr}.\n+     */\n+    protected AbstractCuratorFrameworkBuilder(String zkConnectionStr) {\n+        checkArgument(!zkConnectionStr.isEmpty(), \"zkConnectionStr can't be empty\");", "originalCommit": "f59672f6196b9dabbdb5f0ddcde5cc03c3e43698", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4MzU0Nw==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388283547", "bodyText": "is -> ms is", "author": "trustin", "createdAt": "2020-03-05T13:12:56Z", "path": "zookeeper/src/main/java/com/linecorp/armeria/common/zookeeper/AbstractCuratorFrameworkBuilder.java", "diffHunk": "@@ -0,0 +1,164 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.common.zookeeper;\n+\n+import static com.google.common.base.Preconditions.checkArgument;\n+import static com.google.common.base.Preconditions.checkState;\n+import static java.util.Objects.requireNonNull;\n+\n+import java.time.Duration;\n+import java.util.function.Consumer;\n+\n+import javax.annotation.Nullable;\n+\n+import org.apache.curator.framework.CuratorFramework;\n+import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.framework.CuratorFrameworkFactory.Builder;\n+import org.apache.curator.retry.ExponentialBackoffRetry;\n+\n+import com.google.common.collect.ImmutableList;\n+import com.google.common.primitives.Ints;\n+\n+import com.linecorp.armeria.common.util.UnstableApi;\n+\n+/**\n+ * A skeletal builder implementation for {@link CuratorFramework}.\n+ */\n+@UnstableApi\n+public class AbstractCuratorFrameworkBuilder {\n+\n+    private static final int DEFAULT_CONNECT_TIMEOUT_MILLIS = 1000;\n+    private static final int DEFAULT_SESSION_TIMEOUT_MILLIS = 10000;\n+    private static final ExponentialBackoffRetry DEFAULT_RETRY_POLICY =\n+            new ExponentialBackoffRetry(DEFAULT_CONNECT_TIMEOUT_MILLIS, 3);\n+\n+    @Nullable\n+    private final CuratorFrameworkFactory.Builder clientBuilder;\n+    @Nullable\n+    private final ImmutableList.Builder<Consumer<? super Builder>> customizers;\n+\n+    /**\n+     * Creates a new instance with the specified {@code zkConnectionStr}.\n+     */\n+    protected AbstractCuratorFrameworkBuilder(String zkConnectionStr) {\n+        checkArgument(!zkConnectionStr.isEmpty(), \"zkConnectionStr can't be empty\");\n+        clientBuilder = CuratorFrameworkFactory.builder()\n+                                               .connectString(zkConnectionStr)\n+                                               .connectionTimeoutMs(DEFAULT_CONNECT_TIMEOUT_MILLIS)\n+                                               .sessionTimeoutMs(DEFAULT_SESSION_TIMEOUT_MILLIS)\n+                                               .retryPolicy(DEFAULT_RETRY_POLICY);\n+        customizers = new ImmutableList.Builder<>();\n+    }\n+\n+    /**\n+     * Creates a new instance.\n+     */\n+    protected AbstractCuratorFrameworkBuilder() {\n+        clientBuilder = null;\n+        customizers = null;\n+    }\n+\n+    /**\n+     * Sets the specified connect timeout. {@value DEFAULT_CONNECT_TIMEOUT_MILLIS} is used by default.", "originalCommit": "f59672f6196b9dabbdb5f0ddcde5cc03c3e43698", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4NTg3Mg==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388285872", "bodyText": "How about just ZooKeeperExtension?", "author": "trustin", "createdAt": "2020-03-05T13:17:22Z", "path": "zookeeper/src/test/java/com/linecorp/armeria/common/zookeeper/ZooKeeperInstanceExtension.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.common.zookeeper;\n+\n+import static com.google.common.base.Preconditions.checkState;\n+\n+import java.time.Duration;\n+\n+import javax.annotation.Nullable;\n+\n+import org.junit.jupiter.api.extension.ExtensionContext;\n+\n+import com.linecorp.armeria.common.util.Exceptions;\n+import com.linecorp.armeria.internal.testing.TemporaryFolder;\n+import com.linecorp.armeria.testing.junit.common.AbstractAllOrEachExtension;\n+\n+import zookeeperjunit.CloseableZooKeeper;\n+import zookeeperjunit.ZKFactory;\n+import zookeeperjunit.ZKInstance;\n+import zookeeperjunit.ZooKeeperAssert;\n+\n+public class ZooKeeperInstanceExtension extends AbstractAllOrEachExtension implements ZooKeeperAssert {", "originalCommit": "f59672f6196b9dabbdb5f0ddcde5cc03c3e43698", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4Nzk5Ng==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388287996", "bodyText": "Perhaps we could move this field up and make buildCuratorFramework() return it? We could add a method like isUserSpecifiedCuratorFramework() to AbstractCuratorFrameworkBuilder.", "author": "trustin", "createdAt": "2020-03-05T13:21:23Z", "path": "zookeeper/src/main/java/com/linecorp/armeria/client/zookeeper/ZooKeeperEndpointGroupBuilder.java", "diffHunk": "@@ -15,58 +15,41 @@\n  */\n package com.linecorp.armeria.client.zookeeper;\n \n-import static com.google.common.base.Preconditions.checkState;\n-import static com.linecorp.armeria.internal.common.zookeeper.ZooKeeperDefaults.DEFAULT_CONNECT_TIMEOUT_MS;\n-import static com.linecorp.armeria.internal.common.zookeeper.ZooKeeperDefaults.DEFAULT_RETRY_POLICY;\n-import static com.linecorp.armeria.internal.common.zookeeper.ZooKeeperDefaults.DEFAULT_SESSION_TIMEOUT_MS;\n import static java.util.Objects.requireNonNull;\n \n-import java.util.ArrayList;\n-import java.util.List;\n+import java.time.Duration;\n import java.util.function.Consumer;\n \n import javax.annotation.Nullable;\n \n import org.apache.curator.framework.CuratorFramework;\n-import org.apache.curator.framework.CuratorFrameworkFactory;\n+import org.apache.curator.framework.CuratorFrameworkFactory.Builder;\n \n import com.linecorp.armeria.client.endpoint.EndpointSelectionStrategy;\n+import com.linecorp.armeria.common.zookeeper.AbstractCuratorFrameworkBuilder;\n import com.linecorp.armeria.common.zookeeper.NodeValueCodec;\n \n /**\n  * Builds a {@link ZooKeeperEndpointGroup}.\n  */\n-public final class ZooKeeperEndpointGroupBuilder {\n+public final class ZooKeeperEndpointGroupBuilder extends AbstractCuratorFrameworkBuilder {\n \n     @Nullable\n     private final CuratorFramework client;", "originalCommit": "f59672f6196b9dabbdb5f0ddcde5cc03c3e43698", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODc0NDEwMQ==", "url": "https://github.com/line/armeria/pull/2552#discussion_r388744101", "bodyText": "That sounds good.", "author": "ikhoon", "createdAt": "2020-03-06T07:14:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODI4Nzk5Ng=="}], "type": "inlineReview"}, {"oid": "b486896042ae1685bb79e32db09b9a90a7d9aaa9", "url": "https://github.com/line/armeria/commit/b486896042ae1685bb79e32db09b9a90a7d9aaa9", "message": "Address comments by @trustin", "committedDate": "2020-03-06T06:56:55Z", "type": "commit"}, {"oid": "a2617ef26836962fc23ce67e86b2c9916a9e15c2", "url": "https://github.com/line/armeria/commit/a2617ef26836962fc23ce67e86b2c9916a9e15c2", "message": "Fix checkstyle", "committedDate": "2020-03-06T08:03:52Z", "type": "commit"}, {"oid": "9360a1279dfbd93fbe6e51fe2bffe3a0286b6e33", "url": "https://github.com/line/armeria/commit/9360a1279dfbd93fbe6e51fe2bffe3a0286b6e33", "message": "Update Javadoc & clean up", "committedDate": "2020-03-06T11:15:42Z", "type": "commit"}, {"oid": "e682a46a5c043c5dc6020d9796c9ef6bc9c5fd2b", "url": "https://github.com/line/armeria/commit/e682a46a5c043c5dc6020d9796c9ef6bc9c5fd2b", "message": "more clean up", "committedDate": "2020-03-06T11:21:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTUzMTU4NA==", "url": "https://github.com/line/armeria/pull/2552#discussion_r389531584", "bodyText": "nit: Now 0.44.4", "author": "trustin", "createdAt": "2020-03-09T09:03:35Z", "path": "testing-internal/src/main/java/com/linecorp/armeria/internal/testing/TemporaryFolder.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2020 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package com.linecorp.armeria.internal.testing;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.util.Comparator;\n+import java.util.stream.Stream;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * A helper class to handle temporary folders in JUnit {@code Extension}s.\n+ */\n+public class TemporaryFolder {\n+\n+    // Forked from CentralDogma 0.44.3", "originalCommit": "e682a46a5c043c5dc6020d9796c9ef6bc9c5fd2b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "63311a2cfebf5feb6089b49efd4f9ca09c9fb36d", "url": "https://github.com/line/armeria/commit/63311a2cfebf5feb6089b49efd4f9ca09c9fb36d", "message": "Update TemporaryFolder.java", "committedDate": "2020-03-09T09:05:58Z", "type": "commit"}]}