{"pr_number": 2500, "pr_title": "Clean up `ClientUtil`", "pr_createdAt": "2020-02-17T14:18:00Z", "pr_url": "https://github.com/line/armeria/pull/2500", "timeline": [{"oid": "79d69c4e977b951f9c9c6380fb2d3bdff14a433b", "url": "https://github.com/line/armeria/commit/79d69c4e977b951f9c9c6380fb2d3bdff14a433b", "message": "Clean up `ClientUtil`\n\nRealized that we already fail the request-side in\n`DefaultClientRequestContext.init()` and `failEarly()`, which allowed me\nto clean up 5c6ac9a77bc303729dbf640c7a0763571f8395b3 a little bit more.\n\nRelated: #2499", "committedDate": "2020-02-17T14:15:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIwNzYyMQ==", "url": "https://github.com/line/armeria/pull/2500#discussion_r380207621", "bodyText": "This rearrangement is to make abort() is called before log completion, like we did in ClientUtil.fail(), for consistency.", "author": "trustin", "createdAt": "2020-02-17T14:19:22Z", "path": "core/src/main/java/com/linecorp/armeria/client/DefaultClientRequestContext.java", "diffHunk": "@@ -257,16 +257,16 @@ private void runThreadLocalContextCustomizers() {\n     }\n \n     private void failEarly(Throwable cause) {\n-        final RequestLogBuilder logBuilder = logBuilder();\n-        final UnprocessedRequestException wrapped = new UnprocessedRequestException(cause);\n-        logBuilder.endRequest(wrapped);\n-        logBuilder.endResponse(wrapped);\n-\n         final HttpRequest req = request();\n         if (req != null) {\n             autoFillSchemeAndAuthority();\n             req.abort(cause);\n         }\n+\n+        final RequestLogBuilder logBuilder = logBuilder();\n+        final UnprocessedRequestException wrapped = new UnprocessedRequestException(cause);\n+        logBuilder.endRequest(wrapped);\n+        logBuilder.endResponse(wrapped);", "originalCommit": "79d69c4e977b951f9c9c6380fb2d3bdff14a433b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxNjA0Nw==", "url": "https://github.com/line/armeria/pull/2500#discussion_r380216047", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    requireNonNull(fallbackResponseFactory, \"fallback\");\n          \n          \n            \n                    requireNonNull(fallbackResponseFactory, \"fallbackResponseFactory\");", "author": "ikhoon", "createdAt": "2020-02-17T14:35:13Z", "path": "core/src/main/java/com/linecorp/armeria/internal/client/ClientUtil.java", "diffHunk": "@@ -79,16 +88,17 @@ private static EndpointGroup mapEndpoint(ClientRequestContext ctx, EndpointGroup\n \n     public static <I extends Request, O extends Response, U extends Client<I, O>>\n     O executeWithFallback(U delegate, ClientRequestContext ctx,\n-                          BiFunction<ClientRequestContext, Throwable, O> fallback) {\n+                          BiFunction<ClientRequestContext, Throwable, O> fallbackResponseFactory) {\n \n         requireNonNull(delegate, \"delegate\");\n         requireNonNull(ctx, \"ctx\");\n-        requireNonNull(fallback, \"fallback\");\n+        requireNonNull(fallbackResponseFactory, \"fallback\");", "originalCommit": "79d69c4e977b951f9c9c6380fb2d3bdff14a433b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIzODc5OQ==", "url": "https://github.com/line/armeria/pull/2500#discussion_r380238799", "bodyText": "Thanks!", "author": "trustin", "createdAt": "2020-02-17T15:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDIxNjA0Nw=="}], "type": "inlineReview"}, {"oid": "1c7bdf96f547adafdab8eb1fc729866921fa8782", "url": "https://github.com/line/armeria/commit/1c7bdf96f547adafdab8eb1fc729866921fa8782", "message": "Update core/src/main/java/com/linecorp/armeria/internal/client/ClientUtil.java\n\nCo-Authored-By: Ikhun Um <ih.pert@gmail.com>", "committedDate": "2020-02-17T15:16:09Z", "type": "commit"}]}