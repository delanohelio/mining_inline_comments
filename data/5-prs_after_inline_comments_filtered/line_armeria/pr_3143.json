{"pr_number": 3143, "pr_title": "Add arbitrary param parsers", "pr_createdAt": "2020-10-28T10:52:10Z", "pr_url": "https://github.com/line/armeria/pull/3143", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MjMzNQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513362335", "bodyText": "How about changing this line, rather than special casing in stringToType()?", "author": "trustin", "createdAt": "2020-10-28T11:16:12Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -74,6 +81,12 @@\n                     .put(Object.class, Function.identity())", "originalCommit": "f5303eea767feb84631e03870a76ffdfeb0e1b7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MjUxMA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513362510", "bodyText": "Never mind. It will not work.", "author": "trustin", "createdAt": "2020-10-28T11:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MjMzNQ=="}], "type": "inlineReview"}, {"oid": "57be31b2608c080096a3cc40e031fb93d342eb99", "url": "https://github.com/line/armeria/commit/57be31b2608c080096a3cc40e031fb93d342eb99", "message": "Add arbitrary param parsers\n\nThis will add the ability to convert String parameters\n(those marked with @Query, @Header and @Param) to be converted\nto any arbitrary object type, provided that the class has at least\none of the following methods (discovered in order):\npublic static T of(String)\npublic static T valueOf(String)\npublic static T fromString(String)\npublic T(String)\n\nIf a method exists but throws an exception on conversion, the next will\nNOT be tried.\n\nCloses #2574", "committedDate": "2020-10-28T11:22:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MzMxNg==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513363316", "bodyText": "Could we skip the method that returns the type that's not compatible with clazz?\nHow about using MethodHandle, which is faster than reflection? https://www.baeldung.com/java-method-handles", "author": "trustin", "createdAt": "2020-10-28T11:18:00Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +95,69 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method with a single {@link String} argument in clazz.\n+     * @param clazz the class being introspected\n+     * @param methodName the method expected\n+     * @param <T> the expected result. It is *not* checked\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    @Nullable\n+    private static <T> Function<String, T> getPublicStaticMethod(final Class<T> clazz,\n+                                                                 final String methodName) {\n+        try {\n+            final Method method = clazz.getMethod(methodName, String.class);", "originalCommit": "f5303eea767feb84631e03870a76ffdfeb0e1b7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3MDAyMg==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513370022", "bodyText": "uhm.. yes.\nNever heard of MethodHandle before. Looking into it", "author": "tobias-", "createdAt": "2020-10-28T11:29:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MzMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NjI3NQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514096275", "bodyText": "Fixed", "author": "tobias-", "createdAt": "2020-10-29T08:55:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2MzMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NDMyOQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513364329", "bodyText": "Ditto - could use method handles?", "author": "trustin", "createdAt": "2020-10-28T11:19:47Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +95,69 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method with a single {@link String} argument in clazz.\n+     * @param clazz the class being introspected\n+     * @param methodName the method expected\n+     * @param <T> the expected result. It is *not* checked\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    @Nullable\n+    private static <T> Function<String, T> getPublicStaticMethod(final Class<T> clazz,\n+                                                                 final String methodName) {\n+        try {\n+            final Method method = clazz.getMethod(methodName, String.class);\n+            return (str) -> {\n+                try {\n+                    return (T) method.invoke(null, str);\n+                } catch (RuntimeException e) {\n+                    throw e;\n+                } catch (Exception e) {\n+                    throw new IllegalArgumentException(e);\n+                }\n+            };\n+        } catch (Throwable t) {\n+            // No valid public static method found\n+        }\n+        return null;\n+    }\n+\n+    @Nullable\n+    private static <T> Function<String, T> getStringConstructor(final Class<T> clazz) {\n+        try {\n+            final Constructor<T> constructor = clazz.getConstructor(String.class);", "originalCommit": "f5303eea767feb84631e03870a76ffdfeb0e1b7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3MDM0Ng==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513370346", "bodyText": "Will do", "author": "tobias-", "createdAt": "2020-10-28T11:30:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NDMyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NjMyNQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514096325", "bodyText": "Fixed", "author": "tobias-", "createdAt": "2020-10-29T08:55:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NDMyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NTY0Mg==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513365642", "bodyText": "Could use Exceptions.throwUnsafely() instead of wrapping with IAE?\nCould catch an InvocationTargetException and unwrap before throwing", "author": "trustin", "createdAt": "2020-10-28T11:22:10Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +95,69 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method with a single {@link String} argument in clazz.\n+     * @param clazz the class being introspected\n+     * @param methodName the method expected\n+     * @param <T> the expected result. It is *not* checked\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    @Nullable\n+    private static <T> Function<String, T> getPublicStaticMethod(final Class<T> clazz,\n+                                                                 final String methodName) {\n+        try {\n+            final Method method = clazz.getMethod(methodName, String.class);\n+            return (str) -> {\n+                try {\n+                    return (T) method.invoke(null, str);\n+                } catch (RuntimeException e) {\n+                    throw e;\n+                } catch (Exception e) {\n+                    throw new IllegalArgumentException(e);\n+                }\n+            };\n+        } catch (Throwable t) {\n+            // No valid public static method found\n+        }\n+        return null;\n+    }\n+\n+    @Nullable\n+    private static <T> Function<String, T> getStringConstructor(final Class<T> clazz) {\n+        try {\n+            final Constructor<T> constructor = clazz.getConstructor(String.class);\n+            return (str) -> {\n+                try {\n+                    return constructor.newInstance(str);\n+                } catch (RuntimeException e) {\n+                    throw e;\n+                } catch (Exception e) {\n+                    throw new IllegalArgumentException(e);\n+                }", "originalCommit": "f5303eea767feb84631e03870a76ffdfeb0e1b7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3MDQxMw==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513370413", "bodyText": "Will do", "author": "tobias-", "createdAt": "2020-10-28T11:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NTY0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NjM4Mg==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514096382", "bodyText": "Fixed", "author": "tobias-", "createdAt": "2020-10-29T08:55:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NTY0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NTcwMg==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513365702", "bodyText": "Could use Exceptions.throwUnsafely() instead of wrapping with IAE?\nCould catch an InvocationTargetException and unwrap before throwing", "author": "trustin", "createdAt": "2020-10-28T11:22:17Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +95,69 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method with a single {@link String} argument in clazz.\n+     * @param clazz the class being introspected\n+     * @param methodName the method expected\n+     * @param <T> the expected result. It is *not* checked\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    @Nullable\n+    private static <T> Function<String, T> getPublicStaticMethod(final Class<T> clazz,\n+                                                                 final String methodName) {\n+        try {\n+            final Method method = clazz.getMethod(methodName, String.class);\n+            return (str) -> {\n+                try {\n+                    return (T) method.invoke(null, str);\n+                } catch (RuntimeException e) {\n+                    throw e;\n+                } catch (Exception e) {\n+                    throw new IllegalArgumentException(e);", "originalCommit": "f5303eea767feb84631e03870a76ffdfeb0e1b7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3MDI2NQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513370265", "bodyText": "Thanks, missed those.", "author": "tobias-", "createdAt": "2020-10-28T11:30:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NTcwMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NjQ1NQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514096455", "bodyText": "Fixed", "author": "tobias-", "createdAt": "2020-10-29T08:55:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NTcwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NjY1Nw==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513366657", "bodyText": "I guess the value doesn't need to be weak. The value will be automatically deferenced when the key is collected.", "author": "trustin", "createdAt": "2020-10-28T11:24:09Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -74,6 +81,12 @@\n                     .put(Object.class, Function.identity())\n                     .build();\n \n+    /**\n+     * \"Cache\" of converters from string to the Class in the key.\n+     */\n+    private static final Map<Class<?>, Function<String, ?>> convertExternalTypes =\n+            new MapMaker().weakKeys().weakValues().makeMap();", "originalCommit": "57be31b2608c080096a3cc40e031fb93d342eb99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2OTA3OQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513369079", "bodyText": "But is the key entry really collected, or just the value of the WeakRef? That question is something I was unsure enough of to just go with weakValues().", "author": "tobias-", "createdAt": "2020-10-28T11:28:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NjY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3MTg5Ng==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513371896", "bodyText": "The value of the WeakReference will be collected. If the map implementation finds out that the WeakReference is empty, the map entry will be cleaned up. I think that's how all weak key maps work in Java. weakValues() basically does the same thing; the only difference is that it does that on an entry value, i.e. if an entry value's WeakReference is empty, it will clean up the entry.", "author": "trustin", "createdAt": "2020-10-28T11:33:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NjY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM3MjYxOA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513372618", "bodyText": "So, in this case, we do not want the entry to be cleaned up when the value is GC'd, because it's very likely that the value (Function) is only referred via this map (convertExternalTypes).", "author": "trustin", "createdAt": "2020-10-28T11:34:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NjY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM5ODMxMw==", "url": "https://github.com/line/armeria/pull/3143#discussion_r513398313", "bodyText": "Very true, didn't think about that case. Will remove weakValues()", "author": "tobias-", "createdAt": "2020-10-28T12:20:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NjY1Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA5NjUxMA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514096510", "bodyText": "Fixed", "author": "tobias-", "createdAt": "2020-10-29T08:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzM2NjY1Nw=="}], "type": "inlineReview"}, {"oid": "9a9fa299cf789ad94eaf49b39c475dfe268d6b0f", "url": "https://github.com/line/armeria/commit/9a9fa299cf789ad94eaf49b39c475dfe268d6b0f", "message": "Add arbitrary param parsers\n\nThis will add the ability to convert String parameters\n(those marked with @Query, @Header and @Param) to be converted\nto any arbitrary object type, provided that the class has at least\none of the following methods (discovered in order):\npublic static T of(String)\npublic static T valueOf(String)\npublic static T fromString(String)\npublic T(String)\n\nIf a method exists but throws an exception on conversion, the next will\nNOT be tried.\n\nCloses #2574", "committedDate": "2020-10-28T12:33:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxNzcwNQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514717705", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright 2018 LINE Corporation\n          \n          \n            \n             * Copyright 2020 LINE Corporation", "author": "heowc", "createdAt": "2020-10-30T02:23:56Z", "path": "core/src/test/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtilTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2018 LINE Corporation", "originalCommit": "9a9fa299cf789ad94eaf49b39c475dfe268d6b0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwNjM3OQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514906379", "bodyText": "Thanks. Fixed for this file.\nThis file is obviously created 2020, but how about the other file? Should I replace the line in\n.../src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java with\nCopyright 2018-2020 LINE Coporation", "author": "tobias-", "createdAt": "2020-10-30T07:08:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxNzcwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3MDI2Mg==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514970262", "bodyText": "Other files don't seem to need to be changed. \ud83d\ude04", "author": "heowc", "createdAt": "2020-10-30T09:32:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxNzcwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxODg0Nw==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514718847", "bodyText": "I think you can remove all public keywords from that class.", "author": "heowc", "createdAt": "2020-10-30T02:25:07Z", "path": "core/src/test/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtilTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2018 LINE Corporation\n+ *\n+ * LINE Corporation licenses this file to you under the Apache License,\n+ * version 2.0 (the \"License\"); you may not use this file except in compliance\n+ * with the License. You may obtain a copy of the License at:\n+ *\n+ *   https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the\n+ * License for the specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package com.linecorp.armeria.internal.server.annotation;\n+\n+import static com.linecorp.armeria.internal.server.annotation.AnnotatedServiceTypeUtil.stringToType;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import java.util.UUID;\n+\n+import org.junit.jupiter.api.Test;\n+\n+public class AnnotatedServiceTypeUtilTest {", "originalCommit": "9a9fa299cf789ad94eaf49b39c475dfe268d6b0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkwNDIwMQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514904201", "bodyText": "Unfortunately, no, as then every inner class will be \"kind of\" implicit package private (ie, unless you use reflections), which will make the constructors also package private, which will make checkstyle complain. So either:\n\nTest class is public\nThe classes only used for these tests are moved into separate files.\n\nI figured adding the public keyword was the easier and cleaner", "author": "tobias-", "createdAt": "2020-10-30T07:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxODg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk3MDYwNw==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514970607", "bodyText": "Oops... sorry for the confusion. Please ignore my comment.", "author": "heowc", "createdAt": "2020-10-30T09:32:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxODg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAxNzExOA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515017118", "bodyText": "No worries. I fought checkstyle for a long time until I understood why it was complaining. (initially I wrote it without the public keyword)", "author": "tobias-", "createdAt": "2020-10-30T11:00:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxODg0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAxOTY0NQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515019645", "bodyText": "You might want to use @SuppressWarnings(\"CheckStyleRuleName\") to suppress that error, but I guess either ways are fine.", "author": "trustin", "createdAt": "2020-10-30T11:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDcxODg0Nw=="}], "type": "inlineReview"}, {"oid": "565febc6a1736f27cb4bba119e32679b398988e6", "url": "https://github.com/line/armeria/commit/565febc6a1736f27cb4bba119e32679b398988e6", "message": "Add arbitrary param parsers\n\nThis will add the ability to convert String parameters\n(those marked with @Query, @Header and @Param) to be converted\nto any arbitrary object type, provided that the class has at least\none of the following methods (discovered in order):\npublic static T of(String)\npublic static T valueOf(String)\npublic static T fromString(String)\npublic T(String)\n\nIf a method exists but throws an exception on conversion, the next will\nNOT be tried.\n\nCloses #2574", "committedDate": "2020-10-30T07:06:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1ODUxOQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514958519", "bodyText": "nit: {@code clazz}", "author": "ikhoon", "createdAt": "2020-10-30T09:10:01Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +99,73 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method {@link MethodHandle} with a single {@link String} argument\n+     * in clazz.", "originalCommit": "565febc6a1736f27cb4bba119e32679b398988e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAxNTk3NA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515015974", "bodyText": "Maybe nitpicking, but valid.", "author": "tobias-", "createdAt": "2020-10-30T10:58:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1ODUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1ODg3NA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r514958874", "bodyText": "nit: {@code clazz}", "author": "ikhoon", "createdAt": "2020-10-30T09:10:46Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +99,73 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method {@link MethodHandle} with a single {@link String} argument\n+     * in clazz.\n+     * @param <T> the expected result\n+     * @param clazz the class being introspected\n+     * @param methodName the method expected\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @Nullable\n+    private static <T> MethodHandle getPublicStaticMethodHandle(final Class<T> clazz,\n+                                                                final String methodName) {\n+        try {\n+            final MethodType methodType = MethodType.methodType(clazz, String.class);\n+            return MethodHandles.publicLookup().findStatic(clazz, methodName, methodType);\n+        } catch (Throwable t) {\n+            // No valid public static method found\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Try to get a constructor {@link MethodHandle} with a single {@link String} argument in clazz.", "originalCommit": "565febc6a1736f27cb4bba119e32679b398988e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAxNTk1NA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515015954", "bodyText": "Maybe nitpicking, but valid.", "author": "tobias-", "createdAt": "2020-10-30T10:58:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk1ODg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAwNTQ4OA==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515005488", "bodyText": "Could we also double check the static method returns the object that's compatible with clazz? i.e.\nif (!clazz.isAssignableFrom(methodType.returnType())) {\n    return;\n}\n\n\n\nCould you also add the test case for the static method that returns an incompatible type? e.g.\npublic class Foo {\n    public static Bar of(String value) { new Bar(value); }\n}\npublic class Bar { ... }", "author": "trustin", "createdAt": "2020-10-30T10:37:23Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +99,73 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method {@link MethodHandle} with a single {@link String} argument\n+     * in clazz.\n+     * @param <T> the expected result\n+     * @param clazz the class being introspected\n+     * @param methodName the method expected\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @Nullable\n+    private static <T> MethodHandle getPublicStaticMethodHandle(final Class<T> clazz,\n+                                                                final String methodName) {\n+        try {\n+            final MethodType methodType = MethodType.methodType(clazz, String.class);\n+            return MethodHandles.publicLookup().findStatic(clazz, methodName, methodType);\n+        } catch (Throwable t) {\n+            // No valid public static method found\n+            return null;\n+        }", "originalCommit": "565febc6a1736f27cb4bba119e32679b398988e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAxODkzNw==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515018937", "bodyText": "Could you also add the test case for the static method that returns an incompatible type? e.g.\npublic class Foo {\n    public static Bar of(String value) { new Bar(value); }\n}\npublic class Bar { ... }\n\n\n\n\nExcellent point. Done!", "author": "tobias-", "createdAt": "2020-10-30T11:04:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAwNTQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAwNjA2Mw==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515006063", "bodyText": "How about returning early when methodHandle == null so we reduce the cognitive load of the reader?", "author": "trustin", "createdAt": "2020-10-30T10:38:33Z", "path": "core/src/main/java/com/linecorp/armeria/internal/server/annotation/AnnotatedServiceTypeUtil.java", "diffHunk": "@@ -82,6 +99,73 @@\n                     .put(\"0\", false)\n                     .build();\n \n+    /**\n+     * Try to get a public static method {@link MethodHandle} with a single {@link String} argument\n+     * in clazz.\n+     * @param <T> the expected result\n+     * @param clazz the class being introspected\n+     * @param methodName the method expected\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @Nullable\n+    private static <T> MethodHandle getPublicStaticMethodHandle(final Class<T> clazz,\n+                                                                final String methodName) {\n+        try {\n+            final MethodType methodType = MethodType.methodType(clazz, String.class);\n+            return MethodHandles.publicLookup().findStatic(clazz, methodName, methodType);\n+        } catch (Throwable t) {\n+            // No valid public static method found\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Try to get a constructor {@link MethodHandle} with a single {@link String} argument in clazz.\n+     * @param <T> the expected result\n+     * @param clazz the class being introspected\n+     * @return a function that takes a {@link String} and produces a {@link T}\n+     */\n+    @Nullable\n+    private static <T> MethodHandle getStringConstructorMethodHandle(final Class<T> clazz) {\n+        try {\n+            final MethodType methodType = MethodType.methodType(void.class, String.class);\n+            return MethodHandles.publicLookup().findConstructor(clazz, methodType);\n+        } catch (Throwable t) {\n+            // No valid constructor found\n+            return null;\n+        }\n+    }\n+\n+    /**\n+     * Try to get a function that can create an instance of type {@code clazz} with a single\n+     * {@link String} argument.\n+     * @param <T> the expected resulting type\n+     * @param clazz the class being introspected\n+     * @return a function that takes a {@link String} and produces a {@code T}\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    @Nullable\n+    static <T> Function<String, T> getCreatorMethod(Class<T> clazz) {\n+        final MethodHandle methodHandle = Stream.of(\"of\", \"valueOf\", \"fromString\")\n+                     .map((methodName) -> getPublicStaticMethodHandle(clazz, methodName))\n+                     .filter(Objects::nonNull)\n+                     .findFirst()\n+                     .orElseGet(() -> getStringConstructorMethodHandle(clazz));\n+        if (methodHandle != null) {", "originalCommit": "565febc6a1736f27cb4bba119e32679b398988e6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAxNzczOQ==", "url": "https://github.com/line/armeria/pull/3143#discussion_r515017739", "bodyText": "Done!\nI've gotten too used to Kotlin and if-is-expression, where this makes sense (single return or even no explicit return statement in the method).", "author": "tobias-", "createdAt": "2020-10-30T11:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTAwNjA2Mw=="}], "type": "inlineReview"}, {"oid": "e5d2902ed9451e1fd7432c0c374f154c67e2b1e6", "url": "https://github.com/line/armeria/commit/e5d2902ed9451e1fd7432c0c374f154c67e2b1e6", "message": "Add arbitrary param parsers\n\nThis will add the ability to convert String parameters\n(those marked with @Query, @Header and @Param) to be converted\nto any arbitrary object type, provided that the class has at least\none of the following methods (discovered in order):\npublic static T of(String)\npublic static T valueOf(String)\npublic static T fromString(String)\npublic T(String)\n\nIf a method exists but throws an exception on conversion, the next will\nNOT be tried.\n\nCloses #2574", "committedDate": "2020-10-30T11:01:27Z", "type": "forcePushed"}, {"oid": "ded76975068fd1bdc5d6a9979846bfbacc3dbb28", "url": "https://github.com/line/armeria/commit/ded76975068fd1bdc5d6a9979846bfbacc3dbb28", "message": "Add arbitrary param parsers\n\nThis will add the ability to convert String parameters\n(those marked with @Query, @Header and @Param) to be converted\nto any arbitrary object type, provided that the class has at least\none of the following methods (discovered in order):\npublic static T of(String)\npublic static T valueOf(String)\npublic static T fromString(String)\npublic T(String)\n\nIf a method exists but throws an exception on conversion, the next will\nNOT be tried.\n\nCloses #2574", "committedDate": "2020-10-30T11:34:31Z", "type": "commit"}, {"oid": "ded76975068fd1bdc5d6a9979846bfbacc3dbb28", "url": "https://github.com/line/armeria/commit/ded76975068fd1bdc5d6a9979846bfbacc3dbb28", "message": "Add arbitrary param parsers\n\nThis will add the ability to convert String parameters\n(those marked with @Query, @Header and @Param) to be converted\nto any arbitrary object type, provided that the class has at least\none of the following methods (discovered in order):\npublic static T of(String)\npublic static T valueOf(String)\npublic static T fromString(String)\npublic T(String)\n\nIf a method exists but throws an exception on conversion, the next will\nNOT be tried.\n\nCloses #2574", "committedDate": "2020-10-30T11:34:31Z", "type": "forcePushed"}]}