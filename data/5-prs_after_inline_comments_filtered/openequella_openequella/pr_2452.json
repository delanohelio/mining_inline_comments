{"pr_number": 2452, "pr_title": "Allow skipping tests in TestNG at runtime", "pr_createdAt": "2020-10-23T00:22:02Z", "pr_url": "https://github.com/openequella/openEQUELLA/pull/2452", "timeline": [{"oid": "695b2bf51bf8b413d76ba1c980301dfe664a097b", "url": "https://github.com/openequella/openEQUELLA/commit/695b2bf51bf8b413d76ba1c980301dfe664a097b", "message": "Refactor the TestNG Transformer directory structure", "committedDate": "2020-10-22T22:37:08Z", "type": "commit"}, {"oid": "0a334d9a2efed4f082c943b2b4b13dd3a526ae5b", "url": "https://github.com/openequella/openEQUELLA/commit/0a334d9a2efed4f082c943b2b4b13dd3a526ae5b", "message": "Add a new annotation to skip tests in TestNG.", "committedDate": "2020-10-22T22:39:43Z", "type": "commit"}, {"oid": "0fd7f34b93caebc6e6a891c3bcef144e5c5a20c5", "url": "https://github.com/openequella/openEQUELLA/commit/0fd7f34b93caebc6e6a891c3bcef144e5c5a20c5", "message": "Use the SkipTest annotation to skip tests at runtime.", "committedDate": "2020-10-23T00:00:18Z", "type": "commit"}, {"oid": "5eae8de91eede5ad5871f1bb1ca27b4901b4446b", "url": "https://github.com/openequella/openEQUELLA/commit/5eae8de91eede5ad5871f1bb1ca27b4901b4446b", "message": "Skip NewSearchPageTest when CI is in Old UI.", "committedDate": "2020-10-23T00:02:01Z", "type": "commit"}, {"oid": "8fae8a78b1f5023c7314b9e83db4d87dc5cc9822", "url": "https://github.com/openequella/openEQUELLA/commit/8fae8a78b1f5023c7314b9e83db4d87dc5cc9822", "message": "Update 'testng-codebuild.yaml' to use the TestAnnotationTransformer.", "committedDate": "2020-10-23T00:07:11Z", "type": "commit"}, {"oid": "33b5649303f469297725d95b1c1561c96e766420", "url": "https://github.com/openequella/openEQUELLA/commit/33b5649303f469297725d95b1c1561c96e766420", "message": "Remove the skipping test workaround added in NewSearchPageTest.", "committedDate": "2020-10-23T00:08:48Z", "type": "commit"}, {"oid": "6752dfe3786d8939e866db3b7771663d2b2a85de", "url": "https://github.com/openequella/openEQUELLA/commit/6752dfe3786d8939e866db3b7771663d2b2a85de", "message": "Add environment variable 'OLD_TEST_NEWUI' in buildspec.yml", "committedDate": "2020-10-23T00:15:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzMjg5MA==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510532890", "bodyText": "I wonder if people want to add this annotation on class level. Adding it on method level gives more flexibility though.", "author": "PenghaiZhang", "createdAt": "2020-10-23T00:32:35Z", "path": "autotest/OldTests/src/test/java/io/github/openequella/search/NewSearchPageTest.java", "diffHunk": "@@ -18,13 +19,15 @@ protected void prepareBrowserSession() {\n   }\n \n   @Test(description = \"open the new Search page and wait for initial search completed\")\n+  @SkipTest(skipOldUI = true)", "originalCommit": "6752dfe3786d8939e866db3b7771663d2b2a85de", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0MzEwNA==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510643104", "bodyText": "Depends. If this class is dedicated to newUI, I'd say put it at the class level.", "author": "edalex-ian", "createdAt": "2020-10-23T06:02:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDUzMjg5MA=="}], "type": "inlineReview"}, {"oid": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975", "url": "https://github.com/openequella/openEQUELLA/commit/2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975", "message": "Remove an error configuration for testng-codebuild listener.", "committedDate": "2020-10-23T03:22:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0NjcwOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510646709", "bodyText": "Arguably these should be split out into two methods:\n\ncheckRetryAnnotation; and\ncheckSkipTestAnnotation.", "author": "edalex-ian", "createdAt": "2020-10-23T06:05:47Z", "path": "autotest/OldTests/src/test/java/testng/TestAnnotationTransformer.java", "diffHunk": "@@ -0,0 +1,31 @@\n+package testng;\n+\n+import java.lang.reflect.Constructor;\n+import java.lang.reflect.Method;\n+import org.testng.IAnnotationTransformer;\n+import org.testng.annotations.ITestAnnotation;\n+import testng.annotation.RetryTest;\n+import testng.annotation.SkipTest;\n+\n+public class TestAnnotationTransformer implements IAnnotationTransformer {\n+  private static final String OLD_TEST_NEWUI = \"OLD_TEST_NEWUI\";\n+\n+  @Override\n+  public void transform(\n+      ITestAnnotation annotation, Class testClass, Constructor testConstructor, Method testMethod) {\n+    if (testMethod == null) return;\n+\n+    RetryTest maxRetryCount = testMethod.getAnnotation(RetryTest.class);\n+    if (maxRetryCount != null && maxRetryCount.value() > 1) {\n+      annotation.setRetryAnalyzer(FailureRetryAnalyzer.class);\n+    }\n+\n+    SkipTest skipTest = testMethod.getAnnotation(SkipTest.class);\n+    // Read the configuration of using new UI or not from environment variable.\n+    boolean isNewUIEnabled = Boolean.parseBoolean(System.getProperty(OLD_TEST_NEWUI));\n+    // Skip tests that should not run against Old UI when CI is running in Old UI.\n+    if (skipTest != null && skipTest.skipOldUI() && !isNewUIEnabled) {\n+      annotation.setEnabled(false);\n+    }", "originalCommit": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY0OTEzMQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r510649131", "bodyText": "Seeing this annotation is just about skipping base on old vs new, should we maybe go with naming like NewUiOnly? And have a simple value so that then you can have:\n@NewUiOnly(true)\n@Test\nclass NewUiTests {", "author": "edalex-ian", "createdAt": "2020-10-23T06:08:26Z", "path": "autotest/OldTests/src/test/java/testng/annotation/SkipTest.java", "diffHunk": "@@ -0,0 +1,9 @@\n+package testng.annotation;\n+\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.RetentionPolicy;\n+\n+@Retention(RetentionPolicy.RUNTIME)\n+public @interface SkipTest {", "originalCommit": "2e8ea9c228c17ff0ce1cc3c2ee3809effe0f6975", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "882cb9d416d83e0adad5ccc61c04009a16a92270", "url": "https://github.com/openequella/openEQUELLA/commit/882cb9d416d83e0adad5ccc61c04009a16a92270", "message": "Check why NewSearchPageTest was skipped on both New and Old UI.", "committedDate": "2020-10-25T22:17:25Z", "type": "commit"}, {"oid": "ae076406f8fe3231d96ca0ccfddc7b01dd39ce6a", "url": "https://github.com/openequella/openEQUELLA/commit/ae076406f8fe3231d96ca0ccfddc7b01dd39ce6a", "message": "Rename annotation 'SkipTest' to 'NewUIOnly'.", "committedDate": "2020-10-25T22:39:43Z", "type": "commit"}, {"oid": "dd59edc3b57bce8ff95c9c54c956feabf8e7d678", "url": "https://github.com/openequella/openEQUELLA/commit/dd59edc3b57bce8ff95c9c54c956feabf8e7d678", "message": "Refactor method 'transform' of TestAnnotationTransformer.", "committedDate": "2020-10-25T22:40:56Z", "type": "commit"}, {"oid": "10e91c0eb7ca75b07591caeac1c8ca58dea7d8da", "url": "https://github.com/openequella/openEQUELLA/commit/10e91c0eb7ca75b07591caeac1c8ca58dea7d8da", "message": "Use 'getenv' to access environment variable 'OLD_TEST_NEWUI'.", "committedDate": "2020-10-25T22:44:21Z", "type": "commit"}, {"oid": "5b44fb0cabdaa83ea2dc81c9878f75025ee9ea0f", "url": "https://github.com/openequella/openEQUELLA/commit/5b44fb0cabdaa83ea2dc81c9878f75025ee9ea0f", "message": "Remove testing code added in TestAnnotationTransformer.", "committedDate": "2020-10-25T23:05:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDk2NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r512114965", "bodyText": "out of curiosity, why does this need to be passed true?\nWouldn't it default to true?", "author": "ChristianMurphy", "createdAt": "2020-10-26T16:51:48Z", "path": "autotest/OldTests/src/test/java/io/github/openequella/search/NewSearchPageTest.java", "diffHunk": "@@ -18,13 +19,15 @@ protected void prepareBrowserSession() {\n   }\n \n   @Test(description = \"open the new Search page and wait for initial search completed\")\n+  @NewUIOnly(true)", "originalCommit": "5b44fb0cabdaa83ea2dc81c9878f75025ee9ea0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMwOTQzOQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r512309439", "bodyText": "Oh I thought it defaults to false \ud83e\udd14  I might be wrong.", "author": "PenghaiZhang", "createdAt": "2020-10-26T22:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMxMDQ5NQ==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r512310495", "bodyText": "Okay, and why is the default false?\nIf it shouldn't run in NewUIOnly, wouldn't it not have the NewUIOnly annotation?\nIt seems like false would be the exception, not the rule?\nUnless I'm missing some context here", "author": "ChristianMurphy", "createdAt": "2020-10-26T22:37:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDk2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMyMzA5NA==", "url": "https://github.com/openequella/openEQUELLA/pull/2452#discussion_r512323094", "bodyText": "I think you are right!", "author": "PenghaiZhang", "createdAt": "2020-10-26T23:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjExNDk2NQ=="}], "type": "inlineReview"}, {"oid": "9e1d826e90747b21862fa4f57c76f4cd6fc62765", "url": "https://github.com/openequella/openEQUELLA/commit/9e1d826e90747b21862fa4f57c76f4cd6fc62765", "message": "Change the default value of annotation 'NewUIOnly' to true.", "committedDate": "2020-10-26T23:16:05Z", "type": "commit"}]}