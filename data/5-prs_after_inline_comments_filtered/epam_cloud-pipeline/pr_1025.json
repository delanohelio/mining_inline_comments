{"pr_number": 1025, "pr_title": "Issue 1013 allow to restrict non supported docker images", "pr_createdAt": "2020-03-31T17:29:19Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1025", "timeline": [{"oid": "936ec060fd7cb561544ba1966754a15489a4b527", "url": "https://github.com/epam/cloud-pipeline/commit/936ec060fd7cb561544ba1966754a15489a4b527", "message": "(issue #1013) docker comp scan add analizer to be able to get OS version", "committedDate": "2020-03-30T14:05:07Z", "type": "commit"}, {"oid": "a2f999e0a063110fda3b1263d2a34135b6a4c2bc", "url": "https://github.com/epam/cloud-pipeline/commit/a2f999e0a063110fda3b1263d2a34135b6a4c2bc", "message": "(issue #1013) tests", "committedDate": "2020-03-30T14:24:51Z", "type": "commit"}, {"oid": "0da70706f0d57befd178b5d84e6b9951fc7ebe63", "url": "https://github.com/epam/cloud-pipeline/commit/0da70706f0d57befd178b5d84e6b9951fc7ebe63", "message": "(issue #1013) introduce ToolOSVersion", "committedDate": "2020-03-31T13:39:00Z", "type": "commit"}, {"oid": "d7b17ba6d5a4084ab1f51af95bb74579fc43d79e", "url": "https://github.com/epam/cloud-pipeline/commit/d7b17ba6d5a4084ab1f51af95bb74579fc43d79e", "message": "(issue #1013) tests", "committedDate": "2020-03-31T14:16:05Z", "type": "commit"}, {"oid": "275059754b1269b5b4e10a6c4409d6abeffd47f9", "url": "https://github.com/epam/cloud-pipeline/commit/275059754b1269b5b4e10a6c4409d6abeffd47f9", "message": "(issue #1013) change regexp for system-release file", "committedDate": "2020-03-31T15:21:10Z", "type": "commit"}, {"oid": "55a08c9ba7e7cf2ecad429c1a51edfd45592a724", "url": "https://github.com/epam/cloud-pipeline/commit/55a08c9ba7e7cf2ecad429c1a51edfd45592a724", "message": "(issue #1013) logging", "committedDate": "2020-03-31T17:00:45Z", "type": "commit"}, {"oid": "b417382f7ec16f6a121cef20dc2e6c1e77f54ec4", "url": "https://github.com/epam/cloud-pipeline/commit/b417382f7ec16f6a121cef20dc2e6c1e77f54ec4", "message": "(issue #1013) default value for system pref", "committedDate": "2020-03-31T17:24:52Z", "type": "commit"}, {"oid": "cd15e4e0547449d043aa59e996f12de155955fff", "url": "https://github.com/epam/cloud-pipeline/commit/cd15e4e0547449d043aa59e996f12de155955fff", "message": "(issue #1013) cleanup", "committedDate": "2020-03-31T17:43:44Z", "type": "commit"}, {"oid": "cd15e4e0547449d043aa59e996f12de155955fff", "url": "https://github.com/epam/cloud-pipeline/commit/cd15e4e0547449d043aa59e996f12de155955fff", "message": "(issue #1013) cleanup", "committedDate": "2020-03-31T17:43:44Z", "type": "forcePushed"}, {"oid": "e0532d223425ff169bd8e2948ab49b1e92148018", "url": "https://github.com/epam/cloud-pipeline/commit/e0532d223425ff169bd8e2948ab49b1e92148018", "message": "(issue #1013) check that tool os version start with allowed os version, not contain", "committedDate": "2020-04-01T09:41:43Z", "type": "commit"}, {"oid": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "url": "https://github.com/epam/cloud-pipeline/commit/c1b7f642f3e26af876277c9f701968a68a7b2ee1", "message": "Allow to restrict \"non-supported\" docker images (#1013) - GUI part implemented", "committedDate": "2020-04-01T12:41:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc4OTE4NA==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r401789184", "bodyText": "Maybe use Optional here?", "author": "mzueva", "createdAt": "2020-04-01T17:32:49Z", "path": "api/src/main/java/com/epam/pipeline/dao/tool/ToolVulnerabilityDao.java", "diffHunk": "@@ -260,6 +263,10 @@ private static MapSqlParameterSource getParams(long toolId, String version, Stri\n             params.addValue(ToolVersionColumns.SUCCESS_SCAN_DATE.name(),\n                             newStatus == ToolScanStatus.COMPLETED ? scanDate : null);\n             params.addValue(ToolVersionColumns.WHITE_LIST.name(), whiteList);\n+            params.addValue(ToolVersionColumns.OS_NAME.name(),\n+                    toolOSVersion != null ? toolOSVersion.getDistribution() : null);", "originalCommit": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5MDIwNg==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r401790206", "bodyText": "You can use log formatting:\nLOGGER.debug(\"Tool: {} version: {} \", tool.getId(), version) ...", "author": "mzueva", "createdAt": "2020-04-01T17:34:25Z", "path": "api/src/main/java/com/epam/pipeline/manager/docker/scan/AggregatingToolScanManager.java", "diffHunk": "@@ -235,6 +237,16 @@ public boolean checkTool(Tool tool, String tag) {\n                     maxMediumVulnerabilities < severityCounters.getOrDefault(VulnerabilitySeverity.Medium, 0)) {\n                 return false;\n             }\n+\n+            LOGGER.debug(\"Tool: \" + tool.getId() + \" version: \" + tag +", "originalCommit": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5MjA1Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r401792057", "bodyText": "I see a lot of changes where null is added as argument to method updateToolVersionScanStatus. Maybe we should introduce overloaded method without osVersion argument  to reduce number of changes to the code?", "author": "mzueva", "createdAt": "2020-04-01T17:37:22Z", "path": "api/src/main/java/com/epam/pipeline/manager/docker/DockerRegistryManager.java", "diffHunk": "@@ -490,7 +490,7 @@ private DockerRegistry loadByIdOrName(DockerRegistry registry) {\n                     toolGroup.getName()));\n             toolManager.updateToolVersionScanStatus(toolInGroup.get().getId(),\n                     ToolScanStatus.NOT_SCANNED, DateUtils.now(), event.getTarget().getTag(),\n-                    null, event.getTarget().getDigest());\n+                    null, null, event.getTarget().getDigest());", "originalCommit": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5Mjk0MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r401792940", "bodyText": "Please, don't miss final", "author": "mzueva", "createdAt": "2020-04-01T17:38:50Z", "path": "docker-comp-scan/src/main/java/com/epam/dockercompscan/owasp/analyzer/OSVersionAnalyzer.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.dockercompscan.owasp.analyzer;\n+\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.filefilter.NameFileFilter;\n+import org.owasp.dependencycheck.Engine;\n+import org.owasp.dependencycheck.analyzer.AbstractFileTypeAnalyzer;\n+import org.owasp.dependencycheck.analyzer.AnalysisPhase;\n+import org.owasp.dependencycheck.analyzer.Experimental;\n+import org.owasp.dependencycheck.analyzer.exception.AnalysisException;\n+import org.owasp.dependencycheck.dependency.Confidence;\n+import org.owasp.dependencycheck.dependency.Dependency;\n+import org.owasp.dependencycheck.dependency.EvidenceType;\n+import org.owasp.dependencycheck.exception.InitializationException;\n+import org.owasp.dependencycheck.utils.FileFilterBuilder;\n+\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+@Experimental\n+public class OSVersionAnalyzer extends AbstractFileTypeAnalyzer {\n+\n+    public static final String DEPENDENCY_ECOSYSTEM = \"OS\";\n+\n+    public static final String ANALYZER_OS_ENABLED = AnalyzeEnabler.ANALYZER_OS_PACKAGE.getValue();\n+\n+    /**\n+     * The name of the analyzer.\n+     */\n+    private static final String ANALYZER_NAME = \"OS Version Analyzer\";\n+\n+    /**\n+     * The phase that this analyzer is intended to run in.\n+     */\n+    private static final AnalysisPhase ANALYSIS_PHASE = AnalysisPhase.INFORMATION_COLLECTION;\n+\n+    /**\n+     * Names of OS version files to analyze.\n+     */\n+    private static final String OS_RELEASE = \"os-release\";\n+    private static final String REDHAT_RELEASE = \"redhat-release\";\n+    private static final String SYSTEM_RELEASE = \"system-release\";\n+    private static final String CENTOS_RELEASE = \"centos-release\";\n+\n+    /**\n+     * Filter that detects files named \"os-release\".\n+     */\n+    private static final NameFileFilter NAME_FILE_FILTER = new NameFileFilter(\n+            new String[]{OS_RELEASE, REDHAT_RELEASE, SYSTEM_RELEASE, CENTOS_RELEASE});\n+\n+    /**\n+     * The file filter used to determine which files this analyzer supports.\n+     */\n+    private static final FileFilter FILTER = FileFilterBuilder.newInstance().addFileFilters(NAME_FILE_FILTER).build();\n+\n+    private static final Pattern VERSION_PATTERN = Pattern.compile(\".*\\nVERSION_ID=\\\"?([^\\n\\\"]*)\\\"?\\n.*\");\n+    private static final Pattern NAME_TITLE_PATTERN = Pattern.compile(\".*\\nID=\\\"?([^\\n\\\"]*)\\\"?\\n.*\");\n+    private static final Pattern SYSTEM_NAME_TITLE_PATTERN = Pattern.compile(\"([^ ]+).*\");\n+    private static final Pattern SYSTEM_VERSION_PATTERN = Pattern.compile(\"([\\\\d\\\\.\\\\-_]+)\");\n+\n+    @Override\n+    protected FileFilter getFileFilter() {\n+        return FILTER;\n+    }\n+\n+    @Override\n+    protected void prepareFileTypeAnalyzer(final Engine engine) throws InitializationException {\n+    }\n+\n+    @Override\n+    protected String getAnalyzerEnabledSettingKey() {\n+        return ANALYZER_OS_ENABLED;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return ANALYZER_NAME;\n+    }\n+\n+    @Override\n+    public AnalysisPhase getAnalysisPhase() {\n+        return ANALYSIS_PHASE;\n+    }\n+\n+    @Override\n+    protected void analyzeDependency(final Dependency dependency, final Engine engine) throws AnalysisException {\n+        final File actualFile = dependency.getActualFile();\n+        try {\n+            String contents = FileUtils.readFileToString(actualFile, Charset.defaultCharset()).trim();", "originalCommit": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5MzcxNA==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r401793714", "bodyText": "Please check and exit first:\nif (StringUtils.isEmpty(contents)) {\n    return;\n}", "author": "mzueva", "createdAt": "2020-04-01T17:40:11Z", "path": "docker-comp-scan/src/main/java/com/epam/dockercompscan/owasp/analyzer/OSVersionAnalyzer.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.dockercompscan.owasp.analyzer;\n+\n+import org.apache.commons.io.FileUtils;\n+import org.apache.commons.io.filefilter.NameFileFilter;\n+import org.owasp.dependencycheck.Engine;\n+import org.owasp.dependencycheck.analyzer.AbstractFileTypeAnalyzer;\n+import org.owasp.dependencycheck.analyzer.AnalysisPhase;\n+import org.owasp.dependencycheck.analyzer.Experimental;\n+import org.owasp.dependencycheck.analyzer.exception.AnalysisException;\n+import org.owasp.dependencycheck.dependency.Confidence;\n+import org.owasp.dependencycheck.dependency.Dependency;\n+import org.owasp.dependencycheck.dependency.EvidenceType;\n+import org.owasp.dependencycheck.exception.InitializationException;\n+import org.owasp.dependencycheck.utils.FileFilterBuilder;\n+\n+import java.io.File;\n+import java.io.FileFilter;\n+import java.io.IOException;\n+import java.nio.charset.Charset;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+@Experimental\n+public class OSVersionAnalyzer extends AbstractFileTypeAnalyzer {\n+\n+    public static final String DEPENDENCY_ECOSYSTEM = \"OS\";\n+\n+    public static final String ANALYZER_OS_ENABLED = AnalyzeEnabler.ANALYZER_OS_PACKAGE.getValue();\n+\n+    /**\n+     * The name of the analyzer.\n+     */\n+    private static final String ANALYZER_NAME = \"OS Version Analyzer\";\n+\n+    /**\n+     * The phase that this analyzer is intended to run in.\n+     */\n+    private static final AnalysisPhase ANALYSIS_PHASE = AnalysisPhase.INFORMATION_COLLECTION;\n+\n+    /**\n+     * Names of OS version files to analyze.\n+     */\n+    private static final String OS_RELEASE = \"os-release\";\n+    private static final String REDHAT_RELEASE = \"redhat-release\";\n+    private static final String SYSTEM_RELEASE = \"system-release\";\n+    private static final String CENTOS_RELEASE = \"centos-release\";\n+\n+    /**\n+     * Filter that detects files named \"os-release\".\n+     */\n+    private static final NameFileFilter NAME_FILE_FILTER = new NameFileFilter(\n+            new String[]{OS_RELEASE, REDHAT_RELEASE, SYSTEM_RELEASE, CENTOS_RELEASE});\n+\n+    /**\n+     * The file filter used to determine which files this analyzer supports.\n+     */\n+    private static final FileFilter FILTER = FileFilterBuilder.newInstance().addFileFilters(NAME_FILE_FILTER).build();\n+\n+    private static final Pattern VERSION_PATTERN = Pattern.compile(\".*\\nVERSION_ID=\\\"?([^\\n\\\"]*)\\\"?\\n.*\");\n+    private static final Pattern NAME_TITLE_PATTERN = Pattern.compile(\".*\\nID=\\\"?([^\\n\\\"]*)\\\"?\\n.*\");\n+    private static final Pattern SYSTEM_NAME_TITLE_PATTERN = Pattern.compile(\"([^ ]+).*\");\n+    private static final Pattern SYSTEM_VERSION_PATTERN = Pattern.compile(\"([\\\\d\\\\.\\\\-_]+)\");\n+\n+    @Override\n+    protected FileFilter getFileFilter() {\n+        return FILTER;\n+    }\n+\n+    @Override\n+    protected void prepareFileTypeAnalyzer(final Engine engine) throws InitializationException {\n+    }\n+\n+    @Override\n+    protected String getAnalyzerEnabledSettingKey() {\n+        return ANALYZER_OS_ENABLED;\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return ANALYZER_NAME;\n+    }\n+\n+    @Override\n+    public AnalysisPhase getAnalysisPhase() {\n+        return ANALYSIS_PHASE;\n+    }\n+\n+    @Override\n+    protected void analyzeDependency(final Dependency dependency, final Engine engine) throws AnalysisException {\n+        final File actualFile = dependency.getActualFile();\n+        try {\n+            String contents = FileUtils.readFileToString(actualFile, Charset.defaultCharset()).trim();\n+            collectDescriptionData(dependency, actualFile.getName(), contents);\n+        } catch (IOException e) {\n+            throw new AnalysisException(\"Problem occurred while reading dependency file.\", e);\n+        }\n+    }\n+\n+    private void collectDescriptionData(final Dependency dependency, final String source, final String contents) {\n+        if (!contents.isEmpty()) {", "originalCommit": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5NTAzMQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r401795031", "bodyText": "I think it is not the best idea to have field isAllowed in this class, as it is not stored in DB and actually is mutated and set in runtime.", "author": "mzueva", "createdAt": "2020-04-01T17:42:29Z", "path": "api/src/main/java/com/epam/pipeline/entity/scan/ToolOSVersion.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.entity.scan;\n+\n+import lombok.AllArgsConstructor;\n+import lombok.Data;\n+import lombok.RequiredArgsConstructor;\n+\n+@Data\n+@RequiredArgsConstructor\n+@AllArgsConstructor\n+public class ToolOSVersion {\n+    private final String distribution;\n+    private final String version;\n+    private Boolean isAllowed;", "originalCommit": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5NzQ3NQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r401797475", "bodyText": "I think we can get SystemPreference value and check os version at this point and remove isAllowed field from object itself.", "author": "mzueva", "createdAt": "2020-04-01T17:46:38Z", "path": "api/src/main/java/com/epam/pipeline/manager/docker/scan/AggregatingToolScanManager.java", "diffHunk": "@@ -235,6 +237,16 @@ public boolean checkTool(Tool tool, String tag) {\n                     maxMediumVulnerabilities < severityCounters.getOrDefault(VulnerabilitySeverity.Medium, 0)) {\n                 return false;\n             }\n+\n+            LOGGER.debug(\"Tool: \" + tool.getId() + \" version: \" + tag +\n+                    \"Check tool os version.\");\n+            if (toolVersionScanResult.getToolOSVersion() != null\n+                    && !toolVersionScanResult.getToolOSVersion().getIsAllowed()) {", "originalCommit": "c1b7f642f3e26af876277c9f701968a68a7b2ee1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d6cf4c9e7e48f7d4716146374841d1301af1f0a0", "url": "https://github.com/epam/cloud-pipeline/commit/d6cf4c9e7e48f7d4716146374841d1301af1f0a0", "message": "(issue #1013) clean up", "committedDate": "2020-04-02T10:15:18Z", "type": "commit"}, {"oid": "1515d92b2fd17f405a6ddfc95d96076e35549cb9", "url": "https://github.com/epam/cloud-pipeline/commit/1515d92b2fd17f405a6ddfc95d96076e35549cb9", "message": "(issue #1013) introduce View objects for Tool scan related objects", "committedDate": "2020-04-02T12:09:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMwMzYzMA==", "url": "https://github.com/epam/cloud-pipeline/pull/1025#discussion_r402303630", "bodyText": "Please, remove star import", "author": "mzueva", "createdAt": "2020-04-02T13:16:19Z", "path": "api/src/main/java/com/epam/pipeline/manager/pipeline/ToolApiService.java", "diffHunk": "@@ -21,9 +21,7 @@\n import com.epam.pipeline.entity.docker.ToolDescription;\n import com.epam.pipeline.entity.docker.ToolVersion;\n import com.epam.pipeline.entity.pipeline.Tool;\n-import com.epam.pipeline.entity.scan.ToolScanPolicy;\n-import com.epam.pipeline.entity.scan.ToolScanResult;\n-import com.epam.pipeline.entity.scan.ToolVersionScanResult;\n+import com.epam.pipeline.entity.scan.*;", "originalCommit": "1515d92b2fd17f405a6ddfc95d96076e35549cb9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "47689efb8771a4dfc4f103b198e88773514eccdc", "url": "https://github.com/epam/cloud-pipeline/commit/47689efb8771a4dfc4f103b198e88773514eccdc", "message": "(issue #1013) imports", "committedDate": "2020-04-02T13:21:16Z", "type": "commit"}]}