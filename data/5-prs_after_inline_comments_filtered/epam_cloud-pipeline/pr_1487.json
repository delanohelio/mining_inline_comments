{"pr_number": 1487, "pr_title": "Issue 1405 Implemented tests for configuration controllers", "pr_createdAt": "2020-10-12T08:50:36Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1487", "timeline": [{"oid": "37dd4254c6ff689daf5c6da31c30bb8ce110222e", "url": "https://github.com/epam/cloud-pipeline/commit/37dd4254c6ff689daf5c6da31c30bb8ce110222e", "message": "Issue #1405: Implemented tests for ConfigurationController", "committedDate": "2020-10-16T14:18:29Z", "type": "commit"}, {"oid": "97797aa2e939376d6c21379d56eaaf7a671eba4f", "url": "https://github.com/epam/cloud-pipeline/commit/97797aa2e939376d6c21379d56eaaf7a671eba4f", "message": "Issue #1405: ConfigurationCreatorUtils used, implemented tests for ServerlessConfigurationController", "committedDate": "2020-10-16T14:18:29Z", "type": "commit"}, {"oid": "eeb7721209fb42ce9f97f90b36327bdab8b3d885", "url": "https://github.com/epam/cloud-pipeline/commit/eeb7721209fb42ce9f97f90b36327bdab8b3d885", "message": "Issue #1405: TypeReference creation moved to CreatorUtils", "committedDate": "2020-10-16T14:18:30Z", "type": "commit"}, {"oid": "5feff350fc48ba1378caab093528eea66599b04b", "url": "https://github.com/epam/cloud-pipeline/commit/5feff350fc48ba1378caab093528eea66599b04b", "message": "Issue #1405: Configuration controllers test classes refactoring", "committedDate": "2020-10-16T14:35:09Z", "type": "commit"}, {"oid": "5feff350fc48ba1378caab093528eea66599b04b", "url": "https://github.com/epam/cloud-pipeline/commit/5feff350fc48ba1378caab093528eea66599b04b", "message": "Issue #1405: Configuration controllers test classes refactoring", "committedDate": "2020-10-16T14:35:09Z", "type": "forcePushed"}, {"oid": "64f383ab199d4f2c72eed074c8098fd503b94503", "url": "https://github.com/epam/cloud-pipeline/commit/64f383ab199d4f2c72eed074c8098fd503b94503", "message": "Issue #1405: Removed extra line breaks", "committedDate": "2020-10-19T11:19:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3MzM1Ng==", "url": "https://github.com/epam/cloud-pipeline/pull/1487#discussion_r508373356", "bodyText": "Could you please check that POST, GET, PUT and DELETE requests can be made. For example parameterized test can be of help here.", "author": "tcibinan", "createdAt": "2020-10-20T10:04:36Z", "path": "api/src/test/java/com/epam/pipeline/controller/configuration/ServerlessConfigurationControllerTest.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.configuration;\n+\n+import com.epam.pipeline.controller.Result;\n+import com.epam.pipeline.manager.configuration.ServerlessConfigurationApiService;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import com.fasterxml.jackson.core.type.TypeReference;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+import static org.mockito.Matchers.eq;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+\n+@WebMvcTest(controllers = ServerlessConfigurationController.class)\n+public class ServerlessConfigurationControllerTest extends AbstractControllerTest {\n+\n+    private static final long ID = 1L;\n+    private static final String TEST_CONFIG = \"testConfig\";\n+    private static final String RESULT = \"RESULT\";\n+    private static final String SERVERLESS_URL = SERVLET_PATH + \"/serverless\";\n+    private static final String GENERATE_URL = SERVERLESS_URL + \"/url/%d\";\n+    private static final String RUN_URL = SERVERLESS_URL + \"/%d/%s\";\n+    private static final TypeReference<Result<String>> STRING_TYPE = new TypeReference<Result<String>>() { };\n+\n+    @Autowired\n+    private ServerlessConfigurationApiService mockServerlessConfigurationApiService;\n+\n+    @Test\n+    public void shouldFailGenerateUrlForUnauthorizedUser() throws Exception {\n+        performUnauthorizedRequest(get(String.format(GENERATE_URL, ID)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldGenerateUrl() throws Exception {\n+        Mockito.doReturn(RESULT).when(mockServerlessConfigurationApiService).generateUrl(ID, TEST_CONFIG);\n+\n+        final MvcResult mvcResult = performRequest(\n+                get(String.format(GENERATE_URL, ID)).param(\"config\", TEST_CONFIG)\n+        );\n+\n+        Mockito.verify(mockServerlessConfigurationApiService).generateUrl(ID, TEST_CONFIG);\n+        assertResponse(mvcResult, RESULT, STRING_TYPE);\n+    }\n+\n+    @Test\n+    public void shouldFailRunForUnauthorizedUser() throws Exception {\n+        performUnauthorizedRequest(get(String.format(RUN_URL, ID, TEST_CONFIG)));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldRun() throws Exception {\n+        Mockito.doReturn(RESULT).when(mockServerlessConfigurationApiService)\n+                .run(eq(ID), eq(TEST_CONFIG), Mockito.any());\n+\n+        performRequest(get(String.format(RUN_URL, ID, TEST_CONFIG)));\n+\n+        Mockito.verify(mockServerlessConfigurationApiService).run(eq(ID), eq(TEST_CONFIG), Mockito.any());\n+    }", "originalCommit": "64f383ab199d4f2c72eed074c8098fd503b94503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM3NzMyNQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1487#discussion_r508377325", "bodyText": "You have to create an additional instance of run configuration. Otherwise the test class will fail once tests execution order is different which is possible since junit 4 doesn't have any guarantees on tests execution order.", "author": "tcibinan", "createdAt": "2020-10-20T10:10:46Z", "path": "api/src/test/java/com/epam/pipeline/controller/configuration/ConfigurationControllerTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.configuration;\n+\n+import com.epam.pipeline.config.JsonMapper;\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.manager.configuration.RunConfigurationApiService;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = ConfigurationController.class)\n+public class ConfigurationControllerTest extends AbstractControllerTest {\n+\n+    private static final long ID = 1L;\n+    private static final String CONFIGURATION_URL = SERVLET_PATH + \"/configuration\";\n+    private static final String CONFIGURATION_BY_ID_URL = CONFIGURATION_URL + \"/%d\";\n+    private static final String ALL_CONFIGURATIONS_URL = CONFIGURATION_URL + \"/loadAll\";\n+    private JsonMapper mapper;\n+    private final RunConfiguration runConfiguration = ConfigurationCreatorUtils.getRunConfiguration();\n+    private final RunConfigurationVO runConfigurationVO = ConfigurationCreatorUtils.getRunConfigurationVO();\n+\n+    @Autowired\n+    private RunConfigurationApiService mockRunConfigurationApiService;\n+\n+    @Before\n+    public void setUp() {\n+        mapper = getObjectMapper();\n+        mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);\n+    }\n+\n+    @Test\n+    public void shouldFailSaveConfigurationForUnauthorizedUser() throws Exception {\n+        performUnauthorizedRequest(post(CONFIGURATION_URL));\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldSaveConfiguration() throws Exception {\n+        final String content = getObjectMapper().writeValueAsString(runConfigurationVO);\n+        Mockito.doReturn(runConfiguration).when(mockRunConfigurationApiService).save(Mockito.refEq(runConfigurationVO));\n+\n+        final MvcResult mvcResult = performRequest(post(CONFIGURATION_URL).content(content));\n+\n+        Mockito.verify(mockRunConfigurationApiService).save(Mockito.refEq(runConfigurationVO));\n+        assertResponse(mvcResult, mapper, runConfiguration, ConfigurationCreatorUtils.RUN_CONFIGURATION_TYPE);\n+    }\n+\n+    @Test\n+    @WithMockUser\n+    public void shouldUpdateConfiguration() throws Exception {\n+        runConfigurationVO.setId(ID);", "originalCommit": "64f383ab199d4f2c72eed074c8098fd503b94503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQwMjQ5OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1487#discussion_r508402498", "bodyText": "Unfortunately this doesn't work as you would expect. Basically getObjectMapper() doesn't return a new instance on each call.\nTo do this properly we have to use two instances of object mappers. Default one which is used for serialization / deserialization in spring cannot be used as is in tests. It can be used for serialization but not for deserealization. Therefore let's use two object mappers in the abstract class. Something like the following can be of help.\nfinal ObjectMapper serializationObjectMapper = currentObjectMapper;\nfinal ObjectMapper deserializationObjectMapper = JsonMapper.newInstance();\ndeserializationObjectMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);\n...\nfinal Result<T> actualResult = JsonMapper.parseData(actual, typeReference, deserializationObjectMapper);", "author": "tcibinan", "createdAt": "2020-10-20T10:52:14Z", "path": "api/src/test/java/com/epam/pipeline/controller/configuration/ConfigurationControllerTest.java", "diffHunk": "@@ -0,0 +1,138 @@\n+/*\n+ * Copyright 2017-2020 EPAM Systems, Inc. (https://www.epam.com/)\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.epam.pipeline.controller.configuration;\n+\n+import com.epam.pipeline.config.JsonMapper;\n+import com.epam.pipeline.controller.vo.configuration.RunConfigurationVO;\n+import com.epam.pipeline.entity.configuration.RunConfiguration;\n+import com.epam.pipeline.manager.configuration.RunConfigurationApiService;\n+import com.epam.pipeline.test.creator.configuration.ConfigurationCreatorUtils;\n+import com.epam.pipeline.test.web.AbstractControllerTest;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.Mockito;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.autoconfigure.web.servlet.WebMvcTest;\n+import org.springframework.security.test.context.support.WithMockUser;\n+import org.springframework.test.web.servlet.MvcResult;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.delete;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.post;\n+\n+@WebMvcTest(controllers = ConfigurationController.class)\n+public class ConfigurationControllerTest extends AbstractControllerTest {\n+\n+    private static final long ID = 1L;\n+    private static final String CONFIGURATION_URL = SERVLET_PATH + \"/configuration\";\n+    private static final String CONFIGURATION_BY_ID_URL = CONFIGURATION_URL + \"/%d\";\n+    private static final String ALL_CONFIGURATIONS_URL = CONFIGURATION_URL + \"/loadAll\";\n+    private JsonMapper mapper;\n+    private final RunConfiguration runConfiguration = ConfigurationCreatorUtils.getRunConfiguration();\n+    private final RunConfigurationVO runConfigurationVO = ConfigurationCreatorUtils.getRunConfigurationVO();\n+\n+    @Autowired\n+    private RunConfigurationApiService mockRunConfigurationApiService;\n+\n+    @Before\n+    public void setUp() {\n+        mapper = getObjectMapper();\n+        mapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);", "originalCommit": "64f383ab199d4f2c72eed074c8098fd503b94503", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "de73fd1887b676c66491a37840169fa7d6351de8", "url": "https://github.com/epam/cloud-pipeline/commit/de73fd1887b676c66491a37840169fa7d6351de8", "message": "Issue #1405: Extra mapper for deserialization added to AbstractControllerTest, test execution order dependency fixed", "committedDate": "2020-10-21T10:52:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MjYzNg==", "url": "https://github.com/epam/cloud-pipeline/pull/1487#discussion_r510692636", "bodyText": "Let's move it to a class field.", "author": "tcibinan", "createdAt": "2020-10-23T07:37:57Z", "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "diffHunk": "@@ -81,13 +83,16 @@ protected final JsonMapper getObjectMapper() {\n                                    final JsonMapper objectMapper,\n                                    final T payload,\n                                    final TypeReference<Result<T>> typeReference) throws Exception {\n+        final ObjectMapper deserializationMapper = JsonMapper.newInstance();\n+        deserializationMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);", "originalCommit": "de73fd1887b676c66491a37840169fa7d6351de8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDY5MzQ4Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1487#discussion_r510693482", "bodyText": "Please use either Assert.assertSomething or just assertSomething syntax, not both. It is pretty hard to read if the code is not consistent.", "author": "tcibinan", "createdAt": "2020-10-23T07:39:39Z", "path": "api/src/test/java/com/epam/pipeline/test/web/AbstractControllerTest.java", "diffHunk": "@@ -81,13 +83,16 @@ protected final JsonMapper getObjectMapper() {\n                                    final JsonMapper objectMapper,\n                                    final T payload,\n                                    final TypeReference<Result<T>> typeReference) throws Exception {\n+        final ObjectMapper deserializationMapper = JsonMapper.newInstance();\n+        deserializationMapper.disable(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES);\n         final ResponseResult<T> expectedResult = buildExpectedResult(payload);\n \n         final String actual = mvcResult.getResponse().getContentAsString();\n         Assert.assertTrue(StringUtils.isNotBlank(actual));\n         assertThat(actual).isEqualToIgnoringWhitespace(objectMapper.writeValueAsString(expectedResult));\n \n-        final Result<T> actualResult = JsonMapper.parseData(actual, typeReference);\n+        final Result<T> actualResult = JsonMapper.parseData(actual, typeReference, deserializationMapper);\n+        assertNotNull(actualResult);\n         Assert.assertEquals(expectedResult.getPayload(), actualResult.getPayload());", "originalCommit": "de73fd1887b676c66491a37840169fa7d6351de8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f3c904d2006aa07b04d9e909e62c5955b92b1aa5", "url": "https://github.com/epam/cloud-pipeline/commit/f3c904d2006aa07b04d9e909e62c5955b92b1aa5", "message": "Issue #1405: Moved deserializationMapper to class field, removed unused assertResponseMethod, common style to assertions applied", "committedDate": "2020-10-23T10:29:22Z", "type": "commit"}]}