{"pr_number": 1651, "pr_title": "Issue #1645: Rewrite RunApiServiceTest", "pr_createdAt": "2020-12-11T15:22:27Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1651", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNDcxMA==", "url": "https://github.com/epam/cloud-pipeline/pull/1651#discussion_r546624710", "bodyText": "Could you please double check if the test logic correct?", "author": "ekazachkova", "createdAt": "2020-12-21T10:22:50Z", "path": "api/src/test/java/com/epam/pipeline/acl/run/RunApiServiceTest.java", "diffHunk": "@@ -96,181 +77,182 @@\n     @Autowired\n     private EntityManager mockEntityManager;\n \n-    private RunAclFactory runAclFactory;\n-    private PipelineAclFactory pipelineAclFactory;\n-    private ToolAclFactory toolAclFactory;\n-\n     @Autowired\n-    public void setRunAclFactory(final AuthManager authManager,\n-                                 final PipelineRunManager mockRunManager) {\n-        this.runAclFactory = new RunAclFactory(authManager, mockRunManager);\n-    }\n-\n-    @Autowired\n-    public void setPipelineAclFactory(final AuthManager authManager,\n-                                      final GrantPermissionManager grantPermissionManager,\n-                                      final JdbcMutableAclServiceImpl aclService,\n-                                      final UserManager mockUserManager,\n-                                      final PipelineManager mockPipelineManager,\n-                                      final EntityManager mockEntityManager) {\n-        this.pipelineAclFactory = new PipelineAclFactory(authManager,\n-                grantPermissionManager, aclService, mockUserManager,\n-                mockPipelineManager, mockEntityManager);\n-    }\n+    private ToolManager mockToolManager;\n \n-    @Autowired\n-    public void setToolAclFactory(final AuthManager authManager, final ToolManager mockToolManager) {\n-        this.toolAclFactory = new ToolAclFactory(authManager, mockToolManager);\n-    }\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadToolRunForOwner() {\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n+        mockAuthUser(ANOTHER_SIMPLE_USER);\n \n-    @After\n-    public void tearDown() {\n-        aclCache.clearCache();\n+        assertThat(runApiService.loadPipelineRun(ID)).isEqualTo(pipelineRun);\n     }\n \n     @Test\n-    @WithMockUser(username = TEST_OWNER)\n-    public void loadToolRunShouldBeAllowedForOwner() {\n-        runAclFactory.initToolPipelineRunForCurrentUser();\n-        assertThat(runApiService.loadPipelineRun(TEST_RUN_ID).getId(), equalTo(TEST_RUN_ID));\n-    }\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyLoadToolRunForNonOwner() {\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = TEST_USER1)\n-    public void loadToolRunShouldBeDeniedForNonOwner() {\n-        runAclFactory.initToolPipelineRunForOwner(TEST_OWNER);\n-        runApiService.loadPipelineRun(TEST_RUN_ID);\n+        assertThrows(AccessDeniedException.class, () -> runApiService.loadPipelineRun(ID));\n     }\n \n     @Test\n-    @WithMockUser(username = TEST_ADMIN_NAME, roles = {TEST_ADMIN_ROLE})\n-    public void loadToolRunShouldBeAllowedForAdmin() {\n-        runAclFactory.initToolPipelineRunForOwner(TEST_OWNER);\n-        assertThat(runApiService.loadPipelineRun(TEST_RUN_ID).getId(), equalTo(TEST_RUN_ID));\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldLoadToolRunForAdmin() {\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n+\n+        assertThat(runApiService.loadPipelineRun(ID)).isEqualTo(pipelineRun);\n     }\n \n     @Test\n-    @WithMockUser(username = TEST_USER1)\n-    public void loadPipelineRunShouldBeAllowedForOwner() {\n-        final Pipeline pipeline = pipelineAclFactory.initPipelineForCurrentUser();\n-        runAclFactory.initPipelineRunForCurrentUser(pipeline);\n-        assertThat(runApiService.loadPipelineRun(TEST_RUN_ID).getId(), equalTo(TEST_RUN_ID));\n+    @WithMockUser\n+    public void shouldLoadPipelineRunForOwner() {\n+        final PipelineRun pipelineRun = getPipelineRun(ID, SIMPLE_USER);", "originalCommit": "2dcdee5d0c4bccb7b9827dbd05ba6d8f8641a14d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjYyNTU2NQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1651#discussion_r546625565", "bodyText": "Add space please.", "author": "ekazachkova", "createdAt": "2020-12-21T10:24:34Z", "path": "api/src/test/java/com/epam/pipeline/acl/run/RunApiServiceTest.java", "diffHunk": "@@ -96,181 +77,182 @@\n     @Autowired\n     private EntityManager mockEntityManager;\n \n-    private RunAclFactory runAclFactory;\n-    private PipelineAclFactory pipelineAclFactory;\n-    private ToolAclFactory toolAclFactory;\n-\n     @Autowired\n-    public void setRunAclFactory(final AuthManager authManager,\n-                                 final PipelineRunManager mockRunManager) {\n-        this.runAclFactory = new RunAclFactory(authManager, mockRunManager);\n-    }\n-\n-    @Autowired\n-    public void setPipelineAclFactory(final AuthManager authManager,\n-                                      final GrantPermissionManager grantPermissionManager,\n-                                      final JdbcMutableAclServiceImpl aclService,\n-                                      final UserManager mockUserManager,\n-                                      final PipelineManager mockPipelineManager,\n-                                      final EntityManager mockEntityManager) {\n-        this.pipelineAclFactory = new PipelineAclFactory(authManager,\n-                grantPermissionManager, aclService, mockUserManager,\n-                mockPipelineManager, mockEntityManager);\n-    }\n+    private ToolManager mockToolManager;\n \n-    @Autowired\n-    public void setToolAclFactory(final AuthManager authManager, final ToolManager mockToolManager) {\n-        this.toolAclFactory = new ToolAclFactory(authManager, mockToolManager);\n-    }\n+    @Test\n+    @WithMockUser\n+    public void shouldLoadToolRunForOwner() {\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n+        mockAuthUser(ANOTHER_SIMPLE_USER);\n \n-    @After\n-    public void tearDown() {\n-        aclCache.clearCache();\n+        assertThat(runApiService.loadPipelineRun(ID)).isEqualTo(pipelineRun);\n     }\n \n     @Test\n-    @WithMockUser(username = TEST_OWNER)\n-    public void loadToolRunShouldBeAllowedForOwner() {\n-        runAclFactory.initToolPipelineRunForCurrentUser();\n-        assertThat(runApiService.loadPipelineRun(TEST_RUN_ID).getId(), equalTo(TEST_RUN_ID));\n-    }\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyLoadToolRunForNonOwner() {\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = TEST_USER1)\n-    public void loadToolRunShouldBeDeniedForNonOwner() {\n-        runAclFactory.initToolPipelineRunForOwner(TEST_OWNER);\n-        runApiService.loadPipelineRun(TEST_RUN_ID);\n+        assertThrows(AccessDeniedException.class, () -> runApiService.loadPipelineRun(ID));\n     }\n \n     @Test\n-    @WithMockUser(username = TEST_ADMIN_NAME, roles = {TEST_ADMIN_ROLE})\n-    public void loadToolRunShouldBeAllowedForAdmin() {\n-        runAclFactory.initToolPipelineRunForOwner(TEST_OWNER);\n-        assertThat(runApiService.loadPipelineRun(TEST_RUN_ID).getId(), equalTo(TEST_RUN_ID));\n+    @WithMockUser(roles = ADMIN_ROLE)\n+    public void shouldLoadToolRunForAdmin() {\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n+\n+        assertThat(runApiService.loadPipelineRun(ID)).isEqualTo(pipelineRun);\n     }\n \n     @Test\n-    @WithMockUser(username = TEST_USER1)\n-    public void loadPipelineRunShouldBeAllowedForOwner() {\n-        final Pipeline pipeline = pipelineAclFactory.initPipelineForCurrentUser();\n-        runAclFactory.initPipelineRunForCurrentUser(pipeline);\n-        assertThat(runApiService.loadPipelineRun(TEST_RUN_ID).getId(), equalTo(TEST_RUN_ID));\n+    @WithMockUser\n+    public void shouldLoadPipelineRunForOwner() {\n+        final PipelineRun pipelineRun = getPipelineRun(ID, SIMPLE_USER);\n+        pipelineRun.setPipelineId(pipelineRun.getId());\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n+        mockAuthUser(SIMPLE_USER);\n+\n+        assertThat(runApiService.loadPipelineRun(ID).getId()).isEqualTo(pipeline.getId());\n     }\n \n-    @Test(expected = AccessDeniedException.class)\n-    @WithMockUser(username = TEST_USER1)\n-    public void loadPipelineRunShouldBeDeniedForNonOwner() {\n-        final Pipeline pipeline = pipelineAclFactory.initPipelineForOwner(TEST_OWNER);\n-        runAclFactory.initPipelineRunForOwner(pipeline, TEST_OWNER);\n-        runApiService.loadPipelineRun(TEST_RUN_ID);\n+    @Test\n+    @WithMockUser(username = SIMPLE_USER)\n+    public void shouldDenyLoadPipelineRunForNonOwner() {\n+        doReturn(pipelineRun).when(mockRunManager).loadPipelineRun(ID);\n+        doReturn(pipeline).when(mockRunManager).loadRunParent(pipelineRun);\n+        initAclEntity(pipeline);\n+        mockSecurityContext();\n+\n+        assertThrows(AccessDeniedException.class, () ->runApiService.loadPipelineRun(ID));", "originalCommit": "2dcdee5d0c4bccb7b9827dbd05ba6d8f8641a14d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d5a9b4e32c97e785dcc335ec865cbac2802b039", "url": "https://github.com/epam/cloud-pipeline/commit/7d5a9b4e32c97e785dcc335ec865cbac2802b039", "message": "Issue #1645: Fixed loadPipeline test", "committedDate": "2020-12-21T14:48:31Z", "type": "forcePushed"}, {"oid": "458ffe4e0507f0b82a9223516ea8da1d874f7c68", "url": "https://github.com/epam/cloud-pipeline/commit/458ffe4e0507f0b82a9223516ea8da1d874f7c68", "message": "Issue #1645: Rewrote RunApiServiceTest using new approach", "committedDate": "2020-12-22T10:37:26Z", "type": "commit"}, {"oid": "3089adeaedbc4a4a1ec4568432ea698a47e76c63", "url": "https://github.com/epam/cloud-pipeline/commit/3089adeaedbc4a4a1ec4568432ea698a47e76c63", "message": "Issue #1645: Removed old acl config and unused factory classes", "committedDate": "2020-12-22T10:38:46Z", "type": "commit"}, {"oid": "4588c075eb4a74581d89f2fd0ab5124fa1411e00", "url": "https://github.com/epam/cloud-pipeline/commit/4588c075eb4a74581d89f2fd0ab5124fa1411e00", "message": "Issue #1645: Renamed test", "committedDate": "2020-12-22T10:38:49Z", "type": "commit"}, {"oid": "442b9f052c79db5411b126fa15bb9e4fd7685d02", "url": "https://github.com/epam/cloud-pipeline/commit/442b9f052c79db5411b126fa15bb9e4fd7685d02", "message": "Issue #1645: Fixed loadPipeline test", "committedDate": "2020-12-22T10:38:49Z", "type": "commit"}, {"oid": "442b9f052c79db5411b126fa15bb9e4fd7685d02", "url": "https://github.com/epam/cloud-pipeline/commit/442b9f052c79db5411b126fa15bb9e4fd7685d02", "message": "Issue #1645: Fixed loadPipeline test", "committedDate": "2020-12-22T10:38:49Z", "type": "forcePushed"}]}