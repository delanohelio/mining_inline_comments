{"pr_number": 1114, "pr_title": "Provide node disks API", "pr_createdAt": "2020-05-15T09:04:11Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1114", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0NDI3MQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1114#discussion_r428144271", "bodyText": "Please add Transactional annotation", "author": "mzueva", "createdAt": "2020-05-20T16:24:32Z", "path": "api/src/main/java/com/epam/pipeline/dao/cluster/NodeDiskDao.java", "diffHunk": "@@ -0,0 +1,76 @@\n+package com.epam.pipeline.dao.cluster;\n+\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.cluster.DiskRegistrationRequest;\n+import com.epam.pipeline.entity.utils.DateUtils;\n+import lombok.RequiredArgsConstructor;\n+import org.springframework.jdbc.core.RowMapper;\n+import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;\n+import org.springframework.jdbc.core.namedparam.NamedParameterJdbcDaoSupport;\n+\n+import java.sql.Timestamp;\n+import java.time.LocalDateTime;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+@RequiredArgsConstructor\n+public class NodeDiskDao extends NamedParameterJdbcDaoSupport {\n+    \n+    private final String insertNodeDiskQuery;\n+    private final String loadNodeDisksByNodeIdQuery;\n+    private final String deleteNodeDisksByNodeIdQuery;\n+\n+    public List<NodeDisk> insert(final String nodeId, final List<DiskRegistrationRequest> requests) {", "originalCommit": "436ad7b389701e28a76bab908fbfadfd97ec1a43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU5ODc2Nw==", "url": "https://github.com/epam/cloud-pipeline/pull/1114#discussion_r428598767", "bodyText": "Added.", "author": "tcibinan", "createdAt": "2020-05-21T11:34:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0NDI3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0ODA3NQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1114#discussion_r428148075", "bodyText": "You can just add @Transactional annotation to the class and all DB changes will be rolled-back.", "author": "mzueva", "createdAt": "2020-05-20T16:30:36Z", "path": "api/src/test/java/com/epam/pipeline/dao/cluster/NodeDiskDaoTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+package com.epam.pipeline.dao.cluster;\n+\n+import com.epam.pipeline.AbstractSpringTest;\n+import com.epam.pipeline.entity.cluster.DiskRegistrationRequest;\n+import com.epam.pipeline.entity.cluster.NodeDisk;\n+import com.epam.pipeline.entity.utils.DateUtils;\n+import org.junit.After;\n+import org.junit.Test;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.dao.DataIntegrityViolationException;\n+\n+import java.time.LocalDateTime;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+import static com.epam.pipeline.util.CustomAssertions.assertThrows;\n+import static org.hamcrest.CoreMatchers.is;\n+import static org.junit.Assert.assertThat;\n+import static org.junit.Assert.assertTrue;\n+\n+public class NodeDiskDaoTest extends AbstractSpringTest {\n+    \n+    private static final String NODE_ID = \"NODE_ID\";\n+    private static final String ANOTHER_NODE_ID = \"ANOTHER_NODE_ID\";\n+    private static final String NULL_NODE_ID = null;\n+    private static final Long SIZE = 1L;\n+    private static final Long NULL_SIZE = null;\n+\n+    @Autowired\n+    private NodeDiskDao dao;\n+\n+    @After\n+    public void deleteDisksByNodeId() {\n+        dao.deleteByNodeId(NODE_ID);", "originalCommit": "436ad7b389701e28a76bab908fbfadfd97ec1a43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU5OTM3OQ==", "url": "https://github.com/epam/cloud-pipeline/pull/1114#discussion_r428599379", "bodyText": "That's good. Thanks. Added.", "author": "tcibinan", "createdAt": "2020-05-21T11:36:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODE0ODA3NQ=="}], "type": "inlineReview"}, {"oid": "d2e8c99263d2e93eb0b06a2f51c595579b2dbce4", "url": "https://github.com/epam/cloud-pipeline/commit/d2e8c99263d2e93eb0b06a2f51c595579b2dbce4", "message": "Add node disks registration API", "committedDate": "2020-05-21T08:27:24Z", "type": "commit"}, {"oid": "50bb25c657e44b8dbefcef6d573214f8e13c165d", "url": "https://github.com/epam/cloud-pipeline/commit/50bb25c657e44b8dbefcef6d573214f8e13c165d", "message": "Register attached disks", "committedDate": "2020-05-21T08:27:25Z", "type": "commit"}, {"oid": "e089e3557370337a127d4acad3f85042e61116c0", "url": "https://github.com/epam/cloud-pipeline/commit/e089e3557370337a127d4acad3f85042e61116c0", "message": "Require node write permission for disks registration", "committedDate": "2020-05-21T08:27:25Z", "type": "commit"}, {"oid": "64273903f6b889feaace57e9ad376b7809eaba47", "url": "https://github.com/epam/cloud-pipeline/commit/64273903f6b889feaace57e9ad376b7809eaba47", "message": "Add nodes registration to all nodeup scripts", "committedDate": "2020-05-21T08:27:26Z", "type": "commit"}, {"oid": "64e9f14d32f4d94aa9a0632f74d216b13db0e75a", "url": "https://github.com/epam/cloud-pipeline/commit/64e9f14d32f4d94aa9a0632f74d216b13db0e75a", "message": "Resolve checkstyle and pmd issues", "committedDate": "2020-05-21T08:27:26Z", "type": "commit"}, {"oid": "11919114efe57ee2e2293bff9e51a91872529afe", "url": "https://github.com/epam/cloud-pipeline/commit/11919114efe57ee2e2293bff9e51a91872529afe", "message": "Revert all changes in nodeup scripts", "committedDate": "2020-05-21T08:27:27Z", "type": "commit"}, {"oid": "f2d7aaaf86867eccdd656bcf4b9b8427a80e1d08", "url": "https://github.com/epam/cloud-pipeline/commit/f2d7aaaf86867eccdd656bcf4b9b8427a80e1d08", "message": "Store pipeline run compute and disks prices explicitly", "committedDate": "2020-05-21T08:27:27Z", "type": "commit"}, {"oid": "ac717ebabef607756f328c819fe4515c97818a74", "url": "https://github.com/epam/cloud-pipeline/commit/ac717ebabef607756f328c819fe4515c97818a74", "message": "Support API level disks registration", "committedDate": "2020-05-21T08:30:06Z", "type": "commit"}, {"oid": "0e20161b3403720cad6fdb699edcb551b65dbf63", "url": "https://github.com/epam/cloud-pipeline/commit/0e20161b3403720cad6fdb699edcb551b65dbf63", "message": "Repair API level disks registration", "committedDate": "2020-05-21T08:30:07Z", "type": "commit"}, {"oid": "ac4d10fcfc9cfa39894e06a7b38e1f091dc2957c", "url": "https://github.com/epam/cloud-pipeline/commit/ac4d10fcfc9cfa39894e06a7b38e1f091dc2957c", "message": "Fix instance filtering in gcp vm service", "committedDate": "2020-05-21T08:30:07Z", "type": "commit"}, {"oid": "541c9c12eb9b65922f55836ac15e69ca393394d5", "url": "https://github.com/epam/cloud-pipeline/commit/541c9c12eb9b65922f55836ac15e69ca393394d5", "message": "Split instance disk and node disk abstractions", "committedDate": "2020-05-21T08:30:08Z", "type": "commit"}, {"oid": "d2f44e51d527c4aa73f2e0742bc04b29b34e4414", "url": "https://github.com/epam/cloud-pipeline/commit/d2f44e51d527c4aa73f2e0742bc04b29b34e4414", "message": "Add newest pipeline run fields to corresponding sql queries", "committedDate": "2020-05-21T08:30:08Z", "type": "commit"}, {"oid": "327717452fede8ebe7d0ac7761575ba4b399a653", "url": "https://github.com/epam/cloud-pipeline/commit/327717452fede8ebe7d0ac7761575ba4b399a653", "message": "Remove unused imports", "committedDate": "2020-05-21T08:30:08Z", "type": "commit"}, {"oid": "ca17b2541e74343434faefecaa6aa5cf132b92d4", "url": "https://github.com/epam/cloud-pipeline/commit/ca17b2541e74343434faefecaa6aa5cf132b92d4", "message": "Revert unrequired changes", "committedDate": "2020-05-21T08:30:09Z", "type": "commit"}, {"oid": "4ad159918be7e1c633778af6e87157eabb88dc72", "url": "https://github.com/epam/cloud-pipeline/commit/4ad159918be7e1c633778af6e87157eabb88dc72", "message": "Update runs price per hour for reassigned nodes as well", "committedDate": "2020-05-21T08:30:09Z", "type": "commit"}, {"oid": "4ad159918be7e1c633778af6e87157eabb88dc72", "url": "https://github.com/epam/cloud-pipeline/commit/4ad159918be7e1c633778af6e87157eabb88dc72", "message": "Update runs price per hour for reassigned nodes as well", "committedDate": "2020-05-21T08:30:09Z", "type": "forcePushed"}, {"oid": "83fa0fde77084daeca905ff7eeb986aa54eddcbd", "url": "https://github.com/epam/cloud-pipeline/commit/83fa0fde77084daeca905ff7eeb986aa54eddcbd", "message": "Resolve review issues", "committedDate": "2020-05-21T08:47:16Z", "type": "commit"}, {"oid": "736255968a4093f4c0778fe734915866f750f8e6", "url": "https://github.com/epam/cloud-pipeline/commit/736255968a4093f4c0778fe734915866f750f8e6", "message": "Remove unused import", "committedDate": "2020-05-21T09:34:28Z", "type": "commit"}, {"oid": "78cd7f1a7fef0f79b6fef80e61d2e52bfdee0760", "url": "https://github.com/epam/cloud-pipeline/commit/78cd7f1a7fef0f79b6fef80e61d2e52bfdee0760", "message": "Adjust reassigned node run price only if there are registered disks", "committedDate": "2020-05-21T10:17:31Z", "type": "commit"}, {"oid": "c3a8486dcd2d8585b77f3f0db8f591ddf3623566", "url": "https://github.com/epam/cloud-pipeline/commit/c3a8486dcd2d8585b77f3f0db8f591ddf3623566", "message": "Resolve rebase issues", "committedDate": "2020-05-21T10:54:50Z", "type": "commit"}]}