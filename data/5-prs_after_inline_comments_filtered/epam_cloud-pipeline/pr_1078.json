{"pr_number": 1078, "pr_title": "Issue 1060 SMB support for web dav", "pr_createdAt": "2020-04-28T15:52:25Z", "pr_url": "https://github.com/epam/cloud-pipeline/pull/1078", "timeline": [{"oid": "f69d40d49881dbe4d6f88a971ddd2228c8dbfb07", "url": "https://github.com/epam/cloud-pipeline/commit/f69d40d49881dbe4d6f88a971ddd2228c8dbfb07", "message": "(issue #1060) update kube secret when create azure region to be able to pass creds to WebDav container", "committedDate": "2020-04-24T14:01:31Z", "type": "commit"}, {"oid": "15b263d3ee14f8dd704e00da79e41b5f5c130555", "url": "https://github.com/epam/cloud-pipeline/commit/15b263d3ee14f8dd704e00da79e41b5f5c130555", "message": "(issue #1060) fix tests", "committedDate": "2020-04-27T10:29:17Z", "type": "commit"}, {"oid": "e23d7d3f89c8c0f40f90367ea7c7074927b0e751", "url": "https://github.com/epam/cloud-pipeline/commit/e23d7d3f89c8c0f40f90367ea7c7074927b0e751", "message": "(issue #1060) patching mount sync scripts for webdav service to be able to work with SMB shares", "committedDate": "2020-04-27T16:19:26Z", "type": "commit"}, {"oid": "ed787c7af0f92a40282b9d5401d4ab976001ccf1", "url": "https://github.com/epam/cloud-pipeline/commit/ed787c7af0f92a40282b9d5401d4ab976001ccf1", "message": "(issue #1060) change messages", "committedDate": "2020-04-28T10:21:34Z", "type": "commit"}, {"oid": "867b14bed04e4cb68738ea6244e69accb7d7d3ef", "url": "https://github.com/epam/cloud-pipeline/commit/867b14bed04e4cb68738ea6244e69accb7d7d3ef", "message": "(issue #1060) small fixes", "committedDate": "2020-04-28T15:43:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MDQ1Mg==", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422040452", "bodyText": "This code duplicates logic in aspect, I'd suggest to move it to a separate service and use it in aspect and in onApplicationEvent  method", "author": "mzueva", "createdAt": "2020-05-08T09:21:51Z", "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "diffHunk": "@@ -223,6 +238,33 @@ public AbstractCloudRegion loadOrDefault(final Long id) {\n                 .orElseGet(this::loadDefaultRegion);\n     }\n \n+    public void refreshCloudRegionCredKubeSecret() {\n+        log.debug(\"Create Kube secret with cloud region creds if it does not exist.\");\n+        if (!kubernetesManager.isSecretExist(CP_REGION_CREDS_SECRET)) {\n+            log.warn(\"Secret: \" + CP_REGION_CREDS_SECRET + \" doesn't exist!\");\n+            return;\n+        }\n+        kubernetesManager.refreshSecret(CP_REGION_CREDS_SECRET,\n+                loadAll()\n+                        .stream()\n+                        .filter(region -> region.getProvider().equals(CloudProvider.AZURE))\n+                        .map(region -> (AzureRegion) region)\n+                        .collect(\n+                                Collectors.toMap(azureRegion -> azureRegion.getId().toString(),", "originalCommit": "867b14bed04e4cb68738ea6244e69accb7d7d3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MDc5MA==", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422040790", "bodyText": "Maybe extract this code to some util method or class, since such conversion is used several times", "author": "mzueva", "createdAt": "2020-05-08T09:22:39Z", "path": "api/src/main/java/com/epam/pipeline/manager/region/CloudRegionManager.java", "diffHunk": "@@ -223,6 +238,33 @@ public AbstractCloudRegion loadOrDefault(final Long id) {\n                 .orElseGet(this::loadDefaultRegion);\n     }\n \n+    public void refreshCloudRegionCredKubeSecret() {\n+        log.debug(\"Create Kube secret with cloud region creds if it does not exist.\");\n+        if (!kubernetesManager.isSecretExist(CP_REGION_CREDS_SECRET)) {\n+            log.warn(\"Secret: \" + CP_REGION_CREDS_SECRET + \" doesn't exist!\");\n+            return;\n+        }\n+        kubernetesManager.refreshSecret(CP_REGION_CREDS_SECRET,\n+                loadAll()\n+                        .stream()\n+                        .filter(region -> region.getProvider().equals(CloudProvider.AZURE))\n+                        .map(region -> (AzureRegion) region)\n+                        .collect(\n+                                Collectors.toMap(azureRegion -> azureRegion.getId().toString(),\n+                                        azureRegion ->  {\n+                                            final HashMap<String, String> creds = new HashMap<>();\n+                                            creds.put(STORAGE_ACCOUNT, azureRegion.getStorageAccount());\n+                                            creds.put(STORAGE_KEY, loadCredentials(azureRegion).getStorageAccountKey());\n+                                            try {\n+                                                return Base64.encodeBase64String(mapper.writeValueAsString(creds).getBytes());", "originalCommit": "867b14bed04e4cb68738ea6244e69accb7d7d3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjA0MTU3OA==", "url": "https://github.com/epam/cloud-pipeline/pull/1078#discussion_r422041578", "bodyText": "I think it is better to call methods doesSecretExist", "author": "mzueva", "createdAt": "2020-05-08T09:24:21Z", "path": "api/src/main/java/com/epam/pipeline/manager/cluster/KubernetesManager.java", "diffHunk": "@@ -167,6 +199,15 @@ public String createDockerRegistrySecret(DockerRegistrySecret secret) {\n         }\n     }\n \n+    public boolean isSecretExist(final String name) {", "originalCommit": "867b14bed04e4cb68738ea6244e69accb7d7d3ef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb01ce61f7bcd2e78a37f675ce7a8081c9f01d78", "url": "https://github.com/epam/cloud-pipeline/commit/bb01ce61f7bcd2e78a37f675ce7a8081c9f01d78", "message": "issue #1060 final keyword usage", "committedDate": "2020-05-08T11:26:53Z", "type": "commit"}, {"oid": "89d8e21ee2d0160035c40c5ea890cca6ef9d1749", "url": "https://github.com/epam/cloud-pipeline/commit/89d8e21ee2d0160035c40c5ea890cca6ef9d1749", "message": "move code that related to serialization creds to helper class", "committedDate": "2020-05-08T12:28:58Z", "type": "forcePushed"}, {"oid": "e31104307384483aec4b8375f8f9754914616c32", "url": "https://github.com/epam/cloud-pipeline/commit/e31104307384483aec4b8375f8f9754914616c32", "message": "move code that related to serialization creds to helper class", "committedDate": "2020-05-08T12:38:24Z", "type": "commit"}, {"oid": "e31104307384483aec4b8375f8f9754914616c32", "url": "https://github.com/epam/cloud-pipeline/commit/e31104307384483aec4b8375f8f9754914616c32", "message": "move code that related to serialization creds to helper class", "committedDate": "2020-05-08T12:38:24Z", "type": "forcePushed"}]}