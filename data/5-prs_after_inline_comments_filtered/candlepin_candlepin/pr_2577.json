{"pr_number": 2577, "pr_title": "[F] Convert DeletedConsumerResource to the OpenAPI specification (ENT-1871)", "pr_createdAt": "2020-01-22T09:08:36Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2577", "timeline": [{"oid": "dc7370b0682abfc42af735e2dbe377613b7c49e9", "url": "https://github.com/candlepin/candlepin/commit/dc7370b0682abfc42af735e2dbe377613b7c49e9", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-01-22T09:08:56Z", "type": "forcePushed"}, {"oid": "8c31c4c9f5ef349deccd76f18c63e35d39e54187", "url": "https://github.com/candlepin/candlepin/commit/8c31c4c9f5ef349deccd76f18c63e35d39e54187", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-01-22T10:30:34Z", "type": "forcePushed"}, {"oid": "a05f984a53754b8eb8f674d7abec596fcc5058d9", "url": "https://github.com/candlepin/candlepin/commit/a05f984a53754b8eb8f674d7abec596fcc5058d9", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-01-23T10:48:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE5MTQ0OA==", "url": "https://github.com/candlepin/candlepin/pull/2577#discussion_r370191448", "bodyText": "This doesn't actually work in all cases. Since the processing of the stream occurs later, the connection backing the CPQ can close and it'll trigger an exception instead of returning the result.\nFor now, just return the CandlepinQuery object as normal, and set the container type to \"Iterable\" in the yaml.", "author": "Ceiu", "createdAt": "2020-01-23T15:36:33Z", "path": "server/src/main/java/org/candlepin/resource/DeletedConsumerResource.java", "diffHunk": "@@ -51,17 +40,11 @@ public DeletedConsumerResource(DeletedConsumerCurator deletedConsumerCurator,\n         this.translator = translator;\n     }\n \n-    @ApiOperation(\n-        notes = \"Retrieves a list of Deleted Consumers By deletion date or all. \" +\n-        \"List returned is the deleted Consumers.\",\n-        value = \"listByDate\", response = DeletedConsumerDTO.class, responseContainer = \"list\")\n-    @ApiResponses({ @ApiResponse(code = 400, message = \"\"), @ApiResponse(code = 404, message = \"\") })\n-    @GET\n-    @Produces(MediaType.APPLICATION_JSON)\n-    public CandlepinQuery<DeletedConsumerDTO> listByDate(@QueryParam(\"date\") String dateStr) {\n-        return this.translator.translateQuery(dateStr != null ?\n+    @Override\n+    public Stream<DeletedConsumerDTO> listByDate(String dateStr) {\n+        CandlepinQuery<DeletedConsumerDTO> query = this.translator.translateQuery(dateStr != null ?\n             this.deletedConsumerCurator.findByDate(ResourceDateParser.parseDateString(dateStr)) :\n-            this.deletedConsumerCurator.listAll(),\n-            DeletedConsumerDTO.class);\n+            this.deletedConsumerCurator.listAll(), DeletedConsumerDTO.class);\n+        return StreamSupport.stream(query.spliterator(), false);", "originalCommit": "a05f984a53754b8eb8f674d7abec596fcc5058d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYzMzEwNw==", "url": "https://github.com/candlepin/candlepin/pull/2577#discussion_r370633107", "bodyText": "@Ceiu\nI had tested this API locally and it was working. For now, I have updated code as per your suggestion i.e. use Iterable instead of Stream.\nIf we use Stream then would it fail in a larger response? Could you please share the scenarios in which this will throw an exception in the case of Stream.", "author": "abhiskum", "createdAt": "2020-01-24T13:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE5MTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzNTc5NA==", "url": "https://github.com/candlepin/candlepin/pull/2577#discussion_r370835794", "bodyText": "The easier thing to do would be to take a look at CandlepinQueryInterceptor.\nThere are two risks to dropping the interceptor and just using a stream directly:\n\nWe give up our control over when the stream is processed vs when the connection backing it is closed. We've had issues in the past with race conditions where the connection would close and cause various exceptions when the stream is processed. I would have to dip into the git history to give you concrete examples.\nNested objects straight up fail in many cases. This was the driving feature here that caused the CandlepinQueryInterceptor to start using its own connection.\n\nI think the long-term goal is to remove CPQ entirely and start using properly designed streams, but that is not something we're willing/able to address in these PRs. For the immediate term, we can move into the spec-first world by setting the container type to be Iterable, but then returning the CandlepinQuery as-is and letting the interceptor pick it up and process it safely. We can even leverage Java's covariant return typing to let the generated API interface define it as an Iterable, but our class define it as a CandlepinQuery as it does today.", "author": "Ceiu", "createdAt": "2020-01-24T20:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE5MTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTA1ODk1Mw==", "url": "https://github.com/candlepin/candlepin/pull/2577#discussion_r371058953", "bodyText": "Thanks @Ceiu for details.", "author": "abhiskum", "createdAt": "2020-01-27T04:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE5MTQ0OA=="}], "type": "inlineReview"}, {"oid": "5db093f06a4753aa43596594a373087f3aa92d15", "url": "https://github.com/candlepin/candlepin/commit/5db093f06a4753aa43596594a373087f3aa92d15", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-01-24T06:35:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyOTkzMA==", "url": "https://github.com/candlepin/candlepin/pull/2577#discussion_r370629930", "bodyText": "Is this the trend we're following to solve the problem of \"DeletedConsumerDTO is not within its bound; should extend org.candlepin.dto.TimestampedCandlepinDTO\"? Turning the extends TimestampedEntityTranslator to implements ObjectTranslator?\n@abhiskum @Ceiu @kahowell", "author": "nikosmoum", "createdAt": "2020-01-24T13:22:22Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/DeletedConsumerTranslator.java", "diffHunk": "@@ -15,14 +15,16 @@\n package org.candlepin.dto.api.v1;\n \n import org.candlepin.dto.ModelTranslator;\n-import org.candlepin.dto.TimestampedEntityTranslator;\n+import org.candlepin.dto.ObjectTranslator;\n import org.candlepin.model.DeletedConsumer;\n \n+import java.time.ZoneOffset;\n+import java.util.Date;\n+\n /**\n  * This translator provides translation from DeletedConsumer model objects to DeletedConsumerDTOs\n  */\n-public class DeletedConsumerTranslator extends\n-    TimestampedEntityTranslator<DeletedConsumer, DeletedConsumerDTO> {\n+public class DeletedConsumerTranslator implements ObjectTranslator<DeletedConsumer, DeletedConsumerDTO> {", "originalCommit": "5db093f06a4753aa43596594a373087f3aa92d15", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgzOTA2Mw==", "url": "https://github.com/candlepin/candlepin/pull/2577#discussion_r370839063", "bodyText": "I believe so. I've done a bit of tinkering now, and I can't get the API generation to do any kind of inheritance that's worth considering, which leaves is us with composition; and that, unfortunately, means manually doing all the shared things like timestamping.", "author": "Ceiu", "createdAt": "2020-01-24T20:58:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDYyOTkzMA=="}], "type": "inlineReview"}, {"oid": "c216ff56a63b16616e2346cb7d474516b9544d57", "url": "https://github.com/candlepin/candlepin/commit/c216ff56a63b16616e2346cb7d474516b9544d57", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-01-26T11:26:12Z", "type": "forcePushed"}, {"oid": "66fae1764e8955ecdbe3a4b5ce754597eb6c753b", "url": "https://github.com/candlepin/candlepin/commit/66fae1764e8955ecdbe3a4b5ce754597eb6c753b", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-01-29T00:01:25Z", "type": "forcePushed"}, {"oid": "9c0b95f0c0daea6ca3e3cc26427bbf3fde3bf426", "url": "https://github.com/candlepin/candlepin/commit/9c0b95f0c0daea6ca3e3cc26427bbf3fde3bf426", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-02-03T05:40:12Z", "type": "forcePushed"}, {"oid": "21c5280b34cc615c9ceba2bbd87510a48e98265d", "url": "https://github.com/candlepin/candlepin/commit/21c5280b34cc615c9ceba2bbd87510a48e98265d", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-02-04T03:55:51Z", "type": "commit"}, {"oid": "21c5280b34cc615c9ceba2bbd87510a48e98265d", "url": "https://github.com/candlepin/candlepin/commit/21c5280b34cc615c9ceba2bbd87510a48e98265d", "message": "Convert DeletedConsumerResource to the OpenAPI specification\n - Created new specifications for the deleted consumer resource and deleted consumer DTO\n - Updated DeletedConsumerResource to implement the generated API specification\n - Deleted the existing API DeletedConsumerDTO\n - Deleted DeletedConsumerDTOTest test\n - Updated DeletedConsumerTranslator as per generated DTO", "committedDate": "2020-02-04T03:55:51Z", "type": "forcePushed"}]}