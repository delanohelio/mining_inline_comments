{"pr_number": 2845, "pr_title": "[M] Added support for cloud registration (ENT-3213) (ENT-3214)", "pr_createdAt": "2020-11-19T22:21:30Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2845", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MTI3OQ==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527451279", "bodyText": "Copyright header year.", "author": "wolfdale", "createdAt": "2020-11-20T06:13:17Z", "path": "common/src/main/java/org/candlepin/common/exceptions/NotImplementedException.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/**\n+ * Copyright (c) 2009 - 2012 Red Hat, Inc.", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyNzQ3Nw==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527727477", "bodyText": "Fixed", "author": "Ceiu", "createdAt": "2020-11-20T14:27:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MTI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MTUyMA==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527451520", "bodyText": "Incorrect copyright year.", "author": "wolfdale", "createdAt": "2020-11-20T06:13:35Z", "path": "server/src/main/java/org/candlepin/auth/CloudRegistrationAuth.java", "diffHunk": "@@ -0,0 +1,316 @@\n+/**\n+ * Copyright (c) 2009 - 2012 Red Hat, Inc.", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyNzUyNQ==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527727525", "bodyText": "Fixed", "author": "Ceiu", "createdAt": "2020-11-20T14:27:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MTUyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MTczOQ==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527451739", "bodyText": "Incorrect copyright year.", "author": "wolfdale", "createdAt": "2020-11-20T06:13:48Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/CloudRegistrationDTO.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyNzU4Mw==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527727583", "bodyText": "Fixed", "author": "Ceiu", "createdAt": "2020-11-20T14:27:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MTczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MjAzMg==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527452032", "bodyText": "Typo. It should be identity", "author": "wolfdale", "createdAt": "2020-11-20T06:14:07Z", "path": "server/src/main/java/org/candlepin/service/model/CloudRegistrationInfo.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.service.model;\n+\n+\n+\n+/**\n+ * The CloudRegistrationInfo represents a minimal set of cloud registration information to be used\n+ * for authenticating a given cloud provider and user account for automatic registration in\n+ * Candlepin.\n+ *\n+ * Data which is not set or does not change should be represented by null values. To explicitly\n+ * clear a value, an empty string or non-null \"empty\" value should be used instead.\n+ */\n+public interface CloudRegistrationInfo {\n+\n+    /**\n+     * Fetches the cloud provider type.\n+     *\n+     * @return\n+     *  the cloud provider type, or null if the provider type has not been set\n+     */\n+    String getType();\n+\n+    /**\n+     * Fetches the metadata for the cloud provider, such as the user's account identifiers.\n+     *\n+     * @return\n+     *  the cloud provider metadata, or null of the metadata has not been set\n+     */\n+    String getMetadata();\n+\n+    /**\n+     * Fetches the signature to use for verifying the identy of the cloud provider.", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzcyNzgwMg==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527727802", "bodyText": "Fixed", "author": "Ceiu", "createdAt": "2020-11-20T14:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzQ1MjAzMg=="}], "type": "inlineReview"}, {"oid": "4409d640782e9121f40997d5cfafb0f9211ae59d", "url": "https://github.com/candlepin/candlepin/commit/4409d640782e9121f40997d5cfafb0f9211ae59d", "message": "Added support for automated cloud registration\n\n- Added support for automated cloud registration via JWT tokens\n- Added the CloudRegistrationAdapter and CloudRegistrationInfo\n  adapter and interface for allowing service adapters to implement\n  the organization resolution logic for cloud registration details\n- Added new JWT configurations for controlling the issuer name and\n  TTL\n- Updated the mutators in Owner to return itself for fluent-style\n  method chaining\n- Updated KeycloakAuth to no longer end authentication on\n  unsupported auth types, or failed authentication in general", "committedDate": "2020-11-20T14:28:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3Njk3OA==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527676978", "bodyText": "wrong comment", "author": "nikosmoum", "createdAt": "2020-11-20T13:03:50Z", "path": "server/src/main/java/org/candlepin/service/CloudRegistrationAdapter.java", "diffHunk": "@@ -0,0 +1,46 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.service;\n+\n+import org.candlepin.service.exception.CloudRegistrationAuthorizationException;\n+import org.candlepin.service.exception.MalformedCloudRegistrationException;\n+import org.candlepin.service.model.CloudRegistrationInfo;\n+\n+\n+\n+/**\n+ * Interface to the Certificate Service.", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5NDAwOA==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527794008", "bodyText": "Fixed", "author": "Ceiu", "createdAt": "2020-11-20T16:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3Njk3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3ODAyMg==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527678022", "bodyText": "redundant word", "author": "nikosmoum", "createdAt": "2020-11-20T13:05:51Z", "path": "server/src/main/java/org/candlepin/resource/CloudRegistrationResource.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.resource;\n+\n+import org.candlepin.auth.CloudRegistrationAuth;\n+import org.candlepin.auth.Principal;\n+import org.candlepin.common.auth.SecurityHole;\n+import org.candlepin.common.exceptions.BadRequestException;\n+import org.candlepin.common.exceptions.NotAuthorizedException;\n+import org.candlepin.common.exceptions.NotImplementedException;\n+import org.candlepin.dto.api.v1.CloudRegistrationDTO;\n+import org.candlepin.service.exception.CloudRegistrationAuthorizationException;\n+import org.candlepin.service.exception.MalformedCloudRegistrationException;\n+\n+\n+import com.google.inject.Inject;\n+\n+import org.xnap.commons.i18n.I18n;\n+\n+import java.util.Objects;\n+\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+\n+\n+\n+/**\n+ * Endpoints for cloud-features features and authentication", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5NDU5Mw==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527794593", "bodyText": "Fixed", "author": "Ceiu", "createdAt": "2020-11-20T16:08:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3ODAyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3OTcxMQ==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527679711", "bodyText": "This is always going to be null, since we're reaching this code from an endpoint with @SecurityHole as mentioned in my other comment", "author": "nikosmoum", "createdAt": "2020-11-20T13:09:24Z", "path": "server/src/main/java/org/candlepin/auth/CloudRegistrationAuth.java", "diffHunk": "@@ -0,0 +1,316 @@\n+/**\n+ * Copyright (c) 2009 - 2012 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package org.candlepin.auth;\n+\n+import org.candlepin.auth.permissions.OwnerPermission;\n+import org.candlepin.auth.permissions.Permission;\n+import org.candlepin.common.config.Configuration;\n+import org.candlepin.common.config.ConversionException;\n+import org.candlepin.common.resteasy.auth.AuthUtil;\n+import org.candlepin.config.ConfigProperties;\n+import org.candlepin.model.Owner;\n+import org.candlepin.model.OwnerCurator;\n+import org.candlepin.pki.CertificateReader;\n+import org.candlepin.service.CloudRegistrationAdapter;\n+import org.candlepin.service.exception.CloudRegistrationAuthorizationException;\n+import org.candlepin.service.exception.MalformedCloudRegistrationException;\n+import org.candlepin.service.model.CloudRegistrationInfo;\n+import org.candlepin.util.Util;\n+\n+import org.jboss.resteasy.spi.HttpRequest;\n+import org.keycloak.TokenVerifier;\n+import org.keycloak.common.VerificationException;\n+import org.keycloak.common.util.KeyUtils;\n+import org.keycloak.crypto.Algorithm;\n+import org.keycloak.crypto.AsymmetricSignatureSignerContext;\n+import org.keycloak.crypto.KeyType;\n+import org.keycloak.crypto.KeyUse;\n+import org.keycloak.crypto.KeyWrapper;\n+import org.keycloak.jose.jws.JWSBuilder;\n+import org.keycloak.representations.JsonWebToken;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.xnap.commons.i18n.I18n;\n+\n+import java.security.PrivateKey;\n+import java.security.PublicKey;\n+import java.security.cert.X509Certificate;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import javax.inject.Inject;\n+import javax.inject.Provider;\n+import javax.servlet.ServletRequest;\n+import javax.servlet.ServletResponse;\n+import javax.ws.rs.core.Context;\n+\n+\n+\n+/**\n+ * AuthenticationProvider that accepts an {@link AccessToken} generated from an earlier call to the\n+ * CloudRegistration authorize endpoint\n+ */\n+public class CloudRegistrationAuth implements AuthProvider {\n+    private static Logger log = LoggerFactory.getLogger(CloudRegistrationAuth.class);\n+\n+    private static final String TOKEN_ALGORITHM = Algorithm.RS512;\n+    private static final String TOKEN_SUBJECT_DEFAULT = \"cloud_auth\";\n+    private static final String AUTH_TYPE = \"Bearer\";\n+    private static final String TOKEN_TYPE = \"CP-Cloud-Registration\";\n+\n+    @Context private ServletRequest servletRequest;\n+    @Context private ServletResponse servletResponse;\n+\n+    private final Configuration config;\n+    private final Provider<I18n> i18nProvider;\n+    private final CertificateReader certificateReader;\n+    private final CloudRegistrationAdapter cloudRegistrationAdapter;\n+    private final OwnerCurator ownerCurator;\n+\n+    private final boolean enabled;\n+    private final String jwtIssuer;\n+    private final int jwtTokenTTL; // seconds\n+\n+    private final X509Certificate certificate;\n+    private final PublicKey publicKey;\n+    private final PrivateKey privateKey;\n+\n+\n+    @Inject\n+    public CloudRegistrationAuth(Configuration config, Provider<I18n> i18nProvider,\n+        CertificateReader certificateReader, CloudRegistrationAdapter cloudRegistrationAdapter,\n+        OwnerCurator ownerCurator) {\n+\n+        this.config = Objects.requireNonNull(config);\n+        this.i18nProvider = Objects.requireNonNull(i18nProvider);\n+        this.certificateReader = Objects.requireNonNull(certificateReader);\n+        this.cloudRegistrationAdapter = Objects.requireNonNull(cloudRegistrationAdapter);\n+        this.ownerCurator = Objects.requireNonNull(ownerCurator);\n+\n+        // Pre-parse config values we'll be using a bunch\n+        try {\n+            this.enabled = this.config.getBoolean(ConfigProperties.CLOUD_AUTHENTICATION);\n+\n+            this.jwtIssuer = this.config.getProperty(ConfigProperties.JWT_ISSUER);\n+            this.jwtTokenTTL = this.config.getInt(ConfigProperties.JWT_TOKEN_TTL);\n+        }\n+        catch (ConversionException e) {\n+            // Try to pretty up the exception for easy debugging\n+            throw new RuntimeException(\"Invalid value(s) found while parsing JWT configuration\", e);\n+        }\n+\n+        // Fetch our keys\n+        try {\n+            this.certificate = this.certificateReader.getCACert();\n+            this.publicKey = this.certificate.getPublicKey();\n+            this.privateKey = this.certificateReader.getCaKey();\n+        }\n+        catch (Exception e) {\n+            throw new RuntimeException(\"Unable to load public and private keys\", e);\n+        }\n+    }\n+\n+    /**\n+     * {@inheritDoc}\n+     */\n+    @Override\n+    public Principal getPrincipal(HttpRequest httpRequest) {\n+        if (!this.enabled) {\n+            // If cloud auth isn't enabled, don't even attempt to validate anything\n+            return null;\n+        }\n+\n+        String auth = AuthUtil.getHeader(httpRequest, \"Authorization\");\n+        if (auth.isEmpty()) {\n+            // Auth header is empty; no type or token provided\n+            return null;\n+        }\n+\n+        String[] authChunks = auth.split(\" \");\n+        if (!AUTH_TYPE.equalsIgnoreCase(authChunks[0]) || authChunks.length != 2) {\n+            // Not a type we handle; ignore it and hope another auth filter picks it up\n+            return null;\n+        }\n+\n+        try {\n+            TokenVerifier<JsonWebToken> verifier = TokenVerifier.create(authChunks[1], JsonWebToken.class)\n+                .publicKey(publicKey)\n+                .verify();\n+\n+            JsonWebToken token = verifier.getToken();\n+            String[] audiences = token.getAudience();\n+\n+            // Verify that the token is active and hasn't expired\n+            if (!token.isActive()) {\n+                throw new VerificationException(\"Token is not active or has expired\");\n+            }\n+\n+            // Verify the token has the JWT type we're expecting\n+            if (TOKEN_TYPE.equalsIgnoreCase(token.getType())) {\n+                // Pull the subject (username) and owner key(s) out of the token\n+                String subject = token.getSubject();\n+                String ownerKey = audiences != null && audiences.length > 0 ? audiences[0] : null;\n+\n+                if (subject == null || subject.isEmpty()) {\n+                    throw new VerificationException(\"Token contains an invalid subject: \" + subject);\n+                }\n+\n+                if (ownerKey == null || ownerKey.isEmpty()) {\n+                    throw new VerificationException(\"Token contains an invalid audience: \" + ownerKey);\n+                }\n+\n+                return this.createCloudUserPrincipal(subject, ownerKey);\n+            }\n+        }\n+        catch (VerificationException e) {\n+            log.debug(\"Cloud registration token validation failed:\", e);\n+\n+            // Impl note:\n+            // Since we're using a common/standard auth type (bearer), we can't immediately fail\n+            // out here, as it's possible the token will be verified by another provider\n+        }\n+\n+        return null;\n+    }\n+\n+    /**\n+     * Creates a dummy user principal with the minimum amount of information and access to complete\n+     * a user registration. The username of the principal will be the subject provided.\n+     *\n+     * @param subject\n+     *  the subject for which to create the principal; will be used as the username\n+     *\n+     * @param ownerKey\n+     *  the key of an organization in which the principal will have authorization to register\n+     *  clients\n+     *\n+     * @return\n+     *  a minimal UserPrincipal representing the cloud registration token\n+     */\n+    private UserPrincipal createCloudUserPrincipal(String subject, String ownerKey) {\n+        Owner owner = this.ownerCurator.getByKey(ownerKey);\n+        if (owner == null) {\n+            // If the owner does not exist, we might be creating it on client registration, so\n+            // make a fake owner to pass into our permission object\n+            owner = new Owner(ownerKey, ownerKey);\n+        }\n+\n+        List<Permission> permissions = Arrays.asList(\n+            new OwnerPermission(owner, Access.CREATE)\n+            // Add any additional permissions here as needed\n+        );\n+\n+        return new UserPrincipal(subject, permissions, false);\n+    }\n+\n+    /**\n+     * Validates the provided cloud registration information, and generates a registration token if\n+     * valid\n+     *\n+     * @param principal\n+     *  the principal for which to generate the token\n+     *\n+     * @param cloudRegistrationInfo\n+     *  The registration information to validate\n+     *\n+     * @throws UnsupportedOperationException\n+     *  if the current Candlepin configuration does not support cloud registration\n+     *\n+     * @throws CloudRegistrationAuthorizationException\n+     *  if cloud registration is not permitted for the cloud provider or account holder specified by\n+     *  the cloud registration details\n+     *\n+     * @throws MalformedCloudRegistrationException\n+     *  if the cloud registration details are null, incomplete, or malformed\n+     *\n+     * @return\n+     *  a registration token to be used for completing registration for the client identified by the\n+     *  specified cloud registration details\n+     */\n+    public String generateRegistrationToken(Principal principal, CloudRegistrationInfo cloudRegistrationInfo)\n+        throws CloudRegistrationAuthorizationException, MalformedCloudRegistrationException {\n+\n+        if (principal == null) {\n+            throw new IllegalArgumentException(\"principal is null\");\n+        }\n+\n+        if (cloudRegistrationInfo == null) {\n+            throw new IllegalArgumentException(\"cloudRegistrationInfo is null\");\n+        }\n+\n+        String ownerKey = this.cloudRegistrationAdapter.resolveCloudRegistrationData(cloudRegistrationInfo);\n+        if (ownerKey == null) {\n+            String errmsg = this.i18nProvider.get()\n+                .tr(\"cloud provider or account details could not be resolved to an organization\");\n+\n+            throw new CloudRegistrationAuthorizationException(errmsg);\n+        }\n+\n+        return this.buildRegistrationToken(principal, ownerKey);\n+    }\n+\n+    /**\n+     * Creates a new cloud registration token for the specific owner key. The owner/organization\n+     * will be set as the subject of the token, and need not explicitly exist locally in Candlepin.\n+     *\n+     * @param principal\n+     *  the principal for which the token will be generated\n+     *\n+     * @param ownerKey\n+     *  The key of the owner/organization for which the token will be generated\n+     *\n+     * @return\n+     *  an encrypted JWT token string\n+     */\n+    private String buildRegistrationToken(Principal principal, String ownerKey) {\n+        String keyId = KeyUtils.createKeyId(this.publicKey);\n+\n+        // Try to use the username present in the principal; otherwise use the default\n+        String username = principal.getUsername();\n+        if (username == null) {", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzc5NTcyNw==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527795727", "bodyText": "Not always; it depends on the headers provided in the request. More on this below.", "author": "Ceiu", "createdAt": "2020-11-20T16:09:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY3OTcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjAzMQ==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527682031", "bodyText": "I think it is reasonable to assume that no client is going to hit this endpoint by providing a username/password, or any other kind of existing authentication (keycloak, jtw, oauth, etc.), because if they are here, they're looking to get authenticated in the first place. Which would mean this principal is always going to be a NoAuthPrincipal (because we have @SecurityHole set) which has no authentication at all. Looking further at what the code is doing with it, it only uses the getUsername() method, which will always return null in the case of a NoAuthPrincipal, so I don't think we really need this variable at all.", "author": "nikosmoum", "createdAt": "2020-11-20T13:14:01Z", "path": "server/src/main/java/org/candlepin/resource/CloudRegistrationResource.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.resource;\n+\n+import org.candlepin.auth.CloudRegistrationAuth;\n+import org.candlepin.auth.Principal;\n+import org.candlepin.common.auth.SecurityHole;\n+import org.candlepin.common.exceptions.BadRequestException;\n+import org.candlepin.common.exceptions.NotAuthorizedException;\n+import org.candlepin.common.exceptions.NotImplementedException;\n+import org.candlepin.dto.api.v1.CloudRegistrationDTO;\n+import org.candlepin.service.exception.CloudRegistrationAuthorizationException;\n+import org.candlepin.service.exception.MalformedCloudRegistrationException;\n+\n+\n+import com.google.inject.Inject;\n+\n+import org.xnap.commons.i18n.I18n;\n+\n+import java.util.Objects;\n+\n+import javax.ws.rs.Consumes;\n+import javax.ws.rs.POST;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.core.Context;\n+import javax.ws.rs.core.MediaType;\n+\n+\n+\n+/**\n+ * Endpoints for cloud-features features and authentication\n+ */\n+@Path(\"/cloud\")\n+public class CloudRegistrationResource {\n+    private final CloudRegistrationAuth cloudRegistrationAuth;\n+\n+    private final I18n i18n;\n+\n+    @Inject\n+    public CloudRegistrationResource(I18n i18n, CloudRegistrationAuth cloudRegistrationAuth) {\n+        this.i18n = Objects.requireNonNull(i18n);\n+        this.cloudRegistrationAuth = Objects.requireNonNull(cloudRegistrationAuth);\n+    }\n+\n+    @POST\n+    @Path(\"authorize\")\n+    @Produces(MediaType.TEXT_PLAIN)\n+    @Consumes(MediaType.APPLICATION_JSON)\n+    @SecurityHole(noAuth = true)\n+    public String authorize(CloudRegistrationDTO cloudRegDTO,\n+        @Context Principal principal) {", "originalCommit": "85a55dabf96f5fbe1eec0f150592f4fce4bd07e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzgxMDgzNw==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r527810837", "bodyText": "The intent here is to allow a principal, if present, to be (partially) carried forward. In general, at least today, I agree that this will virtually always going to resolve to the default.\nThis is one of those things where I feel we should be doing something to track who is doing what. Especially since in the current design, the token usage is not limited to one use, since this is all stateless. We could use the correlation ID and make sure that matches during the auth step.\nGiven that we require a rather destructive permission, we should probably do something.", "author": "Ceiu", "createdAt": "2020-11-20T16:32:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjAzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk3NjE4Ng==", "url": "https://github.com/candlepin/candlepin/pull/2845#discussion_r530976186", "bodyText": "I suppose we can keep the principal here for now, although it's not directly linked to using the correlation ID (I would imagine that would be set on the token itself, not having anything to do with the principal)", "author": "nikosmoum", "createdAt": "2020-11-26T11:52:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzY4MjAzMQ=="}], "type": "inlineReview"}, {"oid": "e5510130677e672d8acc2700f585bf0bb04664ea", "url": "https://github.com/candlepin/candlepin/commit/e5510130677e672d8acc2700f585bf0bb04664ea", "message": "Added support for automated cloud registration\n\n- Added support for automated cloud registration via JWT tokens\n- Added the CloudRegistrationAdapter and CloudRegistrationInfo\n  adapter and interface for allowing service adapters to implement\n  the organization resolution logic for cloud registration details\n- Added new JWT configurations for controlling the issuer name and\n  TTL\n- Updated the mutators in Owner to return itself for fluent-style\n  method chaining\n- Updated KeycloakAuth to no longer end authentication on\n  unsupported auth types, or failed authentication in general", "committedDate": "2020-11-20T16:33:43Z", "type": "forcePushed"}, {"oid": "e03bfe24c4fa0576fb5f7740a907e19f45e22728", "url": "https://github.com/candlepin/candlepin/commit/e03bfe24c4fa0576fb5f7740a907e19f45e22728", "message": "Added support for automated cloud registration\n\n- Added support for automated cloud registration via JWT tokens\n- Added the CloudRegistrationAdapter and CloudRegistrationInfo\n  adapter and interface for allowing service adapters to implement\n  the organization resolution logic for cloud registration details\n- Added new JWT configurations for controlling the issuer name and\n  TTL\n- Updated the mutators in Owner to return itself for fluent-style\n  method chaining\n- Updated KeycloakAuth to no longer end authentication on\n  unsupported auth types, or failed authentication in general", "committedDate": "2020-11-30T18:58:15Z", "type": "commit"}, {"oid": "e03bfe24c4fa0576fb5f7740a907e19f45e22728", "url": "https://github.com/candlepin/candlepin/commit/e03bfe24c4fa0576fb5f7740a907e19f45e22728", "message": "Added support for automated cloud registration\n\n- Added support for automated cloud registration via JWT tokens\n- Added the CloudRegistrationAdapter and CloudRegistrationInfo\n  adapter and interface for allowing service adapters to implement\n  the organization resolution logic for cloud registration details\n- Added new JWT configurations for controlling the issuer name and\n  TTL\n- Updated the mutators in Owner to return itself for fluent-style\n  method chaining\n- Updated KeycloakAuth to no longer end authentication on\n  unsupported auth types, or failed authentication in general", "committedDate": "2020-11-30T18:58:15Z", "type": "forcePushed"}]}