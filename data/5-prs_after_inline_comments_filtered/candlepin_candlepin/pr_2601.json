{"pr_number": 2601, "pr_title": "ENT-1860 - Port GuestIdDTO to openapi spec", "pr_createdAt": "2020-02-05T10:05:38Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2601", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc1NDE5Mg==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r375754192", "bodyText": "This change is altering our REST API. In this case, this is the legacy (non-async) hypervisor check-in, which is what legacy virt-who clients are probably using. I'm not certain that this will break them, but I'd be careful about it. From what I understand, the old String argument constructor was used for this legacy use case, where a guestId is sent as string, but there might be another use case where a full-fledged GuestIdDTO is sent. @wottop would be the best person to ask about it.\nIf this is something we shouldn't change, then we'd have to find a way to make this work otherwise, like this: https://stackoverflow.com/questions/45768194/how-to-generate-constructors-in-swagger-codegen", "author": "nikosmoum", "createdAt": "2020-02-06T10:28:50Z", "path": "server/src/main/java/org/candlepin/resource/HypervisorResource.java", "diffHunk": "@@ -142,7 +144,7 @@ public HypervisorResource(ConsumerResource consumerResource, ConsumerCurator con\n     @UpdateConsumerCheckIn\n     @SuppressWarnings(\"checkstyle:indentation\")\n     public HypervisorUpdateResultDTO hypervisorUpdate(\n-        Map<String, List<GuestIdDTO>> hostGuestDTOMap, @Context Principal principal,\n+        Map<String, List<String>> hostGuestMap, @Context Principal principal,", "originalCommit": "f35d03ed26b3a4e1c60a462d45059e47d4af416b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTg2NjU2OA==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r375866568", "bodyText": "In API call, hypervisorUpdate()method converts the List of guestIds to List of GuestIdDTO using string argument constructor. The rspecs in hypervisor_check_in.rb are passing a List of guestIds in string format. So I am assuming, virt-who is using the same format, and this change made successful execution of rspecs.\n@wottop Can you confirm if GuestIdDTO is directly sent?", "author": "sonalidhome", "createdAt": "2020-02-06T14:31:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc1NDE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc1Nzg0Mw==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r375757843", "bodyText": "In case we do want to change the API to have a list of Strings instead of GuestIdDTOs, then there is no need to do any conversion here. Instead we could update the code to process List of Strings, and change GuestIdResource.populateEntities to the conversion to a GuestId object.", "author": "nikosmoum", "createdAt": "2020-02-06T10:36:17Z", "path": "server/src/main/java/org/candlepin/resource/HypervisorResource.java", "diffHunk": "@@ -152,11 +154,16 @@ public HypervisorUpdateResultDTO hypervisorUpdate(\n         @QueryParam(\"create_missing\") @DefaultValue(\"true\") boolean createMissing) {\n         log.debug(\"Hypervisor check-in by principal: {}\", principal);\n \n-        if (hostGuestDTOMap == null) {\n+        Map<String, List<GuestIdDTO>> convertedHostGuestIdDTOMap;\n+\n+        if (hostGuestMap == null) {\n             log.debug(\"Host/Guest mapping provided during hypervisor checkin was null.\");\n             throw new BadRequestException(\n                 i18n.tr(\"Host to guest mapping was not provided for hypervisor check-in.\"));\n         }\n+        else {\n+            convertedHostGuestIdDTOMap = convertMapToGuestIdDTO(hostGuestMap);", "originalCommit": "f35d03ed26b3a4e1c60a462d45059e47d4af416b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI2ODgxNQ==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r376268815", "bodyText": "Updated as per suggestion.", "author": "sonalidhome", "createdAt": "2020-02-07T08:35:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTc1Nzg0Mw=="}], "type": "inlineReview"}, {"oid": "e6fd644ddfbe623dc885092179da2da7571008fb", "url": "https://github.com/candlepin/candlepin/commit/e6fd644ddfbe623dc885092179da2da7571008fb", "message": "ENT-1860 - Port GuestIdDTO to openapi spec\n- Added specifications in yaml file\n- Removed existing GuestIdDTO and GuestIdDTOTest\n- Updated the populate method of translator\n- Fixed JUnit tests. Added workaround of GuestIdDTOTest in ConsumerDTOTest to pass JUnits.\n- Updated hypervisorUpdate() method of HyperVisorResource.java to accept\n  List<string> GuestIds instead of List<GuestIdDTO>. Because of MismatchedInputException: Cannot\n  construct instance of GuestIdDTO: no String-argument constructor. This is raised due to\n  the auto-generated DTO class does not have constructors.", "committedDate": "2020-02-07T08:24:54Z", "type": "forcePushed"}, {"oid": "b4b804fa9980112c5c5be22c68bf5f8aa1f5b16e", "url": "https://github.com/candlepin/candlepin/commit/b4b804fa9980112c5c5be22c68bf5f8aa1f5b16e", "message": "ENT-1860 - Port GuestIdDTO to openapi spec\n- Added specifications in yaml file\n- Removed existing GuestIdDTO and GuestIdDTOTest\n- Updated the populate method of translator\n- Fixed JUnit tests. Added workaround of GuestIdDTOTest in ConsumerDTOTest to pass JUnits.\n- Updated hypervisorUpdate() method of HyperVisorResource.java to accept\n  List<string> GuestIds instead of List<GuestIdDTO>. Because of MismatchedInputException: Cannot\n  construct instance of GuestIdDTO: no String-argument constructor. This is raised due to\n  the auto-generated DTO class does not have constructors.", "committedDate": "2020-02-07T08:32:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI4MDAxNw==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r376280017", "bodyText": "Now that all we have is the String guestId, there is no need to create redundant GuestIdDTO objects, or call populateEntity. We have eliminated the need for DTOs, so this is enough:\nentities.add(new GuestId(guestId));", "author": "nikosmoum", "createdAt": "2020-02-07T09:02:25Z", "path": "server/src/main/java/org/candlepin/resource/GuestIdResource.java", "diffHunk": "@@ -154,34 +154,35 @@ protected void populateEntity(GuestId guestId, GuestIdDTO dto) {\n     }\n \n     /**\n-     * Populates the specified entities with data from the provided DTOs.\n+     * Populates the specified entities with data from the provided guestIds.\n      *\n      * @param entities\n      *  The entities instance to populate\n      *\n-     * @param dtos\n-     *  The DTO containing the data with which to populate the entity\n+     * @param guestIds\n+     *  The list of string containing the guestIds to populate the entity\n      *\n      * @throws IllegalArgumentException\n      *  if either entity or dto are null\n      */\n-    protected void populateEntities(List<GuestId> entities, List<GuestIdDTO> dtos) {\n+    protected void populateEntities(List<GuestId> entities, List<String> guestIds) {\n         if (entities == null) {\n             throw new IllegalArgumentException(\"the guestId model entity is null\");\n         }\n \n-        if (dtos == null) {\n-            throw new IllegalArgumentException(\"the guestId dto is null\");\n+        if (guestIds == null) {\n+            throw new IllegalArgumentException(\"the list of guestId is null\");\n         }\n \n-        for (GuestIdDTO dto : dtos) {\n-            if (dto == null) {\n+        for (String guestId : guestIds) {\n+            if (guestId == null) {\n                 continue;\n             }\n \n-            GuestId guestId = new GuestId();\n-            populateEntity(guestId, dto);\n-            entities.add(guestId);\n+            GuestIdDTO guestIdDTO = new GuestIdDTO().guestId(guestId);\n+            GuestId guestIdEntity = new GuestId();\n+            populateEntity(guestIdEntity, guestIdDTO);\n+            entities.add(guestIdEntity);", "originalCommit": "b4b804fa9980112c5c5be22c68bf5f8aa1f5b16e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5OTI0NQ==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r376299245", "bodyText": "Understood. Corrected now.", "author": "sonalidhome", "createdAt": "2020-02-07T09:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI4MDAxNw=="}], "type": "inlineReview"}, {"oid": "a2648c0269a8c835affa4c7c3cae3ca40b26fd6c", "url": "https://github.com/candlepin/candlepin/commit/a2648c0269a8c835affa4c7c3cae3ca40b26fd6c", "message": "ENT-1860 - Port GuestIdDTO to openapi spec\n- Added specifications in yaml file\n- Removed existing GuestIdDTO and GuestIdDTOTest\n- Updated the populate method of translator\n- Fixed JUnit tests. Added workaround of GuestIdDTOTest in ConsumerDTOTest to pass JUnits.\n- Updated hypervisorUpdate() method of HyperVisorResource.java to accept\n  List<string> GuestIds instead of List<GuestIdDTO>. Because of MismatchedInputException: Cannot\n  construct instance of GuestIdDTO: no String-argument constructor. This is raised due to\n  the auto-generated DTO class does not have constructors.", "committedDate": "2020-02-07T09:40:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNDE4OQ==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r376304189", "bodyText": "This is still creating a GuestIdDTO object, and calling populateEntity, both of which are not needed. All these 3 lines of code can be condensed into one: entities.add(new GuestId(guestId));", "author": "nikosmoum", "createdAt": "2020-02-07T09:54:30Z", "path": "server/src/main/java/org/candlepin/resource/GuestIdResource.java", "diffHunk": "@@ -154,34 +154,34 @@ protected void populateEntity(GuestId guestId, GuestIdDTO dto) {\n     }\n \n     /**\n-     * Populates the specified entities with data from the provided DTOs.\n+     * Populates the specified entities with data from the provided guestIds.\n      *\n      * @param entities\n      *  The entities instance to populate\n      *\n-     * @param dtos\n-     *  The DTO containing the data with which to populate the entity\n+     * @param guestIds\n+     *  The list of string containing the guestIds to populate the entity\n      *\n      * @throws IllegalArgumentException\n      *  if either entity or dto are null\n      */\n-    protected void populateEntities(List<GuestId> entities, List<GuestIdDTO> dtos) {\n+    protected void populateEntities(List<GuestId> entities, List<String> guestIds) {\n         if (entities == null) {\n             throw new IllegalArgumentException(\"the guestId model entity is null\");\n         }\n \n-        if (dtos == null) {\n-            throw new IllegalArgumentException(\"the guestId dto is null\");\n+        if (guestIds == null) {\n+            throw new IllegalArgumentException(\"the list of guestId is null\");\n         }\n \n-        for (GuestIdDTO dto : dtos) {\n-            if (dto == null) {\n+        for (String guestId : guestIds) {\n+            if (guestId == null) {\n                 continue;\n             }\n \n-            GuestId guestId = new GuestId();\n-            populateEntity(guestId, dto);\n-            entities.add(guestId);\n+            GuestId guestIdEntity = new GuestId();\n+            populateEntity(guestIdEntity, new GuestIdDTO().guestId(guestId));\n+            entities.add(guestIdEntity);", "originalCommit": "a2648c0269a8c835affa4c7c3cae3ca40b26fd6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMyNjk3Mg==", "url": "https://github.com/candlepin/candlepin/pull/2601#discussion_r376326972", "bodyText": "Fair enough. I didn't realize that before. Thank you.", "author": "sonalidhome", "createdAt": "2020-02-07T10:44:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMwNDE4OQ=="}], "type": "inlineReview"}, {"oid": "3233a48002dece9c452a128f414b243aa5390fc3", "url": "https://github.com/candlepin/candlepin/commit/3233a48002dece9c452a128f414b243aa5390fc3", "message": "ENT-1860 - Port GuestIdDTO to openapi spec\n- Added specifications in yaml file\n- Removed existing GuestIdDTO and GuestIdDTOTest\n- Updated the populate method of translator\n- Fixed JUnit tests. Added workaround of GuestIdDTOTest in ConsumerDTOTest to pass JUnits.\n- Updated hypervisorUpdate() method of HyperVisorResource.java to accept\n  List<string> GuestIds instead of List<GuestIdDTO>. Because of MismatchedInputException: Cannot\n  construct instance of GuestIdDTO: no String-argument constructor. This is raised due to\n  the auto-generated DTO class does not have constructors.", "committedDate": "2020-02-07T10:40:56Z", "type": "forcePushed"}, {"oid": "e4fa36de70f6cb5255cc6cbff6cbc621c7b5c844", "url": "https://github.com/candlepin/candlepin/commit/e4fa36de70f6cb5255cc6cbff6cbc621c7b5c844", "message": "ENT-1860 - Port GuestIdDTO to openapi spec\n- Added specifications in yaml file\n- Removed existing GuestIdDTO and GuestIdDTOTest\n- Updated the populate method of translator\n- Fixed JUnit tests. Added workaround of GuestIdDTOTest in ConsumerDTOTest to pass JUnits.\n- Updated hypervisorUpdate() method of HyperVisorResource.java to accept\n  List<string> GuestIds instead of List<GuestIdDTO>. Because of MismatchedInputException: Cannot\n  construct instance of GuestIdDTO: no String-argument constructor. This is raised due to\n  the auto-generated DTO class does not have constructors.", "committedDate": "2020-02-11T15:14:32Z", "type": "commit"}, {"oid": "e4fa36de70f6cb5255cc6cbff6cbc621c7b5c844", "url": "https://github.com/candlepin/candlepin/commit/e4fa36de70f6cb5255cc6cbff6cbc621c7b5c844", "message": "ENT-1860 - Port GuestIdDTO to openapi spec\n- Added specifications in yaml file\n- Removed existing GuestIdDTO and GuestIdDTOTest\n- Updated the populate method of translator\n- Fixed JUnit tests. Added workaround of GuestIdDTOTest in ConsumerDTOTest to pass JUnits.\n- Updated hypervisorUpdate() method of HyperVisorResource.java to accept\n  List<string> GuestIds instead of List<GuestIdDTO>. Because of MismatchedInputException: Cannot\n  construct instance of GuestIdDTO: no String-argument constructor. This is raised due to\n  the auto-generated DTO class does not have constructors.", "committedDate": "2020-02-11T15:14:32Z", "type": "forcePushed"}]}