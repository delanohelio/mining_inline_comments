{"pr_number": 2645, "pr_title": "[M] [RFE] Added support for changing content access parameters via API (ENT-2219)", "pr_createdAt": "2020-03-19T13:00:01Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2645", "timeline": [{"oid": "ccab264daf50a3103e5e08f1026a265755994274", "url": "https://github.com/candlepin/candlepin/commit/ccab264daf50a3103e5e08f1026a265755994274", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details", "committedDate": "2020-03-24T20:53:08Z", "type": "forcePushed"}, {"oid": "b89568105b71f9d4699b94fc8b8ce62995e4212a", "url": "https://github.com/candlepin/candlepin/commit/b89568105b71f9d4699b94fc8b8ce62995e4212a", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists", "committedDate": "2020-03-28T15:57:04Z", "type": "forcePushed"}, {"oid": "5ccad2bc40f6b32f9eafca27074eaa2ba6d142d1", "url": "https://github.com/candlepin/candlepin/commit/5ccad2bc40f6b32f9eafca27074eaa2ba6d142d1", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists\n- Updated JUnit to 5.4.2; updated several affected tests accordingly\n- Refactored the ImporterTest", "committedDate": "2020-03-28T23:02:02Z", "type": "forcePushed"}, {"oid": "4d4f381137179cc8a8849c410362e16ed657b5cd", "url": "https://github.com/candlepin/candlepin/commit/4d4f381137179cc8a8849c410362e16ed657b5cd", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists\n- Updated JUnit to 5.4.2; updated several affected tests accordingly\n- Refactored the ImporterTest", "committedDate": "2020-04-01T19:25:19Z", "type": "forcePushed"}, {"oid": "a43437408e8c9c9bba940ca178e3f63d03a4d449", "url": "https://github.com/candlepin/candlepin/commit/a43437408e8c9c9bba940ca178e3f63d03a4d449", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists\n- Updated JUnit to 5.4.2; updated several affected tests accordingly\n- Refactored the ImporterTest", "committedDate": "2020-04-01T20:02:53Z", "type": "forcePushed"}, {"oid": "49b856684952fd79ca79ea6d011d5f602c62d241", "url": "https://github.com/candlepin/candlepin/commit/49b856684952fd79ca79ea6d011d5f602c62d241", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists\n- Updated JUnit to 5.4.2; updated several affected tests accordingly\n- Refactored the ImporterTest", "committedDate": "2020-04-01T21:32:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg0NzYwNA==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r404847604", "bodyText": "I don't know if this is something that could happen, but this will set listUpdated to true if the order of csv in the list is switched (e.g. currentList is org_environment,entitlement and updatedList is entitlement,org_environment. The final effect might be the same, but we'll be running some of the following code unnecesserilly. Maybe it should be comparing after both strings are split into arrays of Strings?\nIf we decide we care about the ordering of these, then we should also change this in the other places we compare the list Strings (create/update owner calls).", "author": "nikosmoum", "createdAt": "2020-04-07T14:21:07Z", "path": "server/src/main/java/org/candlepin/controller/ContentAccessManager.java", "diffHunk": "@@ -388,4 +489,172 @@ private String createDN(Consumer consumer, Owner owner) {\n         return v3extensionUtil.createEntitlementDataPayload(productModels,\n             emptyConsumer, emptyPool, null);\n     }\n+\n+    public boolean hasCertChangedSince(Consumer consumer, Date date) {\n+        if (date == null) {\n+            return true;\n+        }\n+\n+        Environment env = this.environmentCurator.getConsumerEnvironment(consumer);\n+        OwnerEnvContentAccess oeca = ownerEnvContentAccessCurator\n+            .getContentAccess(consumer.getOwnerId(), env == null ? null : env.getId());\n+\n+        return oeca == null ||\n+            consumer.getContentAccessCert() == null ||\n+            oeca.getUpdated().getTime() > date.getTime();\n+    }\n+\n+    @Transactional\n+    public void removeContentAccessCert(Consumer consumer) {\n+        if (consumer.getContentAccessCert() == null) {\n+            return;\n+        }\n+        contentAccessCertificateCurator.delete(consumer.getContentAccessCert());\n+        consumer.setContentAccessCert(null);\n+    }\n+\n+\n+    /**\n+     * Updates the content access mode state for the given owner using the updated content access mode\n+     * list and content access mode provided.\n+     *\n+     * @param owner\n+     *  The owner to refresh\n+     *\n+     * @param updatedList\n+     *  the updated content access mode list to apply, or an empty string to restore the default value\n+     *\n+     * @param updatedMode\n+     *  the updated content access mode to apply, or an empty string to restore the default value\n+     *\n+     * @throws IllegalStateException\n+     *  if the requested content access mode is not in the provided content access mode list\n+     *\n+     * @return\n+     *  the refreshed owner; may be a different instance than the input owner\n+     */\n+    @Transactional\n+    public Owner updateOwnerContentAccess(Owner owner, String updatedList, String updatedMode) {\n+        if (owner == null) {\n+            throw new IllegalArgumentException(\"owner is null\");\n+        }\n+\n+        boolean listUpdated = false;\n+        boolean modeUpdated = false;\n+\n+        this.ownerCurator.lock(owner);\n+\n+        final String defaultMode = ContentAccessMode.getDefault().toDatabaseValue();\n+\n+        // Grab the current list and mode\n+        String currentList = this.resolveContentAccessValue(owner.getContentAccessModeList(), true);\n+        String currentMode = this.resolveContentAccessValue(owner.getContentAccessMode(), true);\n+\n+        // Resolve the updated list and mode\n+        updatedList = this.resolveContentAccessValue(updatedList, false);\n+        updatedMode = this.resolveContentAccessValue(updatedMode, false);\n+\n+        if (updatedList != null) {\n+            String[] modes = updatedList.split(\",\");\n+\n+            // We're not interested in storing access modes that we don't support\n+            for (String mode : modes) {\n+                // This will throw an IAE if the mode isn't one we support.\n+                ContentAccessMode.resolveModeName(mode);\n+            }\n+\n+            listUpdated = !updatedList.equals(currentList);", "originalCommit": "49b856684952fd79ca79ea6d011d5f602c62d241", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4ODQ3Ng==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r405088476", "bodyText": "You're right in that this triggers in an order swap, but I made the choice to not care about that since the overhead associated with a list change is minimal (and is something we just assumed was the case, prior). The only extra work this incurs is the persisting of the owner if the mode is unchanged, and a database call to cull invalid modes.\nI'm not entirely opposed to adding the logic to do an unordered comparison, but I feel it's not going to be a very common case, and we'll lose runtime from the extra computation in the general case vs what I assume to be the uncommon cases of an order change.", "author": "Ceiu", "createdAt": "2020-04-07T20:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg0NzYwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NjkxMw==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r404856913", "bodyText": "incomplete comment", "author": "nikosmoum", "createdAt": "2020-04-07T14:33:02Z", "path": "server/src/main/java/org/candlepin/model/ConsumerCurator.java", "diffHunk": "@@ -1287,4 +1290,32 @@ public int getConsumerEntitlementCount(Owner owner, ConsumerType type) {\n             .list();\n     }\n \n+    /**\n+     * Clears (nulls) the content access mode for any consumer belonging to the given owner, that is\n+     * using a mode which is", "originalCommit": "49b856684952fd79ca79ea6d011d5f602c62d241", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4NDE0Nw==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r405084147", "bodyText": "Yikes. Looks like my brain just kinda gave up here. I've fixed this all up and added some additional input validation.", "author": "Ceiu", "createdAt": "2020-04-07T20:14:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NjkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NzQwNw==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r404857407", "bodyText": "This is the @param existingModes, not the @return", "author": "nikosmoum", "createdAt": "2020-04-07T14:33:44Z", "path": "server/src/main/java/org/candlepin/model/ConsumerCurator.java", "diffHunk": "@@ -1287,4 +1290,32 @@ public int getConsumerEntitlementCount(Owner owner, ConsumerType type) {\n             .list();\n     }\n \n+    /**\n+     * Clears (nulls) the content access mode for any consumer belonging to the given owner, that is\n+     * using a mode which is\n+     *\n+     * @param owner\n+     *  the owner for which to fetch active consumer content access modes\n+     *\n+     * @throws IllegalArgumentException\n+     *  if owner is null\n+     *\n+     * @return\n+     *  a list of all active consumer content access modes for consumers of the given owner", "originalCommit": "49b856684952fd79ca79ea6d011d5f602c62d241", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4NDE5MQ==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r405084191", "bodyText": "Fixed", "author": "Ceiu", "createdAt": "2020-04-07T20:14:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg1NzQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA0NTg2MA==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r405045860", "bodyText": "I see this was not a restriction on the create owner call before (both the mode and the list could be set). Was that an omission? Also, I assume this has something to do with the implementation note below about pre-existing expected behaviours; what are those?\nAlso, if we're adding this restriction here now, we should add a test case about it (best place is probably OwnerResourceTest.java)", "author": "nikosmoum", "createdAt": "2020-04-07T19:05:34Z", "path": "server/src/main/java/org/candlepin/resource/OwnerResource.java", "diffHunk": "@@ -879,35 +886,54 @@ public OwnerDTO createOwner(@ApiParam(name = \"owner\", required = true) OwnerDTO\n             throw new BadRequestException(i18n.tr(\"Owners must be created with a valid key\"));\n         }\n \n-        // Validate and set content access mode list & content access mode\n-        if (StringUtils.isBlank(dto.getContentAccessModeList())) {\n-            dto.setContentAccessModeList(ContentAccessCertServiceAdapter.DEFAULT_CONTENT_ACCESS_MODE);\n-        }\n+        Owner owner = new Owner();\n+        owner.setKey(dto.getKey());\n \n-        if (StringUtils.isBlank(dto.getContentAccessMode())) {\n-            dto.setContentAccessMode(ContentAccessCertServiceAdapter.DEFAULT_CONTENT_ACCESS_MODE);\n+        // Check that the default service level is *not* set at this point\n+        if (!StringUtils.isBlank(dto.getDefaultServiceLevel())) {\n+            throw new BadRequestException(\n+                i18n.tr(\"The default service level cannot be specified during owner creation\"));\n         }\n \n-        if (!containsContentAccessMode(dto.getContentAccessModeList(), dto.getContentAccessMode())) {\n-            throw new BadRequestException(\n-                i18n.tr(\"The content access mode \\\"{1}\\\" is not allowed for this owner.\",\n-                    dto.getContentAccessMode()));\n+        // Validate and set content access mode list & content access mode\n+        boolean configureContentAccess = false;\n+\n+        final String defaultContentAccess = ContentAccessMode.getDefault().toDatabaseValue();\n+        String contentAccessModeList = dto.getContentAccessModeList();\n+        String contentAccessMode = dto.getContentAccessMode();\n+\n+        if (!StringUtils.isBlank(contentAccessMode) && !contentAccessMode.equals(defaultContentAccess)) {\n+            if (config.getBoolean(ConfigProperties.STANDALONE)) {\n+                throw new BadRequestException(\n+                    i18n.tr(\"The owner content access mode and content access mode list cannot be set \" +\n+                        \"directly in standalone mode.\"));", "originalCommit": "49b856684952fd79ca79ea6d011d5f602c62d241", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA4NjI5Mw==", "url": "https://github.com/candlepin/candlepin/pull/2645#discussion_r405086293", "bodyText": "It looked to be an omission, and from the bit of discussion I had with people who remembered the original design, it seemed like an oversight. Prior, we could set the content access mode and list during creation, but it would not result in an actual change in state or cert generation at all. So you could get into a situation where an owner was already in org_environment but it wouldn't be functional, and the only way to fix it would be to do two updates to flip to entitlement and then back to org_environment so the updateOwnerContentAccess call (previously refreshContentAccess) would get hit.\nThis got added to prevent that from happening, but I quickly found that we have a lot of behavior that's expecting some parts of this to be allowed -- i.e. explicitly setting the default values during creation, and specifying the existing values during update (such as when a client fetches an org, makes changes to the received json and then sends it back up).\nThere were a few tests which broke by adding this restriction, and those were updated or skipped in standalone mode where it either didn't make sense or didn't seem to be reconcilable.", "author": "Ceiu", "createdAt": "2020-04-07T20:18:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA0NTg2MA=="}], "type": "inlineReview"}, {"oid": "4591715317ca7b517388d6078e813b19ba64b322", "url": "https://github.com/candlepin/candlepin/commit/4591715317ca7b517388d6078e813b19ba64b322", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists\n- Updated JUnit to 5.4.2; updated several affected tests accordingly\n- Refactored the ImporterTest", "committedDate": "2020-04-07T20:39:12Z", "type": "forcePushed"}, {"oid": "9dd3a78aa4aff6d072618d5c02f4ed81b43d6c6a", "url": "https://github.com/candlepin/candlepin/commit/9dd3a78aa4aff6d072618d5c02f4ed81b43d6c6a", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists\n- Updated JUnit to 5.4.2; updated several affected tests accordingly\n- Refactored the ImporterTest", "committedDate": "2020-04-08T13:14:18Z", "type": "commit"}, {"oid": "9dd3a78aa4aff6d072618d5c02f4ed81b43d6c6a", "url": "https://github.com/candlepin/candlepin/commit/9dd3a78aa4aff6d072618d5c02f4ed81b43d6c6a", "message": "Added support for changing content access parameters via API\n\n- OwnerResource.updateOwner now allows changing the content access\n  mode and content access mode list if Candlepin is not running in\n  standalone mode\n- Owner refresh no longer attempts to pull content access details\n- Content access mode lists no longer accept unsupported modes as\n  part of the lists\n- Updated JUnit to 5.4.2; updated several affected tests accordingly\n- Refactored the ImporterTest", "committedDate": "2020-04-08T13:14:18Z", "type": "forcePushed"}]}