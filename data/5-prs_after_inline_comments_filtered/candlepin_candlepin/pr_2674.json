{"pr_number": 2674, "pr_title": "ENT-1886: Port SubscriptionResource to spec-first", "pr_createdAt": "2020-04-07T14:00:30Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2674", "timeline": [{"oid": "5d0b4a3ee1f0e2164cbcbd650981c8d0fbde4c4c", "url": "https://github.com/candlepin/candlepin/commit/5d0b4a3ee1f0e2164cbcbd650981c8d0fbde4c4c", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-08T08:21:13Z", "type": "forcePushed"}, {"oid": "668f22f33a4dafbe1330db0b5afa4c115446e7d4", "url": "https://github.com/candlepin/candlepin/commit/668f22f33a4dafbe1330db0b5afa4c115446e7d4", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-08T09:24:53Z", "type": "forcePushed"}, {"oid": "d8039ad8bb38e87b4448f3b0e29c76a434d65c56", "url": "https://github.com/candlepin/candlepin/commit/d8039ad8bb38e87b4448f3b0e29c76a434d65c56", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-14T11:27:50Z", "type": "forcePushed"}, {"oid": "5809397bc94c6dc5a2a8d58d99be539c8716f8d9", "url": "https://github.com/candlepin/candlepin/commit/5809397bc94c6dc5a2a8d58d99be539c8716f8d9", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-15T11:06:15Z", "type": "forcePushed"}, {"oid": "21da61f71057203caa366ad7c3dd28cb0438bc21", "url": "https://github.com/candlepin/candlepin/commit/21da61f71057203caa366ad7c3dd28cb0438bc21", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-15T13:24:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4MTc3Mg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408881772", "bodyText": "Encapsulation violation. This would also lead to duplicate product content references since we're not removing the original.", "author": "Ceiu", "createdAt": "2020-04-15T14:23:02Z", "path": "server/src/main/java/org/candlepin/controller/ContentManager.java", "diffHunk": "@@ -318,18 +320,32 @@ public Content updateContent(ContentDTO update, Owner owner, boolean regenerateE\n             log.debug(\"Updating affected product: {}\", product);\n             ProductDTO pdto = this.modelTranslator.translate(product, ProductDTO.class);\n \n-            ProductContentDTO pcdto = pdto.getProductContent(cdto.getId());\n-            if (pcdto != null) {\n-                pdto.addContent(cdto, pcdto.isEnabled());\n+            pdto.getProductContent().stream()\n+                .filter(content -> content.getContent().getId().equals(cdto.getId()))\n+                .findFirst()\n+                .ifPresent(content -> {\n+                    addContent(pdto, cdto, content.getEnabled());\n \n-                // Impl note: This should also take care of our entitlement cert regeneration\n-                this.productManager.updateProduct(pdto, owner, regenerateEntitlementCerts);\n-            }\n+                    // Impl note: This should also take care of our entitlement cert regeneration\n+                    this.productManager.updateProduct(pdto, owner, regenerateEntitlementCerts);\n+                });\n         }\n \n         return updated;\n     }\n \n+    private void addContent(ProductDTO product, ContentDTO dto, boolean enabled) {\n+        if (dto == null || dto.getId() == null) {\n+            throw new IllegalArgumentException(\"dto references incomplete content\");\n+        }\n+\n+        ProductContentDTO content = new ProductContentDTO();\n+        content.setContent(dto);\n+        content.setEnabled(enabled);\n+\n+        product.getProductContent().add(content);", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MDM4MA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409480380", "bodyText": "Done. Removed the original before insert.", "author": "Januson", "createdAt": "2020-04-16T11:23:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4MTc3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4NzI2NQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408887265", "bodyText": "nack on this block\nI understand that we're likely losing some functionality due to the spec-first bits, but we can do better than throwing an iterative stream and closures at it and inheriting the DTO's structure management.\nThe product manager side is a mess, but we should do something like grabbing the list, stepping through it and finding the content in question, removing it from the list, adding the new reference, and then setting the new list wholesale.\nAlternatively, we can update the content reference in place since that's effectively what will happen above, but even that's a bit janky and subject to breaking when the managers finally get updated to no longer use the DTOs as inputs.", "author": "Ceiu", "createdAt": "2020-04-15T14:30:06Z", "path": "server/src/main/java/org/candlepin/controller/ContentManager.java", "diffHunk": "@@ -257,13 +257,15 @@ public Content updateContent(ContentDTO update, Owner owner, boolean regenerateE\n                     log.debug(\"Updating affected product: {}\", product);\n                     ProductDTO pdto = this.modelTranslator.translate(product, ProductDTO.class);\n \n-                    ProductContentDTO pcdto = pdto.getProductContent(cdto.getId());\n-                    if (pcdto != null) {\n-                        pdto.addContent(cdto, pcdto.isEnabled());\n+                    pdto.getProductContent().stream()", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MDQ4MQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409480481", "bodyText": "You are right, that stream was a bit sloppy. I refactored it a bit.", "author": "Januson", "createdAt": "2020-04-16T11:23:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4NzI2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4NzU2OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408887569", "bodyText": "Same as above here: we should rework this.", "author": "Ceiu", "createdAt": "2020-04-15T14:30:31Z", "path": "server/src/main/java/org/candlepin/controller/ContentManager.java", "diffHunk": "@@ -318,18 +320,32 @@ public Content updateContent(ContentDTO update, Owner owner, boolean regenerateE\n             log.debug(\"Updating affected product: {}\", product);\n             ProductDTO pdto = this.modelTranslator.translate(product, ProductDTO.class);\n \n-            ProductContentDTO pcdto = pdto.getProductContent(cdto.getId());\n-            if (pcdto != null) {\n-                pdto.addContent(cdto, pcdto.isEnabled());\n+            pdto.getProductContent().stream()", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MDYxMw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409480613", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:23:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4NzU2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4OTI3OA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408889278", "bodyText": "Why do we pull the collection from the DTO again when we already have it locally?", "author": "Ceiu", "createdAt": "2020-04-15T14:32:51Z", "path": "server/src/main/java/org/candlepin/controller/ProductManager.java", "diffHunk": "@@ -817,17 +823,17 @@ public static boolean isChangedBy(Product entity, ProductDTO dto) {\n             };\n \n             if (!Util.collectionsAreEqual((Collection) entity.getProductContent(),\n-                (Collection) productContent, comparator)) {\n+                (Collection) dto.getProductContent(), comparator)) {", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MDY5Ng==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409480696", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:23:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4OTI3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4OTYwNQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408889605", "bodyText": "None of the code changes below require knowledge of the specific collection the DTO returns.", "author": "Ceiu", "createdAt": "2020-04-15T14:33:15Z", "path": "server/src/main/java/org/candlepin/controller/ProductManager.java", "diffHunk": "@@ -783,12 +786,15 @@ public static boolean isChangedBy(Product entity, ProductDTO dto) {\n         // case-insensitive key/value comparison and similiarities (i.e. management_enabled: 1 is\n         // functionally identical to Management_Enabled: true, but it will be detected as a change\n         // in attributes.\n-        Map<String, String> attributes = dto.getAttributes();\n+        Map<String, String> attributes = null;\n+        if (dto.getAttributes() != null) {\n+            attributes = dto.getAttributes().getAttributes();\n+        }\n         if (attributes != null && !attributes.equals(entity.getAttributes())) {\n             return true;\n         }\n \n-        Collection<ProductContentDTO> productContent = dto.getProductContent();\n+        Set<ProductContentDTO> productContent = dto.getProductContent();", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MDc0Nw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409480747", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:23:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg4OTYwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5MDY4Mg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408890682", "bodyText": "This needs to stay as BrandingDTO, since this method is working with DTOs, not the adapter layer. The code below that uses the adapter interface erroneously is what should change instead.", "author": "Ceiu", "createdAt": "2020-04-15T14:34:31Z", "path": "server/src/main/java/org/candlepin/controller/ProductManager.java", "diffHunk": "@@ -817,17 +823,17 @@ public static boolean isChangedBy(Product entity, ProductDTO dto) {\n             };\n \n             if (!Util.collectionsAreEqual((Collection) entity.getProductContent(),\n-                (Collection) productContent, comparator)) {\n+                (Collection) dto.getProductContent(), comparator)) {\n \n                 return true;\n             }\n         }\n \n-        Collection<BrandingDTO> brandingDTOs = dto.getBranding();\n+        Collection<BrandingInfo> brandingDTOs = getBranding(dto);", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MDgwOQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409480809", "bodyText": "Done. Replaced the use of adapter with a new comparator.", "author": "Januson", "createdAt": "2020-04-16T11:23:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5MDY4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NDQ4Mw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408894483", "bodyText": "Why are we no longer using the standard product model here?", "author": "Ceiu", "createdAt": "2020-04-15T14:39:24Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/ProductCertificateDTO.java", "diffHunk": "@@ -35,7 +35,7 @@\n     protected String id;\n     protected String key;\n     protected String cert;\n-    private ProductDTO product;\n+    private ProductLegacyDTO product;", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk4OTI5Mg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411989292", "bodyText": "Done. Removed ProductLegacyDTO", "author": "Januson", "createdAt": "2020-04-21T08:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NDQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NjkxNQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408896915", "bodyText": "Encapsulation violation", "author": "Ceiu", "createdAt": "2020-04-15T14:42:34Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/ProductTranslator.java", "diffHunk": "@@ -104,11 +118,37 @@ public ProductDTO populate(ModelTranslator modelTranslator, Product source, Prod\n             }\n         }\n         else {\n-            destination.setProductContent(Collections.emptyList());\n+            destination.productContent(Collections.emptySet());\n             destination.setBranding(Collections.emptySet());\n         }\n \n         return destination;\n     }\n \n+    private AttributesDTO createAttributes(Map<String, String> attributes) {\n+        AttributesDTO dto = new AttributesDTO();\n+        if (attributes == null) {\n+            dto.attributes(new HashMap<>());\n+        }\n+        else {\n+            dto.attributes(attributes);\n+        }\n+        return dto;\n+    }\n+\n+    private void addBranding(ProductDTO product, BrandingDTO branding) {\n+        if (isNullOrIncomplete(branding)) {\n+            throw new IllegalArgumentException(\"branding is null or incomplete\");\n+        }\n+\n+        product.getBranding().add(branding);", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MDk0MQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409480941", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NjkxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NzYzOA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408897638", "bodyText": "Rather than offload this to an inherited method (and all the baggage that comes with it), we should follow the model used by the content block above and set the collection all at once directly.", "author": "Ceiu", "createdAt": "2020-04-15T14:43:26Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/ProductTranslator.java", "diffHunk": "@@ -61,41 +63,53 @@ public ProductDTO populate(Product source, ProductDTO destination) {\n      */\n     @Override\n     public ProductDTO populate(ModelTranslator modelTranslator, Product source, ProductDTO destination) {\n-        destination = super.populate(modelTranslator, source, destination);\n+        if (source == null) {\n+            throw new IllegalArgumentException(\"source is null\");\n+        }\n \n-        destination.setUuid(source.getUuid());\n-        destination.setId(source.getId());\n-        destination.setName(source.getName());\n-        destination.setMultiplier(source.getMultiplier());\n-        destination.setHref(source.getHref());\n-        destination.setLocked(source.isLocked());\n-        destination.setAttributes(source.getAttributes());\n-        destination.setDependentProductIds(source.getDependentProductIds());\n+        if (destination == null) {\n+            throw new IllegalArgumentException(\"destination is null\");\n+        }\n+\n+        destination.created(Util.toDateTime(source.getCreated()))\n+            .updated(Util.toDateTime(source.getUpdated()))\n+            .uuid(source.getUuid())\n+            .id(source.getId())\n+            .name(source.getName())\n+            .multiplier(source.getMultiplier())\n+            .href(source.getHref())\n+            .locked(source.isLocked())\n+            .attributes(createAttributes(source.getAttributes()))\n+            .productContent(new HashSet<>())\n+            .branding(new HashSet<>())\n+            .dependentProductIds(new HashSet<>(source.getDependentProductIds()));\n \n         if (modelTranslator != null) {\n             Collection<ProductContent> productContent = source.getProductContent();\n-            destination.setProductContent(Collections.emptyList());\n-\n             if (productContent != null) {\n-                ObjectTranslator<Content, ContentDTO> contentTranslator = modelTranslator\n-                    .findTranslatorByClass(Content.class, ContentDTO.class);\n+                ObjectTranslator<ProductContent, ProductContentDTO> contentTranslator = modelTranslator\n+                    .findTranslatorByClass(ProductContent.class, ProductContentDTO.class);\n \n+                Set<ProductContentDTO> content = new HashSet<>();\n                 for (ProductContent pc : productContent) {\n                     if (pc != null) {\n-                        ContentDTO dto = contentTranslator.translate(modelTranslator, pc.getContent());\n-\n+                        ProductContentDTO dto = contentTranslator.translate(modelTranslator, pc);\n                         if (dto != null) {\n-                            destination.addContent(dto, pc.isEnabled());\n+                            content.add(dto);\n                         }\n                     }\n                 }\n+                destination.productContent(content);\n+            }\n+            else {\n+                destination.productContent(Collections.emptySet());\n             }\n \n             Collection<Branding> branding = source.getBranding();\n             if (branding != null && !branding.isEmpty()) {\n                 for (Branding brand : branding) {\n                     if (brand != null) {\n-                        destination.addBranding(modelTranslator.translate(brand, BrandingDTO.class));\n+                        addBranding(destination, modelTranslator.translate(brand, BrandingDTO.class));", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTAyOQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481029", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5NzYzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5ODc4OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408898789", "bodyText": "Like the other instances of this, just build the collection and set it directly.", "author": "Ceiu", "createdAt": "2020-04-15T14:44:53Z", "path": "server/src/main/java/org/candlepin/dto/shim/ProductDataTranslator.java", "diffHunk": "@@ -70,40 +74,43 @@ public ProductDTO populate(ModelTranslator modelTranslator, ProductData source,\n             throw new IllegalArgumentException(\"dest is null\");\n         }\n \n-        dest.setCreated(source.getCreated());\n-        dest.setUpdated(source.getUpdated());\n-\n-        dest.setUuid(source.getUuid());\n-        dest.setId(source.getId());\n-        dest.setName(source.getName());\n-        dest.setMultiplier(source.getMultiplier());\n-        dest.setAttributes(source.getAttributes());\n-        dest.setDependentProductIds(source.getDependentProductIds());\n-        dest.setHref(source.getHref());\n-        dest.setLocked(source.isLocked());\n-\n+        dest.id(source.getId())\n+            .uuid(source.getUuid())\n+            .name(source.getName())\n+            .multiplier(source.getMultiplier())\n+            .created(Util.toDateTime(source.getCreated()))\n+            .updated(Util.toDateTime(source.getUpdated()))\n+            .attributes(Util.split(source.getAttributes()))\n+            .productContent(new HashSet<>())\n+            .branding(new HashSet<>())\n+            .dependentProductIds(toSet(source))\n+            .href(source.getHref())\n+            .locked(source.isLocked());\n \n         if (modelTranslator != null) {\n             Collection<ProductContentData> productContentData = source.getProductContent();\n-            dest.setProductContent(null);\n             if (productContentData != null) {\n                 ObjectTranslator<ContentData, ContentDTO> contentTranslator = modelTranslator\n                     .findTranslatorByClass(ContentData.class, ContentDTO.class);\n \n-                for (ProductContentData pcd : productContentData) {\n-                    if (pcd != null && pcd.getContent() != null) {\n-                        ContentDTO dto = contentTranslator.translate(modelTranslator, pcd.getContent());\n-                        dest.addContent(dto, pcd.isEnabled());\n+                for (ProductContentData productContent : productContentData) {\n+                    if (productContent != null && productContent.getContent() != null) {\n+                        ContentDTO dto = contentTranslator\n+                            .translate(modelTranslator, productContent.getContent());\n+                        addContent(dest, dto, productContent.isEnabled());\n                     }\n                 }\n             }\n+            else {\n+                dest.productContent(null);\n+            }\n \n             Collection<Branding> productBrandings = source.getBranding();\n             dest.setBranding(null);\n             if (productBrandings != null) {\n                 for (Branding brand : productBrandings) {\n                     if (brand != null) {\n-                        dest.addBranding(modelTranslator.translate(brand, BrandingDTO.class));\n+                        addBranding(dest, modelTranslator.translate(brand, BrandingDTO.class));", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTA2NQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481065", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5ODc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTAyNg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408899026", "bodyText": "Build and set the collection directly", "author": "Ceiu", "createdAt": "2020-04-15T14:45:09Z", "path": "server/src/main/java/org/candlepin/dto/shim/ProductDataTranslator.java", "diffHunk": "@@ -70,40 +74,43 @@ public ProductDTO populate(ModelTranslator modelTranslator, ProductData source,\n             throw new IllegalArgumentException(\"dest is null\");\n         }\n \n-        dest.setCreated(source.getCreated());\n-        dest.setUpdated(source.getUpdated());\n-\n-        dest.setUuid(source.getUuid());\n-        dest.setId(source.getId());\n-        dest.setName(source.getName());\n-        dest.setMultiplier(source.getMultiplier());\n-        dest.setAttributes(source.getAttributes());\n-        dest.setDependentProductIds(source.getDependentProductIds());\n-        dest.setHref(source.getHref());\n-        dest.setLocked(source.isLocked());\n-\n+        dest.id(source.getId())\n+            .uuid(source.getUuid())\n+            .name(source.getName())\n+            .multiplier(source.getMultiplier())\n+            .created(Util.toDateTime(source.getCreated()))\n+            .updated(Util.toDateTime(source.getUpdated()))\n+            .attributes(Util.split(source.getAttributes()))\n+            .productContent(new HashSet<>())\n+            .branding(new HashSet<>())\n+            .dependentProductIds(toSet(source))\n+            .href(source.getHref())\n+            .locked(source.isLocked());\n \n         if (modelTranslator != null) {\n             Collection<ProductContentData> productContentData = source.getProductContent();\n-            dest.setProductContent(null);\n             if (productContentData != null) {\n                 ObjectTranslator<ContentData, ContentDTO> contentTranslator = modelTranslator\n                     .findTranslatorByClass(ContentData.class, ContentDTO.class);\n \n-                for (ProductContentData pcd : productContentData) {\n-                    if (pcd != null && pcd.getContent() != null) {\n-                        ContentDTO dto = contentTranslator.translate(modelTranslator, pcd.getContent());\n-                        dest.addContent(dto, pcd.isEnabled());\n+                for (ProductContentData productContent : productContentData) {\n+                    if (productContent != null && productContent.getContent() != null) {\n+                        ContentDTO dto = contentTranslator\n+                            .translate(modelTranslator, productContent.getContent());\n+                        addContent(dest, dto, productContent.isEnabled());", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTEwMw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481103", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTE4OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408899189", "bodyText": "encapsulation", "author": "Ceiu", "createdAt": "2020-04-15T14:45:23Z", "path": "server/src/main/java/org/candlepin/dto/shim/ProductDataTranslator.java", "diffHunk": "@@ -114,4 +121,42 @@ public ProductDTO populate(ModelTranslator modelTranslator, ProductData source,\n \n         return dest;\n     }\n+\n+    private HashSet<String> toSet(ProductData source) {\n+        if (source == null || source.getDependentProductIds() == null) {\n+            return null;\n+        }\n+        return new HashSet<>(source.getDependentProductIds());\n+    }\n+\n+    private void addContent(ProductLegacyDTO product, ContentDTO dto, boolean enabled) {\n+        if (dto == null || dto.getId() == null) {\n+            throw new IllegalArgumentException(\"dto references incomplete content\");\n+        }\n+\n+        ProductContentDTO content = new ProductContentDTO();\n+        content.setContent(dto);\n+        content.setEnabled(enabled);\n+\n+        product.getProductContent().add(content);", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTEzOQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481139", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTE4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTI0NQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408899245", "bodyText": "encapsulation", "author": "Ceiu", "createdAt": "2020-04-15T14:45:27Z", "path": "server/src/main/java/org/candlepin/dto/shim/ProductDataTranslator.java", "diffHunk": "@@ -114,4 +121,42 @@ public ProductDTO populate(ModelTranslator modelTranslator, ProductData source,\n \n         return dest;\n     }\n+\n+    private HashSet<String> toSet(ProductData source) {\n+        if (source == null || source.getDependentProductIds() == null) {\n+            return null;\n+        }\n+        return new HashSet<>(source.getDependentProductIds());\n+    }\n+\n+    private void addContent(ProductLegacyDTO product, ContentDTO dto, boolean enabled) {\n+        if (dto == null || dto.getId() == null) {\n+            throw new IllegalArgumentException(\"dto references incomplete content\");\n+        }\n+\n+        ProductContentDTO content = new ProductContentDTO();\n+        content.setContent(dto);\n+        content.setEnabled(enabled);\n+\n+        product.getProductContent().add(content);\n+    }\n+\n+    private boolean addBranding(ProductLegacyDTO product, BrandingDTO branding) {\n+        if (isNullOrIncomplete(branding)) {\n+            throw new IllegalArgumentException(\"branding is null or incomplete\");\n+        }\n+\n+        if (product.getBranding() == null) {\n+            product.setBranding(new HashSet<>());\n+        }\n+\n+        return product.getBranding().add(branding);", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTE3NQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481175", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTI0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTg4OA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408899888", "bodyText": "This should be unnecessary. The places where we'd need such a thing are probably already doing something bad and should be updated rather than adding more to the Jenga tower.", "author": "Ceiu", "createdAt": "2020-04-15T14:46:14Z", "path": "server/src/main/java/org/candlepin/hostedtest/BrandingInfoAdapter.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+\n+package org.candlepin.hostedtest;\n+\n+import org.candlepin.dto.api.v1.BrandingDTO;\n+import org.candlepin.service.model.BrandingInfo;\n+\n+public class BrandingInfoAdapter implements BrandingInfo {", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTIzOA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481238", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5OTg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyMTI1OA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408921258", "bodyText": "Does this have value when we're explicitly defining the structure via objects (and inheriting oddities such as the .getAttributes().getAttributes() as above?)", "author": "Ceiu", "createdAt": "2020-04-15T15:13:24Z", "path": "server/src/main/java/org/candlepin/jackson/CandlepinAttributesDeserializer.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/**\n+ * Copyright (c) 2009 - 2016 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.jackson;\n+\n+import org.candlepin.common.exceptions.CandlepinJsonProcessingException;\n+import org.candlepin.dto.api.v1.AttributesDTO;\n+\n+import com.fasterxml.jackson.core.JsonParser;\n+import com.fasterxml.jackson.core.TreeNode;\n+import com.fasterxml.jackson.databind.DeserializationContext;\n+import com.fasterxml.jackson.databind.deser.std.StdDeserializer;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+\n+\n+/**\n+ * The CandlepinAttributeDeserializer handles the deserialization of attributes, processing both\n+ * the current attribute mapping style and obsoleted formats.\n+ */\n+public class CandlepinAttributesDeserializer extends StdDeserializer<AttributesDTO> {", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk2MzQ2NA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411963464", "bodyText": "Done. Not needed anymore after removal of ProductLegacyDTO.", "author": "Januson", "createdAt": "2020-04-21T08:02:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyMTI1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNDUyNw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408924527", "bodyText": "Keep this whitespace", "author": "Ceiu", "createdAt": "2020-04-15T15:17:43Z", "path": "server/src/main/java/org/candlepin/resource/CdnResource.java", "diffHunk": "@@ -51,7 +51,6 @@ public CdnResource(I18n i18n, CdnCurator curator, CdnManager manager, ModelTrans\n         this.cdnManager = manager;\n         this.translator = translator;\n     }\n-", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTI5Mw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481293", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNDUyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNTE5Mg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408925192", "bodyText": "encapsulation", "author": "Ceiu", "createdAt": "2020-04-15T15:18:39Z", "path": "server/src/main/java/org/candlepin/resource/OwnerProductResource.java", "diffHunk": "@@ -346,14 +351,36 @@ public ProductDTO addBatchContent(\n \n             ContentDTO cdto = this.translator.translate(content, ContentDTO.class);\n \n-            changed |= pdto.addContent(cdto, enabled);\n+            changed |= addContent(pdto, cdto, enabled);\n         }\n \n         if (changed) {\n             product = this.productManager.updateProduct(pdto, owner, true);\n         }\n \n-        return this.translator.translate(product, ProductDTO.class);\n+        return this.translator.translate(product, ProductLegacyDTO.class);\n+    }\n+\n+\n+    private boolean addContent(ProductDTO product, ContentDTO dto, boolean enabled) {\n+        if (dto == null || dto.getId() == null) {\n+            throw new IllegalArgumentException(\"dto references incomplete content\");\n+        }\n+\n+        ProductContentDTO content = new ProductContentDTO();\n+        content.setContent(dto);\n+        content.setEnabled(enabled);\n+\n+        boolean changed = product.getProductContent()\n+            .stream()\n+            .filter(contentDTO -> contentDTO.getContent().getId().equals(content.getContent().getId()))\n+            .noneMatch(contentDTO -> contentDTO.equals(content));\n+\n+        if (changed) {\n+            product.getProductContent().add(content);", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjI1MDQyMA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r412250420", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T14:46:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNTE5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNjQ0Mw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408926443", "bodyText": "We seem to be heavily using the \"Legacy\" product here and aren't using the base product at all, which implies it's not actually legacy.", "author": "Ceiu", "createdAt": "2020-04-15T15:20:06Z", "path": "server/src/main/java/org/candlepin/resource/OwnerProductResource.java", "diffHunk": "@@ -196,7 +201,7 @@ protected Content fetchContent(Owner owner, String contentId) {\n         response = Product.class, responseContainer = \"list\")\n     @GET\n     @Produces(MediaType.APPLICATION_JSON)\n-    public CandlepinQuery<ProductDTO> listProducts(\n+    public CandlepinQuery<ProductLegacyDTO> listProducts(", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5NTE3Ng==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409495176", "bodyText": "We are using both. ProductLegacyDTO and CandlepinAttributesDeserializer are my attempt to preserve current functionallity of @JsonSerialize/Deserialize we use for attributes.", "author": "Januson", "createdAt": "2020-04-16T11:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNjQ0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk2MTg0NQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411961845", "bodyText": "Removed *LegacyDTOs", "author": "Januson", "createdAt": "2020-04-21T08:00:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNjQ0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNjc2Nw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408926767", "bodyText": "encapsulation", "author": "Ceiu", "createdAt": "2020-04-15T15:20:32Z", "path": "server/src/main/java/org/candlepin/resource/OwnerProductResource.java", "diffHunk": "@@ -407,30 +434,44 @@ public ProductDTO removeBatchContent(\n         // Alternatively, we can shut off Hibernate's auto-commit junk and get in the habit of\n         // calling commit methods as necessary so we don't have to work with DTOs internally.\n \n-        boolean changed = false;\n-        for (String contentId : contentIds) {\n-            changed |= pdto.removeContent(contentId);\n-        }\n+        boolean changed = removeContent(pdto, new HashSet<>(contentIds));\n \n         if (changed) {\n             product = this.productManager.updateProduct(pdto, owner, true);\n         }\n \n-        return this.translator.translate(product, ProductDTO.class);\n+        return this.translator.translate(product, ProductLegacyDTO.class);\n+    }\n+\n+    public boolean removeContent(ProductDTO product, Set<String> contentIds) {\n+        if (contentIds == null) {\n+            throw new IllegalArgumentException(\"contentId is null\");\n+        }\n+        if (contentIds.isEmpty()) {\n+            return false;\n+        }\n+\n+        Set<ProductContentDTO> toRemove = product.getProductContent().stream()\n+            .filter(content -> contentIds.contains(content.getContent().getId()))\n+            .collect(Collectors.toSet());\n+\n+        product.getProductContent().removeAll(toRemove);", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjIyODAwMA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r412228000", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T14:20:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyNjc2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyODYxNQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408928615", "bodyText": "This is unrelated to your PR, but can we put a TODO on this to axe this entirely? I don't think anyone knows it exists, and it doesn't provide any real value other than saving two lines of code.", "author": "Ceiu", "createdAt": "2020-04-15T15:23:01Z", "path": "server/src/main/java/org/candlepin/util/Util.java", "diffHunk": "@@ -143,6 +147,13 @@ public static Date toDate(String dt) {\n         }\n     }\n \n+    public static Date toDate(OffsetDateTime dt) {\n+        if (dt == null) {\n+            return null;\n+        }\n+        return Date.from(dt.toInstant());\n+    }\n+\n     public static <T> T assertNotNull(T value, String message) {", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTQ2OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481469", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:24:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkyODYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkzMDI0MA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408930240", "bodyText": "This method is already defined in java.util.Collections with the exact same name and arguments, but is generically typed.", "author": "Ceiu", "createdAt": "2020-04-15T15:25:12Z", "path": "server/src/main/java/org/candlepin/util/Util.java", "diffHunk": "@@ -547,4 +558,37 @@ public static String getHostname() {\n     public static OffsetDateTime toDateTime(Date date) {\n         return date != null ? date.toInstant().atOffset(ZoneOffset.UTC) : null;\n     }\n+\n+    /**\n+     * Takes a map and splits it into a list of maps each with one item from the given map.\n+     *\n+     * @param map a map to be split\n+     * @return a list of single item maps\n+     */\n+    public static List<Map<String, String>> split(Map<String, String> map) {\n+        if (map == null) {\n+            return Collections.emptyList();\n+        }\n+        return map.entrySet().stream()\n+            .map(Util::singletonMap)\n+            .collect(Collectors.toList());\n+    }\n+\n+    private static Map<String, String> singletonMap(Map.Entry<String, String> entry) {\n+        return singletonMap(entry.getKey(), entry.getValue());\n+    }\n+\n+    /**\n+     * Takes a key value pair and returns a map with a single entry.\n+     *\n+     * @param key a key of the single entry\n+     * @param value a value of the single entry\n+     * @return a map with a single entry\n+     */\n+    public static Map<String, String> singletonMap(String key, String value) {", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ4MTU0MQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r409481541", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-16T11:25:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODkzMDI0MA=="}], "type": "inlineReview"}, {"oid": "2282a86d9906e84ae58ad99eaa34fb746f7ab5c4", "url": "https://github.com/candlepin/candlepin/commit/2282a86d9906e84ae58ad99eaa34fb746f7ab5c4", "message": "PR review fixes\n\n- Fix api descriptions\n- Remove unnecessary legacy subscription dto\n- Refactor content update in content manager\n- Replace with Collections implementation\n- Remove assertNonNull util\n- Replace branding adapter with comparator", "committedDate": "2020-04-16T11:15:45Z", "type": "forcePushed"}, {"oid": "52822d9cea012f292073800b657c94b497b66af7", "url": "https://github.com/candlepin/candlepin/commit/52822d9cea012f292073800b657c94b497b66af7", "message": "PR review fixes\n\n- Fix api descriptions\n- Remove unnecessary legacy subscription dto\n- Refactor content update in content manager\n- Replace with Collections implementation\n- Remove assertNonNull util\n- Replace branding adapter with comparator", "committedDate": "2020-04-16T11:19:52Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5MDAyNg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r408890026", "bodyText": "All the DTOs that were ported/introduced in the spec file also need to have jackson mix-ins added in the addMixInAnnotationsForDTOs method in this class.", "author": "nikosmoum", "createdAt": "2020-04-15T14:33:42Z", "path": "server/src/main/java/org/candlepin/resteasy/JsonProvider.java", "diffHunk": "@@ -113,6 +115,7 @@ public JsonProvider(boolean indentJson, ProductCachedSerializationModule product\n         customModule.addSerializer(Date.class, new DateSerializer());\n         // Ensure we handle releaseVer fields properly\n         customModule.addDeserializer(ReleaseVerDTO.class, new ReleaseVersionWrapDeserializer());\n+        customModule.addDeserializer(AttributesDTO.class, new CandlepinAttributesDeserializer());\n         mapper.registerModule(customModule);\n ", "originalCommit": "21da61f71057203caa366ad7c3dd28cb0438bc21", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMzAzNQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411913035", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:43:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg5MDAyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIzOTkyNQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r410239925", "bodyText": "Comment needs an update, since BrandingDTO no longer implements BrandingInfo, it should mention something like \"...for Branding and BrandingDTO objects\"", "author": "nikosmoum", "createdAt": "2020-04-17T13:56:23Z", "path": "server/src/main/java/org/candlepin/controller/ProductManager.java", "diffHunk": "@@ -825,16 +834,39 @@ public static boolean isChangedBy(Product entity, ProductDTO dto) {\n \n         Collection<BrandingDTO> brandingDTOs = dto.getBranding();\n         if (brandingDTOs != null) {\n-            Comparator<BrandingInfo> comparator = BrandingInfo.getBrandingInfoComparator();\n-            if (!Util.collectionsAreEqual((Collection) entity.getBranding(), (Collection) brandingDTOs,\n-                comparator)) {\n+            Comparator comparator = getBrandingDTOComparator();\n+            if (!Util.collectionsAreEqual((Collection) entity.getBranding(),\n+                (Collection) brandingDTOs, comparator)) {\n                 return true;\n             }\n         }\n \n         return false;\n     }\n \n+\n+    /**\n+     * Utility method that returns a Comparator for objects that implement BrandingInfo.\n+     *\n+     * @return A comparator for BrandingInfo objects.", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTk0Nw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911947", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:41:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIzOTkyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI0NDMyMw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r410244323", "bodyText": "Wrong comment", "author": "nikosmoum", "createdAt": "2020-04-17T14:03:16Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/ProductContentTranslator.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.dto.ObjectTranslator;\n+import org.candlepin.model.ProductContent;\n+\n+\n+/**\n+ * The ContentTranslator provides translation from Content model objects to\n+ * ContentDTOs", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTU1Nw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911557", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI0NDMyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1MzgwOQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r410253809", "bodyText": "I don't think we should be throwing exceptions in translators. This kind of thing is for when we receive a DTO in a POST/PUT request and we have to validate the client data. Here, we're just translating the data we know is already valid (Branding) to be output back, so we don't need any validation", "author": "nikosmoum", "createdAt": "2020-04-17T14:18:23Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/ProductTranslator.java", "diffHunk": "@@ -61,54 +64,94 @@ public ProductDTO populate(Product source, ProductDTO destination) {\n      */\n     @Override\n     public ProductDTO populate(ModelTranslator modelTranslator, Product source, ProductDTO destination) {\n-        destination = super.populate(modelTranslator, source, destination);\n+        if (source == null) {\n+            throw new IllegalArgumentException(\"source is null\");\n+        }\n+\n+        if (destination == null) {\n+            throw new IllegalArgumentException(\"destination is null\");\n+        }\n \n-        destination.setUuid(source.getUuid());\n-        destination.setId(source.getId());\n-        destination.setName(source.getName());\n-        destination.setMultiplier(source.getMultiplier());\n-        destination.setHref(source.getHref());\n-        destination.setLocked(source.isLocked());\n-        destination.setAttributes(source.getAttributes());\n-        destination.setDependentProductIds(source.getDependentProductIds());\n+        destination.created(Util.toDateTime(source.getCreated()))\n+            .updated(Util.toDateTime(source.getUpdated()))\n+            .uuid(source.getUuid())\n+            .id(source.getId())\n+            .name(source.getName())\n+            .multiplier(source.getMultiplier())\n+            .href(source.getHref())\n+            .locked(source.isLocked())\n+            .attributes(toAttributes(source.getAttributes()))\n+            .productContent(new HashSet<>())\n+            .branding(new HashSet<>())\n+            .dependentProductIds(new HashSet<>(source.getDependentProductIds()));\n \n         if (modelTranslator != null) {\n             Collection<ProductContent> productContent = source.getProductContent();\n-            destination.setProductContent(Collections.emptyList());\n-\n             if (productContent != null) {\n-                ObjectTranslator<Content, ContentDTO> contentTranslator = modelTranslator\n-                    .findTranslatorByClass(Content.class, ContentDTO.class);\n+                ObjectTranslator<ProductContent, ProductContentDTO> contentTranslator = modelTranslator\n+                    .findTranslatorByClass(ProductContent.class, ProductContentDTO.class);\n \n+                Set<ProductContentDTO> content = new HashSet<>();\n                 for (ProductContent pc : productContent) {\n                     if (pc != null) {\n-                        ContentDTO dto = contentTranslator.translate(modelTranslator, pc.getContent());\n-\n+                        ProductContentDTO dto = contentTranslator.translate(modelTranslator, pc);\n                         if (dto != null) {\n-                            destination.addContent(dto, pc.isEnabled());\n+                            content.add(dto);\n                         }\n                     }\n                 }\n+                destination.productContent(content);\n+            }\n+            else {\n+                destination.productContent(Collections.emptySet());\n             }\n \n             Collection<Branding> branding = source.getBranding();\n             if (branding != null && !branding.isEmpty()) {\n+                Set<BrandingDTO> dtos = new HashSet<>();\n                 for (Branding brand : branding) {\n                     if (brand != null) {\n-                        destination.addBranding(modelTranslator.translate(brand, BrandingDTO.class));\n+                        BrandingDTO dto = modelTranslator.translate(brand, BrandingDTO.class);\n+                        if (isNullOrIncomplete(dto)) {\n+                            throw new IllegalArgumentException(\"branding is null or incomplete\");", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTUxMw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911513", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1MzgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1NDcwNg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r410254706", "bodyText": "wrong comment", "author": "nikosmoum", "createdAt": "2020-04-17T14:19:43Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/SubscriptionTranslator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/**\n+ * Copyright (c) 2009 - 2020 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.dto.ObjectTranslator;\n+import org.candlepin.model.Cdn;\n+import org.candlepin.model.Certificate;\n+import org.candlepin.model.Owner;\n+import org.candlepin.model.dto.ProductData;\n+import org.candlepin.model.dto.Subscription;\n+import org.candlepin.util.Util;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+\n+/**\n+ * The RoleTranslator provides translation from Role model objects to\n+ * RoleDTOs", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTQ3Ng==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911476", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1NDcwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1OTgwNA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r410259804", "bodyText": "Same here: no need for validation at this point", "author": "nikosmoum", "createdAt": "2020-04-17T14:27:28Z", "path": "server/src/main/java/org/candlepin/dto/shim/ProductDataTranslator.java", "diffHunk": "@@ -70,42 +79,51 @@ public ProductDTO populate(ModelTranslator modelTranslator, ProductData source,\n             throw new IllegalArgumentException(\"dest is null\");\n         }\n \n-        dest.setCreated(source.getCreated());\n-        dest.setUpdated(source.getUpdated());\n-\n-        dest.setUuid(source.getUuid());\n-        dest.setId(source.getId());\n-        dest.setName(source.getName());\n-        dest.setMultiplier(source.getMultiplier());\n-        dest.setAttributes(source.getAttributes());\n-        dest.setDependentProductIds(source.getDependentProductIds());\n-        dest.setHref(source.getHref());\n-        dest.setLocked(source.isLocked());\n-\n+        dest.id(source.getId())\n+            .uuid(source.getUuid())\n+            .name(source.getName())\n+            .multiplier(source.getMultiplier())\n+            .created(Util.toDateTime(source.getCreated()))\n+            .updated(Util.toDateTime(source.getUpdated()))\n+            .attributes(toAttributes(source.getAttributes()))\n+            .productContent(new HashSet<>())\n+            .branding(new HashSet<>())\n+            .dependentProductIds(toSet(source))\n+            .href(source.getHref())\n+            .locked(source.isLocked());\n \n         if (modelTranslator != null) {\n             Collection<ProductContentData> productContentData = source.getProductContent();\n-            dest.setProductContent(null);\n-            if (productContentData != null) {\n+            if (productContentData != null && !productContentData.isEmpty()) {\n                 ObjectTranslator<ContentData, ContentDTO> contentTranslator = modelTranslator\n                     .findTranslatorByClass(ContentData.class, ContentDTO.class);\n-\n-                for (ProductContentData pcd : productContentData) {\n-                    if (pcd != null && pcd.getContent() != null) {\n-                        ContentDTO dto = contentTranslator.translate(modelTranslator, pcd.getContent());\n-                        dest.addContent(dto, pcd.isEnabled());\n+                Set<ProductContentDTO> dtos = new HashSet<>();\n+                for (ProductContentData productContent : productContentData) {\n+                    if (productContent != null && productContent.getContent() != null) {\n+                        ContentDTO dto = contentTranslator\n+                            .translate(modelTranslator, productContent.getContent());\n+                        dtos.add(createContent(dto, productContent.isEnabled()));\n                     }\n                 }\n+                dest.productContent(dtos);\n+            }\n+            else {\n+                dest.productContent(Collections.emptySet());\n             }\n \n             Collection<Branding> productBrandings = source.getBranding();\n-            dest.setBranding(null);\n-            if (productBrandings != null) {\n+            if (productBrandings != null && !productBrandings.isEmpty()) {\n+                Set<BrandingDTO> dtos = new HashSet<>();\n                 for (Branding brand : productBrandings) {\n                     if (brand != null) {\n-                        dest.addBranding(modelTranslator.translate(brand, BrandingDTO.class));\n+                        BrandingDTO dto = modelTranslator.translate(brand, BrandingDTO.class);\n+                        if (isNullOrIncomplete(dto)) {\n+                            throw new IllegalArgumentException(\"branding is null or incomplete\");", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTQ1Mg==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911452", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI1OTgwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NTIwNA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r410265204", "bodyText": "We're moving this resource to the spec file, which means all these annotations should be removed from all endpoints here (since they will be auto-generated in SubscriptionApi)", "author": "nikosmoum", "createdAt": "2020-04-17T14:35:32Z", "path": "server/src/main/java/org/candlepin/resource/SubscriptionResource.java", "diffHunk": "@@ -63,34 +65,37 @@\n @Path(\"/subscriptions\")\n @Api(value = \"subscriptions\", authorizations = { @Authorization(\"basic\") })\n @Consumes(MediaType.APPLICATION_JSON)\n-public class SubscriptionResource {\n+public class SubscriptionResource implements SubscriptionsApi {\n     private static Logger log = LoggerFactory.getLogger(SubscriptionResource.class);\n \n-    private SubscriptionServiceAdapter subService;\n-    private ConsumerCurator consumerCurator;\n-    private PoolManager poolManager;\n-\n-    private I18n i18n;\n+    private final SubscriptionServiceAdapter subService;\n+    private final ConsumerCurator consumerCurator;\n+    private final PoolManager poolManager;\n+    private final I18n i18n;\n+    private final ModelTranslator translator;\n \n     @Inject\n     public SubscriptionResource(SubscriptionServiceAdapter subService,\n-        ConsumerCurator consumerCurator, PoolManager poolManager, I18n i18n) {\n-\n-        this.subService = subService;\n-        this.consumerCurator = consumerCurator;\n-        this.poolManager = poolManager;\n-\n-        this.i18n = i18n;\n+        ConsumerCurator consumerCurator, PoolManager poolManager, I18n i18n,\n+        ModelTranslator translator) {\n+\n+        this.subService = Objects.requireNonNull(subService);\n+        this.consumerCurator = Objects.requireNonNull(consumerCurator);\n+        this.poolManager = Objects.requireNonNull(poolManager);\n+        this.i18n = Objects.requireNonNull(i18n);\n+        this.translator = Objects.requireNonNull(translator);\n     }\n \n     @ApiOperation(notes = \"Retrieves a list of Subscriptions\", value = \"getSubscriptions\")\n     @GET\n     @Produces(MediaType.APPLICATION_JSON)", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTQzMQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911431", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NTIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MzIzNA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r410343234", "bodyText": "We're still violating encapsulation principles here. We don't want to modify the collection and assume that's going to be retained.\nWe should be building up the content and then throwing a new collection at the DTO, or figuring out a way to return the addContent method back to the OpenAPI DTOs.", "author": "Ceiu", "createdAt": "2020-04-17T16:44:02Z", "path": "server/src/main/java/org/candlepin/controller/ContentManager.java", "diffHunk": "@@ -306,28 +303,56 @@ public Content updateContent(ContentDTO update, Owner owner, boolean regenerateE\n         updated = this.contentCurator.create(updated);\n \n         this.ownerContentCurator.updateOwnerContentReferences(owner,\n-            Collections.<String, String>singletonMap(entity.getUuid(), updated.getUuid()));\n+            Collections.singletonMap(entity.getUuid(), updated.getUuid()));\n \n         // Impl note:\n         // This block is a consequence of products and contents not being strongly related.\n         log.debug(\"Updating {} affected products\", affectedProducts.size());\n-        ContentDTO cdto = this.modelTranslator.translate(updated, ContentDTO.class);\n+        ContentDTO updatedContent = this.modelTranslator.translate(updated, ContentDTO.class);\n \n         // TODO: Should we bulk this up like we do in importContent? Probably.\n         for (Product product : affectedProducts) {\n             log.debug(\"Updating affected product: {}\", product);\n+\n             ProductDTO pdto = this.modelTranslator.translate(product, ProductDTO.class);\n+            addContent(pdto, updatedContent);\n \n-            ProductContentDTO pcdto = pdto.getProductContent(cdto.getId());\n-            if (pcdto != null) {\n-                pdto.addContent(cdto, pcdto.isEnabled());\n+            // Impl note: This should also take care of our entitlement cert regeneration\n+            this.productManager.updateProduct(pdto, owner, regenerateEntitlementCerts);\n+        }\n \n-                // Impl note: This should also take care of our entitlement cert regeneration\n-                this.productManager.updateProduct(pdto, owner, regenerateEntitlementCerts);\n+        return updated;\n+    }\n+\n+    private ProductContentDTO findContent(Set<ProductContentDTO> contents, String id) {\n+        if (id == null) {\n+            return null;\n+        }\n+        for (ProductContentDTO content : contents) {\n+            if (id.equals(content.getContent().getId())) {\n+                return content;\n             }\n         }\n+        return null;\n+    }\n \n-        return updated;\n+    private void addContent(ProductDTO product, ContentDTO update) {\n+        if (update == null || update.getId() == null) {\n+            throw new IllegalArgumentException(\"update references incomplete content\");\n+        }\n+\n+        Set<ProductContentDTO> productContent = product.getProductContent();", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk3MDI5OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411970299", "bodyText": "That is a problem with our current use of dtos. DTO is breaking encapsulation by definition. Using them as a makeshift domain objects is only making it worse. We are modifying the all over the place which we should not do.", "author": "Januson", "createdAt": "2020-04-21T08:12:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MzIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjM5NzM0OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r412397349", "bodyText": "We've already run into problems a number of times before by doing this. Making assumptions about how the DTOs map their data isn't a good practice here. As soon as you do, you're coupling the internal logic of two completely separate things -- one of which we have very little control over now.\nShould ContentManager be using DTOs these days? Absolutely not. It's an area that's very deserving of a refactor. But that's not reason enough to exacerbate the problem.", "author": "Ceiu", "createdAt": "2020-04-21T18:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MzIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjcwOTY0Mw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r412709643", "bodyText": "We are apparently agreeing about the problem. What do you suggest w should do? I refactored the code so that the collection are at least not modified in place, but coupling is still there.", "author": "Januson", "createdAt": "2020-04-22T06:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MzIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc4MDQxOA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r412780418", "bodyText": "In the interest of getting this PR merged, and not adding additional work, I think the solution for now is good. But we should find a better way of doing this in another task.\nI spent sometime trying to understand why we even use DTOs in this way in the ContentManager. Firstly, using DTOs in Product/ContentManager is no problem in itself, if what we're doing is simply accepting a DTO as an update from a resource endpoint and only call getters on it. And I agree with both of you, we shouldn't be altering the data on the DTO. The reason (which seems uniquely affecting ContentManager but not ProductManager) looks to me to be:\nWhat we want to do:\n\nWe're fetching entities from the DB (Content and Product) and want to process them (involves altering the data on them).\nThen we want to pass on that data to the ProductManager (because they're intrinsically connected), BUT, the ProductManager\naccepts DTOs as input, so we have to translate the entities into DTOs and then pass them to ProductManager.\n\nWhat we're actually doing:\n\nFetching entities from the DB (alternate versions of content, affected products etc.)\nWe're explicitly using a translator and turning them into DTOs (ONLY because we want to later send them to ProductManager, which accepts DTOs)\nWe're processing/altering them (here is the current problem).\nSending them off to ProductManager.\n\nWhat I think we should be doing:\n\nFetching entities from DB.\nWe're processing/altering them. **\nWe're translating them to DTOs.\nSending them to ProductManager.\n\n** If we have hibernate issues in step 2 here, as some comments in the code imply,\nwhere altering collections on entities is a problem, then we have some alternatives:\na. Up until now we used DTOs (but now this is a problem, so something else should be used)\nb. We can clone the entities (so that they are not hibernate-managed, and alter freely)\nc. We can create new data containers (you could call them DTOs) that provide the encapsulation\nwe need.\nI think a is not an option, and c is overkill (because we'd still need to re-translate into api DTOs), and prefer option b.", "author": "nikosmoum", "createdAt": "2020-04-22T08:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MzIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzA5ODE1NA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r413098154", "bodyText": "@Januson\nWe should be avoiding directly modifying the collection and assuming it will update the DTO's state. That last part is what makes this class dependent on the inner workings of the DTO. We should, instead, create a new collection of the content we want, and assign that to the DTO.\n@nikosmoum\nSome history on why DTOs were ever used in the Product/Content manager:\nOriginally, it only accepted model objects, as the expectation was that it would take a modified product, fetch a new instance from the DB exactly how it's represented on the backend, and do all its calculations based on the modified local (potentially attached) instance, and the detached instance it fetched representing the current DB state.\nHowever, due to how we've configured Hibernate (primarily, auto-commit/flush), there are a number of operations which cause Hibernate to be \"helpful\" and persist some changes to managed objects, even if we haven't explicitly called .merge or .update. The first version had a number of weird bugs where collections on products and content would not be reflected in version comparisons, because Hibernate had persisted the change for us as soon as we did any select on the DB against the table owning the object -- even if it was for a different entity/instance.\nThis led to a number of choices, and after weighing the pros/cons of them, we, perhaps erroneously, opted to use DTOs at this layer to allow us to pass in the changes without risking putting a managed object in an unknown state.\nSince then, we've made a number of other changes, such as making product and content immutable, which may fix the issue entirely by means of telling Hibernate to never change the object; we've added the service adapter model, which is how most of these changes are made today; and I'm currently working on a refresh refactor which pulls much of the work out of these managers.\nIt's entirely probable that in the very near future, we'll have a clear view of what these managers need to do, and how we should go about using them. The resource refactor should be the final nail in the coffin of passing the DTOs into the managers, and will likely be the optimal point for addressing the remaining components of the managers in question.", "author": "Ceiu", "createdAt": "2020-04-22T15:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MzIzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzc0MTY4OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r413741689", "bodyText": "@Ceiu @Januson Alright, we can address the long term impact after those changes. For the short-term changes in this PR then, the change should be: iterate the DTO collection items and add them to an entirely new collection, modify the new collection as needed, then add it back to the DTO, right?\nEdit: It looks like the updated code is using the HashSet copy constructor, which internally is doing just that, so no need for more changes?", "author": "nikosmoum", "createdAt": "2020-04-23T11:37:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MzIzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5MjQxMw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411292413", "bodyText": "Where exactly is this needed? I can't find where this is used in your changes?", "author": "nikosmoum", "createdAt": "2020-04-20T11:11:05Z", "path": "server/src/main/java/org/candlepin/util/Util.java", "diffHunk": "@@ -547,4 +550,24 @@ public static String getHostname() {\n     public static OffsetDateTime toDateTime(Date date) {\n         return date != null ? date.toInstant().atOffset(ZoneOffset.UTC) : null;\n     }\n+\n+    /**\n+     * Takes a map and splits it into a list of maps each with one item from the given map.\n+     *\n+     * @param map a map to be split\n+     * @return a list of single item maps\n+     */\n+    public static List<Map<String, String>> split(Map<String, String> map) {", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTM4OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911389", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5MjQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5OTIzOQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411299239", "bodyText": "Code duplication: This can be replaced by instantiating a ContentTranslatorTest and calling initSourceObject()", "author": "nikosmoum", "createdAt": "2020-04-20T11:23:19Z", "path": "server/src/test/java/org/candlepin/dto/api/v1/ProductContentTranslatorTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.AbstractTranslatorTest;\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.model.Content;\n+import org.candlepin.model.ProductContent;\n+\n+import java.util.Arrays;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+\n+\n+/**\n+ * Test suite for the ContentTranslator class\n+ */\n+public class ProductContentTranslatorTest extends\n+    AbstractTranslatorTest<ProductContent, ProductContentDTO, ProductContentTranslator> {\n+\n+    protected ProductContentTranslator translator = new ProductContentTranslator();\n+\n+    @Override\n+    protected void initModelTranslator(ModelTranslator modelTranslator) {\n+        modelTranslator.registerTranslator(new ContentTranslator(), Content.class, ContentDTO.class);\n+        modelTranslator.registerTranslator(this.translator, ProductContent.class, ProductContentDTO.class);\n+    }\n+\n+    @Override\n+    protected ProductContentTranslator initObjectTranslator() {\n+        return this.translator;\n+    }\n+\n+    @Override\n+    protected ProductContent initSourceObject() {\n+        Content content = new Content();\n+\n+        content.setUuid(\"test_value\");\n+        content.setId(\"test_value\");\n+        content.setType(\"test_value\");\n+        content.setLabel(\"test_value\");\n+        content.setName(\"test_value\");\n+        content.setVendor(\"test_value\");\n+        content.setContentUrl(\"test_value\");\n+        content.setRequiredTags(\"test_value\");\n+        content.setReleaseVersion(\"test_value\");\n+        content.setGpgUrl(\"test_value\");\n+        content.setMetadataExpiration(1234L);\n+        content.setModifiedProductIds(Arrays.asList(\"1\", \"2\", \"3\"));\n+        content.setArches(\"test_value\");\n+        content.setLocked(Boolean.TRUE);", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTMzOA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911338", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5OTIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5OTg4NA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411299884", "bodyText": "Code duplication: This can be replaced by calling ContentTranslatorTest's verifyOutput method", "author": "nikosmoum", "createdAt": "2020-04-20T11:24:29Z", "path": "server/src/test/java/org/candlepin/dto/api/v1/ProductContentTranslatorTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.AbstractTranslatorTest;\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.model.Content;\n+import org.candlepin.model.ProductContent;\n+\n+import java.util.Arrays;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNull;\n+\n+\n+/**\n+ * Test suite for the ContentTranslator class\n+ */\n+public class ProductContentTranslatorTest extends\n+    AbstractTranslatorTest<ProductContent, ProductContentDTO, ProductContentTranslator> {\n+\n+    protected ProductContentTranslator translator = new ProductContentTranslator();\n+\n+    @Override\n+    protected void initModelTranslator(ModelTranslator modelTranslator) {\n+        modelTranslator.registerTranslator(new ContentTranslator(), Content.class, ContentDTO.class);\n+        modelTranslator.registerTranslator(this.translator, ProductContent.class, ProductContentDTO.class);\n+    }\n+\n+    @Override\n+    protected ProductContentTranslator initObjectTranslator() {\n+        return this.translator;\n+    }\n+\n+    @Override\n+    protected ProductContent initSourceObject() {\n+        Content content = new Content();\n+\n+        content.setUuid(\"test_value\");\n+        content.setId(\"test_value\");\n+        content.setType(\"test_value\");\n+        content.setLabel(\"test_value\");\n+        content.setName(\"test_value\");\n+        content.setVendor(\"test_value\");\n+        content.setContentUrl(\"test_value\");\n+        content.setRequiredTags(\"test_value\");\n+        content.setReleaseVersion(\"test_value\");\n+        content.setGpgUrl(\"test_value\");\n+        content.setMetadataExpiration(1234L);\n+        content.setModifiedProductIds(Arrays.asList(\"1\", \"2\", \"3\"));\n+        content.setArches(\"test_value\");\n+        content.setLocked(Boolean.TRUE);\n+\n+        ProductContent source = new ProductContent();\n+        source.setContent(content);\n+        source.setEnabled(true);\n+\n+        return source;\n+    }\n+\n+    @Override\n+    protected ProductContentDTO initDestinationObject() {\n+        // Nothing fancy to do here.\n+        return new ProductContentDTO();\n+    }\n+\n+    @Override\n+    protected void verifyOutput(ProductContent source, ProductContentDTO dto, boolean childrenGenerated) {\n+        if (source != null) {\n+            // This DTO does not have any nested objects, so we don't need to worry about the\n+            // childrenGenerated flag\n+\n+            assertEquals(source.isEnabled(), dto.getEnabled());\n+\n+            if (childrenGenerated) {\n+                Content content = source.getContent();\n+                ContentDTO contentDto = dto.getContent();\n+                assertEquals(content.getUuid(), contentDto.getUuid());\n+                assertEquals(content.getId(), contentDto.getId());\n+                assertEquals(content.getType(), contentDto.getType());\n+                assertEquals(content.getLabel(), contentDto.getLabel());\n+                assertEquals(content.getName(), contentDto.getName());\n+                assertEquals(content.getVendor(), contentDto.getVendor());\n+                assertEquals(content.getContentUrl(), contentDto.getContentUrl());\n+                assertEquals(content.getRequiredTags(), contentDto.getRequiredTags());\n+                assertEquals(content.getReleaseVersion(), contentDto.getReleaseVer());\n+                assertEquals(content.getGpgUrl(), contentDto.getGpgUrl());\n+                assertEquals(content.getMetadataExpiration(), contentDto.getMetadataExpire());\n+                assertEquals(content.getModifiedProductIds(), contentDto.getModifiedProductIds());\n+                assertEquals(content.getArches(), contentDto.getArches());", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTMxOQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911319", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTI5OTg4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMjQzNA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411302434", "bodyText": "There is no use for creating new util methods to create ProductData instances. You can create a ProductDataTranslatorTest instance and call initSourceObject() instead", "author": "nikosmoum", "createdAt": "2020-04-20T11:28:58Z", "path": "server/src/test/java/org/candlepin/dto/api/v1/SubscriptionTranslatorTest.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.AbstractTranslatorTest;\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.dto.shim.ProductDataTranslator;\n+import org.candlepin.model.Cdn;\n+import org.candlepin.model.Certificate;\n+import org.candlepin.model.Owner;\n+import org.candlepin.model.SubscriptionsCertificate;\n+import org.candlepin.model.dto.ProductData;\n+import org.candlepin.model.dto.Subscription;\n+import org.candlepin.util.Util;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Date;\n+\n+import static org.apache.commons.collections.CollectionUtils.isEmpty;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Test suite for the ProductTranslator class\n+ */\n+public class SubscriptionTranslatorTest extends\n+    AbstractTranslatorTest<Subscription, SubscriptionDTO, SubscriptionTranslator> {\n+\n+    private SubscriptionTranslator translator = new SubscriptionTranslator();\n+\n+    @Override\n+    protected void initModelTranslator(ModelTranslator modelTranslator) {\n+        modelTranslator.registerTranslator(new CdnTranslator(), Cdn.class, CdnDTO.class);\n+        modelTranslator.registerTranslator(\n+            new CertificateTranslator(), Certificate.class, CertificateDTO.class);\n+        modelTranslator.registerTranslator(new NestedOwnerTranslator(), Owner.class, NestedOwnerDTO.class);\n+        modelTranslator.registerTranslator(\n+            new ProductDataTranslator(), ProductData.class, ProductDTO.class);\n+        modelTranslator.registerTranslator(this.translator, Subscription.class, SubscriptionDTO.class);\n+    }\n+\n+    @Override\n+    protected SubscriptionTranslator initObjectTranslator() {\n+        return this.translator;\n+    }\n+\n+    @Override\n+    protected Subscription initSourceObject() {\n+        Subscription source = new Subscription();\n+\n+        source.setId(\"test_id\");\n+        source.setOwner(this.createOwner());\n+        source.setProduct(this.createProduct());\n+        source.setDerivedProduct(this.createProduct());\n+        source.setProvidedProducts(this.createProducts());\n+        source.setDerivedProvidedProducts(this.createProducts());", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTI4OQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911289", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:40:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMjQzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMzQ2MA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411303460", "bodyText": "These 2 can be replaced by using CertificateTranslatorTest.initSourceObject() and CdnTranslatorTest.initSourceObject()", "author": "nikosmoum", "createdAt": "2020-04-20T11:30:53Z", "path": "server/src/test/java/org/candlepin/dto/api/v1/SubscriptionTranslatorTest.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.AbstractTranslatorTest;\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.dto.shim.ProductDataTranslator;\n+import org.candlepin.model.Cdn;\n+import org.candlepin.model.Certificate;\n+import org.candlepin.model.Owner;\n+import org.candlepin.model.SubscriptionsCertificate;\n+import org.candlepin.model.dto.ProductData;\n+import org.candlepin.model.dto.Subscription;\n+import org.candlepin.util.Util;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Date;\n+\n+import static org.apache.commons.collections.CollectionUtils.isEmpty;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Test suite for the ProductTranslator class\n+ */\n+public class SubscriptionTranslatorTest extends\n+    AbstractTranslatorTest<Subscription, SubscriptionDTO, SubscriptionTranslator> {\n+\n+    private SubscriptionTranslator translator = new SubscriptionTranslator();\n+\n+    @Override\n+    protected void initModelTranslator(ModelTranslator modelTranslator) {\n+        modelTranslator.registerTranslator(new CdnTranslator(), Cdn.class, CdnDTO.class);\n+        modelTranslator.registerTranslator(\n+            new CertificateTranslator(), Certificate.class, CertificateDTO.class);\n+        modelTranslator.registerTranslator(new NestedOwnerTranslator(), Owner.class, NestedOwnerDTO.class);\n+        modelTranslator.registerTranslator(\n+            new ProductDataTranslator(), ProductData.class, ProductDTO.class);\n+        modelTranslator.registerTranslator(this.translator, Subscription.class, SubscriptionDTO.class);\n+    }\n+\n+    @Override\n+    protected SubscriptionTranslator initObjectTranslator() {\n+        return this.translator;\n+    }\n+\n+    @Override\n+    protected Subscription initSourceObject() {\n+        Subscription source = new Subscription();\n+\n+        source.setId(\"test_id\");\n+        source.setOwner(this.createOwner());\n+        source.setProduct(this.createProduct());\n+        source.setDerivedProduct(this.createProduct());\n+        source.setProvidedProducts(this.createProducts());\n+        source.setDerivedProvidedProducts(this.createProducts());\n+        source.setQuantity(15L);\n+        source.setStartDate(new Date());\n+        source.setEndDate(new Date());\n+        source.setContractNumber(\"test_contact\");\n+        source.setAccountNumber(\"test_acc_num\");\n+        source.setModified(new Date());\n+        source.setOrderNumber(\"test_order_num\");\n+        source.setUpstreamPoolId(\"test_pool_id\");\n+        source.setUpstreamEntitlementId(\"test_ent_id\");\n+        source.setUpstreamConsumerId(\"test_cons_id\");\n+        source.setCertificate(this.createCert());\n+        source.setCdn(this.createCdn());", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTI2Nw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911267", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwMzQ2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwNTAzNA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411305034", "bodyText": "NestedOwnerTranslatorTest.initSourceObject()", "author": "nikosmoum", "createdAt": "2020-04-20T11:33:34Z", "path": "server/src/test/java/org/candlepin/dto/api/v1/SubscriptionTranslatorTest.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.AbstractTranslatorTest;\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.dto.shim.ProductDataTranslator;\n+import org.candlepin.model.Cdn;\n+import org.candlepin.model.Certificate;\n+import org.candlepin.model.Owner;\n+import org.candlepin.model.SubscriptionsCertificate;\n+import org.candlepin.model.dto.ProductData;\n+import org.candlepin.model.dto.Subscription;\n+import org.candlepin.util.Util;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Date;\n+\n+import static org.apache.commons.collections.CollectionUtils.isEmpty;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Test suite for the ProductTranslator class\n+ */\n+public class SubscriptionTranslatorTest extends\n+    AbstractTranslatorTest<Subscription, SubscriptionDTO, SubscriptionTranslator> {\n+\n+    private SubscriptionTranslator translator = new SubscriptionTranslator();\n+\n+    @Override\n+    protected void initModelTranslator(ModelTranslator modelTranslator) {\n+        modelTranslator.registerTranslator(new CdnTranslator(), Cdn.class, CdnDTO.class);\n+        modelTranslator.registerTranslator(\n+            new CertificateTranslator(), Certificate.class, CertificateDTO.class);\n+        modelTranslator.registerTranslator(new NestedOwnerTranslator(), Owner.class, NestedOwnerDTO.class);\n+        modelTranslator.registerTranslator(\n+            new ProductDataTranslator(), ProductData.class, ProductDTO.class);\n+        modelTranslator.registerTranslator(this.translator, Subscription.class, SubscriptionDTO.class);\n+    }\n+\n+    @Override\n+    protected SubscriptionTranslator initObjectTranslator() {\n+        return this.translator;\n+    }\n+\n+    @Override\n+    protected Subscription initSourceObject() {\n+        Subscription source = new Subscription();\n+\n+        source.setId(\"test_id\");\n+        source.setOwner(this.createOwner());", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTI0NA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911244", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:39:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwNTAzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwNTY5MQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411305691", "bodyText": "The various verifyOutput methods from the *TranslatorTest.java instances can be used here instead", "author": "nikosmoum", "createdAt": "2020-04-20T11:34:45Z", "path": "server/src/test/java/org/candlepin/dto/api/v1/SubscriptionTranslatorTest.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.AbstractTranslatorTest;\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.dto.shim.ProductDataTranslator;\n+import org.candlepin.model.Cdn;\n+import org.candlepin.model.Certificate;\n+import org.candlepin.model.Owner;\n+import org.candlepin.model.SubscriptionsCertificate;\n+import org.candlepin.model.dto.ProductData;\n+import org.candlepin.model.dto.Subscription;\n+import org.candlepin.util.Util;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Date;\n+\n+import static org.apache.commons.collections.CollectionUtils.isEmpty;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+/**\n+ * Test suite for the ProductTranslator class\n+ */\n+public class SubscriptionTranslatorTest extends\n+    AbstractTranslatorTest<Subscription, SubscriptionDTO, SubscriptionTranslator> {\n+\n+    private SubscriptionTranslator translator = new SubscriptionTranslator();\n+\n+    @Override\n+    protected void initModelTranslator(ModelTranslator modelTranslator) {\n+        modelTranslator.registerTranslator(new CdnTranslator(), Cdn.class, CdnDTO.class);\n+        modelTranslator.registerTranslator(\n+            new CertificateTranslator(), Certificate.class, CertificateDTO.class);\n+        modelTranslator.registerTranslator(new NestedOwnerTranslator(), Owner.class, NestedOwnerDTO.class);\n+        modelTranslator.registerTranslator(\n+            new ProductDataTranslator(), ProductData.class, ProductDTO.class);\n+        modelTranslator.registerTranslator(this.translator, Subscription.class, SubscriptionDTO.class);\n+    }\n+\n+    @Override\n+    protected SubscriptionTranslator initObjectTranslator() {\n+        return this.translator;\n+    }\n+\n+    @Override\n+    protected Subscription initSourceObject() {\n+        Subscription source = new Subscription();\n+\n+        source.setId(\"test_id\");\n+        source.setOwner(this.createOwner());\n+        source.setProduct(this.createProduct());\n+        source.setDerivedProduct(this.createProduct());\n+        source.setProvidedProducts(this.createProducts());\n+        source.setDerivedProvidedProducts(this.createProducts());\n+        source.setQuantity(15L);\n+        source.setStartDate(new Date());\n+        source.setEndDate(new Date());\n+        source.setContractNumber(\"test_contact\");\n+        source.setAccountNumber(\"test_acc_num\");\n+        source.setModified(new Date());\n+        source.setOrderNumber(\"test_order_num\");\n+        source.setUpstreamPoolId(\"test_pool_id\");\n+        source.setUpstreamEntitlementId(\"test_ent_id\");\n+        source.setUpstreamConsumerId(\"test_cons_id\");\n+        source.setCertificate(this.createCert());\n+        source.setCdn(this.createCdn());\n+\n+        return source;\n+    }\n+\n+    private Collection<ProductData> createProducts() {\n+        return Arrays.asList(\n+            new ProductData(),\n+            new ProductData()\n+        );\n+    }\n+\n+    private ProductData createProduct() {\n+        return new ProductData();\n+    }\n+\n+    @Override\n+    protected SubscriptionDTO initDestinationObject() {\n+        // Nothing fancy to do here.\n+        return new SubscriptionDTO();\n+    }\n+\n+    @Override\n+    protected void verifyOutput(\n+        Subscription source, SubscriptionDTO dto, boolean childrenGenerated) {\n+        if (source != null) {\n+            assertEquals(source.getId(), dto.getId());\n+            assertEquals(source.getQuantity(), dto.getQuantity());\n+            assertEquals(Util.toDateTime(source.getStartDate()), dto.getStartDate());\n+            assertEquals(Util.toDateTime(source.getEndDate()), dto.getEndDate());\n+            assertEquals(source.getContractNumber(), dto.getContractNumber());\n+            assertEquals(source.getAccountNumber(), dto.getAccountNumber());\n+            assertEquals(Util.toDateTime(source.getModified()), dto.getModified());\n+            assertEquals(source.getOrderNumber(), dto.getOrderNumber());\n+            assertEquals(source.getUpstreamPoolId(), dto.getUpstreamPoolId());\n+            assertEquals(source.getUpstreamEntitlementId(), dto.getUpstreamEntitlementId());\n+            assertEquals(source.getUpstreamConsumerId(), dto.getUpstreamConsumerId());\n+\n+            if (childrenGenerated) {\n+                assertNotNull(source.getOwner());\n+                assertNotNull(source.getProduct());\n+                assertNotNull(source.getDerivedProduct());\n+                assertNotNull(source.getCertificate());\n+                assertNotNull(source.getCdn());\n+\n+                for (ProductData product : source.getProvidedProducts()) {\n+                    assertNotNull(product);\n+                }\n+\n+                for (ProductData product : source.getDerivedProvidedProducts()) {\n+                    assertNotNull(product);\n+                }\n+            }\n+            else {\n+\n+                assertTrue(isEmpty(dto.getProvidedProducts()));\n+                assertTrue(isEmpty(dto.getDerivedProvidedProducts()));\n+                assertNull(dto.getOwner());\n+                assertNull(dto.getProduct());\n+                assertNull(dto.getDerivedProduct());\n+                assertNull(dto.getCert());\n+                assertNull(dto.getCdn());\n+            }", "originalCommit": "7e860ebb94fc59cd0847cf5664960f9e0d2dbb9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkxMTIxMA==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r411911210", "bodyText": "Done.", "author": "Januson", "createdAt": "2020-04-21T06:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTMwNTY5MQ=="}], "type": "inlineReview"}, {"oid": "c39b40ccb71bd7e7cb3a9256bb27a99adc9835d0", "url": "https://github.com/candlepin/candlepin/commit/c39b40ccb71bd7e7cb3a9256bb27a99adc9835d0", "message": "More review fixes\n- Remove *LegacyDTO\n- Add MixIn for deserialization of attributes", "committedDate": "2020-04-20T14:06:30Z", "type": "forcePushed"}, {"oid": "f241f9dd9ec51089d3bbe399ddcde7b0dec83f48", "url": "https://github.com/candlepin/candlepin/commit/f241f9dd9ec51089d3bbe399ddcde7b0dec83f48", "message": "More review fixes\n- Remove *LegacyDTO\n- Add MixIn for deserialization of attributes", "committedDate": "2020-04-20T14:24:16Z", "type": "forcePushed"}, {"oid": "afcfb9e567e48bbb467299db426e53847ae78212", "url": "https://github.com/candlepin/candlepin/commit/afcfb9e567e48bbb467299db426e53847ae78212", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-21T06:39:14Z", "type": "forcePushed"}, {"oid": "d08a20464103ebf852810193aace696f36ce9138", "url": "https://github.com/candlepin/candlepin/commit/d08a20464103ebf852810193aace696f36ce9138", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-21T08:37:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA2NTI1MQ==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r412065251", "bodyText": "Should be ProductContentDTO instead of ContentDTO", "author": "nikosmoum", "createdAt": "2020-04-21T10:27:30Z", "path": "server/src/main/java/org/candlepin/dto/api/v1/ProductContentTranslator.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/**\n+ * Copyright (c) 2009 - 2017 Red Hat, Inc.\n+ *\n+ * This software is licensed to you under the GNU General Public License,\n+ * version 2 (GPLv2). There is NO WARRANTY for this software, express or\n+ * implied, including the implied warranties of MERCHANTABILITY or FITNESS\n+ * FOR A PARTICULAR PURPOSE. You should have received a copy of GPLv2\n+ * along with this software; if not, see\n+ * http://www.gnu.org/licenses/old-licenses/gpl-2.0.txt.\n+ *\n+ * Red Hat trademarks are not licensed under GPLv2. No permission is\n+ * granted to use or replicate Red Hat trademarks that are incorporated\n+ * in this software or its documentation.\n+ */\n+package org.candlepin.dto.api.v1;\n+\n+import org.candlepin.dto.ModelTranslator;\n+import org.candlepin.dto.ObjectTranslator;\n+import org.candlepin.model.ProductContent;\n+\n+\n+/**\n+ * The ProductContentTranslator provides translation from {@link ProductContent}\n+ * model objects to {@link ContentDTO}s", "originalCommit": "d08a20464103ebf852810193aace696f36ce9138", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5ODQzMw==", "url": "https://github.com/candlepin/candlepin/pull/2674#discussion_r412098433", "bodyText": "It looks like adding a second mixin for the same target class doesn't work (it overrides the first one). So the filtering that is provided by the DynamicPropertyFilterMixIn addition doesn't work right not (I've created the following spec test to test dynamic filtering: http://pastebin.test.redhat.com/857369).\nTo fix it, I tried making ProductAttributesMixIn implement DynamicPropertyFilterMixIn, but that didn't work. Then I found this, which says that it should work using inheritance, so I turned DynamicPropertyFilterMixIn from an interface to an abstract class, and had ProductAttributesMixIn extend it, and it did work, so we should do that", "author": "nikosmoum", "createdAt": "2020-04-21T11:21:58Z", "path": "server/src/main/java/org/candlepin/resteasy/JsonProvider.java", "diffHunk": "@@ -174,13 +182,17 @@ private void addMixInAnnotationsForDTOs(ObjectMapper mapper) {\n         mapper.addMixIn(GuestIdDTOArrayElement.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(NestedOwnerDTO.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(PermissionBlueprintDTO.class, DynamicPropertyFilterMixIn.class);\n+        mapper.addMixIn(ProductContentDTO.class, DynamicPropertyFilterMixIn.class);\n+        mapper.addMixIn(ProductDTO.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(RoleDTO.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(StatusDTO.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(TimestampedEntity.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(UserDTO.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(OwnerDTO.class, DynamicPropertyFilterMixIn.class);\n+        mapper.addMixIn(SubscriptionDTO.class, DynamicPropertyFilterMixIn.class);\n         mapper.addMixIn(UpstreamConsumerDTO.class, DynamicPropertyFilterMixIn.class);\n         //TODO: Add more mix-ins here as more DTOs are ported to openapi spec\n+\n+        mapper.addMixIn(ProductDTO.class, ProductAttributesMixIn.class);", "originalCommit": "d08a20464103ebf852810193aace696f36ce9138", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e828e9c6b2a933225e0d7103e2cacc374956390f", "url": "https://github.com/candlepin/candlepin/commit/e828e9c6b2a933225e0d7103e2cacc374956390f", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-21T14:00:10Z", "type": "forcePushed"}, {"oid": "83b1917d4a88d9fedf08a23c59fed0df05d51c77", "url": "https://github.com/candlepin/candlepin/commit/83b1917d4a88d9fedf08a23c59fed0df05d51c77", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-21T14:09:33Z", "type": "forcePushed"}, {"oid": "1c8f6d32560d32fb7eeb8a25ca705a9694dfb6b4", "url": "https://github.com/candlepin/candlepin/commit/1c8f6d32560d32fb7eeb8a25ca705a9694dfb6b4", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-21T14:44:22Z", "type": "forcePushed"}, {"oid": "672cdf2242f43eb40f71974854b27b2bbaba018b", "url": "https://github.com/candlepin/candlepin/commit/672cdf2242f43eb40f71974854b27b2bbaba018b", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-22T06:36:05Z", "type": "forcePushed"}, {"oid": "a659acfff56fc657d49ac53bd451d87ec77c23fe", "url": "https://github.com/candlepin/candlepin/commit/a659acfff56fc657d49ac53bd451d87ec77c23fe", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-23T13:49:48Z", "type": "forcePushed"}, {"oid": "7f2f3076b23e3d454ebb6c6b615e6dbecadf410e", "url": "https://github.com/candlepin/candlepin/commit/7f2f3076b23e3d454ebb6c6b615e6dbecadf410e", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-23T14:10:48Z", "type": "forcePushed"}, {"oid": "c877b2406bde7a3b6eefe21071b413b00bbee3c8", "url": "https://github.com/candlepin/candlepin/commit/c877b2406bde7a3b6eefe21071b413b00bbee3c8", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-23T14:15:15Z", "type": "commit"}, {"oid": "c877b2406bde7a3b6eefe21071b413b00bbee3c8", "url": "https://github.com/candlepin/candlepin/commit/c877b2406bde7a3b6eefe21071b413b00bbee3c8", "message": "ENT-1886: Port SubscriptionResource to spec-first\n- Add SubscriptionResource definition\n- Add missing DTO definitions\n- Add translators\n- Add AttributesDeserializer", "committedDate": "2020-04-23T14:15:15Z", "type": "forcePushed"}]}