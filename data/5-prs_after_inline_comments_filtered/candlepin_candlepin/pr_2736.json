{"pr_number": 2736, "pr_title": "1847879: Artemis errors while trying to send events during hypervisor update job (ENT-2529)", "pr_createdAt": "2020-06-25T12:51:08Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2736", "timeline": [{"oid": "a28b932db68186cca97be099893bedbf2af8bcec", "url": "https://github.com/candlepin/candlepin/commit/a28b932db68186cca97be099893bedbf2af8bcec", "message": "1847879: Artemis errors while trying to send events during hypervisor update job", "committedDate": "2020-06-26T06:03:07Z", "type": "forcePushed"}, {"oid": "c1fc008101e8095d7bdef8595028db1ebba4df06", "url": "https://github.com/candlepin/candlepin/commit/c1fc008101e8095d7bdef8595028db1ebba4df06", "message": "1847879: Artemis errors while trying to send events during hypervisor update job", "committedDate": "2020-06-26T06:19:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE4Nzg5Mw==", "url": "https://github.com/candlepin/candlepin/pull/2736#discussion_r446187893", "bodyText": "This works, but is still breaking the encapsulation open to accomplish the goal. The purpose of the EventMessageSender is to be our abstraction layer for managing the session, so we should avoid spinning up a new one to do the work it should be doing. From the other change in this code, it appears you've already spotted the downside in doing it this way: you need to do the close check in every operation; making the session management exist in three places, rather than one.\nHowever, this does highlight another minor problem with the existing code: EventMessageSender isn't static. The wrapper does not care about the state of its outer class, nor should it ever use it. We don't need the baggage an inner class inherits in such a case, and we should be declaring it statically.", "author": "Ceiu", "createdAt": "2020-06-26T13:35:49Z", "path": "server/src/main/java/org/candlepin/audit/EventSinkImpl.java", "diffHunk": "@@ -127,8 +127,8 @@ public void queueEvent(Event event) {\n \n         try {\n             // Lazily initialize the message sender when the first\n-            // message gets queued.\n-            if (messageSender == null) {\n+            // message gets queued or initialize session if it's closed.\n+            if (messageSender == null || messageSender.session.isClosed()) {", "originalCommit": "c1fc008101e8095d7bdef8595028db1ebba4df06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njg0ODAwNw==", "url": "https://github.com/candlepin/candlepin/pull/2736#discussion_r446848007", "bodyText": "Right, made some adjustments to it.\nChecks on sendMessages & cancelMessages methods are to prevent doing anything if we don't have session opened. This line inside JobManager which make sure that events are always sent out or rolled backed (in case of exception). Now with transnational wrapper specifically in HypervisorUpdateJob the AMQ session get closed in last transaction, which leads to problem when control goes back to JobManager.", "author": "wolfdale", "createdAt": "2020-06-29T08:12:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjE4Nzg5Mw=="}], "type": "inlineReview"}, {"oid": "fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "url": "https://github.com/candlepin/candlepin/commit/fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "message": "1847879: Artemis errors while trying to send events during hypervisor update job", "committedDate": "2020-06-29T07:04:30Z", "type": "commit"}, {"oid": "fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "url": "https://github.com/candlepin/candlepin/commit/fbea6c174ce0fb2c39d1b2311f6b14d93f7c5a48", "message": "1847879: Artemis errors while trying to send events during hypervisor update job", "committedDate": "2020-06-29T07:04:30Z", "type": "forcePushed"}]}