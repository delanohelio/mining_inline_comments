{"pr_number": 2780, "pr_title": "1868383: Default repositories are not enabled, after registering a client with an Activation Key, to an org with Simple Content Access Mode in Red Hat Satellite 6 (ENT - 2742)", "pr_createdAt": "2020-08-24T05:41:18Z", "pr_url": "https://github.com/candlepin/candlepin/pull/2780", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODk3MA==", "url": "https://github.com/candlepin/candlepin/pull/2780#discussion_r476428970", "bodyText": "If we're adding content with the same ID to a given product twice, it will overwrite the previous instance with the new one. I would expect that this results in the enabled flag being set to whatever comes in last, rather than both existing on the product.\nAside from that, I don't understand the intent behind adding it as a disabled content if it's already present. In this case, the resultant behavior we want is for the content to be available if something has enabled it. Adding a disabled version of the content as well will only serve as a stumbling block for any processing that occurs after this step.\nIn the event we have an organization that has multiple sources of a given content with mixed enablement, I would expect the \"enabled\" version to win out. We could even fetch that set of content pretty easily with a new query that only fetches enabled content for a given owner.", "author": "Ceiu", "createdAt": "2020-08-25T12:59:46Z", "path": "server/src/main/java/org/candlepin/controller/ContentAccessManager.java", "diffHunk": "@@ -525,8 +524,19 @@ private String createDN(Consumer consumer, Owner owner) {\n         containerSet.add(container);\n         container.setId(\"content_access\");\n         container.setName(\" Content Access\");\n-        for (Content c : ownerContent) {\n-            container.addContent(c, false);\n+        Set<String> contentUuids = new HashSet<>();\n+\n+        for (Product product : ownerProduct) {\n+            for (ProductContent pc : product.getProductContent()) {\n+                if (contentUuids.contains(pc.getContent().getUuid())) {", "originalCommit": "564c4d608e24e8461a2f838e2aaeea5170692344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzA1NDM0Nw==", "url": "https://github.com/candlepin/candlepin/pull/2780#discussion_r477054347", "bodyText": "I was not sure what should be the expected behavior with mix content enablement, I have already asked PM's about it\nand waiting for a reply. Modified the code to make sure that the \"enabled\" version win out.\nI noticed that content can exist without product, when we query owner-content we get unwanted content, so decided to go via owner-product (and ideally it should be content of product with active pool, there was some work in that area with ENT-2352, not sure if it is there in master branch)", "author": "wolfdale", "createdAt": "2020-08-26T06:05:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzIzODcxMQ==", "url": "https://github.com/candlepin/candlepin/pull/2780#discussion_r477238711", "bodyText": "In non-SCA mode, we simply return duplicates (or more) of the same content that might be enabled or disabled, but that's because they come from different entitlement certs. I wonder what happens on the client side in that case (the client tools guys can help here). Do we actually end up with duplicate entries in redhat.repo?", "author": "nikosmoum", "createdAt": "2020-08-26T11:47:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1OTMwNg==", "url": "https://github.com/candlepin/candlepin/pull/2780#discussion_r477559306", "bodyText": "@cnsnyder @jirihnidek ^^\nI think I recall seeing discussion that it ends up being that if duplicates exist, then the first found is what is used; which is probably not desired overall (undefined behavior is bad behavior). If that's the case, then I think we should get some PMs involved, figure out what they expect, and then determine where the new behavior should be. I expect that it'll mostly fall to CP to generate something a tad more sane, since subman is already implementing a contingency plan, even if that implementation isn't optimal or deterministic.", "author": "Ceiu", "createdAt": "2020-08-26T20:08:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODk3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU2MDM5Nw==", "url": "https://github.com/candlepin/candlepin/pull/2780#discussion_r477560397", "bodyText": "Also, regardless, this branch is a bit special, since everything is being added to a single product. That in itself is causing deduplication work done elsewhere to keep the last update received (Product.addContent -> Product.addProductContent).\nSo really, the ask here is what PMs expect in the case of multiple entitlements providing a given content in different states of enablement.", "author": "Ceiu", "createdAt": "2020-08-26T20:10:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyODk3MA=="}], "type": "inlineReview"}, {"oid": "aebc6f66daf3698b3172185155d848fda61d1319", "url": "https://github.com/candlepin/candlepin/commit/aebc6f66daf3698b3172185155d848fda61d1319", "message": "1868383: Honour content default for owner in SCA mode (ENT-2742)", "committedDate": "2020-08-26T05:55:09Z", "type": "forcePushed"}, {"oid": "65c692aa826c69d13c45d2d3feae9dda915c2676", "url": "https://github.com/candlepin/candlepin/commit/65c692aa826c69d13c45d2d3feae9dda915c2676", "message": "1868383: Honour content default for owner in SCA mode (ENT-2742)", "committedDate": "2020-08-26T06:34:41Z", "type": "forcePushed"}, {"oid": "88a3cc06c703fe5ced03597edc47a582cb6dc1a4", "url": "https://github.com/candlepin/candlepin/commit/88a3cc06c703fe5ced03597edc47a582cb6dc1a4", "message": "1868383: Honour content default for owner in SCA mode (ENT-2742)\n  - When more than one product provides the same content with different\n    enablement values,deduplicate them by keeping the enabled content only.", "committedDate": "2020-08-27T13:33:09Z", "type": "commit"}, {"oid": "88a3cc06c703fe5ced03597edc47a582cb6dc1a4", "url": "https://github.com/candlepin/candlepin/commit/88a3cc06c703fe5ced03597edc47a582cb6dc1a4", "message": "1868383: Honour content default for owner in SCA mode (ENT-2742)\n  - When more than one product provides the same content with different\n    enablement values,deduplicate them by keeping the enabled content only.", "committedDate": "2020-08-27T13:33:09Z", "type": "forcePushed"}]}