{"pr_number": 6116, "pr_title": "Fix: Only if `.sav` file has changes a recovery dialog is shown", "pr_createdAt": "2020-03-13T22:43:40Z", "pr_url": "https://github.com/JabRef/jabref/pull/6116", "timeline": [{"oid": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "url": "https://github.com/JabRef/jabref/commit/73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "message": "When JabRef finds a `.sav` file without changes, there is no dialog asking for acceptance of changes anymore.\n\nCo-authored-by: Stefan Kolb <stefan-kolb@web.de>", "committedDate": "2020-03-13T22:43:54Z", "type": "commit"}, {"oid": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "url": "https://github.com/JabRef/jabref/commit/73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "message": "When JabRef finds a `.sav` file without changes, there is no dialog asking for acceptance of changes anymore.\n\nCo-authored-by: Stefan Kolb <stefan-kolb@web.de>", "committedDate": "2020-03-13T22:43:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2OTkxMw==", "url": "https://github.com/JabRef/jabref/pull/6116#discussion_r392569913", "bodyText": "Files.mismatch should do the job\nhttps://docs.oracle.com/en/java/javase/12/docs/api/java.base/java/nio/file/Files.html#mismatch(java.nio.file.Path,java.nio.file.Path)", "author": "tobiasdiez", "createdAt": "2020-03-14T09:03:24Z", "path": "src/main/java/org/jabref/logic/autosaveandbackup/BackupManager.java", "diffHunk": "@@ -86,13 +87,27 @@ public static void shutdown(BibDatabaseContext bibDatabaseContext) {\n     }\n \n     /**\n-     * Checks whether a backup file exists for the given database file.\n+     * Checks whether a backup file exists for the given database file. If it exists, it is checked whether it is\n+     * different from the original.\n      *\n-     * @param originalPath Path to the file a backup should be checked for.\n+     * @param originalPath Path to the file a backup should be checked for. Example: jabref.bib.\n+     * @return <code>true</code> if backup file exists AND differs from originalPath. <code>false</code> is the\n+     * \"default\" return value in the good case. In the case of an exception <code>true</code> is returned to ensure that\n+     * the user checks the output.\n      */\n-    public static boolean checkForBackupFile(Path originalPath) {\n+    public static boolean backupFileDiffers(Path originalPath) {\n         Path backupPath = getBackupPath(originalPath);\n-        return Files.exists(backupPath) && !Files.isDirectory(backupPath);\n+        if (!Files.exists(backupPath) || Files.isDirectory(backupPath)) {\n+            return false;\n+        }\n+\n+        try {\n+            return !com.google.common.io.Files.equal(originalPath.toFile(), backupPath.toFile());", "originalCommit": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU3MDA3OQ==", "url": "https://github.com/JabRef/jabref/pull/6116#discussion_r392570079", "bodyText": "How do these tests work? I cannot see a .sav file in the folder?!", "author": "tobiasdiez", "createdAt": "2020-03-14T09:05:47Z", "path": "src/test/java/org/jabref/logic/autosaveandbackup/BackupManagerTest.java", "diffHunk": "@@ -15,4 +17,22 @@ public void backupFileNameIsCorrectlyGeneratedWithinTmpDirectory() {\n         Path savPath = BackupManager.getBackupPath(bibPath);\n         assertEquals(Paths.get(\"tmp\", \"test.bib.sav\"), savPath);\n     }\n+\n+    @Test\n+    public void backupFileIsEqualForNonExistingBackup() throws Exception {\n+        Path originalFile = Path.of(BackupManagerTest.class.getResource(\"no-backup.bib\").toURI());\n+        assertFalse(BackupManager.backupFileDiffers(originalFile));\n+    }\n+\n+    @Test\n+    public void backupFileIsEqual() throws Exception {\n+        Path originalFile = Path.of(BackupManagerTest.class.getResource(\"no-changes.bib\").toURI());\n+        assertFalse(BackupManager.backupFileDiffers(originalFile));\n+    }\n+\n+    @Test\n+    public void backupFileDiffers() throws Exception {\n+        Path originalFile = Path.of(BackupManagerTest.class.getResource(\"changes.bib\").toURI());", "originalCommit": "73b7cb9c3ac7307ea5a5064e83104183c3c69e46", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU3NTMxNA==", "url": "https://github.com/JabRef/jabref/pull/6116#discussion_r392575314", "bodyText": "Save files are missing in the commit! @tobiasdiez Why do you approve the PR if you have objections (that are correct!)?", "author": "stefan-kolb", "createdAt": "2020-03-14T10:38:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU3MDA3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjcxMTA2MA==", "url": "https://github.com/JabRef/jabref/pull/6116#discussion_r392711060", "bodyText": "They did not work - I added the missing files in ee472cf", "author": "koppor", "createdAt": "2020-03-15T20:46:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU3MDA3OQ=="}], "type": "inlineReview"}, {"oid": "ee472cf55d351d22ea328eb897bf30e37f5a2811", "url": "https://github.com/JabRef/jabref/commit/ee472cf55d351d22ea328eb897bf30e37f5a2811", "message": "Make test names and filenames more speaking and add missing files", "committedDate": "2020-03-15T20:22:46Z", "type": "commit"}, {"oid": "db8e8b30a2c1e4ec38e8b4e7f5c6003e170c02b3", "url": "https://github.com/JabRef/jabref/commit/db8e8b30a2c1e4ec38e8b4e7f5c6003e170c02b3", "message": "Use JDK12 instead of Google Guava", "committedDate": "2020-03-15T20:44:15Z", "type": "commit"}, {"oid": "b5a39568ba5c4e41e17b87f0de5979762c3024bd", "url": "https://github.com/JabRef/jabref/commit/b5a39568ba5c4e41e17b87f0de5979762c3024bd", "message": "Merge branch 'master' into fix-bak", "committedDate": "2020-03-17T05:24:46Z", "type": "commit"}]}