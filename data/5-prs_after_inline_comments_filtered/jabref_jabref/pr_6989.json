{"pr_number": 6989, "pr_title": "Merge parsing of bracketed patterns", "pr_createdAt": "2020-10-07T16:05:35Z", "pr_url": "https://github.com/JabRef/jabref/pull/6989", "timeline": [{"oid": "29cf0bd13b073a8d44f82c043699ddb95d24c3d0", "url": "https://github.com/JabRef/jabref/commit/29cf0bd13b073a8d44f82c043699ddb95d24c3d0", "message": "Add test cases", "committedDate": "2020-10-07T15:37:45Z", "type": "commit"}, {"oid": "32f4a6417dc53bb8358fc601f62713f28a208f16", "url": "https://github.com/JabRef/jabref/commit/32f4a6417dc53bb8358fc601f62713f28a208f16", "message": "Fix test case use of unwanted character", "committedDate": "2020-10-08T13:29:36Z", "type": "commit"}, {"oid": "035723643b80928b5a68b68ce34f3135cdeb834e", "url": "https://github.com/JabRef/jabref/commit/035723643b80928b5a68b68ce34f3135cdeb834e", "message": "Add method injection to `expandBrackets`", "committedDate": "2020-10-08T14:42:14Z", "type": "commit"}, {"oid": "77045bd91ecdbaa5423c1f6705cbf9cd21254a3f", "url": "https://github.com/JabRef/jabref/commit/77045bd91ecdbaa5423c1f6705cbf9cd21254a3f", "message": "Fix logger message", "committedDate": "2020-10-08T14:42:35Z", "type": "commit"}, {"oid": "5647df5070db30d49646a4326fdcf51cc44e0069", "url": "https://github.com/JabRef/jabref/commit/5647df5070db30d49646a4326fdcf51cc44e0069", "message": "Extract methods and change parsing\n\nExtracts code from `generateKey` as methods for readability purposes and\n switches out the parsing code for the one in `BracketedPattern`", "committedDate": "2020-10-08T15:15:41Z", "type": "commit"}, {"oid": "cc8aabe742e168a882b7ada32a6bf1932997f1de", "url": "https://github.com/JabRef/jabref/commit/cc8aabe742e168a882b7ada32a6bf1932997f1de", "message": "Codestyle improvements", "committedDate": "2020-10-08T15:16:56Z", "type": "commit"}, {"oid": "876ab47da4d3398769a9f27f4027eb396869921d", "url": "https://github.com/JabRef/jabref/commit/876ab47da4d3398769a9f27f4027eb396869921d", "message": "Fix use of illegal character in test case", "committedDate": "2020-10-08T15:19:35Z", "type": "commit"}, {"oid": "9d96877d2b2a880bf0fafc0d74219f0c0925da22", "url": "https://github.com/JabRef/jabref/commit/9d96877d2b2a880bf0fafc0d74219f0c0925da22", "message": "Add log output for PatternSyntaxException", "committedDate": "2020-10-08T17:53:24Z", "type": "commit"}, {"oid": "af776c53478360071fb5103eb53eb205a82b590c", "url": "https://github.com/JabRef/jabref/commit/af776c53478360071fb5103eb53eb205a82b590c", "message": "Fix handling unwanted characters between brackets", "committedDate": "2020-10-08T19:36:02Z", "type": "commit"}, {"oid": "bca72ab52fa7343b452d3fa542cc6fe34354995b", "url": "https://github.com/JabRef/jabref/commit/bca72ab52fa7343b452d3fa542cc6fe34354995b", "message": "Fix Checkstyle", "committedDate": "2020-10-12T19:32:41Z", "type": "commit"}, {"oid": "47bc8d13826cb704ceed333a484f473764186262", "url": "https://github.com/JabRef/jabref/commit/47bc8d13826cb704ceed333a484f473764186262", "message": "Add test case for incorrect regex replacement", "committedDate": "2020-10-12T19:48:27Z", "type": "commit"}, {"oid": "c67128ccbd69550e5d4a3f4c6ceef04649e99440", "url": "https://github.com/JabRef/jabref/commit/c67128ccbd69550e5d4a3f4c6ceef04649e99440", "message": "Add JavaDoc", "committedDate": "2020-10-12T20:10:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzOTIyMQ==", "url": "https://github.com/JabRef/jabref/pull/6989#discussion_r503539221", "bodyText": "Possible exception if fieldParts is empty? Can this happen", "author": "Siedlerchr", "createdAt": "2020-10-12T21:24:28Z", "path": "src/main/java/org/jabref/logic/citationkeypattern/BracketedPattern.java", "diffHunk": "@@ -172,6 +172,43 @@ public String expand(BibEntry bibentry, Character keywordDelimiter, BibDatabase\n     public static String expandBrackets(String pattern, Character keywordDelimiter, BibEntry entry, BibDatabase database) {\n         Objects.requireNonNull(pattern);\n         Objects.requireNonNull(entry);\n+        return expandBrackets(pattern, expandBracketContent(keywordDelimiter, entry, database));\n+    }\n+\n+    /**\n+     * Utility method creating a function taking the string representation of the content of a bracketed expression and\n+     * expanding it.\n+     *\n+     * @param keywordDelimiter The keyword delimiter to use\n+     * @param entry            The {@link BibEntry} to use for expansion\n+     * @param database         The {@link BibDatabase} for field resolving. May be null.\n+     * @return a function accepting a bracketed expression and returning the result of expanding it\n+     */\n+    private static Function<String, String> expandBracketContent(Character keywordDelimiter, BibEntry entry, BibDatabase database) {\n+        return (String bracket) -> {\n+            String expandedPattern;\n+            List<String> fieldParts = parseFieldAndModifiers(bracket);\n+            // check whether there is a modifier on the end such as\n+            // \":lower\":\n+            expandedPattern = getFieldValue(entry, fieldParts.get(0), keywordDelimiter, database);", "originalCommit": "c67128ccbd69550e5d4a3f4c6ceef04649e99440", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzU2ODI3OQ==", "url": "https://github.com/JabRef/jabref/pull/6989#discussion_r503568279", "bodyText": "It will be an exception if fieldsPart is empty, which cannot happen. current is a StringBuilder, so parseFieldAndModifiers should at least return a list containing one empty String.\n\n  \n    \n      jabref/src/main/java/org/jabref/logic/citationkeypattern/BracketedPattern.java\n    \n    \n        Lines 1130 to 1131\n      in\n      c67128c\n    \n    \n    \n    \n\n        \n          \n           parts.add(current.toString()); \n        \n\n        \n          \n           return parts; \n        \n    \n  \n\n\nNow that you have pointed it out though, it does make me nervous. I'll a test case since I do believe this is the correct behaviour, and I can't find a test for it (an empty bracketed expression []).", "author": "k3KAW8Pnf7mkmdSMPHz27", "createdAt": "2020-10-12T22:38:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUzOTIyMQ=="}], "type": "inlineReview"}, {"oid": "c8b59d528165de7152c1eac8b96b475137e5fcfd", "url": "https://github.com/JabRef/jabref/commit/c8b59d528165de7152c1eac8b96b475137e5fcfd", "message": "Add test case", "committedDate": "2020-10-12T22:37:07Z", "type": "commit"}]}