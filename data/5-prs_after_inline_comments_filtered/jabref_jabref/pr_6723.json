{"pr_number": 6723, "pr_title": "Delete link after download", "pr_createdAt": "2020-07-28T22:42:25Z", "pr_url": "https://github.com/JabRef/jabref/pull/6723", "timeline": [{"oid": "cc742593aeca6200550b0a2ddb02cf7da615bc5d", "url": "https://github.com/JabRef/jabref/commit/cc742593aeca6200550b0a2ddb02cf7da615bc5d", "message": "Delete link after download\n\nFixes #6588.", "committedDate": "2020-07-28T22:39:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzODI2OA==", "url": "https://github.com/JabRef/jabref/pull/6723#discussion_r462038268", "bodyText": "There is no ifPresent and orElse code here. - Can't we use int and -1? - This would be closer to the data model of linkedFiles.", "author": "koppor", "createdAt": "2020-07-29T04:57:07Z", "path": "src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java", "diffHunk": "@@ -427,7 +427,22 @@ public void download() {\n             BackgroundTask<Path> downloadTask = prepareDownloadTask(targetDirectory.get(), urlDownload);\n             downloadTask.onSuccess(destination -> {\n                 LinkedFile newLinkedFile = LinkedFilesEditorViewModel.fromFile(destination, databaseContext.getFileDirectoriesAsPaths(filePreferences), externalFileTypes);\n-                entry.addFile(0, newLinkedFile);\n+\n+                var linkedFiles = entry.getFiles();\n+                // The file type changes as part of download process (see prepareDownloadTask), thus we only compare by link\n+                Optional<Integer> oldFileIndex = Optional.empty();\n+                for (int i = 0; i < linkedFiles.size(); i++) {\n+                    LinkedFile file = linkedFiles.get(i);\n+                    if (file.getLink().equalsIgnoreCase(linkedFile.getLink())) {\n+                        oldFileIndex = Optional.of(i);\n+                    }\n+                }\n+                if (oldFileIndex.isPresent()) {", "originalCommit": "cc742593aeca6200550b0a2ddb02cf7da615bc5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzODY0NQ==", "url": "https://github.com/JabRef/jabref/pull/6723#discussion_r462038645", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            for (int i = 0; i < linkedFiles.size(); i++) {\n          \n          \n            \n                           int oldFileIndex = -1;\n          \n          \n            \n                            int i = 0;\n          \n          \n            \n                            while (i < linkedFiles.size() && oldFileIndex == -1) {", "author": "koppor", "createdAt": "2020-07-29T04:58:38Z", "path": "src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java", "diffHunk": "@@ -427,7 +427,22 @@ public void download() {\n             BackgroundTask<Path> downloadTask = prepareDownloadTask(targetDirectory.get(), urlDownload);\n             downloadTask.onSuccess(destination -> {\n                 LinkedFile newLinkedFile = LinkedFilesEditorViewModel.fromFile(destination, databaseContext.getFileDirectoriesAsPaths(filePreferences), externalFileTypes);\n-                entry.addFile(0, newLinkedFile);\n+\n+                var linkedFiles = entry.getFiles();\n+                // The file type changes as part of download process (see prepareDownloadTask), thus we only compare by link\n+                Optional<Integer> oldFileIndex = Optional.empty();\n+                for (int i = 0; i < linkedFiles.size(); i++) {", "originalCommit": "cc742593aeca6200550b0a2ddb02cf7da615bc5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjAzODcxMw==", "url": "https://github.com/JabRef/jabref/pull/6723#discussion_r462038713", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            }\n          \n          \n            \n                              i++;\n          \n          \n            \n                            }", "author": "koppor", "createdAt": "2020-07-29T04:58:51Z", "path": "src/main/java/org/jabref/gui/fieldeditors/LinkedFileViewModel.java", "diffHunk": "@@ -427,7 +427,22 @@ public void download() {\n             BackgroundTask<Path> downloadTask = prepareDownloadTask(targetDirectory.get(), urlDownload);\n             downloadTask.onSuccess(destination -> {\n                 LinkedFile newLinkedFile = LinkedFilesEditorViewModel.fromFile(destination, databaseContext.getFileDirectoriesAsPaths(filePreferences), externalFileTypes);\n-                entry.addFile(0, newLinkedFile);\n+\n+                var linkedFiles = entry.getFiles();\n+                // The file type changes as part of download process (see prepareDownloadTask), thus we only compare by link\n+                Optional<Integer> oldFileIndex = Optional.empty();\n+                for (int i = 0; i < linkedFiles.size(); i++) {\n+                    LinkedFile file = linkedFiles.get(i);\n+                    if (file.getLink().equalsIgnoreCase(linkedFile.getLink())) {\n+                        oldFileIndex = Optional.of(i);\n+                    }\n+                }", "originalCommit": "cc742593aeca6200550b0a2ddb02cf7da615bc5d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "516101f59dcaea7e771dca67e5ceb413e8afebd2", "url": "https://github.com/JabRef/jabref/commit/516101f59dcaea7e771dca67e5ceb413e8afebd2", "message": "Replace Optional by int and var by real type", "committedDate": "2020-08-01T16:12:20Z", "type": "commit"}]}