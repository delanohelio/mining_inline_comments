{"pr_number": 6746, "pr_title": "Fix entry gets deleted after aux import", "pr_createdAt": "2020-08-07T21:34:13Z", "pr_url": "https://github.com/JabRef/jabref/pull/6746", "timeline": [{"oid": "78855d34bf1788d32a5ed657b60a72bb7df21176", "url": "https://github.com/JabRef/jabref/commit/78855d34bf1788d32a5ed657b60a72bb7df21176", "message": "Fix entry gets deleted after aux import\n\nSet changed flag on clone also for Misc entry type, because otherwise it equals the default entry type and no change is triggered which results in the entry not beeing written to the database on save\nFixes  #6405\n\nSimplify gui code", "committedDate": "2020-08-07T21:33:48Z", "type": "commit"}, {"oid": "57822179bb5a8e6d1273eb42b4c0bf5f0143551c", "url": "https://github.com/JabRef/jabref/commit/57822179bb5a8e6d1273eb42b4c0bf5f0143551c", "message": "add changelog", "committedDate": "2020-08-07T21:36:59Z", "type": "commit"}, {"oid": "e7f21ff636614d5391de24314273341d5d2f1800", "url": "https://github.com/JabRef/jabref/commit/e7f21ff636614d5391de24314273341d5d2f1800", "message": "fix checkstyle shit", "committedDate": "2020-08-07T21:39:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NTk2MQ==", "url": "https://github.com/JabRef/jabref/pull/6746#discussion_r467295961", "bodyText": "I would doubt that this fixed the issue for the other types. -- When the entry type is Article, the clone is unchanged, too. Thus, no serialization written", "author": "koppor", "createdAt": "2020-08-07T21:50:37Z", "path": "src/main/java/org/jabref/model/entry/BibEntry.java", "diffHunk": "@@ -603,10 +604,15 @@ public boolean allFieldsPresent(Collection<OrFields> fields, BibDatabase databas\n     /**\n      * Returns a clone of this entry. Useful for copying.\n      * This will set a new ID for the cloned entry to be able to distinguish both copies.\n+     * Ensures that the changed flag is set when the entry type equals the default entry type Misc\n      */\n     @Override\n     public Object clone() {\n         BibEntry clone = new BibEntry(type.getValue());\n+        if (StandardEntryType.Misc.equals(type.getValue())) {\n+            clone.changed = true;", "originalCommit": "78855d34bf1788d32a5ed657b60a72bb7df21176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMjc1NA==", "url": "https://github.com/JabRef/jabref/pull/6746#discussion_r467312754", "bodyText": "New BibEntryType(entryType) always calls setType() and thus:\nThe default value for field.get is the default entry type misc.\n\n  \n    \n      jabref/src/main/java/org/jabref/model/entry/BibEntry.java\n    \n    \n        Lines 360 to 371\n      in\n      7cc5747\n    \n    \n    \n    \n\n        \n          \n           public Optional<FieldChange> setType(EntryType newType, EntriesEventSource eventSource) { \n        \n\n        \n          \n               Objects.requireNonNull(newType); \n        \n\n        \n          \n            \n        \n\n        \n          \n               EntryType oldType = type.get(); \n        \n\n        \n          \n               if (newType.equals(oldType)) { \n        \n\n        \n          \n                   return Optional.empty(); \n        \n\n        \n          \n               } \n        \n\n        \n          \n            \n        \n\n        \n          \n               changed = true; \n        \n\n        \n          \n               this.type.setValue(newType); \n        \n\n        \n          \n            \n        \n\n        \n          \n               FieldChange change = new FieldChange(this, InternalField.TYPE_HEADER, oldType.getName(), newType.getName());", "author": "Siedlerchr", "createdAt": "2020-08-07T22:29:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NTk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxMzQ3NQ==", "url": "https://github.com/JabRef/jabref/pull/6746#discussion_r467313475", "bodyText": "For all other non default entry types the change flat is correclty set that was what this issue made so special.", "author": "Siedlerchr", "createdAt": "2020-08-07T22:32:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NTk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzM4NzY2MQ==", "url": "https://github.com/JabRef/jabref/pull/6746#discussion_r467387661", "bodyText": "I wouldn't update the changed flag. The clone method should really clone the original entry, without any modifications (otherwise its not a clone).\nHowever, the aux importer should set the changed flag of all entries (regardless of type), so that they get properly reformatted when writing them to disc (i.e. not using the parsed serialization of the original bib file).", "author": "tobiasdiez", "createdAt": "2020-08-08T08:20:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NTk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzQ4MDc3Mg==", "url": "https://github.com/JabRef/jabref/pull/6746#discussion_r467480772", "bodyText": "Well, the clone method implicitly sets the changed flags for all entry types except the default entry type.\nThe aux importer has nothing to do with this changed or serialization stuff. It's only relevant for saving the newly created library.  I don't see any reason to add this logic to the AuxImporter\nOnly the BibTexParser does it.", "author": "Siedlerchr", "createdAt": "2020-08-08T16:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NTk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NjIyNw==", "url": "https://github.com/JabRef/jabref/pull/6746#discussion_r467296227", "bodyText": "Isn't it possible to clone the serializatio, too. Then, the issue should be fixed?", "author": "koppor", "createdAt": "2020-08-07T21:50:58Z", "path": "src/main/java/org/jabref/model/entry/BibEntry.java", "diffHunk": "@@ -603,10 +604,15 @@ public boolean allFieldsPresent(Collection<OrFields> fields, BibDatabase databas\n     /**\n      * Returns a clone of this entry. Useful for copying.\n      * This will set a new ID for the cloned entry to be able to distinguish both copies.\n+     * Ensures that the changed flag is set when the entry type equals the default entry type Misc\n      */\n     @Override\n     public Object clone() {\n         BibEntry clone = new BibEntry(type.getValue());\n+        if (StandardEntryType.Misc.equals(type.getValue())) {\n+            clone.changed = true;\n+        }\n+\n         clone.fields = FXCollections.observableMap(new ConcurrentHashMap<>(fields));\n         return clone;", "originalCommit": "78855d34bf1788d32a5ed657b60a72bb7df21176", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzMxNjExNQ==", "url": "https://github.com/JabRef/jabref/pull/6746#discussion_r467316115", "bodyText": "The issue is already fixed with the changed = true. But I added it as well now", "author": "Siedlerchr", "createdAt": "2020-08-07T22:43:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzI5NjIyNw=="}], "type": "inlineReview"}, {"oid": "dd4bd171eb2ef5d3001ac7aa4418bce3158798b3", "url": "https://github.com/JabRef/jabref/commit/dd4bd171eb2ef5d3001ac7aa4418bce3158798b3", "message": "copy serialization on clone", "committedDate": "2020-08-07T22:42:33Z", "type": "commit"}, {"oid": "576274863396224d5678ae1067ad9d320b0fc4a7", "url": "https://github.com/JabRef/jabref/commit/576274863396224d5678ae1067ad9d320b0fc4a7", "message": "Update CHANGELOG.md\n\nCo-authored-by: Tobias Diez <tobiasdiez@gmx.de>", "committedDate": "2020-08-08T16:25:48Z", "type": "commit"}, {"oid": "cddea1e96b58efb87f4dc97da11b0c258383a08f", "url": "https://github.com/JabRef/jabref/commit/cddea1e96b58efb87f4dc97da11b0c258383a08f", "message": "Merge branch 'master' into auximport", "committedDate": "2020-08-17T19:53:00Z", "type": "commit"}, {"oid": "43eb864af6acfec79ae0c6002c389cceaee49461", "url": "https://github.com/JabRef/jabref/commit/43eb864af6acfec79ae0c6002c389cceaee49461", "message": "Cosmetic change", "committedDate": "2020-08-17T20:01:06Z", "type": "commit"}, {"oid": "5def342b22ecc2777b4cc162b18b4bc0509041e7", "url": "https://github.com/JabRef/jabref/commit/5def342b22ecc2777b4cc162b18b4bc0509041e7", "message": "Fix clone", "committedDate": "2020-08-17T20:56:44Z", "type": "commit"}, {"oid": "48c574633fdca505ddf0b4266fde1017422089d4", "url": "https://github.com/JabRef/jabref/commit/48c574633fdca505ddf0b4266fde1017422089d4", "message": "Mark each entry changed to trigger a \"proper\" write by JabRef", "committedDate": "2020-08-17T21:18:57Z", "type": "commit"}]}