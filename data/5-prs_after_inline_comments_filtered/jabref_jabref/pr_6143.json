{"pr_number": 6143, "pr_title": "Add APS Fetcher (refactored)", "pr_createdAt": "2020-03-17T18:07:56Z", "pr_url": "https://github.com/JabRef/jabref/pull/6143", "timeline": [{"oid": "5ba23c741ce1eecad7690a69de1c8c99fefd5206", "url": "https://github.com/JabRef/jabref/commit/5ba23c741ce1eecad7690a69de1c8c99fefd5206", "message": "Add APS fetcher", "committedDate": "2020-02-26T16:45:30Z", "type": "commit"}, {"oid": "33d9e7e70aa9a0b998c98aa1ce5a1d22a48d6077", "url": "https://github.com/JabRef/jabref/commit/33d9e7e70aa9a0b998c98aa1ce5a1d22a48d6077", "message": "Fix case sensitivity bug", "committedDate": "2020-02-26T16:45:30Z", "type": "commit"}, {"oid": "b88570f41d2b756700a9aa9af347fa64737268f7", "url": "https://github.com/JabRef/jabref/commit/b88570f41d2b756700a9aa9af347fa64737268f7", "message": "Refactor ApsFetcher", "committedDate": "2020-02-26T16:45:30Z", "type": "commit"}, {"oid": "d4df8aae99e00bc1adaeefde56ff92f2f79eed87", "url": "https://github.com/JabRef/jabref/commit/d4df8aae99e00bc1adaeefde56ff92f2f79eed87", "message": "Add note about APS fetcher", "committedDate": "2020-02-26T16:52:36Z", "type": "commit"}, {"oid": "827434c16736f165d6f1873a1eb350b41e3849af", "url": "https://github.com/JabRef/jabref/commit/827434c16736f165d6f1873a1eb350b41e3849af", "message": "Refactor findFulltext()", "committedDate": "2020-02-27T10:43:54Z", "type": "commit"}, {"oid": "5ff30beb3926408fa20044cf6e67d75a099f7106", "url": "https://github.com/JabRef/jabref/commit/5ff30beb3926408fa20044cf6e67d75a099f7106", "message": "Refactor getId()", "committedDate": "2020-02-27T10:56:48Z", "type": "commit"}, {"oid": "5f11a5c4b27f4a34fba9ece9aef161c3ed3d47c0", "url": "https://github.com/JabRef/jabref/commit/5f11a5c4b27f4a34fba9ece9aef161c3ed3d47c0", "message": "Parameterize ApsFetcherTest", "committedDate": "2020-02-27T12:00:03Z", "type": "commit"}, {"oid": "7a855dc0fc28df6ac546ae289367522c47dad643", "url": "https://github.com/JabRef/jabref/commit/7a855dc0fc28df6ac546ae289367522c47dad643", "message": "Add link to APS changelog entry", "committedDate": "2020-02-27T12:00:18Z", "type": "commit"}, {"oid": "e1b7a4f865bc79030f978127580b6dac36c424f7", "url": "https://github.com/JabRef/jabref/commit/e1b7a4f865bc79030f978127580b6dac36c424f7", "message": "Merge branch 'aps-fetcher' of https://github.com/augustjanse/jabref into adsfetcher\n\n* 'aps-fetcher' of https://github.com/augustjanse/jabref:\n  Add link to APS changelog entry\n  Parameterize ApsFetcherTest\n  Refactor getId()\n  Refactor findFulltext()\n  Add note about APS fetcher\n  Refactor ApsFetcher\n  Fix case sensitivity bug\n  Add APS fetcher", "committedDate": "2020-03-17T17:19:39Z", "type": "commit"}, {"oid": "f6bd3b0fd41dba4105c08d5c789a8785c6a11d81", "url": "https://github.com/JabRef/jabref/commit/f6bd3b0fd41dba4105c08d5c789a8785c6a11d81", "message": "Refactor APS Fetcher", "committedDate": "2020-03-17T18:06:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5MDkzOQ==", "url": "https://github.com/JabRef/jabref/pull/6143#discussion_r393890939", "bodyText": "This should be debug or warn", "author": "tobiasdiez", "createdAt": "2020-03-17T18:36:40Z", "path": "src/main/java/org/jabref/logic/importer/fetcher/ApsFetcher.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.jabref.logic.importer.fetcher;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.jabref.logic.importer.FulltextFetcher;\n+import org.jabref.model.entry.BibEntry;\n+import org.jabref.model.entry.field.StandardField;\n+import org.jabref.model.entry.identifier.DOI;\n+\n+import kong.unirest.Unirest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * FulltextFetcher implementation that attempts to find a PDF URL at APS. Also see the <a\n+ * href=\"https://harvest.aps.org/docs/harvest-api\">API</a>, although it isn't currently used.\n+ */\n+public class ApsFetcher implements FulltextFetcher {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ApsFetcher.class);\n+\n+    // The actual API needs either an API key or a header. This is a workaround.\n+    private static final String DOI_URL = \"https://www.doi.org/\";\n+    private static final String PDF_URL = \"https://journals.aps.org/prl/pdf/\";\n+\n+    @Override\n+    public Optional<URL> findFullText(BibEntry entry) throws IOException {\n+        Objects.requireNonNull(entry);\n+\n+        Optional<DOI> doi = entry.getField(StandardField.DOI).flatMap(DOI::parse);\n+\n+        if (!doi.isPresent()) {\n+            return Optional.empty();\n+        }\n+\n+        Optional<String> id = getId(doi.get().getDOI());\n+\n+        if (id.isPresent()) {\n+\n+            String pdfRequestUrl = PDF_URL + id.get();\n+            int code = Unirest.head(pdfRequestUrl).asJson().getStatus();\n+\n+            if (code == 200) {\n+                LOGGER.info(\"Fulltext PDF found @ APS.\");\n+                try {\n+                    return Optional.of(new URL(pdfRequestUrl));\n+                } catch (MalformedURLException e) {\n+                    LOGGER.info(\"APS returned malformed URL, cannot find PDF.\");", "originalCommit": "f6bd3b0fd41dba4105c08d5c789a8785c6a11d81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5MTA2Mg==", "url": "https://github.com/JabRef/jabref/pull/6143#discussion_r393891062", "bodyText": "I guess debug level suffices", "author": "tobiasdiez", "createdAt": "2020-03-17T18:36:54Z", "path": "src/main/java/org/jabref/logic/importer/fetcher/ApsFetcher.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package org.jabref.logic.importer.fetcher;\n+\n+import java.io.IOException;\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.net.URLConnection;\n+import java.util.Objects;\n+import java.util.Optional;\n+\n+import org.jabref.logic.importer.FulltextFetcher;\n+import org.jabref.model.entry.BibEntry;\n+import org.jabref.model.entry.field.StandardField;\n+import org.jabref.model.entry.identifier.DOI;\n+\n+import kong.unirest.Unirest;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * FulltextFetcher implementation that attempts to find a PDF URL at APS. Also see the <a\n+ * href=\"https://harvest.aps.org/docs/harvest-api\">API</a>, although it isn't currently used.\n+ */\n+public class ApsFetcher implements FulltextFetcher {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ApsFetcher.class);\n+\n+    // The actual API needs either an API key or a header. This is a workaround.\n+    private static final String DOI_URL = \"https://www.doi.org/\";\n+    private static final String PDF_URL = \"https://journals.aps.org/prl/pdf/\";\n+\n+    @Override\n+    public Optional<URL> findFullText(BibEntry entry) throws IOException {\n+        Objects.requireNonNull(entry);\n+\n+        Optional<DOI> doi = entry.getField(StandardField.DOI).flatMap(DOI::parse);\n+\n+        if (!doi.isPresent()) {\n+            return Optional.empty();\n+        }\n+\n+        Optional<String> id = getId(doi.get().getDOI());\n+\n+        if (id.isPresent()) {\n+\n+            String pdfRequestUrl = PDF_URL + id.get();\n+            int code = Unirest.head(pdfRequestUrl).asJson().getStatus();\n+\n+            if (code == 200) {\n+                LOGGER.info(\"Fulltext PDF found @ APS.\");", "originalCommit": "f6bd3b0fd41dba4105c08d5c789a8785c6a11d81", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDUyMzE0OQ==", "url": "https://github.com/JabRef/jabref/pull/6143#discussion_r394523149", "bodyText": "It's info at the other fetchers as well", "author": "Siedlerchr", "createdAt": "2020-03-18T17:33:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5MTA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg5MzQ5MQ==", "url": "https://github.com/JabRef/jabref/pull/6143#discussion_r393893491", "bodyText": "To be honest, I don't see any need to have a parameterized test. As the comments indicate the tests actually check different cases and behaviours. It just happens that the test code is almost the same. Since the code reusage of the parameterized test is minimal, I would prefer if the tests could be split.", "author": "tobiasdiez", "createdAt": "2020-03-17T18:41:03Z", "path": "src/test/java/org/jabref/logic/importer/fetcher/ApsFetcherTest.java", "diffHunk": "@@ -0,0 +1,56 @@\n+package org.jabref.logic.importer.fetcher;\n+\n+import java.io.IOException;\n+import java.net.URL;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import org.jabref.model.entry.BibEntry;\n+import org.jabref.model.entry.field.StandardField;\n+import org.jabref.testutils.category.FetcherTest;\n+\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.Arguments;\n+import org.junit.jupiter.params.provider.MethodSource;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+@FetcherTest\n+class ApsFetcherTest {\n+\n+    private ApsFetcher finder;\n+\n+    @BeforeEach\n+    void setUp() {\n+        finder = new ApsFetcher();\n+    }\n+\n+    private static Stream<Arguments> provideBibEntriesWithDois() throws IOException {", "originalCommit": "f6bd3b0fd41dba4105c08d5c789a8785c6a11d81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "30063369b144c88bbad62787e7c7368066f30c5a", "url": "https://github.com/JabRef/jabref/commit/30063369b144c88bbad62787e7c7368066f30c5a", "message": "Merge remote-tracking branch 'upstream/master' into adsfetcher\n\n* upstream/master:\n  Squashed 'src/main/resources/csl-styles/' changes from 268df9ebc7..db8bd334bd", "committedDate": "2020-03-18T11:30:42Z", "type": "commit"}, {"oid": "c06781e426bffe0f8d87d945f6585a66409eef7a", "url": "https://github.com/JabRef/jabref/commit/c06781e426bffe0f8d87d945f6585a66409eef7a", "message": "Merge remote-tracking branch 'upstream/master' into adsfetcher\n\n* upstream/master:\n  trigger build", "committedDate": "2020-03-18T17:30:44Z", "type": "commit"}, {"oid": "d6299b0c11bcd746e2c4198107cc2d820659b548", "url": "https://github.com/JabRef/jabref/commit/d6299b0c11bcd746e2c4198107cc2d820659b548", "message": "make separate tests", "committedDate": "2020-03-18T17:52:42Z", "type": "commit"}]}