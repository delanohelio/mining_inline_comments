{"pr_number": 2666, "pr_title": "Solved XSS false positive issue", "pr_createdAt": "2020-12-20T09:03:12Z", "pr_url": "https://github.com/zaproxy/zap-extensions/pull/2666", "timeline": [{"oid": "e50dd58c307b04aa1022665a3f0f48b9e0ef805e", "url": "https://github.com/zaproxy/zap-extensions/commit/e50dd58c307b04aa1022665a3f0f48b9e0ef805e", "message": "Solved XSS false positive issue\n\nSigned-off-by: Aman Rawat <rawataman6525@gmail.com>", "committedDate": "2020-12-20T09:12:34Z", "type": "forcePushed"}, {"oid": "5b43499114dc775ea9136294cda628f10bbab77f", "url": "https://github.com/zaproxy/zap-extensions/commit/5b43499114dc775ea9136294cda628f10bbab77f", "message": "Solved XSS false positive\n\nSigned-off-by: Aman Rawat <rawataman6525@gmail.com>", "committedDate": "2021-03-15T12:46:27Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r599426864", "bodyText": "The size check is redundant here.\nThis will lead to more alerts being raised than before (assuming more than one context) and always with the details of the first context. Do you meant to add a break?", "author": "thc202", "createdAt": "2021-03-23T10:03:03Z", "path": "addOns/ascanrules/src/main/java/org/zaproxy/zap/extension/ascanrules/CrossSiteScriptingScanRule.java", "diffHunk": "@@ -588,16 +588,18 @@ public void scan(HttpMessage msg, String param, String value) {\n                             if (contexts2 == null) {\n                                 return;\n                             }\n-                            if (contexts2.size() > 0) {\n-                                // Yep, its vulnerable\n-                                newAlert()\n-                                        .setConfidence(Alert.CONFIDENCE_MEDIUM)\n-                                        .setParam(param)\n-                                        .setAttack(contexts2.get(0).getTarget())\n-                                        .setEvidence(contexts2.get(0).getTarget())\n-                                        .setMessage(contexts2.get(0).getMsg())\n-                                        .raise();\n-                                attackWorked = true;\n+                            for (HtmlContext ctx : contexts2) {\n+                                if (contexts2.size() > 0 && ctx.getSurroundingQuote().isEmpty()) {", "originalCommit": "2dbe4afb8616c1c39e82ab9874aa18296d3c9904", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTEyMzc5Nw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r601123797", "bodyText": "Now I added size check before the for loop. I think this will not raise more alerts if there are more than one context.", "author": "theamanrawat", "createdAt": "2021-03-25T07:05:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTgwNjIxNg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r601806216", "bodyText": "It will still raise them, it would have to break the loop to just raise once (technically the size check is no longer needed with the use of the loop).", "author": "thc202", "createdAt": "2021-03-25T20:09:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMTgwNjY5Mg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r601806692", "bodyText": "Also, worth trying to add a test for this case.", "author": "thc202", "createdAt": "2021-03-25T20:10:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjM1Njc2Mw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602356763", "bodyText": "Here context is the reflection of payload in HTML right?", "author": "theamanrawat", "createdAt": "2021-03-26T14:52:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjM2NDE5Mg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602364192", "bodyText": "Yeah.", "author": "thc202", "createdAt": "2021-03-26T15:01:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjM3MTk0Ng==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602371946", "bodyText": "With or without size check,  It will not give multiple alerts even If there are more than one context. However size check is not required so I will remove it.", "author": "theamanrawat", "createdAt": "2021-03-26T15:12:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjM3ODgyMA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602378820", "bodyText": "You mean with contexts2 having size more than 1?", "author": "thc202", "createdAt": "2021-03-26T15:19:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjM4MDEwNg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602380106", "bodyText": "Yes.", "author": "theamanrawat", "createdAt": "2021-03-26T15:21:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjM5MTEzMw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602391133", "bodyText": "And both having no surrounding quote?", "author": "thc202", "createdAt": "2021-03-26T15:35:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQwNDM4MA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602404380", "bodyText": "Yeah.", "author": "theamanrawat", "createdAt": "2021-03-26T15:53:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYwMjQxODc2Mw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r602418763", "bodyText": "So, the break was added, that makes more sense.", "author": "thc202", "createdAt": "2021-03-26T16:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5OTQyNjg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTAyNDM1OQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r615024359", "bodyText": "One \u2192 Once?\nContext \u2192 Contexts", "author": "thc202", "createdAt": "2021-04-16T17:47:55Z", "path": "addOns/ascanrules/src/test/java/org/zaproxy/zap/extension/ascanrules/CrossSiteScriptingScanRuleUnitTest.java", "diffHunk": "@@ -1183,6 +1183,69 @@ protected Response serve(IHTTPSession session) {\n         assertThat(alertsRaised.get(0).getConfidence(), equalTo(Alert.CONFIDENCE_MEDIUM));\n     }\n \n+    @Test\n+    public void shouldNotAlertXssInJsVariableWithEncoding() throws HttpMalformedHeaderException {\n+        // Given\n+        String path = \"/user/search\";\n+        this.nano.addHandler(\n+                new NanoServerHandler(path) {\n+\n+                    @Override\n+                    protected Response serve(IHTTPSession session) {\n+                        String name = getFirstParamValue(session, \"name\");\n+                        String response;\n+                        if (name != null) {\n+                            name = name.replaceAll(\"\\\"\", \"&quot;\");\n+                            response =\n+                                    getHtml(\"InputInScript.html\", new String[][] {{\"name\", name}});\n+                        } else {\n+                            response = getHtml(\"NoInput.html\");\n+                        }\n+                        return newFixedLengthResponse(response);\n+                    }\n+                });\n+\n+        HttpMessage msg = this.getHttpMessage(path + \"?name=test\");\n+        this.rule.init(msg, this.parent);\n+\n+        // When\n+        this.rule.scan();\n+\n+        // Then\n+        assertThat(alertsRaised.size(), equalTo(0));\n+    }\n+\n+    @Test\n+    public void shouldAlertOneWithMultipleContext() throws HttpMalformedHeaderException {", "originalCommit": "6048e65e0863b0bf405d29628f34d4a818d29dcd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3d90da54db5deae29c96a89d1980cd8047529d42", "url": "https://github.com/zaproxy/zap-extensions/commit/3d90da54db5deae29c96a89d1980cd8047529d42", "message": "Solved XSS false positive\n\nSigned-off-by: Aman Rawat <rawataman6525@gmail.com>", "committedDate": "2021-04-17T11:44:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI0OTMxNA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r615249314", "bodyText": "Since this is looping through a list shouldn\u2019t ctx be used instead of the zero\u2019th element?", "author": "kingthorin", "createdAt": "2021-04-17T12:25:27Z", "path": "addOns/ascanrules/src/main/java/org/zaproxy/zap/extension/ascanrules/CrossSiteScriptingScanRule.java", "diffHunk": "@@ -588,16 +588,19 @@ public void scan(HttpMessage msg, String param, String value) {\n                             if (contexts2 == null) {\n                                 return;\n                             }\n-                            if (contexts2.size() > 0) {\n-                                // Yep, its vulnerable\n-                                newAlert()\n-                                        .setConfidence(Alert.CONFIDENCE_MEDIUM)\n-                                        .setParam(param)\n-                                        .setAttack(contexts2.get(0).getTarget())\n-                                        .setEvidence(contexts2.get(0).getTarget())\n-                                        .setMessage(contexts2.get(0).getMsg())\n-                                        .raise();\n-                                attackWorked = true;\n+                            for (HtmlContext ctx : contexts2) {\n+                                if (ctx.getSurroundingQuote().isEmpty()) {\n+                                    // Yep, its vulnerable\n+                                    newAlert()\n+                                            .setConfidence(Alert.CONFIDENCE_MEDIUM)\n+                                            .setParam(param)\n+                                            .setAttack(contexts2.get(0).getTarget())\n+                                            .setEvidence(contexts2.get(0).getTarget())\n+                                            .setMessage(contexts2.get(0).getMsg())", "originalCommit": "3d90da54db5deae29c96a89d1980cd8047529d42", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI1NDEzOQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r615254139", "bodyText": "Good catch.", "author": "thc202", "createdAt": "2021-04-17T13:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI0OTMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI2NDI0MQ==", "url": "https://github.com/zaproxy/zap-extensions/pull/2666#discussion_r615264241", "bodyText": "The target is the same for all contexts (since the attack is the same). Although for correctness better use ctx, will push that change.", "author": "thc202", "createdAt": "2021-04-17T14:52:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYxNTI0OTMxNA=="}], "type": "inlineReview"}, {"oid": "e5ee576f07d8f0d1b092c815db45f4ef087566c8", "url": "https://github.com/zaproxy/zap-extensions/commit/e5ee576f07d8f0d1b092c815db45f4ef087566c8", "message": "Solved XSS false positive\n\nSigned-off-by: Aman Rawat <rawataman6525@gmail.com>", "committedDate": "2021-04-17T15:11:44Z", "type": "commit"}, {"oid": "e5ee576f07d8f0d1b092c815db45f4ef087566c8", "url": "https://github.com/zaproxy/zap-extensions/commit/e5ee576f07d8f0d1b092c815db45f4ef087566c8", "message": "Solved XSS false positive\n\nSigned-off-by: Aman Rawat <rawataman6525@gmail.com>", "committedDate": "2021-04-17T15:11:44Z", "type": "forcePushed"}]}