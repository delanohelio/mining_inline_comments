{"pr_number": 2637, "pr_title": "SOAP: Various updates", "pr_createdAt": "2020-11-30T14:11:44Z", "pr_url": "https://github.com/zaproxy/zap-extensions/pull/2637", "timeline": [{"oid": "d389dd20bbf9fdfae33bcf140032c57b7a99d09c", "url": "https://github.com/zaproxy/zap-extensions/commit/d389dd20bbf9fdfae33bcf140032c57b7a99d09c", "message": "Various updates\n\n- Enable XML Injection Active Scan Rule to work without the stored\nconfigs.\n- Add support for SOAP version 1.2 to the Action Spoofing Scan Rule.\n- Distinguish alerts by adding the SOAP version to the \"Other Info\"\nsection.\n- Persist the SOAP actions in the database.\n- Before, the message passed to\n`ImportWSDL#getSourceSoapActions(HttpMessage)` did not need to contain\n a SOAP action. It was compared with the stored messages to find the\n  WSDL that had generated it. Now,\n  `TableWsdl#getSourceSoapActions(String)` requires a SOAP action string\n   that is used for comparisons. This shouldn't be a problem however,\n   because,\n    - all version 1 SOAP messages contain a SOAPAction header; and\n    - if the action is omitted in a version 2 message, an empty string\n    is used.\n- Add new classes `TableWsdl` and `SoapAction`. Remove `ImportWSDL`.\n- Many unit tests were removed (for methods that are no longer used),\nsome were added.\n- Cosmetic Changes as suggested by my IDE and other code readability\nimprovements.\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-11-30T14:35:24Z", "type": "forcePushed"}, {"oid": "fc65a8180c7de73399ff719ae760aad284cdfb0f", "url": "https://github.com/zaproxy/zap-extensions/commit/fc65a8180c7de73399ff719ae760aad284cdfb0f", "message": "Various updates\n\n- Enable XML Injection Active Scan Rule to work without the stored\nconfigs.\n- Add support for SOAP version 1.2 to the Action Spoofing Scan Rule.\n- Distinguish alerts by adding the SOAP version to the \"Other Info\"\nsection.\n- Persist the SOAP actions in the database.\n- Before, the message passed to\n`ImportWSDL#getSourceSoapActions(HttpMessage)` did not need to contain\n a SOAP action. It was compared with the stored messages to find the\n  WSDL that had generated it. Now,\n  `TableWsdl#getSourceSoapActions(String)` requires a SOAP action string\n   that is used for comparisons. This shouldn't be a problem however,\n   because,\n    - all version 1 SOAP messages contain a SOAPAction header; and\n    - if the action is omitted in a version 2 message, an empty string\n    is used.\n- Add new classes `TableWsdl` and `SoapAction`. Remove `ImportWSDL`.\n- Many unit tests were removed (for methods that are no longer used),\nsome were added.\n- Cosmetic Changes as suggested by my IDE and other code readability\nimprovements.\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-11-30T15:56:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTA2Nw==", "url": "https://github.com/zaproxy/zap-extensions/pull/2637#discussion_r543511067", "bodyText": "The type could be removed (same in other lambdas).", "author": "thc202", "createdAt": "2020-12-15T16:49:13Z", "path": "addOns/soap/src/main/java/org/zaproxy/zap/extension/soap/ExtensionImportWSDL.java", "diffHunk": "@@ -120,25 +132,20 @@ private ZapMenuItem getMenuImportLocalWSDL() {\n                     Constant.messages.getString(\"soap.topmenu.import.importWSDL.tooltip\"));\n \n             menuImportLocalWSDL.addActionListener(\n-                    new java.awt.event.ActionListener() {\n-                        @Override\n-                        public void actionPerformed(java.awt.event.ActionEvent e) {\n-                            // Prompt for a WSDL file.\n-                            final JFileChooser chooser =\n-                                    new JFileChooser(\n-                                            Model.getSingleton()\n-                                                    .getOptionsParam()\n-                                                    .getUserDirectory());\n-                            FileNameExtensionFilter filter =\n-                                    new FileNameExtensionFilter(\n-                                            Constant.messages.getString(\n-                                                    \"soap.topmenu.import.importWSDL.filter.description\"),\n-                                            \"wsdl\");\n-                            chooser.setFileFilter(filter);\n-                            int rc = chooser.showOpenDialog(View.getSingleton().getMainFrame());\n-                            if (rc == JFileChooser.APPROVE_OPTION) {\n-                                fileUrlWSDLImport(chooser.getSelectedFile());\n-                            }\n+                    (java.awt.event.ActionEvent e) -> {", "originalCommit": "fc65a8180c7de73399ff719ae760aad284cdfb0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTE0Mg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2637#discussion_r543511142", "bodyText": "Could be completely removed.", "author": "thc202", "createdAt": "2020-12-15T16:49:18Z", "path": "addOns/soap/src/main/java/org/zaproxy/zap/extension/soap/SOAPActionSpoofingActiveScanRule.java", "diffHunk": "@@ -73,91 +80,116 @@ public String getReference() {\n         return Constant.messages.getString(MESSAGE_PREFIX + \"refs\");\n     }\n \n+    private TableWsdl getTable() {\n+        return Control.getSingleton()\n+                .getExtensionLoader()\n+                .getExtension(ExtensionImportWSDL.class)\n+                .getTable();\n+    }\n+\n     @Override\n     public int getCategory() {\n         return Category.MISC;\n     }\n \n-    /*\n-     * This method is called by the active scanner for each GET and POST parameter\n-     * for every page\n-     *\n-     * @see\n-     * org.parosproxy.paros.core.scanner.AbstractAppParamPlugin#scan(org.parosproxy.\n-     * paros.network.HttpMessage, java.lang.String, java.lang.String)\n+    /**\n+     * This method is called by the active scanner for each GET and POST parameter for every page.", "originalCommit": "fc65a8180c7de73399ff719ae760aad284cdfb0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTIwOA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2637#discussion_r543511208", "bodyText": "Stopping scan. \u2192 Ignoring message.", "author": "thc202", "createdAt": "2020-12-15T16:49:22Z", "path": "addOns/soap/src/main/java/org/zaproxy/zap/extension/soap/SOAPActionSpoofingActiveScanRule.java", "diffHunk": "@@ -73,91 +80,116 @@ public String getReference() {\n         return Constant.messages.getString(MESSAGE_PREFIX + \"refs\");\n     }\n \n+    private TableWsdl getTable() {\n+        return Control.getSingleton()\n+                .getExtensionLoader()\n+                .getExtension(ExtensionImportWSDL.class)\n+                .getTable();\n+    }\n+\n     @Override\n     public int getCategory() {\n         return Category.MISC;\n     }\n \n-    /*\n-     * This method is called by the active scanner for each GET and POST parameter\n-     * for every page\n-     *\n-     * @see\n-     * org.parosproxy.paros.core.scanner.AbstractAppParamPlugin#scan(org.parosproxy.\n-     * paros.network.HttpMessage, java.lang.String, java.lang.String)\n+    /**\n+     * This method is called by the active scanner for each GET and POST parameter for every page.\n      */\n     @Override\n     public void scan() {\n-        try {\n-            /* Retrieves the original request-response pair. */\n-            final HttpMessage originalMsg = getBaseMsg();\n-            /* This scan is only applied to SOAP 1.1 messages. */\n-            String currentHeader = originalMsg.getRequestHeader().getHeader(\"SOAPAction\");\n-            if (currentHeader != null && originalMsg.getRequestBody().length() > 0) {\n-                currentHeader = currentHeader.trim();\n-                /* Retrieves available actions to try attacks. */\n-                String[] soapActions = ImportWSDL.getInstance().getSourceSoapActions(originalMsg);\n+        /* Retrieves the original request-response pair. */\n+        final HttpMessage originalMsg = getBaseMsg();\n+        String originalSoapAction = SoapAction.extractFrom(originalMsg);\n+        if (originalSoapAction == null) {\n+            // Not a SOAP message\n+            return;\n+        }\n \n-                boolean endScan = false;\n-                if (soapActions == null || soapActions.length == 0) {\n-                    // No actions to spoof\n-                    LOG.info(\n-                            \"Skipping \"\n-                                    + getName()\n-                                    + \" because no actions were found. (URL: \"\n-                                    + originalMsg.getRequestHeader().getURI().toString()\n-                                    + \")\");\n-                    return;\n+        /* Retrieves available actions to try attacks. */\n+        List<SoapAction> soapActions;\n+        try {\n+            soapActions = getTable().getSourceSoapActions(originalSoapAction);\n+        } catch (DatabaseException e) {\n+            LOG.warn(\"Could not retrieve SOAP actions from the database. Stopping scan.\", e);", "originalCommit": "fc65a8180c7de73399ff719ae760aad284cdfb0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTM5MA==", "url": "https://github.com/zaproxy/zap-extensions/pull/2637#discussion_r543511390", "bodyText": "I'd suggest using other word than \"skip\" (maybe ignore like above?), the active scan allows to skip scan rules, which means that no other message would be scanned (which is not the case here, just this one that's not going to be scanned).", "author": "thc202", "createdAt": "2020-12-15T16:49:33Z", "path": "addOns/soap/src/main/java/org/zaproxy/zap/extension/soap/SOAPActionSpoofingActiveScanRule.java", "diffHunk": "@@ -73,91 +80,116 @@ public String getReference() {\n         return Constant.messages.getString(MESSAGE_PREFIX + \"refs\");\n     }\n \n+    private TableWsdl getTable() {\n+        return Control.getSingleton()\n+                .getExtensionLoader()\n+                .getExtension(ExtensionImportWSDL.class)\n+                .getTable();\n+    }\n+\n     @Override\n     public int getCategory() {\n         return Category.MISC;\n     }\n \n-    /*\n-     * This method is called by the active scanner for each GET and POST parameter\n-     * for every page\n-     *\n-     * @see\n-     * org.parosproxy.paros.core.scanner.AbstractAppParamPlugin#scan(org.parosproxy.\n-     * paros.network.HttpMessage, java.lang.String, java.lang.String)\n+    /**\n+     * This method is called by the active scanner for each GET and POST parameter for every page.\n      */\n     @Override\n     public void scan() {\n-        try {\n-            /* Retrieves the original request-response pair. */\n-            final HttpMessage originalMsg = getBaseMsg();\n-            /* This scan is only applied to SOAP 1.1 messages. */\n-            String currentHeader = originalMsg.getRequestHeader().getHeader(\"SOAPAction\");\n-            if (currentHeader != null && originalMsg.getRequestBody().length() > 0) {\n-                currentHeader = currentHeader.trim();\n-                /* Retrieves available actions to try attacks. */\n-                String[] soapActions = ImportWSDL.getInstance().getSourceSoapActions(originalMsg);\n+        /* Retrieves the original request-response pair. */\n+        final HttpMessage originalMsg = getBaseMsg();\n+        String originalSoapAction = SoapAction.extractFrom(originalMsg);\n+        if (originalSoapAction == null) {\n+            // Not a SOAP message\n+            return;\n+        }\n \n-                boolean endScan = false;\n-                if (soapActions == null || soapActions.length == 0) {\n-                    // No actions to spoof\n-                    LOG.info(\n-                            \"Skipping \"\n-                                    + getName()\n-                                    + \" because no actions were found. (URL: \"\n-                                    + originalMsg.getRequestHeader().getURI().toString()\n-                                    + \")\");\n-                    return;\n+        /* Retrieves available actions to try attacks. */\n+        List<SoapAction> soapActions;\n+        try {\n+            soapActions = getTable().getSourceSoapActions(originalSoapAction);\n+        } catch (DatabaseException e) {\n+            LOG.warn(\"Could not retrieve SOAP actions from the database. Stopping scan.\", e);\n+            return;\n+        }\n+        if (soapActions == null || soapActions.isEmpty()) {\n+            // No actions to spoof\n+            LOG.info(\n+                    \"Skipping \"", "originalCommit": "fc65a8180c7de73399ff719ae760aad284cdfb0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUxMTkwMg==", "url": "https://github.com/zaproxy/zap-extensions/pull/2637#discussion_r543511902", "bodyText": "Ideally this should be in the Messages file.", "author": "thc202", "createdAt": "2020-12-15T16:50:06Z", "path": "addOns/soap/src/main/java/org/zaproxy/zap/extension/soap/SOAPActionSpoofingActiveScanRule.java", "diffHunk": "@@ -73,91 +80,116 @@ public String getReference() {\n         return Constant.messages.getString(MESSAGE_PREFIX + \"refs\");\n     }\n \n+    private TableWsdl getTable() {\n+        return Control.getSingleton()\n+                .getExtensionLoader()\n+                .getExtension(ExtensionImportWSDL.class)\n+                .getTable();\n+    }\n+\n     @Override\n     public int getCategory() {\n         return Category.MISC;\n     }\n \n-    /*\n-     * This method is called by the active scanner for each GET and POST parameter\n-     * for every page\n-     *\n-     * @see\n-     * org.parosproxy.paros.core.scanner.AbstractAppParamPlugin#scan(org.parosproxy.\n-     * paros.network.HttpMessage, java.lang.String, java.lang.String)\n+    /**\n+     * This method is called by the active scanner for each GET and POST parameter for every page.\n      */\n     @Override\n     public void scan() {\n-        try {\n-            /* Retrieves the original request-response pair. */\n-            final HttpMessage originalMsg = getBaseMsg();\n-            /* This scan is only applied to SOAP 1.1 messages. */\n-            String currentHeader = originalMsg.getRequestHeader().getHeader(\"SOAPAction\");\n-            if (currentHeader != null && originalMsg.getRequestBody().length() > 0) {\n-                currentHeader = currentHeader.trim();\n-                /* Retrieves available actions to try attacks. */\n-                String[] soapActions = ImportWSDL.getInstance().getSourceSoapActions(originalMsg);\n+        /* Retrieves the original request-response pair. */\n+        final HttpMessage originalMsg = getBaseMsg();\n+        String originalSoapAction = SoapAction.extractFrom(originalMsg);\n+        if (originalSoapAction == null) {\n+            // Not a SOAP message\n+            return;\n+        }\n \n-                boolean endScan = false;\n-                if (soapActions == null || soapActions.length == 0) {\n-                    // No actions to spoof\n-                    LOG.info(\n-                            \"Skipping \"\n-                                    + getName()\n-                                    + \" because no actions were found. (URL: \"\n-                                    + originalMsg.getRequestHeader().getURI().toString()\n-                                    + \")\");\n-                    return;\n+        /* Retrieves available actions to try attacks. */\n+        List<SoapAction> soapActions;\n+        try {\n+            soapActions = getTable().getSourceSoapActions(originalSoapAction);\n+        } catch (DatabaseException e) {\n+            LOG.warn(\"Could not retrieve SOAP actions from the database. Stopping scan.\", e);\n+            return;\n+        }\n+        if (soapActions == null || soapActions.isEmpty()) {\n+            // No actions to spoof\n+            LOG.info(\n+                    \"Skipping \"\n+                            + getName()\n+                            + \" because no actions were found. (URL: \"\n+                            + originalMsg.getRequestHeader().getURI().toString()\n+                            + \")\");\n+            return;\n+        }\n+        for (SoapAction soapAction : soapActions) {\n+            if (isStop()) {\n+                return;\n+            }\n+            HttpMessage msg = getNewMsg();\n+            /* Skips the original case. */\n+            if (originalSoapAction.trim().equals(soapAction.getAction())) {\n+                if (LOG.isDebugEnabled()) {\n+                    LOG.debug(\n+                            \"Ignoring matching actions: \"\n+                                    + originalSoapAction\n+                                    + \" : \"\n+                                    + soapAction.getAction());\n                 }\n-                for (int j = 0; j < soapActions.length && !endScan; j++) {\n-                    HttpMessage msg = getNewMsg();\n-                    /* Skips the original case. */\n-                    if (!currentHeader.equals(soapActions[j])) {\n-                        HttpRequestHeader header = msg.getRequestHeader();\n-                        /* Available actions should be known here from the imported WSDL file. */\n-                        header.setHeader(\"SOAPAction\", soapActions[j]);\n-                        msg.setRequestHeader(header);\n-\n-                        /* Sends the modified request. */\n-                        if (this.isStop()) return;\n-                        sendAndReceive(msg);\n-                        if (this.isStop()) return;\n+                continue;\n+            }\n+            HttpRequestHeader header = msg.getRequestHeader();\n+            boolean isSoapVersionOne = false;\n+            /* Available actions should be known here from the imported WSDL file. */\n+            if (originalMsg.getRequestHeader().getHeader(\"SOAPAction\") != null) {\n+                header.setHeader(\"SOAPAction\", soapAction.getAction());\n+                isSoapVersionOne = true;\n+            } else {\n+                header.setHeader(\n+                        HttpHeader.CONTENT_TYPE,\n+                        \"application/soap+xml;charset=UTF-8;action=\" + soapAction.getAction());\n+            }\n \n-                        /* Checks the response. */\n-                        int code = scanResponse(msg, originalMsg);\n-                        if (code > 0) endScan = true;\n-                        raiseAlert(msg, code);\n-                    } else {\n-                        if (LOG.isDebugEnabled()) {\n-                            LOG.debug(\n-                                    \"Ignoring matching actions: \"\n-                                            + currentHeader\n-                                            + \" : \"\n-                                            + soapActions[j]);\n-                        }\n-                    }\n-                    if (this.isStop()) return;\n-                }\n+            /* Sends the modified request. */\n+            try {\n+                sendAndReceive(msg);\n+            } catch (IOException e) {\n+                LOG.warn(\"Could not send modified SOAP request.\");\n+                return;\n+            }\n+            /* Checks the response. */\n+            ResponseType code = scanResponse(msg, originalMsg);\n+            String otherAlertInfo =", "originalCommit": "fc65a8180c7de73399ff719ae760aad284cdfb0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aca68bce2c7b80ae8c8ac729a7e2a3842926d286", "url": "https://github.com/zaproxy/zap-extensions/commit/aca68bce2c7b80ae8c8ac729a7e2a3842926d286", "message": "Various updates\n\n- Enable XML Injection Active Scan Rule to work without the stored\nconfigs.\n- Add support for SOAP version 1.2 to the Action Spoofing Scan Rule.\n- Distinguish alerts by adding the SOAP version to the \"Other Info\"\nsection.\n- Persist the SOAP actions in the database.\n- Before, the message passed to\n`ImportWSDL#getSourceSoapActions(HttpMessage)` did not need to contain\n a SOAP action. It was compared with the stored messages to find the\n  WSDL that had generated it. Now,\n  `TableWsdl#getSourceSoapActions(String)` requires a SOAP action string\n   that is used for comparisons. This shouldn't be a problem however,\n   because,\n    - all version 1 SOAP messages contain a SOAPAction header; and\n    - if the action is omitted in a version 2 message, an empty string\n    is used.\n- Add new classes `TableWsdl` and `SoapAction`. Remove `ImportWSDL`.\n- Many unit tests were removed (for methods that are no longer used),\nsome were added.\n- Cosmetic Changes as suggested by my IDE and other code readability\nimprovements.\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-12-15T20:25:28Z", "type": "forcePushed"}, {"oid": "c422314867a3e4e2870f0e2d9e4fd981864f234f", "url": "https://github.com/zaproxy/zap-extensions/commit/c422314867a3e4e2870f0e2d9e4fd981864f234f", "message": "SOAP: Various updates\n\n- Enable XML Injection Active Scan Rule to work without the stored\nconfigs.\n- Add support for SOAP version 1.2 to the Action Spoofing Scan Rule.\n- Distinguish alerts by adding the SOAP version to the \"Other Info\"\nsection.\n- Persist the SOAP actions in the database.\n- Before, the message passed to\n`ImportWSDL#getSourceSoapActions(HttpMessage)` did not need to contain\n a SOAP action. It was compared with the stored messages to find the\n  WSDL that had generated it. Now,\n  `TableWsdl#getSourceSoapActions(String)` requires a SOAP action string\n   that is used for comparisons. This shouldn't be a problem however,\n   because,\n    - all version 1 SOAP messages contain a SOAPAction header; and\n    - if the action is omitted in a version 2 message, an empty string\n    is used.\n- Add new classes `TableWsdl` and `SoapAction`. Remove `ImportWSDL`.\n- Many unit tests were removed (for methods that are no longer used),\nsome were added.\n- Cosmetic Changes as suggested by my IDE and other code readability\nimprovements.\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-12-15T20:31:05Z", "type": "forcePushed"}, {"oid": "cff48c0e9c7c94df1d7ab87c1d82a63b35c32365", "url": "https://github.com/zaproxy/zap-extensions/commit/cff48c0e9c7c94df1d7ab87c1d82a63b35c32365", "message": "SOAP: Various updates\n\n- Enable XML Injection Active Scan Rule to work without the stored\nconfigs.\n- Add support for SOAP version 1.2 to the Action Spoofing Scan Rule.\n- Distinguish alerts by adding the SOAP version to the \"Other Info\"\nsection.\n- Persist the SOAP actions in the database.\n- Before, the message passed to\n`ImportWSDL#getSourceSoapActions(HttpMessage)` did not need to contain\n a SOAP action. It was compared with the stored messages to find the\n  WSDL that had generated it. Now,\n  `TableWsdl#getSourceSoapActions(String)` requires a SOAP action string\n   that is used for comparisons. This shouldn't be a problem however,\n   because,\n    - all version 1 SOAP messages contain a SOAPAction header; and\n    - if the action is omitted in a version 2 message, an empty string\n    is used.\n- Add new classes `TableWsdl` and `SoapAction`. Remove `ImportWSDL`.\n- Many unit tests were removed (for methods that are no longer used),\nsome were added.\n- Cosmetic Changes as suggested by my IDE and other code readability\nimprovements.\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-12-15T20:36:52Z", "type": "commit"}, {"oid": "cff48c0e9c7c94df1d7ab87c1d82a63b35c32365", "url": "https://github.com/zaproxy/zap-extensions/commit/cff48c0e9c7c94df1d7ab87c1d82a63b35c32365", "message": "SOAP: Various updates\n\n- Enable XML Injection Active Scan Rule to work without the stored\nconfigs.\n- Add support for SOAP version 1.2 to the Action Spoofing Scan Rule.\n- Distinguish alerts by adding the SOAP version to the \"Other Info\"\nsection.\n- Persist the SOAP actions in the database.\n- Before, the message passed to\n`ImportWSDL#getSourceSoapActions(HttpMessage)` did not need to contain\n a SOAP action. It was compared with the stored messages to find the\n  WSDL that had generated it. Now,\n  `TableWsdl#getSourceSoapActions(String)` requires a SOAP action string\n   that is used for comparisons. This shouldn't be a problem however,\n   because,\n    - all version 1 SOAP messages contain a SOAPAction header; and\n    - if the action is omitted in a version 2 message, an empty string\n    is used.\n- Add new classes `TableWsdl` and `SoapAction`. Remove `ImportWSDL`.\n- Many unit tests were removed (for methods that are no longer used),\nsome were added.\n- Cosmetic Changes as suggested by my IDE and other code readability\nimprovements.\n\nSigned-off-by: ricekot <ricekot@gmail.com>", "committedDate": "2020-12-15T20:36:52Z", "type": "forcePushed"}]}