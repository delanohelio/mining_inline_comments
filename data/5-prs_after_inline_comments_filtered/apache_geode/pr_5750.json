{"pr_number": 5750, "pr_title": "GEODE-8706: getConnection should get readLock to sync with destroyCon\u2026", "pr_createdAt": "2020-11-14T01:57:58Z", "pr_url": "https://github.com/apache/geode/pull/5750", "timeline": [{"oid": "a64ab2e2e0a37954d660074170f5f72e2f0680bc", "url": "https://github.com/apache/geode/commit/a64ab2e2e0a37954d660074170f5f72e2f0680bc", "message": "GEODE-8706: getConnection should get readLock to sync with destroyConnection", "committedDate": "2020-11-14T06:25:04Z", "type": "commit"}, {"oid": "a64ab2e2e0a37954d660074170f5f72e2f0680bc", "url": "https://github.com/apache/geode/commit/a64ab2e2e0a37954d660074170f5f72e2f0680bc", "message": "GEODE-8706: getConnection should get readLock to sync with destroyConnection", "committedDate": "2020-11-14T06:25:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1NjY1NQ==", "url": "https://github.com/apache/geode/pull/5750#discussion_r524456655", "bodyText": "Does this debug statement need to be moved inside the readLock too since it calls this.connection.getServer()?", "author": "boglesby", "createdAt": "2020-11-16T17:44:55Z", "path": "geode-wan/src/main/java/org/apache/geode/internal/cache/wan/GatewaySenderEventRemoteDispatcher.java", "diffHunk": "@@ -295,9 +301,16 @@ public Connection getConnection(boolean startAckReaderThread) throws GatewaySend\n     // OR the connection's ServerLocation doesn't match with the one stored in sender\n     // THEN initialize the connection\n     if (!this.sender.isParallel()) {\n-      if (this.connection == null || this.connection.isDestroyed()\n-          || this.connection.getServer() == null\n-          || !this.connection.getServer().equals(this.sender.getServerLocation())) {\n+      boolean needToReconnect = false;\n+      getConnectionLifeCycleLock().readLock().lock();\n+      try {\n+        needToReconnect = this.connection == null || this.connection.isDestroyed()\n+            || this.connection.getServer() == null\n+            || !this.connection.getServer().equals(this.sender.getServerLocation());\n+      } finally {\n+        getConnectionLifeCycleLock().readLock().unlock();\n+      }\n+      if (needToReconnect) {\n         if (logger.isDebugEnabled()) {", "originalCommit": "a64ab2e2e0a37954d660074170f5f72e2f0680bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3NzI0OA==", "url": "https://github.com/apache/geode/pull/5750#discussion_r524477248", "bodyText": "No need, you see the original author used:\n(this.connection == null) ? \"null\" : ...\nThat means he realized this connection could be null here", "author": "gesterzhou", "createdAt": "2020-11-16T18:18:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ1NjY1NQ=="}], "type": "inlineReview"}, {"oid": "f19745f3bc7abe51658d3805515e96cc34389b81", "url": "https://github.com/apache/geode/commit/f19745f3bc7abe51658d3805515e96cc34389b81", "message": "use getConnectionLifeCycleLock() instead of attribute", "committedDate": "2020-11-16T18:14:36Z", "type": "commit"}]}