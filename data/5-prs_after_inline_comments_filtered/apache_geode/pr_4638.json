{"pr_number": 4638, "pr_title": "GEODE-7683: introduce BR.cmnClearRegion", "pr_createdAt": "2020-01-28T01:04:49Z", "pr_url": "https://github.com/apache/geode/pull/4638", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTk5NDYyMQ==", "url": "https://github.com/apache/geode/pull/4638#discussion_r371994621", "bodyText": "Since we locked the primary bucket just now, should we first unlock it before we throw due to the primary no longer being where we expect?", "author": "BenjaminPerryRoss", "createdAt": "2020-01-28T18:58:27Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/BucketRegion.java", "diffHunk": "@@ -557,6 +558,42 @@ public boolean virtualPut(EntryEventImpl event, boolean ifNew, boolean ifOld,\n     }\n   }\n \n+  @Override\n+  void cmnClearRegion(RegionEventImpl regionEvent, boolean cacheWrite, boolean useRVV) {\n+    boolean enableRVV = useRVV && getConcurrencyChecksEnabled();\n+    RegionVersionVector rvv = null;\n+    if (enableRVV) {\n+      rvv = getVersionVector();\n+    }\n+\n+    // lock the primary from moving\n+    DistributedLockService lockService = DistributedLockService\n+        .getServiceNamed(PartitionedRegionHelper.PARTITION_LOCK_SERVICE_NAME);\n+    String lockName = this.getFullPath();\n+    while (!lockService.lock(lockName, 100, -1)) {\n+      if (!getBucketAdvisor().isPrimary()) {\n+        PartitionedRegionException pre =\n+            new PartitionedRegionException(\n+                \"The bucket \" + this.getId() + \" is no longer a primary. Retry the clear\");\n+        throw pre;", "originalCommit": "debcb4ddde543f6e8396b4cdb895642b4474d27b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzA2Mg==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375003062", "bodyText": "This is opposite of what the comment says", "author": "jhuynh1", "createdAt": "2020-02-05T00:39:17Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/BucketRegion.java", "diffHunk": "@@ -557,6 +557,34 @@ public boolean virtualPut(EntryEventImpl event, boolean ifNew, boolean ifOld,\n     }\n   }\n \n+  @Override\n+  void cmnClearRegion(RegionEventImpl regionEvent, boolean cacheWrite, boolean useRVV) {\n+    if (getBucketAdvisor().isPrimary()) {", "originalCommit": "a6328f2e5d073d9682ef37a01409c4e45275a116", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MDg1MA==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375450850", "bodyText": "Yes, I have fixed.", "author": "gesterzhou", "createdAt": "2020-02-05T19:08:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzQ4NA==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375003484", "bodyText": "Does this call just return null if it's not enabled?  Do we need the if check?", "author": "jhuynh1", "createdAt": "2020-02-05T00:41:07Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/BucketRegion.java", "diffHunk": "@@ -557,6 +557,34 @@ public boolean virtualPut(EntryEventImpl event, boolean ifNew, boolean ifOld,\n     }\n   }\n \n+  @Override\n+  void cmnClearRegion(RegionEventImpl regionEvent, boolean cacheWrite, boolean useRVV) {\n+    if (getBucketAdvisor().isPrimary()) {\n+      logger.info(\"Not primary bucket when doing clear, do nothing\");\n+      return;\n+    }\n+\n+    boolean enableRVV = useRVV && getConcurrencyChecksEnabled();\n+    RegionVersionVector rvv = null;\n+    if (enableRVV) {\n+      rvv = getVersionVector();", "originalCommit": "a6328f2e5d073d9682ef37a01409c4e45275a116", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MDczMw==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375450733", "bodyText": "Yes, then just use null for rvv.", "author": "gesterzhou", "createdAt": "2020-02-05T19:08:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ2OTY2MQ==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375469661", "bodyText": "If this returns null, then the if check isn't needed.  It'll be null either way.", "author": "jhuynh1", "createdAt": "2020-02-05T19:44:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzMzI1Mg==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375533252", "bodyText": "There's basicLocalClear whose useRVV is false. I need to consider that.", "author": "gesterzhou", "createdAt": "2020-02-05T22:01:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyNDA4NQ==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375624085", "bodyText": "Lets think of the case where useRVV is false.\nif (false) {}\nrvv is already null, so rvv ends up null;\nOR\n//remove the if check\nrvv = getVersionVector() <-returns null anyways\nThe end result is the same.  why have the if check?", "author": "jhuynh1", "createdAt": "2020-02-06T03:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzQ4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI0Njk3Mw==", "url": "https://github.com/apache/geode/pull/4638#discussion_r376246973", "bodyText": "In BR.cmnClearRegion(), since we have locked the rvvLock, no more operations will be intiated here. So no need to explicitly use RVV. I will fix this part.", "author": "gesterzhou", "createdAt": "2020-02-07T07:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzQ4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzg4OA==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375003888", "bodyText": "Shouldn't it only be the origin that distributes?", "author": "jhuynh1", "createdAt": "2020-02-05T00:42:48Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/BucketRegion.java", "diffHunk": "@@ -557,6 +557,34 @@ public boolean virtualPut(EntryEventImpl event, boolean ifNew, boolean ifOld,\n     }\n   }\n \n+  @Override\n+  void cmnClearRegion(RegionEventImpl regionEvent, boolean cacheWrite, boolean useRVV) {\n+    if (getBucketAdvisor().isPrimary()) {\n+      logger.info(\"Not primary bucket when doing clear, do nothing\");\n+      return;\n+    }\n+\n+    boolean enableRVV = useRVV && getConcurrencyChecksEnabled();\n+    RegionVersionVector rvv = null;\n+    if (enableRVV) {\n+      rvv = getVersionVector();\n+    }\n+\n+    // get rvvLock\n+    Set<InternalDistributedMember> participants =\n+        getCacheDistributionAdvisor().adviseInvalidateRegion();\n+    try {\n+      obtainWriteLocksForClear(regionEvent, participants);\n+      clearRegionLocally(regionEvent, cacheWrite, null);\n+      if (!regionEvent.isOriginRemote() && regionEvent.getOperation().isDistributed()) {", "originalCommit": "a6328f2e5d073d9682ef37a01409c4e45275a116", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ0OTk0NA==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375449944", "bodyText": "Yes, after I carefully reviewed the code, we don't need this check.", "author": "gesterzhou", "createdAt": "2020-02-05T19:06:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwMzg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwNDQyOQ==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375004429", "bodyText": "Not part of this diff, but I assume we are taking a less granular lock earlier in the process for the entire partitioned region?", "author": "jhuynh1", "createdAt": "2020-02-05T00:44:52Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/DistributedRegion.java", "diffHunk": "@@ -2081,10 +2081,12 @@ private void distributedUnlockForClear() {\n   /**\n    * obtain locks preventing generation of new versions in other members\n    */\n-  private void obtainWriteLocksForClear(RegionEventImpl regionEvent,\n+  protected void obtainWriteLocksForClear(RegionEventImpl regionEvent,\n       Set<InternalDistributedMember> participants) {\n     lockLocallyForClear(getDistributionManager(), getMyId(), regionEvent);\n-    DistributedClearOperation.lockAndFlushToOthers(regionEvent, participants);\n+    if (!isUsedForPartitionedRegionBucket()) {\n+      DistributedClearOperation.lockAndFlushToOthers(regionEvent, participants);", "originalCommit": "a6328f2e5d073d9682ef37a01409c4e45275a116", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1MDQxMw==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375450413", "bodyText": "BR does not need to send msg to secondary to do rvvLock.", "author": "gesterzhou", "createdAt": "2020-02-05T19:07:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTAwNDQyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5OTExMA==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375499110", "bodyText": "I see you made reindexUserDataRegion public. Is this something you need to call here?", "author": "boglesby", "createdAt": "2020-02-05T20:47:55Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/BucketRegion.java", "diffHunk": "@@ -557,6 +557,32 @@ public boolean virtualPut(EntryEventImpl event, boolean ifNew, boolean ifOld,\n     }\n   }\n \n+  @Override\n+  void cmnClearRegion(RegionEventImpl regionEvent, boolean cacheWrite, boolean useRVV) {\n+    if (!getBucketAdvisor().isPrimary()) {\n+      logger.info(\"Not primary bucket when doing clear, do nothing\");\n+      return;\n+    }\n+\n+    boolean enableRVV = useRVV && getConcurrencyChecksEnabled();\n+    RegionVersionVector rvv = null;\n+    if (enableRVV) {\n+      rvv = getVersionVector();\n+    }\n+\n+    // get rvvLock\n+    Set<InternalDistributedMember> participants =\n+        getCacheDistributionAdvisor().adviseInvalidateRegion();\n+    try {\n+      obtainWriteLocksForClear(regionEvent, participants);\n+      clearRegionLocally(regionEvent, cacheWrite, rvv);\n+      distributeClearOperation(regionEvent, rvv, participants);\n+\n+      // TODO: call reindexUserDataRegion if there're lucene indexes", "originalCommit": "ad9169097ca662d38e34ea9fb61a5cc314176c9f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUyODYzMg==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375528632", "bodyText": "Yes, that will be called in future as a todo work.", "author": "gesterzhou", "createdAt": "2020-02-05T21:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5OTExMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzNjkwNg==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375536906", "bodyText": "But I changed it back for the time being", "author": "gesterzhou", "createdAt": "2020-02-05T22:10:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5OTExMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUzMjE4OQ==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375532189", "bodyText": "There is no need to change the scope to public, at least not in this pull request.", "author": "jchen21", "createdAt": "2020-02-05T21:59:38Z", "path": "geode-lucene/src/main/java/org/apache/geode/cache/lucene/internal/IndexRepositoryFactory.java", "diffHunk": "@@ -152,7 +152,7 @@ protected IndexWriter buildIndexWriter(int bucketId, BucketRegion fileAndChunkBu\n     return new IndexWriter(dir, config);\n   }\n \n-  private boolean reindexUserDataRegion(Integer bucketId, PartitionedRegion userRegion,\n+  public boolean reindexUserDataRegion(Integer bucketId, PartitionedRegion userRegion,", "originalCommit": "ad9169097ca662d38e34ea9fb61a5cc314176c9f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "11afea7c2d2f2320e908972ce34ddf5d3bf3daf9", "url": "https://github.com/apache/geode/commit/11afea7c2d2f2320e908972ce34ddf5d3bf3daf9", "message": "GEODE-7683: introduce BR.cmnClearRegion", "committedDate": "2020-02-05T23:16:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyMzE1MA==", "url": "https://github.com/apache/geode/pull/4638#discussion_r375623150", "bodyText": "This is not quite the same.  Is there a reason why we removed the if check?  We will now always set oldMemValue even if it's been initialized?\nwhy wasn't this just a removal of the else and leave the else if? Just want to understand the logic here a bit...", "author": "jhuynh1", "createdAt": "2020-02-06T03:20:31Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/BucketRegion.java", "diffHunk": "@@ -2087,19 +2113,10 @@ void updateSizeOnClearRegion(int sizeBeforeClear) {\n     if (isDestroyed || isDestroyingDiskRegion) {\n       // If this region is destroyed, mark the stat as destroyed.\n       oldMemValue = bytesInMemory.getAndSet(BUCKET_DESTROYED);\n-\n-    } else if (!isInitialized()) {\n-      // This case is rather special. We clear the region if the GII failed.\n-      // In the case of bucket regions, we know that there will be no concurrent operations\n-      // if GII has failed, because there is not primary. So it's safe to set these\n-      // counters to 0.\n+    } else {", "originalCommit": "11afea7c2d2f2320e908972ce34ddf5d3bf3daf9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI0NzUyMw==", "url": "https://github.com/apache/geode/pull/4638#discussion_r376247523", "bodyText": "OK, I will keep the \"else if\" with comments and fix into the \"else\" only.", "author": "gesterzhou", "createdAt": "2020-02-07T07:31:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYyMzE1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5Nzg4NQ==", "url": "https://github.com/apache/geode/pull/4638#discussion_r376397885", "bodyText": "Do we need to log this message using info level?.\nUsers won't be able to do anything if they see it anyway, so I think we should either delete it or log it as debug.", "author": "jujoramos", "createdAt": "2020-02-07T13:47:56Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/BucketRegion.java", "diffHunk": "@@ -557,6 +557,32 @@ public boolean virtualPut(EntryEventImpl event, boolean ifNew, boolean ifOld,\n     }\n   }\n \n+  @Override\n+  void cmnClearRegion(RegionEventImpl regionEvent, boolean cacheWrite, boolean useRVV) {\n+    if (!getBucketAdvisor().isPrimary()) {\n+      logger.info(\"Not primary bucket when doing clear, do nothing\");", "originalCommit": "11afea7c2d2f2320e908972ce34ddf5d3bf3daf9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI1NTY0Nw==", "url": "https://github.com/apache/geode/pull/4638#discussion_r377255647", "bodyText": "done", "author": "gesterzhou", "createdAt": "2020-02-10T19:01:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM5Nzg4NQ=="}], "type": "inlineReview"}, {"oid": "5fafebd0d90945f690bc9ce283f5e3cec7e57722", "url": "https://github.com/apache/geode/commit/5fafebd0d90945f690bc9ce283f5e3cec7e57722", "message": "GEODE-7683: introduce BR.cmnClearRegion", "committedDate": "2020-02-11T06:38:45Z", "type": "forcePushed"}, {"oid": "8bf3899e0363428b080fdbdc41f3fadc4d18a4c3", "url": "https://github.com/apache/geode/commit/8bf3899e0363428b080fdbdc41f3fadc4d18a4c3", "message": "GEODE-7683: introduce BR.cmnClearRegion", "committedDate": "2020-02-11T17:20:37Z", "type": "commit"}, {"oid": "8bf3899e0363428b080fdbdc41f3fadc4d18a4c3", "url": "https://github.com/apache/geode/commit/8bf3899e0363428b080fdbdc41f3fadc4d18a4c3", "message": "GEODE-7683: introduce BR.cmnClearRegion", "committedDate": "2020-02-11T17:20:37Z", "type": "forcePushed"}]}