{"pr_number": 4823, "pr_title": "GEODE-7851: Pulse Oauth Configuration", "pr_createdAt": "2020-03-18T03:19:26Z", "pr_url": "https://github.com/apache/geode/pull/4823", "timeline": [{"oid": "775ba6685679218165dbc58985dad7475f163dd9", "url": "https://github.com/apache/geode/commit/775ba6685679218165dbc58985dad7475f163dd9", "message": "GEODE-7851: Pulse Oauth Support\n\n* create an OauthSecurityConfig to configure spring using oauth\n* add PULSE as one of the oauth-enabled-component, and if pulse is set to use oauth, set the OauthSecurityConfig as the active security profile\n* use pulse.properties in the locator's working dir to externalize pulse authentication provider configuration", "committedDate": "2020-03-18T03:17:37Z", "type": "commit"}, {"oid": "bc909c20594c0a90d2f24e76791094ed50a6e28b", "url": "https://github.com/apache/geode/commit/bc909c20594c0a90d2f24e76791094ed50a6e28b", "message": "fix tests", "committedDate": "2020-03-18T19:42:39Z", "type": "commit"}, {"oid": "41fb0abd16ee620968278917c1fca05d919babb5", "url": "https://github.com/apache/geode/commit/41fb0abd16ee620968278917c1fca05d919babb5", "message": "Co-authored-by: Dale Emery <demery@pivotal.io>\nCo-authored-by: Joris Melchior <jmelchior@pivotal.io>\n\ndelete unnecessary test file", "committedDate": "2020-03-18T19:48:27Z", "type": "commit"}, {"oid": "49726156d3275a9f7f8822afccaa4358125000e0", "url": "https://github.com/apache/geode/commit/49726156d3275a9f7f8822afccaa4358125000e0", "message": "spotless", "committedDate": "2020-03-18T20:19:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwMzcxMA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r394703710", "bodyText": "this code repeats \"spring.profiles.active\" four times. Consider changing it to just call System.setProperty once (at the end). You could introduce a localvar \"String activeProfileValue\" and have each of these lines set that local var.", "author": "dschneider-pivotal", "createdAt": "2020-03-18T23:50:50Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/ManagementAgent.java", "diffHunk": "@@ -192,9 +194,20 @@ private void loadWebApplications() {\n         logger.debug(message);\n       }\n     } else {\n+      String[] authTokenEnabledComponents = config.getSecurityAuthTokenEnabledComponents();\n+      boolean pulseOauth = Arrays.stream(authTokenEnabledComponents)\n+          .anyMatch(AuthTokenEnabledComponents::hasPulse);\n       String pwFile = this.config.getJmxManagerPasswordFile();\n-      if (securityService.isIntegratedSecurity() || StringUtils.isNotBlank(pwFile)) {\n+      if (securityService.isIntegratedSecurity()) {\n+        if (pulseOauth) {\n+          System.setProperty(\"spring.profiles.active\", \"pulse.authentication.oauth\");", "originalCommit": "49726156d3275a9f7f8822afccaa4358125000e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNDU2NA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r394704564", "bodyText": "Since you only use \"pulseOauth\" inside the if(isIntegratedSecurity) would it be better to initialize the variable inside that if?", "author": "dschneider-pivotal", "createdAt": "2020-03-18T23:53:33Z", "path": "geode-core/src/main/java/org/apache/geode/management/internal/ManagementAgent.java", "diffHunk": "@@ -192,9 +194,20 @@ private void loadWebApplications() {\n         logger.debug(message);\n       }\n     } else {\n+      String[] authTokenEnabledComponents = config.getSecurityAuthTokenEnabledComponents();\n+      boolean pulseOauth = Arrays.stream(authTokenEnabledComponents)", "originalCommit": "49726156d3275a9f7f8822afccaa4358125000e0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNjA2OQ==", "url": "https://github.com/apache/geode/pull/4823#discussion_r394706069", "bodyText": "It looks like we only have uaa support here. So if a customer is using oauth2 will it only work with uaa or can the configure it for some other oauth2 authentication server?", "author": "dschneider-pivotal", "createdAt": "2020-03-18T23:58:36Z", "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/security/OauthSecurityConfig.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.tools.pulse.internal.security;\n+\n+import static org.springframework.security.config.Customizer.withDefaults;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.context.annotation.PropertySource;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.InMemoryOAuth2AuthorizedClientService;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.web.AuthenticatedPrincipalOAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AuthorizationGrantType;\n+\n+@Configuration\n+@EnableWebSecurity\n+@EnableGlobalMethodSecurity(prePostEnabled = true)\n+@Profile(\"pulse.authentication.oauth\")\n+@PropertySource(\"classpath:pulse.properties\")\n+public class OauthSecurityConfig extends WebSecurityConfigurerAdapter {\n+  @Value(\"${pulse.oauth.provider}\")\n+  private String providerId;\n+  @Value(\"${pulse.oauth.clientId}\")\n+  private String clientId;\n+  @Value(\"${pulse.oauth.clientSecret}\")\n+  private String clientSecret;\n+  @Value(\"${pulse.oauth.authorizationUri}\")\n+  private String authorizationUri;\n+  @Value(\"${pulse.oauth.tokenUri}\")\n+  private String tokenUri;\n+  @Value(\"${pulse.oauth.userInfoUri}\")\n+  private String userInfoUri;\n+  @Value(\"${pulse.oauth.jwkSetUri}\")\n+  private String jwkSetUri;\n+  @Value(\"${pulse.oauth.userNameAttributeName}\")\n+  private String userNameAttributeName;\n+\n+  @Override\n+  protected void configure(HttpSecurity http) throws Exception {\n+    http.authorizeRequests(authorize -> authorize\n+        .anyRequest().authenticated())\n+        .oauth2Login(withDefaults());\n+  }\n+\n+  @Bean\n+  public ClientRegistrationRepository clientRegistrationRepository() {\n+    return new InMemoryClientRegistrationRepository(this.uaaClientRegistration());", "originalCommit": "49726156d3275a9f7f8822afccaa4358125000e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDczODUwMQ==", "url": "https://github.com/apache/geode/pull/4823#discussion_r394738501", "bodyText": "actually that name can be changed", "author": "jinmeiliao", "createdAt": "2020-03-19T01:28:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDcwNjA2OQ=="}], "type": "inlineReview"}, {"oid": "2082ed6390460415d1a5f5250fe019252acfb004", "url": "https://github.com/apache/geode/commit/2082ed6390460415d1a5f5250fe019252acfb004", "message": "review changes", "committedDate": "2020-03-19T03:04:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA5Mjc3MA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395092770", "bodyText": "Do we need to add something here to take of where the app goes after logging out? For OAuth this should be different from Default or Gemfire flows I believe.", "author": "jmelchio", "createdAt": "2020-03-19T15:00:51Z", "path": "geode-pulse/src/main/java/org/apache/geode/tools/pulse/internal/security/OauthSecurityConfig.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.tools.pulse.internal.security;\n+\n+import static org.springframework.security.config.Customizer.withDefaults;\n+\n+import org.springframework.beans.factory.annotation.Value;\n+import org.springframework.context.annotation.Bean;\n+import org.springframework.context.annotation.Configuration;\n+import org.springframework.context.annotation.Profile;\n+import org.springframework.context.annotation.PropertySource;\n+import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;\n+import org.springframework.security.config.annotation.web.builders.HttpSecurity;\n+import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;\n+import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;\n+import org.springframework.security.oauth2.client.InMemoryOAuth2AuthorizedClientService;\n+import org.springframework.security.oauth2.client.OAuth2AuthorizedClientService;\n+import org.springframework.security.oauth2.client.registration.ClientRegistration;\n+import org.springframework.security.oauth2.client.registration.ClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.registration.InMemoryClientRegistrationRepository;\n+import org.springframework.security.oauth2.client.web.AuthenticatedPrincipalOAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.client.web.OAuth2AuthorizedClientRepository;\n+import org.springframework.security.oauth2.core.AuthorizationGrantType;\n+\n+@Configuration\n+@EnableWebSecurity\n+@EnableGlobalMethodSecurity(prePostEnabled = true)\n+@Profile(\"pulse.authentication.oauth\")\n+@PropertySource(\"classpath:pulse.properties\")\n+public class OauthSecurityConfig extends WebSecurityConfigurerAdapter {\n+  @Value(\"${pulse.oauth.provider}\")\n+  private String providerId;\n+  @Value(\"${pulse.oauth.clientId}\")\n+  private String clientId;\n+  @Value(\"${pulse.oauth.clientSecret}\")\n+  private String clientSecret;\n+  @Value(\"${pulse.oauth.authorizationUri}\")\n+  private String authorizationUri;\n+  @Value(\"${pulse.oauth.tokenUri}\")\n+  private String tokenUri;\n+  @Value(\"${pulse.oauth.userInfoUri}\")\n+  private String userInfoUri;\n+  @Value(\"${pulse.oauth.jwkSetUri}\")\n+  private String jwkSetUri;\n+  @Value(\"${pulse.oauth.userNameAttributeName}\")\n+  private String userNameAttributeName;\n+\n+  @Override\n+  protected void configure(HttpSecurity http) throws Exception {\n+    http.authorizeRequests(authorize -> authorize\n+        .anyRequest().authenticated())", "originalCommit": "2082ed6390460415d1a5f5250fe019252acfb004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA5NDU4MA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395094580", "bodyText": "In your test, what does it do?", "author": "jinmeiliao", "createdAt": "2020-03-19T15:03:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA5Mjc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA5NjYzMg==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395096632", "bodyText": "Does this PR need to update some of the doc files to describe how to configure pulse to use oauth2?\n\nYes, I will add a task to the tracker story to update the doc. PR for that is to be followed.", "author": "jinmeiliao", "createdAt": "2020-03-19T15:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA5Mjc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTExNDU4Ng==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395114586", "bodyText": "In your test, what does it do?\n\nDon't have that covered in test yet but it follows the logoutHandler set up in the DefaultSecurityConfig. In the OAuth case I think it should invalidate the token someway. I assume there is a built-in way that Spring handles this so we should try to make use of that.", "author": "jmelchio", "createdAt": "2020-03-19T15:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA5Mjc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTE1NjU0Mw==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395156543", "bodyText": "In this changeset, I have OauthSecurityConfig directly extends WebSecurityConfigurerAdapter. It does not use anything defined in DefaultSecurityConfig. So I hope spring would pick up the flow.", "author": "jinmeiliao", "createdAt": "2020-03-19T16:27:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTA5Mjc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMTUyOQ==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395821529", "bodyText": "It looks as if this uses the /management API itself to somehow mimic UAA (or some other OAuth server). How does that work?", "author": "demery-pivotal", "createdAt": "2020-03-20T18:32:33Z", "path": "geode-assembly/src/integrationTest/java/org/apache/geode/tools/pulse/PulseSecurityConfigOauthProfileTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.tools.pulse;\n+\n+import static org.apache.geode.test.junit.rules.HttpResponseAssert.assertResponse;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.util.Properties;\n+\n+import org.apache.http.HttpResponse;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+import org.apache.geode.examples.SimpleSecurityManager;\n+import org.apache.geode.test.junit.categories.PulseTest;\n+import org.apache.geode.test.junit.rules.GeodeHttpClientRule;\n+import org.apache.geode.test.junit.rules.LocatorStarterRule;\n+\n+@Category({PulseTest.class})\n+public class PulseSecurityConfigOauthProfileTest {\n+  // this test just makes sure the property file in the locator's working dir\n+  // gets properly read and used in the oauth security configuration\n+\n+  @ClassRule\n+  public static LocatorStarterRule locator =\n+      new LocatorStarterRule().withHttpService()\n+          .withSecurityManager(SimpleSecurityManager.class)\n+          .withProperty(\"security-auth-token-enabled-components\", \"pulse\");\n+\n+  private static File pulsePropertyFile;\n+\n+  @BeforeClass\n+  public static void setup() throws Exception {\n+    // copy the pulse.properties to the locator's working dir. Pulse will use the locator's working\n+    // dir as classpath to search for this property file\n+    pulsePropertyFile = new File(locator.getWorkingDir(), \"pulse.properties\");\n+    Properties properties = new Properties();\n+    properties.setProperty(\"pulse.oauth.provider\", \"uaa\");\n+    properties.setProperty(\"pulse.oauth.clientId\", \"pulse\");\n+    properties.setProperty(\"pulse.oauth.clientSecret\", \"secret\");\n+    // have the authorization uri point to a known uri that locator itself can serve\n+    properties.setProperty(\"pulse.oauth.authorizationUri\",\n+        \"http://localhost:\" + locator.getHttpPort() + \"/management\");", "originalCommit": "2082ed6390460415d1a5f5250fe019252acfb004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1MTIzOA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395851238", "bodyText": "this changeset only makes sure pulse can be configured to talk to an authorizationUri. Whatever happens after that, is going to be in Joris's PR.", "author": "jinmeiliao", "createdAt": "2020-03-20T19:35:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMTUyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1MTg4NA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395851884", "bodyText": "As the test comment states \"this test just makes sure the property file in the locator's working dir\ngets properly read and used in the oauth security configuration\". so it only makes sure the configuration in the property file gets used by Pulse, exactly where that URI points to, is irrelavant.", "author": "jinmeiliao", "createdAt": "2020-03-20T19:36:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMTUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMzE1MQ==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395823151", "bodyText": "Why only once? This looks fragile: If someone changes the page to show these words more than once, the test will fail, even if the request redirects properly.", "author": "demery-pivotal", "createdAt": "2020-03-20T18:35:51Z", "path": "geode-assembly/src/integrationTest/java/org/apache/geode/tools/pulse/PulseSecurityConfigOauthProfileTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.tools.pulse;\n+\n+import static org.apache.geode.test.junit.rules.HttpResponseAssert.assertResponse;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.util.Properties;\n+\n+import org.apache.http.HttpResponse;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+import org.apache.geode.examples.SimpleSecurityManager;\n+import org.apache.geode.test.junit.categories.PulseTest;\n+import org.apache.geode.test.junit.rules.GeodeHttpClientRule;\n+import org.apache.geode.test.junit.rules.LocatorStarterRule;\n+\n+@Category({PulseTest.class})\n+public class PulseSecurityConfigOauthProfileTest {\n+  // this test just makes sure the property file in the locator's working dir\n+  // gets properly read and used in the oauth security configuration\n+\n+  @ClassRule\n+  public static LocatorStarterRule locator =\n+      new LocatorStarterRule().withHttpService()\n+          .withSecurityManager(SimpleSecurityManager.class)\n+          .withProperty(\"security-auth-token-enabled-components\", \"pulse\");\n+\n+  private static File pulsePropertyFile;\n+\n+  @BeforeClass\n+  public static void setup() throws Exception {\n+    // copy the pulse.properties to the locator's working dir. Pulse will use the locator's working\n+    // dir as classpath to search for this property file\n+    pulsePropertyFile = new File(locator.getWorkingDir(), \"pulse.properties\");\n+    Properties properties = new Properties();\n+    properties.setProperty(\"pulse.oauth.provider\", \"uaa\");\n+    properties.setProperty(\"pulse.oauth.clientId\", \"pulse\");\n+    properties.setProperty(\"pulse.oauth.clientSecret\", \"secret\");\n+    // have the authorization uri point to a known uri that locator itself can serve\n+    properties.setProperty(\"pulse.oauth.authorizationUri\",\n+        \"http://localhost:\" + locator.getHttpPort() + \"/management\");\n+\n+    properties.store(new FileWriter(pulsePropertyFile), null);\n+    locator.startLocator();\n+  }\n+\n+  @AfterClass\n+  public static void cleanup() {\n+    pulsePropertyFile.delete();\n+  }\n+\n+  @Rule\n+  public GeodeHttpClientRule client = new GeodeHttpClientRule(locator::getHttpPort);\n+\n+  @Test\n+  public void testLogin() throws Exception {\n+    HttpResponse response = client.get(\"/pulse/login.html\");\n+    // the request is redirect to the authorization uri configured before\n+    assertResponse(response).hasStatusCode(200).hasResponseBody()\n+        .containsOnlyOnce(\"latest\")\n+        .containsOnlyOnce(\"supported\");", "originalCommit": "2082ed6390460415d1a5f5250fe019252acfb004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1NDI1Mw==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395854253", "bodyText": "This is a random URL I picked up only for testing purpose. I happen to pick the /management uri, which returns json content {\"latest\":\"...\", \"supported\":[...]}. It is just a way to test the redirect works. It's not likely that url response would change and if it does, yes, developer will need to change the test.", "author": "jinmeiliao", "createdAt": "2020-03-20T19:41:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMzE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1NDgxMQ==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395854811", "bodyText": "Why only once? This looks fragile: If someone changes the page to show these words more than once, the test will fail, even if the request redirects properly.\n\nFrom what I know that is highly unlikely. I think it is safe in this case.", "author": "jmelchio", "createdAt": "2020-03-20T19:42:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMzE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1OTQxOA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395859418", "bodyText": "Each assertion should express a requirement that the test cares about. \"Only once\" is not a requirement here. Fix it.", "author": "demery-pivotal", "createdAt": "2020-03-20T19:53:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMzE1MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg2MTIxMQ==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395861211", "bodyText": "done.", "author": "jinmeiliao", "createdAt": "2020-03-20T19:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMzE1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyMzQzMA==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395823430", "bodyText": "Capitalize the A in OAuth (here and elsewhere)", "author": "demery-pivotal", "createdAt": "2020-03-20T18:36:24Z", "path": "geode-assembly/src/integrationTest/java/org/apache/geode/tools/pulse/PulseSecurityConfigOauthProfileTest.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.tools.pulse;\n+\n+import static org.apache.geode.test.junit.rules.HttpResponseAssert.assertResponse;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.util.Properties;\n+\n+import org.apache.http.HttpResponse;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+\n+import org.apache.geode.examples.SimpleSecurityManager;\n+import org.apache.geode.test.junit.categories.PulseTest;\n+import org.apache.geode.test.junit.rules.GeodeHttpClientRule;\n+import org.apache.geode.test.junit.rules.LocatorStarterRule;\n+\n+@Category({PulseTest.class})\n+public class PulseSecurityConfigOauthProfileTest {", "originalCommit": "2082ed6390460415d1a5f5250fe019252acfb004", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyNTM3Mw==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395825373", "bodyText": "xyz.com is an actual domain name. Please use a test-specific domain name such as:\n\nexample.com (example.com is intended mostly for documentation, but people use it for testing)\n<any-subdomain>.test (.test is a special top-level domain name designed for testing)\n<any-subdomain>.example (.example is another special top-level domain name)", "author": "demery-pivotal", "createdAt": "2020-03-20T18:40:18Z", "path": "geode-pulse/src/integrationTest/java/org/apache/geode/tools/pulse/security/OauthSecurityConfigTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.tools.pulse.security;\n+\n+import static org.springframework.security.test.web.servlet.setup.SecurityMockMvcConfigurers.springSecurity;\n+import static org.springframework.test.web.servlet.request.MockMvcRequestBuilders.get;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.redirectedUrl;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.redirectedUrlPattern;\n+import static org.springframework.test.web.servlet.result.MockMvcResultMatchers.status;\n+\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ActiveProfiles;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.junit4.SpringRunner;\n+import org.springframework.test.context.web.GenericXmlWebContextLoader;\n+import org.springframework.test.context.web.WebAppConfiguration;\n+import org.springframework.test.web.servlet.MockMvc;\n+import org.springframework.test.web.servlet.setup.MockMvcBuilders;\n+import org.springframework.web.context.WebApplicationContext;\n+\n+@RunWith(SpringRunner.class)\n+@ContextConfiguration(locations = {\"classpath*:WEB-INF/pulse-servlet.xml\"},\n+    loader = GenericXmlWebContextLoader.class)\n+@WebAppConfiguration\n+@ActiveProfiles({\"pulse.authentication.oauth\"})\n+public class OauthSecurityConfigTest {\n+  @Autowired\n+  private WebApplicationContext context;\n+\n+  private MockMvc mvc;\n+\n+  @Before\n+  public void setup() {\n+    mvc = MockMvcBuilders\n+        .webAppContextSetup(context)\n+        .apply(springSecurity())\n+        .build();\n+  }\n+\n+  @Test\n+  public void redirectToOauth() throws Exception {\n+    mvc.perform(get(\"/login.html\")).andExpect(status().is3xxRedirection())\n+        .andExpect(redirectedUrl((\"http://localhost/oauth2/authorization/uaa\")));\n+\n+    mvc.perform(get(\"http://localhost/oauth2/authorization/uaa\"))\n+        .andExpect(status().is3xxRedirection())\n+        .andExpect(redirectedUrlPattern(\"http://xyz.com/uaa/oauth/**\"));", "originalCommit": "2082ed6390460415d1a5f5250fe019252acfb004", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg1NDUzNw==", "url": "https://github.com/apache/geode/pull/4823#discussion_r395854537", "bodyText": "will do", "author": "jinmeiliao", "createdAt": "2020-03-20T19:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTgyNTM3Mw=="}], "type": "inlineReview"}, {"oid": "7c9ebd4ece055c15c6b6b0ec5bacc2605d786b2b", "url": "https://github.com/apache/geode/commit/7c9ebd4ece055c15c6b6b0ec5bacc2605d786b2b", "message": "review comments", "committedDate": "2020-03-20T19:52:32Z", "type": "commit"}, {"oid": "95c67ba5a0322672ec21c702dcb3c27492e983e7", "url": "https://github.com/apache/geode/commit/95c67ba5a0322672ec21c702dcb3c27492e983e7", "message": "review comments", "committedDate": "2020-03-20T19:56:28Z", "type": "commit"}, {"oid": "384f93e990b89487954f85282ea80fe9bb42793f", "url": "https://github.com/apache/geode/commit/384f93e990b89487954f85282ea80fe9bb42793f", "message": "review comment", "committedDate": "2020-03-20T20:36:45Z", "type": "commit"}]}