{"pr_number": 5273, "pr_title": "GEODE-8240: solve rolling upgrade bug with new VersionOrdinal interface", "pr_createdAt": "2020-06-18T14:39:13Z", "pr_url": "https://github.com/apache/geode/pull/5273", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1MTUzMg==", "url": "https://github.com/apache/geode/pull/5273#discussion_r442451532", "bodyText": "dead code", "author": "Bill", "createdAt": "2020-06-18T19:25:45Z", "path": "geode-serialization/src/main/java/org/apache/geode/internal/serialization/internal/DSFIDSerializerImpl.java", "diffHunk": "@@ -220,20 +220,6 @@ public void invokeToData(Object ds, DataOutput out) throws IOException {\n     }\n   }\n \n-  /**\n-   * Get the Version of the peer or disk store that created this {@link DataOutput}.\n-   * Returns\n-   * zero if the version is same as this member's.\n-   */\n-  public Version getVersionForDataStreamOrNull(DataOutput out) {\n-    // check if this is a versioned data output\n-    if (out instanceof VersionedDataStream) {\n-      return ((VersionedDataStream) out).getVersion();\n-    } else {\n-      return null;\n-    }\n-  }", "originalCommit": "6cae5f4ea8e387194cc9ac285ec4e04944775633", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ1MjA2Nw==", "url": "https://github.com/apache/geode/pull/5273#discussion_r442452067", "bodyText": "this was used in exactly two places and is better accomplished via Version.CURRENT.isEqual(someVersionOrdinal)", "author": "Bill", "createdAt": "2020-06-18T19:26:48Z", "path": "geode-serialization/src/main/java/org/apache/geode/internal/serialization/Version.java", "diffHunk": "@@ -635,48 +569,4 @@ public boolean isPre65() {\n         .collect(Collectors.toList());\n   }\n \n-  public boolean isCurrentVersion() {\n-    return this.ordinal == CURRENT.ordinal;\n-  }", "originalCommit": "6cae5f4ea8e387194cc9ac285ec4e04944775633", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9a0783994723b4571f71a30471520dc684eee3e8", "url": "https://github.com/apache/geode/commit/9a0783994723b4571f71a30471520dc684eee3e8", "message": "repair TcpServerProductVersionDUnitTest", "committedDate": "2020-06-18T21:58:11Z", "type": "forcePushed"}, {"oid": "423430fa971748578da2d8385de4109376a3ef40", "url": "https://github.com/apache/geode/commit/423430fa971748578da2d8385de4109376a3ef40", "message": "GEODE-8240: carry version in new VersionOrdinal to support rolling\n\nBug in rolling upgrade caused by silently converting unknown future\nversion to a Version, fixed by carrying version in new base type\nVersionOrdinal.\n\nAuthored-by: Bill Burcham <bill.burcham@gmail.com>", "committedDate": "2020-06-19T15:51:25Z", "type": "forcePushed"}, {"oid": "3591ac29ecf509fc70cd98250696c8b3b686d27f", "url": "https://github.com/apache/geode/commit/3591ac29ecf509fc70cd98250696c8b3b686d27f", "message": "GEODE-8240: carry version in new VersionOrdinal to support rolling\n\nBug in rolling upgrade caused by silently converting unknown future\nversion to a Version, fixed by carrying version in new base type\nVersionOrdinal.\n\nAuthored-by: Bill Burcham <bill.burcham@gmail.com>", "committedDate": "2020-06-19T16:08:21Z", "type": "forcePushed"}, {"oid": "a8ba7f23349b52d9558978a12cc0276618c4c921", "url": "https://github.com/apache/geode/commit/a8ba7f23349b52d9558978a12cc0276618c4c921", "message": "GEODE-8240: member identifier carries future versions\n\nGMSMemberData now carries future version (ordinals) again. Compensate\nfor 1.12.0 in-the-wild coordinator producing view with wrong (old)\nversion.\n\nAuthored-by: Bill Burcham <bill.burcham@gmail.com>", "committedDate": "2020-06-25T23:25:16Z", "type": "commit"}, {"oid": "a8ba7f23349b52d9558978a12cc0276618c4c921", "url": "https://github.com/apache/geode/commit/a8ba7f23349b52d9558978a12cc0276618c4c921", "message": "GEODE-8240: member identifier carries future versions\n\nGMSMemberData now carries future version (ordinals) again. Compensate\nfor 1.12.0 in-the-wild coordinator producing view with wrong (old)\nversion.\n\nAuthored-by: Bill Burcham <bill.burcham@gmail.com>", "committedDate": "2020-06-25T23:25:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0MDgzOA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446240838", "bodyText": "This should continue to use Version, not VersionOrdinal.  Using Version ensures that we never create a datastream with an unknown ordinal.  None of our serialization code will know what to do if that should happen.", "author": "bschuchardt", "createdAt": "2020-06-26T15:05:51Z", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/ClientSideHandshakeImpl.java", "diffHunk": "@@ -270,7 +271,7 @@ public ServerQueueStatus handshakeWithServer(Connection conn, ServerLocation loc\n   private InternalDistributedMember readServerMember(DataInputStream p_dis) throws IOException {\n \n     byte[] memberBytes = DataSerializer.readByteArray(p_dis);\n-    Version v = StaticSerialization.getVersionForDataStreamOrNull(p_dis);\n+    final VersionOrdinal v = StaticSerialization.getVersionForDataStreamOrNull(p_dis);", "originalCommit": "a8ba7f23349b52d9558978a12cc0276618c4c921", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3MDU0NQ==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446470545", "bodyText": "fixed", "author": "Bill", "createdAt": "2020-06-27T01:57:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0MDgzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0Mzc1MA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446243750", "bodyText": "This should continue to return a Version, not a VersionOrdinal.  We already have a method for getting the ordinal.", "author": "bschuchardt", "createdAt": "2020-06-26T15:11:06Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/membership/InternalDistributedMember.java", "diffHunk": "@@ -549,7 +550,7 @@ public void setVersionObjectForTest(Version v) {\n   }\n \n   @Override\n-  public Version getVersionObject() {\n+  public VersionOrdinal getVersionObject() {", "originalCommit": "a8ba7f23349b52d9558978a12cc0276618c4c921", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM1NDE3Mw==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446354173", "bodyText": "Since IDM isa MemberIdentifier this (overridden) method has to return a VersionOrdinal not a Version since, in general, a MemberIdentifier can be for a member that is running an unknown software version.\nI'm renaming MemberIdentifier.getVersionObject() => MemberIdentifier.getVersionOrdinalObject().\nTo summarize the state of IDM version methods this is what it looks like now:\n  // inherited from MemberIdentifier. It has a new name to make the return type explicit\n  @Override\n  public VersionOrdinal getVersionOrdinalObject() {\u2026}\n\n  /**\n   * If this member runs a version known in this JVM then return that Version.\n   * If this member does not run a known version then return Version.CURRENT.\n   *\n   * In various serialization scenarios we want the well-known version for this\n   * member, or, if it doesn't have a well-known version, we want the current\n   * (in this JVM) software version. Rather than have that logic spread around in\n   * the serialization code, it is centralized here.\n   */\n  public Version getVersionObject() {\u2026}\nWe still have lots of ways to get a Version from a short version ordinal. Version class has these static methods:\n\nfromOrdinal(short ordinal) throws UnsupportedSerializationVersionException\nfromOrdinalOrCurrent(short ordinal)\nfromOrdinalNoThrow(short ordinal, boolean returnNullForCurrent)\n\nThere is some unfortunate duplication in those methods. Consolidating that logic is beyond the scope of this PR.", "author": "Bill", "createdAt": "2020-06-26T18:50:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0Mzc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NTI2OA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446245268", "bodyText": "same comment about retaining the use of Version in all serialization code.  We need assurance in place that we will never encounter an unknown ordinal during serialization/deserialization.", "author": "bschuchardt", "createdAt": "2020-06-26T15:13:31Z", "path": "geode-core/src/main/java/org/apache/geode/internal/HeapDataOutputStream.java", "diffHunk": "@@ -48,7 +49,7 @@\n     org.apache.geode.internal.serialization.BufferDataOutputStream\n     implements ObjToByteArraySerializer, ByteBufferWriter {\n \n-  public HeapDataOutputStream(Version version) {\n+  public HeapDataOutputStream(VersionOrdinal version) {", "originalCommit": "a8ba7f23349b52d9558978a12cc0276618c4c921", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3MDU4OQ==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446470589", "bodyText": "fixed", "author": "Bill", "createdAt": "2020-06-27T01:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0NTI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0ODMzMA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446248330", "bodyText": "could this find the name of a Version and use it?  Alternatively just use \"VersionOrdinal\" instead of \"UNKNOWN\"", "author": "bschuchardt", "createdAt": "2020-06-26T15:18:57Z", "path": "geode-serialization/src/main/java/org/apache/geode/internal/serialization/VersionOrdinalImpl.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.internal.serialization;\n+\n+public class VersionOrdinalImpl implements VersionOrdinal {\n+\n+  protected final short ordinal;\n+\n+  public VersionOrdinalImpl(final short ordinal) {\n+    this.ordinal = ordinal;\n+  }\n+\n+  @Override\n+  public short ordinal() {\n+    return ordinal;\n+  }\n+\n+  @Override\n+  public int compareTo(final VersionOrdinal other) {\n+    if (other == null) {\n+      return 1;\n+    } else {\n+      return compareTo(other.ordinal());\n+    }\n+  }\n+\n+  /**\n+   * TODO: eliminate this legacy method in favor of requiring callers to construct a\n+   * VersionOrdinalImpl. Inline this logic up in compareTo(VersionOrdinal).\n+   */\n+  public int compareTo(final short other) {\n+    // short min/max can't overflow int, so use (a-b)\n+    final int thisOrdinal = this.ordinal;\n+    final int otherOrdinal = other;\n+    return thisOrdinal - otherOrdinal;\n+  }\n+\n+  @Override\n+  public boolean equals(final Object other) {\n+    if (other == this)\n+      return true;\n+    if (other instanceof VersionOrdinalImpl) {\n+      return this.ordinal == ((VersionOrdinalImpl) other).ordinal;\n+    } else {\n+      return false;\n+    }\n+  }\n+\n+  public boolean equals(final VersionOrdinal other) {\n+    return other != null && this.ordinal == other.ordinal();\n+  }\n+\n+  @Override\n+  public int hashCode() {\n+    int result = 17;\n+    final int mult = 37;\n+    result = mult * result + this.ordinal;\n+    return result;\n+  }\n+\n+  @Override\n+  public String toString() {\n+    return toString(ordinal);\n+  }\n+\n+  /**\n+   * TODO: eliminate this legacy method in favor of requiring callers to construct a\n+   * VersionOrdinalImpl. Inline this logic up in toString().\n+   */\n+  public static String toString(short ordinal) {\n+    return \"UNKNOWN[ordinal=\" + ordinal + ']';", "originalCommit": "a8ba7f23349b52d9558978a12cc0276618c4c921", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3MDU5NA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446470594", "bodyText": "fixed", "author": "Bill", "createdAt": "2020-06-27T01:58:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjI0ODMzMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNjUwOQ==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446436509", "bodyText": "we should have a null check on 'other' here", "author": "luissson", "createdAt": "2020-06-26T22:26:10Z", "path": "geode-serialization/src/main/java/org/apache/geode/internal/serialization/VersionOrdinalImpl.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.internal.serialization;\n+\n+public class VersionOrdinalImpl implements VersionOrdinal {\n+\n+  protected final short ordinal;\n+\n+  public VersionOrdinalImpl(final short ordinal) {\n+    this.ordinal = ordinal;\n+  }\n+\n+  @Override\n+  public short ordinal() {\n+    return ordinal;\n+  }\n+\n+  @Override\n+  public int compareTo(final VersionOrdinal other) {\n+    if (other == null) {\n+      return 1;\n+    } else {\n+      return compareTo(other.ordinal());\n+    }\n+  }\n+\n+  /**\n+   * TODO: eliminate this legacy method in favor of requiring callers to construct a\n+   * VersionOrdinalImpl. Inline this logic up in compareTo(VersionOrdinal).\n+   */\n+  public int compareTo(final short other) {\n+    // short min/max can't overflow int, so use (a-b)\n+    final int thisOrdinal = this.ordinal;\n+    final int otherOrdinal = other;\n+    return thisOrdinal - otherOrdinal;\n+  }\n+\n+  @Override\n+  public boolean equals(final Object other) {\n+    if (other == this)", "originalCommit": "a8ba7f23349b52d9558978a12cc0276618c4c921", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3MDk2Mw==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446470963", "bodyText": "I think we are ok. If other is null then it cannot be equal to this.\nif other is null the instanceof check will return false", "author": "Bill", "createdAt": "2020-06-27T02:01:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQzNjUwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NTgxMQ==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446445811", "bodyText": "the return here may be either Version or VersionOrdinal, do we want to upcast or downcast to ensure returning a single type? Doesn't appear to be a problem currently though", "author": "luissson", "createdAt": "2020-06-26T23:04:45Z", "path": "geode-serialization/src/main/java/org/apache/geode/internal/serialization/internal/AbstractSerializationContext.java", "diffHunk": "@@ -25,10 +26,10 @@\n  */\n public abstract class AbstractSerializationContext {\n \n-  <IO> Version getVersionForDataStream(final IO in) {\n+  <IO> VersionOrdinal getVersionForDataStream(final IO in) {\n     // check if this is a versioned data input\n     if (in instanceof VersionedDataStream) {\n-      final Version v = ((VersionedDataStream) in).getVersion();\n+      final VersionOrdinal v = ((VersionedDataStream) in).getVersion();\n       return v != null ? v : Version.getCurrentVersion();", "originalCommit": "a8ba7f23349b52d9558978a12cc0276618c4c921", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ3MDg1Nw==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446470857", "bodyText": "\"fixed\" this code by reverting it to deal exclusively with Version as before the PR", "author": "Bill", "createdAt": "2020-06-27T02:00:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjQ0NTgxMQ=="}], "type": "inlineReview"}, {"oid": "d063a77958dc70d828c7c167be3e24891ed2a836", "url": "https://github.com/apache/geode/commit/d063a77958dc70d828c7c167be3e24891ed2a836", "message": "GEODE-8240: don't use VersionOrdinal in versioned streams", "committedDate": "2020-06-27T01:55:28Z", "type": "commit"}, {"oid": "91bcf6b46d3293e6cda764cf08cc1999035827f3", "url": "https://github.com/apache/geode/commit/91bcf6b46d3293e6cda764cf08cc1999035827f3", "message": "GEODE-8240: fix compile error", "committedDate": "2020-06-27T16:17:13Z", "type": "commit"}, {"oid": "2497fec767600845eef78fe56bb4d1215fa059b7", "url": "https://github.com/apache/geode/commit/2497fec767600845eef78fe56bb4d1215fa059b7", "message": "GEODE-8240: fix core sanctionedDataSerializables.txt; introduce Versioning factory", "committedDate": "2020-06-27T16:58:49Z", "type": "commit"}, {"oid": "124fd801dc63bbddb157b1770711cc525dd27144", "url": "https://github.com/apache/geode/commit/124fd801dc63bbddb157b1770711cc525dd27144", "message": "GEODE-8240: spA", "committedDate": "2020-06-27T17:15:27Z", "type": "commit"}, {"oid": "be8959930144f7ec8f203365dc8e0cfda8109a03", "url": "https://github.com/apache/geode/commit/be8959930144f7ec8f203365dc8e0cfda8109a03", "message": "GEODE-8240: fix NPE in Configuration.fromData()", "committedDate": "2020-06-27T18:52:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMDI0OQ==", "url": "https://github.com/apache/geode/pull/5273#discussion_r446910249", "bodyText": "The shutdown command had also issues. That's why the variable was there initially in the test case.\nCould you add the execution of the shutdown command after the list members in order to verify that with your solution it works?\nOtherwise, the variable must be removed.", "author": "albertogpz", "createdAt": "2020-06-29T11:50:54Z", "path": "geode-core/src/upgradeTest/java/org/apache/geode/internal/cache/rollingupgrade/RollingUpgradeDUnitTest.java", "diffHunk": "@@ -191,20 +207,26 @@ void doTestRollAll(String regionType, String objectType, String startingVersion)\n       }\n \n       putAndVerify(objectType, server1, regionName, 0, 10, server2);\n-      locator = rollLocatorToCurrent(locator, hostName, locatorPorts[0], getTestMethodName(),\n-          locatorString);\n+      locator =\n+          rollLocatorToCurrent(locator, hostName, locatorPort, locatorProps, getTestMethodName(),\n+              locatorString);\n \n       server1 = rollServerToCurrentAndCreateRegion(server1, regionType, testingDirs[0],\n-          shortcutName, regionName, locatorPorts);\n+          shortcutName, regionName, new int[] {locatorPort});\n       verifyValues(objectType, regionName, 0, 10, server1);\n       putAndVerify(objectType, server1, regionName, 5, 15, server2);\n       putAndVerify(objectType, server2, regionName, 10, 20, server1);\n \n       server2 = rollServerToCurrentAndCreateRegion(server2, regionType, testingDirs[1],\n-          shortcutName, regionName, locatorPorts);\n+          shortcutName, regionName, ports);\n       verifyValues(objectType, regionName, 0, 10, server2);\n       putAndVerify(objectType, server2, regionName, 15, 25, server1);\n \n+      String shutDownCommand = \"shutdown --include-locators=true\";", "originalCommit": "be8959930144f7ec8f203365dc8e0cfda8109a03", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzE4MTUwMA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r447181500", "bodyText": "My latest commit eliminates gfsh entirely so the issue with shutDownCommand is moot.\nI eliminated use of gfsh because I found the test had become flaky on versions 1.3.0-1.8.0, at least on macOS. On Linux (CI) I did not see the flakiness. But rather than figuring that out, I decided to grab the view more directly: by accessing InternalDistributedSystem in the locator JVM.", "author": "Bill", "createdAt": "2020-06-29T18:50:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMDI0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQzNDYyMA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r447434620", "bodyText": "Overall, great work. Thanks, Bill.", "author": "albertogpz", "createdAt": "2020-06-30T06:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjkxMDI0OQ=="}], "type": "inlineReview"}, {"oid": "f582bba890a40ba700dd5f8dcd7273d10b5a5428", "url": "https://github.com/apache/geode/commit/f582bba890a40ba700dd5f8dcd7273d10b5a5428", "message": "eliminate rolling upgrade test flakiness by eliminating gfsh", "committedDate": "2020-06-29T18:46:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MjE3MA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r447282170", "bodyText": "VersionOrdinal's methods should take VersionOrdinal arguments.", "author": "bschuchardt", "createdAt": "2020-06-29T22:08:00Z", "path": "geode-serialization/src/main/java/org/apache/geode/internal/serialization/VersionOrdinal.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.internal.serialization;\n+\n+/**\n+ * VersionOrdinal is able to represent not only currently-known\n+ * Geode versions but future versions as well. This is necessary\n+ * because during rolling upgrades Geode manipulates member\n+ * identifiers for members running newer versions of the software.\n+ * In that case we receive the ordinal over the network\n+ * (serialization) but we don't know other version details such as\n+ * major/minor/patch version, which are known to the Version class.\n+ *\n+ * Implementations must define equals() and hashCode() based on\n+ * ordinal() result. And since this interface extends Comparable,\n+ * implementations must define compareTo() as well.\n+ *\n+ * Unlike Version (a subtype of VersionOrdinal which acts like an\n+ * enumerated type), VersionOrdinal does not, in general, guarantee\n+ * that if vo1.equals(vo2) then vo1 == vo2.\n+ *\n+ * Use the Versioning factory class to construct objects implementing\n+ * this interface. All instances of known versions are defined as\n+ * constants in the Version class, e.g. Version.GEODE_1_11_0\n+ */\n+public interface VersionOrdinal extends Comparable<VersionOrdinal> {", "originalCommit": "f582bba890a40ba700dd5f8dcd7273d10b5a5428", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMyMzY0NA==", "url": "https://github.com/apache/geode/pull/5273#discussion_r447323644", "bodyText": "Corrected this and went one better: added a new unit test for VersionOrdinalImpl.", "author": "Bill", "createdAt": "2020-06-29T23:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI4MjE3MA=="}], "type": "inlineReview"}, {"oid": "86c7f24f24c867177bdd737f2c068ac7a89b1744", "url": "https://github.com/apache/geode/commit/86c7f24f24c867177bdd737f2c068ac7a89b1744", "message": "GEODE-8240: VersionOrdinalImpl unit test; correct signatures", "committedDate": "2020-06-29T23:50:08Z", "type": "commit"}, {"oid": "c34d0e73227837ac14aef49846c8069b81c713f4", "url": "https://github.com/apache/geode/commit/c34d0e73227837ac14aef49846c8069b81c713f4", "message": "GEODE_8240: mod test to ensure we're using interface refs not class refs", "committedDate": "2020-06-29T23:54:06Z", "type": "commit"}]}