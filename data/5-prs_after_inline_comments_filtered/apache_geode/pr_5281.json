{"pr_number": 5281, "pr_title": "Further rework of the RestoreRedundancy data objects for serialization", "pr_createdAt": "2020-06-19T23:38:25Z", "pr_url": "https://github.com/apache/geode/pull/5281", "timeline": [{"oid": "00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "url": "https://github.com/apache/geode/commit/00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "message": "Converting a Duration to a Long because of Serialization", "committedDate": "2020-06-23T20:33:06Z", "type": "commit"}, {"oid": "00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "url": "https://github.com/apache/geode/commit/00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "message": "Converting a Duration to a Long because of Serialization", "committedDate": "2020-06-23T20:33:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU1NjAzNw==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444556037", "bodyText": "This could be replaced with totalPrimaryTransferTime += details.getPrimaryTransferTime();", "author": "DonalEvans", "createdAt": "2020-06-23T23:06:54Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/control/SerializableRestoreRedundancyResultsImpl.java", "diffHunk": "@@ -39,7 +39,8 @@\n   public void addPrimaryReassignmentDetails(PartitionRebalanceInfo details) {\n     totalPrimaryTransfersCompleted += details.getPrimaryTransfersCompleted();\n     totalPrimaryTransferTime =\n-        totalPrimaryTransferTime.plusMillis(details.getPrimaryTransferTime());\n+        totalPrimaryTransferTime + details.getPrimaryTransferTime();", "originalCommit": "00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODI5NA==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444638294", "bodyText": "done", "author": "mhansonp", "createdAt": "2020-06-24T04:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU1NjAzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2MTY1NQ==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444561655", "bodyText": "This test sets multiple fields but does not verify all of them. Would it be possible to confirm that all data in the object is correctly serialized and deserialized, not just the message and status fields?", "author": "DonalEvans", "createdAt": "2020-06-23T23:25:08Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/control/SerializableRestoreRedundancyResultsImplTest.java", "diffHunk": "@@ -153,39 +157,64 @@ public void addRegionResultsAddsToCorrectInternalMapAndAddsPrimaryReassignmentDe\n     when(regionResults.getSatisfiedRedundancyRegionResults())\n         .thenReturn(Collections.singletonMap(successfulRegionName, successfulRegionResult));\n     when(regionResults.getTotalPrimaryTransfersCompleted()).thenReturn(transfersCompleted);\n-    when(regionResults.getTotalPrimaryTransferTime()).thenReturn(Duration.ofMillis(transferTime));\n+    when(regionResults.getTotalPrimaryTransferTime()).thenReturn(transferTime);\n \n     results.addRegionResults(regionResults);\n \n     Map<String, RegionRedundancyStatus> zeroRedundancyResults =\n         results.getZeroRedundancyRegionResults();\n-    assertThat(zeroRedundancyResults.size(), is(1));\n-    assertThat(zeroRedundancyResults.get(zeroRedundancyRegionName), is(zeroRedundancyRegionResult));\n+    assertThat(zeroRedundancyResults.size()).isEqualTo(1);\n+    assertThat(zeroRedundancyResults.get(zeroRedundancyRegionName))\n+        .isEqualTo(zeroRedundancyRegionResult);\n \n     Map<String, RegionRedundancyStatus> underRedundancyResults =\n         results.getUnderRedundancyRegionResults();\n-    assertThat(underRedundancyResults.size(), is(1));\n-    assertThat(underRedundancyResults.get(underRedundancyRegionName),\n-        is(underRedundancyRegionResult));\n+    assertThat(underRedundancyResults.size()).isEqualTo(1);\n+    assertThat(underRedundancyResults.get(underRedundancyRegionName))\n+        .isEqualTo(underRedundancyRegionResult);\n \n     Map<String, RegionRedundancyStatus> successfulRegionResults =\n         results.getSatisfiedRedundancyRegionResults();\n-    assertThat(successfulRegionResults.size(), is(1));\n-    assertThat(successfulRegionResults.get(successfulRegionName), is(successfulRegionResult));\n+    assertThat(successfulRegionResults.size()).isEqualTo(1);\n+    assertThat(successfulRegionResults.get(successfulRegionName)).isEqualTo(successfulRegionResult);\n \n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(transfersCompleted));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(transferTime));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(transfersCompleted);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(transferTime);\n   }\n \n   @Test\n   public void addPrimaryDetailsUpdatesValue() {\n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(0));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(0L));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(0);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(0L);\n     results.addPrimaryReassignmentDetails(details);\n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(transfersCompleted));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(transferTime));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(transfersCompleted);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(transferTime);\n     results.addPrimaryReassignmentDetails(details);\n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(transfersCompleted * 2));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(transferTime * 2));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(transfersCompleted * 2);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(transferTime * 2);\n+  }\n+\n+  @Test\n+  public void testSerializable() throws JsonProcessingException {", "originalCommit": "00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODI2MA==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444638260", "bodyText": "done. assertThat(value).isEqualToComparingFieldByField(restoreRedundancyResults);", "author": "mhansonp", "createdAt": "2020-06-24T04:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2MTY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2MzM1MQ==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444563351", "bodyText": "This can be replaced with totalPrimaryTransferTime += results.getTotalPrimaryTransferTime();", "author": "DonalEvans", "createdAt": "2020-06-23T23:30:46Z", "path": "geode-management/src/main/java/org/apache/geode/management/internal/operation/RestoreRedundancyResultsImpl.java", "diffHunk": "@@ -38,24 +37,55 @@\n   public static final String PRIMARY_TRANSFER_TIME = \"Total primary transfer time (ms) = \";\n   private static final long serialVersionUID = -1174735246756963521L;\n \n-  protected Map<String, RegionRedundancyStatus> zeroRedundancyRegions = new HashMap<>();\n-  protected Map<String, RegionRedundancyStatus> underRedundancyRegions = new HashMap<>();\n-  protected Map<String, RegionRedundancyStatus> satisfiedRedundancyRegions = new HashMap<>();\n+  protected Map<String, RegionRedundancyStatus> zeroRedundancyRegionsResults = new HashMap<>();\n+  protected Map<String, RegionRedundancyStatus> underRedundancyRegionsResults = new HashMap<>();\n+  protected Map<String, RegionRedundancyStatus> satisfiedRedundancyRegionsResults = new HashMap<>();\n \n   protected int totalPrimaryTransfersCompleted;\n-  protected Duration totalPrimaryTransferTime = Duration.ZERO;\n+  protected long totalPrimaryTransferTime = 0;\n   protected boolean success = true;\n   protected String statusMessage;\n   protected final List<String> includedRegionsWithNoMembers = new ArrayList<>();\n+  private RegionRedundancyStatus regionResult;\n+\n+  public void setZeroRedundancyRegionsResults(\n+      Map<String, RegionRedundancyStatus> zeroRedundancyRegionsResults) {\n+    this.zeroRedundancyRegionsResults = zeroRedundancyRegionsResults;\n+  }\n+\n+  public void setUnderRedundancyRegionsResults(\n+      Map<String, RegionRedundancyStatus> underRedundancyRegionsResults) {\n+    this.underRedundancyRegionsResults = underRedundancyRegionsResults;\n+  }\n+\n+  public void setSatisfiedRedundancyRegionsResults(\n+      Map<String, RegionRedundancyStatus> satisfiedRedundancyRegionsResults) {\n+    this.satisfiedRedundancyRegionsResults = satisfiedRedundancyRegionsResults;\n+  }\n+\n+  public void setTotalPrimaryTransfersCompleted(int totalPrimaryTransfersCompleted) {\n+    this.totalPrimaryTransfersCompleted = totalPrimaryTransfersCompleted;\n+  }\n+\n+  public void setTotalPrimaryTransferTime(long totalPrimaryTransferTime) {\n+    this.totalPrimaryTransferTime = totalPrimaryTransferTime;\n+  }\n+\n+  public void setRegionResult(RegionRedundancyStatus regionResult) {\n+    this.regionResult = regionResult;\n+  }\n+\n+\n+  public RestoreRedundancyResultsImpl() {}\n \n \n   public void addRegionResults(RestoreRedundancyResults results) {\n-    satisfiedRedundancyRegions.putAll(results.getSatisfiedRedundancyRegionResults());\n-    underRedundancyRegions.putAll(results.getUnderRedundancyRegionResults());\n-    zeroRedundancyRegions.putAll(results.getZeroRedundancyRegionResults());\n+    satisfiedRedundancyRegionsResults.putAll(results.getSatisfiedRedundancyRegionResults());\n+    underRedundancyRegionsResults.putAll(results.getUnderRedundancyRegionResults());\n+    zeroRedundancyRegionsResults.putAll(results.getZeroRedundancyRegionResults());\n     totalPrimaryTransfersCompleted += results.getTotalPrimaryTransfersCompleted();\n     totalPrimaryTransferTime =\n-        totalPrimaryTransferTime.plus(results.getTotalPrimaryTransferTime());\n+        totalPrimaryTransferTime + results.getTotalPrimaryTransferTime();", "originalCommit": "00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODU2Mw==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444638563", "bodyText": "done.", "author": "mhansonp", "createdAt": "2020-06-24T04:32:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDU2MzM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxOTM2OQ==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444619369", "bodyText": "you can use assertJ's isEqualToComparingFieldByField method to compare all the fields are the same", "author": "jinmeiliao", "createdAt": "2020-06-24T03:07:17Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/control/SerializableRestoreRedundancyResultsImplTest.java", "diffHunk": "@@ -153,39 +157,64 @@ public void addRegionResultsAddsToCorrectInternalMapAndAddsPrimaryReassignmentDe\n     when(regionResults.getSatisfiedRedundancyRegionResults())\n         .thenReturn(Collections.singletonMap(successfulRegionName, successfulRegionResult));\n     when(regionResults.getTotalPrimaryTransfersCompleted()).thenReturn(transfersCompleted);\n-    when(regionResults.getTotalPrimaryTransferTime()).thenReturn(Duration.ofMillis(transferTime));\n+    when(regionResults.getTotalPrimaryTransferTime()).thenReturn(transferTime);\n \n     results.addRegionResults(regionResults);\n \n     Map<String, RegionRedundancyStatus> zeroRedundancyResults =\n         results.getZeroRedundancyRegionResults();\n-    assertThat(zeroRedundancyResults.size(), is(1));\n-    assertThat(zeroRedundancyResults.get(zeroRedundancyRegionName), is(zeroRedundancyRegionResult));\n+    assertThat(zeroRedundancyResults.size()).isEqualTo(1);\n+    assertThat(zeroRedundancyResults.get(zeroRedundancyRegionName))\n+        .isEqualTo(zeroRedundancyRegionResult);\n \n     Map<String, RegionRedundancyStatus> underRedundancyResults =\n         results.getUnderRedundancyRegionResults();\n-    assertThat(underRedundancyResults.size(), is(1));\n-    assertThat(underRedundancyResults.get(underRedundancyRegionName),\n-        is(underRedundancyRegionResult));\n+    assertThat(underRedundancyResults.size()).isEqualTo(1);\n+    assertThat(underRedundancyResults.get(underRedundancyRegionName))\n+        .isEqualTo(underRedundancyRegionResult);\n \n     Map<String, RegionRedundancyStatus> successfulRegionResults =\n         results.getSatisfiedRedundancyRegionResults();\n-    assertThat(successfulRegionResults.size(), is(1));\n-    assertThat(successfulRegionResults.get(successfulRegionName), is(successfulRegionResult));\n+    assertThat(successfulRegionResults.size()).isEqualTo(1);\n+    assertThat(successfulRegionResults.get(successfulRegionName)).isEqualTo(successfulRegionResult);\n \n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(transfersCompleted));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(transferTime));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(transfersCompleted);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(transferTime);\n   }\n \n   @Test\n   public void addPrimaryDetailsUpdatesValue() {\n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(0));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(0L));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(0);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(0L);\n     results.addPrimaryReassignmentDetails(details);\n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(transfersCompleted));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(transferTime));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(transfersCompleted);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(transferTime);\n     results.addPrimaryReassignmentDetails(details);\n-    assertThat(results.getTotalPrimaryTransfersCompleted(), is(transfersCompleted * 2));\n-    assertThat(results.getTotalPrimaryTransferTime().toMillis(), is(transferTime * 2));\n+    assertThat(results.getTotalPrimaryTransfersCompleted()).isEqualTo(transfersCompleted * 2);\n+    assertThat(results.getTotalPrimaryTransferTime()).isEqualTo(transferTime * 2);\n+  }\n+\n+  @Test\n+  public void testSerializable() throws JsonProcessingException {\n+\n+    RestoreRedundancyResultsImpl restoreRedundancyResults = new RestoreRedundancyResultsImpl();\n+    restoreRedundancyResults.setStatusMessage(\"Test\");\n+    restoreRedundancyResults.setSuccess(true);\n+    restoreRedundancyResults.setTotalPrimaryTransfersCompleted(150);\n+    restoreRedundancyResults.setTotalPrimaryTransferTime(250);\n+    RegionRedundancyStatusImpl regionRedundancyStatus = new RegionRedundancyStatusImpl();\n+    regionRedundancyStatus.setActualRedundancy(1);\n+    regionRedundancyStatus.setConfiguredRedundancy(1);\n+    regionRedundancyStatus.setRegionName(\"/foo\");\n+    regionRedundancyStatus.setStatus(SATISFIED);\n+    restoreRedundancyResults.addRegionResult(regionRedundancyStatus);\n+    String jsonString = geodeMapper.writeValueAsString(restoreRedundancyResults);\n+    // deserialize the class\n+    RestoreRedundancyResultsImpl value =", "originalCommit": "00385e14cb30197fe0e9a3fd9a37b7110c188a6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYzODY4Ng==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444638686", "bodyText": "done", "author": "mhansonp", "createdAt": "2020-06-24T04:33:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxOTM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDk4MTIxNg==", "url": "https://github.com/apache/geode/pull/5281#discussion_r444981216", "bodyText": "did you forget to push your commit?", "author": "jinmeiliao", "createdAt": "2020-06-24T15:28:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxOTM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAxOTIzNg==", "url": "https://github.com/apache/geode/pull/5281#discussion_r445019236", "bodyText": "Nope it is failing... It doesn't like the objects in the satisfiedregion lists.", "author": "mhansonp", "createdAt": "2020-06-24T16:26:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxOTM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAxOTU0OA==", "url": "https://github.com/apache/geode/pull/5281#discussion_r445019548", "bodyText": "sorry hash maps.", "author": "mhansonp", "createdAt": "2020-06-24T16:26:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxOTM2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAzNDY3MA==", "url": "https://github.com/apache/geode/pull/5281#discussion_r445034670", "bodyText": "assertThat(value).usingRecursiveComparison().isEqualTo(restoreRedundancyResults);\n\nworked", "author": "mhansonp", "createdAt": "2020-06-24T16:51:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDYxOTM2OQ=="}], "type": "inlineReview"}, {"oid": "81e4b4c5ee196680203bbbc65020a50867a468d8", "url": "https://github.com/apache/geode/commit/81e4b4c5ee196680203bbbc65020a50867a468d8", "message": "Changes for per requests", "committedDate": "2020-06-24T16:50:42Z", "type": "commit"}]}