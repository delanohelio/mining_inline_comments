{"pr_number": 4629, "pr_title": "GEODE-7727: modify sender thread to detect release of connection", "pr_createdAt": "2020-01-24T16:03:34Z", "pr_url": "https://github.com/apache/geode/pull/4629", "timeline": [{"oid": "3a33eec73850f34c2a5e453f819c2a1fa09873b2", "url": "https://github.com/apache/geode/commit/3a33eec73850f34c2a5e453f819c2a1fa09873b2", "message": "GEODE-7727: modify sender thread to detect relese of connection", "committedDate": "2020-02-10T23:43:43Z", "type": "commit"}, {"oid": "d604444044a566e2a03b44d60ae647751d89057e", "url": "https://github.com/apache/geode/commit/d604444044a566e2a03b44d60ae647751d89057e", "message": "GEODE-7727: Update solution only for shared connections", "committedDate": "2020-02-11T10:08:47Z", "type": "commit"}, {"oid": "d604444044a566e2a03b44d60ae647751d89057e", "url": "https://github.com/apache/geode/commit/d604444044a566e2a03b44d60ae647751d89057e", "message": "GEODE-7727: Update solution only for shared connections", "committedDate": "2020-02-11T10:08:47Z", "type": "forcePushed"}, {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "url": "https://github.com/apache/geode/commit/7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "message": "GEODE-7727: added test", "committedDate": "2020-02-13T15:09:34Z", "type": "commit"}, {"oid": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "url": "https://github.com/apache/geode/commit/7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "message": "GEODE-7727: added test", "committedDate": "2020-02-13T15:09:34Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk1MDkyNw==", "url": "https://github.com/apache/geode/pull/4629#discussion_r378950927", "bodyText": "can this be turned into an await()?  Thread.sleep() often causes tests to fail.", "author": "bschuchardt", "createdAt": "2020-02-13T15:55:18Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/internal/tcp/TCPConduitDUnitTest.java", "diffHunk": "@@ -113,6 +114,46 @@ public void basicAcceptConnection() throws Exception {\n     }\n   }\n \n+\n+  @Test\n+  public void testClosingOfSenderConnections() throws Exception {\n+    final VM vm1 = VM.getVM(1);\n+    final VM vm2 = VM.getVM(2);\n+    final VM vm3 = VM.getVM(3);\n+\n+    disconnectAllFromDS();\n+\n+    int port = startLocator();\n+    properties.put(ConfigurationProperties.LOCATORS, \"localhost[\" + port + \"]\");\n+\n+    vm1.invoke(() -> startServer(properties));\n+    vm2.invoke(() -> startServer(properties));\n+    vm3.invoke(() -> startServer(properties));\n+\n+    Thread.sleep(5000);", "originalCommit": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDM0MA==", "url": "https://github.com/apache/geode/pull/4629#discussion_r378970340", "bodyText": "The (!isHandShakeReader) test was added here to fix a race condition between the handshake thread and an application thread using the thread-owned Connection.  I think this test needs to remain in place.", "author": "bschuchardt", "createdAt": "2020-02-13T16:25:08Z", "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1692,10 +1700,8 @@ private void readMessages() {\n         }\n       }\n     } finally {\n-      if (!isHandShakeReader) {\n-        synchronized (stateLock) {\n-          connectionState = STATE_IDLE;\n-        }\n+      synchronized (stateLock) {", "originalCommit": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAxODc4Mg==", "url": "https://github.com/apache/geode/pull/4629#discussion_r379018782", "bodyText": "thanks for comments. I will return check on !isHandShakeReader.", "author": "mivanac", "createdAt": "2020-02-13T17:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk3MDM0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4MDk5OA==", "url": "https://github.com/apache/geode/pull/4629#discussion_r378980998", "bodyText": "handshakeRead and handshakeCancelled are only set to true in notifyHandshakeWaiter().  Why do we need to call that method again in this spot?", "author": "bschuchardt", "createdAt": "2020-02-13T16:41:26Z", "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1637,8 +1640,13 @@ private void readMessages() {\n               }\n             }\n             isHandShakeReader = true;\n-            // Once we have read the handshake the reader can go away\n-            break;\n+            notifyHandshakeWaiter(false);", "originalCommit": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTAxOTQxNw==", "url": "https://github.com/apache/geode/pull/4629#discussion_r379019417", "bodyText": "updated", "author": "mivanac", "createdAt": "2020-02-13T17:47:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4MDk5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODk4Mjk5Nw==", "url": "https://github.com/apache/geode/pull/4629#discussion_r378982997", "bodyText": "good change here.  It shouldn't be needed since a sharedResource will only invoke this method if isReaderThread==true but having an explicit test is a good idea.", "author": "bschuchardt", "createdAt": "2020-02-13T16:44:46Z", "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/Connection.java", "diffHunk": "@@ -1637,8 +1640,13 @@ private void readMessages() {\n               }\n             }\n             isHandShakeReader = true;\n-            // Once we have read the handshake the reader can go away\n-            break;\n+            notifyHandshakeWaiter(false);\n+            // Once we have read the handshake for unshared connections, the reader can skip\n+            // processing messages\n+            if (!sharedResource) {", "originalCommit": "7e9c7d46e58ef1fc08a7ad7bacd9356aa70ff225", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "072377db29986041433c9f39041e33dc002e5f72", "url": "https://github.com/apache/geode/commit/072377db29986041433c9f39041e33dc002e5f72", "message": "GEODE-7727: update ater comments", "committedDate": "2020-02-13T18:36:29Z", "type": "commit"}, {"oid": "072377db29986041433c9f39041e33dc002e5f72", "url": "https://github.com/apache/geode/commit/072377db29986041433c9f39041e33dc002e5f72", "message": "GEODE-7727: update ater comments", "committedDate": "2020-02-13T18:36:29Z", "type": "forcePushed"}, {"oid": "3b256f77434acbf0072a5b38220e3dd0dc8dded3", "url": "https://github.com/apache/geode/commit/3b256f77434acbf0072a5b38220e3dd0dc8dded3", "message": "GEODE-7727: update test", "committedDate": "2020-02-13T21:21:20Z", "type": "commit"}]}