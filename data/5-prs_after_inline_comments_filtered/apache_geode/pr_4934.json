{"pr_number": 4934, "pr_title": "GEODE-7940: Fix Tracking of ShadowBuckets Destroyed", "pr_createdAt": "2020-04-09T11:10:53Z", "pr_url": "https://github.com/apache/geode/pull/4934", "timeline": [{"oid": "e69ba7fef85df3610b13ade240d71c44d742f3dc", "url": "https://github.com/apache/geode/commit/e69ba7fef85df3610b13ade240d71c44d742f3dc", "message": "GEODE-7940: Fix Track of ShadowBuckets Destroyed\n\nThe BucketAdvisor can now keep track of more than just one shadow\nbucket to avoid incorrectly marking all of them as destroyed.\n\n- Added unit and distributed tests.", "committedDate": "2020-04-09T11:08:25Z", "type": "commit"}, {"oid": "1368aa290fcaa8adbb208a1262df5e762740b9d5", "url": "https://github.com/apache/geode/commit/1368aa290fcaa8adbb208a1262df5e762740b9d5", "message": "- Rename some methods.\n- Improve 'markAllShadowBucketsAsNonDestroyed' implementation.", "committedDate": "2020-04-14T14:10:35Z", "type": "commit"}, {"oid": "9e1f15a19aee7a30af5de8bac8f1cb5592e4ad31", "url": "https://github.com/apache/geode/commit/9e1f15a19aee7a30af5de8bac8f1cb5592e4ad31", "message": "- Fix tests.", "committedDate": "2020-04-14T15:00:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5NzY4Ng==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408297686", "bodyText": "just a thought, would this simplify to :\nboolean thisBucketDestroyed = brq.isDestroyed();\nif (!isDREvent) {\nthisBucketDestroyed |= prQ.getColocatedWithRegion()...;\n}", "author": "jhuynh1", "createdAt": "2020-04-14T17:07:24Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/parallel/ParallelGatewaySenderQueue.java", "diffHunk": "@@ -790,17 +790,17 @@ public boolean put(Object object) throws InterruptedException, CacheException {\n           LocalRegion.setThreadInitLevelRequirement(oldLevel);\n         }\n       } else {\n-        boolean thisbucketDestroyed = false;\n+        boolean thisBucketDestroyed;", "originalCommit": "9e1f15a19aee7a30af5de8bac8f1cb5592e4ad31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY4MTM3OA==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408681378", "bodyText": "Changed!.", "author": "jujoramos", "createdAt": "2020-04-15T08:48:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5NzY4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5OTM0OA==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408299348", "bodyText": "Pulling this out will always construct this string now.  Any ideas on perf impact?", "author": "jhuynh1", "createdAt": "2020-04-14T17:10:03Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/parallel/ParallelGatewaySenderQueue.java", "diffHunk": "@@ -701,17 +701,17 @@ public boolean put(Object object) throws InterruptedException, CacheException {\n     AbstractBucketRegionQueue brq =\n         (AbstractBucketRegionQueue) prQ.getDataStore().getLocalBucketById(bucketId);\n \n+    // Full path of the bucket:\n+    final String bucketFullPath =", "originalCommit": "9e1f15a19aee7a30af5de8bac8f1cb5592e4ad31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5MDMxOA==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408690318", "bodyText": "Good point, I haven't ran any performance tests related to the change.\nI've refactored the first part of the String as a constant and moved the initialisation only to places where is needed, hopefully this will reduce the impact. Let me know if you think that's enough.", "author": "jujoramos", "createdAt": "2020-04-15T09:02:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI5OTM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMwMDA5Mw==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408300093", "bodyText": "No change needed, but there might be a way to do this with a stream filter instead .", "author": "jhuynh1", "createdAt": "2020-04-14T17:11:24Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/BucketAdvisorTest.java", "diffHunk": "@@ -150,4 +155,42 @@ public void volunteerForPrimaryIgnoresMissingPrimaryElector() {\n     advisorSpy.volunteerForPrimary();\n     verify(volunteeringDelegate).volunteerForPrimary();\n   }\n+\n+  @Test\n+  public void shadowBucketsDestroyedTrackingShouldWorkCorrectly() {\n+    DistributionManager distributionManager = mock(DistributionManager.class);\n+    when(distributionManager.getId()).thenReturn(new InternalDistributedMember(\"localhost\", 321));\n+\n+    Bucket bucket = mock(Bucket.class);\n+    when(bucket.isHosting()).thenReturn(true);\n+    when(bucket.isPrimary()).thenReturn(false);\n+    when(bucket.getDistributionManager()).thenReturn(distributionManager);\n+\n+    PartitionedRegion partitionedRegion = mock(PartitionedRegion.class);\n+    when(partitionedRegion.getRedundantCopies()).thenReturn(0);\n+    when(partitionedRegion.getPartitionAttributes()).thenReturn(new PartitionAttributesImpl());\n+    RegionAdvisor regionAdvisor = mock(RegionAdvisor.class);\n+    when(regionAdvisor.getPartitionedRegion()).thenReturn(partitionedRegion);\n+\n+    List<String> shadowBuckets = Arrays.asList(\"/bucket1\", \"/bucket2\", \"/bucket3\");\n+    BucketAdvisor bucketAdvisor = BucketAdvisor.createBucketAdvisor(bucket, regionAdvisor);\n+    shadowBuckets.forEach(bucketAdvisor::markShadowBucketAsDestroyed);\n+\n+    // Return false by default.\n+    assertThat(bucketAdvisor.isShadowBucketDestroyed(\"/bucket\")).isFalse();\n+\n+    // Return correct value when found.\n+    bucketAdvisor.markShadowBucketAsDestroyed(shadowBuckets.get(1));\n+    assertThat(bucketAdvisor.isShadowBucketDestroyed(shadowBuckets.get(1))).isTrue();\n+\n+    // Mark all shadow buckets values as destroyed\n+    bucketAdvisor.markAllShadowBucketsAsDestroyed();\n+    shadowBuckets", "originalCommit": "9e1f15a19aee7a30af5de8bac8f1cb5592e4ad31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMTc2MQ==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408701761", "bodyText": "\ud83d\udc4d", "author": "jujoramos", "createdAt": "2020-04-15T09:22:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMwMDA5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMwMDk4Mw==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408300983", "bodyText": "maybe break this into two tests, one just for marking?  it might seem redundant so it's up to you", "author": "jhuynh1", "createdAt": "2020-04-14T17:12:54Z", "path": "geode-core/src/test/java/org/apache/geode/internal/cache/BucketAdvisorTest.java", "diffHunk": "@@ -150,4 +155,42 @@ public void volunteerForPrimaryIgnoresMissingPrimaryElector() {\n     advisorSpy.volunteerForPrimary();\n     verify(volunteeringDelegate).volunteerForPrimary();\n   }\n+\n+  @Test\n+  public void shadowBucketsDestroyedTrackingShouldWorkCorrectly() {\n+    DistributionManager distributionManager = mock(DistributionManager.class);\n+    when(distributionManager.getId()).thenReturn(new InternalDistributedMember(\"localhost\", 321));\n+\n+    Bucket bucket = mock(Bucket.class);\n+    when(bucket.isHosting()).thenReturn(true);\n+    when(bucket.isPrimary()).thenReturn(false);\n+    when(bucket.getDistributionManager()).thenReturn(distributionManager);\n+\n+    PartitionedRegion partitionedRegion = mock(PartitionedRegion.class);\n+    when(partitionedRegion.getRedundantCopies()).thenReturn(0);\n+    when(partitionedRegion.getPartitionAttributes()).thenReturn(new PartitionAttributesImpl());\n+    RegionAdvisor regionAdvisor = mock(RegionAdvisor.class);\n+    when(regionAdvisor.getPartitionedRegion()).thenReturn(partitionedRegion);\n+\n+    List<String> shadowBuckets = Arrays.asList(\"/bucket1\", \"/bucket2\", \"/bucket3\");\n+    BucketAdvisor bucketAdvisor = BucketAdvisor.createBucketAdvisor(bucket, regionAdvisor);\n+    shadowBuckets.forEach(bucketAdvisor::markShadowBucketAsDestroyed);\n+\n+    // Return false by default.\n+    assertThat(bucketAdvisor.isShadowBucketDestroyed(\"/bucket\")).isFalse();\n+\n+    // Return correct value when found.\n+    bucketAdvisor.markShadowBucketAsDestroyed(shadowBuckets.get(1));\n+    assertThat(bucketAdvisor.isShadowBucketDestroyed(shadowBuckets.get(1))).isTrue();\n+\n+    // Mark all shadow buckets values as destroyed\n+    bucketAdvisor.markAllShadowBucketsAsDestroyed();\n+    shadowBuckets\n+        .forEach(b -> assertThat(assertThat(bucketAdvisor.isShadowBucketDestroyed(b)).isTrue()));\n+\n+    // Mark all shadow buckets values as non destroyed\n+    bucketAdvisor.markAllShadowBucketsAsNonDestroyed();", "originalCommit": "9e1f15a19aee7a30af5de8bac8f1cb5592e4ad31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcwMTgzNA==", "url": "https://github.com/apache/geode/pull/4934#discussion_r408701834", "bodyText": "Changed!", "author": "jujoramos", "createdAt": "2020-04-15T09:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODMwMDk4Mw=="}], "type": "inlineReview"}, {"oid": "0400d7ce921e50c65b1ba1e23c1c647380ce920f", "url": "https://github.com/apache/geode/commit/0400d7ce921e50c65b1ba1e23c1c647380ce920f", "message": "- Changes requested by reviewers.", "committedDate": "2020-04-15T09:23:19Z", "type": "commit"}]}