{"pr_number": 4824, "pr_title": "GEODE-7565: Allow gateway receivers with same host and port", "pr_createdAt": "2020-03-18T14:59:48Z", "pr_url": "https://github.com/apache/geode/pull/4824", "timeline": [{"oid": "b180869c73095e7a810ba2e1c92e243a0220e888", "url": "https://github.com/apache/geode/commit/b180869c73095e7a810ba2e1c92e243a0220e888", "message": "GEODE-7565: GW sender connection failover", "committedDate": "2020-03-18T14:25:45Z", "type": "commit"}, {"oid": "8ec3ee4461e4fdd744f519fd600cb863cdae73d3", "url": "https://github.com/apache/geode/commit/8ec3ee4461e4fdd744f519fd600cb863cdae73d3", "message": "Temp workaround for hanging test case", "committedDate": "2020-03-18T15:07:40Z", "type": "forcePushed"}, {"oid": "39bb45d9f45f91713c0fa37f90b5009dfc563441", "url": "https://github.com/apache/geode/commit/39bb45d9f45f91713c0fa37f90b5009dfc563441", "message": "GEODE-7565: gw sender pings not reaching gw receivers", "committedDate": "2020-03-18T15:14:22Z", "type": "commit"}, {"oid": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "url": "https://github.com/apache/geode/commit/0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "message": "Temp workaround for hanging test case", "committedDate": "2020-03-18T15:20:48Z", "type": "commit"}, {"oid": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "url": "https://github.com/apache/geode/commit/0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "message": "Temp workaround for hanging test case", "committedDate": "2020-03-18T15:20:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3NDMyNg==", "url": "https://github.com/apache/geode/pull/4824#discussion_r398774326", "bodyText": "why is this timeout needed?", "author": "bschuchardt", "createdAt": "2020-03-26T17:52:51Z", "path": "geode-core/src/integrationTest/java/org/apache/geode/cache/client/internal/ConnectionPoolImplJUnitTest.java", "diffHunk": "@@ -168,7 +168,7 @@ public void testCacheClose() throws Exception {\n     assertTrue(pool2.isDestroyed());\n   }\n \n-  @Test\n+  @Test(timeout = 5000)", "originalCommit": "0968b2e9bf7e6a3f3b46cf0f779cff3f8bc2dcac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5NjM4Ng==", "url": "https://github.com/apache/geode/pull/4824#discussion_r398796386", "bodyText": "This test case enters in a infinite loop, I still have to fix it. This timeout is a temporary workaround to make it fail, so the CI can at least finish.", "author": "alb3rtobr", "createdAt": "2020-03-26T18:24:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc3NDMyNg=="}], "type": "inlineReview"}, {"oid": "2cecab4e1850ee084079735048e66c25cc447045", "url": "https://github.com/apache/geode/commit/2cecab4e1850ee084079735048e66c25cc447045", "message": "Revert \"GEODE-7565: gw sender pings not reaching gw receivers\"\n\nThis reverts commit 39bb45d9f45f91713c0fa37f90b5009dfc563441.", "committedDate": "2020-03-26T18:26:37Z", "type": "commit"}, {"oid": "d53f1854510728e512e2ac805bfc3e6ce3eb41a7", "url": "https://github.com/apache/geode/commit/d53f1854510728e512e2ac805bfc3e6ce3eb41a7", "message": "GEODE-7565: Distributed ping", "committedDate": "2020-03-26T18:33:45Z", "type": "commit"}, {"oid": "d8b6d0699de08c5ef9962e1614a692eb54e76a72", "url": "https://github.com/apache/geode/commit/d8b6d0699de08c5ef9962e1614a692eb54e76a72", "message": "GEODE-7565: Fix lgtm error", "committedDate": "2020-03-27T10:54:29Z", "type": "commit"}, {"oid": "d8b6d0699de08c5ef9962e1614a692eb54e76a72", "url": "https://github.com/apache/geode/commit/d8b6d0699de08c5ef9962e1614a692eb54e76a72", "message": "GEODE-7565: Fix lgtm error", "committedDate": "2020-03-27T10:54:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMjY1MQ==", "url": "https://github.com/apache/geode/pull/4824#discussion_r399322651", "bodyText": "This is what is causing the ConnectionPoolImplJUnitTest failure.  That test creates two servers and a pool in the same JVM, so both servers have the same membership ID.  If you delete that test and replace it with a distributedTest that creates the servers in different JVMs it ought to pass.", "author": "bschuchardt", "createdAt": "2020-03-27T14:53:14Z", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/EndpointManagerImpl.java", "diffHunk": "@@ -56,17 +56,17 @@ public EndpointManagerImpl(String poolName, DistributedSystem ds, CancelCriterio\n \n   @Override\n   public Endpoint referenceEndpoint(ServerLocation server, DistributedMember memberId) {\n-    Endpoint endpoint = endpointMap.get(server);\n+    Endpoint endpoint = endpointMap.get(memberId);", "originalCommit": "d8b6d0699de08c5ef9962e1614a692eb54e76a72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTM1NTAyOA==", "url": "https://github.com/apache/geode/pull/4824#discussion_r399355028", "bodyText": "Actually I think this is a problem that needs to be brought to the dev email list.  Either the PR needs to change or we need to disallow creating multiple CacheServers in the same cache.", "author": "bschuchardt", "createdAt": "2020-03-27T15:38:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTMyMjY1MQ=="}], "type": "inlineReview"}, {"oid": "3f80e68758aba16a34cc0aeed2757afab46b7bb0", "url": "https://github.com/apache/geode/commit/3f80e68758aba16a34cc0aeed2757afab46b7bb0", "message": "Revert \"GEODE-7565: GW sender connection failover\"\n\nThis reverts commit b180869c73095e7a810ba2e1c92e243a0220e888.", "committedDate": "2020-04-01T17:36:12Z", "type": "commit"}, {"oid": "bec095b0e8166cbef4d3a21e805601addf5f52ee", "url": "https://github.com/apache/geode/commit/bec095b0e8166cbef4d3a21e805601addf5f52ee", "message": "GEODE-7565: Use ip+port+id for server identification", "committedDate": "2020-04-02T14:16:46Z", "type": "commit"}, {"oid": "0c4b00f5c5d32a2ec20cb887bbda6f70d88c2a8b", "url": "https://github.com/apache/geode/commit/0c4b00f5c5d32a2ec20cb887bbda6f70d88c2a8b", "message": "Fix spotlessJava", "committedDate": "2020-04-02T14:26:10Z", "type": "commit"}, {"oid": "e3237d1339716fa63e5176828c22f188c3f650af", "url": "https://github.com/apache/geode/commit/e3237d1339716fa63e5176828c22f188c3f650af", "message": "Undo not needed change", "committedDate": "2020-04-02T15:50:19Z", "type": "commit"}, {"oid": "92a9670e25ebcb237fdc69a696b6c0028815347e", "url": "https://github.com/apache/geode/commit/92a9670e25ebcb237fdc69a696b6c0028815347e", "message": "Use getUniqueId instead of getId", "committedDate": "2020-04-02T15:50:50Z", "type": "commit"}, {"oid": "517d6f6a3046fe08778aedacf9a8f88365e75799", "url": "https://github.com/apache/geode/commit/517d6f6a3046fe08778aedacf9a8f88365e75799", "message": "Remove test timeout", "committedDate": "2020-04-02T16:13:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTkwMA==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404441900", "bodyText": "It looks like this is only used by tests, is that right? It might be better to remove this method, which uses and incorrect memberId of \"\"", "author": "upthewaterspout", "createdAt": "2020-04-06T23:09:13Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/LocatorLoadSnapshot.java", "diffHunk": "@@ -85,49 +86,52 @@ public LocatorLoadSnapshot() {\n   }\n \n   public void addServer(ServerLocation location, String[] groups, ServerLoad initialLoad) {\n-    addServer(location, groups, initialLoad, 30000);\n+    addServer(location, \"\", groups, initialLoad, 30000);", "originalCommit": "517d6f6a3046fe08778aedacf9a8f88365e75799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDcwNzcxOA==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404707718", "bodyText": "I have just added a commit to fix this.", "author": "alb3rtobr", "createdAt": "2020-04-07T10:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0MTkwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzcxNg==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404447716", "bodyText": "I'm wondering about how this method is handling excludedServers. If the hostname-for-senders of all of the servers is the same, doesn't that mean that as soon as one server is in this excluded server list, no results will be returned?", "author": "upthewaterspout", "createdAt": "2020-04-06T23:26:02Z", "path": "geode-core/src/main/java/org/apache/geode/distributed/internal/LocatorLoadSnapshot.java", "diffHunk": "@@ -448,6 +489,65 @@ private void updateMap(Map map, ServerLocation location, float load, float loadP\n     }\n   }\n \n+  private void updateMap(Map map, ServerLocation location, String memberId, float load,\n+      float loadPerConnection) {\n+    Map groupMap = (Map) map.get(null);\n+    ServerLocationAndMemberId locationAndMemberId =\n+        new ServerLocationAndMemberId(location, memberId);\n+    LoadHolder holder =\n+        (LoadHolder) groupMap.get(locationAndMemberId);\n+\n+    if (holder != null) {\n+      holder.setLoad(load, loadPerConnection);\n+    }\n+  }\n+\n+  /**\n+   *\n+   * @param groupServers the servers to consider\n+   * @param excludedServers servers to exclude\n+   * @param count how many you want. a negative number means all of them in order of best to worst\n+   * @return a list of best...worst server LoadHolders\n+   */\n+  private List<LoadHolder> findBestServersUsingMemberId(\n+      Map<ServerLocationAndMemberId, LoadHolder> groupServers,\n+      Set<ServerLocation> excludedServers, int count) {", "originalCommit": "517d6f6a3046fe08778aedacf9a8f88365e75799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDYxNDcwNA==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404614704", "bodyText": "You are right, the excluded servers should have the member id into account\nEdit: Im going to check it because I thought the behavior will be as you said, but in that case, we should see all the receivers down when one of them is down, which is not happening.", "author": "alb3rtobr", "createdAt": "2020-04-07T08:04:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY2NjA0MA==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404666040", "bodyText": "Ok, the method is not involved in the receiver failover, I was wrong. So, you are right about the behavior of the method. And in the case of configuring same host and port for all the receivers it doesn't seem to be an issue.", "author": "alb3rtobr", "createdAt": "2020-04-07T09:25:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTkxNzM1OQ==", "url": "https://github.com/apache/geode/pull/4824#discussion_r409917359", "bodyText": "I'm digging through the code a bit more. I think this method does get called, but maybe we are retrying at a higher level so it doesn't matter for the gateway code.", "author": "upthewaterspout", "createdAt": "2020-04-17T00:04:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzcxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDUxMDc3OQ==", "url": "https://github.com/apache/geode/pull/4824#discussion_r410510779", "bodyText": "I think it's possible to call this method, but it does look like the WAN will retry and come back with an empty excluded servers set. So I think you're right, it will be ok for the WAN case.", "author": "upthewaterspout", "createdAt": "2020-04-17T23:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0NzcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0ODY1MA==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404448650", "bodyText": "Does this need to take into account the version of the member that is being pinged? Could we be pinging a member with an older version and it will fail to deserialize this message? Or are we assuming all of the receivers will be upgraded before we start getting pings that need to be forwarded to the correct server.", "author": "upthewaterspout", "createdAt": "2020-04-06T23:28:53Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/tier/sockets/command/Ping.java", "diffHunk": "@@ -60,6 +78,29 @@ public void cmdExecute(final Message clientMessage, final ServerConnection serve\n     }\n   }\n \n+  /**\n+   * Process a ping request that was sent to the wrong server\n+   */\n+  protected void pingCorrectServer(Message clientMessage, DistributedMember targetServer,\n+      ServerConnection serverConnection)\n+      throws IOException {\n+    if (logger.isDebugEnabled()) {\n+      logger.debug(\"Received a Ping request from {} intended for {}.  Forwarding the ping...\");\n+    }\n+    if (!serverConnection.getCache().getDistributionManager().isCurrentMember(targetServer)) {\n+      logger.warn(\"Unable to ping non-member {} for client {}\", targetServer,\n+          serverConnection.getProxyID());\n+      writeErrorResponse(clientMessage, MessageType.PING, serverConnection);\n+      serverConnection.setAsTrue(RESPONDED);\n+    } else {\n+      // send a ping message to the server. This is a one-way message that doesn't send a reply\n+      final DistributedPingMessage distributedPingMessage =\n+          new DistributedPingMessage(targetServer, serverConnection.getProxyID());", "originalCommit": "517d6f6a3046fe08778aedacf9a8f88365e75799", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDY4ODE4MQ==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404688181", "bodyText": "In our case its ok if the ping is not working while the upgrade of all members is not finished", "author": "alb3rtobr", "createdAt": "2020-04-07T10:01:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0ODY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDg3NTg4Mg==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404875882", "bodyText": "I don't think Ping needs to check the version of the recipient of the DistributedPingMessage.  Only  new clients will include the new targetServer message part, and all servers should be upgraded before new clients come on-line.", "author": "bschuchardt", "createdAt": "2020-04-07T14:56:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0ODY1MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk4MjIyMQ==", "url": "https://github.com/apache/geode/pull/4824#discussion_r404982221", "bodyText": "Ok, makes sense. Thanks Bruce.", "author": "upthewaterspout", "createdAt": "2020-04-07T17:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDQ0ODY1MA=="}], "type": "inlineReview"}, {"oid": "b48450aa495e551657a739a9eb7cbfe25e341b22", "url": "https://github.com/apache/geode/commit/b48450aa495e551657a739a9eb7cbfe25e341b22", "message": "GEODE-7565: Remove unnecessary method", "committedDate": "2020-04-07T10:32:42Z", "type": "commit"}, {"oid": "0e1f2143c58681427b2d7c9cf948c4548fb50996", "url": "https://github.com/apache/geode/commit/0e1f2143c58681427b2d7c9cf948c4548fb50996", "message": "GEODE-7565: Fix incomplete debug message", "committedDate": "2020-04-08T09:02:08Z", "type": "commit"}]}