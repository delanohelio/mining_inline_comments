{"pr_number": 4922, "pr_title": "GEODE-7957: query results toData will write to correct output stream ", "pr_createdAt": "2020-04-07T22:21:26Z", "pr_url": "https://github.com/apache/geode/pull/4922", "timeline": [{"oid": "02f76cc0dac6935ada48ce4222367b8444947578", "url": "https://github.com/apache/geode/commit/02f76cc0dac6935ada48ce4222367b8444947578", "message": "GEODE-7957: toData will write to the correct output stream to preserve ordering\n\n  * Previously, when a query is executed in a function, the toData on specific results\n    set types would write directly to the wrong output stream, causing deserialization issues", "committedDate": "2020-04-07T22:19:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MzU1NQ==", "url": "https://github.com/apache/geode/pull/4922#discussion_r405663555", "bodyText": "You might want to remove this one :-)", "author": "jujoramos", "createdAt": "2020-04-08T16:42:11Z", "path": "geode-core/src/main/java/org/apache/geode/cache/query/internal/CumulativeNonDistinctResults.java", "diffHunk": "@@ -177,6 +177,7 @@ public CumulativeNonDistinctResultsCollection(Collection<? extends Collection<E>\n       this.results = results;\n       this.limit = limit;\n       this.collectionsMetdata = collectionsMetadata;\n+      System.out.println(\"JASON\");", "originalCommit": "02f76cc0dac6935ada48ce4222367b8444947578", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "698b81bba238a3198bf5aad37018d683231dded3", "url": "https://github.com/apache/geode/commit/698b81bba238a3198bf5aad37018d683231dded3", "message": "Updated serializables file", "committedDate": "2020-04-14T17:03:30Z", "type": "commit"}, {"oid": "698b81bba238a3198bf5aad37018d683231dded3", "url": "https://github.com/apache/geode/commit/698b81bba238a3198bf5aad37018d683231dded3", "message": "Updated serializables file", "committedDate": "2020-04-14T17:03:30Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3NTM0OQ==", "url": "https://github.com/apache/geode/pull/4922#discussion_r408675349", "bodyText": "This one can be declared as static final REGION_NAME as it's a constant.", "author": "jujoramos", "createdAt": "2020-04-15T08:38:10Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/query/dunit/MultiServerPartitionedRegionQueryDUnitTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.cache.query.dunit;\n+\n+import static org.apache.geode.test.dunit.VM.getVM;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Properties;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.cache.Cache;\n+import org.apache.geode.cache.CacheFactory;\n+import org.apache.geode.cache.Region;\n+import org.apache.geode.cache.RegionShortcut;\n+import org.apache.geode.cache.client.ClientCache;\n+import org.apache.geode.cache.client.ClientCacheFactory;\n+import org.apache.geode.cache.client.ClientRegionShortcut;\n+import org.apache.geode.cache.execute.FunctionAdapter;\n+import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionException;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.cache.query.FunctionDomainException;\n+import org.apache.geode.cache.query.NameResolutionException;\n+import org.apache.geode.cache.query.Query;\n+import org.apache.geode.cache.query.QueryInvocationTargetException;\n+import org.apache.geode.cache.query.QueryService;\n+import org.apache.geode.cache.query.SelectResults;\n+import org.apache.geode.cache.query.TypeMismatchException;\n+import org.apache.geode.cache.server.CacheServer;\n+import org.apache.geode.distributed.internal.DistributionConfig;\n+import org.apache.geode.test.dunit.VM;\n+import org.apache.geode.test.dunit.rules.CacheRule;\n+import org.apache.geode.test.dunit.rules.ClientCacheRule;\n+import org.apache.geode.test.dunit.rules.DistributedRule;\n+\n+public class MultiServerPartitionedRegionQueryDUnitTest implements Serializable {\n+\n+  @Rule\n+  public DistributedRule distributedRule = new DistributedRule();\n+  @Rule\n+  public CacheRule cacheRule = new CacheRule();\n+  @Rule\n+  public ClientCacheRule clientCacheRule = new ClientCacheRule();\n+\n+  private VM server1, server2, client;\n+  private String regionName = \"region\";", "originalCommit": "698b81bba238a3198bf5aad37018d683231dded3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3NTY5Mg==", "url": "https://github.com/apache/geode/pull/4922#discussion_r408675692", "bodyText": "Can be replaced with int port = server1.invoke(this::createServerAndRegion);.", "author": "jujoramos", "createdAt": "2020-04-15T08:38:44Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/query/dunit/MultiServerPartitionedRegionQueryDUnitTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.cache.query.dunit;\n+\n+import static org.apache.geode.test.dunit.VM.getVM;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Properties;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.cache.Cache;\n+import org.apache.geode.cache.CacheFactory;\n+import org.apache.geode.cache.Region;\n+import org.apache.geode.cache.RegionShortcut;\n+import org.apache.geode.cache.client.ClientCache;\n+import org.apache.geode.cache.client.ClientCacheFactory;\n+import org.apache.geode.cache.client.ClientRegionShortcut;\n+import org.apache.geode.cache.execute.FunctionAdapter;\n+import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionException;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.cache.query.FunctionDomainException;\n+import org.apache.geode.cache.query.NameResolutionException;\n+import org.apache.geode.cache.query.Query;\n+import org.apache.geode.cache.query.QueryInvocationTargetException;\n+import org.apache.geode.cache.query.QueryService;\n+import org.apache.geode.cache.query.SelectResults;\n+import org.apache.geode.cache.query.TypeMismatchException;\n+import org.apache.geode.cache.server.CacheServer;\n+import org.apache.geode.distributed.internal.DistributionConfig;\n+import org.apache.geode.test.dunit.VM;\n+import org.apache.geode.test.dunit.rules.CacheRule;\n+import org.apache.geode.test.dunit.rules.ClientCacheRule;\n+import org.apache.geode.test.dunit.rules.DistributedRule;\n+\n+public class MultiServerPartitionedRegionQueryDUnitTest implements Serializable {\n+\n+  @Rule\n+  public DistributedRule distributedRule = new DistributedRule();\n+  @Rule\n+  public CacheRule cacheRule = new CacheRule();\n+  @Rule\n+  public ClientCacheRule clientCacheRule = new ClientCacheRule();\n+\n+  private VM server1, server2, client;\n+  private String regionName = \"region\";\n+\n+  @Before\n+  public void setup() {\n+    server1 = getVM(0);\n+    server2 = getVM(1);\n+    client = getVM(2);\n+  }\n+\n+  @Test\n+  public void cumulativeResultsToDataShouldWriteToTheCorrectStreamNotCauseCorruption() {\n+    int numPuts = 10;\n+    int port = server1.invoke(() -> {\n+      return createServerAndRegion();\n+    });", "originalCommit": "698b81bba238a3198bf5aad37018d683231dded3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3NTg4Nw==", "url": "https://github.com/apache/geode/pull/4922#discussion_r408675887", "bodyText": "Can be replaced with server2.invoke((SerializableRunnableIF) this::createServerAndRegion);.", "author": "jujoramos", "createdAt": "2020-04-15T08:39:01Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/query/dunit/MultiServerPartitionedRegionQueryDUnitTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.cache.query.dunit;\n+\n+import static org.apache.geode.test.dunit.VM.getVM;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Properties;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.cache.Cache;\n+import org.apache.geode.cache.CacheFactory;\n+import org.apache.geode.cache.Region;\n+import org.apache.geode.cache.RegionShortcut;\n+import org.apache.geode.cache.client.ClientCache;\n+import org.apache.geode.cache.client.ClientCacheFactory;\n+import org.apache.geode.cache.client.ClientRegionShortcut;\n+import org.apache.geode.cache.execute.FunctionAdapter;\n+import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionException;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.cache.query.FunctionDomainException;\n+import org.apache.geode.cache.query.NameResolutionException;\n+import org.apache.geode.cache.query.Query;\n+import org.apache.geode.cache.query.QueryInvocationTargetException;\n+import org.apache.geode.cache.query.QueryService;\n+import org.apache.geode.cache.query.SelectResults;\n+import org.apache.geode.cache.query.TypeMismatchException;\n+import org.apache.geode.cache.server.CacheServer;\n+import org.apache.geode.distributed.internal.DistributionConfig;\n+import org.apache.geode.test.dunit.VM;\n+import org.apache.geode.test.dunit.rules.CacheRule;\n+import org.apache.geode.test.dunit.rules.ClientCacheRule;\n+import org.apache.geode.test.dunit.rules.DistributedRule;\n+\n+public class MultiServerPartitionedRegionQueryDUnitTest implements Serializable {\n+\n+  @Rule\n+  public DistributedRule distributedRule = new DistributedRule();\n+  @Rule\n+  public CacheRule cacheRule = new CacheRule();\n+  @Rule\n+  public ClientCacheRule clientCacheRule = new ClientCacheRule();\n+\n+  private VM server1, server2, client;\n+  private String regionName = \"region\";\n+\n+  @Before\n+  public void setup() {\n+    server1 = getVM(0);\n+    server2 = getVM(1);\n+    client = getVM(2);\n+  }\n+\n+  @Test\n+  public void cumulativeResultsToDataShouldWriteToTheCorrectStreamNotCauseCorruption() {\n+    int numPuts = 10;\n+    int port = server1.invoke(() -> {\n+      return createServerAndRegion();\n+    });\n+    server2.invoke(() -> {\n+      createServerAndRegion();\n+    });", "originalCommit": "698b81bba238a3198bf5aad37018d683231dded3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3NjgyMQ==", "url": "https://github.com/apache/geode/pull/4922#discussion_r408676821", "bodyText": "We are replacing usages of JUnit asserts for assert4j, we can change this before merging the pull request to make sure we don't need to revisit this test in the future.", "author": "jujoramos", "createdAt": "2020-04-15T08:40:30Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/query/dunit/MultiServerPartitionedRegionQueryDUnitTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.cache.query.dunit;\n+\n+import static org.apache.geode.test.dunit.VM.getVM;\n+import static org.junit.Assert.assertEquals;", "originalCommit": "698b81bba238a3198bf5aad37018d683231dded3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY3NzQ5MA==", "url": "https://github.com/apache/geode/pull/4922#discussion_r408677490", "bodyText": "This field is never used.", "author": "jujoramos", "createdAt": "2020-04-15T08:41:42Z", "path": "geode-core/src/distributedTest/java/org/apache/geode/cache/query/dunit/MultiServerPartitionedRegionQueryDUnitTest.java", "diffHunk": "@@ -0,0 +1,197 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.cache.query.dunit;\n+\n+import static org.apache.geode.test.dunit.VM.getVM;\n+import static org.junit.Assert.assertEquals;\n+\n+import java.io.IOException;\n+import java.io.Serializable;\n+import java.util.ArrayList;\n+import java.util.Properties;\n+import java.util.stream.IntStream;\n+\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+\n+import org.apache.geode.cache.Cache;\n+import org.apache.geode.cache.CacheFactory;\n+import org.apache.geode.cache.Region;\n+import org.apache.geode.cache.RegionShortcut;\n+import org.apache.geode.cache.client.ClientCache;\n+import org.apache.geode.cache.client.ClientCacheFactory;\n+import org.apache.geode.cache.client.ClientRegionShortcut;\n+import org.apache.geode.cache.execute.FunctionAdapter;\n+import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionException;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.cache.query.FunctionDomainException;\n+import org.apache.geode.cache.query.NameResolutionException;\n+import org.apache.geode.cache.query.Query;\n+import org.apache.geode.cache.query.QueryInvocationTargetException;\n+import org.apache.geode.cache.query.QueryService;\n+import org.apache.geode.cache.query.SelectResults;\n+import org.apache.geode.cache.query.TypeMismatchException;\n+import org.apache.geode.cache.server.CacheServer;\n+import org.apache.geode.distributed.internal.DistributionConfig;\n+import org.apache.geode.test.dunit.VM;\n+import org.apache.geode.test.dunit.rules.CacheRule;\n+import org.apache.geode.test.dunit.rules.ClientCacheRule;\n+import org.apache.geode.test.dunit.rules.DistributedRule;\n+\n+public class MultiServerPartitionedRegionQueryDUnitTest implements Serializable {\n+\n+  @Rule\n+  public DistributedRule distributedRule = new DistributedRule();\n+  @Rule\n+  public CacheRule cacheRule = new CacheRule();\n+  @Rule\n+  public ClientCacheRule clientCacheRule = new ClientCacheRule();\n+\n+  private VM server1, server2, client;\n+  private String regionName = \"region\";\n+\n+  @Before\n+  public void setup() {\n+    server1 = getVM(0);\n+    server2 = getVM(1);\n+    client = getVM(2);\n+  }\n+\n+  @Test\n+  public void cumulativeResultsToDataShouldWriteToTheCorrectStreamNotCauseCorruption() {\n+    int numPuts = 10;\n+    int port = server1.invoke(() -> {\n+      return createServerAndRegion();\n+    });\n+    server2.invoke(() -> {\n+      createServerAndRegion();\n+    });\n+\n+    String hostname = server1.getHost().getHostName();\n+    client.invoke(() -> {\n+      ClientCacheFactory ccf = new ClientCacheFactory();\n+      ccf.addPoolServer(hostname, port);\n+      clientCacheRule.createClientCache(ccf);\n+      ClientCache clientCache = clientCacheRule.getClientCache();\n+      Region region =\n+          clientCache.createClientRegionFactory(ClientRegionShortcut.PROXY).create(regionName);\n+      IntStream.range(0, numPuts).forEach(id -> region.put(\"key-\" + id, new TestObject(id)));\n+      ArrayList results = (ArrayList) FunctionService.onRegion(region)\n+          .execute(new QueryWithoutTurningIntoListFunction(regionName,\n+              \"select distinct r.id, r.name from /\" + regionName + \" r, /\" + regionName\n+                  + \" t where t.id = r.id order by r.id\"))\n+          .getResult();\n+      SelectResults rs = (SelectResults) results.get(0);\n+      assertEquals(numPuts, rs.size());\n+    });\n+  }\n+\n+  @Test\n+  public void nwayMergeResultsToDataShouldWriteToTheCorrectStreamAndNotCauseCorruption() {\n+    int numPuts = 10;\n+    int port = server1.invoke(() -> {\n+      return createServerAndRegion();\n+    });\n+    server2.invoke(() -> {\n+      createServerAndRegion();\n+    });\n+\n+    String hostname = server1.getHost().getHostName();\n+    client.invoke(() -> {\n+      ClientCacheFactory ccf = new ClientCacheFactory();\n+      ccf.addPoolServer(hostname, port);\n+      clientCacheRule.createClientCache(ccf);\n+      ClientCache clientCache = clientCacheRule.getClientCache();\n+      Region region =\n+          clientCache.createClientRegionFactory(ClientRegionShortcut.PROXY).create(regionName);\n+      IntStream.range(0, numPuts).forEach(id -> region.put(\"key-\" + id, new TestObject(id)));\n+      ArrayList results = (ArrayList) FunctionService.onRegion(region)\n+          .execute(new QueryWithoutTurningIntoListFunction(regionName,\n+              \"select distinct r.id, r.name from /\" + regionName + \" r, /\" + regionName\n+                  + \" t where t.id = r.id order by r.id\"))\n+          .getResult();\n+      SelectResults rs = (SelectResults) results.get(0);\n+      assertEquals(numPuts, rs.size());\n+    });\n+  }\n+\n+  private int createServerAndRegion() throws IOException {\n+    Properties props = new Properties();\n+    props.setProperty(DistributionConfig.VALIDATE_SERIALIZABLE_OBJECTS_NAME, \"true\");\n+    props.setProperty(DistributionConfig.SERIALIZABLE_OBJECT_FILTER_NAME, \"*\");\n+    cacheRule.createCache(new CacheFactory(props).setPdxReadSerialized(true));\n+    Cache cache = cacheRule.getCache();\n+    CacheServer cs = cache.addCacheServer();\n+    cs.setPort(0);\n+    cs.start();\n+    cache.createRegionFactory(RegionShortcut.PARTITION).create(regionName);\n+    return cs.getPort();\n+  }\n+\n+  public static class TestObject implements Serializable {\n+    public int id;\n+    public String name;\n+\n+    public TestObject(int id) {\n+      this.id = id;\n+      this.name = \"Name:\" + id;\n+    }\n+  }\n+\n+  public static class QueryWithoutTurningIntoListFunction extends FunctionAdapter {\n+\n+    private String regionName;", "originalCommit": "698b81bba238a3198bf5aad37018d683231dded3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "58aec752901d93be5a2ea14f8e76cc506c11749f", "url": "https://github.com/apache/geode/commit/58aec752901d93be5a2ea14f8e76cc506c11749f", "message": "Added changes from review", "committedDate": "2020-04-15T16:50:10Z", "type": "commit"}, {"oid": "5513703d9285f7bb880cecd10728bc9e22eef3d7", "url": "https://github.com/apache/geode/commit/5513703d9285f7bb880cecd10728bc9e22eef3d7", "message": "fixed to correct equals check", "committedDate": "2020-04-15T16:52:42Z", "type": "commit"}, {"oid": "c440363c13184f2839112607bc08b7e5d11cac1b", "url": "https://github.com/apache/geode/commit/c440363c13184f2839112607bc08b7e5d11cac1b", "message": "spotless", "committedDate": "2020-04-16T16:28:16Z", "type": "commit"}]}