{"pr_number": 5085, "pr_title": "GEODE-8090: implement function/delta for redis Hash ops", "pr_createdAt": "2020-05-08T23:31:38Z", "pr_url": "https://github.com/apache/geode/pull/5085", "timeline": [{"oid": "8ef6181c623b6ad5a528f90d61b19bb113f58d6d", "url": "https://github.com/apache/geode/commit/8ef6181c623b6ad5a528f90d61b19bb113f58d6d", "message": "wip", "committedDate": "2020-05-11T18:14:06Z", "type": "commit"}, {"oid": "0c5560396ef94de02a1bdf5e1e3bbe591fdfaaea", "url": "https://github.com/apache/geode/commit/0c5560396ef94de02a1bdf5e1e3bbe591fdfaaea", "message": "wip", "committedDate": "2020-05-11T18:15:31Z", "type": "commit"}, {"oid": "ea59f32cf97d970bb077d521509d3bac785cfdde", "url": "https://github.com/apache/geode/commit/ea59f32cf97d970bb077d521509d3bac785cfdde", "message": "wip: executors for hash del, hdel, hset, hmset, and hgetall now use functions.", "committedDate": "2020-05-11T18:16:04Z", "type": "commit"}, {"oid": "b7773aec28a5c5fe3ac80212a830939fe52c2ff8", "url": "https://github.com/apache/geode/commit/b7773aec28a5c5fe3ac80212a830939fe52c2ff8", "message": "implemented basic ops in RedishHash. Deltas are now implemented", "committedDate": "2020-05-11T18:16:04Z", "type": "commit"}, {"oid": "8a9e50e0876dc348b5c6b2eb59a49c7acef4242a", "url": "https://github.com/apache/geode/commit/8a9e50e0876dc348b5c6b2eb59a49c7acef4242a", "message": "all hash commands now deal with RedisHash instead of a Map", "committedDate": "2020-05-11T18:17:52Z", "type": "commit"}, {"oid": "0eec973ee3be706a86f4a94c6a1b46d384a398f0", "url": "https://github.com/apache/geode/commit/0eec973ee3be706a86f4a94c6a1b46d384a398f0", "message": "HashesIntegrationTest now passes.\nBuilds cleanly. Time to create a PR.", "committedDate": "2020-05-11T18:20:03Z", "type": "commit"}, {"oid": "2a9ffe9a7ca8dfa38bd18866f7e676b2fda3405b", "url": "https://github.com/apache/geode/commit/2a9ffe9a7ca8dfa38bd18866f7e676b2fda3405b", "message": "fixed serialization issues", "committedDate": "2020-05-11T18:20:51Z", "type": "commit"}, {"oid": "2a9ffe9a7ca8dfa38bd18866f7e676b2fda3405b", "url": "https://github.com/apache/geode/commit/2a9ffe9a7ca8dfa38bd18866f7e676b2fda3405b", "message": "fixed serialization issues", "committedDate": "2020-05-11T18:20:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNDY1Mw==", "url": "https://github.com/apache/geode/pull/5085#discussion_r423304653", "bodyText": "can we deprecate this method?", "author": "prettyClouds", "createdAt": "2020-05-11T20:37:56Z", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/HashExecutor.java", "diffHunk": "@@ -42,14 +41,14 @@\n    * @param key the region hash key region:<key>\n    * @return the map data\n    */\n-  protected Map<ByteArrayWrapper, ByteArrayWrapper> getMap(ExecutionHandlerContext context,\n+  protected RedisHash getMap(ExecutionHandlerContext context,", "originalCommit": "2a9ffe9a7ca8dfa38bd18866f7e676b2fda3405b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NDE4NQ==", "url": "https://github.com/apache/geode/pull/5085#discussion_r423374185", "bodyText": "We could but we still will use it internally until the other HASH commands are converted to use functions. I don't think it is worth marking the internal apis we need to support this older implementation as deprecated. We should just spend a day converting the other HASH commands to use a function and then we can get rid of this, and other, methods.", "author": "dschneider-pivotal", "createdAt": "2020-05-11T23:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNDY1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNzc5NQ==", "url": "https://github.com/apache/geode/pull/5085#discussion_r423307795", "bodyText": "i think it would be nice if hgetall returned a collection of enttries.  That has more semantic meaning, but I understand that the caller would end up just flattening it to send it over the wire.", "author": "prettyClouds", "createdAt": "2020-05-11T20:43:55Z", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/hash/RedisHashCommands.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+\n+package org.apache.geode.redis.internal.executor.hash;\n+\n+import java.util.Collection;\n+import java.util.List;\n+\n+import org.apache.geode.redis.internal.ByteArrayWrapper;\n+\n+public interface RedisHashCommands {\n+  int hset(ByteArrayWrapper key, List<ByteArrayWrapper> fieldsToSet, boolean NX);\n+\n+  int hdel(ByteArrayWrapper key, List<ByteArrayWrapper> fieldsToRemove);\n+\n+  // TODO: refactor this onto something like RedisKeyCommands\n+  boolean del(ByteArrayWrapper key);\n+\n+  Collection<ByteArrayWrapper> hgetall(ByteArrayWrapper key);", "originalCommit": "2a9ffe9a7ca8dfa38bd18866f7e676b2fda3405b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMyNTA1OA==", "url": "https://github.com/apache/geode/pull/5085#discussion_r423325058", "bodyText": "And it would not be serializable", "author": "dschneider-pivotal", "createdAt": "2020-05-11T21:16:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNzc5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3MzEzMA==", "url": "https://github.com/apache/geode/pull/5085#discussion_r423373130", "bodyText": "I do think it makes more sense for hgetall to return a Collection instead of Collection<Entry<ByteArrayWrapper, ByteArrayWrapper>> because the output of the redis HGETALL command is a flat list. The output is \"key1 value1 key2 value2\". It does not have structure (for example \"{key1 value1} {key2 value2}\". So by having hgetall return a simple Collection it actually corresponds to the public REDIS HGETALL output.", "author": "dschneider-pivotal", "createdAt": "2020-05-11T23:17:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMwNzc5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxOTk0OA==", "url": "https://github.com/apache/geode/pull/5085#discussion_r423319948", "bodyText": "this class is going to grow with each new command added.  Is there any way we can break this up?", "author": "prettyClouds", "createdAt": "2020-05-11T21:06:50Z", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/executor/CommandFunction.java", "diffHunk": "@@ -16,26 +16,53 @@\n \n package org.apache.geode.redis.internal.executor;\n \n+import static org.apache.geode.redis.internal.RedisCommandType.HSET;\n+\n import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n import java.util.concurrent.atomic.AtomicBoolean;\n import java.util.regex.Pattern;\n \n import org.apache.geode.cache.Region;\n import org.apache.geode.cache.execute.Function;\n import org.apache.geode.cache.execute.FunctionContext;\n+import org.apache.geode.cache.execute.FunctionService;\n+import org.apache.geode.cache.execute.ResultCollector;\n import org.apache.geode.cache.execute.ResultSender;\n import org.apache.geode.internal.cache.execute.RegionFunctionContextImpl;\n import org.apache.geode.redis.internal.ByteArrayWrapper;\n import org.apache.geode.redis.internal.RedisCommandType;\n+import org.apache.geode.redis.internal.RedisDataType;\n+import org.apache.geode.redis.internal.executor.hash.RedisHash;\n import org.apache.geode.redis.internal.executor.set.RedisSet;\n import org.apache.geode.redis.internal.executor.set.StripedExecutor;\n+import org.apache.geode.redis.internal.executor.set.SynchronizedStripedExecutor;\n \n public class CommandFunction implements Function<Object[]> {", "originalCommit": "2a9ffe9a7ca8dfa38bd18866f7e676b2fda3405b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3MjI3OQ==", "url": "https://github.com/apache/geode/pull/5085#discussion_r423372279", "bodyText": "Probably. I don't have any ideas. But it does seem like we have a bunch of things that are related to each other and maybe they can be refactored in some way. I do like having a single function. For example we could have a function for each command but that would cause a bunch of busy work each time we add function support for another redis command. I would suggest we wait on this refactoring until we get all the commands we want to support for our first release done. Then we can look at those and figure out the best way to organize the code for those commands.", "author": "dschneider-pivotal", "createdAt": "2020-05-11T23:15:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzMxOTk0OA=="}], "type": "inlineReview"}]}