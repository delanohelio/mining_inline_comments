{"pr_number": 4736, "pr_title": "GEODE-7839: add gfsh oauth token support", "pr_createdAt": "2020-02-26T00:45:10Z", "pr_url": "https://github.com/apache/geode/pull/4736", "timeline": [{"oid": "d1df761813c7ffebaefdbe63d0dc816037c2eb7f", "url": "https://github.com/apache/geode/commit/d1df761813c7ffebaefdbe63d0dc816037c2eb7f", "message": "WIP - initial checkin\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Darrel Schneider <dschneider@pivotal.io>", "committedDate": "2020-02-13T23:23:45Z", "type": "commit"}, {"oid": "cdbda6c525b2399a6acaaa7da1eeb007ebb192a2", "url": "https://github.com/apache/geode/commit/cdbda6c525b2399a6acaaa7da1eeb007ebb192a2", "message": "Start of integration tests to verify token\n\nCo-authored-by: Joris Melchior <joris.melchior@gmail.com>\nCo-authored-by: Darrel Schneider <dschneider@pivotal.io>", "committedDate": "2020-02-14T16:13:57Z", "type": "commit"}, {"oid": "315c1a4d03896c920fa0de05f32e082c5cf91cc0", "url": "https://github.com/apache/geode/commit/315c1a4d03896c920fa0de05f32e082c5cf91cc0", "message": "ConnectCommand no longer retries if a TOKEN is being used. So the new token connect tests now fail (as expected).", "committedDate": "2020-02-14T17:52:08Z", "type": "commit"}, {"oid": "c1feac4b408e696f20fc98fa03b5af89b79054a7", "url": "https://github.com/apache/geode/commit/c1feac4b408e696f20fc98fa03b5af89b79054a7", "message": "jmx connect now works with a token", "committedDate": "2020-02-14T18:42:06Z", "type": "commit"}, {"oid": "437631cac3f6a4903c0ae1bca1a7a914755b86ac", "url": "https://github.com/apache/geode/commit/437631cac3f6a4903c0ae1bca1a7a914755b86ac", "message": "http connect with token now works", "committedDate": "2020-02-14T19:13:00Z", "type": "commit"}, {"oid": "350a05dc652f0210d8b86c9a6beb45f6597e0a68", "url": "https://github.com/apache/geode/commit/350a05dc652f0210d8b86c9a6beb45f6597e0a68", "message": "Enable token acceptance for gfsh http connection\n\nAuthored-by: Joris Melchior <joris.melchior@gmail.com>", "committedDate": "2020-02-19T17:21:02Z", "type": "commit"}, {"oid": "b37774744b2162a621e6ad0e2fca60eff04dd640", "url": "https://github.com/apache/geode/commit/b37774744b2162a621e6ad0e2fca60eff04dd640", "message": "Merge branch 'develop' into gfsh-token-support", "committedDate": "2020-02-19T17:23:26Z", "type": "commit"}, {"oid": "787d05a0617fda4fe015068ae64a2998e88704d9", "url": "https://github.com/apache/geode/commit/787d05a0617fda4fe015068ae64a2998e88704d9", "message": "Merge branch 'develop' into gfsh-token-support", "committedDate": "2020-02-19T18:32:17Z", "type": "commit"}, {"oid": "e48a06d55ed261e831673b6a4632ce8f8393b61c", "url": "https://github.com/apache/geode/commit/e48a06d55ed261e831673b6a4632ce8f8393b61c", "message": "disabled setting AUTH_TOKEN_ENABLED_PARAM on ManagementAgent to see if tests will fail", "committedDate": "2020-02-25T22:40:43Z", "type": "commit"}, {"oid": "92dc6238421bf360a9b2674b65b95c95ba9294e9", "url": "https://github.com/apache/geode/commit/92dc6238421bf360a9b2674b65b95c95ba9294e9", "message": "removed comment", "committedDate": "2020-02-28T22:36:28Z", "type": "commit"}, {"oid": "97d0621cef5b445b464b16657db741ff2daa5301", "url": "https://github.com/apache/geode/commit/97d0621cef5b445b464b16657db741ff2daa5301", "message": "minor whitespace and comment cleanup", "committedDate": "2020-02-28T22:42:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2MjE0Mw==", "url": "https://github.com/apache/geode/pull/4736#discussion_r385962143", "bodyText": "Like we discussed in the meeting, maybe checks for empty strings for username and password here as well, so that you don't need to deal with them anymore.", "author": "jinmeiliao", "createdAt": "2020-02-28T23:05:05Z", "path": "geode-gfsh/src/main/java/org/apache/geode/management/internal/cli/commands/ConnectCommand.java", "diffHunk": "@@ -124,6 +126,14 @@ public ResultModel connect(\n       useSsl = true;\n     }\n \n+    if (\"\".equals(token)) {\n+      return ResultModel.createError(\"--token requires a value, for example --token=foo\");\n+    }\n+", "originalCommit": "97d0621cef5b445b464b16657db741ff2daa5301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYxOTc5NA==", "url": "https://github.com/apache/geode/pull/4736#discussion_r386619794", "bodyText": "I think the current code on this branch is correct. We were very careful to not change the existing behavior of --user and --password in order to be backwards compatible. But we also wanted to be able to tell if both --token and --user or --password were used together. That is why we added a specified default of \"\" for --user and --password. But the old behavior if you specified --user with no value was to just ignore it (it was not flagged as an error). If we do want to say this old behavior is a bug that needs to be fixed lets do that with its own ticket instead of trying to add it into this PR that is about adding --token support.", "author": "dschneider-pivotal", "createdAt": "2020-03-02T20:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2MjE0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2Mjc3MA==", "url": "https://github.com/apache/geode/pull/4736#discussion_r385962770", "bodyText": "this probably is not good. maybe use a unique string based on the token would be nice.", "author": "jinmeiliao", "createdAt": "2020-02-28T23:07:39Z", "path": "geode-core/src/main/java/org/apache/geode/internal/security/shiro/JMXShiroAuthenticator.java", "diffHunk": "@@ -48,13 +48,16 @@ public JMXShiroAuthenticator(SecurityService securityService) {\n \n   @Override\n   public Subject authenticate(Object credentials) {\n-    String username = null;\n+    String username;\n     Properties credProps = new Properties();\n     if (credentials instanceof String[]) {\n       final String[] aCredentials = (String[]) credentials;\n       username = aCredentials[0];\n       credProps.setProperty(ResourceConstants.USER_NAME, aCredentials[0]);\n       credProps.setProperty(ResourceConstants.PASSWORD, aCredentials[1]);\n+    } else if (credentials instanceof String) {\n+      username = \"\";", "originalCommit": "97d0621cef5b445b464b16657db741ff2daa5301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjYyMDMwMw==", "url": "https://github.com/apache/geode/pull/4736#discussion_r386620303", "bodyText": "I addressed this by setting username to \"token-\" + credential.hashCode()", "author": "dschneider-pivotal", "createdAt": "2020-03-02T20:04:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2Mjc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2Mjg0NA==", "url": "https://github.com/apache/geode/pull/4736#discussion_r385962844", "bodyText": "did we decide to do something about this now or later?", "author": "jinmeiliao", "createdAt": "2020-02-28T23:07:58Z", "path": "geode-core/src/main/java/org/apache/geode/internal/security/shiro/JMXShiroAuthenticator.java", "diffHunk": "@@ -48,13 +48,16 @@ public JMXShiroAuthenticator(SecurityService securityService) {\n \n   @Override\n   public Subject authenticate(Object credentials) {\n-    String username = null;\n+    String username;\n     Properties credProps = new Properties();\n     if (credentials instanceof String[]) {\n       final String[] aCredentials = (String[]) credentials;\n       username = aCredentials[0];\n       credProps.setProperty(ResourceConstants.USER_NAME, aCredentials[0]);\n       credProps.setProperty(ResourceConstants.PASSWORD, aCredentials[1]);\n+    } else if (credentials instanceof String) {", "originalCommit": "97d0621cef5b445b464b16657db741ff2daa5301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjUzNTkzMg==", "url": "https://github.com/apache/geode/pull/4736#discussion_r386535932", "bodyText": "I think we should do this later when we need it. It is not clear that we will ever need a more general container (for example a Map) of these properties.", "author": "dschneider-pivotal", "createdAt": "2020-03-02T17:25:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTk2Mjg0NA=="}], "type": "inlineReview"}, {"oid": "f14042e5b978b3cc2271d02c61064fbca1020f5f", "url": "https://github.com/apache/geode/commit/f14042e5b978b3cc2271d02c61064fbca1020f5f", "message": "added --token docs for gfsh connect", "committedDate": "2020-02-28T23:48:46Z", "type": "commit"}, {"oid": "26b20f9b5f47073491b3806f1f19082ebdd7e3fe", "url": "https://github.com/apache/geode/commit/26b20f9b5f47073491b3806f1f19082ebdd7e3fe", "message": "some docs fixes based on pr review", "committedDate": "2020-03-02T19:36:47Z", "type": "commit"}, {"oid": "cfa74a3936dc9ef3826f9cceac5e817ecf787168", "url": "https://github.com/apache/geode/commit/cfa74a3936dc9ef3826f9cceac5e817ecf787168", "message": "for the corner case of using a TOKEN but the SecurityManager\nnot returning a shiroSubject, the user name will now be\n\"token-\" followed by the hashCode of the given token.", "committedDate": "2020-03-02T19:48:06Z", "type": "commit"}]}