{"pr_number": 5464, "pr_title": "GEODE-8432: use regionPath directly instead of getRegion when put eve\u2026", "pr_createdAt": "2020-08-18T17:49:22Z", "pr_url": "https://github.com/apache/geode/pull/5464", "timeline": [{"oid": "39ea51eb55f7833ca5a2b867f2acb331895ca1ec", "url": "https://github.com/apache/geode/commit/39ea51eb55f7833ca5a2b867f2acb331895ca1ec", "message": "GEODE-8432: use regionPath directly instead of getRegion when put event into parallelGatewaySenderQueue", "committedDate": "2020-08-18T17:47:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5NjIyMQ==", "url": "https://github.com/apache/geode/pull/5464#discussion_r472496221", "bodyText": "Should not use value.getRegion() here as it will still cause the hang.", "author": "pivotal-eshu", "createdAt": "2020-08-18T21:12:46Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/parallel/ParallelGatewaySenderQueue.java", "diffHunk": "@@ -693,15 +693,19 @@ public boolean put(Object object) throws InterruptedException, CacheException {\n \n     boolean isDREvent = isDREvent(sender.getCache(), value);\n \n-    Region region = value.getRegion();\n-    String regionPath = null;\n-    if (isDREvent) {\n-      regionPath = region.getFullPath();\n-    } else {\n+    String regionPath = value.getRegionPath();\n+    if (!isDREvent) {\n+      Region region = sender.getCache().getRegion(regionPath);\n+      if (region == null) {\n+        if (isDebugEnabled) {\n+          logger.debug(\"The PR \" + regionPath + \" has not finished initializing.\");\n+        }\n+        region = value.getRegion();", "originalCommit": "39ea51eb55f7833ca5a2b867f2acb331895ca1ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUzMDE4Nw==", "url": "https://github.com/apache/geode/pull/5464#discussion_r472530187", "bodyText": "After I use getRegion(path, true), I don't need to call value.getRegion().\nOtherwise, value.getRegion() is still necessary. When code arrived here, it's normal enqueue (not syncWith enqueue), the event.getRegion() will never be null.", "author": "gesterzhou", "createdAt": "2020-08-18T22:32:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5NjIyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTM0NA==", "url": "https://github.com/apache/geode/pull/5464#discussion_r472499344", "bodyText": "sender.getCache().getRegion(regionPath) should not be null due to initialization as it invokes region.waitOnInitialization(). If region is null, I think it indicates region is destroyed.", "author": "pivotal-eshu", "createdAt": "2020-08-18T21:19:25Z", "path": "geode-core/src/main/java/org/apache/geode/internal/cache/wan/parallel/ParallelGatewaySenderQueue.java", "diffHunk": "@@ -693,15 +693,19 @@ public boolean put(Object object) throws InterruptedException, CacheException {\n \n     boolean isDREvent = isDREvent(sender.getCache(), value);\n \n-    Region region = value.getRegion();\n-    String regionPath = null;\n-    if (isDREvent) {\n-      regionPath = region.getFullPath();\n-    } else {\n+    String regionPath = value.getRegionPath();\n+    if (!isDREvent) {\n+      Region region = sender.getCache().getRegion(regionPath);", "originalCommit": "39ea51eb55f7833ca5a2b867f2acb331895ca1ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjUyOTEwNQ==", "url": "https://github.com/apache/geode/pull/5464#discussion_r472529105", "bodyText": "I will change to sender.getCache().getRegion(regionPath,true).\nIt will be null. In the test, the region is destroyed. But we still need to get the root region. The event will be ignored later by if (!this.userRegionNameToShadowPRMap.containsKey(regionPath)) {", "author": "gesterzhou", "createdAt": "2020-08-18T22:29:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjQ5OTM0NA=="}], "type": "inlineReview"}, {"oid": "de7b583ddc8f151f5362a6adcbd732c37a6c88e8", "url": "https://github.com/apache/geode/commit/de7b583ddc8f151f5362a6adcbd732c37a6c88e8", "message": "when region is destroyed, we should get its reference", "committedDate": "2020-08-18T22:39:42Z", "type": "commit"}]}