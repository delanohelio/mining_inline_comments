{"pr_number": 5839, "pr_title": "GEODE-7861: Improve error reporting in GMSJoinLeave.join()", "pr_createdAt": "2020-12-10T23:39:18Z", "pr_url": "https://github.com/apache/geode/pull/5839", "timeline": [{"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8", "url": "https://github.com/apache/geode/commit/3e3547296e82fe6ac69f2f300ad97813017ad1f8", "message": "GEODE-7861: Improve error reporting in GMSJoinLeave.join()", "committedDate": "2020-12-10T23:53:11Z", "type": "commit"}, {"oid": "3e3547296e82fe6ac69f2f300ad97813017ad1f8", "url": "https://github.com/apache/geode/commit/3e3547296e82fe6ac69f2f300ad97813017ad1f8", "message": "GEODE-7861: Improve error reporting in GMSJoinLeave.join()", "committedDate": "2020-12-10T23:53:11Z", "type": "forcePushed"}, {"oid": "0f96d92b4122d5657c1a8256407f0dc0f6b81878", "url": "https://github.com/apache/geode/commit/0f96d92b4122d5657c1a8256407f0dc0f6b81878", "message": "Fix LocatorDUnitTest.testNoLocator", "committedDate": "2020-12-11T05:45:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0NjM1Mw==", "url": "https://github.com/apache/geode/pull/5839#discussion_r544646353", "bodyText": "as I'm understanding this change, this section is the critical change to improve upon error reporting... I don't see unit testing for the improvement; there is a new test that looks for the above Exception string. Only it seems that a test could validate the expanded error information has been sent as well.", "author": "echobravopapa", "createdAt": "2020-12-16T21:47:29Z", "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeave.java", "diffHunk": "@@ -383,40 +383,44 @@ public boolean join() throws MemberStartupException {\n             break;\n           }\n         }\n-        try {\n-          if (found && !state.hasContactedAJoinedLocator) {\n-            // if locators are restarting they may be handing out IDs from a stale view that\n-            // we should go through quickly. Otherwise we should sleep a bit to let failure\n-            // detection select a new coordinator\n-            if (state.possibleCoordinator.getVmViewId() < 0) {\n-              logger.debug(\"sleeping for {} before making another attempt to find the coordinator\",\n-                  retrySleep);\n-              Thread.sleep(retrySleep);\n-            } else {\n+        if (found && !state.hasContactedAJoinedLocator) {\n+          try {\n+            if (hasCoordinatorJoinedCluster(state.possibleCoordinator.getVmViewId(), retrySleep)) {\n               // since we were given a coordinator that couldn't be used we should keep trying\n               tries = 0;\n               giveupTime = System.currentTimeMillis() + timeout;\n             }\n+          } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            throw new MembershipConfigurationException(\n+                \"Retry sleep interrupted. Giving up on joining the distributed system.\");\n           }\n-        } catch (InterruptedException e) {\n-          logger.debug(\"retry sleep interrupted - giving up on joining the distributed system\");\n-          return false;\n         }\n       } // for\n \n       if (!this.isJoined) {\n         logger.debug(\"giving up attempting to join the distributed system after \"\n             + (System.currentTimeMillis() - startTime) + \"ms\");\n-      }\n \n-      // to preserve old behavior we need to throw a MemberStartupException if\n-      // unable to contact any of the locators\n-      if (!this.isJoined && state.hasContactedAJoinedLocator) {\n-        throw new MemberStartupException(\"Unable to join the distributed system in \"\n-            + (System.currentTimeMillis() - startTime) + \"ms\");\n-      }\n+        // to preserve old behavior we need to throw a MemberStartupException if\n+        // unable to contact any of the locators\n+        if (state.hasContactedAJoinedLocator) {\n+          throw new MemberStartupException(\"Unable to join the distributed system in \"\n+              + (System.currentTimeMillis() - startTime) + \"ms\");\n+        }\n \n-      return this.isJoined;\n+        if (state.locatorsContacted == 0) {\n+          throw new MembershipConfigurationException(\n+              \"Unable to join the distributed system. Could not contact any of the locators: \"", "originalCommit": "3e3547296e82fe6ac69f2f300ad97813017ad1f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0OTM1OQ==", "url": "https://github.com/apache/geode/pull/5839#discussion_r544649359", "bodyText": "looks like this extraction was test driven", "author": "echobravopapa", "createdAt": "2020-12-16T21:52:51Z", "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeave.java", "diffHunk": "@@ -428,6 +432,24 @@ public boolean join() throws MemberStartupException {\n     }\n   }\n \n+  boolean hasCoordinatorJoinedCluster(int viewId, long retrySleep)", "originalCommit": "3e3547296e82fe6ac69f2f300ad97813017ad1f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc5NzI0NQ==", "url": "https://github.com/apache/geode/pull/5839#discussion_r546797245", "bodyText": "How about naming this something indicating that a sleep is going to be performed, like \"pauseIfThereIsNoCoordinator\"?", "author": "bschuchardt", "createdAt": "2020-12-21T16:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDY0OTM1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3MzcyOA==", "url": "https://github.com/apache/geode/pull/5839#discussion_r546773728", "bodyText": "I like it - using a \"when\" to throw an InterruptedException", "author": "bschuchardt", "createdAt": "2020-12-21T15:36:31Z", "path": "geode-membership/src/integrationTest/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeaveJUnitTest.java", "diffHunk": "@@ -1441,24 +1435,74 @@ public void testCoordinatorFindRequestSuccess() throws Exception {\n   public void testCoordinatorFindRequestFailure() throws Exception {\n     try {\n       initMocks(false);\n-      HashSet<MemberIdentifier> registrants = new HashSet<>();\n-      registrants.add(mockMembers[0]);\n-      FindCoordinatorResponse fcr = new FindCoordinatorResponse(mockMembers[0], mockMembers[0],\n-          false, null, registrants, false, true, null);\n+      mockRequestToServer(eq(new HostAndPort(\"localhost\", 12346)));\n       GMSMembershipView view = createView();\n       JoinResponseMessage jrm = new JoinResponseMessage(mockMembers[0], view, 0);\n       gmsJoinLeave.setJoinResponseMessage(jrm);\n \n-      when(locatorClient.requestToServer(eq(new HostAndPort(\"localhost\", 12346)),\n-          isA(FindCoordinatorRequest.class), anyInt(), anyBoolean()))\n-              .thenReturn(fcr);\n-\n-      assertFalse(\"Should not be able to join \", gmsJoinLeave.join());\n+      assertThatThrownBy(() -> gmsJoinLeave.join())\n+          .isInstanceOf(MembershipConfigurationException.class);\n     } finally {\n-\n     }\n   }\n \n+  @Test\n+  public void testJoinFailureWhenSleepInterrupted() throws Exception {\n+    initMocks(false);\n+    mockRequestToServer(isA(HostAndPort.class));\n+\n+    when(mockConfig.getMemberTimeout()).thenReturn(100L);\n+    when(mockConfig.getJoinTimeout()).thenReturn(1000L);\n+\n+    GMSJoinLeave spyGmsJoinLeave = spy(gmsJoinLeave);\n+    when(spyGmsJoinLeave.hasCoordinatorJoinedCluster(-1, GMSJoinLeave.JOIN_RETRY_SLEEP))\n+        .thenThrow(new InterruptedException());", "originalCommit": "0f96d92b4122d5657c1a8256407f0dc0f6b81878", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3NDY2NQ==", "url": "https://github.com/apache/geode/pull/5839#discussion_r546774665", "bodyText": "nice change to make this a \"void\" method that throws an exception if it doesn't succeed in joining the cluster", "author": "bschuchardt", "createdAt": "2020-12-21T15:38:13Z", "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/GMSMembership.java", "diffHunk": "@@ -565,12 +565,7 @@ private void join() throws MemberStartupException {\n         this.isJoining = true; // added for bug #44373\n \n         // connect\n-        boolean ok = services.getJoinLeave().join();\n-\n-        if (!ok) {\n-          throw new MembershipConfigurationException(\"Unable to join the distributed system.  \"\n-              + \"Operation either timed out, was stopped or Locator does not exist.\");\n-        }\n+        services.getJoinLeave().join();", "originalCommit": "0f96d92b4122d5657c1a8256407f0dc0f6b81878", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3NTY3OA==", "url": "https://github.com/apache/geode/pull/5839#discussion_r546775678", "bodyText": "This comment needs to be changed to reflect that the method now throws an exception if it's unable to join the cluster.  The comment should say which exception is thrown.  Should the exception be changed to be a checked exception instead of a runtime exception?", "author": "bschuchardt", "createdAt": "2020-12-21T15:40:07Z", "path": "geode-membership/src/main/java/org/apache/geode/distributed/internal/membership/gms/interfaces/JoinLeave.java", "diffHunk": "@@ -29,7 +29,7 @@\n    * joins the distributed system and returns true if successful, false if not. Throws", "originalCommit": "0f96d92b4122d5657c1a8256407f0dc0f6b81878", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4317d23794802642b7d92b8b7d59e6fec4fadeac", "url": "https://github.com/apache/geode/commit/4317d23794802642b7d92b8b7d59e6fec4fadeac", "message": "Changes after the code review", "committedDate": "2021-01-07T16:49:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MzQ3ODM3Mg==", "url": "https://github.com/apache/geode/pull/5839#discussion_r553478372", "bodyText": "typo:  \"startLocator\"", "author": "bschuchardt", "createdAt": "2021-01-07T17:36:15Z", "path": "geode-membership/src/integrationTest/java/org/apache/geode/distributed/internal/membership/gms/membership/GMSJoinLeaveJUnitTest.java", "diffHunk": "@@ -115,11 +117,18 @@ public void initMocks(boolean enableNetworkPartition) throws Exception {\n \n   public void initMocks(boolean enableNetworkPartition, boolean useTestGMSJoinLeave)\n       throws Exception {\n+    String locator = \"localhost[12345]\";\n+    initMocks(enableNetworkPartition, useTestGMSJoinLeave, locator, locator);\n+  }\n+\n+  public void initMocks(boolean enableNetworkPartition, boolean useTestGMSJoinLeave,\n+      String locators, String startLoactor)", "originalCommit": "4317d23794802642b7d92b8b7d59e6fec4fadeac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3112570a9a3083e6e8d7b9784629c2a03372ebac", "url": "https://github.com/apache/geode/commit/3112570a9a3083e6e8d7b9784629c2a03372ebac", "message": "Fix typo", "committedDate": "2021-01-08T18:06:10Z", "type": "commit"}]}