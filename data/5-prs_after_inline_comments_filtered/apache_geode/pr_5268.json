{"pr_number": 5268, "pr_title": "GEODE-8250: Create new custom log config acceptance tests", "pr_createdAt": "2020-06-17T19:48:48Z", "pr_url": "https://github.com/apache/geode/pull/5268", "timeline": [{"oid": "f12fbfa8fe4e3050e795516245db353cb6880168", "url": "https://github.com/apache/geode/commit/f12fbfa8fe4e3050e795516245db353cb6880168", "message": "GEODE-8250: Create new custom log config acceptance tests\n\nNew tests to discover and verify that use of custom log configs works\nwhen using GFSH to start Locator and Server.", "committedDate": "2020-06-17T19:27:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNjUwNA==", "url": "https://github.com/apache/geode/pull/5268#discussion_r442336504", "bodyText": "in order to use GfshRule you have to have geode home set already (it will give you an error if you don't). so you don't really need this rule here.", "author": "jinmeiliao", "createdAt": "2020-06-18T16:02:11Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/logging/LocatorWithCustomLogConfigAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,291 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.logging;\n+\n+import static java.nio.file.Files.copy;\n+import static org.apache.geode.internal.AvailablePortHelper.getRandomAvailableTCPPorts;\n+import static org.apache.geode.test.assertj.LogFileAssert.assertThat;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.apache.geode.test.util.ResourceUtils.createFileFromResource;\n+import static org.apache.geode.test.util.ResourceUtils.getResource;\n+\n+import java.nio.file.Path;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.junit.rules.TestName;\n+\n+import org.apache.geode.test.junit.rules.RequiresGeodeHome;\n+import org.apache.geode.test.junit.rules.gfsh.GfshRule;\n+\n+public class LocatorWithCustomLogConfigAcceptanceTest {\n+\n+  private static final String CONFIG_WITH_GEODE_PLUGINS_FILE_NAME =\n+      \"LocatorWithCustomLogConfigAcceptanceTestWithGeodePlugins.xml\";\n+  private static final String CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME =\n+      \"LocatorWithCustomLogConfigAcceptanceTestWithoutGeodePlugins.xml\";\n+\n+  private String locatorName;\n+  private Path workingDir;\n+  private int locatorPort;\n+  private int httpPort;\n+  private int rmiPort;\n+  private Path configWithGeodePluginsFile;\n+  private Path configWithoutGeodePluginsFile;\n+  private Path locatorLogFile;\n+  private Path pulseLogFile;\n+  private Path customLogFile;\n+\n+  @Rule\n+  public GfshRule gfshRule = new GfshRule();\n+  @Rule\n+  public RequiresGeodeHome requiresGeodeHome = new RequiresGeodeHome();", "originalCommit": "f12fbfa8fe4e3050e795516245db353cb6880168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3NjQxNw==", "url": "https://github.com/apache/geode/pull/5268#discussion_r444476417", "bodyText": "This change worked, but the other two changes don't work even after I removed the TemporaryFolder and use gfshRule.getTemporaryFolder().", "author": "kirklund", "createdAt": "2020-06-23T20:06:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjMzNjUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4Nzg2Mg==", "url": "https://github.com/apache/geode/pull/5268#discussion_r442387862", "bodyText": "GfshRule itself will try to stop all the processes it starts using the rule if you allow it to host the working dir of all the servers/locators it started. Using the gfshRule.getWorkingDir will get the temp folder that gfsh uses and all the servers/locators' working dir will be under there. That way, when tests finish, GfshRule will kill all the members automatically.", "author": "jinmeiliao", "createdAt": "2020-06-18T17:27:00Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/logging/LocatorWithCustomLogConfigAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,291 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.logging;\n+\n+import static java.nio.file.Files.copy;\n+import static org.apache.geode.internal.AvailablePortHelper.getRandomAvailableTCPPorts;\n+import static org.apache.geode.test.assertj.LogFileAssert.assertThat;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.apache.geode.test.util.ResourceUtils.createFileFromResource;\n+import static org.apache.geode.test.util.ResourceUtils.getResource;\n+\n+import java.nio.file.Path;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.junit.rules.TestName;\n+\n+import org.apache.geode.test.junit.rules.RequiresGeodeHome;\n+import org.apache.geode.test.junit.rules.gfsh.GfshRule;\n+\n+public class LocatorWithCustomLogConfigAcceptanceTest {\n+\n+  private static final String CONFIG_WITH_GEODE_PLUGINS_FILE_NAME =\n+      \"LocatorWithCustomLogConfigAcceptanceTestWithGeodePlugins.xml\";\n+  private static final String CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME =\n+      \"LocatorWithCustomLogConfigAcceptanceTestWithoutGeodePlugins.xml\";\n+\n+  private String locatorName;\n+  private Path workingDir;\n+  private int locatorPort;\n+  private int httpPort;\n+  private int rmiPort;\n+  private Path configWithGeodePluginsFile;\n+  private Path configWithoutGeodePluginsFile;\n+  private Path locatorLogFile;\n+  private Path pulseLogFile;\n+  private Path customLogFile;\n+\n+  @Rule\n+  public GfshRule gfshRule = new GfshRule();\n+  @Rule\n+  public RequiresGeodeHome requiresGeodeHome = new RequiresGeodeHome();\n+  @Rule\n+  public TemporaryFolder temporaryFolder = new TemporaryFolder();\n+  @Rule\n+  public TestName testName = new TestName();\n+\n+  @Before\n+  public void setUpLogConfigFiles() {\n+    configWithGeodePluginsFile = createFileFromResource(\n+        getResource(CONFIG_WITH_GEODE_PLUGINS_FILE_NAME), temporaryFolder.getRoot(),\n+        CONFIG_WITH_GEODE_PLUGINS_FILE_NAME)\n+            .toPath();\n+\n+    configWithoutGeodePluginsFile = createFileFromResource(\n+        getResource(CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME), temporaryFolder.getRoot(),\n+        CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME)\n+            .toPath();\n+  }\n+\n+  @Before\n+  public void setUpOutputFiles() {\n+    locatorName = testName.getMethodName();\n+\n+    workingDir = temporaryFolder.getRoot().toPath().toAbsolutePath();\n+    locatorLogFile = workingDir.resolve(locatorName + \".log\");\n+    pulseLogFile = workingDir.resolve(\"pulse.log\");\n+    customLogFile = workingDir.resolve(\"custom.log\");\n+  }\n+\n+  @Before\n+  public void setUpRandomPorts() {\n+    int[] ports = getRandomAvailableTCPPorts(3);\n+\n+    locatorPort = ports[0];\n+    httpPort = ports[1];\n+    rmiPort = ports[2];\n+  }\n+\n+  @After\n+  public void stopLocator() {\n+    gfshRule.execute(\"stop locator --dir=\" + workingDir);", "originalCommit": "f12fbfa8fe4e3050e795516245db353cb6880168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3NzQ3MQ==", "url": "https://github.com/apache/geode/pull/5268#discussion_r444477471", "bodyText": "Looks like GfshRule is setup to really only work one way and that's to be 100% hands off with workingDir but the problem is I need the workingDir to contain the log4j2.xml and I need to add the workingDir to the classpath. When I do this, GfshRule fails to stop any processes.", "author": "kirklund", "createdAt": "2020-06-23T20:08:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4Nzg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4ODI0Nw==", "url": "https://github.com/apache/geode/pull/5268#discussion_r442388247", "bodyText": "so basically, no need to give a dir here if you allow gfshrule to manage the dir", "author": "jinmeiliao", "createdAt": "2020-06-18T17:27:37Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/logging/LocatorWithCustomLogConfigAcceptanceTest.java", "diffHunk": "@@ -0,0 +1,291 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more contributor license\n+ * agreements. See the NOTICE file distributed with this work for additional information regarding\n+ * copyright ownership. The ASF licenses this file to You under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance with the License. You may obtain a\n+ * copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software distributed under the License\n+ * is distributed on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express\n+ * or implied. See the License for the specific language governing permissions and limitations under\n+ * the License.\n+ */\n+package org.apache.geode.logging;\n+\n+import static java.nio.file.Files.copy;\n+import static org.apache.geode.internal.AvailablePortHelper.getRandomAvailableTCPPorts;\n+import static org.apache.geode.test.assertj.LogFileAssert.assertThat;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;\n+import static org.apache.geode.test.util.ResourceUtils.createFileFromResource;\n+import static org.apache.geode.test.util.ResourceUtils.getResource;\n+\n+import java.nio.file.Path;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.junit.rules.TemporaryFolder;\n+import org.junit.rules.TestName;\n+\n+import org.apache.geode.test.junit.rules.RequiresGeodeHome;\n+import org.apache.geode.test.junit.rules.gfsh.GfshRule;\n+\n+public class LocatorWithCustomLogConfigAcceptanceTest {\n+\n+  private static final String CONFIG_WITH_GEODE_PLUGINS_FILE_NAME =\n+      \"LocatorWithCustomLogConfigAcceptanceTestWithGeodePlugins.xml\";\n+  private static final String CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME =\n+      \"LocatorWithCustomLogConfigAcceptanceTestWithoutGeodePlugins.xml\";\n+\n+  private String locatorName;\n+  private Path workingDir;\n+  private int locatorPort;\n+  private int httpPort;\n+  private int rmiPort;\n+  private Path configWithGeodePluginsFile;\n+  private Path configWithoutGeodePluginsFile;\n+  private Path locatorLogFile;\n+  private Path pulseLogFile;\n+  private Path customLogFile;\n+\n+  @Rule\n+  public GfshRule gfshRule = new GfshRule();\n+  @Rule\n+  public RequiresGeodeHome requiresGeodeHome = new RequiresGeodeHome();\n+  @Rule\n+  public TemporaryFolder temporaryFolder = new TemporaryFolder();\n+  @Rule\n+  public TestName testName = new TestName();\n+\n+  @Before\n+  public void setUpLogConfigFiles() {\n+    configWithGeodePluginsFile = createFileFromResource(\n+        getResource(CONFIG_WITH_GEODE_PLUGINS_FILE_NAME), temporaryFolder.getRoot(),\n+        CONFIG_WITH_GEODE_PLUGINS_FILE_NAME)\n+            .toPath();\n+\n+    configWithoutGeodePluginsFile = createFileFromResource(\n+        getResource(CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME), temporaryFolder.getRoot(),\n+        CONFIG_WITHOUT_GEODE_PLUGINS_FILE_NAME)\n+            .toPath();\n+  }\n+\n+  @Before\n+  public void setUpOutputFiles() {\n+    locatorName = testName.getMethodName();\n+\n+    workingDir = temporaryFolder.getRoot().toPath().toAbsolutePath();\n+    locatorLogFile = workingDir.resolve(locatorName + \".log\");\n+    pulseLogFile = workingDir.resolve(\"pulse.log\");\n+    customLogFile = workingDir.resolve(\"custom.log\");\n+  }\n+\n+  @Before\n+  public void setUpRandomPorts() {\n+    int[] ports = getRandomAvailableTCPPorts(3);\n+\n+    locatorPort = ports[0];\n+    httpPort = ports[1];\n+    rmiPort = ports[2];\n+  }\n+\n+  @After\n+  public void stopLocator() {\n+    gfshRule.execute(\"stop locator --dir=\" + workingDir);\n+  }\n+\n+  @Test\n+  public void locatorLauncherUsesDefaultLoggingConfig() {\n+    String startLocatorCommand = String.join(\" \",\n+        \"start locator\",\n+        \"--name=\" + locatorName,\n+        \"--dir=\" + workingDir,", "originalCommit": "f12fbfa8fe4e3050e795516245db353cb6880168", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ3NjA1Nw==", "url": "https://github.com/apache/geode/pull/5268#discussion_r444476057", "bodyText": "Unfortunately, some of these tests need to add a log4j2.xml file into the classpath (ie, in the workingDir which is then added to the classpath). I've tried making the changes you recommend, but GfshRule does leave the processes around -- it doesn't succeed in stopping them.", "author": "kirklund", "createdAt": "2020-06-23T20:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjM4ODI0Nw=="}], "type": "inlineReview"}, {"oid": "54e4bd4d407db98de90a7de7e29568134fdd0684", "url": "https://github.com/apache/geode/commit/54e4bd4d407db98de90a7de7e29568134fdd0684", "message": "=Trigger", "committedDate": "2020-06-23T20:10:21Z", "type": "commit"}]}