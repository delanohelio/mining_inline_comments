{"pr_number": 4833, "pr_title": "Feature/geode 6536 2: Added retry in borrowConnection/single hop", "pr_createdAt": "2020-03-20T20:31:51Z", "pr_url": "https://github.com/apache/geode/pull/4833", "timeline": [{"oid": "e8d53f154be335cf2e6e5c0fecbc0748bf393c8f", "url": "https://github.com/apache/geode/commit/e8d53f154be335cf2e6e5c0fecbc0748bf393c8f", "message": "GEODE-6536_2: change exception type", "committedDate": "2020-03-21T10:15:35Z", "type": "forcePushed"}, {"oid": "50f187f767534fd9936e39de88c3ec83bbc4e01b", "url": "https://github.com/apache/geode/commit/50f187f767534fd9936e39de88c3ec83bbc4e01b", "message": "GEODE-6536_2: change exception type", "committedDate": "2020-03-21T11:13:41Z", "type": "forcePushed"}, {"oid": "0203011644e708bd3d8d8b6a3dc550638f357102", "url": "https://github.com/apache/geode/commit/0203011644e708bd3d8d8b6a3dc550638f357102", "message": "GEODE-6536_2: change exception type", "committedDate": "2020-03-21T12:31:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTgwMw==", "url": "https://github.com/apache/geode/pull/4833#discussion_r396689803", "bodyText": "Sorry, if i missed this in earlier comments. The \"onlyUseExistingCnx\" indicates no new connection to be created, by the time this gets checked, a create connection attempt will be made if \"tryCreate\" is true (above logic).\nIt seems right to keep the condition check as If(onlyUseExistingCnx) { throw new AllConnectionsInUseException();} if there are no connection to this server available, the exception may be handled differently based on the caller.", "author": "agingade", "createdAt": "2020-03-23T19:05:11Z", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -338,6 +335,10 @@ public PooledConnection borrowConnection(ServerLocation server, long acquireTime\n               }\n             }\n           }\n+          if (null != connection) {\n+            return connection;\n+          }\n+          throw new ServerConnectivityException(BORROW_CONN_ERROR_MSG + server);\n         }\n \n         if (!onlyUseExistingCnx) {", "originalCommit": "0203011644e708bd3d8d8b6a3dc550638f357102", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwNTgyOQ==", "url": "https://github.com/apache/geode/pull/4833#discussion_r396705829", "bodyText": "I introduced logic simular to borrowConnection, because if connectins in pool are not up to maximum, why we could not create new connection. And if \"onlyUseExistingCnx\" is set to false, we will create new connection, even if we exceed maximum.\nBut, I can return to previous implementation.", "author": "mivanac", "createdAt": "2020-03-23T19:33:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTgwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcyODY0NA==", "url": "https://github.com/apache/geode/pull/4833#discussion_r396728644", "bodyText": "Agree with your thinking in relation to max-connection; but this arguments seems to enforce that only existing connection needs to be used.", "author": "agingade", "createdAt": "2020-03-23T20:12:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY4OTgwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Njc3NA==", "url": "https://github.com/apache/geode/pull/4833#discussion_r396696774", "bodyText": "If the tryCreate() is true, and for any reason, unable to create connection, it should be in the loop till the specified timeout (server-timeout), right? throwing an exception here will return before the specified wait time.", "author": "agingade", "createdAt": "2020-03-23T19:17:54Z", "path": "geode-core/src/main/java/org/apache/geode/cache/client/internal/pooling/ConnectionManagerImpl.java", "diffHunk": "@@ -338,6 +335,10 @@ public PooledConnection borrowConnection(ServerLocation server, long acquireTime\n               }\n             }\n           }\n+          if (null != connection) {\n+            return connection;\n+          }\n+          throw new ServerConnectivityException(BORROW_CONN_ERROR_MSG + server);", "originalCommit": "0203011644e708bd3d8d8b6a3dc550638f357102", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcxMTkyMA==", "url": "https://github.com/apache/geode/pull/4833#discussion_r396711920", "bodyText": "It is simular to borrowConnection() implementation, so we are reatempting, until we can try to create connection (until pool size drops bellow maximum). If server is unreachable, we will throw exception.", "author": "mivanac", "createdAt": "2020-03-23T19:43:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Njc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjczMTkxNg==", "url": "https://github.com/apache/geode/pull/4833#discussion_r396731916", "bodyText": "OK, i get your point. I was thinking of the case, where server is busy when this connection is attempted. Also, do we need to handle GemFireSecurityException?", "author": "agingade", "createdAt": "2020-03-23T20:19:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Njc3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIwNjE0Ng==", "url": "https://github.com/apache/geode/pull/4833#discussion_r400206146", "bodyText": "As I said, logic is the same as for borrowConnection(), so I would not change this logic.", "author": "mivanac", "createdAt": "2020-03-30T13:49:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Njc3NA=="}], "type": "inlineReview"}, {"oid": "333f2111c2635909fefc136912c3fb8996deb1af", "url": "https://github.com/apache/geode/commit/333f2111c2635909fefc136912c3fb8996deb1af", "message": "GEODE-6536: Added retry in borrowConnection/single hop", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "7766e7ca8d53ca222029c2d572bd06ccc47d0aba", "url": "https://github.com/apache/geode/commit/7766e7ca8d53ca222029c2d572bd06ccc47d0aba", "message": "GEODE-6536: bug fix", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "d3cdfe15bdbbb979e0b44aeebeab121f0be3868a", "url": "https://github.com/apache/geode/commit/d3cdfe15bdbbb979e0b44aeebeab121f0be3868a", "message": "GEODE-6536: update after comments", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "0f7ae5a32168ebc0110cdeb15ff141dca4974ee3", "url": "https://github.com/apache/geode/commit/0f7ae5a32168ebc0110cdeb15ff141dca4974ee3", "message": "GEODE-6536: modify borrowConnection singleHop solution", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "82799d8f6d8987136502f2aecd1102207469a1e0", "url": "https://github.com/apache/geode/commit/82799d8f6d8987136502f2aecd1102207469a1e0", "message": "GEODE-6536: test update", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "52139beae6e873350c719cefbac635f4e20e2e5a", "url": "https://github.com/apache/geode/commit/52139beae6e873350c719cefbac635f4e20e2e5a", "message": "GEODE-6536: updated tests, and added parameter to desable timeout", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "f3a7ac37b78cf9ad60597d041da8c8c62b45644f", "url": "https://github.com/apache/geode/commit/f3a7ac37b78cf9ad60597d041da8c8c62b45644f", "message": "GEODE-6536: update of cachexml impacts", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "a0f60e1d91541060553f23f6b6777d08c8469d1a", "url": "https://github.com/apache/geode/commit/a0f60e1d91541060553f23f6b6777d08c8469d1a", "message": "GEODE-6536: remove cachexml restriction", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "ca9fefeac72fa3ab169115f59333171357a1b0f9", "url": "https://github.com/apache/geode/commit/ca9fefeac72fa3ab169115f59333171357a1b0f9", "message": "GEODE-6536: update default value and documentation", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "76ca09d568bbcd48abbcea2153e475aae93e89ce", "url": "https://github.com/apache/geode/commit/76ca09d568bbcd48abbcea2153e475aae93e89ce", "message": "GEODE-6536_2: change exception type", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "6466ca8abbd2dd1e28c35cd276c607ef0365a283", "url": "https://github.com/apache/geode/commit/6466ca8abbd2dd1e28c35cd276c607ef0365a283", "message": "GEODE-6536_2: seize new connection only in case onlyUseExistingCnx=false", "committedDate": "2020-03-24T17:18:31Z", "type": "commit"}, {"oid": "6466ca8abbd2dd1e28c35cd276c607ef0365a283", "url": "https://github.com/apache/geode/commit/6466ca8abbd2dd1e28c35cd276c607ef0365a283", "message": "GEODE-6536_2: seize new connection only in case onlyUseExistingCnx=false", "committedDate": "2020-03-24T17:18:31Z", "type": "forcePushed"}]}