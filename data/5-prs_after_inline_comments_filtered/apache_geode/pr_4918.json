{"pr_number": 4918, "pr_title": "GEODE-7965: Modify Redis SADD command to use region.compute", "pr_createdAt": "2020-04-07T21:00:41Z", "pr_url": "https://github.com/apache/geode/pull/4918", "timeline": [{"oid": "a210defd36dcea32acbeeeada0c0a724f74a4f65", "url": "https://github.com/apache/geode/commit/a210defd36dcea32acbeeeada0c0a724f74a4f65", "message": "GEODE-7965: Modify Redis SADD command to use region.compute", "committedDate": "2020-04-07T21:30:20Z", "type": "forcePushed"}, {"oid": "d9958ac4ae57c70a13a3683146e60e320a4e2164", "url": "https://github.com/apache/geode/commit/d9958ac4ae57c70a13a3683146e60e320a4e2164", "message": "GEODE-7965: Modify Redis SADD command to use region.compute", "committedDate": "2020-04-08T17:58:54Z", "type": "commit"}, {"oid": "d9958ac4ae57c70a13a3683146e60e320a4e2164", "url": "https://github.com/apache/geode/commit/d9958ac4ae57c70a13a3683146e60e320a4e2164", "message": "GEODE-7965: Modify Redis SADD command to use region.compute", "committedDate": "2020-04-08T17:58:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3MjcxNg==", "url": "https://github.com/apache/geode/pull/4918#discussion_r405872716", "bodyText": "Remove this printStackTrace. logger.error will log a stack trace if you do this: logger.error(\"description of context\", e);\nBasically we never want to see e.printStackTrace in geode code. Always use a logger instead.", "author": "dschneider-pivotal", "createdAt": "2020-04-08T23:31:00Z", "path": "geode-redis/src/main/java/org/apache/geode/redis/internal/ExecutionHandlerContext.java", "diffHunk": "@@ -146,6 +146,7 @@ public void channelRead(ChannelHandlerContext ctx, Object msg) throws Exception\n       executeCommand(ctx, command);\n     } catch (Exception e) {\n       logger.error(e);\n+      e.printStackTrace();", "originalCommit": "d9958ac4ae57c70a13a3683146e60e320a4e2164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NDA5MA==", "url": "https://github.com/apache/geode/pull/4918#discussion_r406394090", "bodyText": "done - thanks!", "author": "jhutchison", "createdAt": "2020-04-09T18:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3MjcxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3MzM5Nw==", "url": "https://github.com/apache/geode/pull/4918#discussion_r405873397", "bodyText": "Remove this printStackTrace call. Since \"t\" is given to ToDataException it seems like that should be enough. If you do need something here use the logger but I would advise against that and leave it up to the handler of the ToDataException to display the cause.", "author": "dschneider-pivotal", "createdAt": "2020-04-08T23:33:09Z", "path": "geode-core/src/main/java/org/apache/geode/internal/InternalDataSerializer.java", "diffHunk": "@@ -1506,7 +1506,9 @@ public static void writeDSFID(DataSerializableFixedID o, DataOutput out) throws\n       // error condition, so you also need to check to see if the JVM\n       // is still usable:\n       SystemFailure.checkFailure();\n+      t.printStackTrace();", "originalCommit": "d9958ac4ae57c70a13a3683146e60e320a4e2164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NDA1OA==", "url": "https://github.com/apache/geode/pull/4918#discussion_r406394058", "bodyText": "done - thanks!", "author": "jhutchison", "createdAt": "2020-04-09T18:25:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3MzM5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3MzczMQ==", "url": "https://github.com/apache/geode/pull/4918#discussion_r405873731", "bodyText": "delete this blank line", "author": "dschneider-pivotal", "createdAt": "2020-04-08T23:34:02Z", "path": "geode-core/src/main/java/org/apache/geode/internal/InternalDataSerializer.java", "diffHunk": "@@ -1506,7 +1506,9 @@ public static void writeDSFID(DataSerializableFixedID o, DataOutput out) throws\n       // error condition, so you also need to check to see if the JVM\n       // is still usable:\n       SystemFailure.checkFailure();\n+      t.printStackTrace();\n       throw new ToDataException(\"toData failed on dsfid=\" + dsfid + \" msg:\" + t.getMessage(), t);\n+", "originalCommit": "d9958ac4ae57c70a13a3683146e60e320a4e2164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5NDAyOA==", "url": "https://github.com/apache/geode/pull/4918#discussion_r406394028", "bodyText": "done - thanks!", "author": "jhutchison", "createdAt": "2020-04-09T18:24:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3MzczMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3NDQzOA==", "url": "https://github.com/apache/geode/pull/4918#discussion_r405874438", "bodyText": "Do these tests still fail intermittently even with the compute fix?", "author": "dschneider-pivotal", "createdAt": "2020-04-08T23:36:22Z", "path": "geode-redis/src/distributedTest/java/org/apache/geode/redis/RedisDistDUnitTest.java", "diffHunk": "@@ -84,7 +89,62 @@ public static void setup() {\n     client2 = cluster.getVM(4);\n   }\n \n+  class ConcurrentSADDOperation extends ClientTestBase {\n+\n+    private final Collection<String> strings;\n+    private final String key;\n+\n+    protected ConcurrentSADDOperation(int port, String key, Collection<String> strings) {\n+      super(port);\n+      this.strings = strings;\n+      this.key = key;\n+    }\n+\n+    @Override\n+    public void run() {\n+      Jedis jedis = new Jedis(LOCALHOST, port, JEDIS_TIMEOUT);\n+      for (String member : strings) {\n+        jedis.sadd(key, member);\n+      }\n+    }\n+  }\n+\n   @Test\n+  public void testConcurrentSaddOperations_runWithoutException_orDataLoss()\n+      throws InterruptedException {\n+    List<String> set1 = new ArrayList<>();\n+    List<String> set2 = new ArrayList<>();\n+    int setSize = populateSetValueArrays(set1, set2);\n+\n+    final String setName = \"keyset\";\n+\n+    AsyncInvocation<Void> remoteSaddInvocation =\n+        client1.invokeAsync(new ConcurrentSADDOperation(server1Port, setName, set1));\n+\n+    client2.invoke(new ConcurrentSADDOperation(server2Port, setName, set2));\n+\n+    remoteSaddInvocation.await();\n+\n+    Jedis jedis = new Jedis(LOCALHOST, server1Port, JEDIS_TIMEOUT);\n+\n+    Set<String> smembers = jedis.smembers(setName);\n+\n+    assertThat(smembers).hasSize(setSize * 2);\n+    assertThat(smembers).contains(set1.toArray(new String[] {}));\n+    assertThat(smembers).contains(set2.toArray(new String[] {}));\n+  }\n+\n+  private int populateSetValueArrays(List<String> set1, List<String> set2) {\n+    int setSize = 5000;\n+    for (int i = 0; i < setSize; i++) {\n+      set1.add(\"SETA-\" + i);\n+      set2.add(\"SETB-\" + i);\n+    }\n+    return setSize;\n+  }\n+\n+  @Test\n+  @Ignore(\"GEODE-7905\")", "originalCommit": "d9958ac4ae57c70a13a3683146e60e320a4e2164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5Mzk4NQ==", "url": "https://github.com/apache/geode/pull/4918#discussion_r406393985", "bodyText": "so the scope of this story changed-  original branch was dealing with number of commands.  This story now only deals with the SADD command.  We wouldn't expect those tests to pass until the code related to those commands are changed (though we did not explicitly run those testsdone)", "author": "jhutchison", "createdAt": "2020-04-09T18:24:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3NDQzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3NTI4OA==", "url": "https://github.com/apache/geode/pull/4918#discussion_r405875288", "bodyText": "It seems like you are expecting a certain exception here. Can it be made more specific than \"Exception\"?", "author": "dschneider-pivotal", "createdAt": "2020-04-08T23:39:12Z", "path": "geode-redis/src/integrationTest/java/org/apache/geode/redis/SetsIntegrationTest.java", "diffHunk": "@@ -98,6 +101,42 @@ public void testSAddSCard() {\n     assertThat(jedis.scard(key)).isEqualTo(strings.size());\n   }\n \n+  @Rule\n+  public ExpectedException exceptionRule = ExpectedException.none();\n+\n+  @Test\n+  public void testSAdd_withExistingKey_ofWrongType_shouldReturnError() {\n+    String key = \"key\";\n+    String stringValue = \"preexistingValue\";\n+    String[] setValue = new String[1];\n+    setValue[0] = \"set value that should never get added\";\n+\n+    exceptionRule.expect(JedisDataException.class);\n+    exceptionRule.expectMessage(RedisConstants.ERROR_WRONG_TYPE);\n+\n+    jedis.set(key, stringValue);\n+    jedis.sadd(key, setValue);\n+  }\n+\n+  @Test\n+  public void testSAdd_withExistingKey_ofWrongType_shouldNotOverWriteExistingKey() {\n+    String key = \"key\";\n+    String stringValue = \"preexistingValue\";\n+    String[] setValue = new String[1];\n+    setValue[0] = \"set value that should never get added\";\n+\n+    jedis.set(key, stringValue);\n+\n+    try {\n+      jedis.sadd(key, setValue);\n+    } catch (Exception exception) {", "originalCommit": "d9958ac4ae57c70a13a3683146e60e320a4e2164", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjM5Mzk3MA==", "url": "https://github.com/apache/geode/pull/4918#discussion_r406393970", "bodyText": "done!", "author": "jhutchison", "createdAt": "2020-04-09T18:24:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg3NTI4OA=="}], "type": "inlineReview"}, {"oid": "66c1b8c73ad16d2e9625671492723b6ae8772b94", "url": "https://github.com/apache/geode/commit/66c1b8c73ad16d2e9625671492723b6ae8772b94", "message": "correct issues related to comments in commit review;  remove byteArrayWrapper from sanctionedSerializable.txt", "committedDate": "2020-04-09T18:24:31Z", "type": "commit"}]}