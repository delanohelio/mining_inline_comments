{"pr_number": 5562, "pr_title": "GEODE-8542: java.lang.IllegalStateException: tcp message exceeded max\u2026", "pr_createdAt": "2020-09-25T22:57:39Z", "pr_url": "https://github.com/apache/geode/pull/5562", "timeline": [{"oid": "77ae5ed125bd6235de8cf508a3b897e0b079444e", "url": "https://github.com/apache/geode/commit/77ae5ed125bd6235de8cf508a3b897e0b079444e", "message": "GEODE-8542: java.lang.IllegalStateException: tcp message exceeded max size of 16777215\n\nLimit the size of message chunks to the maximum message size allowed\nby org.apache.geode.internal.tcp.Connection.", "committedDate": "2020-09-25T22:56:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODMxNg==", "url": "https://github.com/apache/geode/pull/5562#discussion_r496068316", "bodyText": "I don't know why this code was changed to make the second connection (instead of the first), the old version connection. But the resulting code seems just as correct as the old code  \u2713", "author": "Bill", "createdAt": "2020-09-28T16:09:08Z", "path": "geode-core/src/test/java/org/apache/geode/internal/tcp/MsgStreamerTest.java", "diffHunk": "@@ -92,9 +117,9 @@ protected BaseMsgStreamer createMsgStreamer(boolean mixedDestinationVersions) {\n     when(connection2.getRemoteAddress()).thenReturn(member2);\n     when(connection2.getSendBufferSize()).thenReturn(Connection.SMALL_BUFFER_SIZE);\n     if (mixedDestinationVersions) {\n-      when(connection1.getRemoteVersion()).thenReturn(KnownVersion.GEODE_1_12_0);\n+      when(connection2.getRemoteVersion()).thenReturn(KnownVersion.GEODE_1_12_0);\n     } else {\n-      when(connection1.getRemoteVersion()).thenReturn(KnownVersion.CURRENT);\n+      when(connection2.getRemoteVersion()).thenReturn(KnownVersion.CURRENT);", "originalCommit": "77ae5ed125bd6235de8cf508a3b897e0b079444e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE5NTk5OQ==", "url": "https://github.com/apache/geode/pull/5562#discussion_r496195999", "bodyText": "connection2 does not seem to be used in the test cases", "author": "echobravopapa", "createdAt": "2020-09-28T19:54:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc3ODIxNg==", "url": "https://github.com/apache/geode/pull/5562#discussion_r496778216", "bodyText": "@Bill the version for connection1 was already established.  The if/else statement is to establish the version for connection2.  This was a cut and paste error that I fixed.", "author": "bschuchardt", "createdAt": "2020-09-29T14:45:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2ODMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2OTA2NA==", "url": "https://github.com/apache/geode/pull/5562#discussion_r496069064", "bodyText": "This test could be stronger if the requested message size was MAX_MSG_SIZE + 1. As it stands this test allows a lot of wiggle-room for the implementation.", "author": "Bill", "createdAt": "2020-09-28T16:10:15Z", "path": "geode-core/src/test/java/org/apache/geode/internal/tcp/MsgStreamerTest.java", "diffHunk": "@@ -77,6 +77,31 @@ public void streamerListReleaseWithException() throws IOException {\n     verify(pool, times(2)).releaseSenderBuffer(isA(ByteBuffer.class));\n   }\n \n+  @Test\n+  public void streamerRespectsMaxMessageSize() {\n+    InternalDistributedMember member1;\n+    member1 = new InternalDistributedMember(\"localhost\", 1234);\n+\n+    DistributionMessage message = new SerialAckedMessage();\n+    message.setRecipients(Arrays.asList(member1));\n+\n+    when(connection1.getRemoteAddress()).thenReturn(member1);\n+    when(connection1.getRemoteVersion()).thenReturn(KnownVersion.CURRENT);\n+    // create a streamer for a Connection that has a buffer size that's larger than the\n+    // biggest message we can actually send. This is picked up by the MsgStreamer to allocate\n+    // a buffer\n+    when(connection1.getSendBufferSize()).thenReturn(Connection.MAX_MSG_SIZE * 2);", "originalCommit": "77ae5ed125bd6235de8cf508a3b897e0b079444e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjA2OTY4NQ==", "url": "https://github.com/apache/geode/pull/5562#discussion_r496069685", "bodyText": "since this class is in the same package as Connection this seems like appropriate coupling \u2713", "author": "Bill", "createdAt": "2020-09-28T16:11:08Z", "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/MsgStreamer.java", "diffHunk": "@@ -129,7 +130,8 @@ public ConnectExceptions getConnectExceptions() {\n     this.stats = stats;\n     this.msg = msg;\n     this.cons = cons;\n-    this.buffer = bufferPool.acquireDirectSenderBuffer(sendBufferSize);\n+    int bufferSize = Math.min(sendBufferSize, Connection.MAX_MSG_SIZE);\n+    this.buffer = bufferPool.acquireDirectSenderBuffer(bufferSize);", "originalCommit": "77ae5ed125bd6235de8cf508a3b897e0b079444e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e6305ed270cdcfaa8f2e2fcfad1f7208d5b8cded", "url": "https://github.com/apache/geode/commit/e6305ed270cdcfaa8f2e2fcfad1f7208d5b8cded", "message": "implementing the change that Bill requested", "committedDate": "2020-09-29T15:05:19Z", "type": "commit"}]}