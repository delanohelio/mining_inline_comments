{"pr_number": 5048, "pr_title": "GEODE-8020: buffer management problems", "pr_createdAt": "2020-05-04T21:34:22Z", "pr_url": "https://github.com/apache/geode/pull/5048", "timeline": [{"oid": "8eca65a4cfa34a51376962be87022d110904a722", "url": "https://github.com/apache/geode/commit/8eca65a4cfa34a51376962be87022d110904a722", "message": "GEODE-8020: buffer management problems\n\nThis fixes some buffer handling in MsgStreamerList and alters\nMstStreamer to avoid creating MsgStreamerList and VersionedMsgStreamers\nduring normal, non-upgrade, operations.\n\nIt also changes NioSslEngine to use synchronization in more places,\nnotably the close() method, which was possibly allowing multiple threads to\nchange the state of the engine.", "committedDate": "2020-05-04T21:30:27Z", "type": "commit"}, {"oid": "488bb12aa14a94ca54002a7346eb4c3b9f74171d", "url": "https://github.com/apache/geode/commit/488bb12aa14a94ca54002a7346eb4c3b9f74171d", "message": "revert unnecessary change to ClusterCommunicationsDUnitTest", "committedDate": "2020-05-05T14:56:46Z", "type": "commit"}, {"oid": "c6f34027f63dbb547d4ee41b27ee1c6bbe96b715", "url": "https://github.com/apache/geode/commit/c6f34027f63dbb547d4ee41b27ee1c6bbe96b715", "message": "fixing another null version check", "committedDate": "2020-05-05T18:22:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgzNzc0NQ==", "url": "https://github.com/apache/geode/pull/5048#discussion_r420837745", "bodyText": "that's cute, personalized data ;P", "author": "echobravopapa", "createdAt": "2020-05-06T14:30:36Z", "path": "geode-core/src/main/java/org/apache/geode/internal/net/NioSslEngine.java", "diffHunk": "@@ -398,6 +398,7 @@ public void close(SocketChannel socketChannel) {\n     } finally {\n       bufferPool.releaseBuffer(TRACKED_SENDER, myNetData);\n       bufferPool.releaseBuffer(TRACKED_RECEIVER, peerAppData);\n+      myNetData = null;", "originalCommit": "c6f34027f63dbb547d4ee41b27ee1c6bbe96b715", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDgzOTI5OA==", "url": "https://github.com/apache/geode/pull/5048#discussion_r420839298", "bodyText": "thx for removing all those crufty comments", "author": "echobravopapa", "createdAt": "2020-05-06T14:32:39Z", "path": "geode-core/src/main/java/org/apache/geode/internal/tcp/MsgStreamerList.java", "diffHunk": "@@ -63,25 +63,16 @@ public int writeMessage() throws IOException {\n     for (MsgStreamer streamer : this.streamers) {\n       if (ex != null) {\n         streamer.release();\n-        // TODO: shouldn't we call continue here?\n-        // It seems wrong to call writeMessage on a streamer we have just released.\n-        // But why do we call release on a streamer when we had an exception on one\n-        // of the previous streamer?\n-        // release clears the direct bb and returns it to the pool but leaves\n-        // it has the \"buffer\". THen we call writeMessage and it will use \"buffer\"\n-        // that has also been returned to the pool.\n-        // I think we only have a MsgStreamerList when a DS has a mix of versions\n-        // which usually is just during a rolling upgrade so that might be why we\n-        // haven't noticed this causing a bug.\n-      }\n-      try {\n-        result += streamer.writeMessage();\n-        // if there is an exception we need to finish the\n-        // loop and release the other streamer's buffers\n-      } catch (RuntimeException e) {\n-        ex = e;\n-      } catch (IOException e) {\n-        ioex = e;\n+      } else {", "originalCommit": "c6f34027f63dbb547d4ee41b27ee1c6bbe96b715", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg0NTM0OQ==", "url": "https://github.com/apache/geode/pull/5048#discussion_r420845349", "bodyText": "is the GF prefixed version of the property need to be exposed/documented?", "author": "echobravopapa", "createdAt": "2020-05-06T14:40:24Z", "path": "geode-core/src/main/java/org/apache/geode/internal/net/BufferPool.java", "diffHunk": "@@ -69,7 +74,8 @@ public BufferPool(DMStats stats) {\n   /**\n    * use direct ByteBuffers instead of heap ByteBuffers for NIO operations\n    */\n-  public static final boolean useDirectBuffers = !Boolean.getBoolean(\"p2p.nodirectBuffers\");\n+  public static final boolean useDirectBuffers = !(Boolean.getBoolean(\"p2p.nodirectBuffers\")\n+      || Boolean.getBoolean(GeodeGlossary.GEMFIRE_PREFIX + \"noDirectBuffers\"));", "originalCommit": "c6f34027f63dbb547d4ee41b27ee1c6bbe96b715", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg1MzI1NQ==", "url": "https://github.com/apache/geode/pull/5048#discussion_r420853255", "bodyText": "is the GF prefixed version of the property need to be exposed/documented?\n\nyes, but I'm not sure what the best way is to do that.  I updated properties.html in this PR with the new property.", "author": "bschuchardt", "createdAt": "2020-05-06T14:50:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDg0NTM0OQ=="}], "type": "inlineReview"}, {"oid": "b010e4ddbca1637f6d675e58b1b4b97746a18b75", "url": "https://github.com/apache/geode/commit/b010e4ddbca1637f6d675e58b1b4b97746a18b75", "message": "renamed new BufferPool property", "committedDate": "2020-05-06T18:01:53Z", "type": "commit"}, {"oid": "e616190d63fe4702ca2f6a64a38cdfd0e8286b4e", "url": "https://github.com/apache/geode/commit/e616190d63fe4702ca2f6a64a38cdfd0e8286b4e", "message": "restore logging of ssl exceptions", "committedDate": "2020-05-06T23:37:27Z", "type": "commit"}]}