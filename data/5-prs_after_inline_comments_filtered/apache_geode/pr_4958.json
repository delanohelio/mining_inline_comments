{"pr_number": 4958, "pr_title": "GEODE-7852: test ClientHealthMonitor functionality behind a SNI gateway", "pr_createdAt": "2020-04-14T18:33:52Z", "pr_url": "https://github.com/apache/geode/pull/4958", "timeline": [{"oid": "23a09ad96fa586f42cc88f572429568da5594e9a", "url": "https://github.com/apache/geode/commit/23a09ad96fa586f42cc88f572429568da5594e9a", "message": "GEODE-7852: test ClientHealthMonitor functionality behind a SNI gateway\n\nThis ensures that a server sitting behind an SNI gateway detects the\nloss of a client and cleans up after it.  In this case the test detects\nthat the server has closed CQs created by the non-durable client.\n\nSince test code is not accessible in the Docker container that's running\nthe server I've enhanced the StatArchiveReader to be able to report the\nvalues of a statistic and have enabled statistics recording in the\nserver.\n\n(cherry picked from commit 376df4cc7abc6db38b4b298f8af6f3c53baedf15)", "committedDate": "2020-04-14T18:31:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3NDMzMg==", "url": "https://github.com/apache/geode/pull/4958#discussion_r408374332", "bodyText": "do we need this log in the test output?", "author": "Bill", "createdAt": "2020-04-14T19:14:36Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/client/sni/ClientSNICQAcceptanceTest.java", "diffHunk": "@@ -107,9 +111,18 @@ public void before() throws IOException, InterruptedException {\n \n   }\n \n+  @After\n+  public void after() throws Exception {\n+    String output =\n+        docker.exec(options(\"-T\"), \"geode\", arguments(\"cat\", \"server-dolores/server-dolores.log\"));\n+    System.out.println(\"Server log file--------------------------------\\n\" + output);", "originalCommit": "23a09ad96fa586f42cc88f572429568da5594e9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ0Njg0NQ==", "url": "https://github.com/apache/geode/pull/4958#discussion_r408446845", "bodyText": "Dan thought it was a good idea for the SingleServer test & I thought so, too.  If something goes wrong you probably want this output in the logs.", "author": "bschuchardt", "createdAt": "2020-04-14T21:28:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3NDMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3NzYwMA==", "url": "https://github.com/apache/geode/pull/4958#discussion_r408377600", "bodyText": "Now that we have NotOnWindowsDockerRule, we have the ability for a test to start containers once and to break actual testing into multiple test methods. We do it that way (in SingleServerSNIAcceptanceTest and DualServerSNIAcceptanceTest) for performance reasons\u2014we don't want to take too many minutes out of our CI pipeline, for SNI testing.\nSo for these reasons I think we should do one of two things:\n\nuse NotOnWindowsDockerRule here, and break these tests into multiple test methods\ngo further, and transfer these CQ tests over to the SingleServerSNIAcceptanceTest class (eliminating this test class entirely)\n\nI can see why we might want to do (1) even though it will add more Docker startup/teardown time (versus (2)), since there is some CQ-specific stuff here: 3 fields and an inner (CqListener) class.", "author": "Bill", "createdAt": "2020-04-14T19:20:31Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/client/sni/ClientSNICQAcceptanceTest.java", "diffHunk": "@@ -22,6 +22,7 @@\n import static org.apache.geode.distributed.ConfigurationProperties.SSL_REQUIRE_AUTHENTICATION;\n import static org.apache.geode.distributed.ConfigurationProperties.SSL_TRUSTSTORE;\n import static org.apache.geode.distributed.ConfigurationProperties.SSL_TRUSTSTORE_PASSWORD;\n+import static org.apache.geode.test.awaitility.GeodeAwaitility.await;", "originalCommit": "23a09ad96fa586f42cc88f572429568da5594e9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ0ODE0Ng==", "url": "https://github.com/apache/geode/pull/4958#discussion_r408448146", "bodyText": "There's only one test in this class.  No need for the ClassRule, though we could standardize on using it if we want.  The SingleServer test expects the same content to be in the server cache for each test, so I don't think it would be appropriate to add this test to it without addressing that.  I would rather keep this class and have it focus on subscriptions.", "author": "bschuchardt", "createdAt": "2020-04-14T21:31:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3NzYwMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ2MTIwMA==", "url": "https://github.com/apache/geode/pull/4958#discussion_r408461200", "bodyText": "I've changed this to a ClassRule", "author": "bschuchardt", "createdAt": "2020-04-14T21:59:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3NzYwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODI4Nw==", "url": "https://github.com/apache/geode/pull/4958#discussion_r408378287", "bodyText": "do we need/want these stats in the test output?", "author": "Bill", "createdAt": "2020-04-14T19:21:42Z", "path": "geode-assembly/src/acceptanceTest/java/org/apache/geode/client/sni/ClientSNICQAcceptanceTest.java", "diffHunk": "@@ -152,6 +165,21 @@ public void performSimpleCQOverSNIProxy()\n \n     assertThat(eventUpdateCounter.get()).isEqualTo(62);\n \n+    // verify that the server cleans up when the client connection to the gateway is destroyed\n+    ((PoolImpl) cache.getDefaultPool()).killPrimaryEndpoint();\n+    // since we can't run code in the server let's grab the CQ statistics and verify that\n+    // the CQ has been closed. StatArchiveReader has a main() that we can use to get a printout\n+    // of stat values\n+    await().untilAsserted(() -> {\n+      String stats = docker.exec(options(\"-T\"), \"geode\",\n+          arguments(\"java\", \"-cp\", \"/geode/lib/geode-dependencies.jar\",\n+              \"org.apache.geode.internal.statistics.StatArchiveReader\",\n+              \"stat\", \"server-dolores/statArchive.gfs\", \"CqServiceStats.numCqsClosed\"));\n+      System.out.println(\"stats from server are :\" + stats);", "originalCommit": "23a09ad96fa586f42cc88f572429568da5594e9a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ0ODU3MQ==", "url": "https://github.com/apache/geode/pull/4958#discussion_r408448571", "bodyText": "Yes, if something goes wrong we can see why things didn't match in the awaitility failure message.  Helped me a lot.", "author": "bschuchardt", "createdAt": "2020-04-14T21:32:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODM3ODI4Nw=="}], "type": "inlineReview"}, {"oid": "e1159b9f351bda1ce261966d466be404a4980895", "url": "https://github.com/apache/geode/commit/e1159b9f351bda1ce261966d466be404a4980895", "message": "change the docker rule to be a class-rule in case we add more tests to this class", "committedDate": "2020-04-14T21:54:13Z", "type": "commit"}, {"oid": "313f4b4ddc3481bd8eb14de8b1b73ce2e0abb8e6", "url": "https://github.com/apache/geode/commit/313f4b4ddc3481bd8eb14de8b1b73ce2e0abb8e6", "message": "removed system.out.println per Bill's review", "committedDate": "2020-04-14T22:43:45Z", "type": "commit"}]}