{"pr_number": 641, "pr_title": "combine checkbox values for openmrs entities", "pr_createdAt": "2020-09-09T14:43:40Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/641", "timeline": [{"oid": "4efd3c38f07c3866d56d622d7d4421cbbeadbdcb", "url": "https://github.com/opensrp/opensrp-client-core/commit/4efd3c38f07c3866d56d622d7d4421cbbeadbdcb", "message": "combine checkbox values for openmrs entities", "committedDate": "2020-09-09T14:42:54Z", "type": "commit"}, {"oid": "27858faed8d80f89fc4eb5f39dc78c294a08f173", "url": "https://github.com/opensrp/opensrp-client-core/commit/27858faed8d80f89fc4eb5f39dc78c294a08f173", "message": "Merge branch 'master' into combine-check-box-values-for-concept", "committedDate": "2020-09-09T14:48:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5NzY0Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486897646", "bodyText": "Should these be part of the if block? Is it used elsewhere?", "author": "vincent-karuri", "createdAt": "2020-09-11T09:18:57Z", "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -407,26 +409,39 @@ private static JSONObject getCheckBoxJsonObjects(Event event, JSONObject parentO\n \n     public static void addObservation(Event e, JSONObject jsonObject) {\n         String value = getString(jsonObject, VALUE);\n-        if (StringUtils.isBlank(value)) { return; }\n+        if (StringUtils.isBlank(value)) {\n+            return;\n+        }\n \n         String type = getString(jsonObject, AllConstants.TYPE);\n         if (AllConstants.CHECK_BOX.equals(type)) {\n             try {\n                 List<Object> optionValues = new ArrayList<>();\n+                List<Object> optionEntityIds = new ArrayList<>();\n                 Map<String, Object> optionKeyVals = new HashMap<>();\n                 if (jsonObject.has(AllConstants.OPTIONS)) {\n                     JSONArray options = jsonObject.getJSONArray(AllConstants.OPTIONS);\n+                    boolean shouldBeCombined = jsonObject.optBoolean(AllConstants.COMBINE_CHECKBOX_OPTION_VALUES);\n+                    String entity = getString(jsonObject, OPENMRS_ENTITY);\n                     for (int i = 0; i < options.length(); i++) {\n                         JSONObject option = options.getJSONObject(i);\n                         boolean optionValue = option.optBoolean(VALUE);\n                         if (!optionValue) {\n                             continue;\n                         }\n-                        if (CONCEPT.equals(getString(jsonObject, OPENMRS_ENTITY))) {\n+                        if (CONCEPT.equals(entity)) {\n+                            String optionKey = option.optString(KEY);\n+                            String openmrsEntityId = option.optString(OPENMRS_ENTITY_ID);", "originalCommit": "27858faed8d80f89fc4eb5f39dc78c294a08f173", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkwNTg4NA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486905884", "bodyText": "yeah it should be part since, it checks first if it is a concept before starting the combination", "author": "bennsimon", "createdAt": "2020-09-11T09:26:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5NzY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkzMDM1Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486930356", "bodyText": "Sorry, meant should it move to the if block at line 440?", "author": "vincent-karuri", "createdAt": "2020-09-11T09:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5NzY0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk1MDY4MA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486950680", "bodyText": "ok changing", "author": "bennsimon", "createdAt": "2020-09-11T10:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5NzY0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5ODg4OA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486898888", "bodyText": "Isn't createObservation being called on line 445?", "author": "vincent-karuri", "createdAt": "2020-09-11T09:20:14Z", "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -435,8 +450,13 @@ public static void addObservation(Event e, JSONObject jsonObject) {\n                         }\n                     }\n                     if (!optionValues.isEmpty()) {\n-                        // For options without concepts combine the values into one observation\n-                        createObservation(e, jsonObject, optionKeyVals, optionValues);\n+                        if (CONCEPT.equals(entity) && shouldBeCombined) {\n+                            e.addObs(new Obs(CONCEPT, AllConstants.CHECK_BOX, jsonObject.optString(OPENMRS_ENTITY_ID), jsonObject.optString(OPENMRS_ENTITY_PARENT), optionEntityIds, optionValues, null,\n+                                    jsonObject.optString(KEY)));", "originalCommit": "27858faed8d80f89fc4eb5f39dc78c294a08f173", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5OTc0Mg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486899742", "bodyText": "Or are we going for duplicate obs for backward compatibility?", "author": "vincent-karuri", "createdAt": "2020-09-11T09:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5ODg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkwODM3NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486908375", "bodyText": "these are combined values hence, only one obs need to be created, This check shouldBeCombined ensures that its working only when combined AllConstants.COMBINE_CHECKBOX_OPTION_VALUES is added to the field", "author": "bennsimon", "createdAt": "2020-09-11T09:29:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5ODg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkyMjA3Mw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486922073", "bodyText": "I think you can define, jsonObject.optString(OPENMRS_ENTITY_ID), jsonObject.optString(OPENMRS_ENTITY_PARENT), jsonObject.optString(KEY) once, since they're used elsewhere in this block.", "author": "vincent-karuri", "createdAt": "2020-09-11T09:43:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5ODg4OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkyNTI4NA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486925284", "bodyText": "cool, changing", "author": "bennsimon", "createdAt": "2020-09-11T09:46:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njg5ODg4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkwMTE0Nw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486901147", "bodyText": "Not sure I understand this change?", "author": "vincent-karuri", "createdAt": "2020-09-11T09:22:26Z", "path": "opensrp-app/src/main/java/org/smartregister/location/helper/LocationHelper.java", "diffHunk": "@@ -168,7 +168,7 @@ public String getOpenMrsLocationId(@NonNull String locationName) {\n         } catch (Exception e) {\n             Timber.e(e);\n         }\n-        return locationName.equals(response) ? AllConstants.ADVANCED_DATA_CAPTURE_STRATEGY_PREFIX + locationName.trim().replaceAll(\" \", \"-\").toLowerCase(Locale.ENGLISH) : response;\n+        return response;", "originalCommit": "27858faed8d80f89fc4eb5f39dc78c294a08f173", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkwNDE1OQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486904159", "bodyText": "@ndegwamartin  made this change an just reverting it since it breaks our code. I have discussed with him", "author": "bennsimon", "createdAt": "2020-09-11T09:25:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkwMTE0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkyODA3OA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486928078", "bodyText": "cool", "author": "vincent-karuri", "createdAt": "2020-09-11T09:49:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjkwMTE0Nw=="}], "type": "inlineReview"}, {"oid": "a804d99ef338ba2fb915e2b527c9c5f21807c120", "url": "https://github.com/opensrp/opensrp-client-core/commit/a804d99ef338ba2fb915e2b527c9c5f21807c120", "message": "add variables to be reused", "committedDate": "2020-09-11T09:52:51Z", "type": "commit"}, {"oid": "908d23f4eaa6b85270e4dd207b67fb10296ecf33", "url": "https://github.com/opensrp/opensrp-client-core/commit/908d23f4eaa6b85270e4dd207b67fb10296ecf33", "message": "Merge branch 'combine-check-box-values-for-concept' of github.com:OpenSRP/opensrp-client-core into combine-check-box-values-for-concept", "committedDate": "2020-09-11T09:53:34Z", "type": "commit"}, {"oid": "4fba12a5fbcb4f5f65e1534e26d1880303deb562", "url": "https://github.com/opensrp/opensrp-client-core/commit/4fba12a5fbcb4f5f65e1534e26d1880303deb562", "message": "change the scope of option variables\n\nupdate snapshot version", "committedDate": "2020-09-11T10:18:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjI0MQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486982241", "bodyText": "fieldKey?", "author": "vincent-karuri", "createdAt": "2020-09-11T11:26:13Z", "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -407,26 +409,42 @@ private static JSONObject getCheckBoxJsonObjects(Event event, JSONObject parentO\n \n     public static void addObservation(Event e, JSONObject jsonObject) {\n         String value = getString(jsonObject, VALUE);\n-        if (StringUtils.isBlank(value)) { return; }\n+        if (StringUtils.isBlank(value)) {\n+            return;\n+        }\n \n         String type = getString(jsonObject, AllConstants.TYPE);\n         if (AllConstants.CHECK_BOX.equals(type)) {\n             try {\n                 List<Object> optionValues = new ArrayList<>();\n+                List<Object> optionEntityIds = new ArrayList<>();\n                 Map<String, Object> optionKeyVals = new HashMap<>();\n                 if (jsonObject.has(AllConstants.OPTIONS)) {\n                     JSONArray options = jsonObject.getJSONArray(AllConstants.OPTIONS);\n+                    String fieldsOpenmrsEntityId = jsonObject.optString(OPENMRS_ENTITY_ID);\n+                    String fieldOpenmrsEntityParent = jsonObject.optString(OPENMRS_ENTITY_PARENT);\n+                    String fieldKey = jsonObject.optString(KEY);\n+                    boolean shouldBeCombined = jsonObject.optBoolean(AllConstants.COMBINE_CHECKBOX_OPTION_VALUES);\n+                    String entity = getString(jsonObject, OPENMRS_ENTITY);\n                     for (int i = 0; i < options.length(); i++) {\n                         JSONObject option = options.getJSONObject(i);\n                         boolean optionValue = option.optBoolean(VALUE);\n                         if (!optionValue) {\n                             continue;\n                         }\n-                        if (CONCEPT.equals(getString(jsonObject, OPENMRS_ENTITY))) {\n+                        if (CONCEPT.equals(entity)) {\n                             // For options with concepts create an observation for each\n                             option.put(AllConstants.TYPE, type);\n-                            option.put(AllConstants.PARENT_ENTITY_ID, jsonObject.getString(OPENMRS_ENTITY_ID));\n+                            option.put(AllConstants.PARENT_ENTITY_ID, fieldsOpenmrsEntityId);\n                             option.put(KEY, jsonObject.getString(KEY));", "originalCommit": "4fba12a5fbcb4f5f65e1534e26d1880303deb562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk5ODIwMA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486998200", "bodyText": "jsonObject.getString(OPENMRS_ENTITY_ID) is fieldsOpenmrsEntityId otherwise i dont get the question", "author": "bennsimon", "createdAt": "2020-09-11T12:01:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk5OTU3Nw==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486999577", "bodyText": "Replace jsonObject.getString(KEY) with fieldKey.", "author": "vincent-karuri", "createdAt": "2020-09-11T12:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAwMjU5OQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r487002599", "bodyText": "cool changing", "author": "bennsimon", "createdAt": "2020-09-11T12:10:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjY2MA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486982660", "bodyText": "Should this be part of an else block?\nDo we need to do this if someone explicitly specifies that they should be combined?", "author": "vincent-karuri", "createdAt": "2020-09-11T11:27:11Z", "path": "opensrp-app/src/main/java/org/smartregister/util/JsonFormUtils.java", "diffHunk": "@@ -407,26 +409,42 @@ private static JSONObject getCheckBoxJsonObjects(Event event, JSONObject parentO\n \n     public static void addObservation(Event e, JSONObject jsonObject) {\n         String value = getString(jsonObject, VALUE);\n-        if (StringUtils.isBlank(value)) { return; }\n+        if (StringUtils.isBlank(value)) {\n+            return;\n+        }\n \n         String type = getString(jsonObject, AllConstants.TYPE);\n         if (AllConstants.CHECK_BOX.equals(type)) {\n             try {\n                 List<Object> optionValues = new ArrayList<>();\n+                List<Object> optionEntityIds = new ArrayList<>();\n                 Map<String, Object> optionKeyVals = new HashMap<>();\n                 if (jsonObject.has(AllConstants.OPTIONS)) {\n                     JSONArray options = jsonObject.getJSONArray(AllConstants.OPTIONS);\n+                    String fieldsOpenmrsEntityId = jsonObject.optString(OPENMRS_ENTITY_ID);\n+                    String fieldOpenmrsEntityParent = jsonObject.optString(OPENMRS_ENTITY_PARENT);\n+                    String fieldKey = jsonObject.optString(KEY);\n+                    boolean shouldBeCombined = jsonObject.optBoolean(AllConstants.COMBINE_CHECKBOX_OPTION_VALUES);\n+                    String entity = getString(jsonObject, OPENMRS_ENTITY);\n                     for (int i = 0; i < options.length(); i++) {\n                         JSONObject option = options.getJSONObject(i);\n                         boolean optionValue = option.optBoolean(VALUE);\n                         if (!optionValue) {\n                             continue;\n                         }\n-                        if (CONCEPT.equals(getString(jsonObject, OPENMRS_ENTITY))) {\n+                        if (CONCEPT.equals(entity)) {\n                             // For options with concepts create an observation for each\n                             option.put(AllConstants.TYPE, type);\n-                            option.put(AllConstants.PARENT_ENTITY_ID, jsonObject.getString(OPENMRS_ENTITY_ID));\n+                            option.put(AllConstants.PARENT_ENTITY_ID, fieldsOpenmrsEntityId);\n                             option.put(KEY, jsonObject.getString(KEY));\n+\n+                            if (shouldBeCombined) {\n+                                String optionKey = option.optString(KEY);\n+                                String optionsOpenmrsEntityId = option.optString(OPENMRS_ENTITY_ID);\n+                                optionValues.add(optionKey);\n+                                optionEntityIds.add(optionsOpenmrsEntityId);\n+                                continue;\n+                            }\n                             createObservation(e, option, String.valueOf(option.getBoolean(VALUE)));", "originalCommit": "4fba12a5fbcb4f5f65e1534e26d1880303deb562", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk5NzM3Ng==", "url": "https://github.com/opensrp/opensrp-client-core/pull/641#discussion_r486997376", "bodyText": "it can but continue takes care of it", "author": "bennsimon", "createdAt": "2020-09-11T11:59:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Njk4MjY2MA=="}], "type": "inlineReview"}, {"oid": "43b318c9276c789c242cd208bcc933c02fec9233", "url": "https://github.com/opensrp/opensrp-client-core/commit/43b318c9276c789c242cd208bcc933c02fec9233", "message": "code cleanup", "committedDate": "2020-09-11T12:35:12Z", "type": "commit"}]}