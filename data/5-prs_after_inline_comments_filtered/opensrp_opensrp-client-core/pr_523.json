{"pr_number": 523, "pr_title": "Load subforms & rules files from db", "pr_createdAt": "2020-05-14T15:38:31Z", "pr_url": "https://github.com/opensrp/opensrp-client-core/pull/523", "timeline": [{"oid": "c25e3f3af82b630ab57c99b36906ff5a61076542", "url": "https://github.com/opensrp/opensrp-client-core/commit/c25e3f3af82b630ab57c99b36906ff5a61076542", "message": "Fix loading sub-forms & forms\n\n- URL Encode client form identifiers\n- Fix issue where client form identifier with backslash cannot be fetched from server because the backslash is not escaped", "committedDate": "2020-05-14T15:50:38Z", "type": "forcePushed"}, {"oid": "0324dc6ebefdee178d9d575d2e6cf48909fdfcf4", "url": "https://github.com/opensrp/opensrp-client-core/commit/0324dc6ebefdee178d9d575d2e6cf48909fdfcf4", "message": "Load sub-forms & rules from the DB in JSONFormActivity\n\n- Extends JsonFormActivity\n- Add native form as a dependency", "committedDate": "2020-05-15T08:53:11Z", "type": "commit"}, {"oid": "1937d723cb7f44be8cda3cff1006849861f1d80d", "url": "https://github.com/opensrp/opensrp-client-core/commit/1937d723cb7f44be8cda3cff1006849861f1d80d", "message": "Fix loading sub-forms & forms\n\n- URL Encode client form identifiers\n- Fix issue where client form identifier with backslash cannot be fetched from server because the backslash is not escaped", "committedDate": "2020-05-15T08:53:12Z", "type": "commit"}, {"oid": "201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "url": "https://github.com/opensrp/opensrp-client-core/commit/201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "message": "Change native-form version to 1.8.6-SNAPSHOT", "committedDate": "2020-05-15T08:53:12Z", "type": "commit"}, {"oid": "201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "url": "https://github.com/opensrp/opensrp-client-core/commit/201aed1a96ea7c1a6ea2f11041f9b2972e18e0d0", "message": "Change native-form version to 1.8.6-SNAPSHOT", "committedDate": "2020-05-15T08:53:12Z", "type": "forcePushed"}, {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "url": "https://github.com/opensrp/opensrp-client-core/commit/d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "message": "Revert escaping of backslach & cleanup code", "committedDate": "2020-05-15T10:00:57Z", "type": "commit"}, {"oid": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "url": "https://github.com/opensrp/opensrp-client-core/commit/d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "message": "Revert escaping of backslach & cleanup code", "committedDate": "2020-05-15T10:00:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1MzU5MQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427153591", "bodyText": "use Locale.ENGLISH instead or en", "author": "dubdabasoduba", "createdAt": "2020-05-19T09:16:14Z", "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;\n+        ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = dbFormName.endsWith(\".json\")\n+                    ? dbFormName.substring(0, localeFormIdentity.length() - 5) : dbFormName + \".json\";\n+            clientForm = clientFormRepository.getActiveClientFormByIdentifier(revisedFormName);\n+\n+            if (clientForm == null) {\n+                String finalSubFormsLocation = com.vijay.jsonwizard.utils.FormUtils.getSubFormLocation(subFormsLocation);\n+                dbFormName = TextUtils.isEmpty(finalSubFormsLocation) ? localeFormIdentity : finalSubFormsLocation + \"/\" + localeFormIdentity;\n+                clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+            }\n+        }\n+\n+        try {\n+            if (clientForm != null) {\n+                Timber.d(\"============%s form loaded from db============\", dbFormName);\n+                String originalJson = clientForm.getJson();\n+\n+                return new JSONObject(NativeFormLangUtils.getTranslatedString(originalJson, context));\n+            }\n+        } catch (JSONException e) {\n+            Timber.e(e);\n+        }\n+\n+        return null;\n+    }\n+\n+    @Nullable\n+    public BufferedReader getRulesFromRepository(String fileName) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = fileName;\n+        if (!\"en\".equals(locale)) {", "originalCommit": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NDIwMQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427154201", "bodyText": "Where are this imports used in this class?", "author": "dubdabasoduba", "createdAt": "2020-05-19T09:17:13Z", "path": "opensrp-app/src/main/java/org/smartregister/service/DocumentConfigurationService.java", "diffHunk": "@@ -17,6 +17,8 @@\n import org.smartregister.repository.ClientFormRepository;\n import org.smartregister.repository.ManifestRepository;\n \n+import java.io.UnsupportedEncodingException;\n+import java.net.URLEncoder;", "originalCommit": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NTAyNA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427155024", "bodyText": "use Locale.ENGLISH instead of the  string en", "author": "dubdabasoduba", "createdAt": "2020-05-19T09:18:30Z", "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {", "originalCommit": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NzI5Mg==", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427157292", "bodyText": "StringUtils.isNotBlank or StringUtils.isBlank is more efficient than TextUtils.isEmpty since it checks for whitespaces too", "author": "dubdabasoduba", "createdAt": "2020-05-19T09:22:10Z", "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;", "originalCommit": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1NzU2NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427157565", "bodyText": "Can we have the .json  defined as a constant?", "author": "dubdabasoduba", "createdAt": "2020-05-19T09:22:41Z", "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;\n+        ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = dbFormName.endsWith(\".json\")", "originalCommit": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1ODY2NQ==", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427158665", "bodyText": "This has been repeated in line 1176 please refactor it for reuse", "author": "dubdabasoduba", "createdAt": "2020-05-19T09:24:30Z", "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1135,6 +1139,13 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         }\n \n         ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(localeFormIdentity);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = localeFormIdentity .endsWith(\".json\")\n+                    ? localeFormIdentity.substring(0, localeFormIdentity.length() - 5) : localeFormIdentity + \".json\";", "originalCommit": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzE1OTE4MA==", "url": "https://github.com/opensrp/opensrp-client-core/pull/523#discussion_r427159180", "bodyText": "StringUtils.isNotBlank or StringUtils.isBlank is more efficient than TextUtils.isEmpty since it checks for whitespaces too & refactor for reuse.", "author": "dubdabasoduba", "createdAt": "2020-05-19T09:25:17Z", "path": "opensrp-app/src/main/java/org/smartregister/util/FormUtils.java", "diffHunk": "@@ -1147,4 +1158,66 @@ public JSONObject getFormJsonFromRepositoryOrAssets(String formIdentity) {\n         return getFormJson(formIdentity);\n     }\n \n+    @Nullable\n+    public JSONObject getSubFormJsonFromRepository(String formIdentity, String subFormsLocation, Context context, boolean translateSubForm) {\n+        ClientFormRepository clientFormRepository = CoreLibrary.getInstance().context().getClientFormRepository();\n+        String locale = mContext.getResources().getConfiguration().locale.getLanguage();\n+\n+        //Check the current locale of the app to load the correct version of the form in the desired language\n+        String localeFormIdentity = formIdentity;\n+        if (!\"en\".equals(locale)) {\n+            localeFormIdentity = localeFormIdentity + \"-\" + locale;\n+        }\n+\n+        String dbFormName = TextUtils.isEmpty(subFormsLocation) ? localeFormIdentity : subFormsLocation + \"/\" + localeFormIdentity;\n+        ClientForm clientForm = clientFormRepository.getActiveClientFormByIdentifier(dbFormName);\n+\n+        if (clientForm == null) {\n+            String revisedFormName = dbFormName.endsWith(\".json\")\n+                    ? dbFormName.substring(0, localeFormIdentity.length() - 5) : dbFormName + \".json\";\n+            clientForm = clientFormRepository.getActiveClientFormByIdentifier(revisedFormName);\n+\n+            if (clientForm == null) {\n+                String finalSubFormsLocation = com.vijay.jsonwizard.utils.FormUtils.getSubFormLocation(subFormsLocation);\n+                dbFormName = TextUtils.isEmpty(finalSubFormsLocation) ? localeFormIdentity : finalSubFormsLocation + \"/\" + localeFormIdentity;", "originalCommit": "d78c3ac37e6631b2ce6f93afcabb9dd190633a67", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "96692c0ce82fc67f96dfd2b4cc218834cb0c2bc5", "url": "https://github.com/opensrp/opensrp-client-core/commit/96692c0ce82fc67f96dfd2b4cc218834cb0c2bc5", "message": "Code cleanup", "committedDate": "2020-05-19T12:20:14Z", "type": "commit"}, {"oid": "e7cd082786240081424a3b037a72911d57180c7f", "url": "https://github.com/opensrp/opensrp-client-core/commit/e7cd082786240081424a3b037a72911d57180c7f", "message": "Add tests for FormUtils", "committedDate": "2020-05-19T13:00:56Z", "type": "commit"}, {"oid": "9d86c1b44a64422e65c692e5de59c2fbfa228bed", "url": "https://github.com/opensrp/opensrp-client-core/commit/9d86c1b44a64422e65c692e5de59c2fbfa228bed", "message": "Add tests for DynamicJsonFormActivityTest", "committedDate": "2020-05-19T13:56:22Z", "type": "commit"}]}