{"pr_number": 3744, "pr_title": "Add support for commands.yml aliases in command cooldowns", "pr_createdAt": "2020-10-26T01:51:45Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3744", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTY4NzE5NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r511687194", "bodyText": "I'd just use ternary operator, ,something like:\nfinal String fullCommand =  (pluginCommand != null) pluginCommand.getName() + args : cmd + args;", "author": "benwoo1110", "createdAt": "2020-10-26T02:09:28Z", "path": "Essentials/src/com/earth2me/essentials/EssentialsPlayerListener.java", "diffHunk": "@@ -572,12 +572,18 @@ public void onPlayerCommandPreprocess(final PlayerCommandPreprocessEvent event)\n             user.updateActivityOnInteract(broadcast);\n         }\n \n-        if (ess.getSettings().isCommandCooldownsEnabled() && pluginCommand != null\n+        if (ess.getSettings().isCommandCooldownsEnabled()\n             && !user.isAuthorized(\"essentials.commandcooldowns.bypass\")) {\n             final int argStartIndex = event.getMessage().indexOf(\" \");\n             final String args = argStartIndex == -1 ? \"\" // No arguments present\n                 : \" \" + event.getMessage().substring(argStartIndex); // arguments start at argStartIndex; substring from there.\n-            final String fullCommand = pluginCommand.getName() + args;\n+\n+            final String fullCommand;", "originalCommit": "2dce6713c5776663d7602b22e54e784a2a85d85b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "39f2f4f9a2f2553a75e9a2d8feadc9ef53f5a2c6", "url": "https://github.com/EssentialsX/Essentials/commit/39f2f4f9a2f2553a75e9a2d8feadc9ef53f5a2c6", "message": "Fall back to command from PlayerPreProcessEvent in case PluginCommand is null", "committedDate": "2020-10-26T02:11:39Z", "type": "forcePushed"}, {"oid": "60db00a94db3bd863944fcd26fe89635ce312824", "url": "https://github.com/EssentialsX/Essentials/commit/60db00a94db3bd863944fcd26fe89635ce312824", "message": "Add support for command aliases in PlayerCommandPreProcessEvent", "committedDate": "2020-10-30T16:05:47Z", "type": "commit"}, {"oid": "60db00a94db3bd863944fcd26fe89635ce312824", "url": "https://github.com/EssentialsX/Essentials/commit/60db00a94db3bd863944fcd26fe89635ce312824", "message": "Add support for command aliases in PlayerCommandPreProcessEvent", "committedDate": "2020-10-30T16:05:47Z", "type": "forcePushed"}, {"oid": "dbcf797239a6205240063762ff10d8e483b812ef", "url": "https://github.com/EssentialsX/Essentials/commit/dbcf797239a6205240063762ff10d8e483b812ef", "message": "Merge branch '2.x' into fix/alias-command-cooldown", "committedDate": "2020-12-21T08:31:51Z", "type": "commit"}, {"oid": "e637e66987b02ccbb1fa740f9e57d9e0e0ee0e90", "url": "https://github.com/EssentialsX/Essentials/commit/e637e66987b02ccbb1fa740f9e57d9e0e0ee0e90", "message": "Move new files into src/main/java folders (as a result of refactor upstream)", "committedDate": "2020-12-21T08:49:53Z", "type": "commit"}, {"oid": "e637e66987b02ccbb1fa740f9e57d9e0e0ee0e90", "url": "https://github.com/EssentialsX/Essentials/commit/e637e66987b02ccbb1fa740f9e57d9e0e0ee0e90", "message": "Move new files into src/main/java folders (as a result of refactor upstream)", "committedDate": "2020-12-21T08:49:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA2OTMwNA==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r551069304", "bodyText": "is there a reason you didn't make a paper specific provider? also has this been tested on 1.8.8-1.16.4?", "author": "JRoy", "createdAt": "2021-01-03T23:35:18Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -329,6 +332,9 @@ public void onEnable() {\n                     knownCommandsProvider = new ReflKnownCommandsProvider();\n                 }\n \n+                //Command Alias provider\n+                formattedCommandAliasProvider = new ReflFormattedCommandAliasProvider(PaperLib.isPaper());", "originalCommit": "1a8d3dc34d8cf69ac8277f8e24bd3e8311c5cfa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ2NDcwMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r551464702", "bodyText": "Yup! should be working just fine on all implementations of paper (saw that the modification to FormattedCommandAliasProvider was added in to paper before the 1.8 launch), and its still present and works fine on the latest 1.16.4 version.\nI will update the class to make separate classes for both servertypes!", "author": "FrankHeijden", "createdAt": "2021-01-04T17:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA2OTMwNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTQ4OTAzMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r551489030", "bodyText": "Splitted the file up in a paper and spigot version, however, due to the need for the reflection library I also had to include the NMSReflectionProvider in the PaperProvider module -- not sure if that would be a problem?", "author": "FrankHeijden", "createdAt": "2021-01-04T18:27:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTA2OTMwNA=="}], "type": "inlineReview"}, {"oid": "b6c5cc3da6c9bee14c44c9c387dadf188b41e3f9", "url": "https://github.com/EssentialsX/Essentials/commit/b6c5cc3da6c9bee14c44c9c387dadf188b41e3f9", "message": "Refactor FormattedCommandAliasProvider\n- Split the provider up for both spigot/paper impl.", "committedDate": "2021-01-04T18:24:04Z", "type": "commit"}, {"oid": "b6c5cc3da6c9bee14c44c9c387dadf188b41e3f9", "url": "https://github.com/EssentialsX/Essentials/commit/b6c5cc3da6c9bee14c44c9c387dadf188b41e3f9", "message": "Refactor FormattedCommandAliasProvider\n- Split the provider up for both spigot/paper impl.", "committedDate": "2021-01-04T18:24:04Z", "type": "forcePushed"}, {"oid": "ad8ce92d3aabee857e2f9a0abf008d1cac89bbcd", "url": "https://github.com/EssentialsX/Essentials/commit/ad8ce92d3aabee857e2f9a0abf008d1cac89bbcd", "message": "Merge branch '2.x' into fix/alias-command-cooldown\n\n# Conflicts:\n#\tproviders/PaperProvider/build.gradle", "committedDate": "2021-01-04T18:26:05Z", "type": "commit"}, {"oid": "58fab762c6d5b0e00a76fc91c564ecd079ff5774", "url": "https://github.com/EssentialsX/Essentials/commit/58fab762c6d5b0e00a76fc91c564ecd079ff5774", "message": "Merge branch '2.x' into fix/alias-command-cooldown\n\n# Conflicts:\n#\tproviders/PaperProvider/build.gradle", "committedDate": "2021-01-16T20:41:27Z", "type": "commit"}, {"oid": "cd4007b9c7e7ac87eccda12df8c901457232ca52", "url": "https://github.com/EssentialsX/Essentials/commit/cd4007b9c7e7ac87eccda12df8c901457232ca52", "message": "Merge branch '2.x' into fix/alias-command-cooldown\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/Essentials.java", "committedDate": "2021-01-24T21:17:51Z", "type": "commit"}, {"oid": "cd4007b9c7e7ac87eccda12df8c901457232ca52", "url": "https://github.com/EssentialsX/Essentials/commit/cd4007b9c7e7ac87eccda12df8c901457232ca52", "message": "Merge branch '2.x' into fix/alias-command-cooldown\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/Essentials.java", "committedDate": "2021-01-24T21:17:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIwODg4Nw==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571208887", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            //Command Alias provider\n          \n          \n            \n                            // Command aliases provider", "author": "mdcfe", "createdAt": "2021-02-05T19:44:17Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -338,6 +342,13 @@ public void onEnable() {\n                     knownCommandsProvider = new ReflKnownCommandsProvider();\n                 }\n \n+                //Command Alias provider", "originalCommit": "cd4007b9c7e7ac87eccda12df8c901457232ca52", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c27c8e0170168b47eeed34ab3e2e58621a7c51c7", "url": "https://github.com/EssentialsX/Essentials/commit/c27c8e0170168b47eeed34ab3e2e58621a7c51c7", "message": "Update Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "committedDate": "2021-02-05T19:47:08Z", "type": "commit"}, {"oid": "e850e726c2a3cd8e73f873f92ff224fee1ac8d07", "url": "https://github.com/EssentialsX/Essentials/commit/e850e726c2a3cd8e73f873f92ff224fee1ac8d07", "message": "Merge branch '2.x' into fix/alias-command-cooldown", "committedDate": "2021-02-05T19:48:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMTA4MQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571221081", "bodyText": "Why are you using reflection here, let alone on a class already in the classpath?", "author": "JRoy", "createdAt": "2021-02-05T20:07:37Z", "path": "providers/NMSReflectionProvider/src/main/java/net/ess3/nms/refl/providers/ReflFormattedCommandAliasProvider.java", "diffHunk": "@@ -0,0 +1,52 @@\n+package net.ess3.nms.refl.providers;\n+\n+import net.ess3.nms.refl.ReflUtil;\n+import net.ess3.provider.FormattedCommandAliasProvider;\n+import org.bukkit.command.CommandSender;\n+import org.bukkit.command.FormattedCommandAlias;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+\n+public class ReflFormattedCommandAliasProvider extends FormattedCommandAliasProvider {\n+\n+    protected final Class<? extends FormattedCommandAlias> formattedCommandAliasClass;\n+    private final Field formatStringsField;\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public ReflFormattedCommandAliasProvider() {\n+        Class<? extends FormattedCommandAlias> formattedCommandAliasClass = null;\n+        Field formatStringsField = null;\n+        try {\n+            formattedCommandAliasClass = (Class<? extends FormattedCommandAlias>) ReflUtil.getOBClass(\"command.FormattedCommandAlias\");", "originalCommit": "e850e726c2a3cd8e73f873f92ff224fee1ac8d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzMzA2MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571233060", "bodyText": "I use reflection here, because the method FormattedCommandAlias#buildCommand(String, String[]) has private access, which we need to determine the commands which are being pointed to by this alias (and thus apply limitations / cooldowns on those).", "author": "FrankHeijden", "createdAt": "2021-02-05T20:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMTA4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzMzU0NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571233545", "bodyText": "Should have been more clear, I meant why are you getting the class with reflection? You can just use FormattedCommandAlias.class", "author": "JRoy", "createdAt": "2021-02-05T20:32:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMTA4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNDcyNg==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571234726", "bodyText": "Ah right, good call, will remove it.", "author": "FrankHeijden", "createdAt": "2021-02-05T20:35:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMTA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMjEzMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571222131", "bodyText": "if you just have to use reflection anyway, I'd rather we not use the Paper provider", "author": "JRoy", "createdAt": "2021-02-05T20:09:36Z", "path": "providers/PaperProvider/src/main/java/net/ess3/provider/providers/PaperReflFormattedCommandAliasProvider.java", "diffHunk": "@@ -0,0 +1,22 @@\n+package net.ess3.provider.providers;\n+\n+import net.ess3.nms.refl.ReflUtil;\n+import net.ess3.nms.refl.providers.ReflFormattedCommandAliasProvider;\n+import org.bukkit.command.CommandSender;\n+import org.bukkit.command.FormattedCommandAlias;\n+\n+import java.lang.reflect.Method;\n+\n+public class PaperReflFormattedCommandAliasProvider extends ReflFormattedCommandAliasProvider {\n+\n+    @Override\n+    public String buildCommand(FormattedCommandAlias command, CommandSender sender, String formatString, String[] args) {\n+        try {\n+            final Method buildCommandMethod = ReflUtil.getMethodCached(formattedCommandAliasClass, \"buildCommand\", CommandSender.class, String.class, String[].class);", "originalCommit": "e850e726c2a3cd8e73f873f92ff224fee1ac8d07", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzNDI2Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571234266", "bodyText": "Sure thing, will remove this call extra file -- however, in one of your earlier comments ( #3744 (comment) ) you suggested I created a Paper provider for this one; would it be okay to revert this change then? or what did you have it in mind?", "author": "FrankHeijden", "createdAt": "2021-02-05T20:34:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMjEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzODA3MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571238070", "bodyText": "Should have been more clear about this too, my point was if you need reflection for both Paper too, why do we need a Paper version too if they both do the same thing", "author": "JRoy", "createdAt": "2021-02-05T20:41:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMjEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIzOTgyMw==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571239823", "bodyText": "Ah, that's because paper appends the CommandSender in the buildCommand method. Are you suggesting we should just check this on the fly in the buildCommand method whether the paper / spigot version should be called?", "author": "FrankHeijden", "createdAt": "2021-02-05T20:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMjEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ1MDQzMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571450430", "bodyText": "Okay I understand the need for that now, I think the best choice is reverting back to that one provider in that case", "author": "JRoy", "createdAt": "2021-02-06T15:47:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMjEzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ1MjI4NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571452285", "bodyText": "Sounds good!", "author": "FrankHeijden", "createdAt": "2021-02-06T16:04:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTIyMjEzMQ=="}], "type": "inlineReview"}, {"oid": "32c65ea97f98f4399caf89a64c8464ba1c91939f", "url": "https://github.com/EssentialsX/Essentials/commit/32c65ea97f98f4399caf89a64c8464ba1c91939f", "message": "Remove reflection call for FormattedCommandAlias class", "committedDate": "2021-02-05T20:40:19Z", "type": "commit"}, {"oid": "345e425c60de8c57497068994e3f8465ea3dfb7c", "url": "https://github.com/EssentialsX/Essentials/commit/345e425c60de8c57497068994e3f8465ea3dfb7c", "message": "Revert back to initial reflection call\nRemoving PaperReflFormattedCommandAliasProvider.java and the need for the reflection library in paper providers.", "committedDate": "2021-02-06T16:17:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ1NDMwNA==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571454304", "bodyText": "should be an interface which extends Provider", "author": "JRoy", "createdAt": "2021-02-06T16:23:07Z", "path": "providers/BaseProviders/src/main/java/net/ess3/provider/FormattedCommandAliasProvider.java", "diffHunk": "@@ -0,0 +1,30 @@\n+package net.ess3.provider;\n+\n+import org.bukkit.command.CommandSender;\n+import org.bukkit.command.FormattedCommandAlias;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+public abstract class FormattedCommandAliasProvider {", "originalCommit": "345e425c60de8c57497068994e3f8465ea3dfb7c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ1NDc1NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571454755", "bodyText": "MethodHandles are more performant and should be used instead of java.lang.reflect's Method\nSee ReflServerStateProvider if you need to know how we use MethodHandle", "author": "JRoy", "createdAt": "2021-02-06T16:27:22Z", "path": "providers/NMSReflectionProvider/src/main/java/net/ess3/nms/refl/providers/ReflFormattedCommandAliasProvider.java", "diffHunk": "@@ -0,0 +1,60 @@\n+package net.ess3.nms.refl.providers;\n+\n+import net.ess3.nms.refl.ReflUtil;\n+import net.ess3.provider.FormattedCommandAliasProvider;\n+import org.bukkit.command.CommandSender;\n+import org.bukkit.command.FormattedCommandAlias;\n+\n+import java.lang.reflect.Field;\n+import java.lang.reflect.Method;\n+\n+public class ReflFormattedCommandAliasProvider extends FormattedCommandAliasProvider {\n+\n+    private final boolean paper;\n+    private final Field formatStringsField;\n+    private final Method buildCommandMethod;", "originalCommit": "345e425c60de8c57497068994e3f8465ea3dfb7c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ2NjM1Nw==", "url": "https://github.com/EssentialsX/Essentials/pull/3744#discussion_r571466357", "bodyText": "Sure thing!", "author": "FrankHeijden", "createdAt": "2021-02-06T18:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTQ1NDc1NQ=="}], "type": "inlineReview"}, {"oid": "b432c30105d24f059aa9a1f39609924452720480", "url": "https://github.com/EssentialsX/Essentials/commit/b432c30105d24f059aa9a1f39609924452720480", "message": "Use MethodHandles instead of Method invocations + Make FormattedCommandAliasProvider an interface", "committedDate": "2021-02-06T18:15:21Z", "type": "commit"}, {"oid": "736802df6e16341f655d6ec4de5596903b45e09f", "url": "https://github.com/EssentialsX/Essentials/commit/736802df6e16341f655d6ec4de5596903b45e09f", "message": "Merge branch '2.x' into fix/alias-command-cooldown", "committedDate": "2021-02-20T16:28:10Z", "type": "commit"}]}