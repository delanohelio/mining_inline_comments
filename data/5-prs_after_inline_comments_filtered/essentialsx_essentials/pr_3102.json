{"pr_number": 3102, "pr_title": "Reduce sync loads for teleporting", "pr_createdAt": "2020-03-28T19:55:10Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3102", "timeline": [{"oid": "0e1cb48d07bf2faacb41c6d6fd5276274ff97344", "url": "https://github.com/EssentialsX/Essentials/commit/0e1cb48d07bf2faacb41c6d6fd5276274ff97344", "message": "Reduce sync teleporting loads", "committedDate": "2020-03-28T19:33:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3MzE2MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400573160", "bodyText": "We never need an 'async' call inside any other 'async' callbacks because the chunk has already been loaded - this should make the code a lot nicer.", "author": "Ichbinjoe", "createdAt": "2020-03-31T00:28:43Z", "path": "Essentials/src/com/earth2me/essentials/Teleport.java", "diffHunk": "@@ -121,28 +121,38 @@ public void now(Player entity, boolean cooldown, TeleportCause cause) throws Exc\n     protected void now(IUser teleportee, ITarget target, TeleportCause cause) throws Exception {\n         cancel(false);\n         teleportee.setLastLocation();\n-        Location loc = target.getLocation();\n \n-        if (LocationUtil.isBlockUnsafeForUser(teleportee, loc.getWorld(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ())) {\n-            if (ess.getSettings().isTeleportSafetyEnabled()) {\n-                if (ess.getSettings().isForceDisableTeleportSafety()) {\n-                    PaperLib.teleportAsync(teleportee.getBase(), loc, cause);\n+        PaperLib.getChunkAtAsync(target.getLocation()).thenAccept(chunk -> {\n+            Location loc = target.getLocation();\n+            if (LocationUtil.isBlockUnsafeForUser(teleportee, chunk, loc.getBlockX(), loc.getBlockY(), loc.getBlockZ())) {\n+                if (ess.getSettings().isTeleportSafetyEnabled()) {\n+                    if (ess.getSettings().isForceDisableTeleportSafety()) {\n+                        PaperLib.teleportAsync(teleportee.getBase(), loc, cause);", "originalCommit": "0e1cb48d07bf2faacb41c6d6fd5276274ff97344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3OTk3OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400579978", "bodyText": "This would be a single line change but sure I guess", "author": "JRoy", "createdAt": "2020-03-31T00:53:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3MzE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Mzg4Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400573882", "bodyText": "I think you have hit the crux of why this hasn't happened previously :)\nWe can't throw the exception back upstream obviously because we are in a different stack frame. e.printStackTrace() isn't remotely acceptable, and even if it was, we lost the entire point of the exception - to notify the user that the destination of the teleport is unsafe. This is bad design in general (using exceptions as user feedback mechanisms), but unfortunately unless we are going to uproot the entire codebase its here to stay.\nA possible solution is to give now() a separate argument which accepts an exception as a callback, but that would bubble all the way up the stack as Node-esque hell. Not sure what the right solution here is.", "author": "Ichbinjoe", "createdAt": "2020-03-31T00:31:20Z", "path": "Essentials/src/com/earth2me/essentials/Teleport.java", "diffHunk": "@@ -121,28 +121,38 @@ public void now(Player entity, boolean cooldown, TeleportCause cause) throws Exc\n     protected void now(IUser teleportee, ITarget target, TeleportCause cause) throws Exception {\n         cancel(false);\n         teleportee.setLastLocation();\n-        Location loc = target.getLocation();\n \n-        if (LocationUtil.isBlockUnsafeForUser(teleportee, loc.getWorld(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ())) {\n-            if (ess.getSettings().isTeleportSafetyEnabled()) {\n-                if (ess.getSettings().isForceDisableTeleportSafety()) {\n-                    PaperLib.teleportAsync(teleportee.getBase(), loc, cause);\n+        PaperLib.getChunkAtAsync(target.getLocation()).thenAccept(chunk -> {\n+            Location loc = target.getLocation();\n+            if (LocationUtil.isBlockUnsafeForUser(teleportee, chunk, loc.getBlockX(), loc.getBlockY(), loc.getBlockZ())) {\n+                if (ess.getSettings().isTeleportSafetyEnabled()) {\n+                    if (ess.getSettings().isForceDisableTeleportSafety()) {\n+                        PaperLib.teleportAsync(teleportee.getBase(), loc, cause);\n+                    } else {\n+                        try {\n+                            PaperLib.teleportAsync(teleportee.getBase(), LocationUtil.getSafeDestination(ess, teleportee, loc), cause);\n+                        } catch (Exception e) {\n+                            e.printStackTrace();\n+                        }\n+                    }\n                 } else {\n-                    PaperLib.teleportAsync(teleportee.getBase(), LocationUtil.getSafeDestination(ess, teleportee, loc), cause);\n+                    try {\n+                        throw new Exception(tl(\"unsafeTeleportDestination\", loc.getWorld().getName(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ()));\n+                    } catch (Exception e) {\n+                        e.printStackTrace();\n+                    }", "originalCommit": "0e1cb48d07bf2faacb41c6d6fd5276274ff97344", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMjM1Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400612356", "bodyText": "I looked into it, creating a callable is way too much of hassle to do here than just printing the stack trace. The point of these exceptions are to inform the user of their own mistake. As you pointed out, these are poor uses of exceptions and would require an uproot of the entire codebase to get rid of these poor uses. That being said, I feel like that is not in the scope of this PR and should be addressed separately than hacking in something that would only be used here and not anywhere else.", "author": "JRoy", "createdAt": "2020-03-31T02:54:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Mzg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDYxMjgzMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400612832", "bodyText": "I would like the feedback of other team members on this as well!\nCC: @pop4959 @md678685", "author": "JRoy", "createdAt": "2020-03-31T02:55:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Mzg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY4NTYxNA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400685614", "bodyText": "Unfortunately without somehow signalling up to the user how things broke, this is a regression of behavior. I would also agree that fixing that is not in the scope of this PR, but breaking user experience changes like this has been something that EssentialsX has always tried to avoid (to its own peril a lot of the time sure, but then again server owners are an interesting bunch).\nhttps://xkcd.com/1172/", "author": "Ichbinjoe", "createdAt": "2020-03-31T07:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Mzg4Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTMxMjg2NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r401312865", "bodyText": "I haven't had the time to properly look into or test this PR yet, however I'll just say that existing behavior should be retained, including providing correct errors back to the user (and wherever else). If it's not possible to work around how Essentials' exception system works then it definitely blocks this PR and that will need to be taken care of first (perhaps by doing some refactoring so that the user errors can be accessed without needing to go through an exception). As Roy mentioned it is not in scope for this PR but it would certainly need to be addressed before pulling this.\nMD has been somewhat busy lately, so it may be a while for him to give some assessment on this, but I'll try to give this PR more love soon. We should definitely discuss this carefully and not rush to push out these changes before they are completely ready.", "author": "pop4959", "createdAt": "2020-04-01T01:56:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3Mzg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NDQxMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400574410", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    x = x & 0xF;\n          \n          \n            \n                    z = z & 0xF;\n          \n          \n            \n                    return y > chunk.getWorld().getMaxHeight() || HOLLOW_MATERIALS.contains(chunk.getBlock(x, y - 1, z).getType());\n          \n          \n            \n                    return y > chunk.getWorld().getMaxHeight() || HOLLOW_MATERIALS.contains(chunk.getBlock(x & 0xf, y - 1, z & 0xf).getType());\n          \n      \n    \n    \n  \n\nWhile Java doesn't do this, other languages this kind of assignment is scary, as you may be modifying the value out of scope. (You aren't here, you are fine, but it isn't a good pattern)", "author": "Ichbinjoe", "createdAt": "2020-03-31T00:33:27Z", "path": "Essentials/src/com/earth2me/essentials/utils/LocationUtil.java", "diffHunk": "@@ -89,26 +86,42 @@ public static Location getTarget(final LivingEntity entity) throws Exception {\n     }\n \n     public static boolean isBlockAboveAir(final World world, final int x, final int y, final int z) {\n-        return y > world.getMaxHeight() || HOLLOW_MATERIALS.contains(world.getBlockAt(x, y - 1, z).getType());\n+        return isBlockAboveAir(world.getChunkAt(x, z), x, y, z);\n+    }\n+\n+    public static boolean isBlockAboveAir(final Chunk chunk, int x, final int y, int z) {\n+        x = x & 0xF;\n+        z = z & 0xF;\n+        return y > chunk.getWorld().getMaxHeight() || HOLLOW_MATERIALS.contains(chunk.getBlock(x, y - 1, z).getType());", "originalCommit": "0e1cb48d07bf2faacb41c6d6fd5276274ff97344", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDU3NDc0MA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r400574740", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    x = x & 0xF;\n          \n          \n            \n                    z = z & 0xF;\n          \n          \n            \n                    final Block below = chunk.getBlock(x, y - 1, z);\n          \n          \n            \n                    final Block below = chunk.getBlock(x & 0xf, y - 1, z & 0xf);\n          \n      \n    \n    \n  \n\nsame as above", "author": "Ichbinjoe", "createdAt": "2020-03-31T00:34:36Z", "path": "Essentials/src/com/earth2me/essentials/utils/LocationUtil.java", "diffHunk": "@@ -89,26 +86,42 @@ public static Location getTarget(final LivingEntity entity) throws Exception {\n     }\n \n     public static boolean isBlockAboveAir(final World world, final int x, final int y, final int z) {\n-        return y > world.getMaxHeight() || HOLLOW_MATERIALS.contains(world.getBlockAt(x, y - 1, z).getType());\n+        return isBlockAboveAir(world.getChunkAt(x, z), x, y, z);\n+    }\n+\n+    public static boolean isBlockAboveAir(final Chunk chunk, int x, final int y, int z) {\n+        x = x & 0xF;\n+        z = z & 0xF;\n+        return y > chunk.getWorld().getMaxHeight() || HOLLOW_MATERIALS.contains(chunk.getBlock(x, y - 1, z).getType());\n     }\n \n     public static boolean isBlockUnsafeForUser(final IUser user, final World world, final int x, final int y, final int z) {\n-        if (user.getBase().isOnline() && world.equals(user.getBase().getWorld()) && (user.getBase().getGameMode() == GameMode.CREATIVE || user.getBase().getGameMode() == GameMode.SPECTATOR || user.isGodModeEnabled()) && user.getBase().getAllowFlight()) {\n+        return isBlockUnsafeForUser(user, world.getChunkAt(x, z), x, y, z);\n+    }\n+\n+    public static boolean isBlockUnsafeForUser(final IUser user, final Chunk chunk, final int x, final int y, final int z) {\n+        if (user.getBase().isOnline() && chunk.getWorld().equals(user.getBase().getWorld()) && (user.getBase().getGameMode() == GameMode.CREATIVE || user.getBase().getGameMode() == GameMode.SPECTATOR || user.isGodModeEnabled()) && user.getBase().getAllowFlight()) {\n             return false;\n         }\n \n-        if (isBlockDamaging(world, x, y, z)) {\n+        if (isBlockDamaging(chunk, x, y, z)) {\n             return true;\n         }\n-        return isBlockAboveAir(world, x, y, z);\n+        return isBlockAboveAir(chunk, x, y, z);\n     }\n \n     public static boolean isBlockUnsafe(final World world, final int x, final int y, final int z) {\n         return isBlockDamaging(world, x, y, z) || isBlockAboveAir(world, x, y, z);\n     }\n \n     public static boolean isBlockDamaging(final World world, final int x, final int y, final int z) {\n-        final Block below = world.getBlockAt(x, y - 1, z);\n+        return isBlockDamaging(world.getChunkAt(x, z), x, y, z);\n+    }\n+\n+    public static boolean isBlockDamaging(final Chunk chunk, int x, final int y, int z) {\n+        x = x & 0xF;\n+        z = z & 0xF;\n+        final Block below = chunk.getBlock(x, y - 1, z);", "originalCommit": "0e1cb48d07bf2faacb41c6d6fd5276274ff97344", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "61830099b4c9ea2d32fe2b8433b428d41078c2af", "url": "https://github.com/EssentialsX/Essentials/commit/61830099b4c9ea2d32fe2b8433b428d41078c2af", "message": "Avoid argument re-assigning", "committedDate": "2020-03-31T01:14:34Z", "type": "commit"}, {"oid": "af869f6a9d25d58ce7bb22555c5df7b8c5323875", "url": "https://github.com/EssentialsX/Essentials/commit/af869f6a9d25d58ce7bb22555c5df7b8c5323875", "message": "Remove async teleports when unnecessary", "committedDate": "2020-03-31T01:39:19Z", "type": "commit"}, {"oid": "709bb830ef2810f18f5c11ce21562d095df6bfe6", "url": "https://github.com/EssentialsX/Essentials/commit/709bb830ef2810f18f5c11ce21562d095df6bfe6", "message": "Make exceptions cleaner", "committedDate": "2020-03-31T02:50:29Z", "type": "commit"}, {"oid": "a5bc910c2c3ff9c3c119f4d7caf7080a833e94cf", "url": "https://github.com/EssentialsX/Essentials/commit/a5bc910c2c3ff9c3c119f4d7caf7080a833e94cf", "message": "Merge branch '2.x' into feature/better-async", "committedDate": "2020-04-03T15:53:43Z", "type": "commit"}, {"oid": "7b58655d5650f8fb6b75037d2832cd529227f7fa", "url": "https://github.com/EssentialsX/Essentials/commit/7b58655d5650f8fb6b75037d2832cd529227f7fa", "message": "Async all the things\n\nMade an async version of every method with fallbacks for deprecated methods.", "committedDate": "2020-04-04T00:39:34Z", "type": "commit"}, {"oid": "bd49c562f77f76230d2d9b5e057e727778aabbe8", "url": "https://github.com/EssentialsX/Essentials/commit/bd49c562f77f76230d2d9b5e057e727778aabbe8", "message": "Remove old now fallback method", "committedDate": "2020-04-04T00:48:30Z", "type": "commit"}, {"oid": "80250ffc2592f12c646cc5ebaa19fb6334ab0bbf", "url": "https://github.com/EssentialsX/Essentials/commit/80250ffc2592f12c646cc5ebaa19fb6334ab0bbf", "message": "Migrate everything to the new async teleport API", "committedDate": "2020-04-04T03:15:26Z", "type": "commit"}, {"oid": "c299234645235c7d19193f429cdd9b8593644bf0", "url": "https://github.com/EssentialsX/Essentials/commit/c299234645235c7d19193f429cdd9b8593644bf0", "message": "Update ITeleport javadocs", "committedDate": "2020-04-04T03:17:27Z", "type": "commit"}, {"oid": "1fd2d572f017e2e8d2dd5448a5352eb2d744e317", "url": "https://github.com/EssentialsX/Essentials/commit/1fd2d572f017e2e8d2dd5448a5352eb2d744e317", "message": "Merge branch '2.x' into feature/better-async", "committedDate": "2020-04-04T15:49:47Z", "type": "commit"}, {"oid": "24cd053ce5b6390454fb9e7035a388dacf88e3d3", "url": "https://github.com/EssentialsX/Essentials/commit/24cd053ce5b6390454fb9e7035a388dacf88e3d3", "message": "Fix invoking via async context", "committedDate": "2020-04-04T20:36:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY1MjA0MQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r403652041", "bodyText": "I'm fairly certain that if a 3rd party plugin calls this it will deadlock the server. Should have been more clear when talking about 'deadlocking' in discord.\nI'm fairly certain this is the case - imagine the following:\n\nsendToJail is called\nthe server has a 'cache miss', resulting in a chunk load.\nbut wait! we are using paper, so its a cool async chunk load\nserver goes off and loads the chunk in a separate thread\nServer tries to continue to 126 - which is blocked on a lock. Main thread is now dependent on the async thread completing (which is what we want, because this is maintaining legacy behavior)\nServer is done 'loading' the chunk via IO, but now must load the chunk into the internal chunk map, which includes loading entities\nEntities have to be loaded in sync because they have to figure out bounding box stuff which calls into big block methods which look at worlds at a whole, not just the chunk\nI would assume Paper then waits for the next sync chunk to load the entities and declare the chunk 'loaded'\n\nAt this point, we have deadlocked because the sync thread is unable to progress in order to process the final chunk load, yet in order to progress the chunk must be loaded.", "author": "Ichbinjoe", "createdAt": "2020-04-05T05:35:54Z", "path": "Essentials/src/com/earth2me/essentials/Jails.java", "diffHunk": "@@ -117,12 +118,31 @@ public void removeJail(final String jail) throws Exception {\n     }\n \n     @Override\n+    @Deprecated\n     public void sendToJail(final IUser user, final String jail) throws Exception {\n+        CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+        CompletableFuture<Boolean> future = new CompletableFuture<>();\n+        sendToJail(user, jail, eFuture, future);\n+        if (!future.get()) {\n+            throw eFuture.get();\n+        }", "originalCommit": "24cd053ce5b6390454fb9e7035a388dacf88e3d3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTg4OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407499888", "bodyText": "Should be mitigated as of now", "author": "JRoy", "createdAt": "2020-04-13T14:15:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzY1MjA0MQ=="}], "type": "inlineReview"}, {"oid": "f1e3bf72ed0a60e67da37e79a156e88a0ce37a76", "url": "https://github.com/EssentialsX/Essentials/commit/f1e3bf72ed0a60e67da37e79a156e88a0ce37a76", "message": "Fix /jail using deprecated method", "committedDate": "2020-04-06T19:34:25Z", "type": "commit"}, {"oid": "ca9ebc1f5c5ff85af696ce569bd232465ed6d69a", "url": "https://github.com/EssentialsX/Essentials/commit/ca9ebc1f5c5ff85af696ce569bd232465ed6d69a", "message": "Fix jail join handler using deprecated method", "committedDate": "2020-04-06T19:45:00Z", "type": "commit"}, {"oid": "6f4d95709edadf941ad02aeeeec6f9a34e6e855e", "url": "https://github.com/EssentialsX/Essentials/commit/6f4d95709edadf941ad02aeeeec6f9a34e6e855e", "message": "Merge branch '2.x' into feature/better-async", "committedDate": "2020-04-06T19:49:04Z", "type": "commit"}, {"oid": "30ce336b7f3ccd5874b4b2b5185676fc55d02d73", "url": "https://github.com/EssentialsX/Essentials/commit/30ce336b7f3ccd5874b4b2b5185676fc55d02d73", "message": "Rename all teleport classes to indicate async", "committedDate": "2020-04-10T18:53:22Z", "type": "commit"}, {"oid": "b2f6ce9100a6ad613611bb1976e50a84dd231127", "url": "https://github.com/EssentialsX/Essentials/commit/b2f6ce9100a6ad613611bb1976e50a84dd231127", "message": "Remove deprecated methods", "committedDate": "2020-04-10T18:56:01Z", "type": "commit"}, {"oid": "8e87db821cfb9f4e0dfb95895ef68d10bcf491d0", "url": "https://github.com/EssentialsX/Essentials/commit/8e87db821cfb9f4e0dfb95895ef68d10bcf491d0", "message": "Add (and deprecate) old teleport api", "committedDate": "2020-04-10T19:25:12Z", "type": "commit"}, {"oid": "07a346522a089dc639fbd18ed1d011ecd697017d", "url": "https://github.com/EssentialsX/Essentials/commit/07a346522a089dc639fbd18ed1d011ecd697017d", "message": "Revert TimedTeleport.java", "committedDate": "2020-04-10T19:37:12Z", "type": "commit"}, {"oid": "5aa587856faa3005d1987a28886e1ba51427e975", "url": "https://github.com/EssentialsX/Essentials/commit/5aa587856faa3005d1987a28886e1ba51427e975", "message": "Reduce Diff", "committedDate": "2020-04-10T19:42:56Z", "type": "commit"}, {"oid": "9302e413e97ff077192c403594c148a279ed2991", "url": "https://github.com/EssentialsX/Essentials/commit/9302e413e97ff077192c403594c148a279ed2991", "message": "Add legacy sendToJail method", "committedDate": "2020-04-10T19:46:15Z", "type": "commit"}, {"oid": "fd0ce61530843bd862ccd8dd0e55137fa1a3035c", "url": "https://github.com/EssentialsX/Essentials/commit/fd0ce61530843bd862ccd8dd0e55137fa1a3035c", "message": "Reduce Diff Further", "committedDate": "2020-04-10T19:49:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ1MjAzOQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407452039", "bodyText": "As far as I can tell, the throw new NoChargeException() is to prevent players paying the command cost for both the /jump command and the teleport itself. Does this change alter this behaviour (or am I reading it wrong)?", "author": "mdcfe", "createdAt": "2020-04-13T12:20:14Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandjump.java", "diffHunk": "@@ -46,8 +47,7 @@ public void run(final Server server, final User user, final String commandLabel,\n \n         final Trade charge = new Trade(this.getName(), ess);\n         charge.isAffordableFor(user);\n-        user.getTeleport().teleport(loc, charge, TeleportCause.COMMAND);\n-        throw new NoChargeException();\n+        user.getAsyncTeleport().teleport(loc, charge, TeleportCause.COMMAND, getNewExceptionFuture(user.getSource(), commandLabel), new CompletableFuture<>());", "originalCommit": "fd0ce61530843bd862ccd8dd0e55137fa1a3035c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ1MzY2Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407453666", "bodyText": "Same concern over NoChargeException as earlier", "author": "mdcfe", "createdAt": "2020-04-13T12:25:01Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtppos.java", "diffHunk": "@@ -55,8 +56,7 @@ public void run(final Server server, final User user, final String commandLabel,\n         final Trade charge = new Trade(this.getName(), ess);\n         charge.isAffordableFor(user);\n         user.sendMessage(tl(\"teleporting\", loc.getWorld().getName(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ()));\n-        user.getTeleport().teleport(loc, charge, TeleportCause.COMMAND);\n-        throw new NoChargeException();", "originalCommit": "fd0ce61530843bd862ccd8dd0e55137fa1a3035c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ1NDY1Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407454653", "bodyText": "What's the functional difference between using these two lines and just calling getNewExceptionFuture()?", "author": "mdcfe", "createdAt": "2020-04-13T12:27:50Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpo.java", "diffHunk": "@@ -17,6 +18,8 @@ public Commandtpo() {\n \n     @Override\n     public void run(final Server server, final User user, final String commandLabel, final String[] args) throws Exception {\n+        CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+        eFuture.thenAccept(e -> showError(user.getBase(), e, commandLabel));", "originalCommit": "fd0ce61530843bd862ccd8dd0e55137fa1a3035c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5OTQwNg==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407499406", "bodyText": "Nothing, I probably wrote that before I made that method. Fixed!", "author": "JRoy", "createdAt": "2020-04-13T14:14:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ1NDY1Mw=="}], "type": "inlineReview"}, {"oid": "332545e675dc506fcb54c193a248756194b53c0c", "url": "https://github.com/EssentialsX/Essentials/commit/332545e675dc506fcb54c193a248756194b53c0c", "message": "Use getNewExceptionFuture in Commandtpo", "committedDate": "2020-04-13T14:15:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUxOTc1OA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407519758", "bodyText": "getNewExceptionFuture", "author": "mdcfe", "createdAt": "2020-04-13T14:53:43Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandhome.java", "diffHunk": "@@ -38,30 +38,32 @@ public void run(final Server server, final User user, final String commandLabel,\n                 }\n             }\n         }\n+        CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+        eFuture.thenAccept(e -> showError(user.getBase(), e, commandLabel));", "originalCommit": "332545e675dc506fcb54c193a248756194b53c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyMDE3MQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407520171", "bodyText": "Another getNewExceptionFuture", "author": "mdcfe", "createdAt": "2020-04-13T14:54:29Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtp.java", "diffHunk": "@@ -23,6 +22,9 @@ public Commandtp() {\n \n     @Override\n     public void run(final Server server, final User user, final String commandLabel, final String[] args) throws Exception {\n+        CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+        CompletableFuture<Boolean> future = new CompletableFuture<>();\n+        eFuture.thenAccept(e -> showError(user.getBase(), e, commandLabel));", "originalCommit": "332545e675dc506fcb54c193a248756194b53c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyMDQ4NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407520485", "bodyText": "getNewExceptionFuture", "author": "mdcfe", "createdAt": "2020-04-13T14:55:01Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpaccept.java", "diffHunk": "@@ -49,24 +51,32 @@ public void run(final Server server, final User user, final String commandLabel,\n         user.sendMessage(tl(\"requestAccepted\"));\n         requester.sendMessage(tl(\"requestAcceptedFrom\", user.getDisplayName()));\n \n-        try {\n-            if (user.isTpRequestHere()) {\n-                final Location loc = user.getTpRequestLocation();\n-                Teleport teleport = requester.getTeleport();\n-                teleport.setTpType(Teleport.TeleportType.TPA);\n-                teleport.teleportPlayer(user, user.getTpRequestLocation(), charge, TeleportCause.COMMAND);\n-                requester.sendMessage(tl(\"teleporting\", loc.getWorld().getName(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ()));\n-            } else {\n-                Teleport teleport = requester.getTeleport();\n-                teleport.setTpType(Teleport.TeleportType.TPA);\n-                teleport.teleport(user.getBase(), charge, TeleportCause.COMMAND);\n-            }\n-        } catch (Exception ex) {\n+        CompletableFuture<Exception> eFuture = new CompletableFuture<>();", "originalCommit": "332545e675dc506fcb54c193a248756194b53c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyMDYyNw==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407520627", "bodyText": "getNewExceptionFuture", "author": "mdcfe", "createdAt": "2020-04-13T14:55:18Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpall.java", "diffHunk": "@@ -41,11 +42,9 @@ private void teleportAllPlayers(Server server, CommandSource sender, User target\n             if (sender.equals(target.getBase()) && target.getWorld() != player.getWorld() && ess.getSettings().isWorldTeleportPermissions() && !target.isAuthorized(\"essentials.worlds.\" + target.getWorld().getName())) {\n                 continue;\n             }\n-            try {\n-                player.getTeleport().now(loc, false, TeleportCause.COMMAND);\n-            } catch (Exception ex) {\n-                ess.showError(sender, ex, getName());\n-            }\n+            CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+            eFuture.thenAccept(e -> showError(sender.getSender(), e, label));", "originalCommit": "332545e675dc506fcb54c193a248756194b53c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyMDc5Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407520792", "bodyText": "getNewExceptionFuture", "author": "mdcfe", "createdAt": "2020-04-13T14:55:35Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpoffline.java", "diffHunk": "@@ -28,7 +30,9 @@ public void run(final Server server, final User user, final String label, final\n                 }\n \n                 user.sendMessage(tl(\"teleporting\", logout.getWorld().getName(), logout.getBlockX(), logout.getBlockY(), logout.getBlockZ()));\n-                user.getTeleport().now(logout, false, PlayerTeleportEvent.TeleportCause.COMMAND);\n+                CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+                eFuture.thenAccept(e -> showError(user.getBase(), e, label));", "originalCommit": "332545e675dc506fcb54c193a248756194b53c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUyMDkwOA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407520908", "bodyText": "getNewExceptionFuture", "author": "mdcfe", "createdAt": "2020-04-13T14:55:49Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtpohere.java", "diffHunk": "@@ -28,8 +29,9 @@ public void run(final Server server, final User user, final String commandLabel,\n             throw new Exception(tl(\"noPerm\", \"essentials.worlds.\" + user.getWorld().getName()));\n         }\n \n-        // Verify permission\n-        player.getTeleport().now(user.getBase(), false, TeleportCause.COMMAND);\n+        CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+        eFuture.thenAccept(e -> showError(user.getBase(), e, commandLabel));", "originalCommit": "332545e675dc506fcb54c193a248756194b53c0c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d4df801271f808abb4160a242a8625e849f03465", "url": "https://github.com/EssentialsX/Essentials/commit/d4df801271f808abb4160a242a8625e849f03465", "message": "Use getNewExceptionFuture everywhere", "committedDate": "2020-04-13T15:44:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MTU4Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407671583", "bodyText": "Seems like I missed this one the first time around.", "author": "mdcfe", "createdAt": "2020-04-13T19:31:47Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtp.java", "diffHunk": "@@ -113,7 +121,9 @@ public void run(final Server server, final CommandSource sender, final String co\n         if (args.length == 2) {\n             final User toPlayer = getPlayer(server, args, 1, true, false);\n             target.sendMessage(tl(\"teleportAtoB\", Console.NAME, toPlayer.getDisplayName()));\n-            target.getTeleport().now(toPlayer.getBase(), false, TeleportCause.COMMAND);\n+            CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+            target.getAsyncTeleport().now(toPlayer.getBase(), false, TeleportCause.COMMAND, eFuture, new CompletableFuture<>());\n+            eFuture.thenAccept(e -> showError(sender.getSender(), e, commandLabel));", "originalCommit": "d4df801271f808abb4160a242a8625e849f03465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MjIwMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r407672200", "bodyText": "Also this one.", "author": "mdcfe", "createdAt": "2020-04-13T19:32:57Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandtp.java", "diffHunk": "@@ -123,8 +133,15 @@ public void run(final Server server, final CommandSource sender, final String co\n             }\n             final Location loc = new Location(target.getWorld(), x, y, z, target.getLocation().getYaw(), target.getLocation().getPitch());\n             sender.sendMessage(tl(\"teleporting\", loc.getWorld().getName(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ()));\n-            target.getTeleport().now(loc, false, TeleportCause.COMMAND);\n-            target.sendMessage(tl(\"teleporting\", loc.getWorld().getName(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ()));\n+            CompletableFuture<Exception> eFuture = new CompletableFuture<>();\n+            CompletableFuture<Boolean> future = new CompletableFuture<>();\n+            target.getAsyncTeleport().now(loc, false, TeleportCause.COMMAND, eFuture, future);\n+            future.thenAccept(success -> {\n+                if (success) {\n+                    target.sendMessage(tl(\"teleporting\", loc.getWorld().getName(), loc.getBlockX(), loc.getBlockY(), loc.getBlockZ()));\n+                }\n+            });\n+            eFuture.thenAccept(e -> showError(sender.getSender(), e, commandLabel));", "originalCommit": "d4df801271f808abb4160a242a8625e849f03465", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "944f112d557b181f4b4755ae63fbaef22b0805e2", "url": "https://github.com/EssentialsX/Essentials/commit/944f112d557b181f4b4755ae63fbaef22b0805e2", "message": "Fix even more usages", "committedDate": "2020-04-13T19:34:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQzNTc5Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r408435792", "bodyText": "ok", "author": "pop4959", "createdAt": "2020-04-14T21:07:19Z", "path": "Essentials/src/com/earth2me/essentials/api/ITeleport.java", "diffHunk": "@@ -117,17 +129,19 @@\n      *\n      * @param teleporter - The user performing the /back command.\n      *                   This value may be {@code null} to indicate console.\n-     * @param chargeFor - What the {@code teleporter} will be charged if teleportPlayer is successful\n+     * @param chargeFor  - What the {@code teleporter} will be charged if teleportPlayer is successful", "originalCommit": "944f112d557b181f4b4755ae63fbaef22b0805e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODQ0NTM3MQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r408445371", "bodyText": "Logger::info would also work here", "author": "pop4959", "createdAt": "2020-04-14T21:25:47Z", "path": "Essentials/src/com/earth2me/essentials/commands/EssentialsCommand.java", "diffHunk": "@@ -344,6 +347,21 @@ private static boolean canInteractWith(User interactor, User interactee) {\n         return command.tabComplete(sender.getSender(), label, effectiveArgs);\n     }\n \n+    @Override\n+    public void showError(CommandSender sender, Throwable throwable, String commandLabel) {\n+        sender.sendMessage(tl(\"errorWithMessage\", throwable.getMessage()));\n+        if (ess.getSettings().isDebug()) {\n+            ess.getLogger().log(Level.INFO, tl(\"errorCallingCommand\", commandLabel), throwable);", "originalCommit": "944f112d557b181f4b4755ae63fbaef22b0805e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "015eeedc07957d2dcf3f9ef5f09585211dfce91c", "url": "https://github.com/EssentialsX/Essentials/commit/015eeedc07957d2dcf3f9ef5f09585211dfce91c", "message": "Revert LocationUtil.java", "committedDate": "2020-04-20T16:36:48Z", "type": "commit"}, {"oid": "1013dd8ab912c0574d0694112ba0e54fc0d97f17", "url": "https://github.com/EssentialsX/Essentials/commit/1013dd8ab912c0574d0694112ba0e54fc0d97f17", "message": "Fix issue causing unsafe locations to not work properly", "committedDate": "2020-04-20T16:41:39Z", "type": "commit"}, {"oid": "c9d35b4945f55f2d3db000f0078df0dcd2148f07", "url": "https://github.com/EssentialsX/Essentials/commit/c9d35b4945f55f2d3db000f0078df0dcd2148f07", "message": "Add deprecated notice in IUser implementation", "committedDate": "2020-04-20T20:01:24Z", "type": "commit"}, {"oid": "606b2040eef2b5425243706b1bd183d0abccd4f9", "url": "https://github.com/EssentialsX/Essentials/commit/606b2040eef2b5425243706b1bd183d0abccd4f9", "message": "Use CompletableFuture#completeExceptionally for exceptions", "committedDate": "2020-04-20T20:37:12Z", "type": "commit"}, {"oid": "e95ce2a5d6c849d8eae3e947bef74aaecba43cc2", "url": "https://github.com/EssentialsX/Essentials/commit/e95ce2a5d6c849d8eae3e947bef74aaecba43cc2", "message": "Use Essentials' logger in EssentialsCommand#showError", "committedDate": "2020-04-20T20:44:18Z", "type": "commit"}, {"oid": "5a194fbce2ffdc82a5ceeb25e1f084b09fd851eb", "url": "https://github.com/EssentialsX/Essentials/commit/5a194fbce2ffdc82a5ceeb25e1f084b09fd851eb", "message": "Return implementation rather than interface", "committedDate": "2020-04-21T13:47:31Z", "type": "commit"}, {"oid": "806d607b5761a2a7f8a7c9e19a00fab26f7b00b9", "url": "https://github.com/EssentialsX/Essentials/commit/806d607b5761a2a7f8a7c9e19a00fab26f7b00b9", "message": "Merge branch '2.x' into feature/better-async", "committedDate": "2020-04-24T15:06:49Z", "type": "commit"}, {"oid": "613665a7f6bbe4f485def052812b4e82448b5e9e", "url": "https://github.com/EssentialsX/Essentials/commit/613665a7f6bbe4f485def052812b4e82448b5e9e", "message": "Merge branch '2.x' into feature/better-async", "committedDate": "2020-04-27T21:42:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MTM2Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r418741363", "bodyText": "This logic is called on main, thus this will deadlock; need to check the current thread before doing this", "author": "electronicboy", "createdAt": "2020-05-01T21:15:58Z", "path": "Essentials/src/com/earth2me/essentials/AsyncTeleport.java", "diffHunk": "@@ -0,0 +1,419 @@\n+package com.earth2me.essentials;\n+\n+import com.earth2me.essentials.api.IAsyncTeleport;\n+import com.earth2me.essentials.commands.WarpNotFoundException;\n+import com.earth2me.essentials.utils.DateUtil;\n+import com.earth2me.essentials.utils.LocationUtil;\n+import io.papermc.lib.PaperLib;\n+import net.ess3.api.IEssentials;\n+import net.ess3.api.IUser;\n+import net.ess3.api.InvalidWorldException;\n+import net.ess3.api.events.UserTeleportEvent;\n+import net.ess3.api.events.UserWarpEvent;\n+import org.bukkit.Bukkit;\n+import org.bukkit.Location;\n+import org.bukkit.entity.Player;\n+import org.bukkit.event.player.PlayerRespawnEvent;\n+import org.bukkit.event.player.PlayerTeleportEvent.TeleportCause;\n+\n+import java.math.BigDecimal;\n+import java.util.Calendar;\n+import java.util.GregorianCalendar;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.ExecutionException;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+\n+public class AsyncTeleport implements IAsyncTeleport {\n+    private final IUser teleportOwner;\n+    private final IEssentials ess;\n+    private AsyncTimedTeleport timedTeleport;\n+\n+    private TeleportType tpType;\n+\n+    public AsyncTeleport(IUser user, IEssentials ess) {\n+        this.teleportOwner = user;\n+        this.ess = ess;\n+        tpType = TeleportType.NORMAL;\n+    }\n+\n+    public enum TeleportType {\n+        TPA,\n+        BACK,\n+        NORMAL\n+    }\n+\n+    public void cooldown(boolean check) throws Throwable {\n+        CompletableFuture<Boolean> exceptionFuture = new CompletableFuture<>();\n+        if (cooldown(check, exceptionFuture)) {\n+            try {\n+                exceptionFuture.get();\n+            } catch (ExecutionException e) {\n+                throw e.getCause();\n+            }\n+        }\n+    }\n+\n+    public boolean cooldown(boolean check, CompletableFuture<Boolean> future) {\n+        final Calendar time = new GregorianCalendar();\n+        if (teleportOwner.getLastTeleportTimestamp() > 0) {\n+            // Take the current time, and remove the delay from it.\n+            final double cooldown = ess.getSettings().getTeleportCooldown();\n+            final Calendar earliestTime = new GregorianCalendar();\n+            earliestTime.add(Calendar.SECOND, -(int) cooldown);\n+            earliestTime.add(Calendar.MILLISECOND, -(int) ((cooldown * 1000.0) % 1000.0));\n+            // This value contains the most recent time a teleportPlayer could have been used that would allow another use.\n+            final long earliestLong = earliestTime.getTimeInMillis();\n+\n+            // When was the last teleportPlayer used?\n+            final long lastTime = teleportOwner.getLastTeleportTimestamp();\n+\n+            if (lastTime > time.getTimeInMillis()) {\n+                // This is to make sure time didn't get messed up on last teleportPlayer use.\n+                // If this happens, let's give the user the benifit of the doubt.\n+                teleportOwner.setLastTeleportTimestamp(time.getTimeInMillis());\n+                return false;\n+            } else if (lastTime > earliestLong\n+                && cooldownApplies()) {\n+                time.setTimeInMillis(lastTime);\n+                time.add(Calendar.SECOND, (int) cooldown);\n+                time.add(Calendar.MILLISECOND, (int) ((cooldown * 1000.0) % 1000.0));\n+                future.completeExceptionally(new Exception(tl(\"timeBeforeTeleport\", DateUtil.formatDateDiff(time.getTimeInMillis()))));\n+                return true;\n+            }\n+        }\n+        // if justCheck is set, don't update lastTeleport; we're just checking\n+        if (!check) {\n+            teleportOwner.setLastTeleportTimestamp(time.getTimeInMillis());\n+        }\n+        return false;\n+    }\n+\n+    private boolean cooldownApplies() {\n+        boolean applies = true;\n+        String globalBypassPerm = \"essentials.teleport.cooldown.bypass\";\n+        switch (tpType) {\n+            case NORMAL:\n+                applies = !teleportOwner.isAuthorized(globalBypassPerm);\n+                break;\n+            case BACK:\n+                applies = !(teleportOwner.isAuthorized(globalBypassPerm) &&\n+                    teleportOwner.isAuthorized(\"essentials.teleport.cooldown.bypass.back\"));\n+                break;\n+            case TPA:\n+                applies = !(teleportOwner.isAuthorized(globalBypassPerm) &&\n+                    teleportOwner.isAuthorized(\"essentials.teleport.cooldown.bypass.tpa\"));\n+                break;\n+        }\n+        return applies;\n+    }\n+\n+    private void warnUser(final IUser user, final double delay) {\n+        Calendar c = new GregorianCalendar();\n+        c.add(Calendar.SECOND, (int) delay);\n+        c.add(Calendar.MILLISECOND, (int) ((delay * 1000.0) % 1000.0));\n+        user.sendMessage(tl(\"dontMoveMessage\", DateUtil.formatDateDiff(c.getTimeInMillis())));\n+    }\n+\n+\n+    @Override\n+    public void now(Location loc, boolean cooldown, TeleportCause cause, CompletableFuture<Boolean> future) {\n+        if (cooldown && cooldown(false, future)) {\n+            return;\n+        }\n+        final ITarget target = new LocationTarget(loc);\n+        nowAsync(teleportOwner, target, cause, future);\n+    }\n+\n+    @Override\n+    public void now(Player entity, boolean cooldown, TeleportCause cause, CompletableFuture<Boolean> future) {\n+        if (cooldown && cooldown(false, future)) {\n+            future.complete(false);\n+            return;\n+        }\n+        final ITarget target = new PlayerTarget(entity);\n+        nowAsync(teleportOwner, target, cause, future);\n+        future.thenAccept(success -> {\n+            if (success) {\n+                teleportOwner.sendMessage(tl(\"teleporting\", target.getLocation().getWorld().getName(), target.getLocation().getBlockX(), target.getLocation().getBlockY(), target.getLocation().getBlockZ()));\n+            }\n+        });\n+    }\n+\n+    protected void nowAsync(IUser teleportee, ITarget target, TeleportCause cause, CompletableFuture<Boolean> future) {\n+        cancel(false);\n+\n+        UserTeleportEvent event = new UserTeleportEvent(teleportee, cause, target.getLocation());\n+        Bukkit.getServer().getPluginManager().callEvent(event);\n+        if (event.isCancelled()) {\n+            return;\n+        }\n+        teleportee.setLastLocation();\n+\n+        if (!teleportee.getBase().isEmpty()) {\n+            if (!ess.getSettings().isTeleportPassengerDismount()) {\n+                future.completeExceptionally(new Exception(tl(\"passengerTeleportFail\")));\n+                return;\n+            }\n+            CompletableFuture<Object> dismountFuture = new CompletableFuture<>();\n+            Bukkit.getScheduler().runTask(ess, () -> {", "originalCommit": "613665a7f6bbe4f485def052812b4e82448b5e9e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc1MDgyNQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r418750825", "bodyText": "Something like this?\n            if (Bukkit.isPrimaryThread()) {\n                teleportee.getBase().eject();\n            } else {\n                CompletableFuture<Object> dismountFuture = new CompletableFuture<>();\n                Bukkit.getScheduler().runTask(ess, () -> {\n                    teleportee.getBase().eject();\n                    dismountFuture.complete(new Object());\n                });\n                try {\n                    dismountFuture.get(); //EntityDismountEvent requires sync context we also want to wait for it to finish\n                } catch (InterruptedException | ExecutionException e) {\n                    future.completeExceptionally(e);\n                    return;\n                }\n            }", "author": "JRoy", "createdAt": "2020-05-01T21:43:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODc0MTM2Mw=="}], "type": "inlineReview"}, {"oid": "80a7dcb7894f3fe5d5e8dd2fd09dc01dd6a9483e", "url": "https://github.com/EssentialsX/Essentials/commit/80a7dcb7894f3fe5d5e8dd2fd09dc01dd6a9483e", "message": "Avoid possible deadlocks with entity ejections", "committedDate": "2020-05-02T17:49:55Z", "type": "commit"}, {"oid": "b92ea836086062040c300e2d1057fc57b3794449", "url": "https://github.com/EssentialsX/Essentials/commit/b92ea836086062040c300e2d1057fc57b3794449", "message": "Merge remote-tracking branch 'origin/feature/better-async' into feature/better-async", "committedDate": "2020-05-02T17:50:10Z", "type": "commit"}, {"oid": "e72746e628a38df4c77c08ff4b6611a0166005c0", "url": "https://github.com/EssentialsX/Essentials/commit/e72746e628a38df4c77c08ff4b6611a0166005c0", "message": "Nuke some sync loads with homes\n\nTook 7 hours and 2 PRs to paper but it's here!", "committedDate": "2020-05-11T06:38:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjUxMzYyNA==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r422513624", "bodyText": "Could you undo the indentation changes here to clean up the diff?", "author": "mdcfe", "createdAt": "2020-05-09T16:04:15Z", "path": "Essentials/src/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -154,13 +161,13 @@\n     Map<String, Object> getConfigMap();\n \n     Map<String, Object> getConfigMap(String node);\n-    \n+", "originalCommit": "b92ea836086062040c300e2d1057fc57b3794449", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE3ODk1NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3102#discussion_r423178955", "bodyText": "Even if it seems redundant, changing this import from net.ess3.api.ITeleport might cause ABI breakage with plugins that built against the class when it had the old import.", "author": "mdcfe", "createdAt": "2020-05-11T16:51:56Z", "path": "Essentials/src/com/earth2me/essentials/IUser.java", "diffHunk": "@@ -1,7 +1,8 @@\n package com.earth2me.essentials;\n \n+import com.earth2me.essentials.api.IAsyncTeleport;\n+import com.earth2me.essentials.api.ITeleport;", "originalCommit": "e72746e628a38df4c77c08ff4b6611a0166005c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "318ef7c9ce255c0c30cfd0c54b559c8ad4f8daed", "url": "https://github.com/EssentialsX/Essentials/commit/318ef7c9ce255c0c30cfd0c54b559c8ad4f8daed", "message": "Fix ABI and make the codestyle worse", "committedDate": "2020-05-11T17:02:50Z", "type": "commit"}, {"oid": "85a49421620cf8ed4b580d62ab98dca79c5e71ac", "url": "https://github.com/EssentialsX/Essentials/commit/85a49421620cf8ed4b580d62ab98dca79c5e71ac", "message": "Make the codestyle worse because muh diff", "committedDate": "2020-05-11T17:14:31Z", "type": "commit"}, {"oid": "c3ee63c04f3a2f44e7ca03ca756b50bef80f0141", "url": "https://github.com/EssentialsX/Essentials/commit/c3ee63c04f3a2f44e7ca03ca756b50bef80f0141", "message": "Further ruin the codestyle", "committedDate": "2020-05-11T17:15:10Z", "type": "commit"}, {"oid": "5c9f775ce57b6974743b6607a0063be9b58ef8f5", "url": "https://github.com/EssentialsX/Essentials/commit/5c9f775ce57b6974743b6607a0063be9b58ef8f5", "message": "Merge branch '2.x' into feature/better-async", "committedDate": "2020-05-22T00:33:44Z", "type": "commit"}, {"oid": "dec46ac803656b78b132076bde58a357363ce616", "url": "https://github.com/EssentialsX/Essentials/commit/dec46ac803656b78b132076bde58a357363ce616", "message": "Fix error messages not showing in TimedTeleports", "committedDate": "2020-05-25T05:37:57Z", "type": "commit"}, {"oid": "e22a03c8535f3719a1a0ba06a2d4a1a3b9439ebe", "url": "https://github.com/EssentialsX/Essentials/commit/e22a03c8535f3719a1a0ba06a2d4a1a3b9439ebe", "message": "Improve messages around beds for /home", "committedDate": "2020-06-11T21:58:56Z", "type": "commit"}, {"oid": "9efa1147d3daab7223bec584a54b61f8f268501d", "url": "https://github.com/EssentialsX/Essentials/commit/9efa1147d3daab7223bec584a54b61f8f268501d", "message": "Fix #3274\n\nAllow unsafe locations for different worlds + spectator mode", "committedDate": "2020-06-11T22:19:37Z", "type": "commit"}, {"oid": "7ad5bb6c6d0a258f79ba255706e5ee3aaf06a6f7", "url": "https://github.com/EssentialsX/Essentials/commit/7ad5bb6c6d0a258f79ba255706e5ee3aaf06a6f7", "message": "Fix fly safety operators", "committedDate": "2020-06-16T21:00:11Z", "type": "commit"}]}