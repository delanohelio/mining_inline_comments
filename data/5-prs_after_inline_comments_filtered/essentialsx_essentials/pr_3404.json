{"pr_number": 3404, "pr_title": "Fix recipe command on Paper", "pr_createdAt": "2020-06-23T08:21:40Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3404", "timeline": [{"oid": "cc39d3530d869c6d96f1f5d752bd21fde58d2c1d", "url": "https://github.com/EssentialsX/Essentials/commit/cc39d3530d869c6d96f1f5d752bd21fde58d2c1d", "message": "Paper recipe command", "committedDate": "2020-06-23T08:16:30Z", "type": "commit"}, {"oid": "4320e051df6e200a58befea64ba8e5476cd1e80f", "url": "https://github.com/EssentialsX/Essentials/commit/4320e051df6e200a58befea64ba8e5476cd1e80f", "message": "Merge branch '2.x' into paper-recipe", "committedDate": "2020-06-24T22:23:54Z", "type": "commit"}, {"oid": "ce615cb6e03b3b7d9b4b8a76df8e3a7e4f232806", "url": "https://github.com/EssentialsX/Essentials/commit/ce615cb6e03b3b7d9b4b8a76df8e3a7e4f232806", "message": "Less dumb implementation", "committedDate": "2020-06-25T00:04:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI1MTA5Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r447251092", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class PaperPlayerRecipeBookClickEventProvider extends EventProvider {\n          \n          \n            \n            public class PaperRecipeBookListener extends ProviderListener {", "author": "mdcfe", "createdAt": "2020-06-29T21:00:35Z", "path": "providers/PaperProvider/src/net/ess3/provider/providers/PaperPlayerRecipeBookClickEventProvider.java", "diffHunk": "@@ -0,0 +1,24 @@\n+package net.ess3.provider.providers;\n+\n+import com.destroystokyo.paper.event.player.PlayerRecipeBookClickEvent;\n+import net.ess3.provider.EventProvider;\n+import org.bukkit.event.Event;\n+import org.bukkit.event.EventHandler;\n+\n+import java.util.function.Consumer;\n+\n+public class PaperPlayerRecipeBookClickEventProvider extends EventProvider {", "originalCommit": "ce615cb6e03b3b7d9b4b8a76df8e3a7e4f232806", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "02db2867c988abe7622796a88e903ef5a38d104c", "url": "https://github.com/EssentialsX/Essentials/commit/02db2867c988abe7622796a88e903ef5a38d104c", "message": "review suggestions", "committedDate": "2020-06-30T02:02:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNjY3Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r448616672", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            ((Cancellable)event).setCancelled(true);\n          \n          \n            \n                                            ((Cancellable) event).setCancelled(true);", "author": "mdcfe", "createdAt": "2020-07-01T21:07:34Z", "path": "Essentials/src/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -269,6 +273,18 @@ public void onEnable() {\n                     serverStateProvider = new ReflServerStateProvider(getLogger());\n                 }\n \n+                //Event Providers\n+                if (PaperLib.isPaper()) {\n+                    try {\n+                        Class.forName(\"com.destroystokyo.paper.event.player.PlayerRecipeBookClickEvent\");\n+                        recipeBookEventProvider = new PaperRecipeBookListener(event -> {\n+                            if (this.getUser(((PlayerEvent) event).getPlayer()).isRecipeSee()) {\n+                                ((Cancellable)event).setCancelled(true);", "originalCommit": "02db2867c988abe7622796a88e903ef5a38d104c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNzMyNQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r448617325", "bodyText": "This breaks the command on 1.11 and lower. Maybe add a 1.12 check here?", "author": "mdcfe", "createdAt": "2020-07-01T21:09:12Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandrecipe.java", "diffHunk": "@@ -26,18 +25,16 @@\n     public Commandrecipe() {\n         super(\"recipe\");\n     }\n-    \n-    private void disableCommandForVersion1_12() throws Exception {\n-        VersionUtil.BukkitVersion version = VersionUtil.getServerBukkitVersion();\n-        if (version.isHigherThanOrEqualTo(VersionUtil.v1_12_0_R01)\n-            && !ess.getSettings().isForceEnableRecipe()) {\n-            throw new Exception(\"Please use the recipe book in your inventory.\");\n-        }\n-    }\n \n     @Override\n     public void run(final Server server, final CommandSource sender, final String commandLabel, final String[] args) throws Exception {\n-        disableCommandForVersion1_12();\n+        try {\n+            Class.forName(\"com.destroystokyo.paper.event.player.PlayerRecipeBookClickEvent\");\n+        } catch (ClassNotFoundException e) {\n+            sender.sendMessage(tl(\"unsupportedFeature\"));", "originalCommit": "02db2867c988abe7622796a88e903ef5a38d104c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxOTAwMA==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r448619000", "bodyText": "Class::forName doesn't work? I'll look into this.", "author": "pop4959", "createdAt": "2020-07-01T21:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxOTYyNQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r448619625", "bodyText": "@pop4959 No, this command still works (as of the latest build) on 1.11.x and below, but by removing the 1.12 version check entirely we drop support for this command on old versions of MC. These older versions are the ones that don't have the recipe book, and so they're the versions where this command is the most useful.", "author": "mdcfe", "createdAt": "2020-07-01T21:14:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNzMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyMDEwMQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r448620101", "bodyText": "Ah right, completely overlooked that. I'll re-add this check ASAP.", "author": "pop4959", "createdAt": "2020-07-01T21:15:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxNzMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxODAzNg==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r448618036", "bodyText": "If we're removing this check entirely, remove Settings#isForceEnableRecipe too (it's an undocumented config option I used to confirm whether this bug was fixed in newer versions of Spigot).", "author": "mdcfe", "createdAt": "2020-07-01T21:10:45Z", "path": "Essentials/src/com/earth2me/essentials/commands/Commandrecipe.java", "diffHunk": "@@ -26,18 +25,16 @@\n     public Commandrecipe() {\n         super(\"recipe\");\n     }\n-    \n-    private void disableCommandForVersion1_12() throws Exception {\n-        VersionUtil.BukkitVersion version = VersionUtil.getServerBukkitVersion();\n-        if (version.isHigherThanOrEqualTo(VersionUtil.v1_12_0_R01)\n-            && !ess.getSettings().isForceEnableRecipe()) {", "originalCommit": "02db2867c988abe7622796a88e903ef5a38d104c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxOTM1Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3404#discussion_r448619356", "bodyText": "Will do", "author": "pop4959", "createdAt": "2020-07-01T21:13:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYxODAzNg=="}], "type": "inlineReview"}, {"oid": "61ba5c20479c90bc446223dd2a4e1a0177f84b03", "url": "https://github.com/EssentialsX/Essentials/commit/61ba5c20479c90bc446223dd2a4e1a0177f84b03", "message": "Update Essentials/src/com/earth2me/essentials/Essentials.java\n\nCo-authored-by: MD <1917406+md678685@users.noreply.github.com>", "committedDate": "2020-07-01T21:12:30Z", "type": "commit"}, {"oid": "dbd9375b453931cda5e447e5484c26f5adbba849", "url": "https://github.com/EssentialsX/Essentials/commit/dbd9375b453931cda5e447e5484c26f5adbba849", "message": "Review comments", "committedDate": "2020-07-01T21:26:25Z", "type": "commit"}, {"oid": "61e48a93b711461af4983a152b81f979d861630c", "url": "https://github.com/EssentialsX/Essentials/commit/61e48a93b711461af4983a152b81f979d861630c", "message": "Merge branch 'paper-recipe' of https://github.com/pop4959/Essentials into paper-recipe", "committedDate": "2020-07-01T21:28:40Z", "type": "commit"}]}