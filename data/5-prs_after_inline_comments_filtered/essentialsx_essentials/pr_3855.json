{"pr_number": 3855, "pr_title": "Add update checker", "pr_createdAt": "2020-12-22T06:00:31Z", "pr_url": "https://github.com/EssentialsX/Essentials/pull/3855", "timeline": [{"oid": "fbfb00dfbbe35ed158581f4d0877f3e4c28b53b4", "url": "https://github.com/EssentialsX/Essentials/commit/fbfb00dfbbe35ed158581f4d0877f3e4c28b53b4", "message": "Create framework for update checker", "committedDate": "2020-12-21T18:11:52Z", "type": "commit"}, {"oid": "37c51b532a754e4eea9d649929e5a4d49f54b936", "url": "https://github.com/EssentialsX/Essentials/commit/37c51b532a754e4eea9d649929e5a4d49f54b936", "message": "Only include commit hash in dev builds", "committedDate": "2020-12-21T19:07:14Z", "type": "commit"}, {"oid": "20c5149a6f669125340e173031ab8451892fe065", "url": "https://github.com/EssentialsX/Essentials/commit/20c5149a6f669125340e173031ab8451892fe065", "message": "Add version info message in `/ess version` command", "committedDate": "2020-12-22T04:03:12Z", "type": "commit"}, {"oid": "3a3e381bcdff13f93f79f582b9ea13e80c936874", "url": "https://github.com/EssentialsX/Essentials/commit/3a3e381bcdff13f93f79f582b9ea13e80c936874", "message": "Add version info message on startup", "committedDate": "2020-12-22T05:07:01Z", "type": "commit"}, {"oid": "3d3e564167f15ff1492ffb2963b6f6844e56a06f", "url": "https://github.com/EssentialsX/Essentials/commit/3d3e564167f15ff1492ffb2963b6f6844e56a06f", "message": "Use Essentials#runTaskAsynchronously shortcut", "committedDate": "2020-12-22T05:11:43Z", "type": "commit"}, {"oid": "d21fa2f4ef2b467388c8fd7ab712877fd63cf0ac", "url": "https://github.com/EssentialsX/Essentials/commit/d21fa2f4ef2b467388c8fd7ab712877fd63cf0ac", "message": "Add version info message on player join", "committedDate": "2020-12-22T05:33:56Z", "type": "commit"}, {"oid": "5b8939756d761423d5b63cdbb090b007ef64c4c8", "url": "https://github.com/EssentialsX/Essentials/commit/5b8939756d761423d5b63cdbb090b007ef64c4c8", "message": "Don't show custom builds on player join", "committedDate": "2020-12-22T05:59:22Z", "type": "commit"}, {"oid": "a83f7fa1c8c7af7584e959f744d4dba38ae933c9", "url": "https://github.com/EssentialsX/Essentials/commit/a83f7fa1c8c7af7584e959f744d4dba38ae933c9", "message": "Merge branch '2.x' into feature/update-checker", "committedDate": "2020-12-22T06:01:50Z", "type": "commit"}, {"oid": "75f75f8aea7182922f69762660a8778efc04094e", "url": "https://github.com/EssentialsX/Essentials/commit/75f75f8aea7182922f69762660a8778efc04094e", "message": "Account for ahead branches", "committedDate": "2020-12-22T06:07:45Z", "type": "commit"}, {"oid": "9de7f27155a20d2ef800a0e6f438966d292e51cd", "url": "https://github.com/EssentialsX/Essentials/commit/9de7f27155a20d2ef800a0e6f438966d292e51cd", "message": "Merge branch '2.x' into feature/update-checker", "committedDate": "2021-01-10T22:33:34Z", "type": "commit"}, {"oid": "d6fea37b31191f5748bb8abf0a805ae8cad556ee", "url": "https://github.com/EssentialsX/Essentials/commit/d6fea37b31191f5748bb8abf0a805ae8cad556ee", "message": "Add bstats chart for build branch", "committedDate": "2021-01-11T00:18:13Z", "type": "commit"}, {"oid": "2ef496bc07c3893d66379f39e195dac2945c2b57", "url": "https://github.com/EssentialsX/Essentials/commit/2ef496bc07c3893d66379f39e195dac2945c2b57", "message": "Extend release cache to 30 min", "committedDate": "2021-01-11T00:46:17Z", "type": "commit"}, {"oid": "2a5d53fbe5400a7e8ff6864d1b20c31e44c6be39", "url": "https://github.com/EssentialsX/Essentials/commit/2a5d53fbe5400a7e8ff6864d1b20c31e44c6be39", "message": "Merge branch '2.x' into feature/update-checker\n\n# Conflicts:\n#\tEssentials/src/main/java/com/earth2me/essentials/commands/Commandessentials.java", "committedDate": "2021-01-19T12:45:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0Njg1OQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r547246859", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final static String REPO = \"EssentialsX/Essentials\";\n          \n          \n            \n                private final static String BRANCH = \"2.x\";\n          \n          \n            \n                private static final String REPO = \"EssentialsX/Essentials\";\n          \n          \n            \n                private static final String BRANCH = \"2.x\";\n          \n      \n    \n    \n  \n\nwh-", "author": "mdcfe", "createdAt": "2020-12-22T12:21:11Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,205 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+public final class EssentialsUpdateChecker {\n+    private final static String REPO = \"EssentialsX/Essentials\";\n+    private final static String BRANCH = \"2.x\";", "originalCommit": "75f75f8aea7182922f69762660a8778efc04094e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA2NTkzNg==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r560065936", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"com.earth2me.essentials.commands.Command\", \"essentials.\", null);\n          \n          \n            \n                        \"com.earth2me.essentials.commands.Command\", \"essentials.\", null);\n          \n      \n    \n    \n  \n\nUnnecessary spacing change", "author": "mdcfe", "createdAt": "2021-01-19T10:18:31Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -490,7 +542,7 @@ public void reload() {\n     @Override\n     public List<String> onTabComplete(final CommandSender sender, final Command command, final String commandLabel, final String[] args) {\n         return onTabCompleteEssentials(sender, command, commandLabel, args, Essentials.class.getClassLoader(),\n-            \"com.earth2me.essentials.commands.Command\", \"essentials.\", null);\n+                \"com.earth2me.essentials.commands.Command\", \"essentials.\", null);", "originalCommit": "2ef496bc07c3893d66379f39e195dac2945c2b57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA2NjA2Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r560066066", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                Bukkit.getLogger().log(Level.INFO, \"CommandBlock at {0},{1},{2} issued server command: /{3} {4}\", new Object[]{bSenderBlock.getX(), bSenderBlock.getY(), bSenderBlock.getZ(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});\n          \n          \n            \n                                Bukkit.getLogger().log(Level.INFO, \"CommandBlock at {0},{1},{2} issued server command: /{3} {4}\", new Object[] {bSenderBlock.getX(), bSenderBlock.getY(), bSenderBlock.getZ(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});", "author": "mdcfe", "createdAt": "2021-01-19T10:18:43Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -603,10 +655,10 @@ public boolean onCommandEssentials(final CommandSender cSender, final Command co\n \n             if (bSenderBlock != null) {\n                 if (getSettings().logCommandBlockCommands()) {\n-                    Bukkit.getLogger().log(Level.INFO, \"CommandBlock at {0},{1},{2} issued server command: /{3} {4}\", new Object[] {bSenderBlock.getX(), bSenderBlock.getY(), bSenderBlock.getZ(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});\n+                    Bukkit.getLogger().log(Level.INFO, \"CommandBlock at {0},{1},{2} issued server command: /{3} {4}\", new Object[]{bSenderBlock.getX(), bSenderBlock.getY(), bSenderBlock.getZ(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});", "originalCommit": "2ef496bc07c3893d66379f39e195dac2945c2b57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA2NjE0Mw==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r560066143", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            Bukkit.getLogger().log(Level.INFO, \"{0} issued server command: /{1} {2}\", new Object[]{cSender.getName(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});\n          \n          \n            \n                            Bukkit.getLogger().log(Level.INFO, \"{0} issued server command: /{1} {2}\", new Object[] {cSender.getName(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});", "author": "mdcfe", "createdAt": "2021-01-19T10:18:53Z", "path": "Essentials/src/main/java/com/earth2me/essentials/Essentials.java", "diffHunk": "@@ -603,10 +655,10 @@ public boolean onCommandEssentials(final CommandSender cSender, final Command co\n \n             if (bSenderBlock != null) {\n                 if (getSettings().logCommandBlockCommands()) {\n-                    Bukkit.getLogger().log(Level.INFO, \"CommandBlock at {0},{1},{2} issued server command: /{3} {4}\", new Object[] {bSenderBlock.getX(), bSenderBlock.getY(), bSenderBlock.getZ(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});\n+                    Bukkit.getLogger().log(Level.INFO, \"CommandBlock at {0},{1},{2} issued server command: /{3} {4}\", new Object[]{bSenderBlock.getX(), bSenderBlock.getY(), bSenderBlock.getZ(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});\n                 }\n             } else if (user == null) {\n-                Bukkit.getLogger().log(Level.INFO, \"{0} issued server command: /{1} {2}\", new Object[] {cSender.getName(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});\n+                Bukkit.getLogger().log(Level.INFO, \"{0} issued server command: /{1} {2}\", new Object[]{cSender.getName(), commandLabel, EssentialsCommand.getFinalArg(args, 0)});", "originalCommit": "2ef496bc07c3893d66379f39e195dac2945c2b57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA2NjY5NQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r560066695", "bodyText": "Maybe move this into a showJoinUpdateCheck method or something?", "author": "mdcfe", "createdAt": "2021-01-19T10:19:48Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsPlayerListener.java", "diffHunk": "@@ -420,6 +420,53 @@ public void run() {\n                         final TextPager pager = new TextPager(output, true);\n                         pager.showPage(\"1\", null, \"motd\", user.getSource());\n                     }\n+\n+                    if (!user.isAuthorized(\"essentials.updatecheck\")) {\n+                        return;\n+                    }\n+\n+                    if (EssentialsUpdateChecker.isDevBuild()) {\n+                        EssentialsUpdateChecker.getDevToken().thenAccept(token -> {\n+                            switch (token.getBranchStatus()) {\n+                                case BEHIND: {\n+                                    user.sendMessage(tl(\"versionDevBehind\", token.getDistance()));\n+                                    break;\n+                                }\n+                                case AHEAD:\n+                                case DIVERGED: {\n+                                    user.sendMessage(tl(token.getDistance() == 0 ? \"versionDevDivergedLatest\" : \"versionDevDiverged\", token.getDistance()));\n+                                    user.sendMessage(tl(\"versionDevDivergedBranch\", EssentialsUpdateChecker.getVersionBranch()));\n+                                    break;\n+                                }\n+                                case ERROR: {\n+                                    user.sendMessage(tl(\"versionErrorPlayer\"));\n+                                    break;\n+                                }\n+                                default: {\n+                                    break;\n+                                }\n+                            }\n+                        });\n+                    } else {\n+                        EssentialsUpdateChecker.getReleaseToken().thenAccept(token -> {\n+                            switch (token.getBranchStatus()) {\n+                                case BEHIND: {\n+                                    user.sendMessage(tl(\"versionReleaseNew\", EssentialsUpdateChecker.getLatestRelease()));\n+                                    //TODO download link? (https://github.com/EssentialsX/Website/issues/26)\n+                                    break;\n+                                }\n+                                case DIVERGED: //WhatChamp\n+                                case AHEAD: //monkaW????\n+                                case ERROR: {\n+                                    user.sendMessage(tl(\"versionErrorPlayer\"));\n+                                    break;\n+                                }\n+                                default: {\n+                                    break;\n+                                }\n+                            }\n+                        });\n+                    }", "originalCommit": "2ef496bc07c3893d66379f39e195dac2945c2b57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDA2ODA4NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r560068084", "bodyText": "Preferably put this in its own method for consistency", "author": "mdcfe", "createdAt": "2021-01-19T10:21:48Z", "path": "Essentials/src/main/java/com/earth2me/essentials/metrics/MetricsWrapper.java", "diffHunk": "@@ -38,6 +39,7 @@ public MetricsWrapper(final Plugin plugin, final int pluginId, final boolean inc\n         checkForcedMetrics();\n         addPermsChart();\n         addEconomyChart();\n+        addCustomChart(new Metrics.SimplePie(\"releaseBranch\", EssentialsUpdateChecker::getVersionBranch));", "originalCommit": "2ef496bc07c3893d66379f39e195dac2945c2b57", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3NjgzNTc5Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r576835796", "bodyText": "Pending adding a release page to the website, see EssentialsX/Website#29", "author": "mdcfe", "createdAt": "2021-02-16T13:49:25Z", "path": "Essentials/src/main/java/com/earth2me/essentials/commands/Commandessentials.java", "diffHunk": "@@ -388,10 +389,63 @@ private void runVersion(final Server server, final CommandSource sender, final S\n                 sender.sendMessage(tl(\"serverUnsupportedLimitedApi\"));\n                 break;\n         }\n-\n         if (VersionUtil.getSupportStatusClass() != null) {\n             sender.sendMessage(tl(\"serverUnsupportedClass\", VersionUtil.getSupportStatusClass()));\n         }\n+\n+        sender.sendMessage(tl(\"versionFetching\"));\n+        ess.runTaskAsynchronously(() -> {\n+            if (EssentialsUpdateChecker.isDevBuild()) {\n+                final EssentialsUpdateChecker.UpdateToken devToken = EssentialsUpdateChecker.getDevToken().join();\n+                switch (devToken.getBranchStatus()) {\n+                    case IDENTICAL: {\n+                        sender.sendMessage(tl(\"versionDevLatest\"));\n+                        break;\n+                    }\n+                    case BEHIND: {\n+                        sender.sendMessage(tl(\"versionDevBehind\", devToken.getDistance()));\n+                        break;\n+                    }\n+                    case AHEAD:\n+                    case DIVERGED: {\n+                        sender.sendMessage(tl(devToken.getDistance() == 0 ? \"versionDevDivergedLatest\" : \"versionDevDiverged\", devToken.getDistance()));\n+                        sender.sendMessage(tl(\"versionDevDivergedBranch\", EssentialsUpdateChecker.getVersionBranch()));\n+                        break;\n+                    }\n+                    case UNKNOWN: {\n+                        sender.sendMessage(tl(\"versionCustom\", EssentialsUpdateChecker.getBuildInfo()));\n+                        break;\n+                    }\n+                    case ERROR: {\n+                        sender.sendMessage(tl(\"versionError\", EssentialsUpdateChecker.getBuildInfo()));\n+                        break;\n+                    }\n+                }\n+            } else {\n+                final EssentialsUpdateChecker.UpdateToken releaseToken = EssentialsUpdateChecker.getReleaseToken().join();\n+                switch (releaseToken.getBranchStatus()) {\n+                    case IDENTICAL: {\n+                        sender.sendMessage(tl(\"versionReleaseLatest\"));\n+                        break;\n+                    }\n+                    case BEHIND: {\n+                        sender.sendMessage(tl(\"versionReleaseNew\", EssentialsUpdateChecker.getLatestRelease()));\n+                        //TODO download link? (https://github.com/EssentialsX/Website/issues/26)", "originalCommit": "2a5d53fbe5400a7e8ff6864d1b20c31e44c6be39", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3f64efa45c1b857cdacf53c4097010300401cecc", "url": "https://github.com/EssentialsX/Essentials/commit/3f64efa45c1b857cdacf53c4097010300401cecc", "message": "Apply suggestions from code review\n\nCo-authored-by: MD <1917406+mdcfe@users.noreply.github.com>", "committedDate": "2021-02-16T14:57:28Z", "type": "commit"}, {"oid": "a487d3f4289ca63180c14d0279fb71fddd6d20a9", "url": "https://github.com/EssentialsX/Essentials/commit/a487d3f4289ca63180c14d0279fb71fddd6d20a9", "message": "Move release branch chart to its own method", "committedDate": "2021-02-16T15:03:02Z", "type": "commit"}, {"oid": "66415902d0604eb33742fcb58b7749426d2a66be", "url": "https://github.com/EssentialsX/Essentials/commit/66415902d0604eb33742fcb58b7749426d2a66be", "message": "Reduce code duplication", "committedDate": "2021-02-16T17:22:36Z", "type": "commit"}, {"oid": "b5283ea9262e872caac5bac39932038d02c721c6", "url": "https://github.com/EssentialsX/Essentials/commit/b5283ea9262e872caac5bac39932038d02c721c6", "message": "Merge branch '2.x' into feature/update-checker", "committedDate": "2021-02-16T18:50:54Z", "type": "commit"}, {"oid": "7d36c54f1085a99434780ee3053e29c4c3b5e02d", "url": "https://github.com/EssentialsX/Essentials/commit/7d36c54f1085a99434780ee3053e29c4c3b5e02d", "message": "Add download link", "committedDate": "2021-02-24T23:18:25Z", "type": "commit"}, {"oid": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "url": "https://github.com/EssentialsX/Essentials/commit/ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "message": "Merge branch '2.x' into feature/update-checker", "committedDate": "2021-02-25T05:17:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5MjczNw==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r588892737", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final List<String> versionStr = new BufferedReader(new InputStreamReader(Objects.requireNonNull(EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\")), StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n          \n          \n            \n                    if (versionStr.size() == 2) {\n          \n          \n            \n                        if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n          \n          \n            \n                            identifier = versionStr.get(0).split(\"-\")[2];\n          \n          \n            \n                            dev = true;\n          \n          \n            \n                        } else {\n          \n          \n            \n                            identifier = versionStr.get(0);\n          \n          \n            \n                        }\n          \n          \n            \n                        branch = versionStr.get(1);\n          \n          \n            \n                    }\n          \n          \n            \n                    final InputStream inputStream = EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\");\n          \n          \n            \n                    if (inputStream != null) {\n          \n          \n            \n                        final List<String> versionStr = new BufferedReader(new InputStreamReader(inputStream, StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n          \n          \n            \n                        if (versionStr.size() == 2) {\n          \n          \n            \n                            if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n          \n          \n            \n                                identifier = versionStr.get(0).split(\"-\")[2];\n          \n          \n            \n                                dev = true;\n          \n          \n            \n                            } else {\n          \n          \n            \n                                identifier = versionStr.get(0);\n          \n          \n            \n                            }\n          \n          \n            \n                            branch = versionStr.get(1);\n          \n          \n            \n                        }\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nAfaik Objects.requireNonNull in the static block here will cause the class to not initialize, so EssentialsX won't load if the release file is missing.", "author": "mdcfe", "createdAt": "2021-03-06T15:09:05Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public final class EssentialsUpdateChecker {\n+    private static final String REPO = \"EssentialsX/Essentials\";\n+    private static final String BRANCH = \"2.x\";\n+\n+    private static final String versionIdentifier;\n+    private static final String versionBranch;\n+    private static final boolean devBuild;\n+    private static long lastFetchTime = 0;\n+    private static CompletableFuture<UpdateToken> pendingDevFuture;\n+    private static CompletableFuture<UpdateToken> pendingReleaseFuture;\n+    private static String latestRelease = null;\n+    private static UpdateToken cachedDev = null;\n+    private static UpdateToken cachedRelease = null;\n+\n+    static {\n+        String identifier = \"INVALID\";\n+        String branch = \"INVALID\";\n+        boolean dev = false;\n+        final List<String> versionStr = new BufferedReader(new InputStreamReader(Objects.requireNonNull(EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\")), StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n+        if (versionStr.size() == 2) {\n+            if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n+                identifier = versionStr.get(0).split(\"-\")[2];\n+                dev = true;\n+            } else {\n+                identifier = versionStr.get(0);\n+            }\n+            branch = versionStr.get(1);\n+        }", "originalCommit": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5MzA3Ng==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r588893076", "bodyText": "Should have a config option to disable - as it stands, this PR makes external connections without letting the user control them.\nProbably worth making the methods in this class non-static, passing in ISettings here, and only triggering update checks if enabled in config.", "author": "mdcfe", "createdAt": "2021-03-06T15:12:07Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public final class EssentialsUpdateChecker {\n+    private static final String REPO = \"EssentialsX/Essentials\";\n+    private static final String BRANCH = \"2.x\";\n+\n+    private static final String versionIdentifier;\n+    private static final String versionBranch;\n+    private static final boolean devBuild;\n+    private static long lastFetchTime = 0;\n+    private static CompletableFuture<UpdateToken> pendingDevFuture;\n+    private static CompletableFuture<UpdateToken> pendingReleaseFuture;\n+    private static String latestRelease = null;\n+    private static UpdateToken cachedDev = null;\n+    private static UpdateToken cachedRelease = null;\n+\n+    static {\n+        String identifier = \"INVALID\";\n+        String branch = \"INVALID\";\n+        boolean dev = false;\n+        final List<String> versionStr = new BufferedReader(new InputStreamReader(Objects.requireNonNull(EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\")), StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n+        if (versionStr.size() == 2) {\n+            if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n+                identifier = versionStr.get(0).split(\"-\")[2];\n+                dev = true;\n+            } else {\n+                identifier = versionStr.get(0);\n+            }\n+            branch = versionStr.get(1);\n+        }\n+        versionIdentifier = identifier;\n+        versionBranch = branch;\n+        devBuild = dev;\n+    }\n+\n+    private EssentialsUpdateChecker() {", "originalCommit": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5MzE1Mg==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r588893152", "bodyText": "Possibly move to com.earth2me.essentials.updatecheck.UpdateChecker? Base package is cluttered as it is.", "author": "mdcfe", "createdAt": "2021-03-06T15:13:07Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public final class EssentialsUpdateChecker {", "originalCommit": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5MzMzMg==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r588893332", "bodyText": "Why set to null here?", "author": "mdcfe", "createdAt": "2021-03-06T15:15:09Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public final class EssentialsUpdateChecker {\n+    private static final String REPO = \"EssentialsX/Essentials\";\n+    private static final String BRANCH = \"2.x\";\n+\n+    private static final String versionIdentifier;\n+    private static final String versionBranch;\n+    private static final boolean devBuild;\n+    private static long lastFetchTime = 0;\n+    private static CompletableFuture<UpdateToken> pendingDevFuture;\n+    private static CompletableFuture<UpdateToken> pendingReleaseFuture;\n+    private static String latestRelease = null;\n+    private static UpdateToken cachedDev = null;\n+    private static UpdateToken cachedRelease = null;\n+\n+    static {\n+        String identifier = \"INVALID\";\n+        String branch = \"INVALID\";\n+        boolean dev = false;\n+        final List<String> versionStr = new BufferedReader(new InputStreamReader(Objects.requireNonNull(EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\")), StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n+        if (versionStr.size() == 2) {\n+            if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n+                identifier = versionStr.get(0).split(\"-\")[2];\n+                dev = true;\n+            } else {\n+                identifier = versionStr.get(0);\n+            }\n+            branch = versionStr.get(1);\n+        }\n+        versionIdentifier = identifier;\n+        versionBranch = branch;\n+        devBuild = dev;\n+    }\n+\n+    private EssentialsUpdateChecker() {\n+    }\n+\n+    public static boolean isDevBuild() {\n+        return devBuild;\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getDevToken() {\n+        if (cachedDev == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingDevFuture != null) {\n+                return pendingDevFuture;\n+            }\n+            pendingDevFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                pendingDevFuture.complete(cachedDev = fetchDistance(BRANCH, getVersionIdentifier()));\n+                pendingDevFuture = null;\n+                lastFetchTime = System.currentTimeMillis();\n+            }).start();\n+            return pendingDevFuture;\n+        }\n+        return CompletableFuture.completedFuture(cachedDev);\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getReleaseToken() {\n+        if (cachedRelease == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingReleaseFuture != null) {\n+                return pendingReleaseFuture;\n+            }\n+            pendingReleaseFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                catchBlock:\n+                try {\n+                    final HttpURLConnection connection = (HttpURLConnection) new URL(\"https://api.github.com/repos/\" + REPO + \"/releases/latest\").openConnection();\n+                    connection.connect();\n+\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_NOT_FOUND) {\n+                        // Locally built?\n+                        pendingReleaseFuture.complete(cachedRelease = new UpdateToken(BranchStatus.UNKNOWN));\n+                        break catchBlock;\n+                    }\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_INTERNAL_ERROR) {\n+                        // Github is down\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                        break catchBlock;\n+                    }\n+\n+                    try (BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), Charsets.UTF_8))) {\n+                        latestRelease = new Gson().fromJson(reader, JsonObject.class).get(\"tag_name\").getAsString();\n+                        pendingReleaseFuture.complete(cachedRelease = fetchDistance(latestRelease, getVersionIdentifier()));\n+                    } catch (JsonSyntaxException | NumberFormatException e) {\n+                        e.printStackTrace();\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                    }\n+                } catch (IOException e) {\n+                    e.printStackTrace();\n+                    pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                }\n+                pendingReleaseFuture = null;", "originalCommit": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5MzczOQ==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r588893739", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    }\n          \n          \n            \n                    return pendingReleaseFuture;\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nWithout this, we would just return the cached result. On first run this is null and causes NPEs:", "author": "mdcfe", "createdAt": "2021-03-06T15:18:08Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public final class EssentialsUpdateChecker {\n+    private static final String REPO = \"EssentialsX/Essentials\";\n+    private static final String BRANCH = \"2.x\";\n+\n+    private static final String versionIdentifier;\n+    private static final String versionBranch;\n+    private static final boolean devBuild;\n+    private static long lastFetchTime = 0;\n+    private static CompletableFuture<UpdateToken> pendingDevFuture;\n+    private static CompletableFuture<UpdateToken> pendingReleaseFuture;\n+    private static String latestRelease = null;\n+    private static UpdateToken cachedDev = null;\n+    private static UpdateToken cachedRelease = null;\n+\n+    static {\n+        String identifier = \"INVALID\";\n+        String branch = \"INVALID\";\n+        boolean dev = false;\n+        final List<String> versionStr = new BufferedReader(new InputStreamReader(Objects.requireNonNull(EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\")), StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n+        if (versionStr.size() == 2) {\n+            if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n+                identifier = versionStr.get(0).split(\"-\")[2];\n+                dev = true;\n+            } else {\n+                identifier = versionStr.get(0);\n+            }\n+            branch = versionStr.get(1);\n+        }\n+        versionIdentifier = identifier;\n+        versionBranch = branch;\n+        devBuild = dev;\n+    }\n+\n+    private EssentialsUpdateChecker() {\n+    }\n+\n+    public static boolean isDevBuild() {\n+        return devBuild;\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getDevToken() {\n+        if (cachedDev == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingDevFuture != null) {\n+                return pendingDevFuture;\n+            }\n+            pendingDevFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                pendingDevFuture.complete(cachedDev = fetchDistance(BRANCH, getVersionIdentifier()));\n+                pendingDevFuture = null;\n+                lastFetchTime = System.currentTimeMillis();\n+            }).start();\n+            return pendingDevFuture;\n+        }\n+        return CompletableFuture.completedFuture(cachedDev);\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getReleaseToken() {\n+        if (cachedRelease == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingReleaseFuture != null) {\n+                return pendingReleaseFuture;\n+            }\n+            pendingReleaseFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                catchBlock:\n+                try {\n+                    final HttpURLConnection connection = (HttpURLConnection) new URL(\"https://api.github.com/repos/\" + REPO + \"/releases/latest\").openConnection();\n+                    connection.connect();\n+\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_NOT_FOUND) {\n+                        // Locally built?\n+                        pendingReleaseFuture.complete(cachedRelease = new UpdateToken(BranchStatus.UNKNOWN));\n+                        break catchBlock;\n+                    }\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_INTERNAL_ERROR) {\n+                        // Github is down\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                        break catchBlock;\n+                    }\n+\n+                    try (BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), Charsets.UTF_8))) {\n+                        latestRelease = new Gson().fromJson(reader, JsonObject.class).get(\"tag_name\").getAsString();\n+                        pendingReleaseFuture.complete(cachedRelease = fetchDistance(latestRelease, getVersionIdentifier()));\n+                    } catch (JsonSyntaxException | NumberFormatException e) {\n+                        e.printStackTrace();\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                    }\n+                } catch (IOException e) {\n+                    e.printStackTrace();\n+                    pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                }\n+                pendingReleaseFuture = null;\n+                lastFetchTime = System.currentTimeMillis();\n+            }).start();\n+        }", "originalCommit": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5MzkxMw==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r588893913", "bodyText": "...methods?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static String[] getVersionMethods(final boolean sendLatestMessage, final boolean verboseErrors) {\n          \n          \n            \n                public static String[] getVersionMessages(final boolean sendLatestMessage, final boolean verboseErrors) {", "author": "mdcfe", "createdAt": "2021-03-06T15:19:44Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public final class EssentialsUpdateChecker {\n+    private static final String REPO = \"EssentialsX/Essentials\";\n+    private static final String BRANCH = \"2.x\";\n+\n+    private static final String versionIdentifier;\n+    private static final String versionBranch;\n+    private static final boolean devBuild;\n+    private static long lastFetchTime = 0;\n+    private static CompletableFuture<UpdateToken> pendingDevFuture;\n+    private static CompletableFuture<UpdateToken> pendingReleaseFuture;\n+    private static String latestRelease = null;\n+    private static UpdateToken cachedDev = null;\n+    private static UpdateToken cachedRelease = null;\n+\n+    static {\n+        String identifier = \"INVALID\";\n+        String branch = \"INVALID\";\n+        boolean dev = false;\n+        final List<String> versionStr = new BufferedReader(new InputStreamReader(Objects.requireNonNull(EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\")), StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n+        if (versionStr.size() == 2) {\n+            if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n+                identifier = versionStr.get(0).split(\"-\")[2];\n+                dev = true;\n+            } else {\n+                identifier = versionStr.get(0);\n+            }\n+            branch = versionStr.get(1);\n+        }\n+        versionIdentifier = identifier;\n+        versionBranch = branch;\n+        devBuild = dev;\n+    }\n+\n+    private EssentialsUpdateChecker() {\n+    }\n+\n+    public static boolean isDevBuild() {\n+        return devBuild;\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getDevToken() {\n+        if (cachedDev == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingDevFuture != null) {\n+                return pendingDevFuture;\n+            }\n+            pendingDevFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                pendingDevFuture.complete(cachedDev = fetchDistance(BRANCH, getVersionIdentifier()));\n+                pendingDevFuture = null;\n+                lastFetchTime = System.currentTimeMillis();\n+            }).start();\n+            return pendingDevFuture;\n+        }\n+        return CompletableFuture.completedFuture(cachedDev);\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getReleaseToken() {\n+        if (cachedRelease == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingReleaseFuture != null) {\n+                return pendingReleaseFuture;\n+            }\n+            pendingReleaseFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                catchBlock:\n+                try {\n+                    final HttpURLConnection connection = (HttpURLConnection) new URL(\"https://api.github.com/repos/\" + REPO + \"/releases/latest\").openConnection();\n+                    connection.connect();\n+\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_NOT_FOUND) {\n+                        // Locally built?\n+                        pendingReleaseFuture.complete(cachedRelease = new UpdateToken(BranchStatus.UNKNOWN));\n+                        break catchBlock;\n+                    }\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_INTERNAL_ERROR) {\n+                        // Github is down\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                        break catchBlock;\n+                    }\n+\n+                    try (BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), Charsets.UTF_8))) {\n+                        latestRelease = new Gson().fromJson(reader, JsonObject.class).get(\"tag_name\").getAsString();\n+                        pendingReleaseFuture.complete(cachedRelease = fetchDistance(latestRelease, getVersionIdentifier()));\n+                    } catch (JsonSyntaxException | NumberFormatException e) {\n+                        e.printStackTrace();\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                    }\n+                } catch (IOException e) {\n+                    e.printStackTrace();\n+                    pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                }\n+                pendingReleaseFuture = null;\n+                lastFetchTime = System.currentTimeMillis();\n+            }).start();\n+        }\n+        return CompletableFuture.completedFuture(cachedRelease);\n+    }\n+\n+    public static String getVersionIdentifier() {\n+        return versionIdentifier;\n+    }\n+\n+    public static String getVersionBranch() {\n+        return versionBranch;\n+    }\n+\n+    public static String getBuildInfo() {\n+        return \"id:'\" + getVersionIdentifier() + \"' branch:'\" + getVersionBranch() + \"' isDev:\" + isDevBuild();\n+    }\n+\n+    public static String getLatestRelease() {\n+        return latestRelease;\n+    }\n+\n+    private static UpdateToken fetchDistance(final String head, final String hash) {\n+        try {\n+            final HttpURLConnection connection = (HttpURLConnection) new URL(\"https://api.github.com/repos/\" + REPO + \"/compare/\" + head + \"...\" + hash).openConnection();\n+            connection.connect();\n+\n+            if (connection.getResponseCode() == HttpURLConnection.HTTP_NOT_FOUND) {\n+                // Locally built?\n+                return new UpdateToken(BranchStatus.UNKNOWN);\n+            }\n+            if (connection.getResponseCode() == HttpURLConnection.HTTP_INTERNAL_ERROR) {\n+                // Github is down\n+                return new UpdateToken(BranchStatus.ERROR);\n+            }\n+\n+            try (BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), Charsets.UTF_8))) {\n+                final JsonObject obj = new Gson().fromJson(reader, JsonObject.class);\n+                switch (obj.get(\"status\").getAsString()) {\n+                    case \"identical\": {\n+                        return new UpdateToken(BranchStatus.IDENTICAL, 0);\n+                    }\n+                    case \"ahead\": {\n+                        return new UpdateToken(BranchStatus.AHEAD, 0);\n+                    }\n+                    case \"behind\": {\n+                        return new UpdateToken(BranchStatus.BEHIND, obj.get(\"behind_by\").getAsInt());\n+                    }\n+                    case \"diverged\": {\n+                        return new UpdateToken(BranchStatus.DIVERGED, obj.get(\"behind_by\").getAsInt());\n+                    }\n+                    default: {\n+                        return new UpdateToken(BranchStatus.UNKNOWN);\n+                    }\n+                }\n+            } catch (JsonSyntaxException | NumberFormatException e) {\n+                e.printStackTrace();\n+                return new UpdateToken(BranchStatus.ERROR);\n+            }\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+            return new UpdateToken(BranchStatus.ERROR);\n+        }\n+    }\n+\n+    public static String[] getVersionMethods(final boolean sendLatestMessage, final boolean verboseErrors) {", "originalCommit": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4ODg5NDA0NA==", "url": "https://github.com/EssentialsX/Essentials/pull/3855#discussion_r588894044", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static class UpdateToken {\n          \n          \n            \n                public static class Version {", "author": "mdcfe", "createdAt": "2021-03-06T15:20:51Z", "path": "Essentials/src/main/java/com/earth2me/essentials/EssentialsUpdateChecker.java", "diffHunk": "@@ -0,0 +1,258 @@\n+package com.earth2me.essentials;\n+\n+import com.google.common.base.Charsets;\n+import com.google.gson.Gson;\n+import com.google.gson.JsonObject;\n+import com.google.gson.JsonSyntaxException;\n+\n+import java.io.BufferedReader;\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.net.HttpURLConnection;\n+import java.net.URL;\n+import java.nio.charset.StandardCharsets;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.stream.Collectors;\n+\n+import static com.earth2me.essentials.I18n.tl;\n+\n+public final class EssentialsUpdateChecker {\n+    private static final String REPO = \"EssentialsX/Essentials\";\n+    private static final String BRANCH = \"2.x\";\n+\n+    private static final String versionIdentifier;\n+    private static final String versionBranch;\n+    private static final boolean devBuild;\n+    private static long lastFetchTime = 0;\n+    private static CompletableFuture<UpdateToken> pendingDevFuture;\n+    private static CompletableFuture<UpdateToken> pendingReleaseFuture;\n+    private static String latestRelease = null;\n+    private static UpdateToken cachedDev = null;\n+    private static UpdateToken cachedRelease = null;\n+\n+    static {\n+        String identifier = \"INVALID\";\n+        String branch = \"INVALID\";\n+        boolean dev = false;\n+        final List<String> versionStr = new BufferedReader(new InputStreamReader(Objects.requireNonNull(EssentialsUpdateChecker.class.getClassLoader().getResourceAsStream(\"release\")), StandardCharsets.UTF_8)).lines().collect(Collectors.toList());\n+        if (versionStr.size() == 2) {\n+            if (versionStr.get(0).matches(\"\\\\d+\\\\.\\\\d+\\\\.\\\\d+-dev\\\\+\\\\d\\\\d-[0-9a-f]{7,40}\")) {\n+                identifier = versionStr.get(0).split(\"-\")[2];\n+                dev = true;\n+            } else {\n+                identifier = versionStr.get(0);\n+            }\n+            branch = versionStr.get(1);\n+        }\n+        versionIdentifier = identifier;\n+        versionBranch = branch;\n+        devBuild = dev;\n+    }\n+\n+    private EssentialsUpdateChecker() {\n+    }\n+\n+    public static boolean isDevBuild() {\n+        return devBuild;\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getDevToken() {\n+        if (cachedDev == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingDevFuture != null) {\n+                return pendingDevFuture;\n+            }\n+            pendingDevFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                pendingDevFuture.complete(cachedDev = fetchDistance(BRANCH, getVersionIdentifier()));\n+                pendingDevFuture = null;\n+                lastFetchTime = System.currentTimeMillis();\n+            }).start();\n+            return pendingDevFuture;\n+        }\n+        return CompletableFuture.completedFuture(cachedDev);\n+    }\n+\n+    public static CompletableFuture<UpdateToken> getReleaseToken() {\n+        if (cachedRelease == null || ((System.currentTimeMillis() - lastFetchTime) > 1800000L)) {\n+            if (pendingReleaseFuture != null) {\n+                return pendingReleaseFuture;\n+            }\n+            pendingReleaseFuture = new CompletableFuture<>();\n+            new Thread(() -> {\n+                catchBlock:\n+                try {\n+                    final HttpURLConnection connection = (HttpURLConnection) new URL(\"https://api.github.com/repos/\" + REPO + \"/releases/latest\").openConnection();\n+                    connection.connect();\n+\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_NOT_FOUND) {\n+                        // Locally built?\n+                        pendingReleaseFuture.complete(cachedRelease = new UpdateToken(BranchStatus.UNKNOWN));\n+                        break catchBlock;\n+                    }\n+                    if (connection.getResponseCode() == HttpURLConnection.HTTP_INTERNAL_ERROR) {\n+                        // Github is down\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                        break catchBlock;\n+                    }\n+\n+                    try (BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), Charsets.UTF_8))) {\n+                        latestRelease = new Gson().fromJson(reader, JsonObject.class).get(\"tag_name\").getAsString();\n+                        pendingReleaseFuture.complete(cachedRelease = fetchDistance(latestRelease, getVersionIdentifier()));\n+                    } catch (JsonSyntaxException | NumberFormatException e) {\n+                        e.printStackTrace();\n+                        pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                    }\n+                } catch (IOException e) {\n+                    e.printStackTrace();\n+                    pendingReleaseFuture.complete(new UpdateToken(BranchStatus.ERROR));\n+                }\n+                pendingReleaseFuture = null;\n+                lastFetchTime = System.currentTimeMillis();\n+            }).start();\n+        }\n+        return CompletableFuture.completedFuture(cachedRelease);\n+    }\n+\n+    public static String getVersionIdentifier() {\n+        return versionIdentifier;\n+    }\n+\n+    public static String getVersionBranch() {\n+        return versionBranch;\n+    }\n+\n+    public static String getBuildInfo() {\n+        return \"id:'\" + getVersionIdentifier() + \"' branch:'\" + getVersionBranch() + \"' isDev:\" + isDevBuild();\n+    }\n+\n+    public static String getLatestRelease() {\n+        return latestRelease;\n+    }\n+\n+    private static UpdateToken fetchDistance(final String head, final String hash) {\n+        try {\n+            final HttpURLConnection connection = (HttpURLConnection) new URL(\"https://api.github.com/repos/\" + REPO + \"/compare/\" + head + \"...\" + hash).openConnection();\n+            connection.connect();\n+\n+            if (connection.getResponseCode() == HttpURLConnection.HTTP_NOT_FOUND) {\n+                // Locally built?\n+                return new UpdateToken(BranchStatus.UNKNOWN);\n+            }\n+            if (connection.getResponseCode() == HttpURLConnection.HTTP_INTERNAL_ERROR) {\n+                // Github is down\n+                return new UpdateToken(BranchStatus.ERROR);\n+            }\n+\n+            try (BufferedReader reader = new BufferedReader(new InputStreamReader(connection.getInputStream(), Charsets.UTF_8))) {\n+                final JsonObject obj = new Gson().fromJson(reader, JsonObject.class);\n+                switch (obj.get(\"status\").getAsString()) {\n+                    case \"identical\": {\n+                        return new UpdateToken(BranchStatus.IDENTICAL, 0);\n+                    }\n+                    case \"ahead\": {\n+                        return new UpdateToken(BranchStatus.AHEAD, 0);\n+                    }\n+                    case \"behind\": {\n+                        return new UpdateToken(BranchStatus.BEHIND, obj.get(\"behind_by\").getAsInt());\n+                    }\n+                    case \"diverged\": {\n+                        return new UpdateToken(BranchStatus.DIVERGED, obj.get(\"behind_by\").getAsInt());\n+                    }\n+                    default: {\n+                        return new UpdateToken(BranchStatus.UNKNOWN);\n+                    }\n+                }\n+            } catch (JsonSyntaxException | NumberFormatException e) {\n+                e.printStackTrace();\n+                return new UpdateToken(BranchStatus.ERROR);\n+            }\n+        } catch (IOException e) {\n+            e.printStackTrace();\n+            return new UpdateToken(BranchStatus.ERROR);\n+        }\n+    }\n+\n+    public static String[] getVersionMethods(final boolean sendLatestMessage, final boolean verboseErrors) {\n+        if (EssentialsUpdateChecker.isDevBuild()) {\n+            final EssentialsUpdateChecker.UpdateToken devToken = EssentialsUpdateChecker.getDevToken().join();\n+            switch (devToken.getBranchStatus()) {\n+                case IDENTICAL: {\n+                    return sendLatestMessage ? new String[] {tl(\"versionDevLatest\")} : new String[] {};\n+                }\n+                case BEHIND: {\n+                    return new String[] {tl(\"versionDevBehind\", devToken.getDistance()),\n+                            tl(\"versionReleaseNewLink\", \"https://essentialsx.net/downloads.html\")};\n+                }\n+                case AHEAD:\n+                case DIVERGED: {\n+                    return new String[] {tl(devToken.getDistance() == 0 ? \"versionDevDivergedLatest\" : \"versionDevDiverged\", devToken.getDistance()),\n+                            tl(\"versionDevDivergedBranch\", EssentialsUpdateChecker.getVersionBranch()) };\n+                }\n+                case UNKNOWN: {\n+                    return verboseErrors ? new String[] {tl(\"versionCustom\", EssentialsUpdateChecker.getBuildInfo())} : new String[] {};\n+                }\n+                case ERROR: {\n+                    return new String[] {tl(verboseErrors ? \"versionError\" : \"versionErrorPlayer\", EssentialsUpdateChecker.getBuildInfo())};\n+                }\n+                default: {\n+                    return new String[] {};\n+                }\n+            }\n+        } else {\n+            final EssentialsUpdateChecker.UpdateToken releaseToken = EssentialsUpdateChecker.getReleaseToken().join();\n+            switch (releaseToken.getBranchStatus()) {\n+                case IDENTICAL: {\n+                    return sendLatestMessage ? new String[] {tl(\"versionReleaseLatest\")} : new String[] {};\n+                }\n+                case BEHIND: {\n+                    return new String[] {tl(\"versionReleaseNew\", EssentialsUpdateChecker.getLatestRelease()),\n+                            tl(\"versionReleaseNewLink\", \"https://essentialsx.net/downloads.html?branch=stable\")};\n+                }\n+                case DIVERGED: //WhatChamp\n+                case AHEAD: //monkaW?\n+                case UNKNOWN: {\n+                    return verboseErrors ? new String[] {tl(\"versionCustom\", EssentialsUpdateChecker.getBuildInfo())} : new String[] {};\n+                }\n+                case ERROR: {\n+                    return new String[] {tl(verboseErrors ? \"versionError\" : \"versionErrorPlayer\", EssentialsUpdateChecker.getBuildInfo())};\n+                }\n+                default: {\n+                    return new String[] {};\n+                }\n+            }\n+        }\n+    }\n+\n+    public static class UpdateToken {", "originalCommit": "ad9f8596e044f9c459d2bbd7d3a61ab527872af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3e7b9b14fdea5169e0912b4931164793695df90b", "url": "https://github.com/EssentialsX/Essentials/commit/3e7b9b14fdea5169e0912b4931164793695df90b", "message": "Don't return cached release info before actually fetching it", "committedDate": "2021-03-06T15:25:40Z", "type": "commit"}, {"oid": "dfdca8f68b631c59d5f26e3a2a4e553f20014e78", "url": "https://github.com/EssentialsX/Essentials/commit/dfdca8f68b631c59d5f26e3a2a4e553f20014e78", "message": "Don't implode when release file is missing", "committedDate": "2021-03-06T15:26:18Z", "type": "commit"}, {"oid": "e3cbe8fde6dda5832ce92dc89b062a427f6b6490", "url": "https://github.com/EssentialsX/Essentials/commit/e3cbe8fde6dda5832ce92dc89b062a427f6b6490", "message": "Rename UpdateToken to RemoteVersion\n\nwtf is a token jroy pls", "committedDate": "2021-03-06T15:30:56Z", "type": "commit"}, {"oid": "b823e4dd02a5aaf52c57d6ad981e836a93a2ef7a", "url": "https://github.com/EssentialsX/Essentials/commit/b823e4dd02a5aaf52c57d6ad981e836a93a2ef7a", "message": "Rename EssentialsUpdateChecker -> UpdateChecker; make non-static\n\nHoly mother of static abuse", "committedDate": "2021-03-06T15:48:50Z", "type": "commit"}, {"oid": "68e454493c3db22269f2e00818aa1a702ec6e599", "url": "https://github.com/EssentialsX/Essentials/commit/68e454493c3db22269f2e00818aa1a702ec6e599", "message": "Add config option for update checks", "committedDate": "2021-03-06T15:58:32Z", "type": "commit"}, {"oid": "945d1bbda888cbb8c23f35014b1efd4988f75446", "url": "https://github.com/EssentialsX/Essentials/commit/945d1bbda888cbb8c23f35014b1efd4988f75446", "message": "Remove unused imports", "committedDate": "2021-03-06T16:04:56Z", "type": "commit"}, {"oid": "7a36f99945e09d68facb258e350f40e235fdf8a7", "url": "https://github.com/EssentialsX/Essentials/commit/7a36f99945e09d68facb258e350f40e235fdf8a7", "message": "Add config option to config.yml", "committedDate": "2021-03-06T16:26:39Z", "type": "commit"}, {"oid": "c4e44fd3be5479d3a4d09c6e2350a9e3d6c0b266", "url": "https://github.com/EssentialsX/Essentials/commit/c4e44fd3be5479d3a4d09c6e2350a9e3d6c0b266", "message": "Merge branch '2.x' into feature/update-checker", "committedDate": "2021-03-06T16:26:59Z", "type": "commit"}]}