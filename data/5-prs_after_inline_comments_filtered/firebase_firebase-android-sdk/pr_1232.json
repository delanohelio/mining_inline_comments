{"pr_number": 1232, "pr_title": "Improve impression logging for experimental campaigns", "pr_createdAt": "2020-02-11T22:25:03Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1232", "timeline": [{"oid": "493f82d1d940f813b979ece5ffd2e55d192d4587", "url": "https://github.com/firebase/firebase-android-sdk/commit/493f82d1d940f813b979ece5ffd2e55d192d4587", "message": "Improve logging for experimental campaigns", "committedDate": "2020-02-11T22:24:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzkzNzc3Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r377937776", "bodyText": "Lets do Already impression campaign / experiment appropriately... Also, lets move this log line generation to a function.", "author": "prakhar1989", "createdAt": "2020-02-11T22:28:18Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -197,7 +197,14 @@ private boolean shouldIgnoreCache(String event) {\n                                       Logging.logi(\n                                           String.format(\n                                               \"Already impressed %s ? : %s\",", "originalCommit": "493f82d1d940f813b979ece5ffd2e55d192d4587", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "517eb31346fe612eb9260878da93fdd4d87a82b4", "url": "https://github.com/firebase/firebase-android-sdk/commit/517eb31346fe612eb9260878da93fdd4d87a82b4", "message": "Also make everything good", "committedDate": "2020-02-12T00:03:08Z", "type": "commit"}, {"oid": "982a18088d956ce57be3301fa1d2f14640106326", "url": "https://github.com/firebase/firebase-android-sdk/commit/982a18088d956ce57be3301fa1d2f14640106326", "message": "fight the formatter", "committedDate": "2020-02-12T00:09:50Z", "type": "commit"}, {"oid": "3369f3bb7ab976f83475ebb7dcec28a203ea8480", "url": "https://github.com/firebase/firebase-android-sdk/commit/3369f3bb7ab976f83475ebb7dcec28a203ea8480", "message": "make it better", "committedDate": "2020-02-12T00:48:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNDI0Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r378034242", "bodyText": "boolean primitive cannot be null", "author": "PromanSEW", "createdAt": "2020-02-12T04:21:20Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/model/ProtoMarshallerClient.java", "diffHunk": "@@ -207,11 +208,14 @@ private static Text decode(MessagesProto.Text in) {\n   /** Tranform {@link MessagesProto.Content} proto to an {@link InAppMessage} value object */\n   public static InAppMessage decode(\n       @Nonnull MessagesProto.Content in,\n-      String campaignId,\n-      String campaignName,\n-      boolean isTestMessage,\n+      @NonNull String campaignId,\n+      @NonNull String campaignName,\n+      @NonNull boolean isTestMessage,", "originalCommit": "3369f3bb7ab976f83475ebb7dcec28a203ea8480", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODQxMTMyMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r378411321", "bodyText": "Thanks!", "author": "JasonAHeron", "createdAt": "2020-02-12T17:46:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAzNDI0Mg=="}], "type": "inlineReview"}, {"oid": "87d07a184480d324a17b4a2da25f385b2c0f45df", "url": "https://github.com/firebase/firebase-android-sdk/commit/87d07a184480d324a17b4a2da25f385b2c0f45df", "message": "be less dumb", "committedDate": "2020-02-12T17:49:12Z", "type": "commit"}, {"oid": "04901c68b7c38fa8b65cad14454da178868cf1e7", "url": "https://github.com/firebase/firebase-android-sdk/commit/04901c68b7c38fa8b65cad14454da178868cf1e7", "message": "fix the tests", "committedDate": "2020-02-12T19:35:59Z", "type": "commit"}, {"oid": "89b5f2f9573387118c88aafd777597422e7e1dc0", "url": "https://github.com/firebase/firebase-android-sdk/commit/89b5f2f9573387118c88aafd777597422e7e1dc0", "message": "cant be null", "committedDate": "2020-02-12T20:27:43Z", "type": "commit"}, {"oid": "4eca1c012dbeb5dd10c3210cbdbb43ebb24bf3e9", "url": "https://github.com/firebase/firebase-android-sdk/commit/4eca1c012dbeb5dd10c3210cbdbb43ebb24bf3e9", "message": "format", "committedDate": "2020-02-12T20:47:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxNzQxNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r378517416", "bodyText": "nit: add a space after \":\"", "author": "prakhar1989", "createdAt": "2020-02-12T21:17:37Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/DisplayCallbacksImpl.java", "diffHunk": "@@ -224,9 +224,9 @@ private void logActionNotTaken(String action) {\n   }\n \n   private Completable logToImpressionStore() {\n-    Logging.logd(\"Attempting to record: message impression in impression store\");\n-    String campaignId = inAppMessage.getCampaignId();\n-\n+    String campaignId = inAppMessage.getCampaignMetadata().getCampaignId();\n+    Logging.logd(\n+        \"Attempting to record message impression in impression store for id:\" + campaignId);", "originalCommit": "4eca1c012dbeb5dd10c3210cbdbb43ebb24bf3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxODMxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r378518318", "bodyText": "nit: In experimental payload case, this is technically an experimentId, right? Should add that as a comment / clarification and / or rename this variable?", "author": "prakhar1989", "createdAt": "2020-02-12T21:19:27Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/ImpressionStorageClient.java", "diffHunk": "@@ -84,7 +85,11 @@ private void clearInMemCache() {\n   }\n \n   /** Returns {@code Single.just(true)} if the campaign has been impressed */\n-  public Single<Boolean> isImpressed(String campaignId) {\n+  public Single<Boolean> isImpressed(CampaignProto.ThickContent content) {\n+    String campaignId =", "originalCommit": "4eca1c012dbeb5dd10c3210cbdbb43ebb24bf3e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUzMTk2Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r378531963", "bodyText": "Yeah, throughout the rest of the code we call this a campaignId and basically what it really is is a unique message identifier. In reality it should probably just be ID. it doesn't even matter that it's a campaignId or an experimentId just that it uniquely identifies this message. so I've just left it was campaignId.", "author": "JasonAHeron", "createdAt": "2020-02-12T21:48:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxODMxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxODUzOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r378518538", "bodyText": "s/campaign/experiment?", "author": "prakhar1989", "createdAt": "2020-02-12T21:19:55Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -288,6 +282,20 @@ private boolean shouldIgnoreCache(String event) {\n     return Maybe.just(content);\n   }\n \n+  private static void logImpressionStatus(ThickContent content, Boolean isImpressed) {\n+    if (content.getPayloadCase().equals(ThickContent.PayloadCase.VANILLA_PAYLOAD)) {\n+      Logging.logi(\n+          String.format(\n+              \"Already impressed campaign %s ? : %s\",\n+              content.getVanillaPayload().getCampaignName(), isImpressed));\n+    } else if (content.getPayloadCase().equals(ThickContent.PayloadCase.EXPERIMENTAL_PAYLOAD)) {\n+      Logging.logi(\n+          String.format(\n+              \"Already impressed campaign %s ? : %s\",", "originalCommit": "4eca1c012dbeb5dd10c3210cbdbb43ebb24bf3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODUxOTA3OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1232#discussion_r378519078", "bodyText": "why did we change this? The more specific it is, the better. I'd vote for bringing this back.", "author": "prakhar1989", "createdAt": "2020-02-12T21:21:09Z", "path": "firebase-inappmessaging/src/test/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManagerTest.java", "diffHunk": "@@ -560,7 +559,7 @@ public void stream_onCacheWriteFailure_AbsorbsError() {\n \n   @Test\n   public void stream_whenCampaignImpressed_filtersCampaign() {\n-    when(impressionStorageClient.isImpressed(anyString())).thenReturn(Single.just(true));\n+    when(impressionStorageClient.isImpressed(any())).thenReturn(Single.just(true));", "originalCommit": "4eca1c012dbeb5dd10c3210cbdbb43ebb24bf3e9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d348ac0de2322170ceec80a78987fde6c3a1699a", "url": "https://github.com/firebase/firebase-android-sdk/commit/d348ac0de2322170ceec80a78987fde6c3a1699a", "message": "k", "committedDate": "2020-02-12T21:50:01Z", "type": "commit"}]}