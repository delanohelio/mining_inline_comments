{"pr_number": 1100, "pr_title": "Get the IID token before fetching Remote Config.", "pr_createdAt": "2020-01-08T01:12:34Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1100", "timeline": [{"oid": "62c50d9e94170d133e0592782ff8ac3041da9955", "url": "https://github.com/firebase/firebase-android-sdk/commit/62c50d9e94170d133e0592782ff8ac3041da9955", "message": "Get IID token before fetching Remote Config.", "committedDate": "2020-01-07T23:20:58Z", "type": "commit"}, {"oid": "3302f7b82d98ec8c297c4c319fc01a874b5556f8", "url": "https://github.com/firebase/firebase-android-sdk/commit/3302f7b82d98ec8c297c4c319fc01a874b5556f8", "message": "Revert log line in fetch request.", "committedDate": "2020-01-07T23:38:18Z", "type": "commit"}, {"oid": "c998b982d68ed95804e5de9f13b89f25ed9c22b2", "url": "https://github.com/firebase/firebase-android-sdk/commit/c998b982d68ed95804e5de9f13b89f25ed9c22b2", "message": "Remove whitespace.", "committedDate": "2020-01-07T23:39:17Z", "type": "commit"}, {"oid": "6c6e81d950bd31898b4fee60e0910bc3d0a3eff7", "url": "https://github.com/firebase/firebase-android-sdk/commit/6c6e81d950bd31898b4fee60e0910bc3d0a3eff7", "message": "Add copyright to new file.", "committedDate": "2020-01-08T01:20:15Z", "type": "commit"}, {"oid": "a8f519be43eb9c9acfe0a09276ef76e4188631a0", "url": "https://github.com/firebase/firebase-android-sdk/commit/a8f519be43eb9c9acfe0a09276ef76e4188631a0", "message": "Run googleJavaFormat.", "committedDate": "2020-01-08T19:28:12Z", "type": "commit"}, {"oid": "8db94c581e13b8659b11a4e266546803cda116ea", "url": "https://github.com/firebase/firebase-android-sdk/commit/8db94c581e13b8659b11a4e266546803cda116ea", "message": "Add getInstanceId() call to ensureInitialized().", "committedDate": "2020-01-09T00:54:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxNzcyMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364517721", "bodyText": "nit: preserve order?", "author": "clp93", "createdAt": "2020-01-09T01:02:52Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/FirebaseRemoteConfigTest.java", "diffHunk": "@@ -196,6 +205,7 @@ public void setUp() throws Exception {\n   public void ensureInitialized_notInitialized_isNotComplete() {\n     loadCacheWithConfig(mockFetchedCache, /*container=*/ null);\n     loadCacheWithConfig(mockDefaultsCache, /*container=*/ null);\n+    when(mockFirebaseInstanceId.getInstanceId()).thenReturn(Tasks.forResult(INSTANCE_ID_RESULT));", "originalCommit": "8db94c581e13b8659b11a4e266546803cda116ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk1OTQ2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364959464", "bodyText": "I was ordering by complete then incomplete tasks, but I can use the order of tasks in ensureInitialized instead", "author": "danasilver", "createdAt": "2020-01-09T21:06:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxNzcyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxODE4Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364518186", "bodyText": "in previous android changes tests, we have used methods like loadInstanceIdAndToken() (which you changed below). WDYT about doing something similar in this file? It does make it slightly more readable, but at this point, i'm just infavor of consistency :)  https://osscs.corp.google.com/firebase/firebase-android-sdk/+/master:firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandlerTest.java;l=868-871;drc=5301121df4727b357293b3b7de00555362f90170", "author": "clp93", "createdAt": "2020-01-09T01:05:11Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/FirebaseRemoteConfigTest.java", "diffHunk": "@@ -196,6 +205,7 @@ public void setUp() throws Exception {\n   public void ensureInitialized_notInitialized_isNotComplete() {\n     loadCacheWithConfig(mockFetchedCache, /*container=*/ null);\n     loadCacheWithConfig(mockDefaultsCache, /*container=*/ null);\n+    when(mockFirebaseInstanceId.getInstanceId()).thenReturn(Tasks.forResult(INSTANCE_ID_RESULT));", "originalCommit": "8db94c581e13b8659b11a4e266546803cda116ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk2MDEwMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364960100", "bodyText": "Sure, I like the consistency. I do think just having the mock in the method is easier to read, though.", "author": "danasilver", "createdAt": "2020-01-09T21:07:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxODE4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzODk2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364538968", "bodyText": "Thinking out loud: this warms the cache", "author": "erikeldridge", "createdAt": "2020-01-09T02:51:35Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/FirebaseRemoteConfig.java", "diffHunk": "@@ -186,9 +191,14 @@ public static FirebaseRemoteConfig getInstance(@NonNull FirebaseApp app) {\n     Task<ConfigContainer> defaultsConfigsTask = defaultConfigsCache.get();\n     Task<ConfigContainer> fetchedConfigsTask = fetchedConfigsCache.get();\n     Task<FirebaseRemoteConfigInfo> metadataTask = Tasks.call(executor, this::getInfo);\n+    Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();", "originalCommit": "8db94c581e13b8659b11a4e266546803cda116ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk1MTEyMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364951121", "bodyText": "Yeah, if ensureInitialized() is called before first fetch, fetch() won't need to wait for the first roundtrip for the IID token.", "author": "danasilver", "createdAt": "2020-01-09T20:43:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzODk2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUzOTQzNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364539437", "bodyText": "Thinking out loud: the instance ID can change any time, so it's good we're loading it from the IID SDK before each fetch, ie as opposed to caching the ID", "author": "erikeldridge", "createdAt": "2020-01-09T02:54:11Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -188,7 +189,21 @@ public ConfigFetchHandler(\n                   createThrottledMessage(backoffEndTime.getTime() - currentTime.getTime()),\n                   backoffEndTime.getTime()));\n     } else {\n-      fetchResponseTask = fetchFromBackendAndCacheResponse(currentTime);\n+      Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();", "originalCommit": "8db94c581e13b8659b11a4e266546803cda116ea", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDA0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364540047", "bodyText": "I'm wondering if completedIidTask is passed in as a thread-safe reference, since this is an async operation. Seems easy enough to just use it, eg completedIidTask.isSuccessful().\nMinor: if it's fine to reference instanceIdTask and completedIidTask is unused, we could indicate that's intentional in the name, eg completedIidTask --> unusedTask.", "author": "erikeldridge", "createdAt": "2020-01-09T02:57:20Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -188,7 +189,21 @@ public ConfigFetchHandler(\n                   createThrottledMessage(backoffEndTime.getTime() - currentTime.getTime()),\n                   backoffEndTime.getTime()));\n     } else {\n-      fetchResponseTask = fetchFromBackendAndCacheResponse(currentTime);\n+      Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();\n+      fetchResponseTask =\n+          instanceIdTask.continueWithTask(\n+              executor,\n+              (completedIidTask) -> {", "originalCommit": "8db94c581e13b8659b11a4e266546803cda116ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk1NTExMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364955111", "bodyText": "Ah, good call. Updated to check completedIidTask.isSuccessful().", "author": "danasilver", "createdAt": "2020-01-09T20:54:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzNTU1MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r366035551", "bodyText": "\ud83d\udc4d", "author": "erikeldridge", "createdAt": "2020-01-13T21:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDY4MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364540680", "bodyText": "Thinking out loud: this continues to be an instance var. Weird how it has getInstanceId and getId methods.", "author": "erikeldridge", "createdAt": "2020-01-09T03:00:51Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -270,15 +286,16 @@ private String createThrottledMessage(long throttledDurationInMillis) {\n    *     error connecting to the server.\n    */\n   @WorkerThread\n-  private FetchResponse fetchFromBackend(Date currentTime) throws FirebaseRemoteConfigException {\n+  private FetchResponse fetchFromBackend(InstanceIdResult instanceId, Date currentTime)\n+      throws FirebaseRemoteConfigException {\n     try {\n       HttpURLConnection urlConnection = frcBackendApiClient.createHttpURLConnection();\n \n       FetchResponse response =\n           frcBackendApiClient.fetch(\n               urlConnection,\n-              firebaseInstanceId.getId(),\n-              firebaseInstanceId.getToken(),", "originalCommit": "8db94c581e13b8659b11a4e266546803cda116ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDk1NTc0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r364955749", "bodyText": "Not sure I follow? I believe InstanceIdResult only has getId() and getToken().", "author": "danasilver", "createdAt": "2020-01-09T20:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzODM0OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r366038348", "bodyText": "I was just noting the similarity in naming between firebaseInstanceId.getInstanceId and instanceId.getId. I guess this is highlighted by this review, where we can see both side by side.  To be clear, I don't think any action is required.", "author": "erikeldridge", "createdAt": "2020-01-13T21:29:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU0MDY4MA=="}], "type": "inlineReview"}, {"oid": "b729eb183bf3970c8dd156677c3912950be98bdc", "url": "https://github.com/firebase/firebase-android-sdk/commit/b729eb183bf3970c8dd156677c3912950be98bdc", "message": "Add iid to kotlin and re-order iid in RC constructor.", "committedDate": "2020-01-09T18:41:21Z", "type": "commit"}, {"oid": "55ce968c9c67ae5841a37d2a27d2a5dbf098fb89", "url": "https://github.com/firebase/firebase-android-sdk/commit/55ce968c9c67ae5841a37d2a27d2a5dbf098fb89", "message": "Fix ktx test.", "committedDate": "2020-01-09T20:15:50Z", "type": "commit"}, {"oid": "f27393f95c3fe19d01931b200042e12f52d2a64a", "url": "https://github.com/firebase/firebase-android-sdk/commit/f27393f95c3fe19d01931b200042e12f52d2a64a", "message": "Updates in response to review feedback.", "committedDate": "2020-01-09T21:08:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzYxODc0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1100#discussion_r367618747", "bodyText": "nit: just grab the exception from the callback arg", "author": "ciarand", "createdAt": "2020-01-16T19:54:18Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/ConfigFetchHandler.java", "diffHunk": "@@ -188,7 +189,21 @@ public ConfigFetchHandler(\n                   createThrottledMessage(backoffEndTime.getTime() - currentTime.getTime()),\n                   backoffEndTime.getTime()));\n     } else {\n-      fetchResponseTask = fetchFromBackendAndCacheResponse(currentTime);\n+      Task<InstanceIdResult> instanceIdTask = firebaseInstanceId.getInstanceId();\n+      fetchResponseTask =\n+          instanceIdTask.continueWithTask(\n+              executor,\n+              (completedIidTask) -> {\n+                if (!completedIidTask.isSuccessful()) {\n+                  return Tasks.forException(\n+                      new FirebaseRemoteConfigClientException(\n+                          \"Failed to get Firebase Instance ID token for fetch.\",\n+                          instanceIdTask.getException()));", "originalCommit": "f27393f95c3fe19d01931b200042e12f52d2a64a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "12134ec04a648c3b08749198058262211f7c7c37", "url": "https://github.com/firebase/firebase-android-sdk/commit/12134ec04a648c3b08749198058262211f7c7c37", "message": "Use completed task for IID token exception.", "committedDate": "2020-01-16T21:08:38Z", "type": "commit"}]}