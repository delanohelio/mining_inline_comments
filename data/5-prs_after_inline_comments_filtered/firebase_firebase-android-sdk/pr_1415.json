{"pr_number": 1415, "pr_title": "DeferredValue changes for ServerValue.increment()", "pr_createdAt": "2020-04-01T22:04:26Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1415", "timeline": [{"oid": "cb986fe9c5378cdba7ba1b1add7255c32a180a35", "url": "https://github.com/firebase/firebase-android-sdk/commit/cb986fe9c5378cdba7ba1b1add7255c32a180a35", "message": "DeferredValue changes for ServerValue.increment()\n\nPorts https://github.com/firebase/firebase-ios-sdk/pull/5149/commits/aa67e19051a9b92d6fca709e709d3ac58beb00ed", "committedDate": "2020-04-01T22:04:15Z", "type": "commit"}, {"oid": "6410ea53df6618dbf040de6cb3f5fba4096de187", "url": "https://github.com/firebase/firebase-android-sdk/commit/6410ea53df6618dbf040de6cb3f5fba4096de187", "message": "Format", "committedDate": "2020-04-01T22:14:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzU2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401957564", "bodyText": "nit: boolean values should typically be named. E.g. serverIncrementOverwritesExistingData(/*online*/ true);", "author": "inlined", "createdAt": "2020-04-01T22:56:27Z", "path": "firebase-database/src/androidTest/java/com/google/firebase/database/DataTest.java", "diffHunk": "@@ -2747,7 +2747,18 @@ public void onComplete(DatabaseError error, boolean committed, DataSnapshot curr\n   }\n \n   @Test\n-  public void testServerIncrementOverwritesExistingData()\n+  public void testServerIncrementOverwritesExistingDataOnline()\n+      throws DatabaseException, TimeoutException, InterruptedException {\n+    serverIncrementOverwritesExistingData(true);", "originalCommit": "6410ea53df6618dbf040de6cb3f5fba4096de187", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2ODQxNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401968415", "bodyText": "Done. Android Studio does this already implicitly, but it still makes sense to do until GitHub catches up.", "author": "schmidt-sebastian", "createdAt": "2020-04-01T23:29:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1NzU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1ODUxNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401958515", "bodyText": "You could reduce the number of files that people need to read if you have\nValueProvider\nValueProvider::Deferred\nValueProvider::Existing\n\nIDR if that requires you to make an abstract class rather than an interface though.", "author": "inlined", "createdAt": "2020-04-01T22:58:57Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/DeferredValueProvider.java", "diffHunk": "@@ -0,0 +1,42 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.database.core;\n+\n+import com.google.firebase.database.snapshot.ChildKey;\n+import com.google.firebase.database.snapshot.Node;\n+import java.util.ArrayList;\n+\n+/** A DeferredValueProvider computes the value of a Node only when {@link #node()} is invoked. */\n+public class DeferredValueProvider implements ValueProvider {", "originalCommit": "6410ea53df6618dbf040de6cb3f5fba4096de187", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2OTA0MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401969040", "bodyText": "It does, but I think it is still a good idea - especially since these classes are so small.", "author": "schmidt-sebastian", "createdAt": "2020-04-01T23:31:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1ODUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk1OTUxMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401959511", "bodyText": "Oof... I hate files and classes called utilities", "author": "inlined", "createdAt": "2020-04-01T23:01:42Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/ServerValues.java", "diffHunk": "@@ -99,32 +100,29 @@ static Object resolveComplexDeferredValue(\n     return increment.doubleValue() + existingVal.doubleValue();\n   }\n \n-  public static SparseSnapshotTree resolveDeferredValueTree(\n-      SparseSnapshotTree tree, Node existing, final Map<String, Object> serverValues) {\n-    final SparseSnapshotTree resolvedTree = new SparseSnapshotTree();\n-    tree.forEachTree(\n-        new Path(\"\"),\n-        new SparseSnapshotTree.SparseSnapshotTreeVisitor() {\n-          @Override\n-          public void visitTree(Path prefixPath, Node tree) {\n-            resolvedTree.remember(\n-                prefixPath,\n-                resolveDeferredValueSnapshot(tree, existing.getChild(prefixPath), serverValues));\n-          }\n-        });\n-    return resolvedTree;\n+  public static Node resolveDeferredValueSnapshot(\n+      Node data, Node existing, final Map<String, Object> serverValues) {\n+    return resolveDeferredValueSnapshot(data, new ExistingValueProvider(existing), serverValues);\n   }\n \n   public static Node resolveDeferredValueSnapshot(\n-      Node data, Node existing, final Map<String, Object> serverValues) {\n-    Object priorityVal =\n-        resolveDeferredValue(data.getPriority().getValue(), existing.getPriority(), serverValues);\n-    Node priority = PriorityUtilities.parsePriority(priorityVal);\n+      Node data, SyncTree syncTree, Path path, final Map<String, Object> serverValues) {\n+    return resolveDeferredValueSnapshot(\n+        data, new DeferredValueProvider(syncTree, path), serverValues);\n+  }\n \n+  private static Node resolveDeferredValueSnapshot(\n+      Node data, ValueProvider existing, final Map<String, Object> serverValues) {\n+    Object rawPriority = data.getPriority().getValue();\n+    Object priority =\n+        resolveDeferredLeafValue(\n+            rawPriority,\n+            existing.getImmediateChild(ChildKey.fromString(\".priority\")),\n+            serverValues);\n     if (data.isLeafNode()) {\n-      Object value = resolveDeferredValue(data.getValue(), existing, serverValues);\n-      if (!value.equals(data.getValue()) || !priority.equals(data.getPriority())) {\n-        return NodeUtilities.NodeFromJSON(value, priority);\n+      Object value = resolveDeferredLeafValue(data.getValue(), existing, serverValues);\n+      if (!value.equals(data.getValue()) || !Utilities.equals(priority, rawPriority)) {", "originalCommit": "6410ea53df6618dbf040de6cb3f5fba4096de187", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDAzNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401960035", "bodyText": "Interesting. In iOS this starts as merge and is modified with addWrite only where the resolved value changes. Is this a pessimisation?", "author": "inlined", "createdAt": "2020-04-01T23:03:24Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/ServerValues.java", "diffHunk": "@@ -145,22 +143,22 @@ public void visitChild(ChildKey name, Node child) {\n             }\n           });\n       if (!holder.getRootNode().getPriority().equals(priority)) {\n-        return holder.getRootNode().updatePriority(priority);\n+        return holder.getRootNode().updatePriority(PriorityUtilities.parsePriority(priority));\n       } else {\n         return holder.getRootNode();\n       }\n     }\n   }\n \n   public static CompoundWrite resolveDeferredValueMerge(\n-      CompoundWrite merge, Node existing, final Map<String, Object> serverValues) {\n+      CompoundWrite merge, SyncTree syncTree, Path path, final Map<String, Object> serverValues) {\n     CompoundWrite write = CompoundWrite.emptyWrite();", "originalCommit": "6410ea53df6618dbf040de6cb3f5fba4096de187", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3NjQxMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401976410", "bodyText": "I tried to make it match iOS just now but it broke a bunch of tests.", "author": "schmidt-sebastian", "createdAt": "2020-04-01T23:54:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDAzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDI5NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401960295", "bodyText": "I think you can delete \"existing\" above.", "author": "inlined", "createdAt": "2020-04-01T23:04:04Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/SyncTree.java", "diffHunk": "@@ -249,12 +249,12 @@ public boolean isEmpty() {\n                 if (write.isOverwrite()) {\n                   Node resolvedNode =\n                       ServerValues.resolveDeferredValueSnapshot(\n-                          write.getOverwrite(), existing, serverValues);", "originalCommit": "6410ea53df6618dbf040de6cb3f5fba4096de187", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2OTM4Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1415#discussion_r401969387", "bodyText": "Good catch. This also removed:\nArrayList<Long> excludeThis = new ArrayList<>();\nexcludeThis.add(write.getWriteId());\ncalcCompleteEventCache(write.getPath(), excludeThis);\n\nThat's a bit suspicious, but this never existed on iOS.", "author": "schmidt-sebastian", "createdAt": "2020-04-01T23:32:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk2MDI5NQ=="}], "type": "inlineReview"}, {"oid": "2a37cb277287420ec2847f428fd18b3db1d40ac5", "url": "https://github.com/firebase/firebase-android-sdk/commit/2a37cb277287420ec2847f428fd18b3db1d40ac5", "message": "Review", "committedDate": "2020-04-01T23:56:23Z", "type": "commit"}]}