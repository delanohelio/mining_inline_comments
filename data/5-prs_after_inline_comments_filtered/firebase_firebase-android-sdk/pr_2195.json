{"pr_number": 2195, "pr_title": "Adding a FidListener that propagates fid changes to the clients.", "pr_createdAt": "2020-11-23T17:59:18Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2195", "timeline": [{"oid": "ada672b4f9268e6bec5bb91563dc5c76d48f33db", "url": "https://github.com/firebase/firebase-android-sdk/commit/ada672b4f9268e6bec5bb91563dc5c76d48f33db", "message": "Adding a FidListener that propagates fid changes to the clients.", "committedDate": "2020-11-23T17:57:25Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwMjM2NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r528902365", "bodyText": "Please add @DeferredApi annotation to this method. It's needed for proper dynamic module loading that is upcoming across Firebase SDKs.", "author": "vkryachko", "createdAt": "2020-11-23T18:12:08Z", "path": "firebase-installations-interop/src/main/java/com/google/firebase/installations/FirebaseInstallationsApi.java", "diffHunk": "@@ -51,4 +52,12 @@\n    */\n   @NonNull\n   Task<Void> delete();\n+\n+  /**\n+   * Register a listener to receive fid changes.\n+   *\n+   * @param listener implementation of the {@code FidListener} to handle fid changes.\n+   * @hide\n+   */\n+  void registerFidListener(FidListener listener);", "originalCommit": "ada672b4f9268e6bec5bb91563dc5c76d48f33db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwMjczOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r528902739", "bodyText": "Also, it might make sense to add a NonNull annotation onto the listener argument.", "author": "vkryachko", "createdAt": "2020-11-23T18:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwMjM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwMzM5MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r528903390", "bodyText": "It looks like this javadoc discourages use of this interface and then immediately suggests to use the same interface instead. Can you clarify the intent here?", "author": "vkryachko", "createdAt": "2020-11-23T18:14:04Z", "path": "firebase-installations-interop/src/main/java/com/google/firebase/installations/internal/FidListener.java", "diffHunk": "@@ -0,0 +1,35 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.internal;\n+\n+import androidx.annotation.NonNull;\n+\n+/**\n+ * <aside class=\"warning\"><strong>Provides an inter-operational interface only</strong>; instead,\n+ * use {@link FidListener} to call a listener when a Fid changes.</aside>", "originalCommit": "ada672b4f9268e6bec5bb91563dc5c76d48f33db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwNDIzMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r528904232", "bodyText": "Should it instead be?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void registerFidListener(@Nullable FidListener listener) {\n          \n          \n            \n              public void registerFidListener(@NonNull FidListener listener) {", "author": "vkryachko", "createdAt": "2020-11-23T18:15:29Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -271,6 +275,14 @@ String getName() {\n     return Tasks.call(backgroundExecutor, this::deleteFirebaseInstallationId);\n   }\n \n+  /** Register a callback {@link FidListener} to receive fid changes. */\n+  @Override\n+  public void registerFidListener(@Nullable FidListener listener) {", "originalCommit": "ada672b4f9268e6bec5bb91563dc5c76d48f33db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwNDcyMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r528904723", "bodyText": "it looks equivalent to just making the whole method saynchronized, please consider doing that.", "author": "vkryachko", "createdAt": "2020-11-23T18:16:24Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -271,6 +275,14 @@ String getName() {\n     return Tasks.call(backgroundExecutor, this::deleteFirebaseInstallationId);\n   }\n \n+  /** Register a callback {@link FidListener} to receive fid changes. */\n+  @Override\n+  public void registerFidListener(@Nullable FidListener listener) {\n+    synchronized (this) {", "originalCommit": "ada672b4f9268e6bec5bb91563dc5c76d48f33db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkwNTkxNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r528905915", "bodyText": "Looks like you're only supporting one listener at a time, I wonder if we want to allow multiple listeners, otherwise it may be surprising to clients that their listener is removed just because someone else registered a listener as well.", "author": "vkryachko", "createdAt": "2020-11-23T18:18:34Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -271,6 +275,14 @@ String getName() {\n     return Tasks.call(backgroundExecutor, this::deleteFirebaseInstallationId);\n   }\n \n+  /** Register a callback {@link FidListener} to receive fid changes. */\n+  @Override\n+  public void registerFidListener(@Nullable FidListener listener) {\n+    synchronized (this) {\n+      this.fidListener = listener;", "originalCommit": "ada672b4f9268e6bec5bb91563dc5c76d48f33db", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMDE0MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r528920140", "bodyText": "Should there be a way to \"unregister\" the listener? A common way to do it is to have the register method return a \"registration\" object, that has a remove() method.", "author": "vkryachko", "createdAt": "2020-11-23T18:44:09Z", "path": "firebase-installations-interop/src/main/java/com/google/firebase/installations/FirebaseInstallationsApi.java", "diffHunk": "@@ -51,4 +52,12 @@\n    */\n   @NonNull\n   Task<Void> delete();\n+\n+  /**\n+   * Register a listener to receive fid changes.", "originalCommit": "ada672b4f9268e6bec5bb91563dc5c76d48f33db", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDE1MTc5Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r530151792", "bodyText": "Done. PTAL if the changes look.", "author": "ankitaj224", "createdAt": "2020-11-25T07:17:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODkyMDE0MA=="}], "type": "inlineReview"}, {"oid": "f7fb021c84e5128b285f384a9cbad4259b067af2", "url": "https://github.com/firebase/firebase-android-sdk/commit/f7fb021c84e5128b285f384a9cbad4259b067af2", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into fisHook", "committedDate": "2020-11-23T19:00:36Z", "type": "commit"}, {"oid": "6c5a1eb98cc94551817de5bc033e58b70cf2cb44", "url": "https://github.com/firebase/firebase-android-sdk/commit/6c5a1eb98cc94551817de5bc033e58b70cf2cb44", "message": "Addressing vlad's comments.", "committedDate": "2020-11-25T07:00:17Z", "type": "commit"}, {"oid": "28e81abf0269d51f112efbcd65ec74737e1afb3a", "url": "https://github.com/firebase/firebase-android-sdk/commit/28e81abf0269d51f112efbcd65ec74737e1afb3a", "message": "Adding unregister method for listeners", "committedDate": "2020-11-25T07:16:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDM5OTUyNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r530399524", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public interface HandleFidListener {\n          \n          \n            \n            public interface FidListenerHandle {", "author": "vkryachko", "createdAt": "2020-11-25T14:08:18Z", "path": "firebase-installations-interop/src/main/java/com/google/firebase/installations/internal/HandleFidListener.java", "diffHunk": "@@ -0,0 +1,30 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.internal;\n+\n+/**\n+ * Interface for un-registering a previously registered listener.\n+ *\n+ * @hide\n+ */\n+public interface HandleFidListener {", "originalCommit": "28e81abf0269d51f112efbcd65ec74737e1afb3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwMTM4Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r530401386", "bodyText": "The handle is supposed to represent a registration so it shouldn't take a listener as a parameter. For an example see\n\n  \n    \n      firebase-android-sdk/firebase-firestore/src/main/java/com/google/firebase/firestore/ListenerRegistration.java\n    \n    \n        Lines 17 to 25\n      in\n      c7d3073\n    \n    \n    \n    \n\n        \n          \n           /** Represents a listener that can be removed by calling {@link #remove()}. */ \n        \n\n        \n          \n           public interface ListenerRegistration { \n        \n\n        \n          \n            \n        \n\n        \n          \n             /** \n        \n\n        \n          \n              * Removes the listener being tracked by this {@code ListenerRegistration}. After the initial \n        \n\n        \n          \n              * call, subsequent calls have no effect. \n        \n\n        \n          \n              */ \n        \n\n        \n          \n             void remove(); \n        \n\n        \n          \n           }", "author": "vkryachko", "createdAt": "2020-11-25T14:10:58Z", "path": "firebase-installations-interop/src/main/java/com/google/firebase/installations/internal/HandleFidListener.java", "diffHunk": "@@ -0,0 +1,30 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.internal;\n+\n+/**\n+ * Interface for un-registering a previously registered listener.\n+ *\n+ * @hide\n+ */\n+public interface HandleFidListener {\n+\n+  /**\n+   * Unregisters a previously registered {@link FidListener}.\n+   *\n+   * @hide\n+   */\n+  void unregister(FidListener fidListener);", "originalCommit": "28e81abf0269d51f112efbcd65ec74737e1afb3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMTAwNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r532801006", "bodyText": "PTAL. Thanks", "author": "ankitaj224", "createdAt": "2020-11-30T18:14:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwMTM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwMjk4OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r530402988", "bodyText": "While the registration is synchronized, the unregister is not, please consider something like\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  public void unregister(FidListener fidListener) {\n          \n          \n            \n                    if (fidListeners.contains(fidListener)) {\n          \n          \n            \n                      fidListeners.remove(fidListener);\n          \n          \n            \n                    }\n          \n          \n            \n                  }\n          \n          \n            \n                  public synchronized void unregister() {\n          \n          \n            \n                    fidListeners.remove(listener);\n          \n          \n            \n                  }", "author": "vkryachko", "createdAt": "2020-11-25T14:13:14Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -271,6 +278,21 @@ String getName() {\n     return Tasks.call(backgroundExecutor, this::deleteFirebaseInstallationId);\n   }\n \n+  /** Register a callback {@link FidListener} to receive fid changes. */\n+  @NonNull\n+  @Override\n+  public synchronized HandleFidListener registerFidListener(@NonNull FidListener listener) {\n+    this.fidListeners.add(listener);\n+    return new HandleFidListener() {\n+      @Override\n+      public void unregister(FidListener fidListener) {\n+        if (fidListeners.contains(fidListener)) {\n+          fidListeners.remove(fidListener);\n+        }\n+      }", "originalCommit": "28e81abf0269d51f112efbcd65ec74737e1afb3a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwNDUxNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r530404516", "bodyText": "Please consider adding a test for removing a registration as well.", "author": "vkryachko", "createdAt": "2020-11-25T14:15:32Z", "path": "firebase-installations/src/test/java/com/google/firebase/installations/FirebaseInstallationsTest.java", "diffHunk": "@@ -453,6 +454,40 @@ public void testReadToken_withJsonformatting() {\n     assertThat(iidStore.readToken(), equalTo(\"thetoken\"));\n   }\n \n+  @Test\n+  public void testFidListener_fidChanged_successful() throws Exception {\n+    when(mockIidStore.readIid()).thenReturn(null);\n+    when(mockIidStore.readToken()).thenReturn(null);\n+    when(mockBackend.createFirebaseInstallation(\n+            anyString(), anyString(), anyString(), anyString(), any()))\n+        .thenReturn(\n+            TEST_INSTALLATION_RESPONSE\n+                .toBuilder()\n+                .setUri(\"/projects/\" + TEST_PROJECT_ID + \"/installations/\" + TEST_FID_2)\n+                .setFid(TEST_FID_2)\n+                .build());\n+\n+    FakeFidListener fidListener = new FakeFidListener();\n+    // Register the FidListener\n+    firebaseInstallations.registerFidListener(fidListener);", "originalCommit": "28e81abf0269d51f112efbcd65ec74737e1afb3a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjgwMTQwOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r532801409", "bodyText": "Updated this test to check the removing registration code as well. PTAL. Thanks", "author": "ankitaj224", "createdAt": "2020-11-30T18:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQwNDUxNg=="}], "type": "inlineReview"}, {"oid": "7a83a77fbf29fdc4389fa8452f9d9c46f51cdd88", "url": "https://github.com/firebase/firebase-android-sdk/commit/7a83a77fbf29fdc4389fa8452f9d9c46f51cdd88", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into fisHook", "committedDate": "2020-11-30T17:47:45Z", "type": "commit"}, {"oid": "43ed01bcc2f89d00ed740541888e08d91196a618", "url": "https://github.com/firebase/firebase-android-sdk/commit/43ed01bcc2f89d00ed740541888e08d91196a618", "message": "Fixing the FidListenerHandle", "committedDate": "2020-11-30T17:57:22Z", "type": "commit"}, {"oid": "56c7b852c0cddd0a85c6374d09b6d60f5ca7d679", "url": "https://github.com/firebase/firebase-android-sdk/commit/56c7b852c0cddd0a85c6374d09b6d60f5ca7d679", "message": "Adding test to validate unregistering the listener", "committedDate": "2020-11-30T18:13:35Z", "type": "commit"}, {"oid": "c276010bf7e6a9f186b4eb30efc3b97b61b646bd", "url": "https://github.com/firebase/firebase-android-sdk/commit/c276010bf7e6a9f186b4eb30efc3b97b61b646bd", "message": "Fixing api.txt", "committedDate": "2020-11-30T19:30:35Z", "type": "commit"}, {"oid": "16cc4d1a7a51f472cdbd0a35b07eb3729058f627", "url": "https://github.com/firebase/firebase-android-sdk/commit/16cc4d1a7a51f472cdbd0a35b07eb3729058f627", "message": "Fixing gradle errors", "committedDate": "2020-11-30T23:10:35Z", "type": "commit"}, {"oid": "3d5b1120fdfae20fd2d98d2762e9544979fb5621", "url": "https://github.com/firebase/firebase-android-sdk/commit/3d5b1120fdfae20fd2d98d2762e9544979fb5621", "message": "Minor fix", "committedDate": "2020-11-30T23:37:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU2ODU5NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r533568594", "bodyText": "nit: consider removing the contains check as remove handles it internally.", "author": "vkryachko", "createdAt": "2020-12-01T16:55:00Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -278,16 +278,22 @@ String getName() {\n     return Tasks.call(backgroundExecutor, this::deleteFirebaseInstallationId);\n   }\n \n-  /** Register a callback {@link FidListener} to receive fid changes. */\n+  /**\n+   * Register a callback {@link FidListener} to receive fid changes.\n+   *\n+   * @hide\n+   */\n   @NonNull\n   @Override\n-  public synchronized HandleFidListener registerFidListener(@NonNull FidListener listener) {\n-    this.fidListeners.add(listener);\n-    return new HandleFidListener() {\n+  public synchronized FidListenerHandle registerFidListener(@NonNull FidListener listener) {\n+    fidListeners.add(listener);\n+    return new FidListenerHandle() {\n       @Override\n-      public void unregister(FidListener fidListener) {\n-        if (fidListeners.contains(fidListener)) {\n-          fidListeners.remove(fidListener);\n+      public void unregister() {\n+        synchronized (FirebaseInstallations.this) {\n+          if (fidListeners.contains(listener)) {", "originalCommit": "3d5b1120fdfae20fd2d98d2762e9544979fb5621", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzc1Njg1NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2195#discussion_r533756854", "bodyText": "Thanks. Done", "author": "ankitaj224", "createdAt": "2020-12-01T22:14:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU2ODU5NA=="}], "type": "inlineReview"}, {"oid": "0e45a1000e2679b3e49725b778208c5a2c03c56a", "url": "https://github.com/firebase/firebase-android-sdk/commit/0e45a1000e2679b3e49725b778208c5a2c03c56a", "message": "Fixing minor nit", "committedDate": "2020-12-01T22:13:32Z", "type": "commit"}, {"oid": "78d2468a7010426bb5290ac054b1b5a318ead3cc", "url": "https://github.com/firebase/firebase-android-sdk/commit/78d2468a7010426bb5290ac054b1b5a318ead3cc", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into fisHook", "committedDate": "2020-12-01T22:14:00Z", "type": "commit"}]}