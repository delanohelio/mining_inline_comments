{"pr_number": 1570, "pr_title": "Completing getId call with the disk reads on the caller thread.  ", "pr_createdAt": "2020-05-18T20:18:57Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1570", "timeline": [{"oid": "4283a2bb3b4434510e061a0d9c4b080595658c2a", "url": "https://github.com/firebase/firebase-android-sdk/commit/4283a2bb3b4434510e061a0d9c4b080595658c2a", "message": "Dropping guava and appcompat dependency from FIS SDK.", "committedDate": "2020-02-06T17:59:09Z", "type": "commit"}, {"oid": "984884cd6f9a90a8172d0957bd13e68e3f06db2f", "url": "https://github.com/firebase/firebase-android-sdk/commit/984884cd6f9a90a8172d0957bd13e68e3f06db2f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-06T18:16:08Z", "type": "commit"}, {"oid": "a82387701d2549bb5fc3b5dc2530a83ed0680d02", "url": "https://github.com/firebase/firebase-android-sdk/commit/a82387701d2549bb5fc3b5dc2530a83ed0680d02", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-11T18:58:16Z", "type": "commit"}, {"oid": "afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "url": "https://github.com/firebase/firebase-android-sdk/commit/afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-13T23:37:48Z", "type": "commit"}, {"oid": "5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "url": "https://github.com/firebase/firebase-android-sdk/commit/5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-05T16:49:33Z", "type": "commit"}, {"oid": "a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "url": "https://github.com/firebase/firebase-android-sdk/commit/a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-09T16:31:08Z", "type": "commit"}, {"oid": "45312e68fe8516dc4d48a2bfdb422f5023c1241b", "url": "https://github.com/firebase/firebase-android-sdk/commit/45312e68fe8516dc4d48a2bfdb422f5023c1241b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T18:13:59Z", "type": "commit"}, {"oid": "f0be4fa07222c687044f66d8cb2859e156611896", "url": "https://github.com/firebase/firebase-android-sdk/commit/f0be4fa07222c687044f66d8cb2859e156611896", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-10T21:55:48Z", "type": "commit"}, {"oid": "ac0397ba816265b24da3eca4645761a37d4b46b6", "url": "https://github.com/firebase/firebase-android-sdk/commit/ac0397ba816265b24da3eca4645761a37d4b46b6", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-11T18:14:18Z", "type": "commit"}, {"oid": "8f6b46e3346cad5d3a4128ad1316e9e0831c0a2b", "url": "https://github.com/firebase/firebase-android-sdk/commit/8f6b46e3346cad5d3a4128ad1316e9e0831c0a2b", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-12T19:40:52Z", "type": "commit"}, {"oid": "686a998ab40a6c855d81b30f7686ef20aef1713c", "url": "https://github.com/firebase/firebase-android-sdk/commit/686a998ab40a6c855d81b30f7686ef20aef1713c", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-16T17:31:01Z", "type": "commit"}, {"oid": "3bf7c24892fc6d66b4b33cb943ac2fe9e3e11598", "url": "https://github.com/firebase/firebase-android-sdk/commit/3bf7c24892fc6d66b4b33cb943ac2fe9e3e11598", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-18T21:05:27Z", "type": "commit"}, {"oid": "07ff7ddc966270c28df8d123ef95e63a9f058494", "url": "https://github.com/firebase/firebase-android-sdk/commit/07ff7ddc966270c28df8d123ef95e63a9f058494", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-30T21:58:00Z", "type": "commit"}, {"oid": "f982f2d752d3567a1164b6f3bb00a1dfc601ab91", "url": "https://github.com/firebase/firebase-android-sdk/commit/f982f2d752d3567a1164b6f3bb00a1dfc601ab91", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-31T22:05:19Z", "type": "commit"}, {"oid": "672526aca799c55e7f83aaa0f08c7e698be388ed", "url": "https://github.com/firebase/firebase-android-sdk/commit/672526aca799c55e7f83aaa0f08c7e698be388ed", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-05T05:34:09Z", "type": "commit"}, {"oid": "1adf4a2621f9367521f806ea893770921713e49f", "url": "https://github.com/firebase/firebase-android-sdk/commit/1adf4a2621f9367521f806ea893770921713e49f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-07T20:56:39Z", "type": "commit"}, {"oid": "4435ed00d6c6d59ae1dd2442e034c75873bf8ed8", "url": "https://github.com/firebase/firebase-android-sdk/commit/4435ed00d6c6d59ae1dd2442e034c75873bf8ed8", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-10T21:22:37Z", "type": "commit"}, {"oid": "99f1f827dac599f04bd69eea5a49c1596eadf49a", "url": "https://github.com/firebase/firebase-android-sdk/commit/99f1f827dac599f04bd69eea5a49c1596eadf49a", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-04-13T22:51:18Z", "type": "commit"}, {"oid": "08d91f888d6ce2f18b5fdf6ef20936c9bc7974c2", "url": "https://github.com/firebase/firebase-android-sdk/commit/08d91f888d6ce2f18b5fdf6ef20936c9bc7974c2", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-01T16:39:27Z", "type": "commit"}, {"oid": "747598f42b4fc9fa882b8feb3e8c8d1b652739ec", "url": "https://github.com/firebase/firebase-android-sdk/commit/747598f42b4fc9fa882b8feb3e8c8d1b652739ec", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-01T18:36:33Z", "type": "commit"}, {"oid": "28cc955fd37c7127dd30ccdcee326328e32b499d", "url": "https://github.com/firebase/firebase-android-sdk/commit/28cc955fd37c7127dd30ccdcee326328e32b499d", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-05T22:00:57Z", "type": "commit"}, {"oid": "519ae71d474bab8a8483f2b5269d53f1536e107d", "url": "https://github.com/firebase/firebase-android-sdk/commit/519ae71d474bab8a8483f2b5269d53f1536e107d", "message": "Fix OverlappingFileLockException.\n\nAccess the data shared by multiple threads only after acquiring cross-process and multi-thread safe locks.", "committedDate": "2020-05-08T17:37:48Z", "type": "commit"}, {"oid": "98e0e25dfa3de3310fd68207622af5d02e1a4f1d", "url": "https://github.com/firebase/firebase-android-sdk/commit/98e0e25dfa3de3310fd68207622af5d02e1a4f1d", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-08T17:38:10Z", "type": "commit"}, {"oid": "cba321b43380cb858bc362889c9a75b088763238", "url": "https://github.com/firebase/firebase-android-sdk/commit/cba321b43380cb858bc362889c9a75b088763238", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-08T22:18:10Z", "type": "commit"}, {"oid": "28598b0c6d552f653e4d55cc181a1df960552814", "url": "https://github.com/firebase/firebase-android-sdk/commit/28598b0c6d552f653e4d55cc181a1df960552814", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-12T22:29:04Z", "type": "commit"}, {"oid": "9519e70f23f1d3e80515b1af8c3ffc8076dcf0ba", "url": "https://github.com/firebase/firebase-android-sdk/commit/9519e70f23f1d3e80515b1af8c3ffc8076dcf0ba", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-05-18T16:54:47Z", "type": "commit"}, {"oid": "f0ff2995443d4fbcb59155a989622b0ae4df19c3", "url": "https://github.com/firebase/firebase-android-sdk/commit/f0ff2995443d4fbcb59155a989622b0ae4df19c3", "message": "Completing getId call with the disk reads on the caller thread.\n\nAlso, fixing delete API to access persisted FID using cross process\nsafe locks.", "committedDate": "2020-05-18T20:16:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NjQ4NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426886485", "bodyText": "This will create a new fid and delete it. I think it is better the way it was.", "author": "fredquintana", "createdAt": "2020-05-18T20:51:22Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -520,7 +509,7 @@ private PersistedInstallationEntry fetchAuthTokenFromServer(\n    * storage.\n    */\n   private Void deleteFirebaseInstallationId() throws FirebaseInstallationsException, IOException {\n-    PersistedInstallationEntry entry = persistedInstallation.readPersistedInstallationEntryValue();\n+    PersistedInstallationEntry entry = getPrefsWithGeneratedIdMultiProcessSafe();", "originalCommit": "f0ff2995443d4fbcb59155a989622b0ae4df19c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg5MTkwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426891902", "bodyText": "Reason for this: If there is one thread that is triggering getId or getToken and another triggering delete. If the delete read is not multi-process safe, and tries to read the same data locked by other thread acquiring CrossProcessLock - could lead to OverLappingFileLockException", "author": "ankitaj224", "createdAt": "2020-05-18T21:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NjQ4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNjUzNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426906535", "bodyText": "As discussed offline: created and used cross-process safe read prefs method.", "author": "ankitaj224", "createdAt": "2020-05-18T21:36:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4NjQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4Nzc3Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426887777", "bodyText": "I see that you want to emulate the old behavior of this being serialized on a sinle thread, but I don't know of adding an additional synchronization block is the right way to go.\nFor one thing, it isn't multi-process safe.", "author": "fredquintana", "createdAt": "2020-05-18T20:54:19Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -213,9 +217,11 @@ String getName() {\n   @Override\n   public Task<String> getId() {\n     preConditionChecks();\n-    Task<String> task = addGetIdListener();\n-    backgroundExecutor.execute(this::doGetId);\n-    return task;\n+    synchronized (lockGetFid) {", "originalCommit": "f0ff2995443d4fbcb59155a989622b0ae4df19c3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4OTE5NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426889195", "bodyText": "Actually, everything doGetId() does it already thread and process safe, so this doesn't need its own protection, does it?", "author": "fredquintana", "createdAt": "2020-05-18T20:57:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4Nzc3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwODI2Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426908267", "bodyText": "I missed that local variables are thread safe. PTAL", "author": "ankitaj224", "createdAt": "2020-05-18T21:40:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjg4Nzc3Nw=="}], "type": "inlineReview"}, {"oid": "bc6ec5ce66a52d1bcd7360334dd2a586616646f9", "url": "https://github.com/firebase/firebase-android-sdk/commit/bc6ec5ce66a52d1bcd7360334dd2a586616646f9", "message": "Addressing Fred's comments", "committedDate": "2020-05-18T21:35:48Z", "type": "commit"}, {"oid": "b26d198e8e48584f9bfd05cb95a9e58e7d59f137", "url": "https://github.com/firebase/firebase-android-sdk/commit/b26d198e8e48584f9bfd05cb95a9e58e7d59f137", "message": "Remove unused variable", "committedDate": "2020-05-18T21:41:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk5Mzk1Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426993956", "bodyText": "How about this comment:\n/** Thread level synchronization for reading FID from disk. */", "author": "andirayo", "createdAt": "2020-05-19T02:28:14Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -73,6 +73,10 @@\n \n   /* used for thread-level synchronization of generating and persisting fids */\n   private static final Object lockGenerateFid = new Object();\n+\n+  /* used for thread-level synchronization of getting a fid. */", "originalCommit": "f0ff2995443d4fbcb59155a989622b0ae4df19c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk5NzM2Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426997362", "bodyText": "If we do the cachedFid solution, then it has to happen outside of the synchronized block of course.\nThe setting of cachedFid could happen anywhere where you think it makes sense.\nif (null != cachedFid) {\n  return cachedFid\n}\nsynchronized (...)", "author": "andirayo", "createdAt": "2020-05-19T02:40:36Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -213,9 +217,11 @@ String getName() {\n   @Override\n   public Task<String> getId() {\n     preConditionChecks();\n-    Task<String> task = addGetIdListener();\n-    backgroundExecutor.execute(this::doGetId);\n-    return task;\n+    synchronized (lockGetFid) {\n+      TaskCompletionSource<String> taskCompletionSource = new TaskCompletionSource<>();\n+      taskCompletionSource.trySetResult(doGetId());\n+      return taskCompletionSource.getTask();\n+    }", "originalCommit": "f0ff2995443d4fbcb59155a989622b0ae4df19c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk5ODc2OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1570#discussion_r426998769", "bodyText": "This method name is misleading.\nHow about #doNetworkCallIfNecessary?", "author": "andirayo", "createdAt": "2020-05-19T02:46:17Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/FirebaseInstallations.java", "diffHunk": "@@ -295,16 +288,12 @@ private void triggerOnException(PersistedInstallationEntry prefs, Exception exce\n     }\n   }\n \n-  private final void doGetId() {\n-    doRegistrationInternal(false);\n-  }\n-\n-  private final void doGetAuthTokenWithoutForceRefresh() {\n-    doRegistrationInternal(false);\n-  }\n-\n-  private final void doGetAuthTokenForceRefresh() {\n-    doRegistrationInternal(true);\n+  private String doGetId() {\n+    PersistedInstallationEntry prefs = getPrefsWithGeneratedIdMultiProcessSafe();\n+    // Execute network calls (CreateInstallations) to the FIS Servers on a separate executor\n+    // i.e networkExecutor\n+    networkExecutor.execute(() -> doNetworkCall(false));", "originalCommit": "f0ff2995443d4fbcb59155a989622b0ae4df19c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0bb76d35e240ac95a20b2c9aeaf0947387f60c36", "url": "https://github.com/firebase/firebase-android-sdk/commit/0bb76d35e240ac95a20b2c9aeaf0947387f60c36", "message": "Cache FID to avoid multiple disk reads. (#1571)\n\n* Cache FID to avoid multiple disk reads.\r\n\r\n* Addressing Rayo's comments.", "committedDate": "2020-05-20T16:49:53Z", "type": "commit"}, {"oid": "9214f9eeb0ebfbf96fcb1f5dcac8997521ec58cb", "url": "https://github.com/firebase/firebase-android-sdk/commit/9214f9eeb0ebfbf96fcb1f5dcac8997521ec58cb", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into blockID", "committedDate": "2020-05-20T16:53:02Z", "type": "commit"}, {"oid": "a5f655867108138f76e470a1100b63b6bf3821e8", "url": "https://github.com/firebase/firebase-android-sdk/commit/a5f655867108138f76e470a1100b63b6bf3821e8", "message": "Addressing Rayo's comments", "committedDate": "2020-05-20T16:57:34Z", "type": "commit"}]}