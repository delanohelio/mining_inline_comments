{"pr_number": 1424, "pr_title": "Firebase Data Collection:- Add tri states to the data collection api", "pr_createdAt": "2020-04-03T18:57:31Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1424", "timeline": [{"oid": "78c6d8908e3ae2bdfc4a1ebdadfb764bac4bf6ac", "url": "https://github.com/firebase/firebase-android-sdk/commit/78c6d8908e3ae2bdfc4a1ebdadfb764bac4bf6ac", "message": "add tri state to common data collection flag", "committedDate": "2020-04-03T18:56:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI0NzgxNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403247816", "bodyText": "I am pretty sure this is a breaking change for old SDKs that call this method.", "author": "vkryachko", "createdAt": "2020-04-03T18:59:36Z", "path": "firebase-common/src/main/java/com/google/firebase/FirebaseApp.java", "diffHunk": "@@ -370,7 +370,7 @@ public void setAutomaticResourceManagementEnabled(boolean enabled) {\n    * @hide\n    */\n   @KeepForSdk\n-  public boolean isDataCollectionDefaultEnabled() {\n+  public Boolean isDataCollectionDefaultEnabled() {", "originalCommit": "78c6d8908e3ae2bdfc4a1ebdadfb764bac4bf6ac", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI1MDI3NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403250275", "bodyText": "hmm i thought none of the sdks used it so far?", "author": "VinayGuthal", "createdAt": "2020-04-03T19:02:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI0NzgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzI0ODk1NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403248955", "bodyText": "Why is it no longer atomic? do we not care about concurrency anymore?", "author": "vkryachko", "createdAt": "2020-04-03T19:00:57Z", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -37,7 +36,7 @@\n   private final Context applicationContext;\n   private final SharedPreferences sharedPreferences;\n   private final Publisher publisher;\n-  private final AtomicBoolean dataCollectionDefaultEnabled;\n+  private Boolean dataCollectionDefaultEnabled;", "originalCommit": "78c6d8908e3ae2bdfc4a1ebdadfb764bac4bf6ac", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf", "url": "https://github.com/firebase/firebase-android-sdk/commit/5ec51b4cf810da872976c1ff7fde268fcbf47fbf", "message": "address comments", "committedDate": "2020-04-03T19:28:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3ODY5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403378699", "bodyText": "Can be extracted into a function?", "author": "ashwinraghav", "createdAt": "2020-04-03T23:12:42Z", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);\n+      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, apiSetting).apply();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!apiSetting, apiSetting)) {", "originalCommit": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MTE4Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403381182", "bodyText": "The publisher part?", "author": "VinayGuthal", "createdAt": "2020-04-03T23:22:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3ODY5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403379683", "bodyText": "Should this also live inside the synchronized block?", "author": "ashwinraghav", "createdAt": "2020-04-03T23:16:44Z", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();", "originalCommit": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MDk5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403380999", "bodyText": "I think shared preferences itself makes sure that it's synchornized", "author": "VinayGuthal", "createdAt": "2020-04-03T23:21:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MDI2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404280268", "bodyText": "Sure, you may however run into a situation where one thread sets the shared prefs value and another one broadcasts the message. So they need to be synchronized around the same mutex", "author": "ashwinraghav", "createdAt": "2020-04-06T17:53:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwMzkwMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404303903", "bodyText": "I dont think a synchronized block is needed in this case. Since the method is doing only one write and no read from the shared prefs. And since readManifestDataCollectionEnabled always returns the same value based on the manifest file", "author": "VinayGuthal", "createdAt": "2020-04-06T18:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwODQ4OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404308489", "bodyText": "You do need to synchronize here, before your change synchronization was happening with the atomic bool, but since you are checking for null now, a bunch of races become possible, i.e. concurrent threads can enter different branches of this if block and cause mess up the resulting state.", "author": "vkryachko", "createdAt": "2020-04-06T18:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMwOTE5NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404309195", "bodyText": "actually nvm the setEnabled method should be in a sync block..\nsetEnabled(true) -> Thread1\nsetEnabled(false) -> Thread2\nThis might result in the shared preferences having the value of false but the dataCollection having the value of True based on the order of execution", "author": "VinayGuthal", "createdAt": "2020-04-06T18:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTY4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403379764", "bodyText": "Synchronized block?", "author": "ashwinraghav", "createdAt": "2020-04-03T23:17:04Z", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +61,28 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n-    if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {\n-      sharedPreferences.edit().putBoolean(DATA_COLLECTION_DEFAULT_ENABLED, enabled).apply();\n-\n-      publisher.publish(\n-          new Event<>(DataCollectionDefaultChange.class, new DataCollectionDefaultChange(enabled)));\n+  public void setEnabled(Boolean enabled) {\n+    if (enabled == null) {\n+      sharedPreferences.edit().remove(DATA_COLLECTION_DEFAULT_ENABLED).apply();\n+      boolean manifestSetting = readManifestDataCollectionEnabled();\n+      if (dataCollectionDefaultEnabled.compareAndSet(!manifestSetting, manifestSetting)) {\n+        publisher.publish(\n+            new Event<>(\n+                DataCollectionDefaultChange.class,\n+                new DataCollectionDefaultChange(manifestSetting)));\n+      }\n+    } else {\n+      boolean apiSetting = Boolean.TRUE.equals(enabled);", "originalCommit": "5ec51b4cf810da872976c1ff7fde268fcbf47fbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MTEwNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r403381104", "bodyText": "I think shared preferences itself makes sure that it's synchornized", "author": "VinayGuthal", "createdAt": "2020-04-03T23:22:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI4MTI1NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404281255", "bodyText": "I mean Lines 69-73 and lines 77-82 seem extractable into a reusable function", "author": "ashwinraghav", "createdAt": "2020-04-06T17:55:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI5Mzc5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r404293799", "bodyText": "yeah makes sense i will do that", "author": "VinayGuthal", "createdAt": "2020-04-06T18:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3OTc2NA=="}], "type": "inlineReview"}, {"oid": "15fedcb316f5125d0b584db6d8c168e3e74b558b", "url": "https://github.com/firebase/firebase-android-sdk/commit/15fedcb316f5125d0b584db6d8c168e3e74b558b", "message": "fix storage", "committedDate": "2020-04-06T18:58:05Z", "type": "commit"}, {"oid": "408a796b4a48ba79fd25328bcbf8d8209f6ecfa4", "url": "https://github.com/firebase/firebase-android-sdk/commit/408a796b4a48ba79fd25328bcbf8d8209f6ecfa4", "message": "Fix tests", "committedDate": "2020-04-06T19:01:13Z", "type": "commit"}, {"oid": "5f41b7a10ca1c4c55d2aaa3ecc8fcb516a63c699", "url": "https://github.com/firebase/firebase-android-sdk/commit/5f41b7a10ca1c4c55d2aaa3ecc8fcb516a63c699", "message": "fix tests", "committedDate": "2020-04-06T20:17:10Z", "type": "commit"}, {"oid": "415d87764b8d9f6201f2c505744481e6d6964c4f", "url": "https://github.com/firebase/firebase-android-sdk/commit/415d87764b8d9f6201f2c505744481e6d6964c4f", "message": "add direct boot tests", "committedDate": "2020-04-06T21:20:57Z", "type": "commit"}, {"oid": "1aab4f835a51c6c92f0a94fb4fad3b77d2161b31", "url": "https://github.com/firebase/firebase-android-sdk/commit/1aab4f835a51c6c92f0a94fb4fad3b77d2161b31", "message": "add tests", "committedDate": "2020-04-06T21:31:09Z", "type": "commit"}, {"oid": "ace69a131e7c3cbef0188ff6ee3f0c60882a9a0d", "url": "https://github.com/firebase/firebase-android-sdk/commit/ace69a131e7c3cbef0188ff6ee3f0c60882a9a0d", "message": "format fix", "committedDate": "2020-04-06T21:34:31Z", "type": "commit"}, {"oid": "f97d6ee4c441a1e4973805d7735079505d586b39", "url": "https://github.com/firebase/firebase-android-sdk/commit/f97d6ee4c441a1e4973805d7735079505d586b39", "message": "Merge branch 'master' into global_collection_change", "committedDate": "2020-04-07T16:10:51Z", "type": "commit"}, {"oid": "aa6bb6f446366be05e6e2ca41a757e214ac47868", "url": "https://github.com/firebase/firebase-android-sdk/commit/aa6bb6f446366be05e6e2ca41a757e214ac47868", "message": "use config 19", "committedDate": "2020-04-07T16:40:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMjgwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405002807", "bodyText": "You may want to rename this to deviceProtectedContext since you changed the logic inside", "author": "vkryachko", "createdAt": "2020-04-07T17:54:50Z", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -43,15 +43,14 @@ public DataCollectionConfigStorage(\n       Context applicationContext, String persistenceKey, Publisher publisher) {\n     this.applicationContext = directBootSafe(applicationContext);\n     this.sharedPreferences =\n-        applicationContext.getSharedPreferences(\n+        this.applicationContext.getSharedPreferences(\n             FIREBASE_APP_PREFS + persistenceKey, Context.MODE_PRIVATE);\n     this.publisher = publisher;\n     this.dataCollectionDefaultEnabled = new AtomicBoolean(readAutoDataCollectionEnabled());\n   }\n \n   private static Context directBootSafe(Context applicationContext) {", "originalCommit": "aa6bb6f446366be05e6e2ca41a757e214ac47868", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYyMTQ4MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405621481", "bodyText": "Actually I think this method is even redundant and you can just use ContextCompat.createDeviceProtectedStorageContext() directly as it does the same version check.", "author": "vkryachko", "createdAt": "2020-04-08T15:40:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMjgwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMzQ0NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405003445", "bodyText": "Since the method is now synchronized there is no point for the bool to be atomic. Also very important to make isEnabled() synchronized as well.", "author": "vkryachko", "createdAt": "2020-04-07T17:55:52Z", "path": "firebase-common/src/main/java/com/google/firebase/internal/DataCollectionConfigStorage.java", "diffHunk": "@@ -61,19 +60,26 @@ public boolean isEnabled() {\n     return dataCollectionDefaultEnabled.get();\n   }\n \n-  public void setEnabled(boolean enabled) {\n+  private synchronized void updateDataCollectionDefaultEnabled(boolean enabled) {\n     if (dataCollectionDefaultEnabled.compareAndSet(!enabled, enabled)) {", "originalCommit": "aa6bb6f446366be05e6e2ca41a757e214ac47868", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "dbec42493afc3168c83b530f67d09b19286584a7", "url": "https://github.com/firebase/firebase-android-sdk/commit/dbec42493afc3168c83b530f67d09b19286584a7", "message": "Fix tests", "committedDate": "2020-04-07T18:46:22Z", "type": "commit"}, {"oid": "c8287d48663a19d31f63fb01f323031f52c834a6", "url": "https://github.com/firebase/firebase-android-sdk/commit/c8287d48663a19d31f63fb01f323031f52c834a6", "message": "fix tests", "committedDate": "2020-04-07T18:51:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMzgwNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405103805", "bodyText": "How does this test work if it's using user credential encrypted context?(i.e. not the direct boot one?)", "author": "vkryachko", "createdAt": "2020-04-07T20:49:40Z", "path": "firebase-common/data-collection-tests/src/test/java/com/google/firebase/DataCollectionTestUtil.java", "diffHunk": "@@ -52,10 +52,17 @@ static SharedPreferences getSharedPreferences() {\n             Context.MODE_PRIVATE);", "originalCommit": "c8287d48663a19d31f63fb01f323031f52c834a6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwNDUwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r405104502", "bodyText": "Its because of the config sdk=19", "author": "VinayGuthal", "createdAt": "2020-04-07T20:50:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTEwMzgwNQ=="}], "type": "inlineReview"}, {"oid": "8ac5f799caca9a44c064d3daad5cfb57e3f7bf44", "url": "https://github.com/firebase/firebase-android-sdk/commit/8ac5f799caca9a44c064d3daad5cfb57e3f7bf44", "message": "Fix tests", "committedDate": "2020-04-08T22:03:02Z", "type": "commit"}, {"oid": "8e5dcb9e759fadbd740c57c1d523fb5f52a8d0f7", "url": "https://github.com/firebase/firebase-android-sdk/commit/8e5dcb9e759fadbd740c57c1d523fb5f52a8d0f7", "message": "remove crash tests", "committedDate": "2020-04-08T22:47:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2NDE3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1424#discussion_r406264174", "bodyText": "pls revert this change, lgtm otherwise", "author": "vkryachko", "createdAt": "2020-04-09T14:53:50Z", "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/internal/common/CrashlyticsControllerTest.java", "diffHunk": "@@ -842,9 +842,8 @@ public void testUploadDisabledThenEnabled() throws Exception {\n     Task<Void> task = controller.submitAllReports(1.0f, testSettingsDataProvider.getAppSettings());\n \n     arbiter.setCrashlyticsDataCollectionEnabled(true);\n-\n+    \n     await(task);\n-", "originalCommit": "8e5dcb9e759fadbd740c57c1d523fb5f52a8d0f7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4cfc6a06ffabcce6ab22b8d48d31aa43033ec79", "url": "https://github.com/firebase/firebase-android-sdk/commit/c4cfc6a06ffabcce6ab22b8d48d31aa43033ec79", "message": "remove crash", "committedDate": "2020-04-09T15:50:24Z", "type": "commit"}]}