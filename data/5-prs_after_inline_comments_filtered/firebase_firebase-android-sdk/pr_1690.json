{"pr_number": 1690, "pr_title": "Unified emulator settings for Firestore", "pr_createdAt": "2020-06-19T17:00:46Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1690", "timeline": [{"oid": "c621f5b9a8bf842ca0ea77b4433e86f5c6c7f695", "url": "https://github.com/firebase/firebase-android-sdk/commit/c621f5b9a8bf842ca0ea77b4433e86f5c6c7f695", "message": "Unified emulator settings for Firestore", "committedDate": "2020-06-19T16:58:16Z", "type": "commit"}, {"oid": "b307898d05e74248adb49c40ae4311d4890a2f3c", "url": "https://github.com/firebase/firebase-android-sdk/commit/b307898d05e74248adb49c40ae4311d4890a2f3c", "message": "Merge branch 'master' into ss-firestore-emulator-settings", "committedDate": "2020-06-19T19:41:13Z", "type": "commit"}, {"oid": "1a151bb78b23203c3345bd09c31d49c2ff968041", "url": "https://github.com/firebase/firebase-android-sdk/commit/1a151bb78b23203c3345bd09c31d49c2ff968041", "message": "Hide new constants", "committedDate": "2020-06-19T19:49:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU4NTY0OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r443585648", "bodyText": "How about deprecating FirebaseFirestoreSettings.setHost() in favor of  EmulatedServiceSettings? Does it have any other use case other than pointing firestore to use the emulator as host?", "author": "rosariopfernandes", "createdAt": "2020-06-22T14:10:00Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -215,6 +239,23 @@ private void ensureClientConfigured() {\n     }\n   }\n \n+  private FirebaseFirestoreSettings mergeEmulatorSettings(\n+      @NonNull FirebaseFirestoreSettings settings,\n+      @NonNull EmulatedServiceSettings emulatorSettings) {\n+\n+    if (!FirebaseFirestoreSettings.DEFAULT_HOST.equals(settings.getHost())) {\n+      throw new IllegalStateException(\n+          \"Cannot change the Firestore host through FirebaseFirestoreSettings when \"\n+              + \"EmulatedServiceSettings are also in effect. \"\n+              + \"Make sure to only set the host in one location.\");\n+    }", "originalCommit": "1a151bb78b23203c3345bd09c31d49c2ff968041", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzYwMDg3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r443600874", "bodyText": "Yeah it's heavily used by the Firestore team themselves for testing against development/staging backends.", "author": "samtstern", "createdAt": "2020-06-22T14:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU4NTY0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzY2MTM4OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r443661388", "bodyText": "@samtstern oh, ok. I understand.", "author": "thatfiredev", "createdAt": "2020-06-22T15:54:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzU4NTY0OA=="}], "type": "inlineReview"}, {"oid": "f9ff9d6cfebe3de8674688639004811662525d0e", "url": "https://github.com/firebase/firebase-android-sdk/commit/f9ff9d6cfebe3de8674688639004811662525d0e", "message": "Merge remote-tracking branch 'origin/master' into ss-firestore-emulator-settings", "committedDate": "2020-06-22T16:46:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5NDU4Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r444394582", "bodyText": "This merge needs to happen before line 209, otherwise the \"equals\" check will fail even if the user calls this method with the same settings.\nAlso nit: Drop \"this\"", "author": "schmidt-sebastian", "createdAt": "2020-06-23T17:37:22Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -193,6 +212,11 @@ public void setFirestoreSettings(@NonNull FirebaseFirestoreSettings settings) {\n                 + \"You can only call setFirestoreSettings() before calling any other methods on a \"\n                 + \"FirebaseFirestore object.\");\n       }\n+\n+      if (this.emulatorSettings != null) {", "originalCommit": "f9ff9d6cfebe3de8674688639004811662525d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5NTM0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r444395344", "bodyText": "Could mergeEmulatorSettings take a Nullable emulatorSettings? That would remove the if check here and once more below.", "author": "schmidt-sebastian", "createdAt": "2020-06-23T17:38:45Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -168,8 +183,12 @@ static FirebaseFirestore newInstance(\n     this.firebaseApp = firebaseApp;\n     this.instanceRegistry = instanceRegistry;\n     this.metadataProvider = metadataProvider;\n+    this.emulatorSettings = emulatorSettings;\n \n-    settings = new FirebaseFirestoreSettings.Builder().build();\n+    this.settings = new FirebaseFirestoreSettings.Builder().build();\n+    if (this.emulatorSettings != null) {\n+      this.settings = mergeEmulatorSettings(settings, emulatorSettings);", "originalCommit": "f9ff9d6cfebe3de8674688639004811662525d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDM5Nzg2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r444397864", "bodyText": "What about:\n\"Cannot specify the host in FirebaseFirestoreSettings when EmulatedServiceSettings is provided.\"\nIt conveys the same information ... in shorter.", "author": "schmidt-sebastian", "createdAt": "2020-06-23T17:42:15Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -215,6 +239,23 @@ private void ensureClientConfigured() {\n     }\n   }\n \n+  private FirebaseFirestoreSettings mergeEmulatorSettings(\n+      @NonNull FirebaseFirestoreSettings settings,\n+      @NonNull EmulatedServiceSettings emulatorSettings) {\n+\n+    if (!FirebaseFirestoreSettings.DEFAULT_HOST.equals(settings.getHost())) {\n+      throw new IllegalStateException(\n+          \"Cannot change the Firestore host through FirebaseFirestoreSettings when \"", "originalCommit": "f9ff9d6cfebe3de8674688639004811662525d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwMDQxMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r444400411", "bodyText": "We don't use this pattern in our SDK codebase. Instead, we verify the text of each exception to make sure that we throw readable errors.", "author": "schmidt-sebastian", "createdAt": "2020-06-23T17:46:11Z", "path": "firebase-firestore/src/test/java/com/google/firebase/firestore/FirebaseFirestoreTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.firestore;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+\n+import androidx.annotation.NonNull;\n+import androidx.test.platform.app.InstrumentationRegistry;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.emulators.EmulatedServiceSettings;\n+import com.google.firebase.emulators.EmulatorSettings;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(manifest = Config.NONE)\n+public class FirebaseFirestoreTest {\n+\n+  @Test\n+  public void getInstance_withEmulator() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator\");\n+\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+    FirebaseFirestoreSettings settings = firestore.getFirestoreSettings();\n+\n+    assertEquals(settings.getHost(), \"10.0.2.2:8080\");\n+    assertFalse(settings.isSslEnabled());\n+  }\n+\n+  @Test\n+  public void getInstance_withEmulator_mergeSettingsSuccess() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator_mergeSettingsSuccess\");\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+    firestore.setFirestoreSettings(\n+        new FirebaseFirestoreSettings.Builder().setPersistenceEnabled(false).build());\n+\n+    FirebaseFirestoreSettings settings = firestore.getFirestoreSettings();\n+\n+    assertEquals(settings.getHost(), \"10.0.2.2:8080\");\n+    assertFalse(settings.isSslEnabled());\n+    assertFalse(settings.isPersistenceEnabled());\n+  }\n+\n+  @Test(expected = IllegalStateException.class)", "originalCommit": "f9ff9d6cfebe3de8674688639004811662525d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQwMDczMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r444400732", "bodyText": "Can you add a test that verifies that setFirestoreSettings can be called multiple times?", "author": "schmidt-sebastian", "createdAt": "2020-06-23T17:46:47Z", "path": "firebase-firestore/src/test/java/com/google/firebase/firestore/FirebaseFirestoreTest.java", "diffHunk": "@@ -0,0 +1,97 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.firestore;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+\n+import androidx.annotation.NonNull;\n+import androidx.test.platform.app.InstrumentationRegistry;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.emulators.EmulatedServiceSettings;\n+import com.google.firebase.emulators.EmulatorSettings;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(manifest = Config.NONE)\n+public class FirebaseFirestoreTest {\n+\n+  @Test\n+  public void getInstance_withEmulator() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator\");\n+\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+    FirebaseFirestoreSettings settings = firestore.getFirestoreSettings();\n+\n+    assertEquals(settings.getHost(), \"10.0.2.2:8080\");\n+    assertFalse(settings.isSslEnabled());\n+  }\n+\n+  @Test\n+  public void getInstance_withEmulator_mergeSettingsSuccess() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator_mergeSettingsSuccess\");\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+    firestore.setFirestoreSettings(\n+        new FirebaseFirestoreSettings.Builder().setPersistenceEnabled(false).build());\n+\n+    FirebaseFirestoreSettings settings = firestore.getFirestoreSettings();\n+\n+    assertEquals(settings.getHost(), \"10.0.2.2:8080\");\n+    assertFalse(settings.isSslEnabled());\n+    assertFalse(settings.isPersistenceEnabled());\n+  }\n+\n+  @Test(expected = IllegalStateException.class)\n+  public void getInstance_withEmulator_mergeSettingsFailure() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator_mergeSettingsFailure\");\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+    firestore.setFirestoreSettings(\n+        new FirebaseFirestoreSettings.Builder().setHost(\"myhost.com\").build());\n+  }", "originalCommit": "f9ff9d6cfebe3de8674688639004811662525d0e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "85b6170e1a306c7624e67824e4f24fa5b37057fc", "url": "https://github.com/firebase/firebase-android-sdk/commit/85b6170e1a306c7624e67824e4f24fa5b37057fc", "message": "Respond to Sebastian's review comments", "committedDate": "2020-06-23T18:34:18Z", "type": "commit"}, {"oid": "a79f753b740ea283a02bc1d514a3f7423703b8a5", "url": "https://github.com/firebase/firebase-android-sdk/commit/a79f753b740ea283a02bc1d514a3f7423703b8a5", "message": "Merge remote-tracking branch 'origin/master' into ss-firestore-emulator-settings", "committedDate": "2020-06-23T18:34:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NDM0Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r444454346", "bodyText": "The problem in the original PR would have only manifested itself if EmulatorSettings are also provided, which would have made the local settings different from the user's. Can you add the preamble from the other tests do to invoke this behavior?", "author": "schmidt-sebastian", "createdAt": "2020-06-23T19:23:33Z", "path": "firebase-firestore/src/test/java/com/google/firebase/firestore/FirebaseFirestoreTest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.firestore;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+\n+import androidx.annotation.NonNull;\n+import androidx.test.platform.app.InstrumentationRegistry;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.FirebaseOptions;\n+import com.google.firebase.emulators.EmulatedServiceSettings;\n+import com.google.firebase.emulators.EmulatorSettings;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+@RunWith(RobolectricTestRunner.class)\n+@Config(manifest = Config.NONE)\n+public class FirebaseFirestoreTest {\n+\n+  @Test\n+  public void getInstance_withEmulator() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator\");\n+\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+    FirebaseFirestoreSettings settings = firestore.getFirestoreSettings();\n+\n+    assertEquals(settings.getHost(), \"10.0.2.2:8080\");\n+    assertFalse(settings.isSslEnabled());\n+  }\n+\n+  @Test\n+  public void getInstance_withEmulator_mergeSettingsSuccess() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator_mergeSettingsSuccess\");\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+    firestore.setFirestoreSettings(\n+        new FirebaseFirestoreSettings.Builder().setPersistenceEnabled(false).build());\n+\n+    FirebaseFirestoreSettings settings = firestore.getFirestoreSettings();\n+\n+    assertEquals(settings.getHost(), \"10.0.2.2:8080\");\n+    assertFalse(settings.isSslEnabled());\n+    assertFalse(settings.isPersistenceEnabled());\n+  }\n+\n+  @Test\n+  public void getInstance_withEmulator_mergeSettingsFailure() {\n+    FirebaseApp app = getApp(\"getInstance_withEmulator_mergeSettingsFailure\");\n+    app.enableEmulators(\n+        new EmulatorSettings.Builder()\n+            .addEmulatedService(\n+                FirebaseFirestore.EMULATOR, new EmulatedServiceSettings(\"10.0.2.2\", 8080))\n+            .build());\n+\n+    try {\n+      FirebaseFirestore firestore = FirebaseFirestore.getInstance(app);\n+      firestore.setFirestoreSettings(\n+          new FirebaseFirestoreSettings.Builder().setHost(\"myhost.com\").build());\n+      fail(\"Exception should be thrown\");\n+    } catch (Exception e) {\n+      assertTrue(e instanceof IllegalStateException);\n+      assertEquals(\n+          e.getMessage(),\n+          \"Cannot specify the host in FirebaseFirestoreSettings when EmulatedServiceSettings is provided.\");\n+    }\n+  }\n+\n+  @Test\n+  public void setSettings_repeatedSuccess() {\n+    FirebaseApp app = getApp(\"setSettings_repeatedSuccess\");", "originalCommit": "a79f753b740ea283a02bc1d514a3f7423703b8a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NzYxNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1690#discussion_r444457617", "bodyText": "Added one more test for that.", "author": "samtstern", "createdAt": "2020-06-23T19:29:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDQ1NDM0Ng=="}], "type": "inlineReview"}, {"oid": "9d499c14ea95fd5d4daff4e9ffb769ce97f56377", "url": "https://github.com/firebase/firebase-android-sdk/commit/9d499c14ea95fd5d4daff4e9ffb769ce97f56377", "message": "Add one more test", "committedDate": "2020-06-23T19:28:59Z", "type": "commit"}, {"oid": "d90d91fc4c449e6ffa476c2e6b4520978c00d288", "url": "https://github.com/firebase/firebase-android-sdk/commit/d90d91fc4c449e6ffa476c2e6b4520978c00d288", "message": "Merge remote-tracking branch 'origin/master' into ss-firestore-emulator-settings", "committedDate": "2020-06-23T21:11:53Z", "type": "commit"}]}