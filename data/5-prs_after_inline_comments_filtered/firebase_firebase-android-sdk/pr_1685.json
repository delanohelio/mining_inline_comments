{"pr_number": 1685, "pr_title": "Move `rawType` to `TypeToken`", "pr_createdAt": "2020-06-18T19:52:59Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1685", "timeline": [{"oid": "b9f15f47106856788b6e6f4957d0a5e497822ebc", "url": "https://github.com/firebase/firebase-android-sdk/commit/b9f15f47106856788b6e6f4957d0a5e497822ebc", "message": "move rawType to TypeToken", "committedDate": "2020-06-18T19:49:38Z", "type": "commit"}, {"oid": "161733dc6503e59e71bd7882b3da88b68aedd2c7", "url": "https://github.com/firebase/firebase-android-sdk/commit/161733dc6503e59e71bd7882b3da88b68aedd2c7", "message": "update api file", "committedDate": "2020-06-18T20:02:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4ODMzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442488330", "bodyText": "pls make it final and set through the private constructor.", "author": "vkryachko", "createdAt": "2020-06-18T20:37:09Z", "path": "encoders/firebase-decoders-json/src/main/java/com/google/firebase/decoders/TypeToken.java", "diffHunk": "@@ -36,6 +36,12 @@\n  * </ol>\n  */\n public abstract class TypeToken<T> {\n+  private Class<T> rawType;", "originalCommit": "161733dc6503e59e71bd7882b3da88b68aedd2c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4ODg2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442488864", "bodyText": "I don't think you need super here or anywhere above and below.", "author": "vkryachko", "createdAt": "2020-06-18T20:38:11Z", "path": "encoders/firebase-decoders-json/src/main/java/com/google/firebase/decoders/TypeToken.java", "diffHunk": "@@ -126,32 +132,26 @@ public String toString() {\n    * Plain class types, Generic types, and Wildcard types.\n    */\n   public static class ClassToken<T> extends TypeToken<T> {\n-    private final Class<T> rawType;\n     private final TypeTokenContainer typeArguments;\n \n     private ClassToken(Class<T> rawType) {\n-      this.rawType = rawType;\n+      super.rawType = rawType;\n       this.typeArguments = TypeTokenContainer.EMPTY;\n     }\n \n     private ClassToken(Class<T> rawType, TypeTokenContainer typeArguments) {\n-      this.rawType = rawType;\n+      super.rawType = rawType;\n       this.typeArguments = typeArguments;\n     }\n \n-    @NonNull\n-    public Class<T> getRawType() {\n-      return rawType;\n-    }\n-\n     @NonNull\n     public TypeTokenContainer getTypeArguments() {\n       return typeArguments;\n     }\n \n     @Override\n     public int hashCode() {\n-      return 11 * rawType.hashCode() + typeArguments.hashCode();\n+      return 11 * super.rawType.hashCode() + typeArguments.hashCode();", "originalCommit": "161733dc6503e59e71bd7882b3da88b68aedd2c7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0NTU0MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442845540", "bodyText": "since ArrayToken is inner class and rawType is private, we need super to access the rawType or use getRawType()", "author": "James201311", "createdAt": "2020-06-19T13:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4ODg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg0OTc3MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442849770", "bodyText": "how about making it protected instead?", "author": "vkryachko", "createdAt": "2020-06-19T13:45:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4ODg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1MjY0Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442852646", "bodyText": "Yes, I am thinking if we make it protected, anyone will be able to access it when they extent the TypeToken, maybe we loose the advantage of putting ArrayToken and ClassToken inside TypeToken? wdyt?", "author": "James201311", "createdAt": "2020-06-19T13:51:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4ODg2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1NDQxMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442854413", "bodyText": "No one will be able to extend it as it has a private constructor", "author": "vkryachko", "createdAt": "2020-06-19T13:54:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ4ODg2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5MDYxNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442490617", "bodyText": "I've read a bit more on generic arrays and it looks like they are even more weird than I'd thought, i.e. there is not even a \"sane\" way to create one - it just won't compile - even though the type Optional<String>[] itself is legal in java.\nSo I would suggest you remove the todo and just leave it as explicitly not supported.\nAlso consider using the error message rtdb uses \n  \n    \n      firebase-android-sdk/firebase-database/src/main/java/com/google/firebase/database/core/utilities/encoding/CustomClassMapper.java\n    \n    \n         Line 200\n      in\n      a7096ac\n    \n    \n    \n    \n\n        \n          \n           \"Generic Arrays are not supported, please use Lists \" + \"instead\");", "author": "vkryachko", "createdAt": "2020-06-18T20:41:49Z", "path": "encoders/firebase-decoders-json/src/main/java/com/google/firebase/decoders/TypeToken.java", "diffHunk": "@@ -80,8 +86,8 @@\n       }\n       throw new IllegalArgumentException(\"<? super T> is not supported\");\n     } else if (type instanceof GenericArrayType) {\n-      Type componentType = ((GenericArrayType) type).getGenericComponentType();\n-      return new ArrayToken<T>(TypeToken.of(componentType));\n+      // TODO: Support GenericArrayType\n+      throw new IllegalArgumentException(\"GenericArrayType is not supported.\");", "originalCommit": "161733dc6503e59e71bd7882b3da88b68aedd2c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjQ5Mjg1OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442492859", "bodyText": "Consider removing the second argument and instead doing something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private ArrayToken(Class<T> rawType, TypeToken<?> componentType) {\n          \n          \n            \n                  super.rawType = rawType;\n          \n          \n            \n                  this.componentType = componentType;\n          \n          \n            \n                }\n          \n          \n            \n                private ArrayToken(Class<T> rawType) {\n          \n          \n            \n                  if(!rawType.isArray()) {\n          \n          \n            \n                    throw new IllegalArgumentException(\"blah-blah\");\n          \n          \n            \n                  }\n          \n          \n            \n                  super(rawType);\n          \n          \n            \n                  this.componentType = TypeToken.of(rawType.getComponentType());\n          \n          \n            \n                }", "author": "vkryachko", "createdAt": "2020-06-18T20:46:28Z", "path": "encoders/firebase-decoders-json/src/main/java/com/google/firebase/decoders/TypeToken.java", "diffHunk": "@@ -180,7 +181,8 @@ String getTypeTokenLiteral() {\n   public static class ArrayToken<T> extends TypeToken<T> {\n     private final TypeToken<?> componentType;\n \n-    private ArrayToken(TypeToken<?> componentType) {\n+    private ArrayToken(Class<T> rawType, TypeToken<?> componentType) {\n+      super.rawType = rawType;\n       this.componentType = componentType;\n     }", "originalCommit": "161733dc6503e59e71bd7882b3da88b68aedd2c7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8ac7c354b9a7b4009951322b509bbfc7bed1f628", "url": "https://github.com/firebase/firebase-android-sdk/commit/8ac7c354b9a7b4009951322b509bbfc7bed1f628", "message": "address comments", "committedDate": "2020-06-19T13:44:12Z", "type": "commit"}, {"oid": "8ac7c354b9a7b4009951322b509bbfc7bed1f628", "url": "https://github.com/firebase/firebase-android-sdk/commit/8ac7c354b9a7b4009951322b509bbfc7bed1f628", "message": "address comments", "committedDate": "2020-06-19T13:44:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1MDQ4Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442850482", "bodyText": "I think you also need to update equals and hashCode now that it has a rawType.", "author": "vkryachko", "createdAt": "2020-06-19T13:47:08Z", "path": "encoders/firebase-decoders-json/src/main/java/com/google/firebase/decoders/TypeToken.java", "diffHunk": "@@ -180,8 +179,12 @@ String getTypeTokenLiteral() {\n   public static class ArrayToken<T> extends TypeToken<T> {", "originalCommit": "8ac7c354b9a7b4009951322b509bbfc7bed1f628", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg1MDgwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442850807", "bodyText": "super() have to be the first statement in a constructor", "author": "James201311", "createdAt": "2020-06-19T13:47:45Z", "path": "encoders/firebase-decoders-json/src/main/java/com/google/firebase/decoders/TypeToken.java", "diffHunk": "@@ -181,9 +179,12 @@ String getTypeTokenLiteral() {\n   public static class ArrayToken<T> extends TypeToken<T> {\n     private final TypeToken<?> componentType;\n \n-    private ArrayToken(Class<T> rawType, TypeToken<?> componentType) {\n-      super.rawType = rawType;\n-      this.componentType = componentType;\n+    private ArrayToken(Class<T> rawType) {\n+      super(rawType);", "originalCommit": "8ac7c354b9a7b4009951322b509bbfc7bed1f628", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d5787840750db9e95abc3b87d66d47f00286e2b3", "url": "https://github.com/firebase/firebase-android-sdk/commit/d5787840750db9e95abc3b87d66d47f00286e2b3", "message": "address comments", "committedDate": "2020-06-19T14:06:55Z", "type": "commit"}, {"oid": "245cb7b19e4e050cb1f120b60d9aea0f1de02360", "url": "https://github.com/firebase/firebase-android-sdk/commit/245cb7b19e4e050cb1f120b60d9aea0f1de02360", "message": "update api file", "committedDate": "2020-06-19T14:09:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjg2NDYxOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1685#discussion_r442864619", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      \"Generic Arrays are not supported, \" + \"please use Lists instead.\");\n          \n          \n            \n                      \"Generic Arrays are not supported, please use Lists instead.\");", "author": "vkryachko", "createdAt": "2020-06-19T14:13:21Z", "path": "encoders/firebase-decoders-json/src/main/java/com/google/firebase/decoders/TypeToken.java", "diffHunk": "@@ -80,8 +91,8 @@\n       }\n       throw new IllegalArgumentException(\"<? super T> is not supported\");\n     } else if (type instanceof GenericArrayType) {\n-      Type componentType = ((GenericArrayType) type).getGenericComponentType();\n-      return new ArrayToken<T>(TypeToken.of(componentType));\n+      throw new IllegalArgumentException(\n+          \"Generic Arrays are not supported, \" + \"please use Lists instead.\");", "originalCommit": "245cb7b19e4e050cb1f120b60d9aea0f1de02360", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4d289c3e4eaef5894551fe6c3bea3ad853a76f90", "url": "https://github.com/firebase/firebase-android-sdk/commit/4d289c3e4eaef5894551fe6c3bea3ad853a76f90", "message": "address comment", "committedDate": "2020-06-19T14:21:00Z", "type": "commit"}]}