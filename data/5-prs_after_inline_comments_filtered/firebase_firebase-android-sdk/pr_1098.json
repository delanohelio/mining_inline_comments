{"pr_number": 1098, "pr_title": "Add functionality to ABT SDK for adding and removing active experiments", "pr_createdAt": "2020-01-07T22:52:06Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1098", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NTk4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r364475983", "bodyText": "Maybe 'notes that an experiment is active in experiment metrics reporting'\nthe call should 'trigger' the experiment regardless of the triggering condition, right? (Anything hitting this wants to manually set the experiment as triggered/active'", "author": "MeghaB", "createdAt": "2020-01-08T22:31:13Z", "path": "firebase-abt/src/main/java/com/google/firebase/abt/FirebaseABTesting.java", "diffHunk": "@@ -140,6 +140,52 @@ public void removeAllExperiments() throws AbtException {\n     removeExperiments(getAllExperimentsInAnalytics());\n   }\n \n+  /**\n+   * Adds an experiment to be active in GA by setting a null triggering condition on the provided", "originalCommit": "5869fcf158156c21ed3d60d4be6a3ff32bb7bb0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3MjQ1MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366072451", "bodyText": "slightly improved text to reflect this more clearly", "author": "JasonAHeron", "createdAt": "2020-01-13T22:53:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NTk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NjUwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r364476507", "bodyText": "note here maybe that it overrides the full running list?\nthis comment would be confusing w.r.t 'reportActive'\nhere we should only 'clean up experiments which are noted in GA but not eligible for this device'? (running might be confused with 'active')", "author": "MeghaB", "createdAt": "2020-01-08T22:32:39Z", "path": "firebase-abt/src/main/java/com/google/firebase/abt/FirebaseABTesting.java", "diffHunk": "@@ -140,6 +140,52 @@ public void removeAllExperiments() throws AbtException {\n     removeExperiments(getAllExperimentsInAnalytics());\n   }\n \n+  /**\n+   * Adds an experiment to be active in GA by setting a null triggering condition on the provided\n+   * experiment. This results in the experiment being active as if it was triggered by the\n+   * triggering condition event being seen in GA.\n+   *\n+   * <p>Note: This is a blocking call and therefore should be called from a worker thread.\n+   *\n+   * @param activeExperiment The {@link AbtExperimentInfo} that should be set as active in GA.\n+   * @throws AbtException If there is no Analytics SDK.\n+   */\n+  @WorkerThread\n+  public void reportActiveExperiment(AbtExperimentInfo activeExperiment) throws AbtException {\n+    throwAbtExceptionIfAnalyticsIsNull();\n+    ArrayList<AbtExperimentInfo> activeExperimentList = new ArrayList<>();\n+\n+    // Remove trigger event if it exists, this sets the experiment to active.\n+    Map<String, String> activeExperimentMap = activeExperiment.toStringMap();\n+    activeExperimentMap.remove(AbtExperimentInfo.TRIGGER_EVENT_KEY);\n+\n+    // Add experiment to GA\n+    activeExperimentList.add(AbtExperimentInfo.fromMap(activeExperimentMap));\n+    addExperiments(activeExperimentList);\n+  }\n+\n+  /**\n+   * Cleans up all experiments which are active in GA but not currently running.\n+   *\n+   * <p>Note: This is a blocking call and therefore should be called from a worker thread.", "originalCommit": "5869fcf158156c21ed3d60d4be6a3ff32bb7bb0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3MzUxNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366073515", "bodyText": "updated", "author": "JasonAHeron", "createdAt": "2020-01-13T22:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NjUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NzIxMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r364477210", "bodyText": "is there another test that's not just 'without analytics' we can update?", "author": "MeghaB", "createdAt": "2020-01-08T22:34:34Z", "path": "firebase-abt/src/test/java/com/google/firebase/abt/FirebaseABTWithoutAnalyticsTest.java", "diffHunk": "@@ -96,6 +96,49 @@ public void replaceAllExperimentsWithoutAnalytics_sendsValidExperimentList_throw\n     assertThat(actualException).hasMessageThat().contains(\"Analytics\");\n   }\n \n+  @Test\n+  public void reportRunningExperimentsWithoutAnalytics_throwsAbtException() {\n+    List<AbtExperimentInfo> experimentInfos = new ArrayList<>();", "originalCommit": "5869fcf158156c21ed3d60d4be6a3ff32bb7bb0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ4NjIzNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r364486237", "bodyText": "sadly no, these are the only tests", "author": "JasonAHeron", "createdAt": "2020-01-08T23:00:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ3NzIxMA=="}], "type": "inlineReview"}, {"oid": "0642876ef0a22c8b58ad3af9e3fe1ce62d4ec056", "url": "https://github.com/firebase/firebase-android-sdk/commit/0642876ef0a22c8b58ad3af9e3fe1ce62d4ec056", "message": "Facilitate FIAM + ABT", "committedDate": "2020-01-13T19:28:28Z", "type": "commit"}, {"oid": "00f9bfb05b74395fedca39b05b67ea2b72c70b99", "url": "https://github.com/firebase/firebase-android-sdk/commit/00f9bfb05b74395fedca39b05b67ea2b72c70b99", "message": "rebase correctly", "committedDate": "2020-01-13T19:32:51Z", "type": "commit"}, {"oid": "00f9bfb05b74395fedca39b05b67ea2b72c70b99", "url": "https://github.com/firebase/firebase-android-sdk/commit/00f9bfb05b74395fedca39b05b67ea2b72c70b99", "message": "rebase correctly", "committedDate": "2020-01-13T19:32:51Z", "type": "forcePushed"}, {"oid": "0ec4611150b680b648ddca85b15b4c0c3fe101bf", "url": "https://github.com/firebase/firebase-android-sdk/commit/0ec4611150b680b648ddca85b15b4c0c3fe101bf", "message": "format", "committedDate": "2020-01-13T19:35:39Z", "type": "commit"}, {"oid": "7a337ad73cad474ba09a3e8f285462d1f0a43cc7", "url": "https://github.com/firebase/firebase-android-sdk/commit/7a337ad73cad474ba09a3e8f285462d1f0a43cc7", "message": "starting to add tests", "committedDate": "2020-01-13T20:19:49Z", "type": "commit"}, {"oid": "870ea00d9a1f42f7402aeb29fde4b9b408bcf05e", "url": "https://github.com/firebase/firebase-android-sdk/commit/870ea00d9a1f42f7402aeb29fde4b9b408bcf05e", "message": "derp", "committedDate": "2020-01-13T20:21:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzNjg1NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366036855", "bodyText": "We should check with GA about this new origin code to make sure events will be processed as expected", "author": "welkinlan", "createdAt": "2020-01-13T21:26:35Z", "path": "firebase-abt/src/main/java/com/google/firebase/abt/FirebaseABTesting.java", "diffHunk": "@@ -65,12 +67,14 @@\n    * Select keys of fields in the experiment descriptions returned from the Firebase Remote Config\n    * server.\n    */\n-  @StringDef({REMOTE_CONFIG})\n+  @StringDef({REMOTE_CONFIG, INAPP_MESSAGING})\n   @Retention(RetentionPolicy.SOURCE)\n   public @interface OriginService {\n \n     /** Must match the origin code in Google Analytics for Firebase. */\n     String REMOTE_CONFIG = \"frc\";\n+\n+    String INAPP_MESSAGING = \"fiam\";", "originalCommit": "870ea00d9a1f42f7402aeb29fde4b9b408bcf05e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3MDM1Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366070356", "bodyText": "yep!", "author": "JasonAHeron", "createdAt": "2020-01-13T22:48:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzNjg1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4MzY5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366083699", "bodyText": "turns out \"fiam\" is correct as per Megha", "author": "JasonAHeron", "createdAt": "2020-01-13T23:29:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAzNjg1NQ=="}], "type": "inlineReview"}, {"oid": "34916bd72f725d720e7f1c212d28192263b8fe04", "url": "https://github.com/firebase/firebase-android-sdk/commit/34916bd72f725d720e7f1c212d28192263b8fe04", "message": "add moar tests", "committedDate": "2020-01-13T22:45:44Z", "type": "commit"}, {"oid": "fd8acb7d89c23ed4bf2dfd1f9772ed68f69aadbf", "url": "https://github.com/firebase/firebase-android-sdk/commit/fd8acb7d89c23ed4bf2dfd1f9772ed68f69aadbf", "message": "updating javadoc", "committedDate": "2020-01-13T22:56:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NTkwOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366075908", "bodyText": "consider replacing \"report\" with a different word like \"check/validate\"? Since this function is used to remove obsolete experiments from GA", "author": "welkinlan", "createdAt": "2020-01-13T23:04:13Z", "path": "firebase-abt/src/main/java/com/google/firebase/abt/FirebaseABTesting.java", "diffHunk": "@@ -162,6 +166,70 @@ public void removeAllExperiments() throws AbtException {\n     return experimentInfos;\n   }\n \n+  /**\n+   * Sets an experiment to be active in GA metrics reporting by setting a null triggering condition\n+   * on the provided experiment. This results in the experiment being active as if it was triggered\n+   * by the triggering condition event being seen in GA.\n+   *\n+   * <p>Note: This is a blocking call and therefore should be called from a worker thread.\n+   *\n+   * @param activeExperiment The {@link AbtExperimentInfo} that should be set as active in GA.\n+   * @throws AbtException If there is no Analytics SDK.\n+   */\n+  @WorkerThread\n+  public void reportActiveExperiment(AbtExperimentInfo activeExperiment) throws AbtException {\n+    throwAbtExceptionIfAnalyticsIsNull();\n+    ArrayList<AbtExperimentInfo> activeExperimentList = new ArrayList<>();\n+\n+    // Remove trigger event if it exists, this sets the experiment to active.\n+    Map<String, String> activeExperimentMap = activeExperiment.toStringMap();\n+    activeExperimentMap.remove(AbtExperimentInfo.TRIGGER_EVENT_KEY);\n+\n+    // Add experiment to GA\n+    activeExperimentList.add(AbtExperimentInfo.fromMap(activeExperimentMap));\n+    addExperiments(activeExperimentList);\n+  }\n+\n+  /**\n+   * Adds an experiment to be active in GA by setting a null triggering condition on the provided\n+   * experiment. This results in the experiment being active as if it was triggered by the\n+   * triggering condition event being seen in GA.\n+   *\n+   * <p>Note: This is a blocking call and therefore should be called from a worker thread.\n+   *\n+   * @param activeExperiment The {@link FirebaseAbt.ExperimentPayload} that should be set as active\n+   *     in GA.\n+   * @throws AbtException If there is no Analytics SDK.\n+   */\n+  @WorkerThread\n+  public void reportActiveExperiment(FirebaseAbt.ExperimentPayload experimentPayload)\n+      throws AbtException {\n+    reportActiveExperiment(AbtExperimentInfo.fromExperimentPayload(experimentPayload));\n+  }\n+\n+  /**\n+   * Cleans up all experiments which are active in GA but not currently running. This method is\n+   * meant to be used to ensure all running experiments should indeed be running.\n+   *\n+   * <p>Note: This is a blocking call and therefore should be called from a worker thread.\n+   *\n+   * @param runningExperiments the currently running {@link AbtExperimentInfo}s, any active\n+   *     experiment that is not in this list will be removed from GA reporting.\n+   * @throws AbtException If there is no Analytics SDK.\n+   */\n+  @WorkerThread\n+  public void reportRunningExperiments(List<AbtExperimentInfo> runningExperiments)", "originalCommit": "fd8acb7d89c23ed4bf2dfd1f9772ed68f69aadbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4MTM0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366081349", "bodyText": "yeah validate seems good actually, I'll switch to that", "author": "JasonAHeron", "createdAt": "2020-01-13T23:21:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NTkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NjQzNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366076435", "bodyText": "noInactiveExperimentsInAnalytics", "author": "welkinlan", "createdAt": "2020-01-13T23:05:40Z", "path": "firebase-abt/src/test/java/com/google/firebase/abt/FirebaseABTestingTest.java", "diffHunk": "@@ -288,6 +289,61 @@ public void getAllExperiments_analyticsSdkUnavailable_throwsAbtException() {\n     assertThat(actualException).hasMessageThat().contains(\"he Analytics SDK is not available\");\n   }\n \n+  @Test\n+  public void reportRunningExperiments_inactiveExperimentsInAnalytics_cleansUpInactiveExperiments()\n+      throws Exception {\n+    // Two experiments running\n+    when(mockAnalyticsConnector.getConditionalUserProperties(ORIGIN_SERVICE, \"\"))\n+        .thenReturn(\n+            Lists.newArrayList(\n+                TEST_ABT_EXPERIMENT_1.toConditionalUserProperty(ORIGIN_SERVICE),\n+                TEST_ABT_EXPERIMENT_2.toConditionalUserProperty(ORIGIN_SERVICE)));\n+\n+    // Update to just one experiment running\n+    firebaseAbt.reportRunningExperiments(Lists.newArrayList(TEST_ABT_EXPERIMENT_1));\n+\n+    // Verify the not running experiment is cleared\n+    verify(mockAnalyticsConnector).clearConditionalUserProperty(TEST_EXPERIMENT_2_ID, null, null);\n+  }\n+\n+  @Test\n+  public void reportRunningExperiments_activeExperimentsInAnalytics_cleansUpNothing()", "originalCommit": "fd8acb7d89c23ed4bf2dfd1f9772ed68f69aadbf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA4MjAwMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1098#discussion_r366082001", "bodyText": "done", "author": "JasonAHeron", "createdAt": "2020-01-13T23:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjA3NjQzNQ=="}], "type": "inlineReview"}, {"oid": "9ad41f431a8719bd5858309889396c90dbea69fe", "url": "https://github.com/firebase/firebase-android-sdk/commit/9ad41f431a8719bd5858309889396c90dbea69fe", "message": "updates per review", "committedDate": "2020-01-13T23:23:16Z", "type": "commit"}]}