{"pr_number": 1279, "pr_title": "Add upload variant switch to ReportUploader", "pr_createdAt": "2020-02-25T18:57:57Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1279", "timeline": [{"oid": "61028865d9ffc063ce721d2f147e4681e0b9fc31", "url": "https://github.com/firebase/firebase-android-sdk/commit/61028865d9ffc063ce721d2f147e4681e0b9fc31", "message": "Add upload variant switch to ReportUploader", "committedDate": "2020-02-25T17:40:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NzQ4MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384077480", "bodyText": "What is the purpose of this .substring(0, 35)?", "author": "jakeouellette", "createdAt": "2020-02-25T19:29:03Z", "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/core/TestNativeReportFilesProvider.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.crashlytics.core;\n+\n+import android.content.Context;\n+import com.google.firebase.crashlytics.internal.report.ReportUploader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+public class TestNativeReportFilesProvider implements ReportUploader.ReportFilesProvider {\n+  private final File validFiles;\n+\n+  public TestNativeReportFilesProvider(Context context) {\n+    final File filesDir = context.getFilesDir();\n+    recursiveDelete(filesDir);\n+\n+    File rootFolder = new File(context.getFilesDir(), UUID.randomUUID().toString());\n+    rootFolder.mkdirs();\n+\n+    validFiles = new File(rootFolder, UUID.randomUUID().toString());\n+    validFiles.mkdirs();\n+  }\n+\n+  @Override\n+  public File[] getCompleteSessionFiles() {\n+    return new File[0];\n+  }\n+\n+  @Override\n+  public File[] getNativeReportFiles() {\n+    return validFiles.listFiles();\n+  }\n+\n+  private static String createRandomSessionId() {\n+    return UUID.randomUUID().toString().substring(0, 35);", "originalCommit": "61028865d9ffc063ce721d2f147e4681e0b9fc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODg2Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384078867", "bodyText": "Copypasta. Lemme check.", "author": "mrwillis21", "createdAt": "2020-02-25T19:31:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NzQ4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MTAxOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384081019", "bodyText": "Standard session ID length: https://github.com/firebase/firebase-android-sdk/blob/master/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java#L231", "author": "mrwillis21", "createdAt": "2020-02-25T19:35:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3NzQ4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODI3OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384078279", "bodyText": "CrashlyticsReportPersistence has this operation too. Should we make a util class?", "author": "jakeouellette", "createdAt": "2020-02-25T19:30:35Z", "path": "firebase-crashlytics/src/androidTest/java/com/google/firebase/crashlytics/core/TestNativeReportFilesProvider.java", "diffHunk": "@@ -0,0 +1,63 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.crashlytics.core;\n+\n+import android.content.Context;\n+import com.google.firebase.crashlytics.internal.report.ReportUploader;\n+import java.io.File;\n+import java.io.IOException;\n+import java.util.UUID;\n+\n+public class TestNativeReportFilesProvider implements ReportUploader.ReportFilesProvider {\n+  private final File validFiles;\n+\n+  public TestNativeReportFilesProvider(Context context) {\n+    final File filesDir = context.getFilesDir();\n+    recursiveDelete(filesDir);\n+\n+    File rootFolder = new File(context.getFilesDir(), UUID.randomUUID().toString());\n+    rootFolder.mkdirs();\n+\n+    validFiles = new File(rootFolder, UUID.randomUUID().toString());\n+    validFiles.mkdirs();\n+  }\n+\n+  @Override\n+  public File[] getCompleteSessionFiles() {\n+    return new File[0];\n+  }\n+\n+  @Override\n+  public File[] getNativeReportFiles() {\n+    return validFiles.listFiles();\n+  }\n+\n+  private static String createRandomSessionId() {\n+    return UUID.randomUUID().toString().substring(0, 35);\n+  }\n+\n+  private static void recursiveDelete(File file) {", "originalCommit": "61028865d9ffc063ce721d2f147e4681e0b9fc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3OTI3MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384079270", "bodyText": "Trying to avoid that for now. \"A little copying is better than a little dependency.\"", "author": "mrwillis21", "createdAt": "2020-02-25T19:32:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODI3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MDMzNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384080334", "bodyText": "Besides, this is a test class.", "author": "mrwillis21", "createdAt": "2020-02-25T19:34:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODY2Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384078663", "bodyText": "should we document what \"legacy\" means / changes?", "author": "jakeouellette", "createdAt": "2020-02-25T19:31:12Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java", "diffHunk": "@@ -105,6 +105,8 @@\n   static final String FIREBASE_APPLICATION_EXCEPTION = \"_ae\";\n   static final String FIREBASE_ANALYTICS_ORIGIN_CRASHLYTICS = \"clx\";\n \n+  static final int REPORT_UPLOAD_VARIANT_LEGACY = 1;", "originalCommit": "61028865d9ffc063ce721d2f147e4681e0b9fc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3OTcxNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384079716", "bodyText": "Let's chat offline about this.", "author": "mrwillis21", "createdAt": "2020-02-25T19:33:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODY2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODk5Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384078996", "bodyText": "Worth a TODO?", "author": "jakeouellette", "createdAt": "2020-02-25T19:31:47Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/report/ReportUploader.java", "diffHunk": "@@ -96,14 +99,21 @@ public boolean uploadReport(Report report, boolean dataCollectionToken) {\n       final CreateReportRequest requestData =\n           new CreateReportRequest(organizationId, googleAppId, report);\n \n-      final boolean sent = createReportCall.invoke(requestData, dataCollectionToken);\n+      boolean sent;\n+      // For now, send native reports to reports endpoint regardless of the setting.", "originalCommit": "61028865d9ffc063ce721d2f147e4681e0b9fc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MDAyNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384080024", "bodyText": "I'm going to circle back to this in the next week or two, but happy to add a TODO if you think it's worth it.", "author": "mrwillis21", "createdAt": "2020-02-25T19:33:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MTUyNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384081524", "bodyText": "I like shorter TODOs better than longer ones because those are the ones we actually get to address, but happy to punt on it for this PR and just do it in future cases if it saves you work :)", "author": "jakeouellette", "createdAt": "2020-02-25T19:36:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA3ODk5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MDc4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384080783", "bodyText": "If it didn't actually send, should we change the name of this bool to shouldDeleteReport or something similar?", "author": "jakeouellette", "createdAt": "2020-02-25T19:35:23Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/report/ReportUploader.java", "diffHunk": "@@ -96,14 +99,21 @@ public boolean uploadReport(Report report, boolean dataCollectionToken) {\n       final CreateReportRequest requestData =\n           new CreateReportRequest(organizationId, googleAppId, report);\n \n-      final boolean sent = createReportCall.invoke(requestData, dataCollectionToken);\n+      boolean sent;\n+      // For now, send native reports to reports endpoint regardless of the setting.\n+      if (isUsingReportsEndpoint || report.getType() == Report.Type.NATIVE) {\n+        sent = createReportCall.invoke(requestData, dataCollectionToken);\n \n-      Logger.getLogger()\n-          .i(\n-              Logger.TAG,\n-              \"Crashlytics report upload \"\n-                  + (sent ? \"complete: \" : \"FAILED: \")\n-                  + report.getIdentifier());\n+        Logger.getLogger()\n+            .i(\n+                Logger.TAG,\n+                \"Crashlytics report upload \"\n+                    + (sent ? \"complete: \" : \"FAILED: \")\n+                    + report.getIdentifier());\n+      } else {\n+        Logger.getLogger().d(Logger.TAG, \"Send to reports endpoint disabled. Removing report.\");\n+        sent = true;", "originalCommit": "61028865d9ffc063ce721d2f147e4681e0b9fc31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MTIzMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1279#discussion_r384081232", "bodyText": "We can, sure.", "author": "mrwillis21", "createdAt": "2020-02-25T19:36:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDA4MDc4Mw=="}], "type": "inlineReview"}, {"oid": "1188357c18016ec75592052d3e3e89850357fe8c", "url": "https://github.com/firebase/firebase-android-sdk/commit/1188357c18016ec75592052d3e3e89850357fe8c", "message": "Feedback", "committedDate": "2020-02-25T19:49:44Z", "type": "commit"}]}