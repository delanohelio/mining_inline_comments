{"pr_number": 1255, "pr_title": "Cap events-per-session in Crashlytics persistence", "pr_createdAt": "2020-02-19T18:55:44Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1255", "timeline": [{"oid": "ea50d53e131c6c350938fd009cd49e2f29f53a64", "url": "https://github.com/firebase/firebase-android-sdk/commit/ea50d53e131c6c350938fd009cd49e2f29f53a64", "message": "Cap events-per-session in Crashlytics persistence\n\nReplaces the concept of fatal/nonfatal in the persistence layer\nwith a persistence-specific concept of normal/high priority events.\n\nThis will be used to implement keeping a maximum number of logged\nexceptions per session, without leaking information about specific\nevent types into the persistence layer.", "committedDate": "2020-02-19T19:08:21Z", "type": "forcePushed"}, {"oid": "3f81d99566cc060ffe18caf769cfbb041052d472", "url": "https://github.com/firebase/firebase-android-sdk/commit/3f81d99566cc060ffe18caf769cfbb041052d472", "message": "Cap events-per-session in Crashlytics persistence\n\nReplaces the concept of fatal/nonfatal in the persistence layer\nwith a persistence-specific concept of normal/high priority events.\n\nThis will be used to implement keeping a maximum number of logged\nexceptions per session, without leaking information about specific\nevent types into the persistence layer.", "committedDate": "2020-02-19T19:10:16Z", "type": "commit"}, {"oid": "3f81d99566cc060ffe18caf769cfbb041052d472", "url": "https://github.com/firebase/firebase-android-sdk/commit/3f81d99566cc060ffe18caf769cfbb041052d472", "message": "Cap events-per-session in Crashlytics persistence\n\nReplaces the concept of fatal/nonfatal in the persistence layer\nwith a persistence-specific concept of normal/high priority events.\n\nThis will be used to implement keeping a maximum number of logged\nexceptions per session, without leaking information about specific\nevent types into the persistence layer.", "committedDate": "2020-02-19T19:10:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNDY1OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382034658", "bodyText": "What resets this back to zero? Is this \"Persistence\" class recreated before it gets sufficiently large?", "author": "jakeouellette", "createdAt": "2020-02-20T14:31:36Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -43,36 +43,41 @@\n \n   private static final Charset UTF_8 = Charset.forName(\"UTF-8\");\n \n-  private static final String WORKING_DIRECTORY_NAME = \"fl\";\n+  private static final String WORKING_DIRECTORY_NAME = \"report-persistence\";\n   private static final String OPEN_SESSIONS_DIRECTORY_NAME = \"sessions\";\n-  private static final String FATAL_DIRECTORY_NAME = \"fatal\";\n-  private static final String NON_FATAL_DIRECTORY_NAME = \"non-fatal\";\n+  private static final String PRIORITY_REPORTS_DIRECTORY = \"priority-reports\";\n+  private static final String REPORTS_DIRECTORY = \"reports\";\n \n-  private static final String REPORT_FILE_NAME = \"report.json\";\n+  private static final String REPORT_FILE_NAME = \"report\";\n   private static final String EVENT_FILE_NAME_PREFIX = \"event\";\n-  private static final String EVENT_FILE_NAME_FORMAT = EVENT_FILE_NAME_PREFIX + \"%s.json\";\n-  private static final String EVENT_COUNTER_FORMAT = \"%010d\";\n-\n-  private static final String EVENT_TYPE_FATAL = \"crash\";\n+  private static final int EVENT_COUNTER_WIDTH = 10; // String width of maximum positive int value\n+  private static final String EVENT_COUNTER_FORMAT = \"%0\" + EVENT_COUNTER_WIDTH + \"d\";\n+  private static final int EVENT_NAME_LENGTH =\n+      EVENT_FILE_NAME_PREFIX.length() + EVENT_COUNTER_WIDTH;\n+  private static final String PRIORITY_EVENT_SUFFIX = \"_\";\n+  private static final String NORMAL_EVENT_SUFFIX = \"\";\n \n   private static final CrashlyticsReportJsonTransform TRANSFORM =\n       new CrashlyticsReportJsonTransform();\n \n   private final AtomicInteger eventCounter = new AtomicInteger(0);", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MDY2Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382050662", "bodyText": "In practice, yes. If you've got a situation where you have greater than Integer.MAX_VALUE events coming in for a single session, something is terribly wrong, and the information isn't going to be particularly useful to you anyway.\nSee also: https://github.com/firebase/firebase-android-sdk/blob/master/firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/core/CrashlyticsController.java#L241", "author": "mrwillis21", "createdAt": "2020-02-20T14:55:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNDY1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNjc0Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382036742", "bodyText": "It is interesting to me that this method is side-effecting and returns a value. Would it be more obvious to the reader if this method were static, and you passed  generateEventFilename(eventCounter.getAndIncrement(), isHighPriority) in?", "author": "jakeouellette", "createdAt": "2020-02-20T14:34:47Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -151,22 +178,55 @@ public void finalizeReports(String currentSessionId) {\n   }\n \n   public List<CrashlyticsReport> loadFinalizedReports() {\n-    final List<CrashlyticsReport> reports = new ArrayList<>();\n-    final List<File> fatalReports = getAllFilesInDirectory(fatalReportsDirectory);\n-    for (File reportFile : fatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<CrashlyticsReport> allReports = new ArrayList<>();\n+    final List<File> priorityReports = getAllFilesInDirectory(priorityReportsDirectory);\n+    for (File reportFile : priorityReports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    final List<File> nonFatalReports = getAllFilesInDirectory(nonFatalReportsDirectory);\n-    for (File reportFile : nonFatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<File> reports = getAllFilesInDirectory(reportsDirectory);\n+    for (File reportFile : reports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    return reports;\n+    return allReports;\n+  }\n+\n+  private static boolean isHighPriorityEvent(String eventFileName) {\n+    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  }\n+\n+  private String generateEventFilename(boolean isHighPriority) {\n+    final String eventNumber =\n+        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNzA4MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382037080", "bodyText": "(I guess you'd probably want to rename it if you did that. I could go either way really, just wanted to ask!)", "author": "jakeouellette", "createdAt": "2020-02-20T14:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNjc0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MDk5MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382050990", "bodyText": "Solid point. I don't think it would necessitate a rename.", "author": "mrwillis21", "createdAt": "2020-02-20T14:56:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzNjc0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzODQ3MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382038470", "bodyText": "Possibly a dumb optimization, but if !isHighPriorityEvent is more variable, and EVENT_FILE_NAME_PREFIX is expected 99% of the time, it might be worth putting the second check first to short circuit early more frequently.", "author": "jakeouellette", "createdAt": "2020-02-20T14:37:33Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -151,22 +178,55 @@ public void finalizeReports(String currentSessionId) {\n   }\n \n   public List<CrashlyticsReport> loadFinalizedReports() {\n-    final List<CrashlyticsReport> reports = new ArrayList<>();\n-    final List<File> fatalReports = getAllFilesInDirectory(fatalReportsDirectory);\n-    for (File reportFile : fatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<CrashlyticsReport> allReports = new ArrayList<>();\n+    final List<File> priorityReports = getAllFilesInDirectory(priorityReportsDirectory);\n+    for (File reportFile : priorityReports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    final List<File> nonFatalReports = getAllFilesInDirectory(nonFatalReportsDirectory);\n-    for (File reportFile : nonFatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<File> reports = getAllFilesInDirectory(reportsDirectory);\n+    for (File reportFile : reports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    return reports;\n+    return allReports;\n+  }\n+\n+  private static boolean isHighPriorityEvent(String eventFileName) {\n+    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  }\n+\n+  private String generateEventFilename(boolean isHighPriority) {\n+    final String eventNumber =\n+        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());\n+    final String prioritySuffix = isHighPriority ? PRIORITY_EVENT_SUFFIX : NORMAL_EVENT_SUFFIX;\n+    return EVENT_FILE_NAME_PREFIX + eventNumber + prioritySuffix;\n   }\n \n   private File getSessionDirectoryById(String sessionId) {\n     return new File(openSessionsDirectory, sessionId);\n   }\n \n+  private static int trimEvents(File sessionDirectory, int maximum) {\n+    final List<File> normalPriorityEventFiles =\n+        getFilesInDirectory(\n+            sessionDirectory, CrashlyticsReportPersistence::isNormalPriorityEventFile);\n+    Collections.sort(normalPriorityEventFiles, CrashlyticsReportPersistence::oldestEventFileFirst);\n+    return capFilesCount(normalPriorityEventFiles, maximum);\n+  }\n+\n+  private static String eventNameOnly(String eventFileName) {\n+    return eventFileName.substring(0, EVENT_NAME_LENGTH);\n+  }\n+\n+  private static boolean isNormalPriorityEventFile(File dir, String name) {\n+    return name.startsWith(EVENT_FILE_NAME_PREFIX) && !isHighPriorityEvent(name);", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MTM0OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382051348", "bodyText": "\ud83d\udc4d", "author": "mrwillis21", "createdAt": "2020-02-20T14:56:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzODQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5NDE2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382094168", "bodyText": "Actually, after looking back at this - we need to filter out any non-event files first, so this needs to stay as it is.", "author": "mrwillis21", "createdAt": "2020-02-20T15:59:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzODQ3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5NDczMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382094732", "bodyText": "Rewrote these two methods though, and paired them, so they'd be easier to reason about.", "author": "mrwillis21", "createdAt": "2020-02-20T16:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAzODQ3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0MDY0OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382040649", "bodyText": "Is it worth having a unit test for this?", "author": "jakeouellette", "createdAt": "2020-02-20T14:40:52Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -151,22 +178,55 @@ public void finalizeReports(String currentSessionId) {\n   }\n \n   public List<CrashlyticsReport> loadFinalizedReports() {\n-    final List<CrashlyticsReport> reports = new ArrayList<>();\n-    final List<File> fatalReports = getAllFilesInDirectory(fatalReportsDirectory);\n-    for (File reportFile : fatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<CrashlyticsReport> allReports = new ArrayList<>();\n+    final List<File> priorityReports = getAllFilesInDirectory(priorityReportsDirectory);\n+    for (File reportFile : priorityReports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    final List<File> nonFatalReports = getAllFilesInDirectory(nonFatalReportsDirectory);\n-    for (File reportFile : nonFatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<File> reports = getAllFilesInDirectory(reportsDirectory);\n+    for (File reportFile : reports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    return reports;\n+    return allReports;\n+  }\n+\n+  private static boolean isHighPriorityEvent(String eventFileName) {\n+    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  }\n+\n+  private String generateEventFilename(boolean isHighPriority) {\n+    final String eventNumber =\n+        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());\n+    final String prioritySuffix = isHighPriority ? PRIORITY_EVENT_SUFFIX : NORMAL_EVENT_SUFFIX;\n+    return EVENT_FILE_NAME_PREFIX + eventNumber + prioritySuffix;\n   }\n \n   private File getSessionDirectoryById(String sessionId) {\n     return new File(openSessionsDirectory, sessionId);\n   }\n \n+  private static int trimEvents(File sessionDirectory, int maximum) {\n+    final List<File> normalPriorityEventFiles =\n+        getFilesInDirectory(\n+            sessionDirectory, CrashlyticsReportPersistence::isNormalPriorityEventFile);\n+    Collections.sort(normalPriorityEventFiles, CrashlyticsReportPersistence::oldestEventFileFirst);\n+    return capFilesCount(normalPriorityEventFiles, maximum);\n+  }\n+\n+  private static String eventNameOnly(String eventFileName) {\n+    return eventFileName.substring(0, EVENT_NAME_LENGTH);\n+  }\n+\n+  private static boolean isNormalPriorityEventFile(File dir, String name) {\n+    return name.startsWith(EVENT_FILE_NAME_PREFIX) && !isHighPriorityEvent(name);\n+  }\n+\n+  private static int oldestEventFileFirst(File f1, File f2) {", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MTcxNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382051717", "bodyText": "Why do we return an int if we never use it?", "author": "jakeouellette", "createdAt": "2020-02-20T14:57:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0MDY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4NzM4Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382087387", "bodyText": "This is a method reference used as a comparator, which must return an int.", "author": "mrwillis21", "createdAt": "2020-02-20T15:49:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0MDY0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEyNzUxMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382127511", "bodyText": "thoughts on the unit test question?", "author": "jakeouellette", "createdAt": "2020-02-20T16:52:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0MDY0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NDU2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382044561", "bodyText": "Is it worth having a unit test on this method?", "author": "jakeouellette", "createdAt": "2020-02-20T14:46:39Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -222,6 +282,25 @@ private static String readTextFile(File file) {\n     }\n   }\n \n+  /**\n+   * Deletes files from the list until the list size is equal to the maximum. If list is already\n+   * correctly sized, no files are deleted. List should be sorted in the order in which files should\n+   * be deleted.\n+   *\n+   * @return the number of files retained on disk\n+   */\n+  private static int capFilesCount(List<File> files, int maximum) {", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5NjIzNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382096234", "bodyText": "Potentially, but I'll come back to it in another PR.", "author": "mrwillis21", "createdAt": "2020-02-20T16:02:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NDU2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NDg2Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382044867", "bodyText": "does persistEvents instrument this trim in any unit tests (possibly they weren't changed by this PR)", "author": "jakeouellette", "createdAt": "2020-02-20T14:47:04Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -151,22 +178,55 @@ public void finalizeReports(String currentSessionId) {\n   }\n \n   public List<CrashlyticsReport> loadFinalizedReports() {\n-    final List<CrashlyticsReport> reports = new ArrayList<>();\n-    final List<File> fatalReports = getAllFilesInDirectory(fatalReportsDirectory);\n-    for (File reportFile : fatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<CrashlyticsReport> allReports = new ArrayList<>();\n+    final List<File> priorityReports = getAllFilesInDirectory(priorityReportsDirectory);\n+    for (File reportFile : priorityReports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    final List<File> nonFatalReports = getAllFilesInDirectory(nonFatalReportsDirectory);\n-    for (File reportFile : nonFatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<File> reports = getAllFilesInDirectory(reportsDirectory);\n+    for (File reportFile : reports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    return reports;\n+    return allReports;\n+  }\n+\n+  private static boolean isHighPriorityEvent(String eventFileName) {\n+    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  }\n+\n+  private String generateEventFilename(boolean isHighPriority) {\n+    final String eventNumber =\n+        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());\n+    final String prioritySuffix = isHighPriority ? PRIORITY_EVENT_SUFFIX : NORMAL_EVENT_SUFFIX;\n+    return EVENT_FILE_NAME_PREFIX + eventNumber + prioritySuffix;\n   }\n \n   private File getSessionDirectoryById(String sessionId) {\n     return new File(openSessionsDirectory, sessionId);\n   }\n \n+  private static int trimEvents(File sessionDirectory, int maximum) {", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MjA2Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382052067", "bodyText": "It does: https://github.com/firebase/firebase-android-sdk/pull/1255/files#diff-611035c62a50caf0141b0f8ff764617bR158", "author": "mrwillis21", "createdAt": "2020-02-20T14:57:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NDg2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NzgyOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382047829", "bodyText": "why does this return an int if we never use it", "author": "jakeouellette", "createdAt": "2020-02-20T14:51:33Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -151,22 +178,55 @@ public void finalizeReports(String currentSessionId) {\n   }\n \n   public List<CrashlyticsReport> loadFinalizedReports() {\n-    final List<CrashlyticsReport> reports = new ArrayList<>();\n-    final List<File> fatalReports = getAllFilesInDirectory(fatalReportsDirectory);\n-    for (File reportFile : fatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<CrashlyticsReport> allReports = new ArrayList<>();\n+    final List<File> priorityReports = getAllFilesInDirectory(priorityReportsDirectory);\n+    for (File reportFile : priorityReports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    final List<File> nonFatalReports = getAllFilesInDirectory(nonFatalReportsDirectory);\n-    for (File reportFile : nonFatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<File> reports = getAllFilesInDirectory(reportsDirectory);\n+    for (File reportFile : reports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    return reports;\n+    return allReports;\n+  }\n+\n+  private static boolean isHighPriorityEvent(String eventFileName) {\n+    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  }\n+\n+  private String generateEventFilename(boolean isHighPriority) {\n+    final String eventNumber =\n+        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());\n+    final String prioritySuffix = isHighPriority ? PRIORITY_EVENT_SUFFIX : NORMAL_EVENT_SUFFIX;\n+    return EVENT_FILE_NAME_PREFIX + eventNumber + prioritySuffix;\n   }\n \n   private File getSessionDirectoryById(String sessionId) {\n     return new File(openSessionsDirectory, sessionId);\n   }\n \n+  private static int trimEvents(File sessionDirectory, int maximum) {", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MjMwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382052307", "bodyText": "Future planned usage.", "author": "mrwillis21", "createdAt": "2020-02-20T14:58:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0NzgyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0OTQ2NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382049465", "bodyText": "getFilesInDirectory makes an array internally, did we consider just working with the array class? (e.g., by doing Arrays.sort)", "author": "jakeouellette", "createdAt": "2020-02-20T14:53:51Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -151,22 +178,55 @@ public void finalizeReports(String currentSessionId) {\n   }\n \n   public List<CrashlyticsReport> loadFinalizedReports() {\n-    final List<CrashlyticsReport> reports = new ArrayList<>();\n-    final List<File> fatalReports = getAllFilesInDirectory(fatalReportsDirectory);\n-    for (File reportFile : fatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<CrashlyticsReport> allReports = new ArrayList<>();\n+    final List<File> priorityReports = getAllFilesInDirectory(priorityReportsDirectory);\n+    for (File reportFile : priorityReports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    final List<File> nonFatalReports = getAllFilesInDirectory(nonFatalReportsDirectory);\n-    for (File reportFile : nonFatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<File> reports = getAllFilesInDirectory(reportsDirectory);\n+    for (File reportFile : reports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    return reports;\n+    return allReports;\n+  }\n+\n+  private static boolean isHighPriorityEvent(String eventFileName) {\n+    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  }\n+\n+  private String generateEventFilename(boolean isHighPriority) {\n+    final String eventNumber =\n+        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());\n+    final String prioritySuffix = isHighPriority ? PRIORITY_EVENT_SUFFIX : NORMAL_EVENT_SUFFIX;\n+    return EVENT_FILE_NAME_PREFIX + eventNumber + prioritySuffix;\n   }\n \n   private File getSessionDirectoryById(String sessionId) {\n     return new File(openSessionsDirectory, sessionId);\n   }\n \n+  private static int trimEvents(File sessionDirectory, int maximum) {\n+    final List<File> normalPriorityEventFiles =\n+        getFilesInDirectory(\n+            sessionDirectory, CrashlyticsReportPersistence::isNormalPriorityEventFile);\n+    Collections.sort(normalPriorityEventFiles, CrashlyticsReportPersistence::oldestEventFileFirst);", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5MTI5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382091298", "bodyText": "I think, in general, working with lists is simpler than working with arrays, and in this case I'm not sure there's much performance benefit either way. Happy to discuss it further if you feel strongly about it, though.", "author": "mrwillis21", "createdAt": "2020-02-20T15:55:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA0OTQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MDczNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382050735", "bodyText": "do we use // TODO(name): style?", "author": "jakeouellette", "createdAt": "2020-02-20T14:55:52Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -43,36 +43,41 @@\n \n   private static final Charset UTF_8 = Charset.forName(\"UTF-8\");\n \n-  private static final String WORKING_DIRECTORY_NAME = \"fl\";\n+  private static final String WORKING_DIRECTORY_NAME = \"report-persistence\";\n   private static final String OPEN_SESSIONS_DIRECTORY_NAME = \"sessions\";\n-  private static final String FATAL_DIRECTORY_NAME = \"fatal\";\n-  private static final String NON_FATAL_DIRECTORY_NAME = \"non-fatal\";\n+  private static final String PRIORITY_REPORTS_DIRECTORY = \"priority-reports\";\n+  private static final String REPORTS_DIRECTORY = \"reports\";\n \n-  private static final String REPORT_FILE_NAME = \"report.json\";\n+  private static final String REPORT_FILE_NAME = \"report\";\n   private static final String EVENT_FILE_NAME_PREFIX = \"event\";\n-  private static final String EVENT_FILE_NAME_FORMAT = EVENT_FILE_NAME_PREFIX + \"%s.json\";\n-  private static final String EVENT_COUNTER_FORMAT = \"%010d\";\n-\n-  private static final String EVENT_TYPE_FATAL = \"crash\";\n+  private static final int EVENT_COUNTER_WIDTH = 10; // String width of maximum positive int value\n+  private static final String EVENT_COUNTER_FORMAT = \"%0\" + EVENT_COUNTER_WIDTH + \"d\";\n+  private static final int EVENT_NAME_LENGTH =\n+      EVENT_FILE_NAME_PREFIX.length() + EVENT_COUNTER_WIDTH;\n+  private static final String PRIORITY_EVENT_SUFFIX = \"_\";\n+  private static final String NORMAL_EVENT_SUFFIX = \"\";\n \n   private static final CrashlyticsReportJsonTransform TRANSFORM =\n       new CrashlyticsReportJsonTransform();\n \n   private final AtomicInteger eventCounter = new AtomicInteger(0);\n \n   // Storage for sessions that are still being written to\n-  private File openSessionsDirectory;\n+  private final File openSessionsDirectory;\n \n   // Storage for finalized reports\n-  // Keep finalized reports organized by whether or not they contain a fatal event.\n-  private File fatalReportsDirectory;\n-  private File nonFatalReportsDirectory;\n+  private final File priorityReportsDirectory;\n+  private final File reportsDirectory;\n+\n+  // TODO: Add settings override", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MjU1Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382052552", "bodyText": "Not in OSS", "author": "mrwillis21", "createdAt": "2020-02-20T14:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MDczNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1Mjk2Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382052963", "bodyText": "This was a headscratcher for me at first, if a name is [path][name-part][number-part][priority-part], I wasn't realizing eventNameOnly returned [name-part][number-part].", "author": "jakeouellette", "createdAt": "2020-02-20T14:58:58Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -151,22 +178,55 @@ public void finalizeReports(String currentSessionId) {\n   }\n \n   public List<CrashlyticsReport> loadFinalizedReports() {\n-    final List<CrashlyticsReport> reports = new ArrayList<>();\n-    final List<File> fatalReports = getAllFilesInDirectory(fatalReportsDirectory);\n-    for (File reportFile : fatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<CrashlyticsReport> allReports = new ArrayList<>();\n+    final List<File> priorityReports = getAllFilesInDirectory(priorityReportsDirectory);\n+    for (File reportFile : priorityReports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    final List<File> nonFatalReports = getAllFilesInDirectory(nonFatalReportsDirectory);\n-    for (File reportFile : nonFatalReports) {\n-      reports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n+    final List<File> reports = getAllFilesInDirectory(reportsDirectory);\n+    for (File reportFile : reports) {\n+      allReports.add(TRANSFORM.reportFromJson(readTextFile(reportFile)));\n     }\n-    return reports;\n+    return allReports;\n+  }\n+\n+  private static boolean isHighPriorityEvent(String eventFileName) {\n+    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  }\n+\n+  private String generateEventFilename(boolean isHighPriority) {\n+    final String eventNumber =\n+        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());\n+    final String prioritySuffix = isHighPriority ? PRIORITY_EVENT_SUFFIX : NORMAL_EVENT_SUFFIX;\n+    return EVENT_FILE_NAME_PREFIX + eventNumber + prioritySuffix;\n   }\n \n   private File getSessionDirectoryById(String sessionId) {\n     return new File(openSessionsDirectory, sessionId);\n   }\n \n+  private static int trimEvents(File sessionDirectory, int maximum) {\n+    final List<File> normalPriorityEventFiles =\n+        getFilesInDirectory(\n+            sessionDirectory, CrashlyticsReportPersistence::isNormalPriorityEventFile);\n+    Collections.sort(normalPriorityEventFiles, CrashlyticsReportPersistence::oldestEventFileFirst);\n+    return capFilesCount(normalPriorityEventFiles, maximum);\n+  }\n+\n+  private static String eventNameOnly(String eventFileName) {\n+    return eventFileName.substring(0, EVENT_NAME_LENGTH);\n+  }\n+\n+  private static boolean isNormalPriorityEventFile(File dir, String name) {\n+    return name.startsWith(EVENT_FILE_NAME_PREFIX) && !isHighPriorityEvent(name);\n+  }\n+\n+  private static int oldestEventFileFirst(File f1, File f2) {\n+    final String name1 = eventNameOnly(f1.getName());", "originalCommit": "3f81d99566cc060ffe18caf769cfbb041052d472", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MzMzMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382053332", "bodyText": "Open to other name ideas. :)", "author": "mrwillis21", "createdAt": "2020-02-20T14:59:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1Mjk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1MzU3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382053574", "bodyText": "maybe a comment or a slightly adjusted name (e.g., getEventNameAndEventNumber?)", "author": "jakeouellette", "createdAt": "2020-02-20T14:59:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1Mjk2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA5NjgwNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382096804", "bodyText": "\ud83d\udc4d", "author": "mrwillis21", "createdAt": "2020-02-20T16:03:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA1Mjk2Mw=="}], "type": "inlineReview"}, {"oid": "d3cb728176ea4be6512917bc4d3def417aec05d9", "url": "https://github.com/firebase/firebase-android-sdk/commit/d3cb728176ea4be6512917bc4d3def417aec05d9", "message": "Feedback", "committedDate": "2020-02-20T16:04:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEyOTEwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382129102", "bodyText": "I'm prefer startsWith and endsWith here, though I could also see some folks preferring a regex match", "author": "jakeouellette", "createdAt": "2020-02-20T16:54:51Z", "path": "firebase-crashlytics/src/main/java/com/google/firebase/crashlytics/internal/persistence/CrashlyticsReportPersistence.java", "diffHunk": "@@ -190,21 +191,24 @@ public void finalizeReports(String currentSessionId) {\n     return allReports;\n   }\n \n-  private static boolean isHighPriorityEvent(String eventFileName) {\n-    return eventFileName.endsWith(PRIORITY_EVENT_SUFFIX);\n+  private static boolean isHighPriorityEventFile(String fileName) {\n+    return fileName.startsWith(EVENT_FILE_NAME_PREFIX) && fileName.endsWith(PRIORITY_EVENT_SUFFIX);\n   }\n \n-  private String generateEventFilename(boolean isHighPriority) {\n-    final String eventNumber =\n-        String.format(Locale.US, EVENT_COUNTER_FORMAT, eventCounter.getAndIncrement());\n-    final String prioritySuffix = isHighPriority ? PRIORITY_EVENT_SUFFIX : NORMAL_EVENT_SUFFIX;\n-    return EVENT_FILE_NAME_PREFIX + eventNumber + prioritySuffix;\n+  private static boolean isNormalPriorityEventFile(File dir, String name) {\n+    return name.startsWith(EVENT_FILE_NAME_PREFIX) && !name.endsWith(PRIORITY_EVENT_SUFFIX);", "originalCommit": "d3cb728176ea4be6512917bc4d3def417aec05d9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjE0MjY0OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1255#discussion_r382142648", "bodyText": "Pretty certain startsWith and endsWith are more efficient than a regex would be, which is why I used them.", "author": "mrwillis21", "createdAt": "2020-02-20T17:18:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjEyOTEwMg=="}], "type": "inlineReview"}]}