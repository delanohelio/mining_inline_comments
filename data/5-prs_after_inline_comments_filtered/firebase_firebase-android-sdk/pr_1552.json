{"pr_number": 1552, "pr_title": "Make schemas back and forth compatible", "pr_createdAt": "2020-05-11T23:15:14Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1552", "timeline": [{"oid": "76920cfefdedec7e0ce11e70e43b09aac4c104b6", "url": "https://github.com/firebase/firebase-android-sdk/commit/76920cfefdedec7e0ce11e70e43b09aac4c104b6", "message": "Making all migrations backward compatible", "committedDate": "2020-05-11T23:21:52Z", "type": "forcePushed"}, {"oid": "3f74e10b6fd35ca26d7c46e511b03bc8e946afbf", "url": "https://github.com/firebase/firebase-android-sdk/commit/3f74e10b6fd35ca26d7c46e511b03bc8e946afbf", "message": "Merge branch 'master' into schemaManagerFix", "committedDate": "2020-05-15T17:21:15Z", "type": "forcePushed"}, {"oid": "521bc710c54ab7fbe9ab706913f47ea2a3dbb8d6", "url": "https://github.com/firebase/firebase-android-sdk/commit/521bc710c54ab7fbe9ab706913f47ea2a3dbb8d6", "message": "Making all migrations backward compatible", "committedDate": "2020-05-15T17:22:26Z", "type": "forcePushed"}, {"oid": "5edc50017f9ff8d5dad7868e7c5711241fbad3c0", "url": "https://github.com/firebase/firebase-android-sdk/commit/5edc50017f9ff8d5dad7868e7c5711241fbad3c0", "message": "Making all migrations backward compatible", "committedDate": "2020-05-18T22:30:12Z", "type": "forcePushed"}, {"oid": "fb99d33dc64f165accb3d1d38379e622ac0307cd", "url": "https://github.com/firebase/firebase-android-sdk/commit/fb99d33dc64f165accb3d1d38379e622ac0307cd", "message": "Added tests to reason about backward compatibility", "committedDate": "2020-05-18T22:53:51Z", "type": "commit"}, {"oid": "c0e647c2e67db2619dd6fac3cfb2923e759589fa", "url": "https://github.com/firebase/firebase-android-sdk/commit/c0e647c2e67db2619dd6fac3cfb2923e759589fa", "message": "Added state simulations", "committedDate": "2020-05-18T22:53:51Z", "type": "commit"}, {"oid": "e97855cc3e5c52944a02f734f5f47421bd32dd7b", "url": "https://github.com/firebase/firebase-android-sdk/commit/e97855cc3e5c52944a02f734f5f47421bd32dd7b", "message": "Making all migrations backward compatible", "committedDate": "2020-05-18T22:53:51Z", "type": "commit"}, {"oid": "e97855cc3e5c52944a02f734f5f47421bd32dd7b", "url": "https://github.com/firebase/firebase-android-sdk/commit/e97855cc3e5c52944a02f734f5f47421bd32dd7b", "message": "Making all migrations backward compatible", "committedDate": "2020-05-18T22:53:51Z", "type": "forcePushed"}, {"oid": "65ab1bdfdadea2d0f336928335e086a49e2adbd5", "url": "https://github.com/firebase/firebase-android-sdk/commit/65ab1bdfdadea2d0f336928335e086a49e2adbd5", "message": "GoogleJavaFormat", "committedDate": "2020-05-18T23:02:31Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MjMzNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r429742335", "bodyText": "Hi.\nCrash is on the rise in our production due to problems related to this issue.\nWhen do you plan to be Merge?\nIt was confirmed that the v4 migration code was added on April 14. Our service version was up after that day, but errors started to appear that event_payloads already exists. What situations can event_payloads be already created?", "author": "LeeOhHyung", "createdAt": "2020-05-25T05:53:00Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -47,34 +50,28 @@\n           + \"FOREIGN KEY (context_id) REFERENCES transport_contexts(_id) ON DELETE CASCADE)\";\n \n   private static final String CREATE_EVENT_METADATA_SQL_V1 =\n-      \"CREATE TABLE event_metadata \"\n+      \"CREATE TABLE IF NOT EXISTS event_metadata \"\n           + \"(_id INTEGER PRIMARY KEY,\"\n           + \" event_id INTEGER NOT NULL,\"\n           + \" name TEXT NOT NULL,\"\n           + \" value TEXT NOT NULL,\"\n           + \"FOREIGN KEY (event_id) REFERENCES events(_id) ON DELETE CASCADE)\";\n \n   private static final String CREATE_CONTEXTS_SQL_V1 =\n-      \"CREATE TABLE transport_contexts \"\n+      \"CREATE TABLE IF NOT EXISTS transport_contexts \"\n           + \"(_id INTEGER PRIMARY KEY,\"\n           + \" backend_name TEXT NOT NULL,\"\n           + \" priority INTEGER NOT NULL,\"\n           + \" next_request_ms INTEGER NOT NULL)\";\n \n   private static final String CREATE_EVENT_BACKEND_INDEX_V1 =\n-      \"CREATE INDEX events_backend_id on events(context_id)\";\n+      \"CREATE INDEX IF NOT EXISTS events_backend_id on events(context_id)\";\n \n   private static final String CREATE_CONTEXT_BACKEND_PRIORITY_INDEX_V1 =\n-      \"CREATE UNIQUE INDEX contexts_backend_priority on transport_contexts(backend_name, priority)\";\n-\n-  private static final String DROP_EVENTS_SQL = \"DROP TABLE events\";\n-\n-  private static final String DROP_EVENT_METADATA_SQL = \"DROP TABLE event_metadata\";\n-\n-  private static final String DROP_CONTEXTS_SQL = \"DROP TABLE transport_contexts\";\n+      \"CREATE UNIQUE INDEX IF NOT EXISTS contexts_backend_priority on transport_contexts(backend_name, priority)\";\n \n   private static final String CREATE_PAYLOADS_TABLE_V4 =\n-      \"CREATE TABLE event_payloads \"\n+      \"CREATE TABLE IF NOT EXISTS event_payloads \"\n           + \"(sequence_num INTEGER NOT NULL,\"\n           + \" event_id INTEGER NOT NULL,\"\n           + \" bytes BLOB NOT NULL,\"", "originalCommit": "65ab1bdfdadea2d0f336928335e086a49e2adbd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyODY3MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r429928671", "bodyText": "@LeeOhHyung the situation arises if you have datatransport version 2.2.2 in you app, then downgrade to 2.2.1 and then back to 2.2.2.\nThe plan is to fix it asap.", "author": "vkryachko", "createdAt": "2020-05-25T13:14:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MjMzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDUzNTQ3MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r430535471", "bodyText": "Can you share what sequence of events lead to your crashes?\nDid you go back and forth between versions of Firebase products ? Which ones?", "author": "ashwinraghav", "createdAt": "2020-05-26T16:12:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTc0MjMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNjI3OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r429926279", "bodyText": "What's the motivation for removing dropss?", "author": "vkryachko", "createdAt": "2020-05-25T13:09:28Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -153,14 +170,7 @@ public void onUpgrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n   }\n \n   @Override\n-  public void onDowngrade(SQLiteDatabase db, int oldVersion, int newVersion) {\n-    db.execSQL(DROP_EVENTS_SQL);\n-    db.execSQL(DROP_EVENT_METADATA_SQL);\n-    db.execSQL(DROP_CONTEXTS_SQL);\n-    // Indices are dropped automatically when the tables are dropped\n-\n-    onCreate(db);", "originalCommit": "65ab1bdfdadea2d0f336928335e086a49e2adbd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3MzEwNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r430673104", "bodyText": "We want the system to be lossless. Also, it seems impossible to completely clean the slate since we cannot look ahead in time.", "author": "ashwinraghav", "createdAt": "2020-05-26T19:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNjI3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNjY1Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r429926652", "bodyText": "I think is its safer to call a drop here before create table, this will make sure the created table matches the expected schema.", "author": "vkryachko", "createdAt": "2020-05-25T13:10:18Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -47,34 +50,28 @@\n           + \"FOREIGN KEY (context_id) REFERENCES transport_contexts(_id) ON DELETE CASCADE)\";\n \n   private static final String CREATE_EVENT_METADATA_SQL_V1 =\n-      \"CREATE TABLE event_metadata \"\n+      \"CREATE TABLE IF NOT EXISTS event_metadata \"\n           + \"(_id INTEGER PRIMARY KEY,\"\n           + \" event_id INTEGER NOT NULL,\"\n           + \" name TEXT NOT NULL,\"\n           + \" value TEXT NOT NULL,\"\n           + \"FOREIGN KEY (event_id) REFERENCES events(_id) ON DELETE CASCADE)\";\n \n   private static final String CREATE_CONTEXTS_SQL_V1 =\n-      \"CREATE TABLE transport_contexts \"\n+      \"CREATE TABLE IF NOT EXISTS transport_contexts \"\n           + \"(_id INTEGER PRIMARY KEY,\"\n           + \" backend_name TEXT NOT NULL,\"\n           + \" priority INTEGER NOT NULL,\"\n           + \" next_request_ms INTEGER NOT NULL)\";\n \n   private static final String CREATE_EVENT_BACKEND_INDEX_V1 =\n-      \"CREATE INDEX events_backend_id on events(context_id)\";\n+      \"CREATE INDEX IF NOT EXISTS events_backend_id on events(context_id)\";\n \n   private static final String CREATE_CONTEXT_BACKEND_PRIORITY_INDEX_V1 =\n-      \"CREATE UNIQUE INDEX contexts_backend_priority on transport_contexts(backend_name, priority)\";\n-\n-  private static final String DROP_EVENTS_SQL = \"DROP TABLE events\";\n-\n-  private static final String DROP_EVENT_METADATA_SQL = \"DROP TABLE event_metadata\";\n-\n-  private static final String DROP_CONTEXTS_SQL = \"DROP TABLE transport_contexts\";\n+      \"CREATE UNIQUE INDEX IF NOT EXISTS contexts_backend_priority on transport_contexts(backend_name, priority)\";\n \n   private static final String CREATE_PAYLOADS_TABLE_V4 =\n-      \"CREATE TABLE event_payloads \"\n+      \"CREATE TABLE IF NOT EXISTS event_payloads \"", "originalCommit": "65ab1bdfdadea2d0f336928335e086a49e2adbd5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDY3MjA3Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r430672073", "bodyText": "One of the goals was to have the system be lossless.\nAre there a specific sequence of events that you can describe that would lead to faulty schemas?\nI realize this is a mental exercise, but that's the only tool we have to reason about this.\nHere's the PR that demonstrates the failures that we are currently prone to : #1548", "author": "ashwinraghav", "createdAt": "2020-05-26T19:56:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNjY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTkyNzUwMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1552#discussion_r429927501", "bodyText": "It seems that most of these IF NOT EXISTS are redundant, the only place it matters is in event_payloads, also see my comment below regarding event_payloads.", "author": "vkryachko", "createdAt": "2020-05-25T13:12:11Z", "path": "transport/transport-runtime/src/main/java/com/google/android/datatransport/runtime/scheduling/persistence/SchemaManager.java", "diffHunk": "@@ -30,12 +31,14 @@\n   private boolean configured = false;\n \n   // Schema migration guidelines\n-  // 1. Model migration at Vn as an operation performed on the database at Vn-1.\n-  // 2. Append the migration to the ordered list of Migrations in the static initializer\n-  // 3. Write tests that cover the following scenarios migrating to Vn from V0..Vn-1\n+  // 1. Only migrations that are backward compatible are allowed. Developers may move back and forth\n+  // between versions\n+  // 2. Model migration at Vn as an operation performed on the database at Vn-1.\n+  // 3. Append the migration to the ordered list of Migrations in the static initializer\n+  // 4. Write tests that cover the following scenarios migrating to Vn from V0..Vn-1\n   // Note: Migrations handle only upgrades. Downgrades will drop and recreate all tables/indices.\n   private static final String CREATE_EVENTS_SQL_V1 =\n-      \"CREATE TABLE events \"\n+      \"CREATE TABLE IF NOT EXISTS events \"", "originalCommit": "65ab1bdfdadea2d0f336928335e086a49e2adbd5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0422a0dec15de8c0b1e4c801d0e4c82e65eb792b", "url": "https://github.com/firebase/firebase-android-sdk/commit/0422a0dec15de8c0b1e4c801d0e4c82e65eb792b", "message": "minimizing change scope", "committedDate": "2020-05-26T21:47:37Z", "type": "commit"}, {"oid": "a82b6f87a37fd106739f0a499ac464b9b7df208e", "url": "https://github.com/firebase/firebase-android-sdk/commit/a82b6f87a37fd106739f0a499ac464b9b7df208e", "message": "Removing alters", "committedDate": "2020-05-26T22:04:28Z", "type": "commit"}, {"oid": "7c00efb025c0aec50bfa95ba70dd2e8fbe94a37f", "url": "https://github.com/firebase/firebase-android-sdk/commit/7c00efb025c0aec50bfa95ba70dd2e8fbe94a37f", "message": "dropping if exists", "committedDate": "2020-05-26T22:06:28Z", "type": "commit"}]}