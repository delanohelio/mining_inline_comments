{"pr_number": 1802, "pr_title": "Re-implement Unified Emulator Settings", "pr_createdAt": "2020-07-22T14:20:09Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1802", "timeline": [{"oid": "54bb527a5845bc8e517aafcb4885478296a1e04d", "url": "https://github.com/firebase/firebase-android-sdk/commit/54bb527a5845bc8e517aafcb4885478296a1e04d", "message": "Database works", "committedDate": "2020-07-22T13:58:43Z", "type": "commit"}, {"oid": "d815a61bd825c477091ab7a365b40b48e21a7df6", "url": "https://github.com/firebase/firebase-android-sdk/commit/d815a61bd825c477091ab7a365b40b48e21a7df6", "message": "Functions works", "committedDate": "2020-07-22T14:03:28Z", "type": "commit"}, {"oid": "4654ca4f4a462c1c12bbd9cedf430c4e05b9bb15", "url": "https://github.com/firebase/firebase-android-sdk/commit/4654ca4f4a462c1c12bbd9cedf430c4e05b9bb15", "message": "Firestore and Functions work", "committedDate": "2020-07-22T14:18:47Z", "type": "commit"}, {"oid": "130a1a6dde06d931ce3f5a68c6d4b8c79a66fcc3", "url": "https://github.com/firebase/firebase-android-sdk/commit/130a1a6dde06d931ce3f5a68c6d4b8c79a66fcc3", "message": "Uncomment", "committedDate": "2020-07-22T14:21:36Z", "type": "commit"}, {"oid": "24f4808594d6fc7e2ceeaacf958e7e7db49183fb", "url": "https://github.com/firebase/firebase-android-sdk/commit/24f4808594d6fc7e2ceeaacf958e7e7db49183fb", "message": "Fix test NPE", "committedDate": "2020-07-22T15:12:29Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMjIyNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r458922227", "bodyText": "If it should now only be called by useEmulator() methods, why does FirebaseApp need to host this functionality as opposed to each sdk handling it individually?", "author": "vkryachko", "createdAt": "2020-07-22T16:26:37Z", "path": "firebase-common/src/main/java/com/google/firebase/FirebaseApp.java", "diffHunk": "@@ -324,23 +321,14 @@ public static FirebaseApp initializeApp(\n   }\n \n   /**\n-   * Specify which services should access local emulators for this FirebaseApp instance.\n-   *\n-   * <p>For example, if the {@link EmulatorSettings} contain {@link\n-   * com.google.firebase.emulators.EmulatedServiceSettings} for {@link FirebaseDatabase#EMULATOR},\n-   * then calls to Cloud Firestore will communicate with the emulator rather than production.\n-   *\n-   * <p>TODO(samstern): Un-hide this once Firestore, Database, and Functions are implemented\n+   * This should <b>only</b> ever be called from inside FirebaseFoo.useEmulator().", "originalCommit": "24f4808594d6fc7e2ceeaacf958e7e7db49183fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzMjkyMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r458932920", "bodyText": "If we want to have a central place for this config but it does not require a public API, then the recommended approach is to use Components as opposed to adding functionality to FirebaseApp", "author": "vkryachko", "createdAt": "2020-07-22T16:40:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ4ODI0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459488244", "bodyText": "I guess there's no need to centralize it anymore.  We may want it one day, but that's for then I guess.", "author": "samtstern", "createdAt": "2020-07-23T14:23:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQ5MTA1Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459491052", "bodyText": "Actually it's pretty hard to make FirebaseDatabase.getInstance(app, url) work without this centralization ... so I'll do a component.", "author": "samtstern", "createdAt": "2020-07-23T14:27:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUxNjk1Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459516953", "bodyText": "hm actually, rtdb has FirebaseDatabaseComponent, could it be used to host the emulator settings as opposed to having a component in firebase-common?", "author": "vkryachko", "createdAt": "2020-07-23T15:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMjIyNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMjI3Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459532272", "bodyText": "Done.", "author": "samtstern", "createdAt": "2020-07-23T15:22:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMjIyNw=="}], "type": "inlineReview"}, {"oid": "60e30d08c496d15d26c3c2a8c55efe9b268a9ee3", "url": "https://github.com/firebase/firebase-android-sdk/commit/60e30d08c496d15d26c3c2a8c55efe9b268a9ee3", "message": "Make a component", "committedDate": "2020-07-23T14:47:11Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUxMjA5Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459512097", "bodyText": "There will be one instance of EmulatorSettings per FirebaseApp so you don't need to prefix the map keys, and as a result it looks like you can drop the FirebaseApp dependency.", "author": "vkryachko", "createdAt": "2020-07-23T14:54:59Z", "path": "firebase-common/src/main/java/com/google/firebase/emulators/EmulatorSettings.java", "diffHunk": "@@ -0,0 +1,55 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.emulators;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+import com.google.firebase.FirebaseApp;\n+import com.google.firebase.components.Component;\n+import com.google.firebase.components.Dependency;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+/** @hide */\n+public class EmulatorSettings {\n+\n+  @NonNull\n+  public static Component<EmulatorSettings> component() {\n+    return Component.builder(EmulatorSettings.class)\n+        .add(Dependency.required(FirebaseApp.class))\n+        .factory(c -> new EmulatorSettings(c.get(FirebaseApp.class)))\n+        .build();\n+  }\n+\n+  private final Map<String, EmulatedServiceSettings> settings = new HashMap<>();\n+  private final FirebaseApp app;\n+\n+  EmulatorSettings(@NonNull FirebaseApp app) {\n+    this.app = app;\n+  }\n+\n+  @Nullable\n+  public EmulatedServiceSettings get(@NonNull String name) {\n+    return settings.get(getKeyFor(name));\n+  }\n+\n+  public void set(@NonNull String name, @Nullable EmulatedServiceSettings serviceSettings) {\n+    settings.put(getKeyFor(name), serviceSettings);\n+  }\n+\n+  private String getKeyFor(@NonNull String name) {\n+    return this.app.getName() + '-' + name;", "originalCommit": "60e30d08c496d15d26c3c2a8c55efe9b268a9ee3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUzMjEyOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459532128", "bodyText": "Sure.", "author": "samtstern", "createdAt": "2020-07-23T15:21:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTUxMjA5Nw=="}], "type": "inlineReview"}, {"oid": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd", "url": "https://github.com/firebase/firebase-android-sdk/commit/a54e6a6806ef20283cc14a8e6c97a4665dfff6bd", "message": "Remove common component", "committedDate": "2020-07-23T15:21:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjQ3NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459572475", "bodyText": "@vkryachko what's the proper way to do this?  Lint says I shouldn't do this outside of getInstance but I can't store a reference to the component in getInstance since the instance comes from the component ...", "author": "samtstern", "createdAt": "2020-07-23T16:22:14Z", "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -202,7 +192,9 @@ public DatabaseReference getReferenceFromUrl(@NonNull String url) {\n           \"Can't pass null for argument 'url' in \" + \"FirebaseDatabase.getReferenceFromUrl()\");\n     }\n \n-    ParsedUrl parsedUrl = Utilities.parseUrl(url, getEmulatorServiceSettings(this.app));\n+    ParsedUrl parsedUrl =\n+        Utilities.parseUrl(\n+            url, getApp().get(FirebaseDatabaseComponent.class).getEmulatorSettings());", "originalCommit": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYwMTExMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459601112", "bodyText": "In this case FirebaseDatabaseComponent is the owner of FirebaseDatabase instances and responsible for creating them, so I would just recommend passing this component to the FirebaseDatabase's constructor here:\n\n  \n    \n      firebase-android-sdk/firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabaseComponent.java\n    \n    \n         Line 66\n      in\n      cc79cc6\n    \n    \n    \n    \n\n        \n          \n           database = new FirebaseDatabase(app, repo, config);", "author": "vkryachko", "createdAt": "2020-07-23T17:10:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxMjExMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459612110", "bodyText": "Ok so it's safe to pass the component down?  Thanks!", "author": "samtstern", "createdAt": "2020-07-23T17:29:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU3MjQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4Nzc2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459587761", "bodyText": "Why do we need to round-trip through Firebase App? It seems like this could now stay within the SDK.\nI am also not sure if I understand the merits of proposal 2. We now have two places next to each other which both configure settings that can end up conflicting. Isn't the thing that is actually missing from our settings object just an \"isEmulator\" property? Or even - is this something the Emulator could just tell us?", "author": "schmidt-sebastian", "createdAt": "2020-07-23T16:47:35Z", "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -302,9 +294,23 @@ public synchronized void setPersistenceCacheSizeBytes(long cacheSizeInBytes) {\n     this.config.setPersistenceCacheSizeBytes(cacheSizeInBytes);\n   }\n \n-  @Nullable\n-  private static EmulatedServiceSettings getEmulatorServiceSettings(@NonNull FirebaseApp app) {\n-    return app.getEmulatorSettings().getServiceSettings(EMULATOR);\n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Realtime Database emulator.\n+   *\n+   * <p>Note: this must be called before this instance has been used to do any database operations.\n+   *\n+   * @param host the emulator host (ex: 10.0.2.2)\n+   * @param port the emulator port (ex: 9000)\n+   */\n+  public void useEmulator(@NonNull String host, int port) {\n+    if (this.repo != null) {\n+      throw new IllegalStateException(\n+          \"Cannot call useEmulator() after instance has already been initialized.\");\n+    }\n+\n+    getApp()\n+        .get(FirebaseDatabaseComponent.class)\n+        .setEmulatorSettings(new EmulatedServiceSettings(host, port));", "originalCommit": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYwOTU2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459609564", "bodyText": "RTDB has no settings object ... did you mean for Firestore?\nI am at the end of my wits here I truly don't care how we design this.  I only did Proposal #2 because I got told off after proposal #1 was already implemented and merged so I reverted it.  I can't justify this API because it's not mine.\nThe reason this has to be app-scoped is because if you call FirebaseDatabase.getInstance(app, url) we need to apply the same emulator settings.", "author": "samtstern", "createdAt": "2020-07-23T17:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4Nzc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYxNTQ2MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459615460", "bodyText": "I think I meant the url parameter in FirebaseDatabase.getInstance(app, url), which is RTDB's \"Settings\" object. I will review this PR for what it is later today (looks fine glancing over it without too much depth).", "author": "schmidt-sebastian", "createdAt": "2020-07-23T17:34:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4Nzc2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYzNzEwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459637102", "bodyText": "No more going through app.", "author": "samtstern", "createdAt": "2020-07-23T18:12:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTU4Nzc2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyOTQzOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459629438", "bodyText": "What is the expected behavior in the following scenario?\nval custom = Firebase.database(\"http://localhost:8000\")\nreadAndWriteTo(custom)\nval default = Firebase.database.useEmulator(\"example.com\", 123)\nafaict this will cause custom to keep talking to localhost, while default will talk to the emulator.\nDo we want to throw in this case?", "author": "vkryachko", "createdAt": "2020-07-23T17:58:45Z", "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -302,9 +294,23 @@ public synchronized void setPersistenceCacheSizeBytes(long cacheSizeInBytes) {\n     this.config.setPersistenceCacheSizeBytes(cacheSizeInBytes);\n   }\n \n-  @Nullable\n-  private static EmulatedServiceSettings getEmulatorServiceSettings(@NonNull FirebaseApp app) {\n-    return app.getEmulatorSettings().getServiceSettings(EMULATOR);\n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Realtime Database emulator.\n+   *\n+   * <p>Note: this must be called before this instance has been used to do any database operations.\n+   *\n+   * @param host the emulator host (ex: 10.0.2.2)\n+   * @param port the emulator port (ex: 9000)\n+   */\n+  public void useEmulator(@NonNull String host, int port) {\n+    if (this.repo != null) {", "originalCommit": "a54e6a6806ef20283cc14a8e6c97a4665dfff6bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTk3ODM2Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r459978366", "bodyText": "No we do not.  That was something we could have done in the old \"hold it all in FirebaseApp\" proposal but it's no longer a feasible edge case to handle.", "author": "samtstern", "createdAt": "2020-07-24T10:40:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTYyOTQzOA=="}], "type": "inlineReview"}, {"oid": "ed5844bcbbb2c8edac80ac775d23955b87db138e", "url": "https://github.com/firebase/firebase-android-sdk/commit/ed5844bcbbb2c8edac80ac775d23955b87db138e", "message": "Make components hold the settings", "committedDate": "2020-07-23T18:10:54Z", "type": "commit"}, {"oid": "c0a7dd4447e5c702fb8df93714b2faafc13d5749", "url": "https://github.com/firebase/firebase-android-sdk/commit/c0a7dd4447e5c702fb8df93714b2faafc13d5749", "message": "Compilation", "committedDate": "2020-07-23T18:14:45Z", "type": "commit"}, {"oid": "487b89a936e344983acc53a76a3ce9c566cc1343", "url": "https://github.com/firebase/firebase-android-sdk/commit/487b89a936e344983acc53a76a3ce9c566cc1343", "message": "Fix compilation", "committedDate": "2020-07-24T09:37:31Z", "type": "commit"}, {"oid": "ca6fc84734a22a6cd818608eeaa7adff07111d3f", "url": "https://github.com/firebase/firebase-android-sdk/commit/ca6fc84734a22a6cd818608eeaa7adff07111d3f", "message": "Merge remote-tracking branch 'origin/master' into ss-emulator-settings-redo", "committedDate": "2020-07-24T10:13:06Z", "type": "commit"}, {"oid": "cebb525ea02f3805c2cfbdef7cc08071876c983c", "url": "https://github.com/firebase/firebase-android-sdk/commit/cebb525ea02f3805c2cfbdef7cc08071876c983c", "message": "api.txt files, versions, changelogs", "committedDate": "2020-07-24T10:38:20Z", "type": "commit"}, {"oid": "06498788114d587bee8353bab24ded2af2d647e7", "url": "https://github.com/firebase/firebase-android-sdk/commit/06498788114d587bee8353bab24ded2af2d647e7", "message": "No components at all", "committedDate": "2020-07-24T16:47:04Z", "type": "commit"}, {"oid": "ebd55c6ecbd7648042389ccc900645a89e7ce88a", "url": "https://github.com/firebase/firebase-android-sdk/commit/ebd55c6ecbd7648042389ccc900645a89e7ce88a", "message": "Missed a spot", "committedDate": "2020-07-24T16:48:49Z", "type": "commit"}, {"oid": "562b2839d32202a469c6bae41b15e3977c8a1b0e", "url": "https://github.com/firebase/firebase-android-sdk/commit/562b2839d32202a469c6bae41b15e3977c8a1b0e", "message": "internalHost and nullability", "committedDate": "2020-07-24T17:03:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3MTQ5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460171499", "bodyText": "Can you mark this Nullable?", "author": "schmidt-sebastian", "createdAt": "2020-07-24T16:50:27Z", "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -40,20 +37,12 @@\n  */\n public class FirebaseDatabase {\n \n-  /**\n-   * Emulator identifier. See {@link FirebaseApp#enableEmulators(EmulatorSettings)}\n-   *\n-   * <p>TODO(samstern): Un-hide this once Firestore, Database, and Functions are implemented\n-   *\n-   * @hide\n-   */\n-  public static final FirebaseEmulator EMULATOR = FirebaseEmulator.forName(\"database\");\n-\n   private static final String SDK_VERSION = BuildConfig.VERSION_NAME;\n \n   private final FirebaseApp app;\n   private final RepoInfo repoInfo;\n   private final DatabaseConfig config;\n+  private EmulatedServiceSettings emulatorSettings;", "originalCommit": "ebd55c6ecbd7648042389ccc900645a89e7ce88a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTMzMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460179331", "bodyText": "Stray semicolon", "author": "schmidt-sebastian", "createdAt": "2020-07-24T17:05:37Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -217,6 +203,25 @@ public void setFirestoreSettings(@NonNull FirebaseFirestoreSettings settings) {\n     }\n   }\n \n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Cloud Firestore emulator.\n+   *\n+   * <p>Note: this must be called before this instance has been used to do any operations.\n+   *\n+   * @param host the emulator host (ex: 10.0.2.2)\n+   * @param port the emulator port (ex: 8080)\n+   */\n+  public void useEmulator(@NonNull String host, int port) {\n+    if (this.client != null) {\n+      throw new IllegalStateException(\n+          \"Cannot call useEmulator() after instance has already been initialized.\");\n+    }\n+\n+    this.emulatorSettings = new EmulatedServiceSettings(host, port);\n+    ;", "originalCommit": "ebd55c6ecbd7648042389ccc900645a89e7ce88a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE3OTUzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460179530", "bodyText": "As discussed offline, internalHost needs to be updated as well.", "author": "schmidt-sebastian", "createdAt": "2020-07-24T17:06:03Z", "path": "firebase-database/src/main/java/com/google/firebase/database/core/RepoInfo.java", "diffHunk": "@@ -61,6 +63,15 @@ public URI getConnectionURL(String optLastSessionId) {\n     return URI.create(url);\n   }\n \n+  public void applyEmulatorSettings(@Nullable EmulatedServiceSettings settings) {\n+    if (settings == null) {\n+      return;\n+    }\n+\n+    this.host = settings.getHost() + \":\" + settings.getPort();", "originalCommit": "ebd55c6ecbd7648042389ccc900645a89e7ce88a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4MDE1OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460180158", "bodyText": "This is allowed in the RTDB proposal. No strong opinion here, but just wanted to point this out.", "author": "schmidt-sebastian", "createdAt": "2020-07-24T17:07:19Z", "path": "firebase-firestore/src/main/java/com/google/firebase/firestore/FirebaseFirestore.java", "diffHunk": "@@ -244,7 +249,7 @@ private FirebaseFirestoreSettings mergeEmulatorSettings(\n \n     if (!FirebaseFirestoreSettings.DEFAULT_HOST.equals(settings.getHost())) {\n       throw new IllegalStateException(\n-          \"Cannot specify the host in FirebaseFirestoreSettings when EmulatedServiceSettings is provided.\");\n+          \"Cannot specify the host in FirebaseFirestoreSettings when emulator settings are provided.\");", "originalCommit": "ebd55c6ecbd7648042389ccc900645a89e7ce88a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4Mjc4NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460182784", "bodyText": "So would you prefer the Firestore settings override?", "author": "samtstern", "createdAt": "2020-07-24T17:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4MDE1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4OTM5Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460189393", "bodyText": "I do, but I defer to your judgement.", "author": "schmidt-sebastian", "createdAt": "2020-07-24T17:25:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE4MDE1OA=="}], "type": "inlineReview"}, {"oid": "370962c058afa96097255794c3ae5c4d791c6342", "url": "https://github.com/firebase/firebase-android-sdk/commit/370962c058afa96097255794c3ae5c4d791c6342", "message": "Sebastian feedback", "committedDate": "2020-07-24T17:15:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MTEyOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460191128", "bodyText": "I think this call needs to happen after the if statement below. You probably want to support this:\nvar db = FirebaseDatabase.getInstance('http://foo');\ndb.useEmulator('localhost');\ndb.getReferenceFromUrl('http://foo/bar');\n\nPlease add test as well.", "author": "schmidt-sebastian", "createdAt": "2020-07-24T17:29:16Z", "path": "firebase-database/src/main/java/com/google/firebase/database/FirebaseDatabase.java", "diffHunk": "@@ -202,7 +193,9 @@ public DatabaseReference getReferenceFromUrl(@NonNull String url) {\n           \"Can't pass null for argument 'url' in \" + \"FirebaseDatabase.getReferenceFromUrl()\");\n     }\n \n-    ParsedUrl parsedUrl = Utilities.parseUrl(url, getEmulatorServiceSettings(this.app));\n+    ParsedUrl parsedUrl = Utilities.parseUrl(url);\n+    parsedUrl.repoInfo.applyEmulatorSettings(this.emulatorSettings);", "originalCommit": "370962c058afa96097255794c3ae5c4d791c6342", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MjYwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460192607", "bodyText": "There is a test for this case actually.  getReferenceFromUrl is overridden by emulator settings.  We'll use the namespace from the URL, but the emulator host/port.", "author": "samtstern", "createdAt": "2020-07-24T17:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MTEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5OTI2Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460199267", "bodyText": "What about:\nvar db = FirebaseDatabase.getInstance('http://foo');\ndb.useEmulator('localhost');\ndb.getReferenceFromUrl('http://bar/baz');\n\nThat doesn't throw anymore, does it?", "author": "schmidt-sebastian", "createdAt": "2020-07-24T17:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MTEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDIwMTIxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460201218", "bodyText": "Will add that to the test.", "author": "samtstern", "createdAt": "2020-07-24T17:49:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MTEyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDE5MTc0Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1802#discussion_r460191742", "bodyText": "s/FirebaseDatabase/FirebaseFunctions/", "author": "schmidt-sebastian", "createdAt": "2020-07-24T17:30:25Z", "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -213,17 +209,24 @@ URL getURL(String function) {\n     }\n   }\n \n-  /**\n-   * Changes this instance to point to a Cloud Functions emulator running locally. See\n-   * https://firebase.google.com/docs/functions/local-emulator\n-   *\n-   * @param origin The origin of the local emulator, such as \"http://10.0.2.2:5005\".\n-   */\n+  /** @deprecated see {@link #useEmulator(String, int)} */\n   public void useFunctionsEmulator(@NonNull String origin) {\n     Preconditions.checkNotNull(origin, \"origin cannot be null\");\n     urlFormat = origin + \"/%2$s/%1$s/%3$s\";\n   }\n \n+  /**\n+   * Modify this FirebaseDatabase instance to communicate with the Cloud Functions emulator.", "originalCommit": "370962c058afa96097255794c3ae5c4d791c6342", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4b1b9ec76742887de70f4f13dfa25e7b5dd8933a", "url": "https://github.com/firebase/firebase-android-sdk/commit/4b1b9ec76742887de70f4f13dfa25e7b5dd8933a", "message": "Typo, remove throw", "committedDate": "2020-07-24T17:39:29Z", "type": "commit"}, {"oid": "2cbb7b9b8670501249d328882735d73aa80f3ea5", "url": "https://github.com/firebase/firebase-android-sdk/commit/2cbb7b9b8670501249d328882735d73aa80f3ea5", "message": "Fix functions test", "committedDate": "2020-07-24T17:46:18Z", "type": "commit"}, {"oid": "911fea0f32e6c4867a1ee1891e98b3312ff7069f", "url": "https://github.com/firebase/firebase-android-sdk/commit/911fea0f32e6c4867a1ee1891e98b3312ff7069f", "message": "One more test", "committedDate": "2020-07-24T17:52:59Z", "type": "commit"}, {"oid": "9fae4496baa0523de01073b627d0cdb2844fcf29", "url": "https://github.com/firebase/firebase-android-sdk/commit/9fae4496baa0523de01073b627d0cdb2844fcf29", "message": "Remove failing test, not relevant", "committedDate": "2020-07-27T10:49:39Z", "type": "commit"}, {"oid": "e351fa850d1db96d50a750ea9619eb39e008a69f", "url": "https://github.com/firebase/firebase-android-sdk/commit/e351fa850d1db96d50a750ea9619eb39e008a69f", "message": "Compilation error", "committedDate": "2020-07-27T11:43:15Z", "type": "commit"}]}