{"pr_number": 2100, "pr_title": "Add custom domain support to callable functions", "pr_createdAt": "2020-10-24T21:37:01Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2100", "timeline": [{"oid": "afeab91daf7b6eed38d7edf85a415f73226bd72b", "url": "https://github.com/firebase/firebase-android-sdk/commit/afeab91daf7b6eed38d7edf85a415f73226bd72b", "message": "Add custom domain support to callable functions", "committedDate": "2020-10-24T21:25:58Z", "type": "commit"}, {"oid": "a5d9a9f9ca7e2e83e3bfbde6b4a7c20aa8d7a661", "url": "https://github.com/firebase/firebase-android-sdk/commit/a5d9a9f9ca7e2e83e3bfbde6b4a7c20aa8d7a661", "message": "fix formatting", "committedDate": "2020-10-24T21:46:05Z", "type": "commit"}, {"oid": "eda2e66b45947fb72bf62937f935e4cb3ae68a42", "url": "https://github.com/firebase/firebase-android-sdk/commit/eda2e66b45947fb72bf62937f935e4cb3ae68a42", "message": "update api.txt", "committedDate": "2020-10-24T21:49:27Z", "type": "commit"}, {"oid": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9", "url": "https://github.com/firebase/firebase-android-sdk/commit/02f76a2e22a3339a622c80b190ed1ecca4f5cda9", "message": "Add test for domains with path", "committedDate": "2020-10-24T22:05:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Njk2NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r511856964", "bodyText": "I think we can just use the standard library URL class and do new URL(regionOrCustomDomain) and then catch MalformedUrlException:\nhttps://docs.oracle.com/javase/7/docs/api/java/net/URL.html#URL(java.lang.String)\nNot quite as good as what you have but worth saving a whole dependency.", "author": "samtstern", "createdAt": "2020-10-26T10:26:44Z", "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -73,26 +74,40 @@\n   private final String projectId;\n \n   // The region to use for all function references.\n-  private final String region;\n+  @Nullable private final String region;\n+\n+  // A custom domain for the http trigger, such as \"https://mydomain.com\"\n+  @Nullable private final String customDomain;\n \n   // The format to use for constructing urls from region, projectId, and name.\n   private String urlFormat = \"https://%1$s-%2$s.cloudfunctions.net/%3$s\";\n \n+  // Allowed custom domain protocols.\n+  private String[] customDomainSchemes = {\"http\", \"https\"};\n+\n   // Emulator settings\n   @Nullable private EmulatedServiceSettings emulatorSettings;\n \n   FirebaseFunctions(\n       FirebaseApp app,\n       Context context,\n       String projectId,\n-      String region,\n+      String regionOrCustomDomain,\n       ContextProvider contextProvider) {\n     this.app = app;\n     this.client = new OkHttpClient();\n     this.serializer = new Serializer();\n     this.contextProvider = Preconditions.checkNotNull(contextProvider);\n     this.projectId = Preconditions.checkNotNull(projectId);\n-    this.region = Preconditions.checkNotNull(region);\n+\n+    UrlValidator validator = new UrlValidator(customDomainSchemes);", "originalCommit": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMTMyMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r512331320", "bodyText": "Done", "author": "kroikie", "createdAt": "2020-10-26T23:35:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1Njk2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NzMyMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r511857321", "bodyText": "If you look at the iOS and JS PRs we set region to the default value here.  This is needed in case the person calls useEmulator", "author": "samtstern", "createdAt": "2020-10-26T10:27:22Z", "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -73,26 +74,40 @@\n   private final String projectId;\n \n   // The region to use for all function references.\n-  private final String region;\n+  @Nullable private final String region;\n+\n+  // A custom domain for the http trigger, such as \"https://mydomain.com\"\n+  @Nullable private final String customDomain;\n \n   // The format to use for constructing urls from region, projectId, and name.\n   private String urlFormat = \"https://%1$s-%2$s.cloudfunctions.net/%3$s\";\n \n+  // Allowed custom domain protocols.\n+  private String[] customDomainSchemes = {\"http\", \"https\"};\n+\n   // Emulator settings\n   @Nullable private EmulatedServiceSettings emulatorSettings;\n \n   FirebaseFunctions(\n       FirebaseApp app,\n       Context context,\n       String projectId,\n-      String region,\n+      String regionOrCustomDomain,\n       ContextProvider contextProvider) {\n     this.app = app;\n     this.client = new OkHttpClient();\n     this.serializer = new Serializer();\n     this.contextProvider = Preconditions.checkNotNull(contextProvider);\n     this.projectId = Preconditions.checkNotNull(projectId);\n-    this.region = Preconditions.checkNotNull(region);\n+\n+    UrlValidator validator = new UrlValidator(customDomainSchemes);\n+    if (validator.isValid(regionOrCustomDomain)) {\n+      this.region = null;", "originalCommit": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjMzMTU0OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r512331548", "bodyText": "Done", "author": "kroikie", "createdAt": "2020-10-26T23:36:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NzMyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NzgyNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r511857825", "bodyText": "See my comment below, but add a test about using useEmulator with a custom domain.  I think it would fail right now.", "author": "samtstern", "createdAt": "2020-10-26T10:28:15Z", "path": "firebase-functions/src/androidTest/java/com/google/firebase/functions/FirebaseFunctionsTest.java", "diffHunk": "@@ -38,6 +38,14 @@ public void testGetUrl() {\n     functions = FirebaseFunctions.getInstance(app);\n     url = functions.getURL(\"my-endpoint\");\n     assertEquals(\"https://us-central1-my-project.cloudfunctions.net/my-endpoint\", url.toString());\n+\n+    functions = FirebaseFunctions.getInstance(app, \"https://mydomain.com\");\n+    url = functions.getURL(\"my-endpoint\");\n+    assertEquals(\"https://mydomain.com/my-endpoint\", url.toString());\n+\n+    functions = FirebaseFunctions.getInstance(app, \"https://mydomain.com/foo\");\n+    url = functions.getURL(\"my-endpoint\");\n+    assertEquals(\"https://mydomain.com/foo/my-endpoint\", url.toString());", "originalCommit": "02f76a2e22a3339a622c80b190ed1ecca4f5cda9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjM0NzgwMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r512347800", "bodyText": "Done.", "author": "kroikie", "createdAt": "2020-10-27T00:33:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTg1NzgyNQ=="}], "type": "inlineReview"}, {"oid": "bc0e4389dbfb140600ee03e03b679453a0ea5ac3", "url": "https://github.com/firebase/firebase-android-sdk/commit/bc0e4389dbfb140600ee03e03b679453a0ea5ac3", "message": "add useEmulator test", "committedDate": "2020-10-27T00:34:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NjM0Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r512586347", "bodyText": "Nit: you could just move this logic inside of the try/catch and not need isRegion at all.  But totally fine either way.", "author": "samtstern", "createdAt": "2020-10-27T10:48:11Z", "path": "firebase-functions/src/main/java/com/google/firebase/functions/FirebaseFunctions.java", "diffHunk": "@@ -85,14 +88,29 @@\n       FirebaseApp app,\n       Context context,\n       String projectId,\n-      String region,\n+      String regionOrCustomDomain,\n       ContextProvider contextProvider) {\n     this.app = app;\n     this.client = new OkHttpClient();\n     this.serializer = new Serializer();\n     this.contextProvider = Preconditions.checkNotNull(contextProvider);\n     this.projectId = Preconditions.checkNotNull(projectId);\n-    this.region = Preconditions.checkNotNull(region);\n+\n+    boolean isRegion;\n+    try {\n+      new URL(regionOrCustomDomain);\n+      isRegion = false;\n+    } catch (MalformedURLException malformedURLException) {\n+      isRegion = true;\n+    }\n+\n+    if (isRegion) {", "originalCommit": "bc0e4389dbfb140600ee03e03b679453a0ea5ac3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjgzNDgxMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r512834812", "bodyText": "Since region and customDomain are final they can't be set both in the try and the catch.\nI'm gussing that Java considers the whole try and not just the lines that could cause the exception.", "author": "kroikie", "createdAt": "2020-10-27T16:18:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NjM0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjg0MjgxOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2100#discussion_r512842819", "bodyText": "Ah interesting, that's fair then!", "author": "samtstern", "createdAt": "2020-10-27T16:28:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjU4NjM0Nw=="}], "type": "inlineReview"}]}