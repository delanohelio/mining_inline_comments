{"pr_number": 2222, "pr_title": "Standardize support for Firebase products that integrate with Remote Config.", "pr_createdAt": "2020-12-02T19:25:37Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/2222", "timeline": [{"oid": "f037c14cecf463119d203704e7f35354b875087e", "url": "https://github.com/firebase/firebase-android-sdk/commit/f037c14cecf463119d203704e7f35354b875087e", "message": "More logging for personalization.", "committedDate": "2020-12-02T19:21:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ2MTExOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r555461118", "bodyText": "Do we need to use a Converter for this? Seems like we're just converting constants and it adds the guava dependency.", "author": "danasilver", "createdAt": "2021-01-12T01:56:35Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -16,22 +16,41 @@\n \n import android.os.Bundle;\n import androidx.annotation.NonNull;\n+import com.google.common.base.CaseFormat;\n+import com.google.common.base.Converter;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_choice\";\n+  public static final String ARM_KEY = \"arm_key\";\n+  public static final String ARM_VALUE = \"arm_value\";\n+  public static final String PERSONALIZATION_ID = \"personalization_id\";\n+  public static final String ARM_INDEX = \"arm_index\";\n+  public static final String GROUP = \"group\";\n+\n+  public static final String ANALYTICS_PULL_EVENT_INTERNAL = \"_fpc\";\n+  public static final String CHOICE_ID = \"choiceId\";\n+  public static final String CHOICE_ID_KEY = \"_fpid\";\n+\n+  private static final Converter<String, String> CONVERTER =", "originalCommit": "f037c14cecf463119d203704e7f35354b875087e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NjAyOTM1MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r556029350", "bodyText": "Removed the Converter. Is Guava a heavy dependency?", "author": "vic-flair", "createdAt": "2021-01-12T19:36:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTQ2MTExOA=="}], "type": "inlineReview"}, {"oid": "ffb9786bfd40006b539cb1478d03e560d9c1a16d", "url": "https://github.com/firebase/firebase-android-sdk/commit/ffb9786bfd40006b539cb1478d03e560d9c1a16d", "message": "Merge branch 'master' into vlum.p13n-2", "committedDate": "2021-01-12T19:25:51Z", "type": "commit"}, {"oid": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "url": "https://github.com/firebase/firebase-android-sdk/commit/3fdff9f1ffe4c690395d85c9351372bc151e8a06", "message": "Remove Converter.", "committedDate": "2021-01-12T19:27:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzY5ODY0Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557698646", "bodyText": "I think this can be initialized with the variable declaration rather than in the constructor.", "author": "danasilver", "createdAt": "2021-01-14T21:06:13Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,21 +17,37 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_assignment\";\n+  public static final String ARM_KEY = \"arm_key\";\n+  public static final String ARM_VALUE = \"arm_value\";\n+  public static final String PERSONALIZATION_ID = \"personalizationId\";\n+  public static final String PERSONALIZATION_ID_KEY = \"personalization_id\";\n+  public static final String ARM_INDEX = \"armIndex\";\n+  public static final String ARM_INDEX_KEY = \"arm_index\";\n+  public static final String GROUP = \"group\";\n+\n+  public static final String ANALYTICS_PULL_EVENT_INTERNAL = \"_fpc\";\n+  public static final String CHOICE_ID = \"choiceId\";\n+  public static final String CHOICE_ID_KEY = \"_fpid\";\n \n   /** The app's Firebase Analytics client. */\n   private final AnalyticsConnector analyticsConnector;\n \n+  /** A map of Remote Config parameter key to Personalization ID. */\n+  private final Map<String, String> armsCache;\n+\n   /** Creates an instance of {@code Personalization}. */\n   public Personalization(@NonNull AnalyticsConnector analyticsConnector) {\n     this.analyticsConnector = analyticsConnector;\n+    armsCache = Collections.synchronizedMap(new HashMap<String, String>());", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcwOTkwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557709907", "bodyText": "Looks like this is used to prevent logging the same key and personalization id combination twice? Do we expect the personalization id to change for a particular key? Maybe we can rename the variable to reflect the usage. Is it necessary to prevent logging twice? If it's necessary can we add a test for it?", "author": "danasilver", "createdAt": "2021-01-14T21:28:23Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,21 +17,37 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_assignment\";\n+  public static final String ARM_KEY = \"arm_key\";\n+  public static final String ARM_VALUE = \"arm_value\";\n+  public static final String PERSONALIZATION_ID = \"personalizationId\";\n+  public static final String PERSONALIZATION_ID_KEY = \"personalization_id\";\n+  public static final String ARM_INDEX = \"armIndex\";\n+  public static final String ARM_INDEX_KEY = \"arm_index\";\n+  public static final String GROUP = \"group\";\n+\n+  public static final String ANALYTICS_PULL_EVENT_INTERNAL = \"_fpc\";\n+  public static final String CHOICE_ID = \"choiceId\";\n+  public static final String CHOICE_ID_KEY = \"_fpid\";\n \n   /** The app's Firebase Analytics client. */\n   private final AnalyticsConnector analyticsConnector;\n \n+  /** A map of Remote Config parameter key to Personalization ID. */\n+  private final Map<String, String> armsCache;", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzc2OTAzMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557769031", "bodyText": "Oh, that's actually supposed to be choice ID. I think I forgot to change it when we were discussing what fields should be called. We do expect choice IDs to change, and we need to log each at least once. There will probably some de-duping on the back-end too, but this is just a quick way to reduce some of that work.", "author": "vic-flair", "createdAt": "2021-01-14T23:37:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcwOTkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcxMDUzNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557710534", "bodyText": "Would consider adding a comment above the block saying what the \"key\" and non-key named variables are used for. Maybe could say ...LOG_KEY, too?", "author": "danasilver", "createdAt": "2021-01-14T21:29:33Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,21 +17,37 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_assignment\";\n+  public static final String ARM_KEY = \"arm_key\";", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcyMTY1OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557721658", "bodyText": "Could us the or operator from AdditionalMatchers to get either of ANALYTICS_PULL_EVENT or ANALYTICS_PULL_EVENT_INTERNAL.", "author": "danasilver", "createdAt": "2021-01-14T21:51:31Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/PersonalizationTest.java", "diffHunk": "@@ -74,8 +82,7 @@ public void setUp() {\n \n     doAnswer(invocation -> FAKE_LOGS.add(invocation.getArgument(2)))\n         .when(mockAnalyticsConnector)\n-        .logEvent(\n-            eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n+        .logEvent(eq(ANALYTICS_ORIGIN_PERSONALIZATION), anyString(), any(Bundle.class));", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcyMjAyOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557722028", "bodyText": "Do we want to verify the other (internal) log event here, too? Could also update the test name since it's logged twice (internal and external) - maybe logArmActive_singlePersonalizationKey_loggedInternallyAndExternally", "author": "danasilver", "createdAt": "2021-01-14T21:52:19Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/PersonalizationTest.java", "diffHunk": "@@ -99,12 +105,16 @@ public void logArmActive_singlePersonalizationKey_loggedOnce() {\n     verify(mockAnalyticsConnector, times(1))\n         .logEvent(\n             eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n-    assertThat(FAKE_LOGS).hasSize(1);\n+    verify(mockAnalyticsConnector, times(1))", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU4MjQyNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558582426", "bodyText": "\ud83d\udc4d  I'd vote to use the _loggedInternallyAndExternally suffix for the test below too, ie logArmActive_multiplePersonalizationKeys_loggedMultiple --> logArmActive_multiplePersonalizationKeys_loggedInternallyAndExternally", "author": "erikeldridge", "createdAt": "2021-01-15T20:43:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcyMjAyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcyODYwNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557728607", "bodyText": "Doesn't seem like there's a way to check if the log statements succeed or fail. Is it ok if one succeeds without the other?", "author": "danasilver", "createdAt": "2021-01-14T22:05:11Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +74,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n+    String personalizationId = metadata.optString(PERSONALIZATION_ID);\n+    if (personalizationId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {\n+      if (armsCache.get(key) == personalizationId) {\n+        return;\n+      }\n+      armsCache.put(key, personalizationId);\n+    }\n+\n     Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n+    params.putString(ARM_KEY, key);\n     params.putString(ARM_VALUE, values.optString(key));\n+    params.putString(PERSONALIZATION_ID_KEY, personalizationId);\n+    params.putInt(ARM_INDEX_KEY, metadata.optInt(ARM_INDEX, -1));\n+    params.putString(GROUP, metadata.optString(GROUP));\n     analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzc2OTA2NQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557769065", "bodyText": "I think it should be OK. As long as it's not happening too frequently, the stats should be close enough.", "author": "vic-flair", "createdAt": "2021-01-14T23:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzcyODYwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzc0MDIzMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557740232", "bodyText": "Might call these logParams and internalLogParams since \"parameters\" otherwise refers to RC parameters.", "author": "danasilver", "createdAt": "2021-01-14T22:29:57Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +74,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n+    String personalizationId = metadata.optString(PERSONALIZATION_ID);\n+    if (personalizationId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {\n+      if (armsCache.get(key) == personalizationId) {\n+        return;\n+      }\n+      armsCache.put(key, personalizationId);\n+    }\n+\n     Bundle params = new Bundle();", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzc0NDY5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557744699", "bodyText": "Same question here - should we test the internal event?", "author": "danasilver", "createdAt": "2021-01-14T22:38:34Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/PersonalizationTest.java", "diffHunk": "@@ -115,16 +125,20 @@ public void logArmActive_multiplePersonalizationKeys_loggedMultiple() {\n     verify(mockAnalyticsConnector, times(2))\n         .logEvent(\n             eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n-    assertThat(FAKE_LOGS).hasSize(2);\n+    verify(mockAnalyticsConnector, times(2))\n+        .logEvent(\n+            eq(ANALYTICS_ORIGIN_PERSONALIZATION),\n+            eq(ANALYTICS_PULL_EVENT_INTERNAL),\n+            any(Bundle.class));\n+    assertThat(FAKE_LOGS).hasSize(4);\n \n     Bundle params1 = new Bundle();\n-    params1.putString(ARM_KEY, \"id1\");\n-    params1.putString(ARM_VALUE, \"value1\");\n-    assertThat(FAKE_LOGS.get(0).toString()).isEqualTo(params1.toString());\n-\n+    params1.putString(CHOICE_ID_KEY, \"id1\");\n     Bundle params2 = new Bundle();\n-    params2.putString(ARM_KEY, \"id2\");\n-    params2.putString(ARM_VALUE, \"value2\");\n-    assertThat(FAKE_LOGS.get(1).toString()).isEqualTo(params2.toString());\n+    params2.putString(CHOICE_ID_KEY, \"id2\");\n+    assertThat(FAKE_LOGS)", "originalCommit": "3fdff9f1ffe4c690395d85c9351372bc151e8a06", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "url": "https://github.com/firebase/firebase-android-sdk/commit/10daf06a6c18b5431bce6d29830bcbba2164c26d", "message": "Check cache for choice ID and add more asserts in tests.", "committedDate": "2021-01-15T00:49:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgyNzg4Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557827882", "bodyText": "ARM_LOG_KEY?", "author": "danasilver", "createdAt": "2021-01-15T02:44:10Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,18 +17,36 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  // Constants with LOG_KEY suffix are how the corresponding ones without it are identified on\n+  // Google Analytics.\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_assignment\";\n+  public static final String ARM_KEY = \"arm_key\";", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODc2Mzg2MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558763860", "bodyText": "Changed it to EXTERNAL_RC_PARAMETER_PARAM per Erik's comment.", "author": "vic-flair", "createdAt": "2021-01-16T02:11:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgyNzg4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgyODYzOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557828639", "bodyText": "I'd still like to rename this to something more descriptive. Maybe loggedArms or loggedChoiceIds?", "author": "danasilver", "createdAt": "2021-01-15T02:46:55Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,18 +17,36 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  // Constants with LOG_KEY suffix are how the corresponding ones without it are identified on\n+  // Google Analytics.\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_assignment\";\n+  public static final String ARM_KEY = \"arm_key\";\n+  public static final String ARM_VALUE = \"arm_value\";\n+  public static final String PERSONALIZATION_ID = \"personalizationId\";\n+  public static final String PERSONALIZATION_ID_LOG_KEY = \"personalization_id\";\n+  public static final String ARM_INDEX = \"armIndex\";\n+  public static final String ARM_INDEX_LOG_KEY = \"arm_index\";\n+  public static final String GROUP = \"group\";\n+\n+  public static final String ANALYTICS_PULL_EVENT_INTERNAL = \"_fpc\";\n+  public static final String CHOICE_ID = \"choiceId\";\n+  public static final String CHOICE_ID_LOG_KEY = \"_fpid\";\n \n   /** The app's Firebase Analytics client. */\n   private final AnalyticsConnector analyticsConnector;\n \n+  /** A map of Remote Config parameter key to choice ID. */\n+  private final Map<String, String> armsCache =", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU4NjM5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558586399", "bodyText": "\ud83d\udc4d  I agree that'd be helpful. I'd vote for loggedChoiceIds since the values are choice IDs.", "author": "erikeldridge", "createdAt": "2021-01-15T20:52:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgyODYzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgyOTYxNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557829614", "bodyText": "Would separate these from the logParams with an empty line for readability. Would it make sense to construct the bundles outside the test as static class values?", "author": "danasilver", "createdAt": "2021-01-15T02:50:05Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/PersonalizationTest.java", "diffHunk": "@@ -88,43 +103,79 @@ public void logArmActive_nonPersonalizationKey_notLogged() {\n \n     verify(mockAnalyticsConnector, times(0))\n         .logEvent(\n-            eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n+            eq(ANALYTICS_ORIGIN_PERSONALIZATION),\n+            or(eq(ANALYTICS_PULL_EVENT), eq(ANALYTICS_PULL_EVENT_INTERNAL)),\n+            any(Bundle.class));\n     assertThat(FAKE_LOGS).isEmpty();\n   }\n \n   @Test\n-  public void logArmActive_singlePersonalizationKey_loggedOnce() {\n+  public void logArmActive_singlePersonalizationKey_loggedInternallyAndExternally() {\n     personalization.logArmActive(\"key1\", CONFIG_CONTAINER);\n \n     verify(mockAnalyticsConnector, times(1))\n         .logEvent(\n             eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n-    assertThat(FAKE_LOGS).hasSize(1);\n+    verify(mockAnalyticsConnector, times(1))\n+        .logEvent(\n+            eq(ANALYTICS_ORIGIN_PERSONALIZATION),\n+            eq(ANALYTICS_PULL_EVENT_INTERNAL),\n+            any(Bundle.class));\n+    assertThat(FAKE_LOGS).hasSize(2);\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, \"id1\");\n-    params.putString(ARM_VALUE, \"value1\");\n-    assertThat(FAKE_LOGS.get(0).toString()).isEqualTo(params.toString());\n+    Bundle logParams = new Bundle();\n+    logParams.putString(ARM_KEY, \"key1\");\n+    logParams.putString(ARM_VALUE, \"value1\");\n+    logParams.putString(PERSONALIZATION_ID_LOG_KEY, \"p13n1\");\n+    logParams.putInt(ARM_INDEX_LOG_KEY, 0);\n+    logParams.putString(GROUP, \"BASELINE\");\n+    Bundle internalLogParams = new Bundle();", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NzgyOTcxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r557829718", "bodyText": "Same here - newline would help readability.", "author": "danasilver", "createdAt": "2021-01-15T02:50:24Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/PersonalizationTest.java", "diffHunk": "@@ -88,43 +103,79 @@ public void logArmActive_nonPersonalizationKey_notLogged() {\n \n     verify(mockAnalyticsConnector, times(0))\n         .logEvent(\n-            eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n+            eq(ANALYTICS_ORIGIN_PERSONALIZATION),\n+            or(eq(ANALYTICS_PULL_EVENT), eq(ANALYTICS_PULL_EVENT_INTERNAL)),\n+            any(Bundle.class));\n     assertThat(FAKE_LOGS).isEmpty();\n   }\n \n   @Test\n-  public void logArmActive_singlePersonalizationKey_loggedOnce() {\n+  public void logArmActive_singlePersonalizationKey_loggedInternallyAndExternally() {\n     personalization.logArmActive(\"key1\", CONFIG_CONTAINER);\n \n     verify(mockAnalyticsConnector, times(1))\n         .logEvent(\n             eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n-    assertThat(FAKE_LOGS).hasSize(1);\n+    verify(mockAnalyticsConnector, times(1))\n+        .logEvent(\n+            eq(ANALYTICS_ORIGIN_PERSONALIZATION),\n+            eq(ANALYTICS_PULL_EVENT_INTERNAL),\n+            any(Bundle.class));\n+    assertThat(FAKE_LOGS).hasSize(2);\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, \"id1\");\n-    params.putString(ARM_VALUE, \"value1\");\n-    assertThat(FAKE_LOGS.get(0).toString()).isEqualTo(params.toString());\n+    Bundle logParams = new Bundle();\n+    logParams.putString(ARM_KEY, \"key1\");\n+    logParams.putString(ARM_VALUE, \"value1\");\n+    logParams.putString(PERSONALIZATION_ID_LOG_KEY, \"p13n1\");\n+    logParams.putInt(ARM_INDEX_LOG_KEY, 0);\n+    logParams.putString(GROUP, \"BASELINE\");\n+    Bundle internalLogParams = new Bundle();\n+    internalLogParams.putString(CHOICE_ID_LOG_KEY, \"id1\");\n+    assertThat(FAKE_LOGS)\n+        .comparingElementsUsing(TO_STRING)\n+        .containsExactly(logParams.toString(), internalLogParams.toString());\n   }\n \n   @Test\n   public void logArmActive_multiplePersonalizationKeys_loggedMultiple() {\n     personalization.logArmActive(\"key1\", CONFIG_CONTAINER);\n     personalization.logArmActive(\"key2\", CONFIG_CONTAINER);\n+    personalization.logArmActive(\"key1\", CONFIG_CONTAINER);\n \n     verify(mockAnalyticsConnector, times(2))\n         .logEvent(\n             eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n-    assertThat(FAKE_LOGS).hasSize(2);\n-\n-    Bundle params1 = new Bundle();\n-    params1.putString(ARM_KEY, \"id1\");\n-    params1.putString(ARM_VALUE, \"value1\");\n-    assertThat(FAKE_LOGS.get(0).toString()).isEqualTo(params1.toString());\n-\n-    Bundle params2 = new Bundle();\n-    params2.putString(ARM_KEY, \"id2\");\n-    params2.putString(ARM_VALUE, \"value2\");\n-    assertThat(FAKE_LOGS.get(1).toString()).isEqualTo(params2.toString());\n+    verify(mockAnalyticsConnector, times(2))\n+        .logEvent(\n+            eq(ANALYTICS_ORIGIN_PERSONALIZATION),\n+            eq(ANALYTICS_PULL_EVENT_INTERNAL),\n+            any(Bundle.class));\n+    assertThat(FAKE_LOGS).hasSize(4);\n+\n+    Bundle logParams1 = new Bundle();\n+    logParams1.putString(ARM_KEY, \"key1\");\n+    logParams1.putString(ARM_VALUE, \"value1\");\n+    logParams1.putString(PERSONALIZATION_ID_LOG_KEY, \"p13n1\");\n+    logParams1.putInt(ARM_INDEX_LOG_KEY, 0);\n+    logParams1.putString(GROUP, \"BASELINE\");\n+    Bundle logParams2 = new Bundle();", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU1NzEyMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558557120", "bodyText": "Thinking (no action req'd): \"_fpc\" for the internal event name, and \"_fpid\" for the parameter name (in which to log the choice ID), aligns w the per-choice metadata design.", "author": "erikeldridge", "createdAt": "2021-01-15T19:48:45Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,18 +17,36 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  // Constants with LOG_KEY suffix are how the corresponding ones without it are identified on\n+  // Google Analytics.\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_assignment\";\n+  public static final String ARM_KEY = \"arm_key\";\n+  public static final String ARM_VALUE = \"arm_value\";\n+  public static final String PERSONALIZATION_ID = \"personalizationId\";\n+  public static final String PERSONALIZATION_ID_LOG_KEY = \"personalization_id\";\n+  public static final String ARM_INDEX = \"armIndex\";\n+  public static final String ARM_INDEX_LOG_KEY = \"arm_index\";\n+  public static final String GROUP = \"group\";\n+\n+  public static final String ANALYTICS_PULL_EVENT_INTERNAL = \"_fpc\";", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU2MzMwMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558563303", "bodyText": "Thinking: this won't break EAP usage because they aren't using the SDK", "author": "erikeldridge", "createdAt": "2021-01-15T20:01:03Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +76,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU2NzAwNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558567006", "bodyText": "Mind adding a comment explaining why we need this?\nThinking: this ensures we only log one event per param-choice pair. This map is bounded by the number of params. Choices are made on each fetch, so this isn't a long-lived cache.", "author": "erikeldridge", "createdAt": "2021-01-15T20:08:42Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +76,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU2OTk3Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558569972", "bodyText": "Minor: there are a lot of things called \"key\" in this file. Since the key arg passed to the logArmActive fn is actually the RC param, renaming it to something like rcParameter would be more self-descriptive.", "author": "erikeldridge", "createdAt": "2021-01-15T20:15:12Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +76,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {\n+      if (choiceId.equals(armsCache.get(key))) {\n+        return;\n+      }\n+      armsCache.put(key, choiceId);\n+    }\n+\n+    Bundle logParams = new Bundle();\n+    logParams.putString(ARM_KEY, key);", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU3NjEzNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558576134", "bodyText": "Thinking: the design lists five things we want to log:\n\nDeveloper friendly identifier of the personalization (either the rc param, or an id customers can map back to rc param), satisfied by the arm_key field\nThe choice that was made (a string value), satisfied by the arm_value field\nThe group the user was in (\u201cp13n\u201d or \u201cbaseline\u201d), satisfied by the group field\nPersonalization ID, satisfied by the personalization_id field\nArm index, satisfied by the arm_index field\n\nThinking: the external event name is arbitrary, we just need to document what it is. personalization_assignment seems self-descriptive to me \ud83d\udc4d\nMinor: renaming arm_key to something like rc_parameter would be more self-descriptive given it communicates an RC parameter.", "author": "erikeldridge", "createdAt": "2021-01-15T20:28:45Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +76,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {\n+      if (choiceId.equals(armsCache.get(key))) {\n+        return;\n+      }\n+      armsCache.put(key, choiceId);\n+    }\n+\n+    Bundle logParams = new Bundle();\n+    logParams.putString(ARM_KEY, key);", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU3NzQ0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558577444", "bodyText": "Minor: as I commented on the iOS change, it's unclear to me what \"pull\" means here and below.\nAlso, given this whole file concerns logging to Analytics, including \"analytics\" in some field names, but not others is confusing. I'd vote to just omit it.\nThe main distinctions from my perspective are internal vs external, and \"event\" vs \"param\" (to use Analytics' \"feature type\" nomenclature from the event proposal).\nTo summarize, I'd vote to use \"internal\" and \"external\" prefixes to differentiate internal from external events, and \"event\" and \"param\" suffixes to differentiate event names from param names, eg INTERNAL_EVENT, INTERNAL_CHOICE_ID_PARAM, etc\nThinking (no action req'd): all these field names are consistent across Android and iOS \ud83d\udc4d", "author": "erikeldridge", "createdAt": "2021-01-15T20:31:51Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,18 +17,36 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  // Constants with LOG_KEY suffix are how the corresponding ones without it are identified on\n+  // Google Analytics.\n+  public static final String ANALYTICS_PULL_EVENT = \"personalization_assignment\";", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODU3OTUxOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558579518", "bodyText": "Thinking: the design lists one thing we want to log:\n\nChoice ID, satisfied by the _fpid param\n\nThinking: the _fpc event name is correct per the events proposal.", "author": "erikeldridge", "createdAt": "2021-01-15T20:36:38Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +76,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {\n+      if (choiceId.equals(armsCache.get(key))) {\n+        return;\n+      }\n+      armsCache.put(key, choiceId);\n+    }\n+\n+    Bundle logParams = new Bundle();\n+    logParams.putString(ARM_KEY, key);\n+    logParams.putString(ARM_VALUE, values.optString(key));\n+    logParams.putString(PERSONALIZATION_ID_LOG_KEY, metadata.optString(PERSONALIZATION_ID));\n+    logParams.putInt(ARM_INDEX_LOG_KEY, metadata.optInt(ARM_INDEX, -1));\n+    logParams.putString(GROUP, metadata.optString(GROUP));\n+    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, logParams);\n+\n+    Bundle internalLogParams = new Bundle();\n+    internalLogParams.putString(CHOICE_ID_LOG_KEY, choiceId);", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODY4OTg5OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558689899", "bodyText": "I'm not very familiar about the SDK development process. Thus, I'll just call out one thing if we have considered: EAP Halfbrick's new experiment tries to set the ARM value as json string.\nI want to check that these json strings can be correctly handled.\nCheck Halfbrick's new experiment's PersonalizationDefinition: http://google3/firebase/sage/p13n/scripts/eap/add_halfbrick_exp2_defs.sh?l=41-42&rcl=351643001", "author": "andyliangdong", "createdAt": "2021-01-15T23:57:54Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +76,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {\n+      if (choiceId.equals(armsCache.get(key))) {\n+        return;\n+      }\n+      armsCache.put(key, choiceId);\n+    }\n+\n+    Bundle logParams = new Bundle();\n+    logParams.putString(ARM_KEY, key);", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODc2NDcwNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558764706", "bodyText": "I don't know of any reason why they wouldn't be OK.", "author": "vic-flair", "createdAt": "2021-01-16T02:13:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODY4OTg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODY5ODIyOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558698228", "bodyText": "I'm not sure where the metadata come from? is this logging server side's decision?", "author": "andyliangdong", "createdAt": "2021-01-16T00:09:32Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -58,9 +76,29 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    synchronized (armsCache) {\n+      if (choiceId.equals(armsCache.get(key))) {\n+        return;\n+      }\n+      armsCache.put(key, choiceId);\n+    }\n+\n+    Bundle logParams = new Bundle();\n+    logParams.putString(ARM_KEY, key);\n+    logParams.putString(ARM_VALUE, values.optString(key));\n+    logParams.putString(PERSONALIZATION_ID_LOG_KEY, metadata.optString(PERSONALIZATION_ID));\n+    logParams.putInt(ARM_INDEX_LOG_KEY, metadata.optInt(ARM_INDEX, -1));\n+    logParams.putString(GROUP, metadata.optString(GROUP));", "originalCommit": "10daf06a6c18b5431bce6d29830bcbba2164c26d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODc2NDgwMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r558764803", "bodyText": "Yeah, from the server.", "author": "vic-flair", "createdAt": "2021-01-16T02:13:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODY5ODIyOA=="}], "type": "inlineReview"}, {"oid": "46fb82f9c83b8445420ff26183c669f2fa88d6a9", "url": "https://github.com/firebase/firebase-android-sdk/commit/46fb82f9c83b8445420ff26183c669f2fa88d6a9", "message": "Rename constants.", "committedDate": "2021-01-16T02:06:53Z", "type": "commit"}, {"oid": "8268fe681e82d3027f8efef2129f6d942f1b2d13", "url": "https://github.com/firebase/firebase-android-sdk/commit/8268fe681e82d3027f8efef2129f6d942f1b2d13", "message": "Use value that looks more like actual Personalization metadata.", "committedDate": "2021-01-16T02:40:36Z", "type": "commit"}, {"oid": "8268fe681e82d3027f8efef2129f6d942f1b2d13", "url": "https://github.com/firebase/firebase-android-sdk/commit/8268fe681e82d3027f8efef2129f6d942f1b2d13", "message": "Use value that looks more like actual Personalization metadata.", "committedDate": "2021-01-16T02:40:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUzMzQ1MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r560533451", "bodyText": "This looks great. Much easier to read \ud83d\udc4d", "author": "erikeldridge", "createdAt": "2021-01-19T22:17:27Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -53,14 +72,36 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    JSONObject metadata = ids.optJSONObject(key);\n+    JSONObject metadata = ids.optJSONObject(rcParameter);\n     if (metadata == null) {\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    // We only to need to log each choice ID once, so this attempts to prevent too much unnecessary\n+    // logging.\n+    synchronized (loggedChoiceIds) {\n+      if (choiceId.equals(loggedChoiceIds.get(rcParameter))) {\n+        return;\n+      }\n+      loggedChoiceIds.put(rcParameter, choiceId);\n+    }\n+\n+    Bundle logParams = new Bundle();\n+    logParams.putString(EXTERNAL_RC_PARAMETER_PARAM, rcParameter);", "originalCommit": "8268fe681e82d3027f8efef2129f6d942f1b2d13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUzMDc5OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r560530798", "bodyText": "Can we simplify this: \"The PARAM suffix identifies log keys sent to Google Analytics.\"", "author": "danasilver", "createdAt": "2021-01-19T22:12:14Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,18 +17,37 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  // Constants with PARAM suffix are how the corresponding ones without it are identified on", "originalCommit": "8268fe681e82d3027f8efef2129f6d942f1b2d13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDUzMjk3NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r560532974", "bodyText": "I think we can remove this comment now that loggedChoiceIds makes the filtering clear.", "author": "danasilver", "createdAt": "2021-01-19T22:16:33Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -53,14 +72,36 @@ public void logArmActive(@NonNull String key, @NonNull ConfigContainer configCon\n       return;\n     }\n \n-    JSONObject metadata = ids.optJSONObject(key);\n+    JSONObject metadata = ids.optJSONObject(rcParameter);\n     if (metadata == null) {\n       return;\n     }\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, metadata.optString(PERSONALIZATION_ID));\n-    params.putString(ARM_VALUE, values.optString(key));\n-    analyticsConnector.logEvent(ANALYTICS_ORIGIN_PERSONALIZATION, ANALYTICS_PULL_EVENT, params);\n+    String choiceId = metadata.optString(CHOICE_ID);\n+    if (choiceId.isEmpty()) {\n+      return;\n+    }\n+\n+    // We only to need to log each choice ID once, so this attempts to prevent too much unnecessary", "originalCommit": "8268fe681e82d3027f8efef2129f6d942f1b2d13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDU2MDEwOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r560560108", "bodyText": "Seems like this could be combined with the above into one statement with all four logs?", "author": "danasilver", "createdAt": "2021-01-19T23:08:10Z", "path": "firebase-config/src/test/java/com/google/firebase/remoteconfig/internal/PersonalizationTest.java", "diffHunk": "@@ -88,43 +123,46 @@ public void logArmActive_nonPersonalizationKey_notLogged() {\n \n     verify(mockAnalyticsConnector, times(0))\n         .logEvent(\n-            eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n+            eq(ANALYTICS_ORIGIN_PERSONALIZATION),\n+            or(eq(EXTERNAL_EVENT), eq(INTERNAL_EVENT)),\n+            any(Bundle.class));\n     assertThat(FAKE_LOGS).isEmpty();\n   }\n \n   @Test\n-  public void logArmActive_singlePersonalizationKey_loggedOnce() {\n+  public void logArmActive_singlePersonalizationKey_loggedInternallyAndExternally() {\n     personalization.logArmActive(\"key1\", CONFIG_CONTAINER);\n \n     verify(mockAnalyticsConnector, times(1))\n-        .logEvent(\n-            eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n-    assertThat(FAKE_LOGS).hasSize(1);\n+        .logEvent(eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(EXTERNAL_EVENT), any(Bundle.class));\n+    verify(mockAnalyticsConnector, times(1))\n+        .logEvent(eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(INTERNAL_EVENT), any(Bundle.class));\n+    assertThat(FAKE_LOGS).hasSize(2);\n \n-    Bundle params = new Bundle();\n-    params.putString(ARM_KEY, \"id1\");\n-    params.putString(ARM_VALUE, \"value1\");\n-    assertThat(FAKE_LOGS.get(0).toString()).isEqualTo(params.toString());\n+    assertThat(FAKE_LOGS)\n+        .comparingElementsUsing(TO_STRING)\n+        .containsExactly(LOG_PARAMS_1.toString(), INTERNAL_LOG_PARAMS_1.toString());\n   }\n \n   @Test\n-  public void logArmActive_multiplePersonalizationKeys_loggedMultiple() {\n+  public void logArmActive_multiplePersonalizationKeys_loggedInternallyAndExternally() {\n     personalization.logArmActive(\"key1\", CONFIG_CONTAINER);\n     personalization.logArmActive(\"key2\", CONFIG_CONTAINER);\n+    personalization.logArmActive(\"key1\", CONFIG_CONTAINER);\n \n     verify(mockAnalyticsConnector, times(2))\n-        .logEvent(\n-            eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(ANALYTICS_PULL_EVENT), any(Bundle.class));\n-    assertThat(FAKE_LOGS).hasSize(2);\n-\n-    Bundle params1 = new Bundle();\n-    params1.putString(ARM_KEY, \"id1\");\n-    params1.putString(ARM_VALUE, \"value1\");\n-    assertThat(FAKE_LOGS.get(0).toString()).isEqualTo(params1.toString());\n-\n-    Bundle params2 = new Bundle();\n-    params2.putString(ARM_KEY, \"id2\");\n-    params2.putString(ARM_VALUE, \"value2\");\n-    assertThat(FAKE_LOGS.get(1).toString()).isEqualTo(params2.toString());\n+        .logEvent(eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(EXTERNAL_EVENT), any(Bundle.class));\n+    verify(mockAnalyticsConnector, times(2))\n+        .logEvent(eq(ANALYTICS_ORIGIN_PERSONALIZATION), eq(INTERNAL_EVENT), any(Bundle.class));\n+    assertThat(FAKE_LOGS).hasSize(4);\n+\n+    assertThat(FAKE_LOGS)\n+        .comparingElementsUsing(TO_STRING)\n+        .containsAtLeast(LOG_PARAMS_1.toString(), LOG_PARAMS_2.toString())\n+        .inOrder();\n+    assertThat(FAKE_LOGS)\n+        .comparingElementsUsing(TO_STRING)\n+        .containsAtLeast(INTERNAL_LOG_PARAMS_1.toString(), INTERNAL_LOG_PARAMS_2.toString())", "originalCommit": "8268fe681e82d3027f8efef2129f6d942f1b2d13", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDU5MjUwMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r560592503", "bodyText": "We can't combine it if we want to check the ordering too, since it's not guaranteed that the external ones come before the internal ones.", "author": "vic-flair", "createdAt": "2021-01-20T00:31:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDU2MDEwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MDU2MzMwMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/2222#discussion_r560563302", "bodyText": "Related to removing the comment below about reducing logging - I'd just note that here as something like \"Remote Config parameter key and Choice ID pairs that have already been logged to Analytics.\"", "author": "danasilver", "createdAt": "2021-01-19T23:15:01Z", "path": "firebase-config/src/main/java/com/google/firebase/remoteconfig/internal/Personalization.java", "diffHunk": "@@ -17,18 +17,37 @@\n import android.os.Bundle;\n import androidx.annotation.NonNull;\n import com.google.firebase.analytics.connector.AnalyticsConnector;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n import org.json.JSONObject;\n \n public class Personalization {\n   public static final String ANALYTICS_ORIGIN_PERSONALIZATION = \"fp\";\n-  public static final String ANALYTICS_PULL_EVENT = \"_fpc\";\n-  public static final String ARM_KEY = \"_fpid\";\n-  public static final String ARM_VALUE = \"_fpct\";\n-  static final String PERSONALIZATION_ID = \"personalizationId\";\n+\n+  // Constants with PARAM suffix are how the corresponding ones without it are identified on\n+  // Google Analytics.\n+  public static final String EXTERNAL_EVENT = \"personalization_assignment\";\n+  public static final String EXTERNAL_RC_PARAMETER_PARAM = \"arm_key\";\n+  public static final String EXTERNAL_ARM_VALUE_PARAM = \"arm_value\";\n+  public static final String PERSONALIZATION_ID = \"personalizationId\";\n+  public static final String EXTERNAL_PERSONALIZATION_ID_PARAM = \"personalization_id\";\n+  public static final String ARM_INDEX = \"armIndex\";\n+  public static final String EXTERNAL_ARM_INDEX_PARAM = \"arm_index\";\n+  public static final String GROUP = \"group\";\n+  public static final String EXTERNAL_GROUP_PARAM = \"group\";\n+\n+  public static final String INTERNAL_EVENT = \"_fpc\";\n+  public static final String CHOICE_ID = \"choiceId\";\n+  public static final String INTERNAL_CHOICE_ID_PARAM = \"_fpid\";\n \n   /** The app's Firebase Analytics client. */\n   private final AnalyticsConnector analyticsConnector;\n \n+  /** A map of Remote Config parameter key to choice ID. */", "originalCommit": "8268fe681e82d3027f8efef2129f6d942f1b2d13", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "64f38afbbd57684af26f84925873045aa64ccd04", "url": "https://github.com/firebase/firebase-android-sdk/commit/64f38afbbd57684af26f84925873045aa64ccd04", "message": "Editing some comments.", "committedDate": "2021-01-20T00:09:08Z", "type": "commit"}]}