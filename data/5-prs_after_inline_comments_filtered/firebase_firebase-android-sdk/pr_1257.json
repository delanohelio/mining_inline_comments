{"pr_number": 1257, "pr_title": "Make FIAM correctly fetch on first open", "pr_createdAt": "2020-02-20T01:01:36Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1257", "timeline": [{"oid": "8cb335910d1ce084eee287b34e8fd7794b849183", "url": "https://github.com/firebase/firebase-android-sdk/commit/8cb335910d1ce084eee287b34e8fd7794b849183", "message": "make it async", "committedDate": "2020-02-26T22:32:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjMxMjYzNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1257#discussion_r382312637", "bodyText": "can we name this something else? From the code, its hard to understand whether displayMessage is being called on this listener or the object level one.", "author": "prakhar1989", "createdAt": "2020-02-20T23:17:09Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/FirebaseInAppMessaging.java", "diffHunk": "@@ -162,21 +164,29 @@ public boolean areMessagesSuppressed() {\n   }\n \n   private void initializeFiam() {\n-    Disposable unusedSubscription =\n-        inAppMessageStreamManager\n-            .createFirebaseInAppMessageStream()\n-            .subscribe(\n-                triggeredInAppMessage ->\n-                    listener\n-                        .doOnSuccess(\n-                            listener -> {\n-                              listener.displayMessage(\n-                                  triggeredInAppMessage.getInAppMessage(),\n-                                  displayCallbacksFactory.generateDisplayCallback(\n-                                      triggeredInAppMessage.getInAppMessage(),\n-                                      triggeredInAppMessage.getTriggeringEvent()));\n-                            })\n-                        .subscribe());\n+    FirebaseInstanceId.getInstance()\n+        .getInstanceId()\n+        .addOnSuccessListener(\n+            new OnSuccessListener<InstanceIdResult>() {\n+              @Override\n+              public void onSuccess(InstanceIdResult instanceIdResult) {\n+                Disposable unusedSubscription =\n+                    inAppMessageStreamManager\n+                        .createFirebaseInAppMessageStream()\n+                        .subscribe(\n+                            triggeredInAppMessage ->\n+                                listener\n+                                    .doOnSuccess(\n+                                        listener -> {", "originalCommit": "222fb10370829260f27d5eb3a38d632a8469c627", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgyODMyNg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1257#discussion_r384828326", "bodyText": "why do we need this method?", "author": "prakhar1989", "createdAt": "2020-02-26T23:24:27Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/FirebaseInAppMessaging.java", "diffHunk": "@@ -161,53 +163,33 @@ public boolean areMessagesSuppressed() {\n     return areMessagesSuppressed;\n   }\n \n-  private void initializeFiam() {\n-    Disposable unusedSubscription =\n-        inAppMessageStreamManager\n-            .createFirebaseInAppMessageStream()\n-            .subscribe(\n-                triggeredInAppMessage ->\n-                    listener\n-                        .doOnSuccess(\n-                            listener -> {\n-                              listener.displayMessage(\n-                                  triggeredInAppMessage.getInAppMessage(),\n-                                  displayCallbacksFactory.generateDisplayCallback(\n-                                      triggeredInAppMessage.getInAppMessage(),\n-                                      triggeredInAppMessage.getTriggeringEvent()));\n-                            })\n-                        .subscribe());\n-  }\n-\n   /*\n    * Called to set a new message display component for FIAM SDK. This is the method used\n    * by both the default FIAM display SDK or any app wanting to customize the message\n    * display.\n    */\n   @Keep\n   public void setMessageDisplayComponent(@NonNull FirebaseInAppMessagingDisplay messageDisplay) {\n-    Logging.logi(\"Setting display event listener\");\n-    this.listener = Maybe.just(messageDisplay);\n+    Logging.logi(\"Setting display event component\");\n+    this.fiamDisplay = messageDisplay;\n   }\n \n   /**\n-   * Unregisters a listener to in app message display events.\n+   * Unregisters a fiamDisplay to in app message display events.\n    *\n    * @hide\n    */\n   @Keep\n   @KeepForSdk\n   public void clearDisplayListener() {", "originalCommit": "b646d51c282812f047adde06925264fe32bb9fb5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMzAzOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1257#discussion_r384833039", "bodyText": "should this be task to single? http://reactivex.io/RxJava/3.x/javadoc/io/reactivex/rxjava3/core/Single.html", "author": "prakhar1989", "createdAt": "2020-02-26T23:38:54Z", "path": "firebase-inappmessaging/src/main/java/com/google/firebase/inappmessaging/internal/InAppMessageStreamManager.java", "diffHunk": "@@ -233,7 +234,7 @@ private boolean shouldIgnoreCache(String event) {\n \n               Function<CampaignImpressionList, Maybe<FetchEligibleCampaignsResponse>> serviceFetch =\n                   impressions ->\n-                      Maybe.fromCallable(() -> apiClient.getFiams(impressions))\n+                      taskToMaybe(apiClient.getFiams(impressions))", "originalCommit": "b646d51c282812f047adde06925264fe32bb9fb5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzOTQ1Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1257#discussion_r384839456", "bodyText": "next cl", "author": "JasonAHeron", "createdAt": "2020-02-26T23:58:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDgzMzAzOQ=="}], "type": "inlineReview"}, {"oid": "7e76835e0c9e5a81377d173900b1d693e8a2745a", "url": "https://github.com/firebase/firebase-android-sdk/commit/7e76835e0c9e5a81377d173900b1d693e8a2745a", "message": "kk", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "24da475aae314a3183bddc9cd9a5c85db46032aa", "url": "https://github.com/firebase/firebase-android-sdk/commit/24da475aae314a3183bddc9cd9a5c85db46032aa", "message": "derpawalrus", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "991e98834afa065e0416d191f1d8885543133485", "url": "https://github.com/firebase/firebase-android-sdk/commit/991e98834afa065e0416d191f1d8885543133485", "message": "cleanitup", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "9d1ba00ea26ba3478328723e81f79d3811abde80", "url": "https://github.com/firebase/firebase-android-sdk/commit/9d1ba00ea26ba3478328723e81f79d3811abde80", "message": "remove absolute garbage", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "684adc31aaa656912c30cb35473327bbe1d62f62", "url": "https://github.com/firebase/firebase-android-sdk/commit/684adc31aaa656912c30cb35473327bbe1d62f62", "message": "wow its not broken", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "4a82d6e22848c794978c07a5fe1b40457b3ea3a1", "url": "https://github.com/firebase/firebase-android-sdk/commit/4a82d6e22848c794978c07a5fe1b40457b3ea3a1", "message": "cleaning", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "2d66dd0afe070c28ec3aefa6c83810d69426163d", "url": "https://github.com/firebase/firebase-android-sdk/commit/2d66dd0afe070c28ec3aefa6c83810d69426163d", "message": "fix test", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "964f8e3da426affec84496b662b6869984454279", "url": "https://github.com/firebase/firebase-android-sdk/commit/964f8e3da426affec84496b662b6869984454279", "message": "format", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "50479c09450e0b058c50174fc404fe00937008cd", "url": "https://github.com/firebase/firebase-android-sdk/commit/50479c09450e0b058c50174fc404fe00937008cd", "message": "kk", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "0006128f4accb7b0c5363aa597d492aa27daa12a", "url": "https://github.com/firebase/firebase-android-sdk/commit/0006128f4accb7b0c5363aa597d492aa27daa12a", "message": "make it async", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "348df76b1c305324fb208a1c9d8b5377ab90917d", "url": "https://github.com/firebase/firebase-android-sdk/commit/348df76b1c305324fb208a1c9d8b5377ab90917d", "message": "format", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "0c847975e98b6686773779fc214f4ba6a7dec4b8", "url": "https://github.com/firebase/firebase-android-sdk/commit/0c847975e98b6686773779fc214f4ba6a7dec4b8", "message": "tests", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "a728b28d68ec6244f19a9ea613c5902920350e78", "url": "https://github.com/firebase/firebase-android-sdk/commit/a728b28d68ec6244f19a9ea613c5902920350e78", "message": "ahhhhhhhh", "committedDate": "2020-02-26T23:59:39Z", "type": "commit"}, {"oid": "a728b28d68ec6244f19a9ea613c5902920350e78", "url": "https://github.com/firebase/firebase-android-sdk/commit/a728b28d68ec6244f19a9ea613c5902920350e78", "message": "ahhhhhhhh", "committedDate": "2020-02-26T23:59:39Z", "type": "forcePushed"}, {"oid": "9fe9e241a66bcdafb829d67c871c3ea1a9f7af7d", "url": "https://github.com/firebase/firebase-android-sdk/commit/9fe9e241a66bcdafb829d67c871c3ea1a9f7af7d", "message": "DID IT!!", "committedDate": "2020-02-27T01:00:43Z", "type": "commit"}]}