{"pr_number": 1333, "pr_title": " Adding a TimeSource in Utils to easily inject and test the auth token expiration.", "pr_createdAt": "2020-03-09T21:47:34Z", "pr_url": "https://github.com/firebase/firebase-android-sdk/pull/1333", "timeline": [{"oid": "4283a2bb3b4434510e061a0d9c4b080595658c2a", "url": "https://github.com/firebase/firebase-android-sdk/commit/4283a2bb3b4434510e061a0d9c4b080595658c2a", "message": "Dropping guava and appcompat dependency from FIS SDK.", "committedDate": "2020-02-06T17:59:09Z", "type": "commit"}, {"oid": "984884cd6f9a90a8172d0957bd13e68e3f06db2f", "url": "https://github.com/firebase/firebase-android-sdk/commit/984884cd6f9a90a8172d0957bd13e68e3f06db2f", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-06T18:16:08Z", "type": "commit"}, {"oid": "a82387701d2549bb5fc3b5dc2530a83ed0680d02", "url": "https://github.com/firebase/firebase-android-sdk/commit/a82387701d2549bb5fc3b5dc2530a83ed0680d02", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-11T18:58:16Z", "type": "commit"}, {"oid": "afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "url": "https://github.com/firebase/firebase-android-sdk/commit/afcb14c913c8dedd87faf6b71fdc7dd4384a6c39", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-02-13T23:37:48Z", "type": "commit"}, {"oid": "5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "url": "https://github.com/firebase/firebase-android-sdk/commit/5574e30b8e3f6c9d09bfca149a6f7853c4141d25", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-05T16:49:33Z", "type": "commit"}, {"oid": "a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "url": "https://github.com/firebase/firebase-android-sdk/commit/a5dd4dc54f2b7941ffe4b5cd76b6c8ab5764f7a1", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk", "committedDate": "2020-03-09T16:31:08Z", "type": "commit"}, {"oid": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "url": "https://github.com/firebase/firebase-android-sdk/commit/58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "message": "Adding a TimeSource in Utils to easily inject and test the auth token\nexpiration functionality.\n\nAlso, added the tests that were removed when fixing the Calendar\ninstance.", "committedDate": "2020-03-09T21:44:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NTI2OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390085268", "bodyText": "this is in milliseconds?", "author": "andirayo", "createdAt": "2020-03-10T04:07:41Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -39,6 +44,6 @@ public boolean isAuthTokenExpired(PersistedInstallationEntry entry) {\n \n   /** Returns current time in seconds. */\n   public long currentTimeInSecs() {\n-    return TimeUnit.MILLISECONDS.toSeconds(System.currentTimeMillis());\n+    return TimeUnit.MILLISECONDS.toSeconds(clock.now());", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwMjQ2Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390502466", "bodyText": "Yes.", "author": "ankitaj224", "createdAt": "2020-03-10T17:53:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NTI2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUyMzQwNQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390523405", "bodyText": "Please add a comment confirming that.", "author": "andirayo", "createdAt": "2020-03-10T18:26:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NTI2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjQyMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390086422", "bodyText": "Returns timestamp in milliseconds since EPOCH in UTC.\nReturns timestamp in milliseconds since EPOCH in local timezone.\n(whatever is the truth)", "author": "andirayo", "createdAt": "2020-03-10T04:12:52Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/Clock.java", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/**\n+ * Provides the current value of \"now\" to allow injecting time as a dependency for testing.\n+ *\n+ * @hide\n+ */\n+public interface Clock {\n+  /** Returns the current, absolute time according to this clock. */", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwNTEwOQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390505109", "bodyText": "Done.", "author": "ankitaj224", "createdAt": "2020-03-10T17:56:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjcwMQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390086701", "bodyText": "What do we need this interface for?\nWhy can't we just use a TimeSource available in Android?", "author": "andirayo", "createdAt": "2020-03-10T04:14:05Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/Clock.java", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/**\n+ * Provides the current value of \"now\" to allow injecting time as a dependency for testing.\n+ *\n+ * @hide\n+ */\n+public interface Clock {", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwMTM3Nw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390501377", "bodyText": "#1333 (comment)", "author": "ankitaj224", "createdAt": "2020-03-10T17:51:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjcwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjgyOA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390086828", "bodyText": "I like your thought process, but I would prefer us to use a TimeSource that is offered by / available on Android.", "author": "andirayo", "createdAt": "2020-03-10T04:14:44Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/SystemClock.java", "diffHunk": "@@ -0,0 +1,23 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/** @hide */\n+public class SystemClock implements Clock {", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwMTI4MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390501280", "bodyText": "The TimeSource that is offered by Android https://developer.android.com/reference/java/time/Clock - requires API level 26\nWe can't use it to due to the minSDK support.", "author": "ankitaj224", "createdAt": "2020-03-10T17:51:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1MTUzMA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390651530", "bodyText": "What about JodaTime? Just asking.\nI am fine with this implementation.", "author": "andirayo", "createdAt": "2020-03-10T22:37:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg1ODM4Mw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r493858383", "bodyText": "We will have to add a dependency on joda-time:joda-time:2.9.4 library which will lead to increase in aar size just to fetch system time.", "author": "ankitaj224", "createdAt": "2020-09-23T19:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAxOTg3MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r494019871", "bodyText": "sg, ty\nplease add a comment in code above System.currentTimeMillies, documenting your decisions.", "author": "andirayo", "createdAt": "2020-09-24T03:42:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA4NjgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDc1OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390090758", "bodyText": "line too long", "author": "andirayo", "createdAt": "2020-03-10T04:33:42Z", "path": "firebase-installations/src/test/java/com/google/firebase/installations/FirebaseInstallationsTest.java", "diffHunk": "@@ -510,6 +513,90 @@ public void testGetId_multipleCalls_sameFIDReturned() throws Exception {\n     assertTrue(\"the entry isn't doesn't have a registered fid: \" + entry, entry.isRegistered());\n   }\n \n+  @Test\n+  public void testGetId_expiredAuthTokenUncheckedException_statusUpdated() throws Exception {\n+    // Start with a registered FID\n+    persistedInstallation.insertOrUpdatePersistedInstallationEntry(\n+        PersistedInstallationEntry.INSTANCE.withRegisteredFid(\n+            TEST_FID_1,\n+            TEST_REFRESH_TOKEN,\n+            utils.currentTimeInSecs(),\n+            TEST_AUTH_TOKEN,\n+            TEST_TOKEN_EXPIRATION_TIMESTAMP));\n+\n+    // Move the time forward by the token expiration time.\n+    fakeClock.advanceTimeBySeconds(TEST_TOKEN_EXPIRATION_TIMESTAMP);\n+\n+    // Mocking unchecked exception on FIS generateAuthToken\n+    when(mockBackend.generateAuthToken(anyString(), anyString(), anyString(), anyString()))\n+        .thenThrow(new IOException());\n+\n+    TestOnCompleteListener<String> onCompleteListener = new TestOnCompleteListener<>();\n+    Task<String> getIdTask = firebaseInstallations.getId();\n+    getIdTask.addOnCompleteListener(executor, onCompleteListener);\n+    String fid = onCompleteListener.await();\n+\n+    assertWithMessage(\"getId Task failed\").that(fid).isEqualTo(TEST_FID_1);\n+\n+    // Waiting for Task that generates auth token with the FIS Servers\n+    executor.awaitTermination(500, TimeUnit.MILLISECONDS);\n+\n+    // Validate that registration status is still REGISTER\n+    PersistedInstallationEntry entry = persistedInstallation.readPersistedInstallationEntryValue();\n+    assertThat(entry.getFirebaseInstallationId(), equalTo(TEST_FID_1));\n+    assertTrue(\"the entry doesn't have a registered fid: \" + entry, entry.isRegistered());\n+  }\n+\n+  /**\n+   * The FID is successfully registered but the token is expired. A getId will cause the token to be", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNzA3OA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390517078", "bodyText": "https://github.com/firebase/firebase-android-sdk/pull/1333/files#r390516954", "author": "ankitaj224", "createdAt": "2020-03-10T18:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDc1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDc3OQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390090779", "bodyText": "line too long", "author": "andirayo", "createdAt": "2020-03-10T04:33:47Z", "path": "firebase-installations/src/test/java/com/google/firebase/installations/FirebaseInstallationsTest.java", "diffHunk": "@@ -510,6 +513,90 @@ public void testGetId_multipleCalls_sameFIDReturned() throws Exception {\n     assertTrue(\"the entry isn't doesn't have a registered fid: \" + entry, entry.isRegistered());\n   }\n \n+  @Test\n+  public void testGetId_expiredAuthTokenUncheckedException_statusUpdated() throws Exception {\n+    // Start with a registered FID\n+    persistedInstallation.insertOrUpdatePersistedInstallationEntry(\n+        PersistedInstallationEntry.INSTANCE.withRegisteredFid(\n+            TEST_FID_1,\n+            TEST_REFRESH_TOKEN,\n+            utils.currentTimeInSecs(),\n+            TEST_AUTH_TOKEN,\n+            TEST_TOKEN_EXPIRATION_TIMESTAMP));\n+\n+    // Move the time forward by the token expiration time.\n+    fakeClock.advanceTimeBySeconds(TEST_TOKEN_EXPIRATION_TIMESTAMP);\n+\n+    // Mocking unchecked exception on FIS generateAuthToken\n+    when(mockBackend.generateAuthToken(anyString(), anyString(), anyString(), anyString()))\n+        .thenThrow(new IOException());\n+\n+    TestOnCompleteListener<String> onCompleteListener = new TestOnCompleteListener<>();\n+    Task<String> getIdTask = firebaseInstallations.getId();\n+    getIdTask.addOnCompleteListener(executor, onCompleteListener);\n+    String fid = onCompleteListener.await();\n+\n+    assertWithMessage(\"getId Task failed\").that(fid).isEqualTo(TEST_FID_1);\n+\n+    // Waiting for Task that generates auth token with the FIS Servers\n+    executor.awaitTermination(500, TimeUnit.MILLISECONDS);\n+\n+    // Validate that registration status is still REGISTER\n+    PersistedInstallationEntry entry = persistedInstallation.readPersistedInstallationEntryValue();", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNjk1NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390516954", "bodyText": "ran googleJavaFormat on this file and it seems correctly formatted as per the rules. Tried splitting the line but that throws lint errors.", "author": "ankitaj224", "createdAt": "2020-03-10T18:16:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1MjMxNA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390652314", "bodyText": "Now, it looks fine too. Sorry about it.", "author": "andirayo", "createdAt": "2020-03-10T22:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDgxNw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390090817", "bodyText": "line too long", "author": "andirayo", "createdAt": "2020-03-10T04:33:55Z", "path": "firebase-installations/src/test/java/com/google/firebase/installations/FirebaseInstallationsTest.java", "diffHunk": "@@ -510,6 +513,90 @@ public void testGetId_multipleCalls_sameFIDReturned() throws Exception {\n     assertTrue(\"the entry isn't doesn't have a registered fid: \" + entry, entry.isRegistered());\n   }\n \n+  @Test\n+  public void testGetId_expiredAuthTokenUncheckedException_statusUpdated() throws Exception {\n+    // Start with a registered FID\n+    persistedInstallation.insertOrUpdatePersistedInstallationEntry(\n+        PersistedInstallationEntry.INSTANCE.withRegisteredFid(\n+            TEST_FID_1,\n+            TEST_REFRESH_TOKEN,\n+            utils.currentTimeInSecs(),\n+            TEST_AUTH_TOKEN,\n+            TEST_TOKEN_EXPIRATION_TIMESTAMP));\n+\n+    // Move the time forward by the token expiration time.\n+    fakeClock.advanceTimeBySeconds(TEST_TOKEN_EXPIRATION_TIMESTAMP);\n+\n+    // Mocking unchecked exception on FIS generateAuthToken\n+    when(mockBackend.generateAuthToken(anyString(), anyString(), anyString(), anyString()))\n+        .thenThrow(new IOException());\n+\n+    TestOnCompleteListener<String> onCompleteListener = new TestOnCompleteListener<>();\n+    Task<String> getIdTask = firebaseInstallations.getId();\n+    getIdTask.addOnCompleteListener(executor, onCompleteListener);\n+    String fid = onCompleteListener.await();\n+\n+    assertWithMessage(\"getId Task failed\").that(fid).isEqualTo(TEST_FID_1);\n+\n+    // Waiting for Task that generates auth token with the FIS Servers\n+    executor.awaitTermination(500, TimeUnit.MILLISECONDS);\n+\n+    // Validate that registration status is still REGISTER\n+    PersistedInstallationEntry entry = persistedInstallation.readPersistedInstallationEntryValue();\n+    assertThat(entry.getFirebaseInstallationId(), equalTo(TEST_FID_1));\n+    assertTrue(\"the entry doesn't have a registered fid: \" + entry, entry.isRegistered());\n+  }\n+\n+  /**\n+   * The FID is successfully registered but the token is expired. A getId will cause the token to be\n+   * refreshed in the background.\n+   */\n+  @Test\n+  public void testGetId_expiredAuthToken_refreshesAuthToken() throws Exception {\n+    // Start with a registered FID\n+    persistedInstallation.insertOrUpdatePersistedInstallationEntry(\n+        PersistedInstallationEntry.INSTANCE.withRegisteredFid(\n+            TEST_FID_1,\n+            TEST_REFRESH_TOKEN,\n+            utils.currentTimeInSecs(),\n+            TEST_AUTH_TOKEN,\n+            TEST_TOKEN_EXPIRATION_TIMESTAMP));\n+\n+    // Make the server generateAuthToken() call return a refreshed token\n+    when(mockBackend.generateAuthToken(anyString(), anyString(), anyString(), anyString()))\n+        .thenReturn(TEST_TOKEN_RESULT);\n+\n+    // Move the time forward by the token expiration time.\n+    fakeClock.advanceTimeBySeconds(TEST_TOKEN_EXPIRATION_TIMESTAMP);\n+\n+    // Get the ID, which should cause the SDK to realize that the auth token is expired and\n+    // kick off a refresh of the token.\n+    TestOnCompleteListener<String> onCompleteListener = new TestOnCompleteListener<>();\n+    Task<String> getIdTask = firebaseInstallations.getId();\n+    getIdTask.addOnCompleteListener(executor, onCompleteListener);\n+    String fid = onCompleteListener.await();\n+    assertWithMessage(\"getId Task failed\").that(fid).isEqualTo(TEST_FID_1);\n+\n+    // Waiting for Task that registers FID on the FIS Servers\n+    executor.awaitTermination(500, TimeUnit.MILLISECONDS);\n+\n+    TestOnCompleteListener<InstallationTokenResult> onCompleteListener2 =\n+        new TestOnCompleteListener<>();\n+    Task<InstallationTokenResult> task = firebaseInstallations.getToken(false);\n+    task.addOnCompleteListener(executor, onCompleteListener2);\n+    InstallationTokenResult installationTokenResult = onCompleteListener2.await();\n+\n+    // Check that the token has been refreshed\n+    assertWithMessage(\"auth token is not what is expected after the refresh\")\n+        .that(installationTokenResult.getToken())\n+        .isEqualTo(TEST_AUTH_TOKEN_2);\n+\n+    verify(mockBackend, never())\n+        .createFirebaseInstallation(TEST_API_KEY, TEST_FID_1, TEST_PROJECT_ID, TEST_APP_ID_1, null);", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNzE1NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390517154", "bodyText": "https://github.com/firebase/firebase-android-sdk/pull/1333/files#r390516954", "author": "ankitaj224", "createdAt": "2020-03-10T18:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MDgxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MTA0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390091044", "bodyText": "TEST_TOKEN_EXPIRATION_TIMESTAMP - TimeUnit.MINUTES.toSeconds(30)", "author": "andirayo", "createdAt": "2020-03-10T04:35:08Z", "path": "firebase-installations/src/test/java/com/google/firebase/installations/FirebaseInstallationsTest.java", "diffHunk": "@@ -658,13 +745,13 @@ public void testGetAuthToken_expiredAuthToken_fetchedNewTokenFromFIS() throws Ex\n         PersistedInstallationEntry.INSTANCE.withRegisteredFid(\n             TEST_FID_1,\n             TEST_REFRESH_TOKEN,\n-            // Set expiration time to 30 minutes from now (within refresh period)\n-            utils.currentTimeInSecs()\n-                - TEST_TOKEN_EXPIRATION_TIMESTAMP\n-                + TimeUnit.MINUTES.toSeconds(30),\n+            utils.currentTimeInSecs(),\n             TEST_AUTH_TOKEN,\n             TEST_TOKEN_EXPIRATION_TIMESTAMP));\n \n+    // Move the time forward by the token expiration time.\n+    fakeClock.advanceTimeBySeconds(TEST_TOKEN_EXPIRATION_TIMESTAMP);", "originalCommit": "58b9fce5d90b094e2881fd0ba67b3c2d844a8e78", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwNzk2MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390507960", "bodyText": "Done. Thanks.", "author": "ankitaj224", "createdAt": "2020-03-10T18:01:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDA5MTA0NA=="}], "type": "inlineReview"}, {"oid": "05a65eb12f07361390ba371456699869ef531c3e", "url": "https://github.com/firebase/firebase-android-sdk/commit/05a65eb12f07361390ba371456699869ef531c3e", "message": " Addressing Rayo's comments and cleaning up the tests.", "committedDate": "2020-03-10T18:12:11Z", "type": "commit"}, {"oid": "9d8c2775f2612063ce1a716b7f530109a2c38a77", "url": "https://github.com/firebase/firebase-android-sdk/commit/9d8c2775f2612063ce1a716b7f530109a2c38a77", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into timeInject", "committedDate": "2020-03-10T18:14:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1MTI0Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390651246", "bodyText": "Please call this #millis() in accordance with the interface you are trying to simulate:\nhttps://developer.android.com/reference/java/time/Clock#millis()", "author": "andirayo", "createdAt": "2020-03-10T22:36:57Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/Clock.java", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/**\n+ * Provides the current value of \"now\" to allow injecting time as a dependency for testing.\n+ *\n+ * @hide\n+ */\n+public interface Clock {\n+  /** Returns the current time in milliseconds since EPOCH in UTC. */\n+  long now();", "originalCommit": "9d8c2775f2612063ce1a716b7f530109a2c38a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1MTQ0Mg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390651442", "bodyText": "How about a comment like this:\nImplementation that uses System.currentTimeMillis() to implement #millis.", "author": "andirayo", "createdAt": "2020-03-10T22:37:31Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/SystemClock.java", "diffHunk": "@@ -0,0 +1,23 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/** @hide */", "originalCommit": "9d8c2775f2612063ce1a716b7f530109a2c38a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1MjA2MQ==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390652061", "bodyText": "Please link to some Java documentation like this one:\nhttps://docs.oracle.com/javase/7/docs/api/java/lang/System.html#currentTimeMillis()", "author": "andirayo", "createdAt": "2020-03-10T22:39:07Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/SystemClock.java", "diffHunk": "@@ -0,0 +1,23 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/** @hide */\n+public class SystemClock implements Clock {\n+  @Override\n+  public long now() {\n+    return System.currentTimeMillis();", "originalCommit": "9d8c2775f2612063ce1a716b7f530109a2c38a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1Mjg0NA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390652844", "bodyText": "I thought I mentioned this before:\n\nTimeUnit.MINUTES.toSeconds(30)", "author": "andirayo", "createdAt": "2020-03-10T22:41:13Z", "path": "firebase-installations/src/test/java/com/google/firebase/installations/FirebaseInstallationsTest.java", "diffHunk": "@@ -680,6 +770,47 @@ public void testGetAuthToken_expiredAuthToken_fetchedNewTokenFromFIS() throws Ex\n         .isEqualTo(TEST_AUTH_TOKEN_2);\n   }\n \n+  @Test\n+  public void testGetAuthToken_multipleCallsDoNotForceRefresh_fetchedNewTokenOnce()\n+      throws Exception {\n+    // start with a valid fid and authtoken\n+    persistedInstallation.insertOrUpdatePersistedInstallationEntry(\n+        PersistedInstallationEntry.INSTANCE.withRegisteredFid(\n+            TEST_FID_1,\n+            TEST_REFRESH_TOKEN,\n+            utils.currentTimeInSecs(),\n+            TEST_AUTH_TOKEN,\n+            TEST_TOKEN_EXPIRATION_TIMESTAMP));\n+\n+    // Make the server generateAuthToken() call return a refreshed token\n+    when(mockBackend.generateAuthToken(anyString(), anyString(), anyString(), anyString()))\n+        .thenReturn(TEST_TOKEN_RESULT);\n+\n+    // expire the authtoken by advancing the clock\n+    fakeClock.advanceTimeBySeconds(TEST_TOKEN_EXPIRATION_TIMESTAMP);", "originalCommit": "9d8c2775f2612063ce1a716b7f530109a2c38a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDY1MzUzMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r390653533", "bodyText": "Please explain why we need this class. Example:\n\"Interface simulating https://developer.android.com/reference/java/time/Clock.\nProvides [...]\"", "author": "andirayo", "createdAt": "2020-03-10T22:43:12Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/Clock.java", "diffHunk": "@@ -0,0 +1,25 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/**\n+ * Provides the current value of \"now\" to allow injecting time as a dependency for testing.", "originalCommit": "9d8c2775f2612063ce1a716b7f530109a2c38a77", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "397646844aa8230ebe6470fd241c3a398d17535c", "url": "https://github.com/firebase/firebase-android-sdk/commit/397646844aa8230ebe6470fd241c3a398d17535c", "message": "Merge branch 'master' of github.com:firebase/firebase-android-sdk into timeInject", "committedDate": "2020-09-23T19:17:32Z", "type": "commit"}, {"oid": "ce3271b6eada84d8c866946d1dda219edcca99f0", "url": "https://github.com/firebase/firebase-android-sdk/commit/ce3271b6eada84d8c866946d1dda219edcca99f0", "message": "Addressing comments.", "committedDate": "2020-09-23T19:53:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAyMDM3MA==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r494020370", "bodyText": "It's usually a bad sign if you have to add a comment to a simple method like this one.\nHow about you use the method name #currentTimeMillis since everybody will understand what it means?", "author": "andirayo", "createdAt": "2020-09-24T03:44:45Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -55,7 +60,7 @@ public long currentTimeInSecs() {\n   /** Returns current time in milliseconds. */\n   public long currentTimeInMillis() {\n     // Mockito doesn't allow to mock static methods. As a result this util method is not static.\n-    return System.currentTimeMillis();\n+    return clock.millis(); // Returns current time in milliseconds.", "originalCommit": "ce3271b6eada84d8c866946d1dda219edcca99f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAyMDQzMg==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r494020432", "bodyText": "I don't think we need this method any longer.", "author": "andirayo", "createdAt": "2020-09-24T03:44:59Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/Utils.java", "diffHunk": "@@ -55,7 +60,7 @@ public long currentTimeInSecs() {\n   /** Returns current time in milliseconds. */\n   public long currentTimeInMillis() {", "originalCommit": "ce3271b6eada84d8c866946d1dda219edcca99f0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAyMDU5Ng==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r494020596", "bodyText": "This class should probably also be a singleton class, but it's not important.\nI leave it up to you. I just wanted to point that out.", "author": "andirayo", "createdAt": "2020-09-24T03:45:41Z", "path": "firebase-installations/src/main/java/com/google/firebase/installations/time/SystemClock.java", "diffHunk": "@@ -0,0 +1,29 @@\n+// Copyright 2020 Google LLC\n+//\n+// Licensed under the Apache License, Version 2.0 (the \"License\");\n+// you may not use this file except in compliance with the License.\n+// You may obtain a copy of the License at\n+//\n+//      http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing, software\n+// distributed under the License is distributed on an \"AS IS\" BASIS,\n+// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+// See the License for the specific language governing permissions and\n+// limitations under the License.\n+\n+package com.google.firebase.installations.time;\n+\n+/**\n+ * Implementation that uses System.currentTimeMillis() to implement {@link Clock#millis()}.\n+ *\n+ * @hide\n+ */\n+public class SystemClock implements Clock {", "originalCommit": "ce3271b6eada84d8c866946d1dda219edcca99f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTE0NTUyMw==", "url": "https://github.com/firebase/firebase-android-sdk/pull/1333#discussion_r495145523", "bodyText": "Oh true. I`ll need a little practice to quickly identify singleton classes.Thanks for pointing it out :) Changed it.", "author": "ankitaj224", "createdAt": "2020-09-25T17:55:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDAyMDU5Ng=="}], "type": "inlineReview"}, {"oid": "30bc285dbbe05aae5fb22f44d68de88d17e03fe6", "url": "https://github.com/firebase/firebase-android-sdk/commit/30bc285dbbe05aae5fb22f44d68de88d17e03fe6", "message": "Addressing comments & improving SystemClock class to be a singleton.", "committedDate": "2020-09-25T18:00:42Z", "type": "commit"}]}