{"pr_number": 5213, "pr_title": "Issue #5170 - fix NPE during websocket upgrade", "pr_createdAt": "2020-08-31T12:55:09Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5213", "timeline": [{"oid": "ae62180416226dcb4f7d1442387c5123f5bee092", "url": "https://github.com/eclipse/jetty.project/commit/ae62180416226dcb4f7d1442387c5123f5bee092", "message": "Issue #5170 - ensure bytes after 101 response isn't lost during upgrade\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-31T08:29:28Z", "type": "commit"}, {"oid": "abb5ae881257788d3de84801e3f7c2228961fc37", "url": "https://github.com/eclipse/jetty.project/commit/abb5ae881257788d3de84801e3f7c2228961fc37", "message": "HttpExchange could be null during parse()\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-09-01T00:03:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDg3OTY1Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r480879652", "bodyText": "Previously the test for upgrade was: connection != endPoint.getConnection()\nNow it is just 101 response status.   Don't we support upgrade like paths (eg for http2) that are not 101s?", "author": "gregw", "createdAt": "2020-09-01T06:39:40Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/http/HttpReceiverOverHTTP.java", "diffHunk": "@@ -235,6 +235,10 @@ private boolean parse()\n \n             if (complete)\n             {\n+                HttpExchange httpExchange = getHttpExchange();\n+                if (httpExchange != null && httpExchange.getResponse().getStatus() == HttpStatus.SWITCHING_PROTOCOLS_101)", "originalCommit": "abb5ae881257788d3de84801e3f7c2228961fc37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNDM2NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r481424365", "bodyText": "@gregw but this class is the HTTP/1.1 specific implementation so it cannot be anything else than 101.\nThe reason to not do the check to see if the connection was upgraded already is because the 101 response may be finished before the request, so the upgrade did not happen yet (but we know it will since it's a 101).", "author": "sbordet", "createdAt": "2020-09-01T20:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDg3OTY1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwNw==", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r481426507", "bodyText": "This is now printing the whole stack trace, while before it was only a line.\nI am not convinced that we should log this at WARN level, because any I/O error due to the other peer will show up as a big stack trace in the logs.\nI'd change warn() to debug().", "author": "sbordet", "createdAt": "2020-09-01T20:56:53Z", "path": "jetty-websocket/websocket-core-common/src/main/java/org/eclipse/jetty/websocket/core/internal/WebSocketConnection.java", "diffHunk": "@@ -469,9 +469,12 @@ private void fillAndParse()\n         }\n         catch (Throwable t)\n         {\n-            LOG.warn(t.toString());\n-            BufferUtil.clear(networkBuffer.getBuffer());\n-            releaseNetworkBuffer();\n+            LOG.warn(\"Error during fillAndParse()\", t);", "originalCommit": "abb5ae881257788d3de84801e3f7c2228961fc37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5NTMxOA==", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r481495318", "bodyText": "I agree, we already give this error to the websocket endpoint with processConnectionError so no reason to warn here.", "author": "lachlan-roberts", "createdAt": "2020-09-01T23:55:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjY5MA==", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r481426690", "bodyText": "Why do you need the NPE guard now?", "author": "sbordet", "createdAt": "2020-09-01T20:57:14Z", "path": "jetty-websocket/websocket-core-common/src/main/java/org/eclipse/jetty/websocket/core/internal/WebSocketConnection.java", "diffHunk": "@@ -469,9 +469,12 @@ private void fillAndParse()\n         }\n         catch (Throwable t)\n         {\n-            LOG.warn(t.toString());\n-            BufferUtil.clear(networkBuffer.getBuffer());\n-            releaseNetworkBuffer();\n+            LOG.warn(\"Error during fillAndParse()\", t);\n+            if (networkBuffer != null)\n+            {\n+                BufferUtil.clear(networkBuffer.getBuffer());\n+                releaseNetworkBuffer();\n+            }", "originalCommit": "abb5ae881257788d3de84801e3f7c2228961fc37", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ5NDAwMA==", "url": "https://github.com/eclipse/jetty.project/pull/5213#discussion_r481494000", "bodyText": "While reproducing this bug I was occasionally getting some ReadPendingException from fillInterested(), and we call this after we have already released the network buffer so it was null.", "author": "lachlan-roberts", "createdAt": "2020-09-01T23:50:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjY5MA=="}], "type": "inlineReview"}, {"oid": "5bdcea2a49410ddbb048ad393f779d61d5cc017f", "url": "https://github.com/eclipse/jetty.project/commit/5bdcea2a49410ddbb048ad393f779d61d5cc017f", "message": "change log warning for fillAndParse errors to debug log\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-09-01T23:55:18Z", "type": "commit"}]}