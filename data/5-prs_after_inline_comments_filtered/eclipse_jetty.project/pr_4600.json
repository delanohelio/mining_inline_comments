{"pr_number": 4600, "pr_title": "Fixed InfinispanSessionData serialization issues when using infinispan", "pr_createdAt": "2020-02-24T09:54:06Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4600", "timeline": [{"oid": "287c6ce7098e14dee1168f62f86d15abf46f3e19", "url": "https://github.com/eclipse/jetty.project/commit/287c6ce7098e14dee1168f62f86d15abf46f3e19", "message": "Fixed InfinispanSessionData serialization issues when using infinispan\nembedded\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-02-24T09:48:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3NTQ3NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383175475", "bodyText": "Why did you change the test data so that all will have expired?", "author": "janbartel", "createdAt": "2020-02-24T10:11:18Z", "path": "tests/test-sessions/test-infinispan-sessions/src/test/java/org/eclipse/jetty/server/session/InfinispanSessionDataStoreTest.java", "diffHunk": "@@ -164,30 +166,26 @@ public boolean checkSessionPersisted(SessionData data) throws Exception\n     @Test\n     public void testQuery() throws Exception\n     {\n-        Cache<String, SessionData> cache = _testSupport.getCache();\n+        InfinispanSessionData sd1 = new InfinispanSessionData(\"sd1\", \"\", \"\", 0, 0, 0, 1000);", "originalCommit": "287c6ce7098e14dee1168f62f86d15abf46f3e19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4OTMxMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383189311", "bodyText": "The previous testQuery didn't work from the beginning, so I replaced it with the test used in RemoteInfinispanSessionDataStoreTest", "author": "kandrej", "createdAt": "2020-02-24T10:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3NTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxNTQzMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383815431", "bodyText": "Fair enough.", "author": "janbartel", "createdAt": "2020-02-25T11:15:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3NTQ3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3NTk3Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383175976", "bodyText": "Also, why did you change the query? The query did the same search as the InfinispanSessionDataStore implementation.", "author": "janbartel", "createdAt": "2020-02-24T10:12:08Z", "path": "tests/test-sessions/test-infinispan-sessions/src/test/java/org/eclipse/jetty/server/session/InfinispanSessionDataStoreTest.java", "diffHunk": "@@ -164,30 +166,26 @@ public boolean checkSessionPersisted(SessionData data) throws Exception\n     @Test\n     public void testQuery() throws Exception\n     {\n-        Cache<String, SessionData> cache = _testSupport.getCache();\n+        InfinispanSessionData sd1 = new InfinispanSessionData(\"sd1\", \"\", \"\", 0, 0, 0, 1000);\n+        sd1.setLastNode(\"fred1\");\n+        _testSupport.getCache().put(\"session1\", sd1);\n \n-        SessionData sd1 = new SessionData(\"sd1\", \"\", \"\", 0, 0, 0, 0);\n-        SessionData sd2 = new SessionData(\"sd2\", \"\", \"\", 0, 0, 0, 1000);\n-        sd2.setExpiry(100L); //long ago\n-        SessionData sd3 = new SessionData(\"sd3\", \"\", \"\", 0, 0, 0, 0);\n+        InfinispanSessionData sd2 = new InfinispanSessionData(\"sd2\", \"\", \"\", 0, 0, 0, 2000);\n+        sd2.setLastNode(\"fred2\");\n+        _testSupport.getCache().put(\"session2\", sd2);\n \n-        cache.put(\"session1\", sd1);\n-        cache.put(\"session2\", sd2);\n-        cache.put(\"session3\", sd3);\n+        InfinispanSessionData sd3 = new InfinispanSessionData(\"sd3\", \"\", \"\", 0, 0, 0, 3000);\n+        sd3.setLastNode(\"fred3\");\n+        _testSupport.getCache().put(\"session3\", sd3);\n \n-        QueryFactory qf = Search.getQueryFactory(cache);\n-        Query q = qf.from(SessionData.class).select(\"id\").having(\"expiry\").lte(System.currentTimeMillis()).and().having(\"expiry\").gt(0).toBuilder().build();\n+        QueryFactory qf = Search.getQueryFactory(_testSupport.getCache());\n \n-        List<Object[]> list = q.list();\n-\n-        List<String> ids = new ArrayList<>();\n-        for (Object[] sl : list)\n+        for (int i = 0; i <= 3; i++)\n         {\n-            ids.add((String)sl[0]);\n+            long now = System.currentTimeMillis();\n+            Query q = qf.from(InfinispanSessionData.class).having(\"expiry\").lt(now).build();", "originalCommit": "287c6ce7098e14dee1168f62f86d15abf46f3e19", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3NjE3Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383176177", "bodyText": "Can we have a test both with and without storeAsBinary enabled, to be on the safe side?", "author": "janbartel", "createdAt": "2020-02-24T10:12:32Z", "path": "tests/test-sessions/test-infinispan-sessions/src/test/java/org/eclipse/jetty/server/session/InfinispanTestSupport.java", "diffHunk": "@@ -113,7 +113,7 @@ public void setup() throws Exception\n                 .persistence()\n                 .addSingleFileStore()\n                 .location(_tmpdir.getAbsolutePath())\n-                .storeAsBinary()\n+                .storeAsBinary().enable()", "originalCommit": "287c6ce7098e14dee1168f62f86d15abf46f3e19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE4OTg0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383189846", "bodyText": "Yes. It just triggers serialization, so data in the cache is in serialized form", "author": "kandrej", "createdAt": "2020-02-24T10:38:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3NjE3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxNTg1Mg==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383815852", "bodyText": "I mean can you make a test both with and without storeAsBinaryEnabled please.", "author": "janbartel", "createdAt": "2020-02-25T11:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3NjE3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3Nzc5Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383177793", "bodyText": "Why is this class necessary? We are using the org.eclipse.jetty.session.infinispan.SessionDataMarshaller now, are you saying this class replaces the SessionDataMarshaller?", "author": "janbartel", "createdAt": "2020-02-24T10:15:36Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/InfinispanSessionDataSerializer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.eclipse.jetty.session.infinispan;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+\n+import org.infinispan.commons.marshall.Externalizer;\n+\n+public class InfinispanSessionDataSerializer implements Externalizer<InfinispanSessionData>", "originalCommit": "287c6ce7098e14dee1168f62f86d15abf46f3e19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE5NTAxNQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383195015", "bodyText": "SessionDataMarshaller is ok in the remote setup, but it is not used in embedded infinispan when storeAsBinary is enabled. In this case the default java serialization rules are used, which fail because the SessionData readObject is invoked and ObjectInputStream is not ClassLoadingObjectInputStream", "author": "kandrej", "createdAt": "2020-02-24T10:48:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3Nzc5Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxNDE4OA==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383814188", "bodyText": "OK. Please see my comment above about the presence of the annotation.", "author": "janbartel", "createdAt": "2020-02-25T11:13:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3Nzc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3ODE1OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383178159", "bodyText": "Please see the o.j.e.session.infinispan.SessionDataMarshaller regarding the requirements for the first field that is serialized: the version.", "author": "janbartel", "createdAt": "2020-02-24T10:16:18Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/InfinispanSessionDataSerializer.java", "diffHunk": "@@ -0,0 +1,69 @@\n+package org.eclipse.jetty.session.infinispan;\n+\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.ObjectInput;\n+import java.io.ObjectOutput;\n+\n+import org.infinispan.commons.marshall.Externalizer;\n+\n+public class InfinispanSessionDataSerializer implements Externalizer<InfinispanSessionData>\n+{\n+\n+    private static final long serialVersionUID = 1L;\n+\n+    @Override\n+    public void writeObject(ObjectOutput output, InfinispanSessionData object) throws IOException\n+    {\n+        output.writeUTF(object.getId()); //session id", "originalCommit": "287c6ce7098e14dee1168f62f86d15abf46f3e19", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxNDcwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383814709", "bodyText": "Rather than copying the serialization, I'd rather that there was a refactoring that made it possible for your new class and the SessionDataMarshaller to use the same code.", "author": "janbartel", "createdAt": "2020-02-25T11:14:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzE3ODE1OQ=="}], "type": "inlineReview"}, {"oid": "4fae023c0d53c99638474bc82ce90e561cbcbda6", "url": "https://github.com/eclipse/jetty.project/commit/4fae023c0d53c99638474bc82ce90e561cbcbda6", "message": "Added version to InfinispanSessionDataSerializer\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-02-25T08:24:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxNDAwMw==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383814003", "bodyText": "You're sure that this annotation will have no effect in the remote case?", "author": "janbartel", "createdAt": "2020-02-25T11:12:34Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/InfinispanSessionData.java", "diffHunk": "@@ -19,6 +20,7 @@\n  * pool and thus these threads have no knowledge of the correct classloader to\n  * use.\n  */\n+@SerializeWith(InfinispanSessionDataSerializer.class)", "originalCommit": "4fae023c0d53c99638474bc82ce90e561cbcbda6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzk2NzEwNA==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r383967104", "bodyText": "I am not sure, but I run the remote tests and it doesn't seem to have any effect on those", "author": "kandrej", "createdAt": "2020-02-25T15:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzgxNDAwMw=="}], "type": "inlineReview"}, {"oid": "e64fee5a486dbd99acdde322950b28efd1746303", "url": "https://github.com/eclipse/jetty.project/commit/e64fee5a486dbd99acdde322950b28efd1746303", "message": "Refactored InfinispanSessionDataSerializer to make use of\nSessionDataMarshaller\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-02-25T15:45:53Z", "type": "commit"}, {"oid": "d6517b92a4470c3d6ff31a3e3004dabbc9eeb056", "url": "https://github.com/eclipse/jetty.project/commit/d6517b92a4470c3d6ff31a3e3004dabbc9eeb056", "message": "Tests with and without storeAsBinary enabled\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-02-26T08:43:36Z", "type": "commit"}, {"oid": "6cbb83aba34c01cb96db4c61cc19b5e8239011d7", "url": "https://github.com/eclipse/jetty.project/commit/6cbb83aba34c01cb96db4c61cc19b5e8239011d7", "message": "Merged InfinispanSessionDataSerializer and SessionDataMarshaller\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-02-27T08:04:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwMzI5Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r385803293", "bodyText": "The thing is, we don't want to do this static initialization all the time. Certainly when we use infinispan remote, the use of the session.proto is already configured into a different serialization context, so this static initialization is wasted.\nIn jetty we are generally static-phobic: we prefer if we can do things per instance.", "author": "janbartel", "createdAt": "2020-02-28T16:46:07Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/SessionDataMarshaller.java", "diffHunk": "@@ -30,13 +39,35 @@\n  * control to ensure that session attributes can be deserialized using either\n  * the container class loader or the webapp classloader, as appropriate.\n  */\n-public class SessionDataMarshaller implements MessageMarshaller<InfinispanSessionData>\n+public class SessionDataMarshaller implements MessageMarshaller<InfinispanSessionData>, Externalizer<InfinispanSessionData>\n {\n     /**\n      * The version of the serializer.\n      */\n     private static final int VERSION = 0;\n \n+    private static final Logger LOG = Log.getLogger(\"org.eclipse.jetty.server.session\");\n+    \n+    private static SerializationContext serializationContext;\n+\n+    static\n+    {\n+        FileDescriptorSource fds = new FileDescriptorSource();\n+        try\n+        {\n+            fds.addProtoFiles(\"/session.proto\");\n+            serializationContext = ProtobufUtil.newSerializationContext();\n+            serializationContext.registerProtoFiles(fds);\n+            serializationContext.registerMarshaller(new SessionDataMarshaller());\n+        }\n+        catch (IOException e)\n+        {\n+            serializationContext = null;\n+            LOG.warn(\"SerializationContext cannot be initialized\", e);\n+        }\n+\n+    }\n+    ", "originalCommit": "6cbb83aba34c01cb96db4c61cc19b5e8239011d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTgwMzkzMg==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r385803932", "bodyText": "Also here I wanted to avoid the double copying and buffering of data, which is why I was suggesting having a common method that worked with both ObejectInput and ProtoSteamReader.", "author": "janbartel", "createdAt": "2020-02-28T16:47:16Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/SessionDataMarshaller.java", "diffHunk": "@@ -49,6 +80,50 @@ public String getTypeName()\n         return \"org_eclipse_jetty_session_infinispan.InfinispanSessionData\";\n     }\n \n+    @Override\n+    public InfinispanSessionData readObject(ObjectInput input) throws IOException, ClassNotFoundException\n+    {\n+        if (serializationContext != null)\n+        {\n+            ByteArrayOutputStream os = new ByteArrayOutputStream();\n+            int bufferSize = 4 * 1024;\n+            byte[] buffer = new byte[bufferSize];\n+            int len = -1;\n+            while ((len = input.read(buffer, 0, bufferSize)) != -1)\n+            {\n+                os.write(buffer, 0, len);\n+            }\n+\n+            // invokes readFrom(ProtoStreamReader)\n+            InfinispanSessionData data = ProtobufUtil.fromByteArray(serializationContext, os.toByteArray(),", "originalCommit": "6cbb83aba34c01cb96db4c61cc19b5e8239011d7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "690e2d447531844c4b55ac850942f352e9ead6c0", "url": "https://github.com/eclipse/jetty.project/commit/690e2d447531844c4b55ac850942f352e9ead6c0", "message": "Wrapped Object Input/Output to Input/Output Streams\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-03-02T08:33:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNjAzNA==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r389736034", "bodyText": "Can we keep the SerializationContext as a field that is lazily initialized only by the readObject/writeObject methods? The field would not be used by the readFrom/writeTo methods.", "author": "janbartel", "createdAt": "2020-03-09T14:44:22Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/SessionDataMarshaller.java", "diffHunk": "@@ -39,35 +38,24 @@\n  * control to ensure that session attributes can be deserialized using either\n  * the container class loader or the webapp classloader, as appropriate.\n  */\n-public class SessionDataMarshaller implements MessageMarshaller<InfinispanSessionData>, Externalizer<InfinispanSessionData>\n+public class SessionDataMarshaller\n+        implements MessageMarshaller<InfinispanSessionData>, Externalizer<InfinispanSessionData>\n {\n     /**\n      * The version of the serializer.\n      */\n     private static final int VERSION = 0;\n \n-    private static final Logger LOG = Log.getLogger(\"org.eclipse.jetty.server.session\");\n-    \n-    private static SerializationContext serializationContext;\n-\n-    static\n+    private SerializationContext initSerializationContext() throws IOException\n     {\n         FileDescriptorSource fds = new FileDescriptorSource();", "originalCommit": "690e2d447531844c4b55ac850942f352e9ead6c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc2Njc1MA==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r389766750", "bodyText": "It is useless to keep SerializationContext because a new SessionDataMarshaller instance is created every time readObject or writeObject is called. I can either have it as a lazily initialized static field or create one every time", "author": "kandrej", "createdAt": "2020-03-09T15:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNjAzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4ODU5OA==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r393588598", "bodyText": "Lets make it a static, lazily initialized. That way, if the remote protobuf marshalling is being used, it will never be initialized, it is only if the Externalizer methods are called that it will be initialized.", "author": "janbartel", "createdAt": "2020-03-17T10:45:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNjAzNA=="}], "type": "inlineReview"}, {"oid": "f4f77701b56d90a93ce5f9c4a1d3b2b203720b4d", "url": "https://github.com/eclipse/jetty.project/commit/f4f77701b56d90a93ce5f9c4a1d3b2b203720b4d", "message": "Fixed an issue when reading the session data from a file.\nModified tests to force read from file if available.\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-03-12T10:41:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r391635891", "bodyText": "Can you explain the necessity for this special write? And also the BoundDelegatingInputStream?", "author": "janbartel", "createdAt": "2020-03-12T13:54:25Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/SessionDataMarshaller.java", "diffHunk": "@@ -49,6 +67,33 @@ public String getTypeName()\n         return \"org_eclipse_jetty_session_infinispan.InfinispanSessionData\";\n     }\n \n+    @Override\n+    public InfinispanSessionData readObject(ObjectInput input) throws IOException, ClassNotFoundException\n+    {\n+        SerializationContext serializationContext = initSerializationContext();\n+\n+        // invokes readFrom(ProtoStreamReader)\n+        InfinispanSessionData data = ProtobufUtil.readFrom(serializationContext, new BoundDelegatingInputStream(input),\n+                InfinispanSessionData.class);\n+        if (data != null)\n+        {\n+            data.deserializeAttributes();\n+        }\n+        return data;\n+    }\n+\n+    @Override\n+    public void writeObject(ObjectOutput output, InfinispanSessionData object) throws IOException\n+    {\n+        SerializationContext serializationContext = initSerializationContext();\n+\n+     // invokes writeTo(ProtoStreamWriter, InfinispanSessionData)\n+        byte[] data = ProtobufUtil.toByteArray(serializationContext, object);\n+        int length = data.length;\n+        output.write(ByteBuffer.allocate(4).putInt(length).array());\n+        output.write(data);        \n+    }\n+", "originalCommit": "f4f77701b56d90a93ce5f9c4a1d3b2b203720b4d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY1Mjk0Mg==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r391652942", "bodyText": "I found out that when reading the session from a file, the returned ObjectInput has more data than writeObject has written. It seems Infinispan appends some data at the end for some reason.\nIf I just wrap all the data in an InputStream, Protobuf fails to deserialize the session. So to know exactly how many bytes need to be parsed, the write first saves the length of the data.\nBoundDelegatingInputStream is just a wrapper that first reads the length of the data and stops when the length is reached.", "author": "kandrej", "createdAt": "2020-03-12T14:19:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY4MDAzNg==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r391680036", "bodyText": "So if you configure storeAsBinary, but don't use a filestore, what happens? Is that combination even possible?", "author": "janbartel", "createdAt": "2020-03-12T14:57:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTcwMzM5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r391703391", "bodyText": "Sure is possible. storeAsBinary means that the data is stored serialized in the cache (memory). The file is always binary\nThis means that when you put an instance in the cache the instance is first serialized and than saved. When you get an instance from the cache it has to be deserialized first. In this case the data from the cache is just copied to a file\nIf storeAsBinary is disabled, you put and get the instance itself in the cache. The data is serialized only when it is moved from the cache to the file", "author": "kandrej", "createdAt": "2020-03-12T15:31:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk0MTg2Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r392941867", "bodyText": "If storeAsBinary=true but not filestore, which form of serialization is used?", "author": "janbartel", "createdAt": "2020-03-16T11:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mjk1MTAxMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r392951011", "bodyText": "Always the Externalizer interface", "author": "kandrej", "createdAt": "2020-03-16T11:29:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE1MzUwNA==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r393153504", "bodyText": "Store as binary is explained in the user guide:\nhttps://infinispan.org/docs/9.4.x/user_guide/user_guide.html#store_binary", "author": "kandrej", "createdAt": "2020-03-16T16:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzU4OTI1MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r393589251", "bodyText": "I wish infinispan had a unified serialization api!\nI think we're good with your solution (just make the serialization context a lazily initialized static).", "author": "janbartel", "createdAt": "2020-03-17T10:46:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTYzNTg5MQ=="}], "type": "inlineReview"}, {"oid": "d436892ce0ed1ec05214859b311d0fba3d706350", "url": "https://github.com/eclipse/jetty.project/commit/d436892ce0ed1ec05214859b311d0fba3d706350", "message": "static lazy init serializationContext\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-03-17T11:09:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYxMDAyMw==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r393610023", "bodyText": "I think you're going to need some synchronization - the lazy init of the serializationContext fields isn't thread safe, is it?", "author": "janbartel", "createdAt": "2020-03-17T11:26:37Z", "path": "jetty-infinispan/infinispan-common/src/main/java/org/eclipse/jetty/session/infinispan/SessionDataMarshaller.java", "diffHunk": "@@ -49,6 +68,39 @@ public String getTypeName()\n         return \"org_eclipse_jetty_session_infinispan.InfinispanSessionData\";\n     }\n \n+    @Override\n+    public InfinispanSessionData readObject(ObjectInput input) throws IOException, ClassNotFoundException\n+    {\n+        if (serializationContext == null)", "originalCommit": "d436892ce0ed1ec05214859b311d0fba3d706350", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYyNTIwOA==", "url": "https://github.com/eclipse/jetty.project/pull/4600#discussion_r393625208", "bodyText": "You're right, better be sure", "author": "kandrej", "createdAt": "2020-03-17T11:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzYxMDAyMw=="}], "type": "inlineReview"}, {"oid": "7d82ea52c9d375d75db97dbd58a1b8792fb1e49d", "url": "https://github.com/eclipse/jetty.project/commit/7d82ea52c9d375d75db97dbd58a1b8792fb1e49d", "message": "synchronized initSerializationContext\n\nSigned-off-by: Andrej Krota <andrej.krota@gmail.com>", "committedDate": "2020-03-17T11:49:41Z", "type": "commit"}]}