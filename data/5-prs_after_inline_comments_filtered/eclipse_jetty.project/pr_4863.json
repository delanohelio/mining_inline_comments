{"pr_number": 4863, "pr_title": "Issue #4860 - NPE from HttpFields", "pr_createdAt": "2020-05-11T12:05:01Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4863", "timeline": [{"oid": "c497b61917a4e4fd09bb098bd264bf06e62db317", "url": "https://github.com/eclipse/jetty.project/commit/c497b61917a4e4fd09bb098bd264bf06e62db317", "message": "Issue #4860 NPE from HttpFields\n\nParanoid catch if sending and exception page throws an exception.\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-05-11T11:57:17Z", "type": "commit"}, {"oid": "6af6af6419b43fce0c7c291579677681f901b676", "url": "https://github.com/eclipse/jetty.project/commit/6af6af6419b43fce0c7c291579677681f901b676", "message": "Issue #4860 NPE from HttpFields\n\nImproved test coverage\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-05-11T11:58:27Z", "type": "commit"}, {"oid": "1ac7fe4f9c0726c70102e83fe4e3a93901d9872c", "url": "https://github.com/eclipse/jetty.project/commit/1ac7fe4f9c0726c70102e83fe4e3a93901d9872c", "message": "Issue #4860 NPE from HttpFields\n\n + Fix bug with list iterator nextIndex\n + List iterator cannot inject null fields\n + minor cleanups\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-05-11T12:00:04Z", "type": "commit"}, {"oid": "2c7c98f4690d2db399005b48dd42e9d2f5131edd", "url": "https://github.com/eclipse/jetty.project/commit/2c7c98f4690d2db399005b48dd42e9d2f5131edd", "message": "Eliminate warnings\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-11T15:03:12Z", "type": "commit"}, {"oid": "90da10dac57c9a4cf5bea85176077e5862c9589b", "url": "https://github.com/eclipse/jetty.project/commit/90da10dac57c9a4cf5bea85176077e5862c9589b", "message": "Issue #4860 - Improving testPreventNullField testcase\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-11T15:05:56Z", "type": "commit"}, {"oid": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "url": "https://github.com/eclipse/jetty.project/commit/6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "message": "Issue #4860 - Consistency to HttpFields API\n\nIf a null name (or HttpHeader or HttpField) is used\nit should throw an ISE\n\n+ .add() should remain consistent\n+ .put() should remain consistent\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-11T15:34:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzE3ODc3NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423178775", "bodyText": "@joakime This comment is wrong.  Setting null used to put in a null entry, but now is a noop.", "author": "gregw", "createdAt": "2020-05-11T16:51:40Z", "path": "jetty-http/src/test/java/org/eclipse/jetty/http/HttpFieldsTest.java", "diffHunk": "@@ -710,15 +749,15 @@ public void testPreventNullField()\n         assertThat(fields.size(), is(1));\n         ListIterator<HttpField> iter = fields.listIterator();\n         iter.next();\n-        iter.set(null);\n+        iter.set(null); // set field to null - null entry in list now", "originalCommit": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTE4OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423251189", "bodyText": "Since you bothered adding a message to the NPE, make it \"header name cannot be null\", or at least \"header name\", as \"name\" alone is just too laconic to be useful.", "author": "sbordet", "createdAt": "2020-05-11T18:56:42Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpField.java", "diffHunk": "@@ -40,7 +40,7 @@ public HttpField(HttpHeader header, String name, String value)\n         if (_header != null && name == null)\n             _name = _header.asString();\n         else\n-            _name = Objects.requireNonNull(name);\n+            _name = Objects.requireNonNull(name, \"name\");", "originalCommit": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTQ4NA==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423251484", "bodyText": "\"header cannot be null\".", "author": "sbordet", "createdAt": "2020-05-11T18:57:15Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -671,6 +676,8 @@ public void put(HttpHeader header, HttpHeaderValue value)\n      */\n     public void put(HttpHeader header, String value)\n     {\n+        Objects.requireNonNull(header, \"header\");", "originalCommit": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MTYwNw==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423251607", "bodyText": "\"name cannot be null\"", "author": "sbordet", "createdAt": "2020-05-11T18:57:27Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -685,7 +692,12 @@ public void put(HttpHeader header, String value)\n      */\n     public void put(String name, List<String> list)\n     {\n+        Objects.requireNonNull(name, \"name\");", "originalCommit": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MjU1MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423252551", "bodyText": "\"header cannot be null\"", "author": "sbordet", "createdAt": "2020-05-11T18:59:11Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -723,6 +736,8 @@ public void add(HttpHeader header, HttpHeaderValue value)\n      */\n     public void add(HttpHeader header, String value)\n     {\n+        Objects.requireNonNull(header, \"header\");", "originalCommit": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzIyMA==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423253220", "bodyText": "We are no-op all the other cases, most notably add(String, String) above, so why throw here?", "author": "sbordet", "createdAt": "2020-05-11T19:00:28Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -723,6 +736,8 @@ public void add(HttpHeader header, HttpHeaderValue value)\n      */\n     public void add(HttpHeader header, String value)\n     {\n+        Objects.requireNonNull(header, \"header\");\n+\n         if (value == null)\n             throw new IllegalArgumentException(\"null value\");", "originalCommit": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4MDk3Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423280973", "bodyText": "Because it will have servlet API impacts.  There is a separate issue that I thought you and and @lachlan-roberts  were working on to normalise the API in 10 to either always noop or always ISE (I can't remember which).  Either way, I don't want to change behaviour in this PR other than to avoid noops and later NPEs (eg from null names or null fields).", "author": "gregw", "createdAt": "2020-05-11T19:52:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI1MzIyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI2NDYyMw==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423264623", "bodyText": "Should not the last parameter be _size++ - _cursor?\nAnd yes, I would rather separate the ++ and -- to different lines so that they are more comprehensible.\nFor example, it takes too much brain power to know if 5++ - 3 is 2 or 3.\nWe have tests that call add(HttpField) but the error in the copy does not show because the array is initialized to 16 elements but in the tests _size is only 4-5.", "author": "sbordet", "createdAt": "2020-05-11T19:21:29Z", "path": "jetty-http/src/main/java/org/eclipse/jetty/http/HttpFields.java", "diffHunk": "@@ -1199,16 +1217,22 @@ public void set(HttpField field)\n         {\n             if (_current < 0)\n                 throw new IllegalStateException();\n-            _fields[_current] = field;\n+            if (field == null)\n+                remove();\n+            else\n+                _fields[_current] = field;\n         }\n \n         @Override\n         public void add(HttpField field)\n         {\n-            _fields = Arrays.copyOf(_fields, _fields.length + 1);\n-            System.arraycopy(_fields, _cursor, _fields, _cursor + 1, _size++);\n-            _fields[_cursor++] = field;\n-            _current = -1;\n+            if (field != null)\n+            {\n+                _fields = Arrays.copyOf(_fields, _fields.length + 1);\n+                System.arraycopy(_fields, _cursor, _fields, _cursor + 1, _size++);", "originalCommit": "6ae75be9bcb7e2059804f1bffcfd18dad44c68d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI4MjkwMA==", "url": "https://github.com/eclipse/jetty.project/pull/4863#discussion_r423282900", "bodyText": "Yep it's a bug and if I change the capacity to 5 in the test I get a failure... but I don't see that it is the bug we are looking for :(", "author": "gregw", "createdAt": "2020-05-11T19:56:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzI2NDYyMw=="}], "type": "inlineReview"}, {"oid": "59a66158ed0c12dd10cec842b0ccf595cbe2e4eb", "url": "https://github.com/eclipse/jetty.project/commit/59a66158ed0c12dd10cec842b0ccf595cbe2e4eb", "message": "Issue #4860 NPE HttpFields\n\nFixes from review.\nFixed iterator overflow bug\nclearer updates of size\nbetter nonNull messages\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-05-11T20:09:19Z", "type": "commit"}, {"oid": "4dc024b2b1b4d84493675403df77e2724bed831f", "url": "https://github.com/eclipse/jetty.project/commit/4dc024b2b1b4d84493675403df77e2724bed831f", "message": "Issue #4860 - Fixing test comment\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-05-11T22:25:49Z", "type": "commit"}, {"oid": "d127db5186be4950d92199b5cda43b4f6a94a126", "url": "https://github.com/eclipse/jetty.project/commit/d127db5186be4950d92199b5cda43b4f6a94a126", "message": "Merge branch 'jetty-9.4.x-4860-NullHttpFields' of github.com:eclipse/jetty.project into jetty-9.4.x-4860-NullHttpFields", "committedDate": "2020-05-11T22:26:05Z", "type": "commit"}]}