{"pr_number": 4810, "pr_title": "Issue #4800 - fix WebSocket LinkageError and invalid PathParam type handling", "pr_createdAt": "2020-04-24T10:17:07Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4810", "timeline": [{"oid": "7c2d804ce9c11f8479ddd5868c77bd9cf0e697ed", "url": "https://github.com/eclipse/jetty.project/commit/7c2d804ce9c11f8479ddd5868c77bd9cf0e697ed", "message": "Change the WSServer to allow deployment of multiple webapps\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-24T00:18:24Z", "type": "commit"}, {"oid": "f5b0dc56d27fdaf99a44fa4793296c75de632a3e", "url": "https://github.com/eclipse/jetty.project/commit/f5b0dc56d27fdaf99a44fa4793296c75de632a3e", "message": "Issue #4800 - Reproduce LinkageError in WebSocket unit test\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-24T03:14:42Z", "type": "commit"}, {"oid": "870a7654645b638f7c57217b3d3b347696e18ee7", "url": "https://github.com/eclipse/jetty.project/commit/870a7654645b638f7c57217b3d3b347696e18ee7", "message": "Issue #4800 - prevent LinkageErrors for WS lookup on JDK 14\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-24T03:31:29Z", "type": "commit"}, {"oid": "fb85c71f8d1fde93cb248f6f425d017dda67231d", "url": "https://github.com/eclipse/jetty.project/commit/fb85c71f8d1fde93cb248f6f425d017dda67231d", "message": "Issue #4800 - invalid PathParam types should be reported at Deployment\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-24T07:11:23Z", "type": "commit"}, {"oid": "64beae3382862c5a96ab887466194ef6cd7593c5", "url": "https://github.com/eclipse/jetty.project/commit/64beae3382862c5a96ab887466194ef6cd7593c5", "message": "Issue #4800 - test both cases individually\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-24T10:16:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzkxNw==", "url": "https://github.com/eclipse/jetty.project/pull/4810#discussion_r414463917", "bodyText": "I had the idea about adding another webapp to be sure it's still deployed despite having this LinkageError", "author": "olamy", "createdAt": "2020-04-24T10:19:09Z", "path": "tests/test-distribution/src/test/java/org/eclipse/jetty/tests/distribution/DistributionTests.java", "diffHunk": "@@ -440,19 +439,14 @@ public void testSimpleWebAppWithWebsocket(String arg) throws Exception\n             try (DistributionTester.Run run2 = distribution.start(args2))\n             {\n                 assertTrue(run2.awaitConsoleLogsFor(\"Started Server@\", 10, TimeUnit.SECONDS));\n-                // we do not test that anymore because it doesn't work for java14\n-                //assertFalse(run2.getLogs().stream().anyMatch(s -> s.contains(\"LinkageError\")));\n+                assertFalse(run2.getLogs().stream().anyMatch(s -> s.contains(\"LinkageError\")));\n \n                 startHttpClient();\n                 ContentResponse response = client.GET(\"http://localhost:\" + port + \"/test1/index.jsp\");\n-                assertEquals(HttpStatus.OK_200, response.getStatus());\n-                assertThat(response.getContentAsString(), containsString(\"Hello\"));\n-                assertThat(response.getContentAsString(), not(containsString(\"<%\")));\n+                assertEquals(HttpStatus.SERVICE_UNAVAILABLE_503, response.getStatus());\n \n                 client.GET(\"http://localhost:\" + port + \"/test2/index.jsp\");\n-                assertEquals(HttpStatus.OK_200, response.getStatus());\n-                assertThat(response.getContentAsString(), containsString(\"Hello\"));\n-                assertThat(response.getContentAsString(), not(containsString(\"<%\")));\n+                assertEquals(HttpStatus.SERVICE_UNAVAILABLE_503, response.getStatus());", "originalCommit": "64beae3382862c5a96ab887466194ef6cd7593c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2NTk1Mg==", "url": "https://github.com/eclipse/jetty.project/pull/4810#discussion_r414465952", "bodyText": "The MethodHandle changes in this PR fix the LinkageError, but now this particular webapp should fail at deployment time anyway as the signature is wrong.", "author": "lachlan-roberts", "createdAt": "2020-04-24T10:22:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ3MjkyOA==", "url": "https://github.com/eclipse/jetty.project/pull/4810#discussion_r414472928", "bodyText": "Should I add in another webapp here to test that it deploys successfully even if these two fail?", "author": "lachlan-roberts", "createdAt": "2020-04-24T10:34:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ4Mzg0MQ==", "url": "https://github.com/eclipse/jetty.project/pull/4810#discussion_r414483841", "bodyText": "yes. I would even say 2 :). I'm not sure about deployment order of contexts. maybe one first and one last. to ensure the failure do not break anything else to be deployed.", "author": "olamy", "createdAt": "2020-04-24T10:54:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzkxNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzcwNTQ0Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4810#discussion_r417705443", "bodyText": "@lachlan-roberts great tests changes! we now even have real websocket tests in the distribution tests module!", "author": "olamy", "createdAt": "2020-04-30T01:29:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDQ2MzkxNw=="}], "type": "inlineReview"}, {"oid": "c8a1dacdd09b8445c2f144d6b2590186608dc6d9", "url": "https://github.com/eclipse/jetty.project/commit/c8a1dacdd09b8445c2f144d6b2590186608dc6d9", "message": "Issue #4800 - Improve WS DistributionTest to also test working webapp\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-27T00:54:06Z", "type": "commit"}, {"oid": "bf5d4ea55448476d8f97944c6ab025cf67160e8b", "url": "https://github.com/eclipse/jetty.project/commit/bf5d4ea55448476d8f97944c6ab025cf67160e8b", "message": "Issue #4800 - Revert MethodHandle changes & update DistributionTests\n\n- It seems it is correct to use the `MethodHandles.publicLookup().in()`\nbut this does not work if same webapp is deployed twice, so the\nMethodHandle changes have been reverted and the test has been disabled\nuntil a resolution to https://bugs.openjdk.java.net/browse/JDK-8244090.\n\n- The DistributionTest has been changed to properly reproduce the issue.\nThere must be a class in the signature of the websocket endpoint which\nis available to both webapps and the client must send and receive an echo\nmessage to ensure that the onOpen MethodHandle is actually invoked.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-29T12:52:26Z", "type": "commit"}, {"oid": "b0e57ffd6dd0ff30a318c832db860810f156f767", "url": "https://github.com/eclipse/jetty.project/commit/b0e57ffd6dd0ff30a318c832db860810f156f767", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-LinkageErrorInvestigation", "committedDate": "2020-04-29T12:52:33Z", "type": "commit"}, {"oid": "1ad600ea49de49d03a75f69624f7bb5bc7d5e9fb", "url": "https://github.com/eclipse/jetty.project/commit/1ad600ea49de49d03a75f69624f7bb5bc7d5e9fb", "message": "fix WS DistributionTest incorrect test expectation\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-30T00:14:43Z", "type": "commit"}]}