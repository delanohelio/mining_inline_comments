{"pr_number": 4750, "pr_title": "Issue #4747 - fix some test failures for jetty-10 with websocket tck", "pr_createdAt": "2020-04-07T01:16:45Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4750", "timeline": [{"oid": "664cb81e6ddba5ac3d8683864228081f4ba61972", "url": "https://github.com/eclipse/jetty.project/commit/664cb81e6ddba5ac3d8683864228081f4ba61972", "message": "Issue #4747 - Default close status code should be normal status\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-05T21:48:14Z", "type": "commit"}, {"oid": "2028b99e83f1304388ab572edc40682e3e7a0823", "url": "https://github.com/eclipse/jetty.project/commit/2028b99e83f1304388ab572edc40682e3e7a0823", "message": "Issue #4747 - SessionID should return same String instance\n\nUsing the object hash code is not random enough to use as a unique ID.\nNow using UUID.randomUUID() instead which sufficiently random.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-06T01:54:16Z", "type": "commit"}, {"oid": "54ee3f393907d9e945fd8b6128cb40443406aa5c", "url": "https://github.com/eclipse/jetty.project/commit/54ee3f393907d9e945fd8b6128cb40443406aa5c", "message": "Issue #4747 - Throwing in onClose now calls onError\n\n- This applies to the javax onClose method not the core onClosed method.\n- Also fixes a bug where onClosed may never be called if onFrame throws.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-06T10:28:57Z", "type": "commit"}, {"oid": "625dfd1a4d0b82b6174452b3c669e723388eebe5", "url": "https://github.com/eclipse/jetty.project/commit/625dfd1a4d0b82b6174452b3c669e723388eebe5", "message": "Issue #4747 - Fix WS path params to work within a context path\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-07T02:18:29Z", "type": "commit"}, {"oid": "3d40e0e25d4710760fd071556e6e7912d5ad3ede", "url": "https://github.com/eclipse/jetty.project/commit/3d40e0e25d4710760fd071556e6e7912d5ad3ede", "message": "Issue #4747 - correctly copy headers in websocket JsrUpgradeListener\n\nHeaders with the same name may not have been copied properly for\nheader values inspected and modified with a Configurator.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-07T05:06:25Z", "type": "commit"}, {"oid": "4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "url": "https://github.com/eclipse/jetty.project/commit/4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "message": "Issue #4747 - filter out synthetic annotated methods\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-08T05:31:42Z", "type": "commit"}, {"oid": "4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "url": "https://github.com/eclipse/jetty.project/commit/4e69b483446f6ce6214c2f0d4ab001b0fd204aff", "message": "Issue #4747 - filter out synthetic annotated methods\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-08T05:31:42Z", "type": "forcePushed"}, {"oid": "45f822ed328a93e0457c27308bed12290a827780", "url": "https://github.com/eclipse/jetty.project/commit/45f822ed328a93e0457c27308bed12290a827780", "message": "Issue #4747 - server is allowed to not select a websocket subprotocol\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-08T07:08:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5NDM2NA==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412094364", "bodyText": "I would much rather keep CloseStatus immutable and replace the entire object than have it partially immutable.\nWhy isn't the cause known when it is created? feels wrong!", "author": "gregw", "createdAt": "2020-04-21T11:15:21Z", "path": "jetty-websocket/websocket-core/src/main/java/org/eclipse/jetty/websocket/core/CloseStatus.java", "diffHunk": "@@ -211,6 +211,11 @@ public boolean isAbnormal()\n         return !isOrdinary(code);\n     }\n \n+    public void initCause(Throwable cause)", "originalCommit": "45f822ed328a93e0457c27308bed12290a827780", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5NTU0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412095546", "bodyText": "this seams wrong.  If we were closed for some other reason, then adding a cause to it could put the wrong cause against a close reason.", "author": "gregw", "createdAt": "2020-04-21T11:17:17Z", "path": "jetty-websocket/websocket-core/src/main/java/org/eclipse/jetty/websocket/core/internal/WebSocketSessionState.java", "diffHunk": "@@ -123,6 +123,28 @@ public boolean onClosed(CloseStatus closeStatus)\n         }\n     }\n \n+    /**\n+     * This should only be called directly before closing the connection when we are in {@link State#CLOSED} state.\n+     * This ensures an abnormal close status and if we have no error in the CloseStatus we will set one.\n+     * @param t the error which occurred.\n+     */\n+    public void onError(Throwable t)\n+    {\n+        synchronized (this)\n+        {\n+            if (_sessionState != State.CLOSED || _closeStatus == null)\n+                throw new IllegalArgumentException();\n+\n+            // Override any normal close status.\n+            if (!_closeStatus.isAbnormal())\n+                _closeStatus = new CloseStatus(CloseStatus.SERVER_ERROR, t);\n+\n+            // Otherwise set the error if it wasn't already set to notify onError as well as onClose.\n+            if (_closeStatus.getCause() == null)\n+                _closeStatus.initCause(t);", "originalCommit": "45f822ed328a93e0457c27308bed12290a827780", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEzNTQzMw==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412135433", "bodyText": "If we received an abnormal close frame and throw in onFrame then we want to keep the same close reason but we want to call onError as well so we need to add a cause to the close status so that onError is notified. I can actually change this line to get rid of the weird initCause method.\n_closeStatus = new CloseStatus(_closeStatus.getCode(), _closeStatus.getReason(), t);", "author": "lachlan-roberts", "createdAt": "2020-04-21T12:21:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5NTU0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE5MzIwNg==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412193206", "bodyText": "Definitely change to keep the close status immutable and get rid of the init.\nBut can you describe more.... maybe in comments... exactly why if we already have a close that we want to change just the cause and not the status and the reason as well?", "author": "gregw", "createdAt": "2020-04-21T13:39:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5NTU0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5ODc1Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412098756", "bodyText": "So it is OK to not select a subprotocol?", "author": "gregw", "createdAt": "2020-04-21T11:22:36Z", "path": "jetty-websocket/websocket-core/src/main/java/org/eclipse/jetty/websocket/core/client/ClientUpgradeRequest.java", "diffHunk": "@@ -409,8 +409,6 @@ else if (values.length == 1)\n \n         // Verify the negotiated subprotocol\n         List<String> offeredSubProtocols = getSubProtocols();\n-        if (negotiatedSubProtocol == null && !offeredSubProtocols.isEmpty())\n-            throw new WebSocketException(\"Upgrade failed: no subprotocol selected from offered subprotocols \");", "originalCommit": "45f822ed328a93e0457c27308bed12290a827780", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEzNTc0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412135746", "bodyText": "It's okay to not select one of the offered subprotocols as long as no subprotocol header is sent back.\nIf the client's handshake did not contain such a header field or if\nthe server does not agree to any of the client's requested\nsubprotocols, the only acceptable value is null.  The absence\nof such a field is equivalent to the null value (meaning that\nif the server does not wish to agree to one of the suggested\nsubprotocols, it MUST NOT send back a |Sec-WebSocket-Protocol|\nheader field in its response).", "author": "lachlan-roberts", "createdAt": "2020-04-21T12:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjA5ODc1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEwMDY4Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412100687", "bodyText": "This looks like it may be called a few times per upgade? if so, perhaps do the addPaths in the constructor.", "author": "gregw", "createdAt": "2020-04-21T11:25:46Z", "path": "jetty-websocket/websocket-servlet/src/main/java/org/eclipse/jetty/websocket/servlet/ServletUpgradeRequest.java", "diffHunk": "@@ -314,6 +315,14 @@ public URI getRequestURI()\n         return requestURI;\n     }\n \n+    /**\n+     * @return the path within the context, combination of the ServletPath with the PathInfo.\n+     */\n+    public String getPathInContext()\n+    {\n+        return URIUtil.addPaths(request.getServletPath(), request.getPathInfo());", "originalCommit": "45f822ed328a93e0457c27308bed12290a827780", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc2NzEyOA==", "url": "https://github.com/eclipse/jetty.project/pull/4750#discussion_r412767128", "bodyText": "It is only called once per upgrade, when creating the FrameHandler.", "author": "lachlan-roberts", "createdAt": "2020-04-22T08:10:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEwMDY4Nw=="}], "type": "inlineReview"}, {"oid": "d1163261a0b2018395478f6ecfe51a3dc1f6cfc5", "url": "https://github.com/eclipse/jetty.project/commit/d1163261a0b2018395478f6ecfe51a3dc1f6cfc5", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-4747-WebSocketTCK", "committedDate": "2020-04-21T14:07:31Z", "type": "commit"}, {"oid": "b51a0ad4583039ef0ccf3e261f19d5b8fcfd711b", "url": "https://github.com/eclipse/jetty.project/commit/b51a0ad4583039ef0ccf3e261f19d5b8fcfd711b", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-4747-WebSocketTCK", "committedDate": "2020-04-22T07:39:41Z", "type": "commit"}, {"oid": "c6e58e693b10f09621e1c7721b01389e6021d2e6", "url": "https://github.com/eclipse/jetty.project/commit/c6e58e693b10f09621e1c7721b01389e6021d2e6", "message": "Issue #4747 - changes from review\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-04-22T08:10:49Z", "type": "commit"}]}