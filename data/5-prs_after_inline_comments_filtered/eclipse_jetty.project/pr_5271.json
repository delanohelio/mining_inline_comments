{"pr_number": 5271, "pr_title": "Issue #5022 Filter Cache cleanup", "pr_createdAt": "2020-09-15T15:15:57Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5271", "timeline": [{"oid": "d21edfcddc276ef158d7e44b0adead61dc6fb53d", "url": "https://github.com/eclipse/jetty.project/commit/d21edfcddc276ef158d7e44b0adead61dc6fb53d", "message": "Issue #5022 Filter Cache cleanup\n\nIssue #5022 Filter Cache cleanup:\n + Fixed many compiler warnings\n + removed old LazyList leftovers\n + Don't create holder string for source unless required\n + Only have a single type of chain, so it can be wrapped regardless of cache\n + Reverse mappings lists to make filter chain creation easier\n + build chain directly rather than build a list then a chain\n\nSigned-off-by: Greg Wilkins <gregw@webtide.com>", "committedDate": "2020-09-15T15:14:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc3MjIwMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5271#discussion_r488772201", "bodyText": "The Servlet Spec requires that the first filters in the chain are the url style mappings, and then the servlet name mappings. This does it the other way around, doesn't it?", "author": "janbartel", "createdAt": "2020-09-15T15:45:11Z", "path": "jetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "diffHunk": "@@ -591,69 +592,69 @@ public void doHandle(String target, Request baseRequest, HttpServletRequest requ\n             return _servletPathMap.getMatch(target);\n         }\n \n-        if (_servletNameMap == null)\n-            return null;\n         ServletHolder holder = _servletNameMap.get(target);\n         if (holder == null)\n             return null;\n         return new MappedResource<>(null, holder);\n     }\n \n+    private FilterChain linkFilterChain(ServletHolder servletHolder, FilterHolder filterHolder, FilterChain chain)\n+    {\n+        if (chain == null)\n+            chain = new ServletFilterChain(servletHolder);\n+        FilterChain next = newFilterChain(filterHolder.getFilter(), chain);\n+        return filterHolder.isAsyncSupported() ? next : new NotAsyncFilterChain(filterHolder, chain);\n+    }\n+\n+    /**\n+     * Create a FilterChain that calls the passed filter with the passed chain\n+     * @param filter The filter to invoke\n+     * @param chain The chain to pass to the filter\n+     * @return A FilterChain that invokes the filter with the chain\n+     */\n+    protected FilterChain newFilterChain(Filter filter, FilterChain chain)\n+    {\n+        return new Chain(filter, chain);\n+    }\n+\n     protected FilterChain getFilterChain(Request baseRequest, String pathInContext, ServletHolder servletHolder)\n     {\n         String key = pathInContext == null ? servletHolder.getName() : pathInContext;\n         int dispatch = FilterMapping.dispatch(baseRequest.getDispatcherType());\n \n-        if (_filterChainsCached && _chainCache != null)\n+        if (_filterChainsCached)\n         {\n             FilterChain chain = _chainCache[dispatch].get(key);\n             if (chain != null)\n                 return chain;\n         }\n \n-        // Build list of filters (list of FilterHolder objects)\n-        List<FilterHolder> filters = new ArrayList<>();\n-\n-        // Path filters\n-        if (pathInContext != null && _filterPathMappings != null)\n-        {\n-            for (FilterMapping filterPathMapping : _filterPathMappings)\n-            {\n-                if (filterPathMapping.appliesTo(pathInContext, dispatch))\n-                    filters.add(filterPathMapping.getFilterHolder());\n-            }\n-        }\n+        FilterChain chain = null;\n \n-        // Servlet name filters\n         if (servletHolder != null && _filterNameMappings != null && !_filterNameMappings.isEmpty())", "originalCommit": "d21edfcddc276ef158d7e44b0adead61dc6fb53d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc3ODI0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5271#discussion_r488778246", "bodyText": "I would hope we fail some of our unit tests then.\nWe should have basic tests that validate these kinds of requirements from the servlet spec.\nUnless Greg has done some kind of trickery and his \"Reverse mappings\" statement is really \"mappings done in reverse\" making the change he made valid again.", "author": "joakime", "createdAt": "2020-09-15T15:53:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc3MjIwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODg4NDczNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5271#discussion_r488884735", "bodyText": "@janbartel The lists are in reverse so we apply the inner onion skin first. The order the filters are executed is not changed.", "author": "gregw", "createdAt": "2020-09-15T18:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc3MjIwMQ=="}], "type": "inlineReview"}, {"oid": "006659c336b1f1faf793883509d4c1921d49fcab", "url": "https://github.com/eclipse/jetty.project/commit/006659c336b1f1faf793883509d4c1921d49fcab", "message": "added comment to explain ordering\n\nSigned-off-by: gregw <gregw@webtide.com>", "committedDate": "2020-09-15T18:51:47Z", "type": "commit"}, {"oid": "52b9925a0f68a287d468a1f82e8c7ba9688ae317", "url": "https://github.com/eclipse/jetty.project/commit/52b9925a0f68a287d468a1f82e8c7ba9688ae317", "message": "More cleanups", "committedDate": "2020-09-15T20:03:17Z", "type": "commit"}, {"oid": "25a1f9afdced1b6479e46ddc4ac927b1e130cab2", "url": "https://github.com/eclipse/jetty.project/commit/25a1f9afdced1b6479e46ddc4ac927b1e130cab2", "message": "fixed toString format\nturn off debug in OSGI test", "committedDate": "2020-09-16T14:06:52Z", "type": "commit"}, {"oid": "4d476e53cd9542f1ae0a211dc9e41216bf868d69", "url": "https://github.com/eclipse/jetty.project/commit/4d476e53cd9542f1ae0a211dc9e41216bf868d69", "message": "Merge branch 'jetty-9.4.x' into jetty-9.4.x-5022-FilterChainCleanup\n\n# Conflicts:\n#\tjetty-servlet/src/main/java/org/eclipse/jetty/servlet/FilterHolder.java\n#\tjetty-servlet/src/main/java/org/eclipse/jetty/servlet/ServletHandler.java", "committedDate": "2020-09-22T09:47:45Z", "type": "commit"}, {"oid": "1cecfeae5a0b1070a68c2b541246edd7b6ff4c8a", "url": "https://github.com/eclipse/jetty.project/commit/1cecfeae5a0b1070a68c2b541246edd7b6ff4c8a", "message": "Merge branch 'jetty-9.4.x' into jetty-9.4.x-5022-FilterChainCleanup", "committedDate": "2020-09-29T16:30:13Z", "type": "commit"}]}