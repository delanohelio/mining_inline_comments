{"pr_number": 5648, "pr_title": "Use Filter name to identify the WebSocketUpgradeFilter.", "pr_createdAt": "2020-11-13T11:14:12Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5648", "timeline": [{"oid": "0493a111067fc57a1e55da2e6eb8608c34593d9f", "url": "https://github.com/eclipse/jetty.project/commit/0493a111067fc57a1e55da2e6eb8608c34593d9f", "message": "Use Filter name to identify the WebSocketUpgradeFilter.\n\nDon't allow configuration of WebSocketMapping attribute.\nThe WebSocketUpgradeFilter is identified by it's name, which must be set as the fully qualified class name.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-13T11:06:20Z", "type": "commit"}, {"oid": "165beff3f36fddf0c9a5e105a39a9ac12e41d658", "url": "https://github.com/eclipse/jetty.project/commit/165beff3f36fddf0c9a5e105a39a9ac12e41d658", "message": "add test for multiple WebSocketUpgradeFilters\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-13T23:43:14Z", "type": "commit"}, {"oid": "6dad0b1b7e62b47efb2d4e8b748446a15479d4f5", "url": "https://github.com/eclipse/jetty.project/commit/6dad0b1b7e62b47efb2d4e8b748446a15479d4f5", "message": "rename WebSocketMapping to WebSocketMappings\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-13T23:46:09Z", "type": "commit"}, {"oid": "3b22c6bc66115bc013b7b696d10dbe0a3d22e20d", "url": "https://github.com/eclipse/jetty.project/commit/3b22c6bc66115bc013b7b696d10dbe0a3d22e20d", "message": "fix broken test: AltFilterTest\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-16T04:57:28Z", "type": "commit"}, {"oid": "f52e61156d3118b40b57294df906a27a4fd82b7e", "url": "https://github.com/eclipse/jetty.project/commit/f52e61156d3118b40b57294df906a27a4fd82b7e", "message": "add test for a subclassed WebSocketUpgradeFilter\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-17T09:57:21Z", "type": "commit"}, {"oid": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33", "url": "https://github.com/eclipse/jetty.project/commit/aba2c93eae4ea3d5b22d686d764c04d26ed48a33", "message": "Add tests for the ordering of the default WebSocketUpgradeFilter.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-18T04:10:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMDg1Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5648#discussion_r525910852", "bodyText": "Use version 4.0 for XMLs.", "author": "sbordet", "createdAt": "2020-11-18T08:50:32Z", "path": "jetty-websocket/websocket-jetty-tests/src/test/java/org/eclipse/jetty/websocket/tests/JettyWebSocketWebApp.java", "diffHunk": "@@ -0,0 +1,84 @@\n+package org.eclipse.jetty.websocket.tests;\n+\n+import java.io.File;\n+import java.io.FileWriter;\n+import java.io.IOException;\n+import java.net.URL;\n+import java.nio.file.Path;\n+\n+import org.eclipse.jetty.toolchain.test.FS;\n+import org.eclipse.jetty.toolchain.test.IO;\n+import org.eclipse.jetty.toolchain.test.MavenTestingUtils;\n+import org.eclipse.jetty.util.TypeUtil;\n+import org.eclipse.jetty.util.resource.PathResource;\n+import org.eclipse.jetty.webapp.WebAppContext;\n+import org.eclipse.jetty.websocket.server.config.JettyWebSocketConfiguration;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+public class JettyWebSocketWebApp extends WebAppContext\n+{\n+    private static final Logger LOG = LoggerFactory.getLogger(JettyWebSocketWebApp.class);\n+\n+    private final Path contextDir;\n+    private final Path webInf;\n+    private final Path classesDir;\n+\n+    public JettyWebSocketWebApp(String contextName)\n+    {\n+        // Ensure context directory.\n+        Path testDir = MavenTestingUtils.getTargetTestingPath(JettyWebSocketWebApp.class.getName());\n+        contextDir = testDir.resolve(contextName);\n+        FS.ensureEmpty(contextDir);\n+\n+        // Ensure WEB-INF directories.\n+        webInf = contextDir.resolve(\"WEB-INF\");\n+        FS.ensureDirExists(webInf);\n+        classesDir = webInf.resolve(\"classes\");\n+        FS.ensureDirExists(classesDir);\n+\n+        // Configure the WebAppContext.\n+        setContextPath(\"/\" + contextName);\n+        setBaseResource(new PathResource(contextDir));\n+        addConfiguration(new JettyWebSocketConfiguration());\n+    }\n+\n+    public Path getContextDir()\n+    {\n+        return contextDir;\n+    }\n+\n+    public void createWebXml() throws IOException\n+    {\n+        String emptyWebXml = \"<?xml version=\\\"1.0\\\" encoding=\\\"UTF-8\\\"?>\" +\n+            \"<web-app xmlns:xsi=\\\"http://www.w3.org/2001/XMLSchema-instance\\\" xmlns=\\\"http://java.sun.com/xml/ns/javaee\\\" \" +\n+            \"xsi:schemaLocation=\\\"http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd\\\" \" +\n+            \"metadata-complete=\\\"false\\\" version=\\\"3.0\\\"></web-app>\";", "originalCommit": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTkxMjk3OA==", "url": "https://github.com/eclipse/jetty.project/pull/5648#discussion_r525912978", "bodyText": "This is a surprise... I thought the default filter was always the first? IMHO it would be better if it is, unless too complicated.", "author": "sbordet", "createdAt": "2020-11-18T08:53:55Z", "path": "jetty-websocket/websocket-jetty-tests/src/test/java/org/eclipse/jetty/websocket/tests/JettyWebSocketFilterTest.java", "diffHunk": "@@ -297,6 +308,98 @@ public void testCustomUpgradeFilter() throws Exception\n         assertThat(socket.textMessages.poll(), is(\"hElLo wOrLd\"));\n     }\n \n+    @Test\n+    public void testDefaultWebSocketUpgradeFilterOrdering() throws Exception\n+    {\n+        String timeoutFromAltFilter = \"5999\";\n+        JettyWebSocketWebApp webApp = new JettyWebSocketWebApp(\"wsuf-ordering1\");\n+        Path webXml = MavenTestingUtils.getTestResourcePath(\"wsuf-ordering1.xml\");\n+        webApp.copyWebXml(webXml);\n+        webApp.copyClass(WebSocketEchoServletContextListener.class);\n+        webApp.copyClass(WebSocketEchoServletContextListener.EchoSocket.class);\n+\n+        server.setHandler(webApp);\n+        server.start();\n+        client.start();\n+\n+        // We have both websocket upgrade filters installed.\n+        FilterHolder[] filterHolders = webApp.getServletHandler().getFilters();\n+        assertThat(filterHolders.length, is(2));\n+        assertThat(filterHolders[0].getFilter(), instanceOf(WebSocketUpgradeFilter.class));\n+        assertThat(filterHolders[1].getFilter(), instanceOf(WebSocketUpgradeFilter.class));\n+\n+        // The custom filter defined in web.xml should be first in line so it will do the upgrade.", "originalCommit": "aba2c93eae4ea3d5b22d686d764c04d26ed48a33", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6a83a261e10d7522b9689b63e3eed8346442d579", "url": "https://github.com/eclipse/jetty.project/commit/6a83a261e10d7522b9689b63e3eed8346442d579", "message": "Always add the default WebSocketUpgradeFilter as the first filter.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-11-18T10:27:25Z", "type": "commit"}, {"oid": "7bc4ee6509808d6dd7e1602a95d7515c4e6ac378", "url": "https://github.com/eclipse/jetty.project/commit/7bc4ee6509808d6dd7e1602a95d7515c4e6ac378", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-WebSocketUpgradeFilter", "committedDate": "2020-11-18T20:48:16Z", "type": "commit"}, {"oid": "dfdcf3e4cc7946b56b15c600e7672c3466c4d91f", "url": "https://github.com/eclipse/jetty.project/commit/dfdcf3e4cc7946b56b15c600e7672c3466c4d91f", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-WebSocketUpgradeFilter", "committedDate": "2020-11-20T18:11:41Z", "type": "commit"}, {"oid": "d52c1fc4785f414a95a613dcb32d5d4071e3219f", "url": "https://github.com/eclipse/jetty.project/commit/d52c1fc4785f414a95a613dcb32d5d4071e3219f", "message": "Merged branch 'jetty-10.0.x' into 'jetty-10.0.x-WebSocketUpgradeFilter'.", "committedDate": "2020-11-23T15:04:34Z", "type": "commit"}]}