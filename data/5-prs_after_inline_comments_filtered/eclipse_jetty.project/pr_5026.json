{"pr_number": 5026, "pr_title": "Issue #5025 - wrong welcome file handling with dispatcher.include() a\u2026", "pr_createdAt": "2020-07-04T13:23:01Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5026", "timeline": [{"oid": "c7d114f67d13417f97fb2601d683b266ad39ea2e", "url": "https://github.com/eclipse/jetty.project/commit/c7d114f67d13417f97fb2601d683b266ad39ea2e", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>", "committedDate": "2020-07-04T13:25:39Z", "type": "forcePushed"}, {"oid": "72d3d1d6034cd267e78adb8acc7b02f2312e0089", "url": "https://github.com/eclipse/jetty.project/commit/72d3d1d6034cd267e78adb8acc7b02f2312e0089", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>", "committedDate": "2020-07-04T13:51:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Mzg4MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449783881", "bodyText": "This should be GET /context/gateway/ HTTP/1.0\\r\\n\\r\\n as you are requesting content belonging to the url-pattern of /gateway/* which the request to /gateway will not match.", "author": "joakime", "createdAt": "2020-07-04T15:54:49Z", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,46 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");\n+        defholder.setInitParameter(\"resourceBase\", altRoot.toUri().toASCIIString());\n+        defholder.setInitParameter(\"dirAllowed\", \"false\");\n+        defholder.setInitParameter(\"redirectWelcome\", \"false\");\n+        defholder.setInitParameter(\"welcomeServlets\", \"true\");\n+        defholder.setInitParameter(\"pathInfoOnly\", \"true\");\n+\n+        ServletHolder gwholder = new ServletHolder(\"gateway\", new HttpServlet() {\n+            @Override\n+            protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n+                    throws ServletException, IOException {\n+                req.getRequestDispatcher(\"/alt/\").include(req, resp);\n+            }\n+        });\n+        context.addServlet(gwholder, \"/gateway/*\");\n+\n+        String rawResponse;\n+        HttpTester.Response response;\n+\n+        // Test included alt default\n+        rawResponse = connector.getResponse(\"GET /context/gateway HTTP/1.0\\r\\n\\r\\n\");", "originalCommit": "72d3d1d6034cd267e78adb8acc7b02f2312e0089", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NDc2Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449784762", "bodyText": "I checked org.eclipse.jetty.http.pathmap.PathMappings#getMatch() and /p request is successfully matched for servlet mapped to /p/* - it's kept in org.eclipse.jetty.http.pathmap.PathMappings#_prefixMap:\n_prefixMap = {org.eclipse.jetty.util.ArrayTernaryTrie@2636} \"{/p=MappedResource[pathSpec=ServletPathSpec[\"/p/*\",pathDepth=2,group=PREFIX_GLOB],resource=default-servlet@2c16bab9==org.ops4j.pax.web.service.jetty.internal.EmbeddedJettyTest$11,jsp=null,order=-1,inst=true,async=true]}\"\n LO: int  = 1 (0x1)\n EQ: int  = 2 (0x2)\n HI: int  = 3 (0x3)\n ROW_SIZE: int  = 4 (0x4)\n _tree: char[]  = {char[512]@2893} \n _key: java.lang.String[]  = {java.lang.String[128]@2894} \n  2 = \"/p\"\n _value: java.lang.Object[]  = {java.lang.Object[128]@2895} \n  2 = {org.eclipse.jetty.http.pathmap.MappedResource@2643} \"MappedResource[pathSpec=ServletPathSpec[\"/p/*\",pathDepth=2,group=PREFIX_GLOB],resource=default-servlet@2c16bab9==org.ops4j.pax.web.service.jetty.internal.EmbeddedJettyTest$11,jsp=null,order=-1,inst=true,async=true]\"\n   pathSpec: org.eclipse.jetty.http.pathmap.PathSpec  = {org.eclipse.jetty.http.pathmap.ServletPathSpec@2897} \"ServletPathSpec[\"/p/*\",pathDepth=2,group=PREFIX_GLOB]\"\n   resource: java.lang.Object  = {org.eclipse.jetty.servlet.ServletHolder@2656} \"default-servlet@2c16bab9==org.ops4j.pax.web.service.jetty.internal.EmbeddedJettyTest$11,jsp=null,order=-1,inst=true,async=true\"", "author": "grgrzybek", "createdAt": "2020-07-04T16:06:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Mzg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2MzYzMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r452263631", "bodyText": "I think you've got 2 differents tests to do here:\n\n\nurl is /context/gateway  WITHOUT the trailing slash, which will go to line 377 of ResourceService that does a 302 redirect to url that adds the trailing slash\n\n\nurl is /context/gateway/  WITH the trailing slash, which will go to the code at line 402 of ResourceService", "author": "janbartel", "createdAt": "2020-07-09T14:33:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Mzg4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDkyMzA2Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r454923067", "bodyText": "@grgrzybek I'd still like to see one request with GET /context/gateway and one with GET /context/gateway/, because the first one will do a redirect before doing the new include path handling: I just want to ensure that we've exercised both codepaths.", "author": "janbartel", "createdAt": "2020-07-15T09:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4Mzg4MQ=="}], "type": "inlineReview"}, {"oid": "a14a665af6587eabe82c621690eb77956d9641d8", "url": "https://github.com/eclipse/jetty.project/commit/a14a665af6587eabe82c621690eb77956d9641d8", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>", "committedDate": "2020-07-04T15:57:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NDE3NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449784175", "bodyText": "This addServlet should be done before Server.start()", "author": "joakime", "createdAt": "2020-07-04T15:58:42Z", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,48 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");\n+        defholder.setInitParameter(\"resourceBase\", altRoot.toUri().toASCIIString());\n+        defholder.setInitParameter(\"dirAllowed\", \"false\");\n+        defholder.setInitParameter(\"redirectWelcome\", \"false\");\n+        defholder.setInitParameter(\"welcomeServlets\", \"true\");\n+        defholder.setInitParameter(\"pathInfoOnly\", \"true\");\n+\n+        ServletHolder gwholder = new ServletHolder(\"gateway\", new HttpServlet()\n+        {\n+            @Override\n+            protected void doGet(HttpServletRequest req, HttpServletResponse resp)\n+                    throws ServletException, IOException\n+            {\n+                req.getRequestDispatcher(\"/alt/\").include(req, resp);\n+            }\n+        });\n+        context.addServlet(gwholder, \"/gateway/*\");", "originalCommit": "a14a665af6587eabe82c621690eb77956d9641d8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NDg4Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449784883", "bodyText": "I don't think it's the case in other tests inside org.eclipse.jetty.servlet.DefaultServletTest...", "author": "grgrzybek", "createdAt": "2020-07-04T16:08:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NDE3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc4NDE4OA==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r449784188", "bodyText": "This addServlet should be done before Server.start()", "author": "joakime", "createdAt": "2020-07-04T15:58:48Z", "path": "jetty-servlet/src/test/java/org/eclipse/jetty/servlet/DefaultServletTest.java", "diffHunk": "@@ -813,6 +815,48 @@ public void testWelcomeMultipleBasesBase() throws Exception\n         }\n     }\n \n+    @Test\n+    public void testIncludedWelcomeDifferentBase() throws Exception\n+    {\n+        Path altRoot = workDir.getPath().resolve(\"altroot\");\n+        FS.ensureDirExists(altRoot);\n+        Path altIndex = altRoot.resolve(\"index.html\");\n+\n+        ServletHolder defholder = context.addServlet(DefaultServlet.class, \"/alt/*\");", "originalCommit": "a14a665af6587eabe82c621690eb77956d9641d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2MDkxNg==", "url": "https://github.com/eclipse/jetty.project/pull/5026#discussion_r452260916", "bodyText": "I think this is a good solution. I would delete the extra \"if\" at line 406 because that can never happen, unless there's a bug in jetty :)", "author": "janbartel", "createdAt": "2020-07-09T14:30:07Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ResourceService.java", "diffHunk": "@@ -401,8 +401,13 @@ protected void sendWelcome(HttpContent content, String pathInContext, boolean en\n \n         if (welcome != null)\n         {\n+            String servletPath = included ? (String)request.getAttribute(RequestDispatcher.INCLUDE_SERVLET_PATH)\n+                    : request.getServletPath();\n+            if (servletPath == null)", "originalCommit": "a14a665af6587eabe82c621690eb77956d9641d8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "84395958f612ea53839f00ac00dd1ab5564e77af", "url": "https://github.com/eclipse/jetty.project/commit/84395958f612ea53839f00ac00dd1ab5564e77af", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>", "committedDate": "2020-07-10T12:16:56Z", "type": "forcePushed"}, {"oid": "93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "url": "https://github.com/eclipse/jetty.project/commit/93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>", "committedDate": "2020-07-10T12:19:15Z", "type": "commit"}, {"oid": "93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "url": "https://github.com/eclipse/jetty.project/commit/93fa21b7b77bd88f5933265b3f28c6a5e3d17e76", "message": "Issue #5025 - wrong welcome file handling with dispatcher.include() and non-default mapping\n\nSigned-off-by: Grzegorz Grzybek <gr.grzybek@gmail.com>", "committedDate": "2020-07-10T12:19:15Z", "type": "forcePushed"}]}