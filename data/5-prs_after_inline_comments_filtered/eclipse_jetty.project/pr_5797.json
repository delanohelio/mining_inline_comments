{"pr_number": 5797, "pr_title": "Issue #5794 ensuring serverChannel is closed in the event of a failed bind to ensure proper resources are cleaned", "pr_createdAt": "2020-12-11T04:02:39Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5797", "timeline": [{"oid": "f7d4b940a2e360c9d7b1d1a946e7828f347c2788", "url": "https://github.com/eclipse/jetty.project/commit/f7d4b940a2e360c9d7b1d1a946e7828f347c2788", "message": "Issue #5794 ensuring serverChannel is closed in the event of a failed bind to ensure proper resources are cleaned\n\nSigned-off-by: Joe Witt <joewitt@apache.org>", "committedDate": "2020-12-11T03:59:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4NjcxMA==", "url": "https://github.com/eclipse/jetty.project/pull/5797#discussion_r540786710", "bodyText": "Can you please rework this fix to use try-with-resources, so there is no need of an explicit close?", "author": "sbordet", "createdAt": "2020-12-11T08:53:42Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ServerConnector.java", "diffHunk": "@@ -346,6 +346,14 @@ protected ServerSocketChannel openAcceptChannel() throws IOException\n             }\n             catch (BindException e)\n             {\n+                try\n+                {\n+                    serverChannel.close();\n+                }\n+                catch (IOException ioe)\n+                {\n+                    LOG.warn(ioe);\n+                }", "originalCommit": "f7d4b940a2e360c9d7b1d1a946e7828f347c2788", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTU4MDg1NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5797#discussion_r541580855", "bodyText": "We only want the serverChannel closed if the BindException occurs.  Otherwise it needs to be returned to the caller in an open state.  I don't believe try-with-resources is what we want here but let me know if I misunderstood.", "author": "joewitt", "createdAt": "2020-12-12T13:56:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4NjcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYyNzA5NA==", "url": "https://github.com/eclipse/jetty.project/pull/5797#discussion_r541627094", "bodyText": "@sbordet try-with-resources doesn't work in this case as we use the socket in the successful case...  actually probably should null out the field... just in case....", "author": "gregw", "createdAt": "2020-12-12T15:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4NjcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYzMDMwMg==", "url": "https://github.com/eclipse/jetty.project/pull/5797#discussion_r541630302", "bodyText": "Actually no fields were set, but there was one already in a try-with-resources, so backed the change out of that one.", "author": "gregw", "createdAt": "2020-12-12T15:47:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4NjcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTYzMzM1Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5797#discussion_r541633356", "bodyText": "Looks like the serverChannel is within the method scope so nothing to null out. I looked at the caller scope or otherwise to see if there was a better place to adjust the close (such as a try with resources).  And I'm not seeing that.  For the specific issue observed the change as I have it closes that problem.  If this is part of a larger concern I'm not sure I follow.  Do you need any change from the patch as-is?", "author": "joewitt", "createdAt": "2020-12-12T15:53:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4NjcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIxNzcxNw==", "url": "https://github.com/eclipse/jetty.project/pull/5797#discussion_r542217717", "bodyText": "Re: using try-with-resources: doh :)\n@gregw #5802 is the same fix? @joewitt can you use IO.close() instead? Also, I think we want to catch everything that may possibly be throws after ServerSocketChannel.open(), so I would widen the try scope.", "author": "sbordet", "createdAt": "2020-12-14T09:04:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4NjcxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIyMzA0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5797#discussion_r542223040", "bodyText": "Incorporating this change within #5802.", "author": "sbordet", "createdAt": "2020-12-14T09:13:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc4NjcxMA=="}], "type": "inlineReview"}]}