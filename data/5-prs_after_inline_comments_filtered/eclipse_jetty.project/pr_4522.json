{"pr_number": 4522, "pr_title": "Issue #4226 - fix JPMS issues with javax websockets", "pr_createdAt": "2020-01-28T07:27:39Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4522", "timeline": [{"oid": "669859213915a0d6189ce72df942f95a3b204226", "url": "https://github.com/eclipse/jetty.project/commit/669859213915a0d6189ce72df942f95a3b204226", "message": "Add tests for Javax ServerContainer default configuration.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-01-28T07:15:27Z", "type": "commit"}, {"oid": "a4b85d1df283a5d4d3589c2290359b27cf621e8c", "url": "https://github.com/eclipse/jetty.project/commit/a4b85d1df283a5d4d3589c2290359b27cf621e8c", "message": "Issue #4226 JavaxWebSocketServerContainer leaking into public signature\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-01-28T07:16:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODgwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4522#discussion_r371648809", "bodyText": "This check currently fails.\nThis issue also came up in #2661.\nThe API has the default maxMessageSize value for the @OnMessage annotation to be -1 which means infinite message size. We didn't want that to be the default as it would be too easy for a client to send a huge message and make the server blow up with an OutOfMemoryError. But we don't know if they have specifically set maxMessageSize = -1 in the annotation or it is just using the default value.\nCurrently if they set maxMessageSize = -2 or maxMessageSize = 0 it will result in infinite message size but a value of -1 will not override the container default value, in this case 60.", "author": "lachlan-roberts", "createdAt": "2020-01-28T07:51:20Z", "path": "jetty-websocket/websocket-javax-tests/src/test/java/org/eclipse/jetty/websocket/javax/tests/ServerConfigTest.java", "diffHunk": "@@ -0,0 +1,137 @@\n+//\n+// ========================================================================\n+// Copyright (c) 1995-2020 Mort Bay Consulting Pty Ltd and others.\n+//\n+// This program and the accompanying materials are made available under\n+// the terms of the Eclipse Public License 2.0 which is available at\n+// https://www.eclipse.org/legal/epl-2.0\n+//\n+// This Source Code may also be made available under the following\n+// Secondary Licenses when the conditions for such availability set\n+// forth in the Eclipse Public License, v. 2.0 are satisfied:\n+// the Apache License v2.0 which is available at\n+// https://www.apache.org/licenses/LICENSE-2.0\n+//\n+// SPDX-License-Identifier: EPL-2.0 OR Apache-2.0\n+// ========================================================================\n+//\n+\n+package org.eclipse.jetty.websocket.javax.tests;\n+\n+import java.io.IOException;\n+import java.net.URI;\n+import java.nio.ByteBuffer;\n+import java.util.concurrent.TimeUnit;\n+import javax.websocket.CloseReason;\n+import javax.websocket.CloseReason.CloseCodes;\n+import javax.websocket.ContainerProvider;\n+import javax.websocket.OnMessage;\n+import javax.websocket.OnOpen;\n+import javax.websocket.Session;\n+import javax.websocket.WebSocketContainer;\n+import javax.websocket.server.ServerEndpoint;\n+\n+import org.eclipse.jetty.server.Server;\n+import org.eclipse.jetty.server.ServerConnector;\n+import org.eclipse.jetty.servlet.ServletContextHandler;\n+import org.eclipse.jetty.websocket.javax.server.config.JavaxWebSocketServletContainerInitializer;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.params.ParameterizedTest;\n+import org.junit.jupiter.params.provider.ValueSource;\n+\n+import static org.hamcrest.MatcherAssert.assertThat;\n+import static org.hamcrest.Matchers.is;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+public class ServerConfigTest\n+{\n+    private Server server;\n+    private WebSocketContainer client;\n+    private ServerConnector connector;\n+\n+    private static final long idleTimeout = 500;\n+    private static final int maxTextMessageSize = 50;\n+    private static final int maxBinaryMessageSize = 60;\n+    private static final long asyncSendTimeout = 200;\n+\n+    @BeforeEach\n+    public void start() throws Exception\n+    {\n+        server = new Server();\n+        connector = new ServerConnector(server);\n+        server.addConnector(connector);\n+\n+        ServletContextHandler contextHandler = new ServletContextHandler(ServletContextHandler.SESSIONS);\n+        contextHandler.setContextPath(\"/\");\n+        server.setHandler(contextHandler);\n+\n+        JavaxWebSocketServletContainerInitializer.configure(contextHandler, (context, container) ->\n+        {\n+            container.setDefaultMaxSessionIdleTimeout(idleTimeout);\n+            container.setDefaultMaxTextMessageBufferSize(maxTextMessageSize);\n+            container.setDefaultMaxBinaryMessageBufferSize(maxBinaryMessageSize);\n+            container.setAsyncSendTimeout(asyncSendTimeout);\n+            container.addEndpoint(ConfigTestSocket.class);\n+            container.addEndpoint(AnnotatedOnMessageSocket.class);\n+        });\n+\n+        server.start();\n+        client = ContainerProvider.getWebSocketContainer();\n+    }\n+\n+    @AfterEach\n+    public void stop() throws Exception\n+    {\n+        server.stop();\n+    }\n+\n+    @ServerEndpoint(\"/containerDefaults\")\n+    public static class ConfigTestSocket\n+    {\n+        @OnOpen\n+        public void onOpen(Session session)\n+        {\n+            assertThat(session.getMaxIdleTimeout(), is(idleTimeout));\n+            assertThat(session.getMaxTextMessageBufferSize(), is(maxTextMessageSize));\n+            assertThat(session.getMaxBinaryMessageBufferSize(), is(maxBinaryMessageSize));\n+            assertThat(session.getAsyncRemote().getSendTimeout(), is(asyncSendTimeout));\n+        }\n+    }\n+\n+    @ServerEndpoint(\"/annotatedOnMessage\")\n+    public static class AnnotatedOnMessageSocket\n+    {\n+        @OnOpen\n+        public void onOpen(Session session)\n+        {\n+            assertThat(session.getMaxTextMessageBufferSize(), is(111));\n+            assertThat(session.getMaxBinaryMessageBufferSize(), is(-1));", "originalCommit": "a4b85d1df283a5d4d3589c2290359b27cf621e8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMwNzUwNg==", "url": "https://github.com/eclipse/jetty.project/pull/4522#discussion_r372307506", "bodyText": "Right, so the check should be session.getMaxBinaryMessageBufferSize() > 0, correct?", "author": "sbordet", "createdAt": "2020-01-29T10:40:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODgwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY2Njk5Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4522#discussion_r372666996", "bodyText": "@sbordet still not sure what to do about this, in the spec -1 is defined as no maximum message size, but if they specifically set -1 in the onOpen annotation it does not have any effect.", "author": "lachlan-roberts", "createdAt": "2020-01-29T22:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0ODgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0OTQ3NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4522#discussion_r371649475", "bodyText": "This change fixes the JPMS issue.\nNot sure if we really need this public as it is only used just below, but have left it public for now.", "author": "lachlan-roberts", "createdAt": "2020-01-28T07:53:27Z", "path": "jetty-websocket/websocket-javax-server/src/main/java/org/eclipse/jetty/websocket/javax/server/config/JavaxWebSocketServletContainerInitializer.java", "diffHunk": "@@ -148,7 +148,7 @@ public static void configure(ServletContextHandler context, Configurator configu\n      * @param context the context to work with\n      * @return the default {@link ServerContainer} for this context\n      */\n-    public static JavaxWebSocketServerContainer initialize(ServletContextHandler context)\n+    public static ServerContainer initialize(ServletContextHandler context)", "originalCommit": "a4b85d1df283a5d4d3589c2290359b27cf621e8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMwOTA4Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4522#discussion_r372309087", "bodyText": "The method needs to be public because it is how embedded applications such as e.g. CometD will initialize WebSocket.", "author": "sbordet", "createdAt": "2020-01-29T10:43:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0OTQ3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY2NTMxNw==", "url": "https://github.com/eclipse/jetty.project/pull/4522#discussion_r372665317", "bodyText": "This method SHOULD NOT BE CALLED by users of Jetty.\n\nI think embedded applications should really be using\npublic static void configure(ServletContextHandler context, Configurator configurator)", "author": "lachlan-roberts", "createdAt": "2020-01-29T22:25:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY0OTQ3NQ=="}], "type": "inlineReview"}, {"oid": "82c61c48ebe945b821b0c794b39cf3f4802602ac", "url": "https://github.com/eclipse/jetty.project/commit/82c61c48ebe945b821b0c794b39cf3f4802602ac", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-4226-JavaxWebSocketJPMS", "committedDate": "2020-01-29T23:37:34Z", "type": "commit"}, {"oid": "006fd3f913d2403d32d2f73313f7ab27cd1c9380", "url": "https://github.com/eclipse/jetty.project/commit/006fd3f913d2403d32d2f73313f7ab27cd1c9380", "message": "Issue #4226 - fix test failures\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-01-30T00:26:51Z", "type": "commit"}]}