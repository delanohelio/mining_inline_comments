{"pr_number": 4911, "pr_title": "Fixes #4904 - WebsocketClient creates more connections than needed.", "pr_createdAt": "2020-05-26T22:42:42Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4911", "timeline": [{"oid": "05f538d3d998fe2aa047dca42932f5489742f83f", "url": "https://github.com/eclipse/jetty.project/commit/05f538d3d998fe2aa047dca42932f5489742f83f", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nFixed connection pool's `acquire()` methods to correctly take into account the number of queued requests.\n\nAlso fixed a collateral bug in `BufferingResponseListener` - wrong calculation of the max content length.\n\nRestored `ConnectionPoolTest` that was disabled in #2540, cleaned it up, and let it run for hours without failures.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-05-26T22:41:36Z", "type": "commit"}, {"oid": "f33a12b0a436da2e3349ec2ea3abc4f8c0bc67e9", "url": "https://github.com/eclipse/jetty.project/commit/f33a12b0a436da2e3349ec2ea3abc4f8c0bc67e9", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nMore fixes to the connection pool logic.\nNow the connection creation is conditional, triggered by\nexplicit send() or failures.\nThe connection creation is not triggered _after_ a send(),\nwhere we aggressively send more queued requests - or\nin release(), where we send queued request after a previous\none was completed.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-05-28T15:03:23Z", "type": "commit"}, {"oid": "6e2429f5bdc39a69a1d202dd5b215e1e9fbf9a8d", "url": "https://github.com/eclipse/jetty.project/commit/6e2429f5bdc39a69a1d202dd5b215e1e9fbf9a8d", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nMore fixes to the connection pool logic.\nNow the connection close/removal aggressively sends more\nrequests triggering the connection creation.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-05-29T07:56:45Z", "type": "commit"}, {"oid": "b0ffaa6ffbb0841b4e48e193b85227b8dbbecb98", "url": "https://github.com/eclipse/jetty.project/commit/b0ffaa6ffbb0841b4e48e193b85227b8dbbecb98", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nImproved comments.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-05-29T09:30:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NzYwMw==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433087603", "bodyText": "IF this can now only be a HttpDestination, why not change the signature of the constructor?", "author": "gregw", "createdAt": "2020-06-01T07:42:30Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -44,13 +44,13 @@\n      * The bottom 32 bits represent the total connections and the top 32 bits represent the pending connections.\n      */\n     private final AtomicBiInteger connections = new AtomicBiInteger();\n-    private final Destination destination;\n+    private final HttpDestination destination;\n     private final int maxConnections;\n     private final Callback requester;\n \n     protected AbstractConnectionPool(Destination destination, int maxConnections, Callback requester)\n     {\n-        this.destination = destination;\n+        this.destination = (HttpDestination)destination;", "originalCommit": "b0ffaa6ffbb0841b4e48e193b85227b8dbbecb98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA5NzAxMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433097011", "bodyText": "Because people may have created their own subclasses and it would break them.\nWill do the change in 10 though.", "author": "sbordet", "createdAt": "2020-06-01T08:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NzYwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzI3Mzk0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433273946", "bodyText": "You could create a second constructor that does the right thing and deprecate the old one (preparing people for the Jetty 10 change).", "author": "joakime", "createdAt": "2020-06-01T14:39:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NzYwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMwMjQ5Mg==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433302492", "bodyText": "@joakime good point, done.", "author": "sbordet", "createdAt": "2020-06-01T15:26:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4NzYwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4ODEwMw==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433088103", "bodyText": "javadoc needed to explain the behaviour of this method...  well perhaps tryCreate needs more javadoc too...", "author": "gregw", "createdAt": "2020-06-01T07:43:33Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -98,11 +98,17 @@ public boolean isClosed()\n \n     @Override\n     public Connection acquire()\n+    {\n+        return acquire(true);\n+    }\n+\n+    protected Connection acquire(boolean create)", "originalCommit": "b0ffaa6ffbb0841b4e48e193b85227b8dbbecb98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4ODYxNQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433088615", "bodyText": "comment on the strategy here.", "author": "gregw", "createdAt": "2020-06-01T07:44:49Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -98,11 +98,17 @@ public boolean isClosed()\n \n     @Override\n     public Connection acquire()\n+    {\n+        return acquire(true);\n+    }\n+\n+    protected Connection acquire(boolean create)\n     {\n         Connection connection = activate();\n         if (connection == null)\n         {\n-            tryCreate(-1);\n+            if (create)\n+                tryCreate(destination.getQueuedRequestCount());", "originalCommit": "b0ffaa6ffbb0841b4e48e193b85227b8dbbecb98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4ODgwNQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433088805", "bodyText": "comma after fail", "author": "gregw", "createdAt": "2020-06-01T07:45:20Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/HttpConnection.java", "diffHunk": "@@ -228,6 +228,8 @@ protected SendFailure send(HttpChannel channel, HttpExchange exchange)\n             }\n             else\n             {\n+                // Association may fail for example if the application", "originalCommit": "b0ffaa6ffbb0841b4e48e193b85227b8dbbecb98", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4OTc3MA==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433089770", "bodyText": "should this check that the queue is not 0?  Why acquire a connection if there are no waiting exchanges?", "author": "gregw", "createdAt": "2020-06-01T07:47:45Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/HttpDestination.java", "diffHunk": "@@ -439,25 +459,27 @@ public void release(Connection connection)\n \n     public boolean remove(Connection connection)\n     {\n-        return connectionPool.remove(connection);\n-    }\n-\n-    public void close(Connection connection)\n-    {\n-        boolean removed = remove(connection);\n+        boolean removed = connectionPool.remove(connection);\n \n         if (getHttpExchanges().isEmpty())\n         {\n             tryRemoveIdleDestination();\n         }\n         else\n         {\n-            // We need to execute queued requests even if this connection failed.\n-            // We may create a connection that is not needed, but it will eventually\n-            // idle timeout, so no worries.\n+            // We need to execute queued requests\n+            // even if this connection was removed.\n+            // We may create a connection that is not\n+            // needed, but it will eventually idle timeout.\n             if (removed)\n-                process();\n+                process(true);", "originalCommit": "b0ffaa6ffbb0841b4e48e193b85227b8dbbecb98", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEwNDM4Nw==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433104387", "bodyText": "The check for the queue is done few lines above. Do you want to do it again here?", "author": "sbordet", "createdAt": "2020-06-01T08:24:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4OTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzExMzY2Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433113666", "bodyText": "Opps didn't see that.\nAn else if (removed) would be clearer that there is a condition above.", "author": "gregw", "createdAt": "2020-06-01T08:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4OTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEzMjIxNQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433132215", "bodyText": "I think an else if would then require the code comment to be moved to a less ideal place so I'm inclined to leave as is.", "author": "sbordet", "createdAt": "2020-06-01T09:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4OTc3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEzNDg4MA==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433134880", "bodyText": "The comment would be better in the body of the else if, as it would not need to repeat the \"if removed\":\nif (getHttpExchanges().isEmpty())\n{\n    tryRemoveIdleDestination();\n}\nelse if (removed)\n{\n   // Process queued exchanges because waiting exchanges may now be able to progress. \n   process(true);\n}", "author": "gregw", "createdAt": "2020-06-01T09:33:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzA4OTc3MA=="}], "type": "inlineReview"}, {"oid": "4ac799afa7c2e07ef8ce5b0441c7a07bedc661bd", "url": "https://github.com/eclipse/jetty.project/commit/4ac799afa7c2e07ef8ce5b0441c7a07bedc661bd", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nUpdates after review: added javadocs.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-01T08:25:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzExMjM2OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433112369", "bodyText": "Does it always create a new connection?    This should say if possible or may schedule.... . At the very least refer to tryCreate for the actual strategy applied.", "author": "gregw", "createdAt": "2020-06-01T08:42:37Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -98,16 +97,41 @@ public boolean isClosed()\n \n     @Override\n     public Connection acquire()\n+    {\n+        return acquire(true);\n+    }\n+\n+    /**\n+     * <p>Returns an idle connection, if available;\n+     * if an idle connection is not available, and the given {@code create} parameter is {@code true},\n+     * then schedules the opening of a new connection;", "originalCommit": "4ac799afa7c2e07ef8ce5b0441c7a07bedc661bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "00d5b6ec303164d5c7f2fe09017acf6b0bc4f9ae", "url": "https://github.com/eclipse/jetty.project/commit/00d5b6ec303164d5c7f2fe09017acf6b0bc4f9ae", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-01T09:29:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyMzA1Mw==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433123053", "bodyText": "How about this one-liner instead?\nint maxPending = (destination.getQueuedRequestCount() + getMaxMultiplex() - 1) / getMaxMultiplex();", "author": "lorban", "createdAt": "2020-06-01T09:06:15Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/MultiplexConnectionPool.java", "diffHunk": "@@ -64,7 +64,11 @@ public Connection acquire()\n         Connection connection = activate();\n         if (connection == null)\n         {\n-            int maxPending = 1 + destination.getQueuedRequestCount() / getMaxMultiplex();", "originalCommit": "4ac799afa7c2e07ef8ce5b0441c7a07bedc661bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0MzczOQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433143739", "bodyText": "That is obfuscated... Does it do ceiling(a/b)?", "author": "sbordet", "createdAt": "2020-06-01T09:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyMzA1Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzIwNzM2NA==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433207364", "bodyText": "Yes, it's the integer version of the following:\nMath.ceil((double) destination.getQueuedRequestCount() / getMaxMultiplex())", "author": "lorban", "createdAt": "2020-06-01T12:34:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyMzA1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyNTI0OQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433125249", "bodyText": "The documented contract is not respected by the RoundRobinConnectionPool subclass. That should probably be documented too.", "author": "lorban", "createdAt": "2020-06-01T09:11:13Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/AbstractConnectionPool.java", "diffHunk": "@@ -98,16 +97,41 @@ public boolean isClosed()\n \n     @Override\n     public Connection acquire()\n+    {\n+        return acquire(true);\n+    }\n+\n+    /**\n+     * <p>Returns an idle connection, if available;\n+     * if an idle connection is not available, and the given {@code create} parameter is {@code true},\n+     * then schedules the opening of a new connection;\n+     * otherwise returns {@code null}.</p>\n+     *\n+     * @param create whether to schedule the opening of a connection if no idle connections are available\n+     * @return an idle connection or {@code null} if no idle connections are available\n+     */\n+    protected Connection acquire(boolean create)", "originalCommit": "4ac799afa7c2e07ef8ce5b0441c7a07bedc661bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0NjQzMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433146431", "bodyText": "Documented.", "author": "sbordet", "createdAt": "2020-06-01T10:01:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEyNTI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEzNDkxNw==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433134917", "bodyText": "Since close(Connection) and remove(Connection) are now identical, shouldn't one of them be removed?", "author": "lorban", "createdAt": "2020-06-01T09:33:50Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/HttpDestination.java", "diffHunk": "@@ -439,25 +459,27 @@ public void release(Connection connection)\n \n     public boolean remove(Connection connection)\n     {\n-        return connectionPool.remove(connection);\n-    }\n-\n-    public void close(Connection connection)\n-    {\n-        boolean removed = remove(connection);\n+        boolean removed = connectionPool.remove(connection);\n \n         if (getHttpExchanges().isEmpty())\n         {\n             tryRemoveIdleDestination();\n         }\n         else\n         {\n-            // We need to execute queued requests even if this connection failed.\n-            // We may create a connection that is not needed, but it will eventually\n-            // idle timeout, so no worries.\n+            // We need to execute queued requests\n+            // even if this connection was removed.\n+            // We may create a connection that is not\n+            // needed, but it will eventually idle timeout.\n             if (removed)\n-                process();\n+                process(true);\n         }\n+        return connectionPool.remove(connection);\n+    }\n+\n+    public void close(Connection connection)", "originalCommit": "4ac799afa7c2e07ef8ce5b0441c7a07bedc661bd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzE0NzUyNA==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433147524", "bodyText": "I deprecated close(Connection) to be removed in 10.", "author": "sbordet", "createdAt": "2020-06-01T10:04:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEzNDkxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzEzNTE3NA==", "url": "https://github.com/eclipse/jetty.project/pull/4911#discussion_r433135174", "bodyText": "As mentioned earlier, this implementation breaks the javadoc's contract.", "author": "lorban", "createdAt": "2020-06-01T09:34:28Z", "path": "jetty-client/src/main/java/org/eclipse/jetty/client/RoundRobinConnectionPool.java", "diffHunk": "@@ -69,6 +69,14 @@ public void setMaxMultiplex(int maxMultiplex)\n         }\n     }\n \n+    @Override\n+    protected Connection acquire(boolean create)", "originalCommit": "4ac799afa7c2e07ef8ce5b0441c7a07bedc661bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8b265071a95b7630d2cef623602ad3fd7aee259c", "url": "https://github.com/eclipse/jetty.project/commit/8b265071a95b7630d2cef623602ad3fd7aee259c", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-01T09:42:28Z", "type": "commit"}, {"oid": "0c2a91db07a72804a8fc65a527edae62a87cafbf", "url": "https://github.com/eclipse/jetty.project/commit/0c2a91db07a72804a8fc65a527edae62a87cafbf", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-01T10:04:42Z", "type": "commit"}, {"oid": "0ffc66eff53078f074bcb9f6ca83d030e068c93c", "url": "https://github.com/eclipse/jetty.project/commit/0ffc66eff53078f074bcb9f6ca83d030e068c93c", "message": "Fixes #4904 - WebsocketClient creates more connections than needed.\n\nUpdates after review.\n\nSigned-off-by: Simone Bordet <simone.bordet@gmail.com>", "committedDate": "2020-06-01T13:17:46Z", "type": "commit"}]}