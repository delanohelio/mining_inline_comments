{"pr_number": 5142, "pr_title": "Issue #5133 - Improve ResourceFactory and Resource list handling", "pr_createdAt": "2020-08-12T18:08:42Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5142", "timeline": [{"oid": "0b0d7d328223577b2acda0fd9ab2231930762bb8", "url": "https://github.com/eclipse/jetty.project/commit/0b0d7d328223577b2acda0fd9ab2231930762bb8", "message": "Issue #5133 - Reworking WebAppContext.extraClasspath\n\n+ Now parsed by WebAppContext into List<Resource>\n+ Reintroduced Resource.fromList\n+ Refactored ResourceFactory to never return null\n  and always throw an exception if unable to\n  get/create/resolve the Resource\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-08-12T17:50:02Z", "type": "commit"}, {"oid": "6848403d3480f07fb41048108d9946fab542db35", "url": "https://github.com/eclipse/jetty.project/commit/6848403d3480f07fb41048108d9946fab542db35", "message": "Issue #5133 - Reworking WebAppContext.extraClasspath\n\n+ Reverting name ResourceFactory.newResource(String)\n  to .getResource(String)\n+ Reintroducing Resource.getResource(String)\n+ ResourceHandler.getResource(String) cleaned up\n  in light of Exception handling requirement\n+ Resource.addPath(String) implementations can\n  never return null now\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-08-12T18:06:09Z", "type": "commit"}, {"oid": "5d3711c3c04aea3b8c22515526dbd9189deb9735", "url": "https://github.com/eclipse/jetty.project/commit/5d3711c3c04aea3b8c22515526dbd9189deb9735", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-5133-webappcontext-extraclasspath-cleanup", "committedDate": "2020-08-13T16:12:20Z", "type": "commit"}, {"oid": "f881a1a2fe904938bd741d38269eba374922f1bb", "url": "https://github.com/eclipse/jetty.project/commit/f881a1a2fe904938bd741d38269eba374922f1bb", "message": "Merge remote-tracking branch 'origin/jetty-10.0.x' into jetty-10.0.x-5133-webappcontext-extraclasspath-cleanup", "committedDate": "2020-08-20T18:32:47Z", "type": "commit"}, {"oid": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "url": "https://github.com/eclipse/jetty.project/commit/b35c4332b2ceda2ee7fd9a80027424175405fad2", "message": "Issue #5133 - Fixing ResourceCollection(String) when no entries provided.\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-08-20T18:35:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNzkzOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476417939", "bodyText": "Why has this method been deleted?", "author": "janbartel", "createdAt": "2020-08-25T12:43:19Z", "path": "jetty-osgi/jetty-osgi-boot/src/main/java/org/eclipse/jetty/osgi/boot/internal/webapp/OSGiWebappClassLoader.java", "diffHunk": "@@ -274,35 +266,4 @@ private boolean isAcceptableLibrary(File file, Set<String> pathToClassFiles)\n     }\n \n     private static Field _contextField;\n-", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4ODY1NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476588655", "bodyText": "It's been a while. I don't recall.\nObviously nothing is using it in our code. (no references to it)\nThe setAccessible possibly?  but that can be easily fixed with method/field modifiers.\nBut I bet it's more likely to be related to the addClassPath(webappContext.getExtraClasspath()) which is additive to existing classpath from prior context (not a replacement).", "author": "joakime", "createdAt": "2020-08-25T16:42:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNjUwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477436509", "bodyText": "The WebAppClassLoader._context is a final field.\nYou cannot reset the value.\nThis method is broken in many different ways.\nNobody is using it, otherwise we would have had many bug reports against it already.", "author": "joakime", "createdAt": "2020-08-26T16:37:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNzkzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNjcxMA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477436710", "bodyText": "I had to touch it as webappContext.getExtraClasspath() returns a List<Resource> now.", "author": "joakime", "createdAt": "2020-08-26T16:37:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxNzkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxODMzNA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476418334", "bodyText": "This seems part of some kind of general code cleanup, and not directly related to the extraClasspath", "author": "janbartel", "createdAt": "2020-08-25T12:44:03Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/CachedContentFactory.java", "diffHunk": "@@ -188,8 +188,7 @@ public HttpContent getContent(String pathInContext, int maxBufferSize) throws IO\n         if (_parent != null)\n         {\n             HttpContent httpContent = _parent.getContent(pathInContext, maxBufferSize);\n-            if (httpContent != null)\n-                return httpContent;\n+            return httpContent;", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzNzg4NA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477437884", "bodyText": "I had to touch .getContent() method, so I was checking over other's use of it.", "author": "joakime", "createdAt": "2020-08-26T16:38:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQxODMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyMDY0MA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476420640", "bodyText": "So where previously we had a declared IOException, this method now throws it wrapped inside an InvalidPathException instead?", "author": "janbartel", "createdAt": "2020-08-25T12:47:51Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/ResourceContentFactory.java", "diffHunk": "@@ -51,14 +51,12 @@ public ResourceContentFactory(ResourceFactory factory, MimeTypes mimeTypes, Comp\n \n     @Override\n     public HttpContent getContent(String pathInContext, int maxBufferSize)", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyMTIzNg==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476421236", "bodyText": "Again, no problem with the substance of this, it's just the inclusion of this unrelated cleanup into this PR.", "author": "janbartel", "createdAt": "2020-08-25T12:48:50Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ResourceHandler.java", "diffHunk": "@@ -74,7 +74,7 @@ protected void notFound(HttpServletRequest request, HttpServletResponse response\n             {\n             }\n         });\n-        _resourceService.setGzipEquivalentFileExtensions(new ArrayList<>(Arrays.asList(new String[]{\".svgz\"})));\n+        _resourceService.setGzipEquivalentFileExtensions(new ArrayList<>(Collections.singletonList(\".svgz\")));", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyOTIyMw==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476429223", "bodyText": "Maybe it would be better to change _resources from an array to a List?", "author": "janbartel", "createdAt": "2020-08-25T13:00:10Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceCollection.java", "diffHunk": "@@ -147,6 +148,22 @@ public ResourceCollection(String csvResources)\n         return _resources;\n     }\n \n+    /**\n+     * Sets the resource collection's resources.\n+     *\n+     * @param res the resources to set\n+     */\n+    public void setResources(List<Resource> res)", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MzY3Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476583672", "bodyText": "I've no probs with that, but it has to be pass by value semantics and not pass by reference, so the list will be copied no matter what.", "author": "gregw", "createdAt": "2020-08-25T16:34:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyOTIyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA4Mzg2OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r492083869", "bodyText": "Done.", "author": "joakime", "createdAt": "2020-09-21T14:17:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQyOTIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzMjE2MA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476432160", "bodyText": "Isn't this the opposite of the foregoing comment: \"Glob references will only iterate through the level specified and will not traverse found directories within the glob reference\"?  The intention is that when the wildcard char * is used, deep directory traversal is not supported.", "author": "janbartel", "createdAt": "2020-08-25T13:04:51Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/Resource.java", "diffHunk": "@@ -921,4 +913,97 @@ public static URL toURL(File file) throws MalformedURLException\n     {\n         return file.toURI().toURL();\n     }\n+\n+    /**\n+     * Parse a list of String delimited resources and\n+     * return the List of Resources instances it represents.\n+     * <p>\n+     * Supports glob references that end in {@code /*} or {@code \\*}.\n+     * Glob references will only iterate through the level specified and will not traverse\n+     * found directories within the glob reference.\n+     * </p>\n+     *\n+     * @param delimitedReferences the comma {@code ,} or semicolon {@code ;} delimited\n+     * String of resource references.\n+     * @param globDirs true if glob references return directories within the glob as well\n+     * @return the list of resources parsed from input string.\n+     */\n+    public static List<Resource> fromList(String delimitedReferences, boolean globDirs) throws IOException\n+    {\n+        return fromList(delimitedReferences, globDirs, Resource::newResource);\n+    }\n+\n+    /**\n+     * Parse a delimited String of resource references and\n+     * return the List of Resources instances it represents.\n+     * <p>\n+     * Supports glob references that end in {@code /*} or {@code \\*}.\n+     * Glob references will only iterate through the level specified and will not traverse\n+     * found directories within the glob reference.\n+     * </p>\n+     *\n+     * @param delimitedReferences the comma {@code ,} or semicolon {@code ;} delimited\n+     * String of resource references.\n+     * @param globDirs true if glob references return directories within the glob as well", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0Njc4MA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477346780", "bodyText": "No, simple glob is supported, aka only a single asterisk (*) which is only the level of the glob itself.\nThe same as doing a ls -1 /path/to/look/at/* (which return all entries at that path location, including the names of the directories)\nA full glob support for deep directory searching would be a double asterisk (**).\nSupporting things like /opt/** and returning entries like /opt/deep/foo.txt.\nOr things like /code/jetty/**/target/classes which would return all entries (directories or files) that end in /target/classes", "author": "joakime", "createdAt": "2020-08-26T14:30:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzMjE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0NzYyNA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477347624", "bodyText": "This behavior does not \"traverse found directories\" it just returns the directory names found at the glob level.", "author": "joakime", "createdAt": "2020-08-26T14:31:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzMjE2MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMjE1MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r492002151", "bodyText": "How about \"true to return directories in addition to files at the level of the glob\"?", "author": "janbartel", "createdAt": "2020-09-21T12:25:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzMjE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQzMjUwNQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476432505", "bodyText": "Isn't this the opposite of the foregoing comment: \"Glob references will only iterate through the level specified and will not traverse found directories within the glob reference\"? The intention is that when the wildcard char * is used, deep directory traversal is not supported.", "author": "janbartel", "createdAt": "2020-08-25T13:05:21Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/Resource.java", "diffHunk": "@@ -921,4 +913,97 @@ public static URL toURL(File file) throws MalformedURLException\n     {\n         return file.toURI().toURL();\n     }\n+\n+    /**\n+     * Parse a list of String delimited resources and\n+     * return the List of Resources instances it represents.\n+     * <p>\n+     * Supports glob references that end in {@code /*} or {@code \\*}.\n+     * Glob references will only iterate through the level specified and will not traverse\n+     * found directories within the glob reference.\n+     * </p>\n+     *\n+     * @param delimitedReferences the comma {@code ,} or semicolon {@code ;} delimited\n+     * String of resource references.\n+     * @param globDirs true if glob references return directories within the glob as well", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTczNw==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476441737", "bodyText": "I don't like WebAppClassLoader setting itself up from the extraClasspath:  the WebAppClassLoader is configured by the WebInfConfiguration, so I don't see why the extraClassPath shouldn't be too.", "author": "janbartel", "createdAt": "2020-08-25T13:19:31Z", "path": "jetty-webapp/src/main/java/org/eclipse/jetty/webapp/WebAppClassLoader.java", "diffHunk": "@@ -185,15 +185,20 @@ public WebAppClassLoader(ClassLoader parent, Context context)\n         String extensions = System.getProperty(WebAppClassLoader.class.getName() + \".extensions\");\n         if (extensions != null)\n         {\n-            StringTokenizer tokenizer = new StringTokenizer(extensions, \",;\");\n+            StringTokenizer tokenizer = new StringTokenizer(extensions, StringUtil.DEFAULT_DELIMS);\n             while (tokenizer.hasMoreTokens())\n             {\n                 _extensions.add(tokenizer.nextToken().trim());\n             }\n         }\n \n         if (context.getExtraClasspath() != null)", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0MjMyMQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477342321", "bodyText": "We have 2 use cases ...\n\nA user of WebAppContext without Configuration.  Yes, this is a thing!  sometimes accidental, most of the time intentional (see spring web, spark, akka, kotlin, etc)\nA user of WebAppContext with Configuration.\n\nIn use case 1 we need WebAppClassLoader to configure itself.\nIt's super odd to have the Class you told \"here, use this config\" not actually be the one that uses that config.\nSince this is a Jetty 10 change, we should probably step back and re-evaluate the whole WebAppContext.extraClasspath role then, as per your comments, it's really a WebInfConfiguration behavior, not a WebAppClassLoader behavior.", "author": "joakime", "createdAt": "2020-08-26T14:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTczNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwOTcyOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r492009729", "bodyText": "In the interests of getting the rest of this applied to jetty-10, I'll drop my objection.", "author": "janbartel", "createdAt": "2020-09-21T12:37:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ0MTczNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1Mzg3Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476453877", "bodyText": "The jetty maven plugin has a use-case for turning a ResourceCollection back into a csv list - any chance you could add that onto ResourceCollection?", "author": "janbartel", "createdAt": "2020-08-25T13:36:47Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceCollection.java", "diffHunk": "@@ -293,11 +275,13 @@ public Resource addPath(String path) throws IOException\n         {\n             return resource;\n         }\n+\n         if (resources != null)\n         {\n             return new ResourceCollection(resources.toArray(new Resource[0]));\n         }\n-        return null;\n+\n+        throw new MalformedURLException(\"path does not result in Resource: \" + path);\n     }\n ", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNjQ3MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477336471", "bodyText": "how would you handle a situation where the path itself has a comma?", "author": "joakime", "createdAt": "2020-08-26T14:16:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1Mzg3Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNzEzMw==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477337133", "bodyText": "We need a proper CSV parser / generator in Jetty if this is going to work reliably. (we have the start of several of them sprinkled around the code, perhaps it's time to formalize it?)", "author": "joakime", "createdAt": "2020-08-26T14:17:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjQ1Mzg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTU3OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476575579", "bodyText": "What would happen if we didn't catch here?    A 500 response probably, but that might be more appropriate that a null response?", "author": "gregw", "createdAt": "2020-08-25T16:22:23Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/CachedContentFactory.java", "diffHunk": "@@ -234,18 +233,26 @@ private HttpContent load(String pathInContext, Resource resource, int maxBufferS\n                     if (compressedContent == null || compressedContent.isValid())\n                     {\n                         compressedContent = null;\n-                        Resource compressedResource = _factory.getResource(compressedPathInContext);\n-                        if (compressedResource.exists() && compressedResource.lastModified() >= resource.lastModified() &&\n-                            compressedResource.length() < resource.length())\n+                        try\n                         {\n-                            compressedContent = new CachedHttpContent(compressedPathInContext, compressedResource, null);\n-                            CachedHttpContent added = _cache.putIfAbsent(compressedPathInContext, compressedContent);\n-                            if (added != null)\n+                            Resource compressedResource = _factory.getResource(compressedPathInContext);\n+                            if (compressedResource.exists() && compressedResource.lastModified() >= resource.lastModified() &&\n+                                compressedResource.length() < resource.length())\n                             {\n-                                compressedContent.invalidate();\n-                                compressedContent = added;\n+                                compressedContent = new CachedHttpContent(compressedPathInContext, compressedResource, null);\n+                                CachedHttpContent added = _cache.putIfAbsent(compressedPathInContext, compressedContent);\n+                                if (added != null)\n+                                {\n+                                    compressedContent.invalidate();\n+                                    compressedContent = added;\n+                                }\n                             }\n                         }\n+                        catch (IOException e)", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU5MDQ3NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476590475", "bodyText": "The catch exists for the speculative _factory.getResource(compressedPathInContext) and allows the next attempt to load below if not valid.\nThe old _factory.getResource() relied on null returning.\nLet me see if I can find a good testcase for this.", "author": "joakime", "createdAt": "2020-08-25T16:45:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTU3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYwMDIzOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476600239", "bodyText": "But the compressedPathInContext should not throw unless something goes horribly wrong.  It should return a resource that does not exist and we should fall through because of an exists test not because of an exception.  We REALLY don't want exceptions to be in our normal execution path!!!!", "author": "gregw", "createdAt": "2020-08-25T17:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTU3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NTk2Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476575962", "bodyText": "again I think we should consider not catching here.", "author": "gregw", "createdAt": "2020-08-25T16:22:58Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/CachedContentFactory.java", "diffHunk": "@@ -279,12 +286,20 @@ private HttpContent load(String pathInContext, Resource resource, int maxBufferS\n                 if (compressedContent != null && compressedContent.isValid() && compressedContent.getResource().lastModified() >= resource.lastModified())\n                     compressedContents.put(format, compressedContent);\n \n-                // Is there a precompressed resource?\n-                Resource compressedResource = _factory.getResource(compressedPathInContext);\n-                if (compressedResource.exists() && compressedResource.lastModified() >= resource.lastModified() &&\n-                    compressedResource.length() < resource.length())\n-                    compressedContents.put(format,\n-                        new ResourceHttpContent(compressedResource, _mimeTypes.getMimeByExtension(compressedPathInContext), maxBufferSize));\n+                try\n+                {\n+                    // Is there a precompressed resource?\n+                    Resource compressedResource = _factory.getResource(compressedPathInContext);\n+                    if (compressedResource.exists() && compressedResource.lastModified() >= resource.lastModified() &&\n+                        compressedResource.length() < resource.length())\n+                        compressedContents.put(format,\n+                            new ResourceHttpContent(compressedResource, _mimeTypes.getMimeByExtension(compressedPathInContext), maxBufferSize));\n+                }\n+                catch (IOException e)", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NzMyMA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476577320", "bodyText": "again let's analyse what happens without a catch here", "author": "gregw", "createdAt": "2020-08-25T16:25:06Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ResourceHandler.java", "diffHunk": "@@ -86,9 +86,18 @@ public String getWelcomeFile(String pathInContext)\n         for (int i = 0; i < _welcomes.length; i++)\n         {\n             String welcomeInContext = URIUtil.addPaths(pathInContext, _welcomes[i]);\n-            Resource welcome = getResource(welcomeInContext);\n-            if (welcome != null && welcome.exists())\n-                return welcomeInContext;\n+            try\n+            {\n+                Resource welcome = getResource(welcomeInContext);\n+                if (welcome.exists())\n+                    return welcomeInContext;\n+            }\n+            catch (IOException e)", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzMTA4Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476631086", "bodyText": "In the past, if welcomeInContext resulted in an invalid resource, it would return null. (logging the various exceptions in the .getResource() call.\nNow, if the Resource can be created, it will be created and then tested if it exists.\nOtherwise if the Resource cannot be created (bad URL syntax, invalid characters on the filesystem, etc) it throws.", "author": "joakime", "createdAt": "2020-08-25T17:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NzMyMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI1ODcwMg==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477258702", "bodyText": "So in what circumstances would getResource(URIUtil.addPaths(pathInContext, _welcomes[i]) throw?\nOnly if the pathInContext or the welcome file we badly formatted, which I think is a configuration error and should not be caught and ignored.      I think it is fine to not catch here..... unless you can think of a valid configuration of welcome files that would sometimes throw?", "author": "gregw", "createdAt": "2020-08-26T12:24:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NzMyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3OTA5MQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476579091", "bodyText": "I don't think the message is right.\nThis method should still return a resource EVEN IF not found, as the request might be a PUT about to create the resource.\nThis method should only throw if something has gone horribly wrong.\nPerhaps this should be an IllegalArguementException ?", "author": "gregw", "createdAt": "2020-08-25T16:27:43Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ResourceHandler.java", "diffHunk": "@@ -157,27 +163,28 @@ public Resource getResource(String path)\n                 path = URIUtil.canonicalPath(path);\n                 r = _baseResource.addPath(path);\n \n-                if (r != null && r.isAlias() && (_context == null || !_context.checkAlias(path, r)))\n+                if (r.isAlias() && (_context == null || !_context.checkAlias(path, r)))\n                 {\n                     if (LOG.isDebugEnabled())\n-                        LOG.debug(\"resource={} alias={}\", r, r.getAlias());\n-                    return null;\n+                        LOG.debug(\"Rejected alias resource={} alias={}\", r, r.getAlias());\n+                    throw new IOException(\"Rejected (see debug logs)\");\n                 }\n             }\n             else if (_context != null)\n+            {\n                 r = _context.getResource(path);\n+                if (r != null)\n+                    return r;\n+            }\n \n             if ((r == null || !r.exists()) && path.endsWith(\"/jetty-dir.css\"))\n                 r = getStylesheet();\n \n-            return r;\n-        }\n-        catch (Exception e)\n-        {\n-            LOG.debug(\"Unable to get Resource for {}\", path, e);\n+            if (r != null)\n+                return r;\n         }\n \n-        return null;\n+        throw new IOException(\"Unable to find Resource for \" + path);", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjYzMzQwNA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476633404", "bodyText": "It cannot return a resource if the Resource itself cannot be created.\nSome examples:\nString resultA = getResource(\"foo#file\"); // wont work on URLResource, should probably have been ecnoded.\nString resultB = getResource(\"bar:zed\"); // wont work on windows for PathResource\nString resultC = getResource(\"WEB-INF/lib/foo.jar!/deep/resource\"); // wont work on URLResource (but will work on PathResource)\nIf you insist on returning a Resource, perhaps we should instead of throwing IOException\nwe should return new BadResource() instead?", "author": "joakime", "createdAt": "2020-08-25T17:52:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3OTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzI2MjI0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477262246", "bodyText": "You've miss understood.     I'm not saying return a resource if it is bad.\nI'm saying that \"Unable to find Resource\" is the wrong message for a bad resource.\nI think IllegalArgumentException is a possibility..... hmm except that those examples you give are legal, just not for the base resource..... so IOException is probably correct.... just that the message is wrong.", "author": "gregw", "createdAt": "2020-08-26T12:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3OTA5MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NzU4Ng==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r491987586", "bodyText": "still not right.  See new review.", "author": "gregw", "createdAt": "2020-09-21T11:58:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3OTA5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MjY5Nw==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476582697", "bodyText": "can't say I love delimitedReferences.\nHow about resourceList", "author": "gregw", "createdAt": "2020-08-25T16:33:11Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/Resource.java", "diffHunk": "@@ -921,4 +913,97 @@ public static URL toURL(File file) throws MalformedURLException\n     {\n         return file.toURI().toURL();\n     }\n+\n+    /**\n+     * Parse a list of String delimited resources and\n+     * return the List of Resources instances it represents.\n+     * <p>\n+     * Supports glob references that end in {@code /*} or {@code \\*}.\n+     * Glob references will only iterate through the level specified and will not traverse\n+     * found directories within the glob reference.\n+     * </p>\n+     *\n+     * @param delimitedReferences the comma {@code ,} or semicolon {@code ;} delimited\n+     * String of resource references.\n+     * @param globDirs true if glob references return directories within the glob as well\n+     * @return the list of resources parsed from input string.\n+     */\n+    public static List<Resource> fromList(String delimitedReferences, boolean globDirs) throws IOException", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM1MzMxMw==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477353313", "bodyText": "I'm not sold.\nTo me, that parameter is not a list, and it is not resources.\nIt's a String.\nIt supports:\n\n1 or more entries. (using simple delimited behaviors with comma or semicolon).\neach entry can be one of the following types:\n\na classpath reference.\nIt can be a relative path (to the working directory).\nIt can be a fully qualified path reference.\nIt can be a Java URI. (no side effects)\nIt can be a Java URL. (with side effects)\nIt can be a path reference with a simple glob suffix.\n\n\nno entry can, itself, have an unencoded comma , or semicolon ; in its name.", "author": "joakime", "createdAt": "2020-08-26T14:38:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MjY5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3NTU2Mg==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r491975562", "bodyText": "How can that arg not be a list of resources?  The method is  fromList not fromStringWithDelimitersSeparatingThingsThatCanBeVariouslyResolvedToResources?\nHow about:\nList<Resource> fromString(...)", "author": "gregw", "createdAt": "2020-09-21T11:42:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MjY5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4NDA1OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476584059", "bodyText": "perhaps stress that a Resource might not exist.", "author": "gregw", "createdAt": "2020-08-25T16:35:22Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceFactory.java", "diffHunk": "@@ -18,17 +18,26 @@\n \n package org.eclipse.jetty.util.resource;\n \n+import java.io.IOException;\n+\n /**\n  * ResourceFactory.\n  */\n public interface ResourceFactory\n {\n-\n     /**\n-     * Get a resource for a path.\n+     * Get a Resource from a provided String.\n+     * <p>\n+     * The behavior here is dependent on the\n+     * implementation of ResourceFactory.\n+     * The provided path can be resolved\n+     * against a known Resource, or can\n+     * be a from-scratch Resource.\n+     * </p>\n      *\n      * @param path The path to the resource\n-     * @return The resource or null\n+     * @return The resource\n+     * @throws IOException if unable to create Resource", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4NDQ1NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r476584455", "bodyText": "IllegalArgException", "author": "gregw", "createdAt": "2020-08-25T16:36:02Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/URLResource.java", "diffHunk": "@@ -290,7 +290,9 @@ public Resource addPath(String path)\n         throws IOException, MalformedURLException\n     {\n         if (path == null)\n-            return null;\n+        {\n+            throw new MalformedURLException(\"null path\");", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzMzNzY5OA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477337698", "bodyText": "How about replacing that entire thing with Objects.requireNotNull(path) ?", "author": "joakime", "createdAt": "2020-08-26T14:18:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4NDQ1NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk3MzA3MA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r491973070", "bodyText": "sure", "author": "gregw", "createdAt": "2020-09-21T11:37:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4NDQ1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0Mzc1MA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r477343750", "bodyText": "This method name is wrong.\nThis javadoc is wrong.\nThis message is wrong.\nWe are not doing CSV, we are doing simple delimited strings (which is not CSV).", "author": "joakime", "createdAt": "2020-08-26T14:26:20Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceCollection.java", "diffHunk": "@@ -182,56 +193,27 @@ public void setResources(Resource[] resources)\n      *\n      * @param csvResources the comma-separated string containing\n      * one or more resource strings.\n+     * @throws IOException if unable resource declared is not valid\n      */\n-    public void setResourcesAsCSV(String csvResources)\n+    public void setResourcesAsCSV(String csvResources) throws IOException\n     {\n-        if (csvResources == null)\n-        {\n-            throw new IllegalArgumentException(\"CSV String is null\");\n-        }\n-\n-        StringTokenizer tokenizer = new StringTokenizer(csvResources, \",;\");\n-        int len = tokenizer.countTokens();\n-        if (len == 0)\n+        if (StringUtil.isBlank(csvResources))\n         {\n-            throw new IllegalArgumentException(\"ResourceCollection@setResourcesAsCSV(String) \" +\n-                \" argument must be a string containing one or more comma-separated resource strings.\");\n+            throw new IllegalArgumentException(\"CSV String is blank\");", "originalCommit": "b35c4332b2ceda2ee7fd9a80027424175405fad2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwMzEzOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r492003139", "bodyText": "I don't think this is a big deal ... it's been this way for years without problems, so in the interests of getting 10 out, I'm fine with it as it is.", "author": "janbartel", "createdAt": "2020-09-21T12:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzM0Mzc1MA=="}], "type": "inlineReview"}, {"oid": "ccc863726b60c9d5bf6e068f639b8786aa5c83ec", "url": "https://github.com/eclipse/jetty.project/commit/ccc863726b60c9d5bf6e068f639b8786aa5c83ec", "message": "Issue #5133 - Updates based on review\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-08-26T17:19:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjYzNA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r491986634", "bodyText": "This is still the wrong exception.\nThe situation where r==nul does not represent file not found.  I not found file will return a resource that does not exist.\nr==null (if it can happen???) represents something illegal or wrong!", "author": "gregw", "createdAt": "2020-09-21T11:56:42Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/ResourceHandler.java", "diffHunk": "@@ -140,44 +142,51 @@ public MimeTypes getMimeTypes()\n     }\n \n     @Override\n-    public Resource getResource(String path)\n+    public Resource getResource(String path) throws IOException\n     {\n         if (LOG.isDebugEnabled())\n-            LOG.debug(\"{} getResource({})\", _context == null ? _baseResource : _context, _baseResource, path);\n+            LOG.debug(\"{} getResource({}): baseResource:{}\", _context == null ? _baseResource : _context, path, _baseResource);\n \n-        if (path == null || !path.startsWith(\"/\"))\n-            return null;\n+        if (StringUtil.isBlank(path))\n+        {\n+            throw new IllegalArgumentException(\"Path is blank\");\n+        }\n \n-        try\n+        if (!path.startsWith(\"/\"))\n+        {\n+            throw new IllegalArgumentException(\"Path reference invalid: \" + path);\n+        }\n+\n+        Resource r = null;\n+\n+        if (_baseResource != null)\n         {\n-            Resource r = null;\n+            path = URIUtil.canonicalPath(path);\n+            r = _baseResource.addPath(path);\n \n-            if (_baseResource != null)\n+            if (r.isAlias() && (_context == null || !_context.checkAlias(path, r)))\n             {\n-                path = URIUtil.canonicalPath(path);\n-                r = _baseResource.addPath(path);\n-\n-                if (r != null && r.isAlias() && (_context == null || !_context.checkAlias(path, r)))\n-                {\n-                    if (LOG.isDebugEnabled())\n-                        LOG.debug(\"resource={} alias={}\", r, r.getAlias());\n-                    return null;\n-                }\n+                if (LOG.isDebugEnabled())\n+                    LOG.debug(\"Rejected alias resource={} alias={}\", r, r.getAlias());\n+                throw new IllegalStateException(\"Rejected alias reference: \" + path);\n             }\n-            else if (_context != null)\n-                r = _context.getResource(path);\n+        }\n+        else if (_context != null)\n+        {\n+            r = _context.getResource(path);\n+            if (r != null)\n+                return r;\n+        }\n \n-            if ((r == null || !r.exists()) && path.endsWith(\"/jetty-dir.css\"))\n-                r = getStylesheet();\n+        if ((r == null || !r.exists()) && path.endsWith(\"/jetty-dir.css\"))\n+            r = getStylesheet();\n \n-            return r;\n-        }\n-        catch (Exception e)\n+        if (r == null)\n         {\n-            LOG.debug(\"Unable to get Resource for {}\", path, e);\n+            throw new FileNotFoundException(\"Resource: \" + path);", "originalCommit": "ccc863726b60c9d5bf6e068f639b8786aa5c83ec", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4OTIyNg==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r491989226", "bodyText": "Your description of this PR says:\n\nRefactored ResourceFactory to never return null and always throw an exception if unable to get/create/resolve the Resource\nResource.addPath(String) implementations can never return null now\n\nSo my reading of this is that r cannot be null!   So IllegalStateException would be more appropriate", "author": "gregw", "createdAt": "2020-09-21T12:01:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjYzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA4NDExOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r492084119", "bodyText": "cancel that as Context.getResources can return null;", "author": "gregw", "createdAt": "2020-09-21T14:17:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NjYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwNTQwOA==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r492005408", "bodyText": "How can it be empty? It is only allocated if you're going to add an entry.", "author": "janbartel", "createdAt": "2020-09-21T12:30:25Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceCollection.java", "diffHunk": "@@ -245,59 +233,54 @@ public Resource addPath(String path) throws IOException\n \n         if (path == null)\n         {\n-            throw new MalformedURLException();\n+            throw new MalformedURLException(\"null path\");\n         }\n \n         if (path.length() == 0 || URIUtil.SLASH.equals(path))\n         {\n             return this;\n         }\n \n-        Resource resource = null;\n-        ArrayList<Resource> resources = null;\n-        int i = 0;\n-        for (; i < _resources.length; i++)\n+        // Attempt a simple (single) Resource lookup that exists\n+        for (Resource res : _resources)\n         {\n-            resource = _resources[i].addPath(path);\n-            if (resource.exists())\n+            Resource fileResource = res.addPath(path);\n+            if (fileResource.exists())\n             {\n-                if (resource.isDirectory())\n+                if (!fileResource.isDirectory())\n                 {\n-                    break;\n+                    return fileResource;\n                 }\n-                return resource;\n             }\n         }\n \n-        for (i++; i < _resources.length; i++)\n+        // Create a list of potential resource for directories of this collection\n+        ArrayList<Resource> potentialResources = null;\n+        for (Resource res : _resources)\n         {\n-            Resource r = _resources[i].addPath(path);\n+            Resource r = res.addPath(path);\n             if (r.exists() && r.isDirectory())\n             {\n-                if (resources == null)\n+                if (potentialResources == null)\n                 {\n-                    resources = new ArrayList<>();\n+                    potentialResources = new ArrayList<>();\n                 }\n \n-                if (resource != null)\n-                {\n-                    resources.add(resource);\n-                    resource = null;\n-                }\n-\n-                resources.add(r);\n+                potentialResources.add(r);\n             }\n         }\n \n-        if (resource != null)\n+        if (potentialResources == null || potentialResources.isEmpty())", "originalCommit": "ccc863726b60c9d5bf6e068f639b8786aa5c83ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAwNzA4Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5142#discussion_r492007083", "bodyText": "This substantially changes the semantic:  before we only ever returned null, or  the first matching resource; now, you throw instead of null (fine) but only return the first resource if there is only one, otherwise you return the whole lot. Pretty sure there's code that's not going to deal with that. Can't we leave the semantic as it was before, ie only return the first?\nAlso, I don't love the var name \"potentialResources\", what was wrong with \"resources\"?", "author": "janbartel", "createdAt": "2020-09-21T12:33:16Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/resource/ResourceCollection.java", "diffHunk": "@@ -245,59 +233,54 @@ public Resource addPath(String path) throws IOException\n \n         if (path == null)\n         {\n-            throw new MalformedURLException();\n+            throw new MalformedURLException(\"null path\");\n         }\n \n         if (path.length() == 0 || URIUtil.SLASH.equals(path))\n         {\n             return this;\n         }\n \n-        Resource resource = null;\n-        ArrayList<Resource> resources = null;\n-        int i = 0;\n-        for (; i < _resources.length; i++)\n+        // Attempt a simple (single) Resource lookup that exists\n+        for (Resource res : _resources)\n         {\n-            resource = _resources[i].addPath(path);\n-            if (resource.exists())\n+            Resource fileResource = res.addPath(path);\n+            if (fileResource.exists())\n             {\n-                if (resource.isDirectory())\n+                if (!fileResource.isDirectory())\n                 {\n-                    break;\n+                    return fileResource;\n                 }\n-                return resource;\n             }\n         }\n \n-        for (i++; i < _resources.length; i++)\n+        // Create a list of potential resource for directories of this collection\n+        ArrayList<Resource> potentialResources = null;\n+        for (Resource res : _resources)\n         {\n-            Resource r = _resources[i].addPath(path);\n+            Resource r = res.addPath(path);\n             if (r.exists() && r.isDirectory())\n             {\n-                if (resources == null)\n+                if (potentialResources == null)\n                 {\n-                    resources = new ArrayList<>();\n+                    potentialResources = new ArrayList<>();\n                 }\n \n-                if (resource != null)\n-                {\n-                    resources.add(resource);\n-                    resource = null;\n-                }\n-\n-                resources.add(r);\n+                potentialResources.add(r);\n             }\n         }\n \n-        if (resource != null)\n+        if (potentialResources == null || potentialResources.isEmpty())\n         {\n-            return resource;\n+            throw new MalformedURLException(\"path does not result in Resource: \" + path);\n         }\n-        if (resources != null)\n+\n+        if (potentialResources.size() == 1)", "originalCommit": "ccc863726b60c9d5bf6e068f639b8786aa5c83ec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f6bcbda689607e140cdd0db93d4ff724a51ecb52", "url": "https://github.com/eclipse/jetty.project/commit/f6bcbda689607e140cdd0db93d4ff724a51ecb52", "message": "Issue #5133 - Changes from Review with jan & greg\n\nSigned-off-by: Joakim Erdfelt <joakim.erdfelt@gmail.com>", "committedDate": "2020-09-21T14:42:26Z", "type": "commit"}]}