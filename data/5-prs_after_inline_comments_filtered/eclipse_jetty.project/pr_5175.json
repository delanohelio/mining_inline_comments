{"pr_number": 5175, "pr_title": "Issue #5105 - StatisticsHandler Graceful Shutdown of Async Requests", "pr_createdAt": "2020-08-19T21:47:09Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/5175", "timeline": [{"oid": "a46ed5b5f06332e8d55ac4c9ee5d81d0ee219e2e", "url": "https://github.com/eclipse/jetty.project/commit/a46ed5b5f06332e8d55ac4c9ee5d81d0ee219e2e", "message": "Also manage graceful shutdown of already started async requests\n\nSigned-off-by: Thomas Draebing <thomas.draebing@sap.com>", "committedDate": "2020-08-19T07:59:21Z", "type": "commit"}, {"oid": "32358b1b7762cda392d499d1cd2077d1ab2b164d", "url": "https://github.com/eclipse/jetty.project/commit/32358b1b7762cda392d499d1cd2077d1ab2b164d", "message": "Issue #5105 - fix StatisticsHandler bug with async dispatched requests\n\nIf the request is async dispatched, the check state.isSuspended() is not\ncorrect to determine if the request was async or not. The check\nstate.isAsyncStarted() should be used instead.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-19T21:27:12Z", "type": "commit"}, {"oid": "a65f00156d7f467c244507127411cb77a286139e", "url": "https://github.com/eclipse/jetty.project/commit/a65f00156d7f467c244507127411cb77a286139e", "message": "Issue #5105 - add optional configuration to not wait for suspended requests in StatisticsHandler\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-19T21:27:12Z", "type": "commit"}, {"oid": "0fae221afab80dda2373bb6bf21ef58b142b957e", "url": "https://github.com/eclipse/jetty.project/commit/0fae221afab80dda2373bb6bf21ef58b142b957e", "message": "Issue #5105 - fix GracefulStopTest expectations from 503s to 404s\n\nStatisticsHandler no longer gives 503 responses after shutdown.\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-19T21:27:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r473359828", "bodyText": "@gregw are you sure that this behaviour change is ok?", "author": "lachlan-roberts", "createdAt": "2020-08-19T21:52:37Z", "path": "jetty-server/src/test/java/org/eclipse/jetty/server/GracefulStopTest.java", "diffHunk": "@@ -631,7 +632,7 @@ public void handle(String target, Request baseRequest, HttpServletRequest reques\n \n         // Check new connections rejected!\n         String unavailable = connector.getResponse(\"GET / HTTP/1.1\\r\\nHost:localhost\\r\\n\\r\\n\");\n-        assertThat(unavailable, containsString(\" 503 Service Unavailable\"));\n+        assertThat(unavailable, containsString(\" 404 Not Found\"));", "originalCommit": "0fae221afab80dda2373bb6bf21ef58b142b957e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTI5OA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101298", "bodyText": "Not really. This handler should never send a 404. It should either send a 503 or return without handling the request at all.\nI tend to think the later is more flexible and that context handler can send any 503s", "author": "gregw", "createdAt": "2020-08-22T15:26:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2NDU3NQ==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475364575", "bodyText": "The StatisticsHandler is not sending the 404, it is not handling the request and then the HttpChannel is sending a 404 because the request was not handled. Previously we were sending 503s from the StatisticsHandler now we are not.\nIf the StatisticsHandler is wrapping a ContextHandler then the ContextHandler won't be able to send any 503s as the request will never get there.", "author": "lachlan-roberts", "createdAt": "2020-08-24T06:16:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczMzE1OA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475733158", "bodyText": "Ah I wasn't looking closely enough.    But I still think we shouldn't change this behaviour, at least not in 9", "author": "gregw", "createdAt": "2020-08-24T16:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzM1OTgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101078", "bodyText": "I think this pattern had been used in other handlers and filters... can you check that we've not made the same mistake elsewhere.", "author": "gregw", "createdAt": "2020-08-22T15:24:03Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -168,51 +172,41 @@ public void handle(String path, Request baseRequest, HttpServletRequest request,\n \n         try\n         {\n-            Handler handler = getHandler();\n-            if (handler != null && !_shutdown.isShutdown() && isStarted())\n-                handler.handle(path, baseRequest, request, response);\n-            else\n-            {\n-                if (!baseRequest.isHandled())\n-                    baseRequest.setHandled(true);\n-                else if (_wrapWarning.compareAndSet(false, true))\n-                    LOG.warn(\"Bad statistics configuration. Latencies will be incorrect in {}\", this);\n-                if (!baseRequest.getResponse().isCommitted())\n-                    response.sendError(HttpStatus.SERVICE_UNAVAILABLE_503);\n-            }\n+            handler.handle(path, baseRequest, request, response);\n         }\n         finally\n         {\n             final long now = System.currentTimeMillis();\n             final long dispatched = now - start;\n \n-            _dispatchedStats.decrement();\n+            long numRequests = -1;\n+            long numDispatches = _dispatchedStats.decrement();\n             _dispatchedTimeStats.record(dispatched);\n \n-            if (state.isSuspended())\n+            if (state.isInitial())\n             {\n-                if (state.isInitial())\n+                if (state.isAsyncStarted())", "originalCommit": "0fae221afab80dda2373bb6bf21ef58b142b957e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM2OTA0Mw==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475369043", "bodyText": "I think there might be a similar issue in DebugHandler but that look like the only one.", "author": "lachlan-roberts", "createdAt": "2020-08-24T06:29:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczMjU4OA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475732588", "bodyText": "OK - fix it in the PR", "author": "gregw", "createdAt": "2020-08-24T16:17:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjAwOTgwOQ==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476009809", "bodyText": "Looks like DebugHandler is deprecated and its replacement DebugListener does not have the same issue.\nI have pushed a fix to this PR for DebugHandler.", "author": "lachlan-roberts", "createdAt": "2020-08-25T00:44:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTA3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTU1OQ==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101559", "bodyText": "Bad name as \"suspended\" is no longer really a thing and the name is a hangover from completions.\nThe choice is between shutting down on zero request or zero dispatched... how about just asyncGraceful?", "author": "gregw", "createdAt": "2020-08-22T15:29:35Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -67,6 +66,8 @@\n     private final LongAdder _responses5xx = new LongAdder();\n     private final LongAdder _responsesTotalBytes = new LongAdder();\n \n+    private boolean waitForSuspendedRequestsOnShutdown = true;", "originalCommit": "0fae221afab80dda2373bb6bf21ef58b142b957e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTEwMTY3MA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r475101670", "bodyText": "start name with set", "author": "gregw", "createdAt": "2020-08-22T15:30:30Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -263,6 +259,16 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    /**\n+     * Set whether the graceful shutdown should wait for all requests to complete (including suspended requests)\n+     * or whether it should only wait for all the actively dispatched requests to complete.\n+     * @param waitForSuspendedRequests true to wait for suspended requests on graceful shutdown.\n+     */\n+    public void waitForSuspendedRequestsOnShutdown(boolean waitForSuspendedRequests)", "originalCommit": "0fae221afab80dda2373bb6bf21ef58b142b957e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0268c590f118720537e1b72c9a4cb1915cdfc39", "url": "https://github.com/eclipse/jetty.project/commit/c0268c590f118720537e1b72c9a4cb1915cdfc39", "message": "change name of waitForSuspendedRequestsOnShutdown to asyncGraceful\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-24T06:19:59Z", "type": "commit"}, {"oid": "2d5da1fa35d81584ce0f947b1e12b46e98762192", "url": "https://github.com/eclipse/jetty.project/commit/2d5da1fa35d81584ce0f947b1e12b46e98762192", "message": "StatisticsHandler should still return 503 responses on shutdown\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-25T00:34:59Z", "type": "commit"}, {"oid": "8edb7682cdedd3c14717eb8fd424db339273aec9", "url": "https://github.com/eclipse/jetty.project/commit/8edb7682cdedd3c14717eb8fd424db339273aec9", "message": "DebugHandler should use isAsyncStarted() instead of isSuspended()\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-25T00:40:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU3NzY5MA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476577690", "bodyText": "Fix the comment above the if statement too, or remove it altogether so it won't rot.", "author": "sbordet", "createdAt": "2020-08-25T16:25:41Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -105,15 +106,15 @@ public void onComplete(AsyncEvent event) throws IOException\n             Request request = state.getBaseRequest();\n             final long elapsed = System.currentTimeMillis() - request.getTimeStamp();\n \n-            long d = _requestStats.decrement();\n+            long numRequests = _requestStats.decrement();\n             _requestTimeStats.record(elapsed);\n \n             updateResponse(request);\n \n             _asyncWaitStats.decrement();\n \n             // If we have no more dispatches, should we signal shutdown?\n-            if (d == 0)\n+            if (numRequests == 0 && asyncGraceful)", "originalCommit": "8edb7682cdedd3c14717eb8fd424db339273aec9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjU4MDIxNA==", "url": "https://github.com/eclipse/jetty.project/pull/5175#discussion_r476580214", "bodyText": "The getter method is missing and should be annotated with @ManagedAttribute.", "author": "sbordet", "createdAt": "2020-08-25T16:29:28Z", "path": "jetty-server/src/main/java/org/eclipse/jetty/server/handler/StatisticsHandler.java", "diffHunk": "@@ -263,6 +264,17 @@ protected void doStop() throws Exception\n         super.doStop();\n     }\n \n+    /**\n+     * Set whether the graceful shutdown should wait for all requests to complete including\n+     * async requests which are not currently dispatched, or whether it should only wait for all the\n+     * actively dispatched requests to complete.\n+     * @param asyncGraceful true to wait for async requests on graceful shutdown.\n+     */\n+    public void setAsyncGraceful(boolean asyncGraceful)\n+    {\n+        this.asyncGraceful = asyncGraceful;\n+    }\n+", "originalCommit": "8edb7682cdedd3c14717eb8fd424db339273aec9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a9c90d330915933abc49805364f06cb41079f242", "url": "https://github.com/eclipse/jetty.project/commit/a9c90d330915933abc49805364f06cb41079f242", "message": "Issue #5105 - change asyncGraceful to gracefulShutdownWaitsForRequests\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-26T22:59:13Z", "type": "commit"}, {"oid": "a9c90d330915933abc49805364f06cb41079f242", "url": "https://github.com/eclipse/jetty.project/commit/a9c90d330915933abc49805364f06cb41079f242", "message": "Issue #5105 - change asyncGraceful to gracefulShutdownWaitsForRequests\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-08-26T22:59:13Z", "type": "forcePushed"}]}