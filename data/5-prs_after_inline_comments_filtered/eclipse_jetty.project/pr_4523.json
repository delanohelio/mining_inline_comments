{"pr_number": 4523, "pr_title": "Issue #4502 - allow changing of close response from jetty and javax websocket onClose events", "pr_createdAt": "2020-01-29T04:25:38Z", "pr_url": "https://github.com/eclipse/jetty.project/pull/4523", "timeline": [{"oid": "4ef208e9f62282ff8a9315ef80d47b43ce9a70f8", "url": "https://github.com/eclipse/jetty.project/commit/4ef208e9f62282ff8a9315ef80d47b43ce9a70f8", "message": "Issue #4502 - onClose can now be triggered on receiving a close frame\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-01-29T04:19:48Z", "type": "commit"}, {"oid": "fdd27a9f28a66754675cd2db0f11a8b3e3593503", "url": "https://github.com/eclipse/jetty.project/commit/fdd27a9f28a66754675cd2db0f11a8b3e3593503", "message": "Issue #4502 - add onClose tests for Jetty and Javax WS APIs\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-01-29T04:20:36Z", "type": "commit"}, {"oid": "8638fb2cc3ed80c7410249a31ad253d67479a458", "url": "https://github.com/eclipse/jetty.project/commit/8638fb2cc3ed80c7410249a31ad253d67479a458", "message": "Fix broken test cases\n\nSigned-off-by: Lachlan Roberts <lachlan@webtide.com>", "committedDate": "2020-01-29T08:13:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NjQ4NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372276485", "bodyText": "How can this happen?  Is this a problem with Core?", "author": "gregw", "createdAt": "2020-01-29T09:38:35Z", "path": "jetty-websocket/websocket-javax-common/src/main/java/org/eclipse/jetty/websocket/javax/common/JavaxWebSocketFrameHandler.java", "diffHunk": "@@ -278,24 +282,41 @@ public void onFrame(Frame frame, Callback callback)\n             dataType = OpCode.UNDEFINED;\n     }\n \n+    public void onClose(Frame frame, Callback callback)\n+    {\n+        notifyOnClose(CloseStatus.getCloseStatus(frame), callback);\n+    }\n+\n     @Override\n     public void onClosed(CloseStatus closeStatus, Callback callback)\n     {\n+        notifyOnClose(closeStatus, callback);\n+        container.notifySessionListeners((listener) -> listener.onJavaxWebSocketSessionClosed(session));\n+    }\n+\n+    private void notifyOnClose(CloseStatus closeStatus, Callback callback)\n+    {\n+        // Make sure onClose is only notified once.\n+        if (!closeNotified.compareAndSet(false, true))", "originalCommit": "8638fb2cc3ed80c7410249a31ad253d67479a458", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyMzYwMQ==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372323601", "bodyText": "No the websocket-core onClosed event means the websocket is fully closed. @sbordet  wanted the ability to send alternate close responses from the API onClose events, so now the onClose event at the API level can be triggered in two ways:\nReceiving a close frame (in which case the websocket is still out open to send a custom close response).\nOr by the core onClosed event (if we never received the close frame but still get closed because of an error or something).\nSo we call notifyOnClose from both these places but we only want to actually call the API onClose event once.", "author": "lachlan-roberts", "createdAt": "2020-01-29T11:15:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3NjQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3Nzg2MA==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372277860", "bodyText": "why public?  surely protected?", "author": "gregw", "createdAt": "2020-01-29T09:41:16Z", "path": "jetty-websocket/websocket-javax-common/src/main/java/org/eclipse/jetty/websocket/javax/common/JavaxWebSocketFrameHandler.java", "diffHunk": "@@ -278,24 +282,41 @@ public void onFrame(Frame frame, Callback callback)\n             dataType = OpCode.UNDEFINED;\n     }\n \n+    public void onClose(Frame frame, Callback callback)", "originalCommit": "8638fb2cc3ed80c7410249a31ad253d67479a458", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyNDA3Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372324076", "bodyText": "Yes I guess this could be protected, all the other methods onText, onPong, etc.. are public, these methods all already existed. Should I change them all to protected?", "author": "lachlan-roberts", "createdAt": "2020-01-29T11:16:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI3Nzg2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NzUxMg==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372297512", "bodyText": "You don't want to wrap a RuntimeException inside another... the old code was correct.", "author": "sbordet", "createdAt": "2020-01-29T10:19:22Z", "path": "jetty-util/src/main/java/org/eclipse/jetty/util/FutureCallback.java", "diffHunk": "@@ -163,9 +163,7 @@ public void block(long timeout, TimeUnit unit) throws IOException\n         {\n             Throwable cause = e.getCause();\n             if (cause instanceof RuntimeException)\n-                throw (RuntimeException)cause;\n-            else if (cause instanceof IOException)\n-                throw (IOException)cause;\n+                throw new RuntimeException(cause);", "originalCommit": "8638fb2cc3ed80c7410249a31ad253d67479a458", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyNDI1MA==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372324250", "bodyText": "What about rewrapping of the IOException, I was getting stack traces that were being thrown and they didn't trace back through theFutureCallback.block() line and just some seemingly unrelated code, so I thought that was a bit weird and decided to wrap them instead so you could see the block call in the stack trace. I can revert this, wasn't sure what the correct behaviour was.", "author": "lachlan-roberts", "createdAt": "2020-01-29T11:16:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NzUxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM1NDM0Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372354346", "bodyText": "I see now, leave this rewrapping then, so applications will have a nicer stack trace that get lost because we unwrap ExecutionException.", "author": "sbordet", "createdAt": "2020-01-29T12:29:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5NzUxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5ODc5Ng==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372298796", "bodyText": "notifyOnClose() has a guard to avoid notifying more than once, but then container.notifySessionListeners() will be called more than once, so either notifyOnClose() returns a boolean or you need to be tighter with the once-only semantic.", "author": "sbordet", "createdAt": "2020-01-29T10:22:11Z", "path": "jetty-websocket/websocket-javax-common/src/main/java/org/eclipse/jetty/websocket/javax/common/JavaxWebSocketFrameHandler.java", "diffHunk": "@@ -278,24 +282,41 @@ public void onFrame(Frame frame, Callback callback)\n             dataType = OpCode.UNDEFINED;\n     }\n \n+    public void onClose(Frame frame, Callback callback)\n+    {\n+        notifyOnClose(CloseStatus.getCloseStatus(frame), callback);\n+    }\n+\n     @Override\n     public void onClosed(CloseStatus closeStatus, Callback callback)\n     {\n+        notifyOnClose(closeStatus, callback);\n+        container.notifySessionListeners((listener) -> listener.onJavaxWebSocketSessionClosed(session));", "originalCommit": "8638fb2cc3ed80c7410249a31ad253d67479a458", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMyNDM3NQ==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372324375", "bodyText": "This method is for the websocket-core onClosed event which is only ever called once. We also call notifyOnClose() when we receive a close frame which is why it needs the guard and container.notifySessionListeners() does not.", "author": "lachlan-roberts", "createdAt": "2020-01-29T11:17:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5ODc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjI5OTM2OA==", "url": "https://github.com/eclipse/jetty.project/pull/4523#discussion_r372299368", "bodyText": "Ditto above.", "author": "sbordet", "createdAt": "2020-01-29T10:23:20Z", "path": "jetty-websocket/websocket-jetty-common/src/main/java/org/eclipse/jetty/websocket/common/JettyWebSocketFrameHandler.java", "diffHunk": "@@ -287,6 +295,19 @@ public void onClosed(CloseStatus closeStatus, Callback callback)\n             state = SuspendState.CLOSED;\n         }\n \n+        notifyOnClose(closeStatus, callback);\n+        container.notifySessionListeners((listener) -> listener.onWebSocketSessionClosed(session));", "originalCommit": "8638fb2cc3ed80c7410249a31ad253d67479a458", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}