{"pr_number": 1021, "pr_title": "fix(iot-dev): fix issue where AMQP layer sometimes throws \"uncorrelated channel\" NPE", "pr_createdAt": "2020-12-09T16:42:16Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021", "timeline": [{"oid": "fc318a3d7795eb960f1dfc48b0f4ae27e1b54c8a", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/fc318a3d7795eb960f1dfc48b0f4ae27e1b54c8a", "message": "fix(iot-dev): fix issue where AMQP layer sometimes throws \"uncorrelated\nchannel\" NPE", "committedDate": "2020-12-09T16:41:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3MzMxOQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539473319", "bodyText": "Is this ever being set to true somewhere or is this for the future?", "author": "jamdavi", "createdAt": "2020-12-09T16:50:48Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionHandler.java", "diffHunk": "@@ -80,13 +80,35 @@ public void setSession(Session session)\n         this.twinReceiverLinkOpened = false;\n         this.methodsSenderLinkOpened = false;\n         this.methodsReceiverLinkOpened = false;\n+        this.sessionOpenedRemotely = false;\n+        this.sessionHandlerClosedBeforeRemoteSessionOpened = false;\n     }\n \n     public void closeSession()\n     {\n         if (this.session != null)\n         {\n-            this.session.close();\n+            if (this.sessionOpenedRemotely)", "originalCommit": "fc318a3d7795eb960f1dfc48b0f4ae27e1b54c8a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3NjAxNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539476014", "bodyText": "Good catch, somehow this didn't get committed to this PR. I've added it being set to true on the onSessionRemoteOpen event now", "author": "timtay-microsoft", "createdAt": "2020-12-09T16:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ3MzMxOQ=="}], "type": "inlineReview"}, {"oid": "e75bcfeb0ca3b3dc608bab639627b560432c975f", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/e75bcfeb0ca3b3dc608bab639627b560432c975f", "message": "fixup", "committedDate": "2020-12-09T16:53:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MjUwNw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539482507", "bodyText": "Since we're intentionally closing this session but not opening a new one in this method we should definitely log it as an error/warning.\nDo we want session.close() to throw here ?", "author": "jamdavi", "createdAt": "2020-12-09T17:02:02Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/transport/amqps/AmqpsSessionHandler.java", "diffHunk": "@@ -105,7 +127,12 @@ public void onSessionFinal(Event e)\n     public void onSessionRemoteOpen(Event e)\n     {\n         log.trace(\"Device session opened remotely for device {}\", this.getDeviceId());\n-        if (this.deviceClientConfig.getAuthenticationType() == DeviceClientConfig.AuthType.X509_CERTIFICATE)\n+        this.sessionOpenedRemotely = true;\n+        if (this.sessionHandlerClosedBeforeRemoteSessionOpened)\n+        {\n+            this.session.close();", "originalCommit": "e75bcfeb0ca3b3dc608bab639627b560432c975f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4OTQ0OA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539489448", "bodyText": "The connection handler that manages 1 to many of these session handlers is generally in charge of managing which sessions are opened and closed. In this particular case, there is no need to open a new session from this session handler since the connection handler deliberately closed this session handler.\nThe expected flow here during retry logic is to have the connection handler create a new session handler for the device that is reconnecting, and if that session handler doesn't open in time, then we close it, wait for a few seconds, and then open a new session handler to try again", "author": "timtay-microsoft", "createdAt": "2020-12-09T17:11:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MjUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4OTc2Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539489763", "bodyText": "In essence, the session handler is disposable, just like the amqp session itself is here", "author": "timtay-microsoft", "createdAt": "2020-12-09T17:11:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MjUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5MzQ5Mg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539493492", "bodyText": "Do we want session.close() to throw here ?\n\nThis is expected behavior to respond to the service acknowledging the beginning of a session that we no longer track, so no", "author": "timtay-microsoft", "createdAt": "2020-12-09T17:16:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MjUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5MzgxMw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539493813", "bodyText": "Got it, so what ever is calling these onXXXX methods due to the event should have context of the state and this just fired out of order due to some unforeseen circumstance.\nStill probably worth logging that this condition happened either here or in the closeSession event above", "author": "jamdavi", "createdAt": "2020-12-09T17:17:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MjUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5ODU5Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1021#discussion_r539498596", "bodyText": "Good idea, I can add some extra logs for this", "author": "timtay-microsoft", "createdAt": "2020-12-09T17:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4MjUwNw=="}], "type": "inlineReview"}, {"oid": "9fc1ecf10a8dc3254413edc2e58a94b948601513", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/9fc1ecf10a8dc3254413edc2e58a94b948601513", "message": "fixup", "committedDate": "2020-12-09T17:25:17Z", "type": "commit"}]}