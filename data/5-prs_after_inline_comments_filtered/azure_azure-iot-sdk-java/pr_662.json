{"pr_number": 662, "pr_title": "Refactor Device client and Deps amqp layers to add better error logging", "pr_createdAt": "2020-01-06T19:05:21Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/662", "timeline": [{"oid": "22a15ff8164e4b94db004b3abc153f8f372fde0d", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/22a15ff8164e4b94db004b3abc153f8f372fde0d", "message": "refactor(deps): Add error logging base handler for amqp connections", "committedDate": "2020-01-04T00:43:40Z", "type": "commit"}, {"oid": "220f8ee6355f9d96229f874f0a4f281d26c9aa6d", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/220f8ee6355f9d96229f874f0a4f281d26c9aa6d", "message": "refactor(iot-dev): Extend error logging base handler for device client", "committedDate": "2020-01-04T00:43:40Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364497338", "bodyText": "Why is this check required? It would be better to check that endpoints is not null.", "author": "abhipsaMisra", "createdAt": "2020-01-08T23:38:02Z", "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ProtonJExceptionParser.java", "diffHunk": "@@ -0,0 +1,58 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.Getter;\n+import org.apache.qpid.proton.amqp.transport.ErrorCondition;\n+import org.apache.qpid.proton.engine.Endpoint;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Getter\n+public class ProtonJExceptionParser\n+{\n+    private String error;\n+    private String errorDescription;\n+\n+    private static final String DEFAULT_ERROR_DESCRIPTION = \"NoErrorDescription\";\n+\n+    public ProtonJExceptionParser(Event event)\n+    {\n+        getTransportExceptionFromProtonEndpoints(event.getSender(), event.getReceiver(), event.getConnection(), event.getTransport(), event.getSession(), event.getLink());\n+    }\n+\n+    private ErrorCondition getErrorConditionFromEndpoint(Endpoint endpoint)\n+    {\n+        return endpoint.getCondition() != null && endpoint.getCondition().getCondition() != null ? endpoint.getCondition() : endpoint.getRemoteCondition();\n+    }\n+\n+    private void getTransportExceptionFromProtonEndpoints(Endpoint... endpoints)\n+    {\n+        for (Endpoint endpoint : endpoints)\n+        {\n+            if (endpoint == null)", "originalCommit": "220f8ee6355f9d96229f874f0a4f281d26c9aa6d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwNDY4Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364504683", "bodyText": "This check is required because that collection of endpoints does contain some null endpoints", "author": "timtay-microsoft", "createdAt": "2020-01-09T00:06:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwNDg3NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364504875", "bodyText": "The collection of endpoints is never null, though", "author": "timtay-microsoft", "createdAt": "2020-01-09T00:07:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUwOTQyOQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364509429", "bodyText": "The Endpoint spread is over the inputs we get from the constructor; makes sense.", "author": "abhipsaMisra", "createdAt": "2020-01-09T00:26:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NzMzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMDQ0Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364510446", "bodyText": "Do we allow multiple sessions over a single connection? If yes, then it'll be useful to log the session identifier here as well (similar to link).", "author": "abhipsaMisra", "createdAt": "2020-01-09T00:30:48Z", "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/transport/amqp/ErrorLoggingBaseHandler.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ *  Copyright (c) Microsoft. All rights reserved.\n+ *  Licensed under the MIT license. See LICENSE file in the project root for full license information.\n+ */\n+\n+package com.microsoft.azure.sdk.iot.deps.transport.amqp;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.apache.qpid.proton.engine.BaseHandler;\n+import org.apache.qpid.proton.engine.Event;\n+\n+@Slf4j\n+public class ErrorLoggingBaseHandler extends BaseHandler\n+{\n+    protected ProtonJExceptionParser protonJExceptionParser;\n+\n+    @Override\n+    public void onLinkRemoteClose(Event event)\n+    {\n+        protonJExceptionParser = new ProtonJExceptionParser(event);\n+        if (protonJExceptionParser.getError() == null)\n+        {\n+            log.debug(\"Amqp link {} was closed remotely\", event.getLink().getName());\n+        }\n+        else\n+        {\n+            if (event.getLink() != null && event.getLink().getName() != null)\n+            {\n+                log.warn(\"Amqp link {} was closed remotely with exception {} with description {}\", event.getLink().getName(), protonJExceptionParser.getError(), protonJExceptionParser.getErrorDescription());\n+            }\n+            else\n+            {\n+                log.warn(\"Unknown amqp link was closed remotely with exception {} with description {}\", protonJExceptionParser.getError(), protonJExceptionParser.getErrorDescription());\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onSessionRemoteClose(Event event)\n+    {\n+        protonJExceptionParser = new ProtonJExceptionParser(event);\n+        if (protonJExceptionParser.getError() == null)", "originalCommit": "22a15ff8164e4b94db004b3abc153f8f372fde0d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDU2MTU0Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/662#discussion_r364561547", "bodyText": "We do open multiple sessions for multiplexed connections, I believe. However, the proton-j session object doesn't have any information in it here that we could use to correlate back to which session it was. Sessions being closed remotely are a bit of a rare case, from my understanding, so we can hold off on adding that kind of mapping for now", "author": "timtay-microsoft", "createdAt": "2020-01-09T05:10:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDUxMDQ0Ng=="}], "type": "inlineReview"}]}