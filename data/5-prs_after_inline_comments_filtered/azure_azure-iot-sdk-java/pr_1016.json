{"pr_number": 1016, "pr_title": "[Preview] Fix multiplexingClient not allowing re-registered clients to subscribe to twin/methods", "pr_createdAt": "2020-12-07T20:16:29Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/1016", "timeline": [{"oid": "51ca3f6f8d0de45db609d52209e66ac4694bf598", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/51ca3f6f8d0de45db609d52209e66ac4694bf598", "message": "fix(iot-dev): Fix multiplexingClient not allowing re-registered clients to subscribe to twin/methods\n\nAdded some clarification in the javadocs for register/unregister to explain that subscriptions from a previous connection are not preserved when re-registered.", "committedDate": "2020-12-07T22:36:06Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxMDYxOA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1016#discussion_r537910618", "bodyText": "Elsewhere in this class, this field is assigned when the user wants to subscribe to methods. When not null, this layer assumes that it is already subscribed. So setting this value to null again allows users to subscribe to methods again later if they re-register", "author": "timtay-microsoft", "createdAt": "2020-12-07T23:24:02Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/InternalClient.java", "diffHunk": "@@ -627,6 +627,20 @@ void startTwinInternal(IotHubEventCallback twinStatusCallback, Object twinStatus\n         }\n     }\n \n+    // only used by the MultiplexingClient class to signal to this client that it needs to re-register twin\n+    // callbacks\n+    void markTwinAsUnsubscribed()\n+    {\n+        this.twin = null;\n+    }\n+\n+    // only used by the MultiplexingClient class to signal to this client that it needs to re-register methods\n+    // callbacks\n+    void markMethodsAsUnsubscribed()\n+    {\n+        this.method = null;", "originalCommit": "51ca3f6f8d0de45db609d52209e66ac4694bf598", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkxMjcxNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/1016#discussion_r537912714", "bodyText": "MessageCallback allows for us and users to set the callback to null, but methods and twin do not, hence the need for these new markTwin/MethodAsUnsubscribed methods", "author": "timtay-microsoft", "createdAt": "2020-12-07T23:26:23Z", "path": "device/iot-device-client/src/main/java/com/microsoft/azure/sdk/iot/device/MultiplexingClient.java", "diffHunk": "@@ -601,6 +625,12 @@ public void unregisterDeviceClients(Iterable<DeviceClient> deviceClients, long t\n                 log.info(\"Unregistering device {} from multiplexing client\", deviceClientToUnregister.getConfig().getDeviceId());\n                 this.multiplexedDeviceClients.remove(deviceClientToUnregister.getConfig().getDeviceId());\n                 deviceClientToUnregister.setDeviceIO(null);\n+\n+                // Clear the device client's subscriptions after it has been unregistered from the multiplexing client\n+                // We may make this optional at some point in the future if users want to be able to preserve subscriptions.\n+                deviceClientToUnregister.markTwinAsUnsubscribed();\n+                deviceClientToUnregister.markMethodsAsUnsubscribed();\n+                deviceClientToUnregister.setMessageCallback(null, null);", "originalCommit": "51ca3f6f8d0de45db609d52209e66ac4694bf598", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ebe53539a29200a633128d5266a50d834239373", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5ebe53539a29200a633128d5266a50d834239373", "message": "fix(iot-dev): Fix multiplexingClient not allowing re-registered clients to subscribe to twin/methods\n\nAdded some clarification in the javadocs for register/unregister to explain that subscriptions from a previous connection are not preserved when re-registered.", "committedDate": "2020-12-07T23:44:19Z", "type": "commit"}, {"oid": "5933548fdb7a96d7f2b145abd5007d8d521dca31", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5933548fdb7a96d7f2b145abd5007d8d521dca31", "message": "fixup", "committedDate": "2020-12-07T23:47:01Z", "type": "forcePushed"}, {"oid": "5933548fdb7a96d7f2b145abd5007d8d521dca31", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/5933548fdb7a96d7f2b145abd5007d8d521dca31", "message": "fixup", "committedDate": "2020-12-07T23:47:01Z", "type": "commit"}]}