{"pr_number": 822, "pr_title": "feat(iot-service): Add model id support for PnP", "pr_createdAt": "2020-06-24T23:48:09Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/822", "timeline": [{"oid": "0ede6d6e2e9a6f770764d97fc7216a72be83c2de", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/0ede6d6e2e9a6f770764d97fc7216a72be83c2de", "message": "initial changes for service client and uts", "committedDate": "2020-06-23T23:45:18Z", "type": "commit"}, {"oid": "812e72dd9bbac2259b0c41d9d190e99f2e0467d2", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/812e72dd9bbac2259b0c41d9d190e99f2e0467d2", "message": "update comments", "committedDate": "2020-06-23T23:57:03Z", "type": "commit"}, {"oid": "8a1f4c33a74d37ee72d8f47e471667b4fde49b38", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/8a1f4c33a74d37ee72d8f47e471667b4fde49b38", "message": "remove unnecessary changes", "committedDate": "2020-06-24T18:53:19Z", "type": "commit"}, {"oid": "ef495818e2e43470bb266f74402c4e5c5c2fa76b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ef495818e2e43470bb266f74402c4e5c5c2fa76b", "message": "remove device changes", "committedDate": "2020-06-24T21:00:14Z", "type": "commit"}, {"oid": "950b7e27ea9a1c6a835766cac560aeefa5a3d6a2", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/950b7e27ea9a1c6a835766cac560aeefa5a3d6a2", "message": "Merge branch 'preview' into bikamani/modelIdPreview", "committedDate": "2020-06-24T23:36:27Z", "type": "commit"}, {"oid": "b252acb0f6153cc09799f96d95e41dd3714a22ce", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/b252acb0f6153cc09799f96d95e41dd3714a22ce", "message": " revert some changes", "committedDate": "2020-06-24T23:40:44Z", "type": "commit"}, {"oid": "039b4f3ad0ebbffdb2d9583847f47563b9cf3d1b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/039b4f3ad0ebbffdb2d9583847f47563b9cf3d1b", "message": "preview api version", "committedDate": "2020-06-24T23:46:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIzMjg3OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r445232879", "bodyText": "Unit Test to check whether this value is set correctly for Twin", "author": "bikamani", "createdAt": "2020-06-24T23:51:40Z", "path": "service/iot-service-client/src/test/java/tests/unit/com/microsoft/azure/sdk/iot/service/devicetwin/DeviceTwinTest.java", "diffHunk": "@@ -946,20 +946,19 @@ public void nextRetrievesCorrectlyWithoutModuleId() throws IotHubException, IOEx\n         final String connectionString = \"testString\";\n         DeviceTwin testTwin = DeviceTwin.createFromConnectionString(connectionString);\n         final String expectedString = \"testJsonAsNext\";\n+        final String modelId = \"testModelId\";", "originalCommit": "039b4f3ad0ebbffdb2d9583847f47563b9cf3d1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8747d71ae55fdfc18f81e8f627984268aab6130f", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/8747d71ae55fdfc18f81e8f627984268aab6130f", "message": "fix twinstate uts", "committedDate": "2020-06-25T00:26:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNzAzMw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448017033", "bodyText": "Is this needed now that modelid sits on device twin?", "author": "prmathur-microsoft", "createdAt": "2020-06-30T22:35:20Z", "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/twin/RegisterManager.java", "diffHunk": "@@ -123,6 +125,17 @@\n     @SerializedName(CAPABILITIES_TAG)\n     protected DeviceCapabilities capabilities = null;\n \n+    /**\n+     * The Digital Twin model id of the device and module\n+     * The value will be null for a non-pnp device.\n+     * The value will be null for a pnp device until the device connects and registers with the model id.\n+     */\n+    private static final String MODEL_ID = \"digital-twin-model-id\";\n+    @Expose(serialize = true, deserialize = true)\n+    @SerializedName(MODEL_ID)\n+    @Setter\n+    @Getter\n+    protected String modelId = null;", "originalCommit": "8747d71ae55fdfc18f81e8f627984268aab6130f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxODc3Mw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448018773", "bodyText": "+1 on this comment. This new field should only exist on twin, not identity", "author": "timtay-microsoft", "createdAt": "2020-06-30T22:40:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNzAzMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUxMTY4MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448511681", "bodyText": "Synced offline on this. This class is used for Twin and this field exist on twin only.", "author": "bikamani", "createdAt": "2020-07-01T17:26:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNzAzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNzczOQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448017739", "bodyText": "Why is this check needed? What would happen if a null or empty is placed on parser.", "author": "prmathur-microsoft", "createdAt": "2020-06-30T22:37:27Z", "path": "service/iot-service-client/src/main/java/com/microsoft/azure/sdk/iot/service/devicetwin/DeviceTwinDevice.java", "diffHunk": "@@ -536,6 +542,10 @@ public String toString()\n         {\n             thisDevice.append(\"Version: \" + this.getVersion() + \"\\n\");\n         }\n+        if(this.modelId != null && !this.modelId.isEmpty())\n+        {", "originalCommit": "8747d71ae55fdfc18f81e8f627984268aab6130f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyODk5Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448528997", "bodyText": "This is a toString function. There's no reason to print the modelId if there is no modelId", "author": "timtay-microsoft", "createdAt": "2020-07-01T17:59:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNzczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzNDIyMQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448534221", "bodyText": "I see that this pattern is followed everywhere. Looking back I would have just printed the data as is i.e. along with null to represent what has actually come on the wire from service. However now I don't think we can make that change and should follow the suit.", "author": "prmathur-microsoft", "createdAt": "2020-07-01T18:09:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNzczOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzNTAzNQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448535035", "bodyText": "If we want to print out null/empty values, this check is not needed. I followed the pattern similar to module id and others as it doesn't seem to provide any value printing out null/empty", "author": "bikamani", "createdAt": "2020-07-01T18:11:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxNzczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxODg1OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448018859", "bodyText": "Questions : 1. Where is this verified to be working?\n2. Will e2e be another PR? Is the task captured?", "author": "prmathur-microsoft", "createdAt": "2020-06-30T22:40:59Z", "path": "deps/src/main/java/com/microsoft/azure/sdk/iot/deps/twin/RegisterManager.java", "diffHunk": "@@ -8,6 +8,8 @@\n import com.microsoft.azure.sdk.iot.deps.serializer.ConfigurationContentParser;", "originalCommit": "8747d71ae55fdfc18f81e8f627984268aab6130f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUxMjQ1NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448512454", "bodyText": "Verified using a sample.\nI added e2e task for this PBI, thanks for reminding", "author": "bikamani", "createdAt": "2020-07-01T17:27:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxODg1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxOTYzMQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448019631", "bodyText": "Same comment here", "author": "prmathur-microsoft", "createdAt": "2020-06-30T22:43:08Z", "path": "service/iot-service-client/src/main/java/com/microsoft/azure/sdk/iot/service/devicetwin/DeviceTwin.java", "diffHunk": "@@ -504,6 +505,11 @@ private DeviceTwinDevice jsonToDeviceTwinDevice(String json) throws IOException\n         deviceTwinDevice.setConnectionState(twinState.getConnectionState());\n         deviceTwinDevice.setConfigurations(twinState.getConfigurations());\n \n+        if (twinState.getModelId() != null && !twinState.getModelId().isEmpty())\n+        {", "originalCommit": "8747d71ae55fdfc18f81e8f627984268aab6130f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUyNjAxNg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448526016", "bodyText": "I would like to understand if there is a reasoning behind why should we set model id when null/empty?", "author": "bikamani", "createdAt": "2020-07-01T17:53:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxOTYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzMzE5OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448533199", "bodyText": "To avoid SDK's having any check. The point I was making is we should leave it to service to throw incase there is no model id and not customize it here.", "author": "prmathur-microsoft", "createdAt": "2020-07-01T18:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxOTYzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUzODg1OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448538859", "bodyText": "ok. done", "author": "bikamani", "createdAt": "2020-07-01T18:19:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAxOTYzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMDU1NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448020555", "bodyText": "unrelated to this PR, but why did we name this DeviceTwinDevice? Is it to separate a device twin from a module twin? Is it public? Can we rename it?", "author": "abhipsaMisra", "createdAt": "2020-06-30T22:46:09Z", "path": "service/iot-service-client/src/main/java/com/microsoft/azure/sdk/iot/service/devicetwin/DeviceTwin.java", "diffHunk": "@@ -504,6 +505,11 @@ private DeviceTwinDevice jsonToDeviceTwinDevice(String json) throws IOException\n         deviceTwinDevice.setConnectionState(twinState.getConnectionState());\n         deviceTwinDevice.setConfigurations(twinState.getConfigurations());\n \n+        if (twinState.getModelId() != null && !twinState.getModelId().isEmpty())\n+        {\n+            deviceTwinDevice.setModelId(twinState.getModelId());", "originalCommit": "8747d71ae55fdfc18f81e8f627984268aab6130f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODUxMjY2Ng==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448512666", "bodyText": "synced offline on this.", "author": "bikamani", "createdAt": "2020-07-01T17:28:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODAyMDU1NQ=="}], "type": "inlineReview"}, {"oid": "c99db4361474ae17773827f48ebf863ec065e5f0", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/c99db4361474ae17773827f48ebf863ec065e5f0", "message": "remove null check", "committedDate": "2020-07-01T18:17:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTE4Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448551187", "bodyText": "Have you verified that this works for non PnP device before making the change?", "author": "prmathur-microsoft", "createdAt": "2020-07-01T18:44:10Z", "path": "service/iot-service-client/src/main/java/com/microsoft/azure/sdk/iot/service/devicetwin/DeviceTwin.java", "diffHunk": "@@ -504,11 +504,7 @@ private DeviceTwinDevice jsonToDeviceTwinDevice(String json) throws IOException\n         deviceTwinDevice.setCapabilities(twinState.getCapabilities());\n         deviceTwinDevice.setConnectionState(twinState.getConnectionState());\n         deviceTwinDevice.setConfigurations(twinState.getConfigurations());\n-", "originalCommit": "c99db4361474ae17773827f48ebf863ec065e5f0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MjAyNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448562024", "bodyText": "yes for non pnp this value is set to null, when printed it will look like below:\nDevice ID: some value\nETag: etag value\nModel ID:\nTags:{}\nReported Properties{}\nDesired Properties: {}", "author": "bikamani", "createdAt": "2020-07-01T19:07:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTE4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODYyMzY0NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/822#discussion_r448623644", "bodyText": "\ud83d\udc4d", "author": "prmathur-microsoft", "createdAt": "2020-07-01T21:23:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU1MTE4Nw=="}], "type": "inlineReview"}]}