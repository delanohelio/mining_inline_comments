{"pr_number": 818, "pr_title": "refactor(e2e): Simplify file upload tests, re-enable file upload tests on android", "pr_createdAt": "2020-06-24T21:13:27Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/818", "timeline": [{"oid": "1b1c88aed756b3d63d712af4c6e0cbe75a217af9", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/1b1c88aed756b3d63d712af4c6e0cbe75a217af9", "message": "refactor(e2e): Simplify file upload tests, re-enable file upload tests on android", "committedDate": "2020-06-24T21:11:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE3NjI5OQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/818#discussion_r445176299", "bodyText": "Because our file upload notifications aren't comparable, the ConcurrentSkipListSet failed to work as a house for the received file upload notifications unless we provided a comparator in this test. The ConcurrentLinkedQueue did not require this, so I simplified our code by just using a ConcurrentLinkedQueue.", "author": "timtay-microsoft", "createdAt": "2020-06-24T21:15:51Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/FileUploadTests.java", "diffHunk": "@@ -87,46 +86,7 @@\n     protected static final String testProxyUser = \"proxyUsername\";\n     protected static final char[] testProxyPass = \"1234\".toCharArray();\n \n-    static Set<FileUploadNotification> activeFileUploadNotifications = new ConcurrentSkipListSet<>(new Comparator<FileUploadNotification>()\n-    {", "originalCommit": "1b1c88aed756b3d63d712af4c6e0cbe75a217af9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE3Njk0Nw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/818#discussion_r445176947", "bodyText": "Instead of running a thread in parallel to all the test methods to collect file upload notifications, now each test method just collects file upload notifications in their own thread. They still pool all the received notifications in the queue above so that if test method A receives a notification that test method B needs, test method B can still get it.", "author": "timtay-microsoft", "createdAt": "2020-06-24T21:17:15Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/FileUploadTests.java", "diffHunk": "@@ -87,46 +86,7 @@\n     protected static final String testProxyUser = \"proxyUsername\";\n     protected static final char[] testProxyPass = \"1234\".toCharArray();\n \n-    static Set<FileUploadNotification> activeFileUploadNotifications = new ConcurrentSkipListSet<>(new Comparator<FileUploadNotification>()\n-    {\n-        @Override\n-        public int compare(FileUploadNotification o1, FileUploadNotification o2) {\n-            if (!o1.getDeviceId().equals(o2.getDeviceId()))\n-            {\n-                return -1;\n-            }\n-\n-            if (!o1.getBlobName().equals(o2.getBlobName()))\n-            {\n-                return -1;\n-            }\n-\n-            if (!o1.getBlobSizeInBytes().equals(o2.getBlobSizeInBytes()))\n-            {\n-                return -1;\n-            }\n-\n-            if (!o1.getBlobUri().equals(o2.getBlobUri()))\n-            {\n-                return -1;\n-            }\n-\n-            if (!o1.getEnqueuedTimeUtcDate().equals(o2.getEnqueuedTimeUtcDate()))\n-            {\n-                return -1;\n-            }\n-\n-            if (!o1.getLastUpdatedTimeDate().equals(o2.getLastUpdatedTimeDate()))\n-            {\n-                return -1;\n-            }\n-\n-            return 0;\n-        }\n-    });\n-    static Thread fileUploadNotificationListenerThread;\n-    static AtomicBoolean hasFileUploadNotificationReceiverThreadFailed = new AtomicBoolean(false);\n-    static Exception fileUploadNotificationReceiverThreadException = null;", "originalCommit": "1b1c88aed756b3d63d712af4c6e0cbe75a217af9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE3NzMxMw==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/818#discussion_r445177313", "bodyText": "This separate thread was causing issues when running these tests on Android, so it had to go away anyways", "author": "timtay-microsoft", "createdAt": "2020-06-24T21:18:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTE3Njk0Nw=="}], "type": "inlineReview"}, {"oid": "bf6aca9b466fc91c4802b6a1984114d7bdef0b60", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/bf6aca9b466fc91c4802b6a1984114d7bdef0b60", "message": "squash", "committedDate": "2020-06-24T21:31:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNjYwMA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/818#discussion_r445206600", "bodyText": "has died from exception ... interesting :D", "author": "azabbasi", "createdAt": "2020-06-24T22:28:22Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/FileUploadTests.java", "diffHunk": "@@ -570,26 +467,18 @@ private FileUploadNotification getFileUploadNotificationForThisDevice(DeviceClie\n                 }\n             }\n \n-            if (System.currentTimeMillis() - startTime > MAXIMUM_TIME_TO_WAIT_FOR_IOTHUB)\n+            FileUploadNotification fileUploadNotification = testInstance.fileUploadNotificationReceiver.receive(FILE_UPLOAD_QUEUE_POLLING_INTERVAL_MILLISECONDS);\n+\n+            if (fileUploadNotification != null)\n             {\n-                Assert.fail(CorrelationDetailsLoggingAssert.buildExceptionMessage(\"Timed out waiting for file upload notification for device\", deviceClient));\n+                activeFileUploadNotifications.add(fileUploadNotification);\n             }\n \n-            //If the notification polling thread has died, the test cannot complete\n-            if (hasFileUploadNotificationReceiverThreadFailed.get())\n+            if (System.currentTimeMillis() - startTime > MAXIMUM_TIME_TO_WAIT_FOR_IOTHUB_MILLISECONDS)\n             {\n-                if (fileUploadNotificationReceiverThreadException != null)\n-                {\n-                    Assert.fail(CorrelationDetailsLoggingAssert.buildExceptionMessage(\"File upload notification listener thread has died from exception \" + Tools.getStackTraceFromThrowable(fileUploadNotificationReceiverThreadException), deviceClient));", "originalCommit": "bf6aca9b466fc91c4802b6a1984114d7bdef0b60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNzAyMg==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/818#discussion_r445207022", "bodyText": "() -> !! and I thought I have seen it all :D", "author": "azabbasi", "createdAt": "2020-06-24T22:29:33Z", "path": "iot-e2e-tests/common/src/test/java/tests/integration/com/microsoft/azure/sdk/iot/iothub/FileUploadTests.java", "diffHunk": "@@ -508,19 +409,15 @@ public void uploadToBlobAsyncMultipleFilesParallel() throws URISyntaxException,\n         for (int i = 1; i < MAX_FILES_TO_UPLOAD; i++)\n         {\n             final int index = i;\n-            executor.submit(new Runnable()\n+            executor.submit(() ->", "originalCommit": "bf6aca9b466fc91c4802b6a1984114d7bdef0b60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNzI2MA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/818#discussion_r445207260", "bodyText": "Pretty fancy stuff, yeah!", "author": "timtay-microsoft", "createdAt": "2020-06-24T22:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIwNzAyMg=="}], "type": "inlineReview"}]}