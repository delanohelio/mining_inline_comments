{"pr_number": 960, "pr_title": "refactor(samples): Refactor Pnp helper code for device samples", "pr_createdAt": "2020-10-06T00:13:46Z", "pr_url": "https://github.com/Azure/azure-iot-sdk-java/pull/960", "timeline": [{"oid": "48af488cef2f1e7da9c7f20e16a7d27e4ca40147", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/48af488cef2f1e7da9c7f20e16a7d27e4ca40147", "message": "refactor pnp samples", "committedDate": "2020-10-06T00:06:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTkzOTgyOA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r499939828", "bodyText": "Note: no need to have CreatePropertyPatch taking hashmap since sendReportedProperties already takes a Set and is easy to directly use that.\nSet reportProperties = new HashSet()\n{\n{\nadd(new Property(\"prop1\", 70));\nadd(new Property(\"prop2\", \"value\"));\n}\n};", "author": "bikamani", "createdAt": "2020-10-06T00:17:49Z", "path": "device/iot-device-samples/pnp-device-sample/temperature-controller-device-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/device/PnpConvention.java", "diffHunk": "@@ -92,18 +105,39 @@ public static Message createIotHubMessageUtf8(@NonNull String telemetryName, @No\n      *     }\n      * }\n      */\n-    public static Set<Property> createPropertyPatch(@NonNull final String propertyName, @NonNull final Object propertyValue, String componentName) {\n+    public static Set<Property> createComponentPropertyPatch(@NonNull final String propertyName, @NonNull final Object propertyValue, @NonNull String componentName) {\n+\n+        return createComponentPropertyPatch(componentName, new HashMap<String, Object>()\n+        {{\n+            put(propertyName, propertyValue);\n+        }});\n+    }\n+", "originalCommit": "48af488cef2f1e7da9c7f20e16a7d27e4ca40147", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4MDE5MQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r500080191", "bodyText": "he -> the", "author": "barustum", "createdAt": "2020-10-06T08:02:05Z", "path": "device/iot-device-samples/pnp-device-sample/temperature-controller-device-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/device/PnpConvention.java", "diffHunk": "@@ -49,7 +50,21 @@ public static Message createIotHubMessageUtf8(@NonNull String telemetryName, @No\n     public static Message createIotHubMessageUtf8(@NonNull String telemetryName, @NonNull Object telemetryValue, String componentName) {\n         Map<String, Object> payload = singletonMap(telemetryName, telemetryValue);\n \n-        Message message = new Message(gson.toJson(payload));\n+        return createIotHubMessageUtf8(new HashMap<String, Object>()\n+        {{\n+            put(telemetryName, telemetryValue);\n+        }}, componentName);\n+    }\n+\n+    /**\n+     * Create a plug and play compatible telemetry message.\n+     * @param telemetryPairs he unserialized name and value telemetry pairs, as defined in the DTDL interface. Names must be 64 characters or less. For more details see", "originalCommit": "48af488cef2f1e7da9c7f20e16a7d27e4ca40147", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4MjE4NQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r500082185", "bodyText": "this says componentName is optional, and can be null. Yet the argument is decorated with \"NonNull\". Doesn't that make componentName required?", "author": "barustum", "createdAt": "2020-10-06T08:05:28Z", "path": "device/iot-device-samples/pnp-device-sample/temperature-controller-device-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/device/PnpConvention.java", "diffHunk": "@@ -92,18 +105,39 @@ public static Message createIotHubMessageUtf8(@NonNull String telemetryName, @No\n      *     }\n      * }\n      */\n-    public static Set<Property> createPropertyPatch(@NonNull final String propertyName, @NonNull final Object propertyValue, String componentName) {\n+    public static Set<Property> createComponentPropertyPatch(@NonNull final String propertyName, @NonNull final Object propertyValue, @NonNull String componentName) {\n+\n+        return createComponentPropertyPatch(componentName, new HashMap<String, Object>()\n+        {{\n+            put(propertyName, propertyValue);\n+        }});\n+    }\n+\n+    /**\n+     * Create a key-value property patch for both read-only and read-write properties.\n+     * @param propertyKeyValuePairs The property name and an unserialized value, as defined in the DTDL interface.\n+     * @param componentName (optional) The name of the component in which the property is defined. Can be null for property defined under the root interface.", "originalCommit": "48af488cef2f1e7da9c7f20e16a7d27e4ca40147", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMDAwNQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r500430005", "bodyText": "Good observation, will modify comment", "author": "bikamani", "createdAt": "2020-10-06T16:20:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4MjE4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4NDEwNA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r500084104", "bodyText": "since ackDescription is not null and is not empty, shouldn't this line include the ackDescription, as such:\nresponse.add(new Property(k, new WritablePropertyResponse(v, ackCode, ackVersion, ackDescription)));\nand line 209 without the ackDescription?", "author": "barustum", "createdAt": "2020-10-06T08:08:42Z", "path": "device/iot-device-samples/pnp-device-sample/temperature-controller-device-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/device/PnpConvention.java", "diffHunk": "@@ -121,29 +155,66 @@ public static Message createIotHubMessageUtf8(@NonNull String telemetryName, @No\n      *     }\n      * }\n      */\n-    public static Set<Property> createPropertyEmbeddedValuePatch(\n+    public static Set<Property> createWritablePropertyResponse(\n             @NonNull String propertyName,\n             @NonNull final Object propertyValue,\n             @NonNull final Integer ackCode,\n             @NonNull final Long ackVersion,\n             String ackDescription) {\n \n-        Map<String, Object> embeddedProperty = new HashMap<String, Object>() {{\n-            put(\"value\", propertyValue);\n-            put(\"ac\", ackCode);\n-            put(\"av\", ackVersion);\n-        }};\n+        return createWritablePropertyResponse(new HashMap<String, Object>()\n+        {{\n+            put(propertyName, propertyValue);\n+        }}, ackCode, ackVersion, ackDescription);\n+    }\n \n-        if (ackDescription != null && !ackDescription.isEmpty()) {\n-            embeddedProperty.put(\"ad\", ackDescription);\n-        }\n+    /**\n+     * Creates a response to a write request on a device property.\n+     * @param propertyPairs The name and unserialized value of the property to report.\n+     * @param ackCode The acknowledgment code from the device, for the embedded value property update.\n+     * @param ackVersion The version no. of the service-initiated read-write property update.\n+     * @param ackDescription (optional) The description from the device, accompanying the embedded value property update.\n+     * @return The property patch for embedded value property updates for read-write properties.\n+     *\n+     * The property patch is created in the below format:\n+     * {\n+     *     \"samplePropertyName\": {\n+     *         \"value\": 20,\n+     *         \"ac\": 200,\n+     *         \"av\": 5,\n+     *         \"ad\": \"The update was successful.\"\n+     *     }\n+     * }\n+     */\n+    public static Set<Property> createWritablePropertyResponse(\n+            @NonNull HashMap<String, Object> propertyPairs,\n+            @NonNull final Integer ackCode,\n+            @NonNull final Long ackVersion,\n+            String ackDescription) {\n+\n+        Set<Property> response = new HashSet<>();\n+\n+        propertyPairs.forEach((k,v) ->\n+            {\n+                if(k == null || k.isEmpty())\n+                {\n+                    throw new IllegalArgumentException(\"One of the propertyPairs keys was null, empty, or white space.\");\n+                }\n \n-        return singleton(new Property(propertyName, embeddedProperty));\n+                if (ackDescription != null && !ackDescription.isEmpty()) {\n+                    response.add(new Property(k, new WritablePropertyResponse(v, ackCode, ackVersion)));", "originalCommit": "48af488cef2f1e7da9c7f20e16a7d27e4ca40147", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMDMwOQ==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r500430309", "bodyText": "agreed will change", "author": "bikamani", "createdAt": "2020-10-06T16:21:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4NDEwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4NDYyOA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r500084628", "bodyText": "is componentName still considered optional since you added the NonNull?", "author": "barustum", "createdAt": "2020-10-06T08:09:36Z", "path": "device/iot-device-samples/pnp-device-sample/temperature-controller-device-sample/src/main/java/samples/com/microsoft/azure/sdk/iot/device/PnpConvention.java", "diffHunk": "@@ -121,29 +155,66 @@ public static Message createIotHubMessageUtf8(@NonNull String telemetryName, @No\n      *     }\n      * }\n      */\n-    public static Set<Property> createPropertyEmbeddedValuePatch(\n+    public static Set<Property> createWritablePropertyResponse(\n             @NonNull String propertyName,\n             @NonNull final Object propertyValue,\n             @NonNull final Integer ackCode,\n             @NonNull final Long ackVersion,\n             String ackDescription) {\n \n-        Map<String, Object> embeddedProperty = new HashMap<String, Object>() {{\n-            put(\"value\", propertyValue);\n-            put(\"ac\", ackCode);\n-            put(\"av\", ackVersion);\n-        }};\n+        return createWritablePropertyResponse(new HashMap<String, Object>()\n+        {{\n+            put(propertyName, propertyValue);\n+        }}, ackCode, ackVersion, ackDescription);\n+    }\n \n-        if (ackDescription != null && !ackDescription.isEmpty()) {\n-            embeddedProperty.put(\"ad\", ackDescription);\n-        }\n+    /**\n+     * Creates a response to a write request on a device property.\n+     * @param propertyPairs The name and unserialized value of the property to report.\n+     * @param ackCode The acknowledgment code from the device, for the embedded value property update.\n+     * @param ackVersion The version no. of the service-initiated read-write property update.\n+     * @param ackDescription (optional) The description from the device, accompanying the embedded value property update.\n+     * @return The property patch for embedded value property updates for read-write properties.\n+     *\n+     * The property patch is created in the below format:\n+     * {\n+     *     \"samplePropertyName\": {\n+     *         \"value\": 20,\n+     *         \"ac\": 200,\n+     *         \"av\": 5,\n+     *         \"ad\": \"The update was successful.\"\n+     *     }\n+     * }\n+     */\n+    public static Set<Property> createWritablePropertyResponse(\n+            @NonNull HashMap<String, Object> propertyPairs,\n+            @NonNull final Integer ackCode,\n+            @NonNull final Long ackVersion,\n+            String ackDescription) {\n+\n+        Set<Property> response = new HashSet<>();\n+\n+        propertyPairs.forEach((k,v) ->\n+            {\n+                if(k == null || k.isEmpty())\n+                {\n+                    throw new IllegalArgumentException(\"One of the propertyPairs keys was null, empty, or white space.\");\n+                }\n \n-        return singleton(new Property(propertyName, embeddedProperty));\n+                if (ackDescription != null && !ackDescription.isEmpty()) {\n+                    response.add(new Property(k, new WritablePropertyResponse(v, ackCode, ackVersion)));\n+                }\n+                else\n+                {\n+                    response.add(new Property(k, new WritablePropertyResponse(v, ackCode, ackVersion, ackDescription)));\n+                }\n+            });\n+\n+        return response;\n     }\n \n     /**\n-     * Create a key-embedded value property patch for read-write properties.\n-     * Embedded value property updates are sent from a device in response to a service-initiated read-write property update.\n+     * Creates a response to a write request on a device property.\n      * @param propertyName The property name, as defined in the DTDL interface.\n      * @param propertyValue The property value, in the format defined in the DTDL interface.\n      * @param componentName (optional) The name of the component in which the property is defined. Can be null for property defined under the root interface.", "originalCommit": "48af488cef2f1e7da9c7f20e16a7d27e4ca40147", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMDU0NA==", "url": "https://github.com/Azure/azure-iot-sdk-java/pull/960#discussion_r500430544", "bodyText": "will address this", "author": "bikamani", "createdAt": "2020-10-06T16:21:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDA4NDYyOA=="}], "type": "inlineReview"}, {"oid": "b0f81cbee45c4497e727dcaf89fe270a7b596e4b", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/b0f81cbee45c4497e727dcaf89fe270a7b596e4b", "message": "address code review comments", "committedDate": "2020-10-06T18:31:06Z", "type": "commit"}, {"oid": "ffcfc01e2c7cba55361b53826efd70815f054ec1", "url": "https://github.com/Azure/azure-iot-sdk-java/commit/ffcfc01e2c7cba55361b53826efd70815f054ec1", "message": "update nonnull description", "committedDate": "2020-10-06T18:33:58Z", "type": "commit"}]}