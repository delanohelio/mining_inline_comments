{"pr_number": 929, "pr_title": "PHOENIX-6083 View index creation does a checkAndPut on an incorrect r\u2026", "pr_createdAt": "2020-10-19T13:32:05Z", "pr_url": "https://github.com/apache/phoenix/pull/929", "timeline": [{"oid": "082371196d9ee4b6a567d1c25f540ef1d6e8f900", "url": "https://github.com/apache/phoenix/commit/082371196d9ee4b6a567d1c25f540ef1d6e8f900", "message": "PHOENIX-6083 View index creation does a checkAndPut on an incorrect row key", "committedDate": "2020-10-19T16:28:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyMjUyMw==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r507922523", "bodyText": "nit: try-with-resources for the connection", "author": "ChinmaySKulkarni", "createdAt": "2020-10-19T17:21:16Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/index/ViewIndexIT.java", "diffHunk": "@@ -169,10 +171,67 @@ public void testDeleteViewIndexSequences() throws Exception {\n         verifySequenceValue(null, sequenceName, sequenceSchemaName, Short.MIN_VALUE + 2);\n         conn1.createStatement().execute(\"DROP VIEW \" + fullViewName);\n         conn1.createStatement().execute(\"DROP TABLE \"+ fullTableName);\n-        \n+\n         verifySequenceNotExists(null, sequenceName, sequenceSchemaName);\n     }\n-    \n+\n+    @Test\n+    public void testDroppingColumnWhileCreatingIndex2() throws Exception {\n+        String schemaName = \"S1\";\n+        String tableName = generateUniqueName();\n+        String viewSchemaName = \"S1\";\n+        String fullTableName = SchemaUtil.getTableName(schemaName, tableName);\n+        String indexName = \"IND_\" + generateUniqueName();\n+        String viewName = \"VIEW_\" + generateUniqueName();\n+        String fullViewName = SchemaUtil.getTableName(viewSchemaName, viewName);\n+\n+        createBaseTable(schemaName, tableName, false, null, null, true);\n+        Connection conn = getConnection();", "originalCommit": "082371196d9ee4b6a567d1c25f540ef1d6e8f900", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyMzIyNg==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r507923226", "bodyText": "nit: Can we store and hence later assert the SQLException code rather than the exception message?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-19T17:22:29Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/index/ViewIndexIT.java", "diffHunk": "@@ -169,10 +171,67 @@ public void testDeleteViewIndexSequences() throws Exception {\n         verifySequenceValue(null, sequenceName, sequenceSchemaName, Short.MIN_VALUE + 2);\n         conn1.createStatement().execute(\"DROP VIEW \" + fullViewName);\n         conn1.createStatement().execute(\"DROP TABLE \"+ fullTableName);\n-        \n+\n         verifySequenceNotExists(null, sequenceName, sequenceSchemaName);\n     }\n-    \n+\n+    @Test\n+    public void testDroppingColumnWhileCreatingIndex2() throws Exception {\n+        String schemaName = \"S1\";\n+        String tableName = generateUniqueName();\n+        String viewSchemaName = \"S1\";\n+        String fullTableName = SchemaUtil.getTableName(schemaName, tableName);\n+        String indexName = \"IND_\" + generateUniqueName();\n+        String viewName = \"VIEW_\" + generateUniqueName();\n+        String fullViewName = SchemaUtil.getTableName(viewSchemaName, viewName);\n+\n+        createBaseTable(schemaName, tableName, false, null, null, true);\n+        Connection conn = getConnection();\n+        conn.setAutoCommit(true);\n+        conn.createStatement().execute(\"CREATE VIEW \" + fullViewName + \" AS SELECT * FROM \" + fullTableName);\n+        conn.commit();\n+\n+        final String[] failedMsg = new String[1];\n+        final CountDownLatch doneSignal = new CountDownLatch(2);\n+        Runnable r1 = new Runnable() {\n+\n+            @Override public void run() {\n+                try {\n+                    conn.createStatement().execute(\"CREATE INDEX \" + indexName + \" ON \" + fullViewName + \" (v1)\");\n+                } catch (SQLException e) {\n+                    failedMsg[0] = e.getMessage();", "originalCommit": "082371196d9ee4b6a567d1c25f540ef1d6e8f900", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyNjYzNg==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r507926636", "bodyText": "Good to either extract this out as a SchemaUtil API and/or add a comment here. Is there some existing API which makes the indexed column name have a ':' instead of '.'?", "author": "ChinmaySKulkarni", "createdAt": "2020-10-19T17:28:08Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/schema/MetaDataClient.java", "diffHunk": "@@ -1689,12 +1689,13 @@ public MutationState createIndex(CreateIndexStatement statement, byte[][] splits\n                 for (ColumnName colName : requiredCols) {\n                     // acquire the mutex using the global physical table name to\n                     // prevent this column from being dropped while the index is being created\n+                    String colNameSeparatedByDot = colName.getColumnName().replace(':', '.');", "originalCommit": "082371196d9ee4b6a567d1c25f540ef1d6e8f900", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "64d4b741ad5161bdf594d1c8e5b037ca7c301b6c", "url": "https://github.com/apache/phoenix/commit/64d4b741ad5161bdf594d1c8e5b037ca7c301b6c", "message": "minor fixes acording to review", "committedDate": "2020-10-30T15:24:17Z", "type": "forcePushed"}, {"oid": "2a0ddfa952cdc572005aa943790ea80cfdac344c", "url": "https://github.com/apache/phoenix/commit/2a0ddfa952cdc572005aa943790ea80cfdac344c", "message": "PHOENIX-6083 View index creation does a checkAndPut on an incorrect row key", "committedDate": "2020-11-02T15:44:07Z", "type": "forcePushed"}, {"oid": "8ef65ee01c36685ae9d993775eeae1eacb4398a9", "url": "https://github.com/apache/phoenix/commit/8ef65ee01c36685ae9d993775eeae1eacb4398a9", "message": "PHOENIX-6083 View index creation does a checkAndPut on an incorrect row key", "committedDate": "2020-11-02T17:07:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc4Nzc1Nw==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r516787757", "bodyText": "This seem preferred way based on existing usages:\nString colNameSeparatedByDot = colName.getColumnName().replace(QueryConstants.NAMESPACE_SEPARATOR, QueryConstants.NAME_SEPARATOR)", "author": "virajjasani", "createdAt": "2020-11-03T16:15:34Z", "path": "phoenix-core/src/main/java/org/apache/phoenix/schema/MetaDataClient.java", "diffHunk": "@@ -1685,12 +1685,16 @@ public MutationState createIndex(CreateIndexStatement statement, byte[][] splits\n                 for (ColumnName colName : requiredCols) {\n                     // acquire the mutex using the global physical table name to\n                     // prevent this column from being dropped while the view is being created\n+                    String colNameSeparatedByDot = SchemaUtil\n+                            .replaceColonToDot(colName.getColumnName());", "originalCommit": "8ef65ee01c36685ae9d993775eeae1eacb4398a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxMTk4Mg==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r516811982", "bodyText": "Okey I'll use it, Thanks", "author": "richardantal", "createdAt": "2020-11-03T16:49:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc4Nzc1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc5NzMwOA==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r516797308", "bodyText": "Not a strong opinion but since we want threads to mutate exceptionCode, maybe we can use AtomicInteger for exceptionCode rather than array with size 1, threads can set values and finally we can assert with assertEquals(exceptionCode.get(), 301) if you would prefer :)", "author": "virajjasani", "createdAt": "2020-11-03T16:29:05Z", "path": "phoenix-core/src/it/java/org/apache/phoenix/end2end/index/ViewIndexIT.java", "diffHunk": "@@ -280,6 +282,64 @@ public void testCoprocsOnGlobalNonMTImmutableViewIndex() throws Exception {\n         testCoprocsOnGlobalViewIndexHelper(false, false);\n     }\n \n+    @Test\n+    public void testDroppingColumnWhileCreatingIndex() throws Exception {\n+        String schemaName = \"S1\";\n+        String tableName = generateUniqueName();\n+        String viewSchemaName = \"S1\";\n+        String fullTableName = SchemaUtil.getTableName(schemaName, tableName);\n+        String indexName = \"IND_\" + generateUniqueName();\n+        String viewName = \"VIEW_\" + generateUniqueName();\n+        String fullViewName = SchemaUtil.getTableName(viewSchemaName, viewName);\n+\n+        createBaseTable(schemaName, tableName, false, null, null, true);\n+        try (Connection conn = getConnection()) {\n+            conn.setAutoCommit(true);\n+            conn.createStatement().execute(\"CREATE VIEW \" + fullViewName + \" AS SELECT * FROM \" + fullTableName);\n+            conn.commit();\n+\n+            final int[] exceptionCode = new int[1];", "originalCommit": "8ef65ee01c36685ae9d993775eeae1eacb4398a9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjgxNTEwOA==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r516815108", "bodyText": "exceptionCode is accessed from an inner class so has to be final, in order to be able to change its value from the other thread it has to be an array.\nWe can use AtomicInteger array but I am not sure if it adds any value.", "author": "richardantal", "createdAt": "2020-11-03T16:54:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc5NzMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MDk1OQ==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r516840959", "bodyText": "I meant AtomicInteger as mutable final object similar to an array.\ne.g\n            final AtomicInteger exceptionCode = new AtomicInteger();\n\n\n&\n                    } catch (SQLException e) {\n                        exceptionCode.set(e.getErrorCode());\n                        throw new RuntimeException(e);\n                    } finally {\n                        doneSignal.countDown();\n                    }\n\n&\n            assertEquals(exceptionCode.get(), 301);\n\nThought?", "author": "virajjasani", "createdAt": "2020-11-03T17:33:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc5NzMwOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1MzM2NQ==", "url": "https://github.com/apache/phoenix/pull/929#discussion_r516853365", "bodyText": "Yeah I think this a better solution. Nice one :)\nThanks for the review @virajjasani I have updated the commit.", "author": "richardantal", "createdAt": "2020-11-03T17:54:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjc5NzMwOA=="}], "type": "inlineReview"}, {"oid": "291d4d55bdbf2f19ff1fceb71339333f55cbfcf0", "url": "https://github.com/apache/phoenix/commit/291d4d55bdbf2f19ff1fceb71339333f55cbfcf0", "message": "PHOENIX-6083 View index creation does a checkAndPut on an incorrect row key", "committedDate": "2020-11-03T16:48:38Z", "type": "forcePushed"}, {"oid": "d1403cce349d696ea53f86466408d9982a6aef2c", "url": "https://github.com/apache/phoenix/commit/d1403cce349d696ea53f86466408d9982a6aef2c", "message": "PHOENIX-6083 View index creation does a checkAndPut on an incorrect row key", "committedDate": "2020-11-03T17:51:42Z", "type": "commit"}, {"oid": "d1403cce349d696ea53f86466408d9982a6aef2c", "url": "https://github.com/apache/phoenix/commit/d1403cce349d696ea53f86466408d9982a6aef2c", "message": "PHOENIX-6083 View index creation does a checkAndPut on an incorrect row key", "committedDate": "2020-11-03T17:51:42Z", "type": "forcePushed"}]}