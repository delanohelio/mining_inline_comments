{"pr_number": 476, "pr_title": "[aws-datastore] Additional logging", "pr_createdAt": "2020-05-16T22:45:13Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/476", "timeline": [{"oid": "a47f5898d8bc5e134d43897392ebe993999a7443", "url": "https://github.com/aws-amplify/amplify-android/commit/a47f5898d8bc5e134d43897392ebe993999a7443", "message": "[aws-datastore] Additional logging\n\nAdds more detailed logging about the system state.\n\nChanges some existing logs to verbose, which is not printed in\nproduction, by defualt.\n\nGeneral strategy is to log lifecycle events at INFO (visible to\nproduction), recoverable failures as WARN. Everything else as VERBOSE.", "committedDate": "2020-05-16T22:36:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODYxNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198615", "bodyText": "removed", "author": "jpignata", "createdAt": "2020-05-16T23:01:17Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationOutbox.java", "diffHunk": "@@ -150,19 +147,20 @@\n      */\n     @NonNull\n     <T extends Model> Completable remove(PendingMutation<T> pendingMutation) {\n-        // defer() creation of the Completable until someone subscribe()s via remove() method.\n-        // At that time, create() a Completable that wraps a call to LocalStorageAdapter#delete(...).\n-        return Completable.defer(() -> Completable.create(subscriber -> {\n-            // Convert the PendingMutation into a Record\n-            PendingMutation.PersistentRecord record = converter.toRecord(pendingMutation);\n-            // Delete it.\n+        return Completable.defer(() -> Completable.create(subscriber ->\n             storage.delete(\n-                record,\n+                converter.toRecord(pendingMutation),\n                 StorageItemChange.Initiator.SYNC_ENGINE,\n-                ignored -> subscriber.onComplete(),\n-                subscriber::onError\n-            );\n-        }));\n+                deletionResult -> {\n+                    LOG.verbose(\"Successfully remove pending mutation from mutation outbox: \" + pendingMutation);", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNTg4Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426205887", "bodyText": "Thanks! fixed", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODY1NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198655", "bodyText": "Can some details about the error also be logged?", "author": "jpignata", "createdAt": "2020-05-16T23:02:17Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -77,22 +76,24 @@\n             // Update the metadata for it\n             .andThen(save(metadata))\n             // Let the world know that we've done a good thing.\n-            .andThen(announceSuccessfulMerge(modelWithMetadata));\n+            .doOnComplete(() -> {\n+                announceSuccessfulMerge(modelWithMetadata);\n+                LOG.verbose(\"Remote model update was sync'd down into local storage: \" + modelWithMetadata);\n+            })\n+            .doOnError(failure ->\n+                LOG.warn(\"Failed to sync remote model into local storage: \" + modelWithMetadata)", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNTkyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426205923", "bodyText": "Whoops, appended , failure into the log statement.", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:16:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODY1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODY4NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198684", "bodyText": "\ud83d\udc4d Noise-ish.", "author": "jpignata", "createdAt": "2020-05-16T23:02:39Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/model/ModelHelper.java", "diffHunk": "@@ -55,7 +55,7 @@ private ModelHelper() {\n             final Method fieldGetter = modelClass.getMethod(getterName);\n             return fieldGetter.invoke(model);\n         } catch (Exception exception) {\n-            LOGGER.warn(String.format(", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODc5Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198793", "bodyText": "Since we're doing two things now, is it worth just inlining? Or is this used elsewhere? If it is, any downside to hoisting the log statement out of it?", "author": "jpignata", "createdAt": "2020-05-16T23:04:54Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Merger.java", "diffHunk": "@@ -77,22 +76,24 @@\n             // Update the metadata for it\n             .andThen(save(metadata))\n             // Let the world know that we've done a good thing.\n-            .andThen(announceSuccessfulMerge(modelWithMetadata));\n+            .doOnComplete(() -> {\n+                announceSuccessfulMerge(modelWithMetadata);", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjA1Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206056", "bodyText": "If I understand your meaning -- do you mean:\n            .doOnComplete(() -> {\n                announceSuccessfulMerge(modelWithMetadata);\n                LOG.verbose(\"Remote model update was sync'd down into local storage: \" + modelWithMetadata);\n            })\n            .doOnError(failure ->\n                LOG.warn(\"Failed to sync remote model into local storage: \" + modelWithMetadata)\n            );\n\nvs.\n            .doOnComplete(() -> announceSuccessfulMerge(modelWithMetadata))\n            .doOnError(failure -> LOG.warn(\"Failed to sync remote model into local storage: \" + modelWithMetadata));\n\nWith the first log moved into announceSuccessfulMerge?\nThe announceSuccessfulMerge published a Hub event, which is a unique path. But I wanted to keep the logging for success/failure close to each other to keep the either-or relationship clear, and nearby in the code.", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:19:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODc5Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODk3Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426198972", "bodyText": "Sorry, I can't help it.", "author": "jpignata", "createdAt": "2020-05-16T23:07:44Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -72,8 +71,11 @@\n      * it again later, when network conditions become favorable again.\n      */\n     void startDrainingMutationOutbox() {\n-        disposable.add(\n+        ongoingOperationsDispoable.add(\n             mutationOutbox.observe()\n+                .doOnSubscribe(disposable ->\n+                    LOG.info(\"Started processing the mutation outbox. Pending mutations will be published to cloud.\")", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjE0NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206144", "bodyText": "Haha -- what is this guy's name again?\nFixed, to \"the cloud\". :-D", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:20:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjg4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206880", "bodyText": "I believe that\u2019s Mr. McGibblets.", "author": "jpignata", "createdAt": "2020-05-17T01:33:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxMDcxMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426210710", "bodyText": "Right!!! McGibblets :-)", "author": "jamesonwilliams", "createdAt": "2020-05-17T02:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5ODk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTAwNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199007", "bodyText": "Do we usually indent string concatenation additional lines? Thought I saw that in other PRs.", "author": "jpignata", "createdAt": "2020-05-16T23:08:20Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -97,10 +99,14 @@ void startDrainingMutationOutbox() {\n             .flatMapCompletable(merger::merge)\n             // Lastly, remove the item from the outbox, so we don't process it again.\n             .andThen(mutationOutbox.remove(mutationOutboxItem))\n-            .andThen(Completable.fromAction(() -> {\n-                LOG.info(\"Pending mutation was published up to Cloud: \" + mutationOutboxItem);\n+            .doOnComplete(() -> {\n+                LOG.verbose(\n+                    \"Pending mutation was published to cloud successfully, \" +\n+                    \"and removed from the mutation outbox: \" + mutationOutboxItem", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjE4NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206185", "bodyText": "Probably should. I'll do it, here.", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:21:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTAwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTA1OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199058", "bodyText": "I've found this recovery suggestion dubious thus far (though I don't have a suggestion here).", "author": "jpignata", "createdAt": "2020-05-16T23:09:34Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -179,24 +187,25 @@ void stopDrainingMutationOutbox() {\n      */\n     private <T extends Model> Single<ModelWithMetadata<T>> publishWithStrategy(\n             PendingMutation<T> mutation, PublicationStrategy<T> publicationStrategy) {\n-        return Single.defer(() -> Single.create(subscriber -> {\n+        T mutatedItem = mutation.getMutatedItem();\n+        String modelClassName = mutation.getClassOfMutatedItem().getSimpleName();\n+        return Single.defer(() -> Single.create(subscriber ->\n             publicationStrategy.publish(\n-                mutation.getMutatedItem(),\n+                mutatedItem,\n                 result -> {\n                     if (!result.hasErrors() && result.hasData()) {\n                         subscriber.onSuccess(result.getData());\n                         return;\n                     }\n-                    String modelName = mutation.getClassOfMutatedItem().getSimpleName();\n                     subscriber.onError(new DataStoreException(\n                         \"Mutation failed. Failed mutation = \" + mutation + \". \" +\n                             \"AppSync response contained errors = \" + result.getErrors(),\n-                        \"Verify that your AppSync endpoint is able to store \" + modelName + \" models.\"\n+                        \"Verify that your AppSync endpoint is able to store \" + modelClassName + \" models.\"", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjIzNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206234", "bodyText": "I'm not sold on the recovery suggestion thing, overall, honestly. We're either not trying hard enough, or, it was a well-intentioned idea that doesn't make sense in practice.", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:22:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTA1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjY2MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206661", "bodyText": "I\u2019ve always liked the idea of exceptions that lead to wiki pages that explained what happened with links to code, and where people can document issues, workarounds, gotchas. Maybe one day. :-)", "author": "jpignata", "createdAt": "2020-05-17T01:30:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTExNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199117", "bodyText": "Assume you'll update this prior to merging, just a flag to remind you.", "author": "jpignata", "createdAt": "2020-05-16T23:10:11Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -35,6 +37,8 @@\n  * and {@link AppSync}.\n  */\n public final class Orchestrator {\n+    private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjMwNA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206304", "bodyText": "To the forCategory factory? Yea, I did the two PRs as siblings, I'll have to update whichever one goes in second.", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTExNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTE4Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199182", "bodyText": "Formatting seems a little off.", "author": "jpignata", "createdAt": "2020-05-16T23:11:26Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -115,14 +125,13 @@ void startSubscriptions() {\n             ));\n             latch.await(SUBSCRIPTION_START_TIMEOUT_MS, TimeUnit.MILLISECONDS);\n         })\n-        .doOnError(exception -> {\n-            LOG.warn(\"An error occurred with one of the subscriptions to the remote DataStore for \" +\n-                \"model \" + clazz.getSimpleName() + \" \" + subscriptionType.name(),\n-                exception.getCause());\n-        })\n-        .onErrorResumeNext(next -> {\n-            next.onComplete();\n-        })\n+        .doOnError(subscriptionError ->\n+            LOG.warn(String.format(Locale.US,", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjQ2OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206468", "bodyText": "Fixed", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:25:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTE4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTM1MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426199351", "bodyText": "Same here - can we get some detailed logged or are they logged elsewhere?", "author": "jpignata", "createdAt": "2020-05-16T23:14:26Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -161,11 +164,15 @@ private SyncTime filterOutOldSyncTimes(SyncTime lastSyncTime) throws DataStoreEx\n     private <T extends Model> Single<Iterable<ModelWithMetadata<T>>> syncModel(\n             Class<T> modelClass, SyncTime syncTime) {\n         final Long lastSyncTimeAsLong = syncTime.exists() ? syncTime.toLong() : null;\n-        return Single.create(emitter -> {\n+        return Single.<Iterable<ModelWithMetadata<T>>>create(emitter -> {\n             final Cancelable cancelable =\n                 appSync.sync(modelClass, lastSyncTimeAsLong, metadataEmitter(emitter), emitter::onError);\n             emitter.setDisposable(asDisposable(cancelable));\n-        });\n+        }).doOnSuccess(results ->\n+            LOG.verbose(\"Successfully sync'd down cloud state for model type = \" + modelClass.getSimpleName())\n+        ).doOnError(failureToSync ->", "originalCommit": "a47f5898d8bc5e134d43897392ebe993999a7443", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIwNjUyNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426206525", "bodyText": "Updated to:\nLOG.warn(\"blah blah\", failureToSync);", "author": "jamesonwilliams", "createdAt": "2020-05-17T01:27:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjE5OTM1MQ=="}], "type": "inlineReview"}, {"oid": "4210af30dbc2ade550ef3f4ca163a0b5361baeed", "url": "https://github.com/aws-amplify/amplify-android/commit/4210af30dbc2ade550ef3f4ca163a0b5361baeed", "message": "Address PR feedback from jpignata", "committedDate": "2020-05-17T01:30:49Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxMDc1NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426210755", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final CompositeDisposable ongoingOperationsDispoable;\n          \n          \n            \n                private final CompositeDisposable ongoingOperationsDisposable;", "author": "rjuliano", "createdAt": "2020-05-17T02:46:42Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -41,15 +41,14 @@\n  * {@link AppSync}. The responses to these mutations are themselves forwarded to the Merger,\n  * which may again modify the store.\n  */\n-@SuppressWarnings(\"CodeBlock2Expr\")\n final class MutationProcessor {\n     private static final Logger LOG = Amplify.Logging.forNamespace(\"amplify:aws-datastore\");\n \n     private final VersionRepository versionRepository;\n     private final Merger merger;\n     private final AppSync appSync;\n     private final MutationOutbox mutationOutbox;\n-    private final CompositeDisposable disposable;\n+    private final CompositeDisposable ongoingOperationsDispoable;", "originalCommit": "4210af30dbc2ade550ef3f4ca163a0b5361baeed", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxNDAyMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426214022", "bodyText": "Lol, when I was in my twenties, and the older engineers would make typos all over the place, I'd look at it, and be like \"what is up with these guys?\" I understand it, now. It's a combination of tired eyes, tired hands, and too much to write. haha\nAnyway, thanks! Will update.", "author": "jamesonwilliams", "createdAt": "2020-05-17T03:49:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxMDc1NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjIxMDc5NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/476#discussion_r426210794", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ongoingOperationsDispoable.add(\n          \n          \n            \n                    ongoingOperationsDisposable.add(", "author": "rjuliano", "createdAt": "2020-05-17T02:47:26Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/MutationProcessor.java", "diffHunk": "@@ -72,8 +71,14 @@\n      * it again later, when network conditions become favorable again.\n      */\n     void startDrainingMutationOutbox() {\n-        disposable.add(\n+        ongoingOperationsDispoable.add(", "originalCommit": "4210af30dbc2ade550ef3f4ca163a0b5361baeed", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f7f7ef07b85ec23c43c34bee6e06de3f1e1667f1", "url": "https://github.com/aws-amplify/amplify-android/commit/f7f7ef07b85ec23c43c34bee6e06de3f1e1667f1", "message": "Fix typo", "committedDate": "2020-05-17T03:50:54Z", "type": "commit"}]}