{"pr_number": 227, "pr_title": "[DataStore] Refactor in-memory storage adapter", "pr_createdAt": "2020-01-08T22:48:56Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/227", "timeline": [{"oid": "214379662e7430f2ae35082dcf4767a1264cdaf2", "url": "https://github.com/aws-amplify/amplify-android/commit/214379662e7430f2ae35082dcf4767a1264cdaf2", "message": "Refactor in-memory storage adapter", "committedDate": "2020-01-08T22:01:38Z", "type": "commit"}, {"oid": "3a888221d77168ae8ee39a7f7b90f453486d689f", "url": "https://github.com/aws-amplify/amplify-android/commit/3a888221d77168ae8ee39a7f7b90f453486d689f", "message": "Revert to list", "committedDate": "2020-01-08T22:46:27Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MDU1MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364490550", "bodyText": "Maybe, instead, \"Verify that there is a model in the datastore that matches the provided predicate.\" ?", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:14:27Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -81,21 +81,36 @@ public void initialize(\n     public <T extends Model> void save(\n             @NonNull final T item,\n             @NonNull final StorageItemChange.Initiator initiator,\n-            @NonNull final QueryPredicate predicate,\n+            @Nullable final QueryPredicate predicate,\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        items.add(item);\n-        StorageItemChange.Record save = StorageItemChange.<T>builder()\n-                .item(item)\n-                .itemClass((Class<T>) item.getClass())\n-                .type(StorageItemChange.Type.SAVE)\n-                .predicate(predicate)\n-                .initiator(initiator)\n-                .build()\n-                .toRecord(storageItemChangeConverter);\n-        changeRecordStream.onNext(save);\n-        onSuccess.accept(save);\n+        final int index = indexOf(item);\n+        if (index > -1) {\n+            // Update\n+            Model savedItem = items.get(index);\n+            if (predicate == null || predicate.evaluate(savedItem)) {\n+                items.remove(index);\n+                save(item, initiator, predicate, onSuccess, onError);\n+                return;\n+            }\n+            onError.accept(new DataStoreException(\n+                    \"Conditional check failed.\",\n+                    \"Verify the saved models.\"));", "originalCommit": "3a888221d77168ae8ee39a7f7b90f453486d689f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MDg3Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364490877", "bodyText": "You can cut out this inner body, and make it a helper method called update(..), perhaps? This will help keep the line length of the save(...) method down. However, if they re-use tons of the same params, it might end up being too minor of a savings.", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:15:37Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -81,21 +81,36 @@ public void initialize(\n     public <T extends Model> void save(\n             @NonNull final T item,\n             @NonNull final StorageItemChange.Initiator initiator,\n-            @NonNull final QueryPredicate predicate,\n+            @Nullable final QueryPredicate predicate,\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        items.add(item);\n-        StorageItemChange.Record save = StorageItemChange.<T>builder()\n-                .item(item)\n-                .itemClass((Class<T>) item.getClass())\n-                .type(StorageItemChange.Type.SAVE)\n-                .predicate(predicate)\n-                .initiator(initiator)\n-                .build()\n-                .toRecord(storageItemChangeConverter);\n-        changeRecordStream.onNext(save);\n-        onSuccess.accept(save);\n+        final int index = indexOf(item);\n+        if (index > -1) {\n+            // Update", "originalCommit": "3a888221d77168ae8ee39a7f7b90f453486d689f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5Mzc1Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364493753", "bodyText": "yea that's the conclusion i've reached: that they share too many parameters to actually take advantage of this", "author": "raphkim", "createdAt": "2020-01-08T23:25:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MDg3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MTE0OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364491149", "bodyText": "Same as above, consider breaking this stuff out into a helper method called create. The semantics would become like \"A save is either an update, or a create, depending on whether or not index is non-zero.\"\n} else {\n  create(...);\n}", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:16:37Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -81,21 +81,36 @@ public void initialize(\n     public <T extends Model> void save(\n             @NonNull final T item,\n             @NonNull final StorageItemChange.Initiator initiator,\n-            @NonNull final QueryPredicate predicate,\n+            @Nullable final QueryPredicate predicate,\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        items.add(item);\n-        StorageItemChange.Record save = StorageItemChange.<T>builder()\n-                .item(item)\n-                .itemClass((Class<T>) item.getClass())\n-                .type(StorageItemChange.Type.SAVE)\n-                .predicate(predicate)\n-                .initiator(initiator)\n-                .build()\n-                .toRecord(storageItemChangeConverter);\n-        changeRecordStream.onNext(save);\n-        onSuccess.accept(save);\n+        final int index = indexOf(item);\n+        if (index > -1) {\n+            // Update\n+            Model savedItem = items.get(index);\n+            if (predicate == null || predicate.evaluate(savedItem)) {\n+                items.remove(index);\n+                save(item, initiator, predicate, onSuccess, onError);\n+                return;\n+            }\n+            onError.accept(new DataStoreException(\n+                    \"Conditional check failed.\",\n+                    \"Verify the saved models.\"));\n+        } else {\n+            // Insert", "originalCommit": "3a888221d77168ae8ee39a7f7b90f453486d689f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MTU2Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364491566", "bodyText": "You could invert this expression, and put the error handling in the body.\nThen, do your happy path back -4 indentation to the left.\ne.g.\nif (unlikeBadThing) {\n    announce(\"Hey no fair...\");\n    return;\n}\n// otherwise\nperformBusiness();\nasUsual();\netc();", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:18:00Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -144,22 +159,23 @@ public void initialize(\n             @NonNull final Consumer<StorageItemChange.Record> onSuccess,\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n-        for (Model savedItem : items) {\n-            if (savedItem.getId().equals(item.getId())\n-                    && (predicate == null || predicate.evaluate(item))) {\n-                items.remove(item);\n-                StorageItemChange.Record deletion = StorageItemChange.<T>builder()\n-                        .item((T) savedItem)\n-                        .itemClass((Class<T>) savedItem.getClass())\n-                        .type(StorageItemChange.Type.DELETE)\n-                        .predicate(predicate)\n-                        .initiator(initiator)\n-                        .build()\n-                        .toRecord(storageItemChangeConverter);\n-                changeRecordStream.onNext(deletion);\n-                onSuccess.accept(deletion);\n-                return;\n-            }\n+        final int index = indexOf(item);\n+        if (index > -1 && (predicate == null || predicate.evaluate(item))) {", "originalCommit": "3a888221d77168ae8ee39a7f7b90f453486d689f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5NjI5MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364496291", "bodyText": "good idea. Also caught a bug where i checked the predicate condition against item to delete rather than on the already stored item.", "author": "raphkim", "createdAt": "2020-01-08T23:33:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5MTU2Ng=="}], "type": "inlineReview"}, {"oid": "57f4de60dea81f97f7b78e866fe2a2576adc8ab3", "url": "https://github.com/aws-amplify/amplify-android/commit/57f4de60dea81f97f7b78e866fe2a2576adc8ab3", "message": "Apply suggestions", "committedDate": "2020-01-08T23:33:43Z", "type": "commit"}, {"oid": "a6fdecdb202bcb01315aa2e64981966b4df2e664", "url": "https://github.com/aws-amplify/amplify-android/commit/a6fdecdb202bcb01315aa2e64981966b4df2e664", "message": "Minor fix", "committedDate": "2020-01-08T23:38:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODU1OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364498558", "bodyText": "I think you need a return; here, too, afteryou fire onError.accept(...).", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:42:49Z", "path": "aws-datastore/src/test/java/com/amplifyframework/datastore/storage/InMemoryStorageAdapter.java", "diffHunk": "@@ -160,23 +160,30 @@ public void initialize(\n             @NonNull final Consumer<DataStoreException> onError\n     ) {\n         final int index = indexOf(item);\n-        if (index > -1 && (predicate == null || predicate.evaluate(item))) {\n-            Model savedItem = items.remove(index);\n-            StorageItemChange.Record deletion = StorageItemChange.<T>builder()\n-                    .item((T) savedItem)\n-                    .itemClass((Class<T>) savedItem.getClass())\n-                    .type(StorageItemChange.Type.DELETE)\n-                    .predicate(predicate)\n-                    .initiator(initiator)\n-                    .build()\n-                    .toRecord(storageItemChangeConverter);\n-            changeRecordStream.onNext(deletion);\n-            onSuccess.accept(deletion);\n-        } else {\n+        if (index < 0) {\n             onError.accept(new DataStoreException(\n-                    \"Item does not exist or conditional check failed.\",\n-                    \"Verify the saved models.\"));\n+                    \"This item was not found in the datastore: \" + item.toString(),\n+                    \"Use save() function to create models to store.\"", "originalCommit": "57f4de60dea81f97f7b78e866fe2a2576adc8ab3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODk5Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/227#discussion_r364498996", "bodyText": "AHA! pushed the change right before this comment ;)", "author": "raphkim", "createdAt": "2020-01-08T23:44:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODU1OA=="}], "type": "inlineReview"}]}