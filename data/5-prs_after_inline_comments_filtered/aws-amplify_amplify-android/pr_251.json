{"pr_number": 251, "pr_title": "[DataStore] Use Hub notifications to communicate Sync Engine events", "pr_createdAt": "2020-01-29T09:05:53Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/251", "timeline": [{"oid": "6f6065e05789838cd3da455047a05fc00fb98c77", "url": "https://github.com/aws-amplify/amplify-android/commit/6f6065e05789838cd3da455047a05fc00fb98c77", "message": "[DataStore] Use Hub notifications to communicate Sync Engine events\n\nPreviously, DataStore instrumentation tests were using Sleep to wait an\narbitrary amount of time for synchronization tasks to complete. See the\nnew statement in Sleep.java about why waiting for a random amount of\ntime is a bad strategy for synchronization. Instead, DataStore\nsynchronization events are now published to the Hub.\n\nSome test utilities are added to help await Hub events, in tests.", "committedDate": "2020-01-29T08:59:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwOTI5OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372709299", "bodyText": "What's a Charley model?", "author": "undefobj", "createdAt": "2020-01-30T00:46:14Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/AWSDataStorePluginInstrumentedTest.java", "diffHunk": "@@ -91,8 +116,8 @@ public void blogOwnerSavedIntoDataStoreIsThenQueriableInRemoteAppSyncApi() throw\n             .build();\n         dataStore.save(localCharley);\n \n-        // Wait a bit. TODO: this is lame; how to tell deterministically when sync engine has sync'd?\n-        Sleep.milliseconds(NETWORK_OP_TIMEOUT_MS + DATA_STORE_OP_TIMEOUT_MS);\n+        // Wait for a Hub event telling us that our Charley model got published to the cloud.\n+        outboundModelEventAccumulator.takeOne();", "originalCommit": "6f6065e05789838cd3da455047a05fc00fb98c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwOTk4OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372709989", "bodyText": "Oh I see, .name(\"Charley Crockett\")\nI was thinking this was a new data structure \ud83d\ude02", "author": "undefobj", "createdAt": "2020-01-30T00:48:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwOTI5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxODQ1NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372718454", "bodyText": "Haha we should invent it!!", "author": "jamesonwilliams", "createdAt": "2020-01-30T01:23:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwOTI5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMDc4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372710783", "bodyText": "One thought here is do we want to have this on a channel for DataStore or API? We've already seen customers asking about using the API category and DataStore together, so there might be merit to having everything going over the API channel for events from AppSync. OTOH we could always publish to both or switch it later. Food for thought.", "author": "undefobj", "createdAt": "2020-01-30T00:52:25Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/network/SyncEngine.java", "diffHunk": "@@ -137,6 +140,11 @@ private void startModelSubscriptions() {\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                     );\n             }\n+\n+            // Notify Hub that we just updated the local storage.\n+            HubEvent<? extends Model> receivedFromCloudEvent =\n+                HubEvent.create(DataStoreChannelEventName.RECEIVED_FROM_CLOUD, mutation.model());\n+            Amplify.Hub.publish(HubChannel.DATASTORE, receivedFromCloudEvent);", "originalCommit": "6f6065e05789838cd3da455047a05fc00fb98c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcyMDk2OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372720969", "bodyText": "Since this event was initiated by the datastore, I thought to put it out onto the datastore channel.\nI think there will be fewer hub events for the API category, overall. Although, there might be some good reasons to use Hub for subscription events, paging on list APIs, retries on recoverable error, things like this.", "author": "jamesonwilliams", "createdAt": "2020-01-30T01:34:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMDc4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMTEwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372711102", "bodyText": "Is this just for local debugging and should we remove?", "author": "undefobj", "createdAt": "2020-01-30T00:53:43Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/network/SyncEngine.java", "diffHunk": "@@ -151,7 +159,12 @@ private void startDrainingChangeJournal() {\n                 .flatMapSingle(this::publishToNetwork)\n                 .flatMapSingle(storageItemChangeJournal::remove)\n                 .subscribe(\n-                    processedChange -> LOG.info(\"Change processed successfully! \" + processedChange),\n+                    processedChange -> {\n+                        LOG.info(\"Change processed successfully! \" + processedChange);", "originalCommit": "6f6065e05789838cd3da455047a05fc00fb98c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxOTEzNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372719136", "bodyText": "Hm, I should change it from .info to .debug. Since the default is to only print info's or better, debug would effectively turn if off (unless somebody changes the log level.)", "author": "jamesonwilliams", "createdAt": "2020-01-30T01:25:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMTEwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMTQ3Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372711476", "bodyText": "I like this but do we have a similar structure on iOS that we could align with names? @palpatim @drochetti", "author": "undefobj", "createdAt": "2020-01-30T00:55:06Z", "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.hub.HubCategory;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+\n+import java.util.Objects;\n+\n+/**\n+ * An enumeration of the names of events relating the the {@link DataStoreCategory},\n+ * that are published via {@link HubCategory#publish(HubChannel, HubEvent)} on the\n+ * {@link HubChannel#DATASTORE} channel.\n+ */\n+public enum DataStoreChannelEventName {", "originalCommit": "6f6065e05789838cd3da455047a05fc00fb98c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcyMDMzMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372720333", "bodyText": "Good point - since this is API surface, we should get the names and behavior aligned across platforms.", "author": "jamesonwilliams", "createdAt": "2020-01-30T01:31:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMTQ3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMjA3OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372712079", "bodyText": "Another thing that we are looking at is \"local only models\" which do not get sync'd to the cloud. A few customers have been asking about this and @drochetti and Manuel are doing a design. In that case we might want to still publish to hub for state management in your app, so it's worth keeping that in mind for the list of possible events - e.g. PUBLISHED_TO_LOCAL", "author": "undefobj", "createdAt": "2020-01-30T00:57:42Z", "path": "core/src/main/java/com/amplifyframework/datastore/DataStoreChannelEventName.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.hub.HubCategory;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+\n+import java.util.Objects;\n+\n+/**\n+ * An enumeration of the names of events relating the the {@link DataStoreCategory},\n+ * that are published via {@link HubCategory#publish(HubChannel, HubEvent)} on the\n+ * {@link HubChannel#DATASTORE} channel.\n+ */\n+public enum DataStoreChannelEventName {\n+    /**\n+     * An item in the local storage has been published to the cloud.\n+     * An event that uses this value for {@link HubEvent#getName()} will contain a model object\n+     * in the {@link HubEvent#getData()}.\n+     */\n+    PUBLISHED_TO_CLOUD(\"published_to_cloud\"),", "originalCommit": "6f6065e05789838cd3da455047a05fc00fb98c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcyMDE3OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372720178", "bodyText": "Okay, cool. Yea, as you note, the DataStoreChangeEventName is really part of the API surface itself, since customers will engage with these names to understand the events on the Hub. I suspect this file will see a bunch more useful stuff come into it.", "author": "jamesonwilliams", "createdAt": "2020-01-30T01:30:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMjA3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMjg4Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372712883", "bodyText": "I'm not sure if we ever got the filter implemented fully in Hub on Android, just an FYI", "author": "undefobj", "createdAt": "2020-01-30T01:00:49Z", "path": "testutils/src/main/java/com/amplifyframework/testutils/HubAccumulator.java", "diffHunk": "@@ -0,0 +1,157 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.testutils;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.core.Amplify;\n+import com.amplifyframework.hub.HubChannel;\n+import com.amplifyframework.hub.HubEvent;\n+import com.amplifyframework.hub.HubEventFilter;\n+import com.amplifyframework.hub.HubEventFilters;\n+import com.amplifyframework.hub.SubscriptionToken;\n+\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.concurrent.CountDownLatch;\n+\n+/**\n+ * Accumulates {@link HubEvent}s received on a {@link HubChannel}, into an in-memory\n+ * buffer. These may be queried by tests in a synchronous way to check if they have arrived.\n+ */\n+@SuppressWarnings({\"unused\", \"UnusedReturnValue\"})\n+public final class HubAccumulator {\n+    private final HubChannel channel;\n+    private final HubEventFilter filter;", "originalCommit": "6f6065e05789838cd3da455047a05fc00fb98c77", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxOTgwOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/251#discussion_r372719808", "bodyText": "For Hub, we did, it's more or less just a single if (...) check, in the publish(...) method.", "author": "jamesonwilliams", "createdAt": "2020-01-30T01:28:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxMjg4Mw=="}], "type": "inlineReview"}]}