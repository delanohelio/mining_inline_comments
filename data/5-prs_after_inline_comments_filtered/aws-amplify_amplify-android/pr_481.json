{"pr_number": 481, "pr_title": "Add text and label configuration", "pr_createdAt": "2020-05-18T06:19:06Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/481", "timeline": [{"oid": "cbab4f719621c8505114a160a1f9a28ed9c17f8c", "url": "https://github.com/aws-amplify/amplify-android/commit/cbab4f719621c8505114a160a1f9a28ed9c17f8c", "message": "Add text and label configuration", "committedDate": "2020-05-18T06:13:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyNTY0MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426425640", "bodyText": "/md This already lives immediately under an \"identify\", right? Can it just be:\n    \"identify\": {\n        \"labels\": {\n        }\n    }\n\ninstead of :\n    \"identfiy\": {\n        \"identifyLabels\": {\n        }\n    }", "author": "jamesonwilliams", "createdAt": "2020-05-18T07:40:12Z", "path": "aws-predictions/src/main/java/com/amplifyframework/predictions/aws/configuration/IdentifyLabelsConfiguration.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.aws.configuration;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.predictions.aws.NetworkPolicy;\n+import com.amplifyframework.predictions.models.LabelType;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+/**\n+ * Configures the behavior for identifying labels.\n+ */\n+public final class IdentifyLabelsConfiguration {\n+    private static final String CONFIG_NAME = \"identifyLabels\";", "originalCommit": "cbab4f719621c8505114a160a1f9a28ed9c17f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzNTQyOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426435428", "bodyText": "discussed; existing CLI behavior", "author": "raphkim", "createdAt": "2020-05-18T07:58:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyNTY0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyNjEyNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426426125", "bodyText": "This is weird, having one of these in a const, and the other not. I'd stick with a single approach, whichever you choose.", "author": "jamesonwilliams", "createdAt": "2020-05-18T07:41:08Z", "path": "aws-predictions/src/main/java/com/amplifyframework/predictions/aws/configuration/IdentifyLabelsConfiguration.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.predictions.aws.configuration;\n+\n+import androidx.annotation.NonNull;\n+import androidx.annotation.Nullable;\n+\n+import com.amplifyframework.predictions.aws.NetworkPolicy;\n+import com.amplifyframework.predictions.models.LabelType;\n+\n+import org.json.JSONException;\n+import org.json.JSONObject;\n+\n+/**\n+ * Configures the behavior for identifying labels.\n+ */\n+public final class IdentifyLabelsConfiguration {\n+    private static final String CONFIG_NAME = \"identifyLabels\";\n+    private final LabelType type;\n+    private final NetworkPolicy networkPolicy;\n+\n+    private IdentifyLabelsConfiguration(\n+            LabelType type,\n+            NetworkPolicy networkPolicy\n+    ) {\n+        this.type = type;\n+        this.networkPolicy = networkPolicy;\n+    }\n+\n+    /**\n+     * Construct an instance of {@link IdentifyLabelsConfiguration} from\n+     * plugin configuration JSON object.\n+     * @param configurationJson the plugin configuration\n+     * @return the configuration for label identification\n+     * @throws JSONException if identify configuration is malformed\n+     */\n+    @Nullable\n+    public static IdentifyLabelsConfiguration fromJson(@NonNull JSONObject configurationJson) throws JSONException {\n+        if (!configurationJson.has(CONFIG_NAME)) {\n+            return null;\n+        }\n+\n+        JSONObject identifyLabelsJson = configurationJson.getJSONObject(CONFIG_NAME);\n+        String typeString = identifyLabelsJson.getString(\"type\");", "originalCommit": "cbab4f719621c8505114a160a1f9a28ed9c17f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzODUyMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426438521", "bodyText": "I simply wanted to make CONFIG_NAME a constant because it gets used twice in the code instead of once like the other keys haha. Also, they denote different levels in the JSON document, so I figured the lowest level nodes don't deserve a special treatment.", "author": "raphkim", "createdAt": "2020-05-18T08:03:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyNjEyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyNzgwOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426427808", "bodyText": "Under what conditions is it valuable to provide a non-LabelType object, here? I see later you have some control flow around a ClassCastException.", "author": "jamesonwilliams", "createdAt": "2020-05-18T07:44:23Z", "path": "aws-predictions/src/main/java/com/amplifyframework/predictions/aws/service/AWSPredictionsService.java", "diffHunk": "@@ -104,12 +107,19 @@ public void translate(\n      * @param onError triggered upon encountering error\n      */\n     public void detectLabels(\n-            @NonNull LabelType type,\n+            @NonNull IdentifyAction type,", "originalCommit": "cbab4f719621c8505114a160a1f9a28ed9c17f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzNjU1Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426436552", "bodyText": "I figured it might be confusing to have people provide IdentifyActionType everywhere except when doing it for label detection and text detection, so I wanted IdentifyActionType.DETECT_LABELS to be a valid entry also. Besides, the configuration value will be always ignored if the user is forced to supply an explicit value here all the time, and I figured IdentifyActionType.DETECT_LABELS is a great choice to use as the default option.", "author": "raphkim", "createdAt": "2020-05-18T08:00:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyNzgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyODA2MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426428060", "bodyText": "But why?", "author": "jamesonwilliams", "createdAt": "2020-05-18T07:44:53Z", "path": "aws-predictions/src/main/java/com/amplifyframework/predictions/aws/service/AWSPredictionsService.java", "diffHunk": "@@ -184,6 +195,32 @@ public void comprehend(\n         comprehendService.comprehend(text, onSuccess, onError);\n     }\n \n+    /**\n+     * If {@link IdentifyAction} is an instance of {@link LabelType} and\n+     * cast if true. Otherwise check configuration for default action type.\n+     * Throw if label detection is not configured.\n+     */\n+    private LabelType getLabelType(IdentifyAction actionType) throws PredictionsException {\n+        try {\n+            return (LabelType) actionType;\n+        } catch (ClassCastException error) {\n+            return configuration.getIdentifyLabelsConfiguration().getType();\n+        }\n+    }\n+\n+    /**\n+     * If {@link IdentifyAction} is an instance of {@link TextFormatType} and\n+     * cast if true. Otherwise check configuration for default action type.", "originalCommit": "cbab4f719621c8505114a160a1f9a28ed9c17f8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyODkwNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426428907", "bodyText": "How about, \"Celebrity detection has not been configured.\" Disabled sounds more like it has been turned off explicitly, or is has been made unavailable by policy.", "author": "jamesonwilliams", "createdAt": "2020-05-18T07:46:31Z", "path": "aws-predictions/src/main/java/com/amplifyframework/predictions/aws/service/AWSRekognitionService.java", "diffHunk": "@@ -133,9 +133,19 @@ void recognizeCelebrities(\n             @NonNull Consumer<IdentifyResult> onSuccess,\n             @NonNull Consumer<PredictionsException> onError\n     ) {\n+        final IdentifyEntitiesConfiguration config;\n         try {\n-            List<CelebrityDetails> celebrities = detectCelebrities(imageData);\n-            onSuccess.accept(IdentifyCelebritiesResult.fromCelebrities(celebrities));\n+            config = pluginConfiguration.getIdentifyEntitiesConfiguration();\n+            if (config.isCelebrityDetectionEnabled()) {\n+                List<CelebrityDetails> celebrities = detectCelebrities(imageData);\n+                onSuccess.accept(IdentifyCelebritiesResult.fromCelebrities(celebrities));\n+            } else {\n+                onError.accept(new PredictionsException(\"Celebrity detection is disabled.\",", "originalCommit": "cbab4f719621c8505114a160a1f9a28ed9c17f8c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzNDc5MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426434790", "bodyText": "There is already an explicit \"celebrityDetectionEnabled\" flag under \"identifyEntities\" configuration, so I think this message is appropriate.", "author": "raphkim", "createdAt": "2020-05-18T07:57:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyODkwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQyOTA4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/481#discussion_r426429080", "bodyText": "This is a great recovery suggestion.", "author": "jamesonwilliams", "createdAt": "2020-05-18T07:46:51Z", "path": "aws-predictions/src/main/java/com/amplifyframework/predictions/aws/service/AWSRekognitionService.java", "diffHunk": "@@ -133,9 +133,19 @@ void recognizeCelebrities(\n             @NonNull Consumer<IdentifyResult> onSuccess,\n             @NonNull Consumer<PredictionsException> onError\n     ) {\n+        final IdentifyEntitiesConfiguration config;\n         try {\n-            List<CelebrityDetails> celebrities = detectCelebrities(imageData);\n-            onSuccess.accept(IdentifyCelebritiesResult.fromCelebrities(celebrities));\n+            config = pluginConfiguration.getIdentifyEntitiesConfiguration();\n+            if (config.isCelebrityDetectionEnabled()) {\n+                List<CelebrityDetails> celebrities = detectCelebrities(imageData);\n+                onSuccess.accept(IdentifyCelebritiesResult.fromCelebrities(celebrities));\n+            } else {\n+                onError.accept(new PredictionsException(\"Celebrity detection is disabled.\",\n+                        \"Please enable celebrity detection via Amplify CLI. This feature \" +\n+                                \"should be accessible by running `amplify update predictions` \" +\n+                                \"in the console and updating entities detection resource with \" +\n+                                \"advanced configuration setting.\"));", "originalCommit": "cbab4f719621c8505114a160a1f9a28ed9c17f8c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}