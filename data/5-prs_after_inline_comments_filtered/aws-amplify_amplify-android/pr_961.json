{"pr_number": 961, "pr_title": "fix: properly support flutter online scenarios", "pr_createdAt": "2020-11-14T21:57:50Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/961", "timeline": [{"oid": "24817665c6692cb99c876e31a6e53f2885253ce0", "url": "https://github.com/aws-amplify/amplify-android/commit/24817665c6692cb99c876e31a6e53f2885253ce0", "message": "fix: properly support flutter online scenarios\n\nPrevious work to support online-sync mode from Flutter had been vetted\nwith the HybridCloudSyncInstrumentationTest. This test was using\nModelSchema.fromClass(), which will still store a Class<T> in the\nmodelClass. As a result, the test was giving false optimism as to the\nfunctionality in the code base.\n\nA change is made to pull ModelSchema from JSON files, in the ./assets\ndirectory, instead. Driven by this updated tests, a number of additional\nclasses are updated to become aware of ModelSchema and SerializedModel.", "committedDate": "2020-11-14T22:04:57Z", "type": "commit"}, {"oid": "24817665c6692cb99c876e31a6e53f2885253ce0", "url": "https://github.com/aws-amplify/amplify-android/commit/24817665c6692cb99c876e31a6e53f2885253ce0", "message": "fix: properly support flutter online scenarios\n\nPrevious work to support online-sync mode from Flutter had been vetted\nwith the HybridCloudSyncInstrumentationTest. This test was using\nModelSchema.fromClass(), which will still store a Class<T> in the\nmodelClass. As a result, the test was giving false optimism as to the\nfunctionality in the code base.\n\nA change is made to pull ModelSchema from JSON files, in the ./assets\ndirectory, instead. Driven by this updated tests, a number of additional\nclasses are updated to become aware of ModelSchema and SerializedModel.", "committedDate": "2020-11-14T22:04:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTI4OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469289", "bodyText": "The response from AppSync doesn't contain any information about what type it is. Previously, we used to know this because of the <T>. Now, I have to hack the modelSchema back in at this higher level. The SubscriptionProcessor knows which subscription the data came back on, so it can append the schema, here.", "author": "jamesonwilliams", "createdAt": "2020-11-14T22:13:17Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SubscriptionProcessor.java", "diffHunk": "@@ -224,7 +224,19 @@ void startDrainingMutationBuffer(Action onPipelineBroken) {\n                 .doOnSubscribe(disposable ->\n                     LOG.info(\"Starting processing subscription data buffer.\")\n                 )\n-                .flatMapCompletable(mutation -> merger.merge(mutation.modelWithMetadata()))\n+                .flatMapCompletable(mutation -> {\n+                    ModelWithMetadata<? extends Model> original = mutation.modelWithMetadata();\n+                    if (original.getModel() instanceof SerializedModel) {\n+                        SerializedModel originalModel = (SerializedModel) original.getModel();\n+                        SerializedModel newModel = SerializedModel.builder()\n+                            .serializedData(originalModel.getSerializedData())\n+                            .modelSchema(mutation.modelSchema())", "originalCommit": "24817665c6692cb99c876e31a6e53f2885253ce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzc2OTAyMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523769021", "bodyText": "Just a clarification...are the terms new and original referring to the type of model you're working with (i.e. SerializedModel vs POJO) or is it referring to the data (i.e. original = existing data and new = updated data)?", "author": "rjuliano", "createdAt": "2020-11-15T14:49:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzgzMzAzMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523833030", "bodyText": "originalModel means \"before I patch this SerializedModel instance's modelSchema field,\" and newModel means \"the SerializedModel we got back from the sync command, but with a patched-up modelSchema field.\"", "author": "jamesonwilliams", "createdAt": "2020-11-15T23:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDcxNzQ4Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r524717486", "bodyText": "Not a blocker for this PR, but it would be nice to see a newBuilder() method on the SerializedModel class, so you could simplify this to:\nSerializedModel newModel = originalModel.newBuilder()\n    .modelSchema(mutation.modelSchema())\n    .build();", "author": "richardmcclellan", "createdAt": "2020-11-16T23:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTMwNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469305", "bodyText": "Same basic situation as in the SubscriptionProcessor.", "author": "jamesonwilliams", "createdAt": "2020-11-14T22:13:32Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/SyncProcessor.java", "diffHunk": "@@ -140,9 +141,20 @@ private Completable createHydrationTask(ModelSchema schema) {\n                 // Sync all the pages\n                 return syncModel(schema, lastSyncTime)\n                     // For each ModelWithMetadata, merge it into the local store.\n-                    .flatMapCompletable(modelWithMetadata ->\n-                        merger.merge(modelWithMetadata, metricsAccumulator::increment)\n-                    )\n+                    .flatMapCompletable(original -> {\n+                        ModelWithMetadata<? extends Model> updated;\n+                        if (original.getModel() instanceof SerializedModel) {\n+                            SerializedModel originalModel = (SerializedModel) original.getModel();\n+                            SerializedModel newModel = SerializedModel.builder()", "originalCommit": "24817665c6692cb99c876e31a6e53f2885253ce0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTQ3Mw==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469473", "bodyText": "The key change in this PR is that the schema are being read from JSON. The JSON files no longer say com.path.to.some.generated.java.model.JavaPojo. (Previously, the test had passed, with those queues.)\nNow, the stated type for a model is a serialized model.", "author": "jamesonwilliams", "createdAt": "2020-11-14T22:15:19Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/HybridCloudSyncInstrumentationTest.java", "diffHunk": "@@ -116,11 +116,12 @@ public void setup() throws AmplifyException {\n         api = SynchronousApi.delegatingTo(apiCategory);\n         appSync = SynchronousAppSync.using(AppSyncClient.via(apiCategory));\n \n+        schemaProvider = SchemaLoader.loadFromAssetsDirectory(\"schemas/commentsblog\");", "originalCommit": "24817665c6692cb99c876e31a6e53f2885253ce0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzQ2OTU2OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r523469568", "bodyText": "This utility is used by the SchemaLoader. The schema loader reads the schema JSON from disk with this list(...) utility. It will then build ModelSchema instances, from each.", "author": "jamesonwilliams", "createdAt": "2020-11-14T22:16:36Z", "path": "testutils/src/main/java/com/amplifyframework/testutils/Assets.java", "diffHunk": "@@ -79,5 +81,30 @@ public static Bitmap readAsBitmap(final String name) throws RuntimeException {\n             throw new RuntimeException(\"Failed to load asset \" + name, ioException);\n         }\n     }\n-}\n \n+    /**\n+     * Lists the files in the assets directory.\n+     * @param path Directory path under assets/.\n+     * @return A list of files found\n+     */\n+    @NonNull\n+    public static List<String> list(String path) {", "originalCommit": "24817665c6692cb99c876e31a6e53f2885253ce0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3OTY4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r524479680", "bodyText": "Hmm, why is this change necessary?  Shouldn't the SerializedModelAdapter already handle this?\nIf this is needed here, then I think we would probably also need a similar change in any other adapter that deserializes a Class that could contain a Model (e.g. PaginatedResult, Iterable, GraphQLResponse)", "author": "richardmcclellan", "createdAt": "2020-11-16T18:22:11Z", "path": "aws-api-appsync/src/main/java/com/amplifyframework/datastore/appsync/ModelWithMetadataAdapter.java", "diffHunk": "@@ -60,7 +61,15 @@ public static void register(@NonNull GsonBuilder builder) {\n             throw new JsonParseException(\"Expected a parameterized type during ModelWithMetadata deserialization.\");\n         }\n \n-        Model model = context.deserialize(json, modelClassType);\n+        final Model model;", "originalCommit": "24817665c6692cb99c876e31a6e53f2885253ce0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTg3MDQxMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r525870410", "bodyText": "Alright, I studied this change a bit more. I think, for now at least, it probably makes sense to leave it as is.\nThe SerializedModelAdapter currently stores modelSchema and serializedData,into a JSON structure like this:\n{\n    \"modelSchema\": {\n        ...\n    },\n    \"serializedData\": {\n    }\n}\nHowever, the format of the ModelWithMetadata is like:\n{\n    \"flatDataKey1\": \"dataVal\",\n    \"flatDataKey2\": \"dataVal\",\n    \"_metadataStuff1\": \"metadata\",\n    \"_metadataStuff2\": \"metadata\"\n}\nThe GSON deserialization will cascade through the adapters you mention, and will try to deserialize a GraphQLResponse<Iterable<ModelWithMetadata<SerializedModel>>>. It knows how to do all of that just fine, except when it gets to the inner-most adapter. At that point, it looks for a field called serializedData in that second JSON structure (which doesn't exist.)\nSo I think TLDR: I am actually doing some custom deserialization only for ModelWithMetadata.\nAnd, it isn't needed for other adapters, since DataStore will always envelope in the ModelWithMetadata.\n\nI can think of a few others ways we could do this.\n\n\nAt a higher level, pass the T as Map<String, Object>, s.t. we try to deserialize GraphQLResponse<Iterable<ModelWithMetadata<Map<String, Object>>>>. Then, we could rectify the map data back into a SerializedModel.builder().serializedData(theResponseContent).build() at a higher level in the stack.\n\n\nRip <T> out of almost all of the system, in future work. This is what I actually want to do. With this, the SQL layer and the AppSync sync layer will just know about SerializedModel only, but not any model types. (I also propose that we rename SerializedModel to maybe just Blob, but that's a separate matter.) Only the highest layer of the system (just under the DataStore API) would know about Java-language data-modeling. At that high-level, it would quickly convert to schema/blob object pairs. Sync engine & storage adapter would operate wholly on those.", "author": "jamesonwilliams", "createdAt": "2020-11-18T07:42:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3OTY4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjIzNjA3OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/961#discussion_r526236079", "bodyText": "Got it, thanks for investigating it :). I'm good to leave it as is for now.\n\nRip  out of almost all of the system, in future work.\n\nI agree this is the right direction to move towards.\n\nI also propose that we rename SerializedModel to maybe just Blob, but that's a separate matter.\n\n\ud83d\udc4d\nI wonder if we could also eliminate ModelWithMetadata entirely, and just store the metadata as a part of the Blob.  We aren't able to do this when working with the generated Java models, but perhaps we could with a Blob.   It would be closer to how the data is modeled on the AppSync side anyway.   Seems like this could simplify a lot too.", "author": "richardmcclellan", "createdAt": "2020-11-18T16:41:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDQ3OTY4MA=="}], "type": "inlineReview"}]}