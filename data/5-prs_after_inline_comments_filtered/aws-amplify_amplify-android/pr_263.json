{"pr_number": 263, "pr_title": "Patch flaky tests for CI/CD", "pr_createdAt": "2020-02-13T23:35:01Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/263", "timeline": [{"oid": "8bfa1b3196932d2b217b024b54f3694d96e20ab5", "url": "https://github.com/aws-amplify/amplify-android/commit/8bfa1b3196932d2b217b024b54f3694d96e20ab5", "message": "Split SQLiteStorageAdapter tests to reduce load", "committedDate": "2020-02-13T22:39:03Z", "type": "commit"}, {"oid": "42207af3ed33b6bf918531ed7d3749467116f98d", "url": "https://github.com/aws-amplify/amplify-android/commit/42207af3ed33b6bf918531ed7d3749467116f98d", "message": "Checkstyle fix", "committedDate": "2020-02-13T22:51:20Z", "type": "commit"}, {"oid": "13b3b7c4ba774194e3c16bec01dbaf66d590e1c2", "url": "https://github.com/aws-amplify/amplify-android/commit/13b3b7c4ba774194e3c16bec01dbaf66d590e1c2", "message": "Extend synchronous API timeout", "committedDate": "2020-02-13T23:29:44Z", "type": "commit"}, {"oid": "d9e84de98204a5a132a90088043b23555c1b2044", "url": "https://github.com/aws-amplify/amplify-android/commit/d9e84de98204a5a132a90088043b23555c1b2044", "message": "Whitespace fix", "committedDate": "2020-02-13T23:40:38Z", "type": "commit"}, {"oid": "1d1b2329c3f4ac8a469f99c2aadd30225c10e0f6", "url": "https://github.com/aws-amplify/amplify-android/commit/1d1b2329c3f4ac8a469f99c2aadd30225c10e0f6", "message": "Extend Sqlite operation timeout duration", "committedDate": "2020-02-13T23:51:19Z", "type": "commit"}, {"oid": "cc2f31027e03d1a496bed2fc674898b7590a020f", "url": "https://github.com/aws-amplify/amplify-android/commit/cc2f31027e03d1a496bed2fc674898b7590a020f", "message": "Extend connection error threshold", "committedDate": "2020-02-14T00:06:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYxOTgwOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379619809", "bodyText": "If they are utility methods, then I recommend to put them into utility classes, not into an abstract base.\nAbstract classes are good candidates for enforcing policy on an interface. But, that\u2019s not really what\u2019s needed here. Here, you\u2019re just trying to re-use some utility code in a few places.", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:02:06Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/StorageAdapterInstrumentedTestBase.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.storage.sqlite;\n+\n+import android.content.Context;\n+import android.os.StrictMode;\n+import androidx.annotation.NonNull;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelProvider;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.core.model.query.predicate.QueryPredicate;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.testmodels.commentsblog.AmplifyModelProvider;\n+import com.amplifyframework.testutils.Await;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ * Test the functionality of {@link SQLiteStorageAdapter} operations.\n+ */\n+@SuppressWarnings(\"DesignForExtension\") // Utility methods shouldn't be overwritten\n+public abstract class StorageAdapterInstrumentedTestBase {", "originalCommit": "cc2f31027e03d1a496bed2fc674898b7590a020f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0NDAyOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379644029", "bodyText": "The biggest reason for using abstract class (it can just be a non-final class to be honest) here was to allow re-initialization of SqliteStorageAdapter per test case without having to copy and paste the same code into each individual test. The \"utility methods\" make a direct reference to this instance, so I can't move them to a static utility class either.", "author": "raphkim", "createdAt": "2020-02-14T21:05:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYxOTgwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYxOTkzNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379619936", "bodyText": "Change to 2020 in all new files", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:02:24Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/SQLiteStorageAdapterDeleteTest.java", "diffHunk": "@@ -0,0 +1,118 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.", "originalCommit": "cc2f31027e03d1a496bed2fc674898b7590a020f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1MjUyNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379652527", "bodyText": "will do.", "author": "raphkim", "createdAt": "2020-02-14T21:28:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYxOTkzNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMDY3NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379620675", "bodyText": "A final utility class StrictMode with a single static enable method?", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:04:04Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/StorageAdapterInstrumentedTestBase.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.storage.sqlite;\n+\n+import android.content.Context;\n+import android.os.StrictMode;\n+import androidx.annotation.NonNull;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelProvider;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.core.model.query.predicate.QueryPredicate;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.testmodels.commentsblog.AmplifyModelProvider;\n+import com.amplifyframework.testutils.Await;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ * Test the functionality of {@link SQLiteStorageAdapter} operations.\n+ */\n+@SuppressWarnings(\"DesignForExtension\") // Utility methods shouldn't be overwritten\n+public abstract class StorageAdapterInstrumentedTestBase {\n+    private static final long SQLITE_OPERATION_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(2);\n+    private static final String DATABASE_NAME = \"AmplifyDatastore.db\";\n+\n+    private SQLiteStorageAdapter sqliteStorageAdapter;\n+    private Context context;\n+\n+    /**\n+     * Enable strict mode for catching SQLite leaks.\n+     */\n+    @BeforeClass\n+    public static void enableStrictMode() {", "originalCommit": "cc2f31027e03d1a496bed2fc674898b7590a020f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY1MDk5NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379650995", "bodyText": "sure thing", "author": "raphkim", "createdAt": "2020-02-14T21:24:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMDY3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMjQxMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379622411", "bodyText": "These methods should go in a class called SynchronousStorageAdapter that lives in the test sources. It would be analogous to the existing SynchronousApi and SynchronousDataStore, but it would pose a synchronous version of the storage adapter interface.\nIf you do it that way, then any test class may use this functionality, not just those who (must) extend this base class.", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:08:10Z", "path": "aws-datastore/src/androidTest/java/com/amplifyframework/datastore/storage/sqlite/StorageAdapterInstrumentedTestBase.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright 2019 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.datastore.storage.sqlite;\n+\n+import android.content.Context;\n+import android.os.StrictMode;\n+import androidx.annotation.NonNull;\n+import androidx.test.core.app.ApplicationProvider;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.core.model.Model;\n+import com.amplifyframework.core.model.ModelProvider;\n+import com.amplifyframework.core.model.ModelSchema;\n+import com.amplifyframework.core.model.query.predicate.QueryPredicate;\n+import com.amplifyframework.datastore.DataStoreException;\n+import com.amplifyframework.datastore.storage.StorageItemChange;\n+import com.amplifyframework.testmodels.commentsblog.AmplifyModelProvider;\n+import com.amplifyframework.testutils.Await;\n+\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.BeforeClass;\n+\n+import java.util.ArrayList;\n+import java.util.HashSet;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.concurrent.TimeUnit;\n+\n+import static org.junit.Assert.assertEquals;\n+\n+/**\n+ * Test the functionality of {@link SQLiteStorageAdapter} operations.\n+ */\n+@SuppressWarnings(\"DesignForExtension\") // Utility methods shouldn't be overwritten\n+public abstract class StorageAdapterInstrumentedTestBase {\n+    private static final long SQLITE_OPERATION_TIMEOUT_MS = TimeUnit.SECONDS.toMillis(2);\n+    private static final String DATABASE_NAME = \"AmplifyDatastore.db\";\n+\n+    private SQLiteStorageAdapter sqliteStorageAdapter;\n+    private Context context;\n+\n+    /**\n+     * Enable strict mode for catching SQLite leaks.\n+     */\n+    @BeforeClass\n+    public static void enableStrictMode() {\n+        StrictMode.setVmPolicy(new StrictMode.VmPolicy.Builder()\n+            .detectLeakedSqlLiteObjects()\n+            .detectLeakedClosableObjects()\n+            .penaltyLog()\n+            .penaltyDeath()\n+            .build());\n+    }\n+\n+    /**\n+     * Setup the required information for SQLiteStorageHelper construction.\n+     * @throws DataStoreException If initialization of storage adapter fails\n+     */\n+    @Before\n+    public void setUp() throws DataStoreException {\n+        context = ApplicationProvider.getApplicationContext();\n+        context.deleteDatabase(DATABASE_NAME);\n+\n+        ModelProvider modelProvider = AmplifyModelProvider.getInstance();\n+        sqliteStorageAdapter = SQLiteStorageAdapter.forModels(modelProvider);\n+        List<ModelSchema> setupResults = Await.result(\n+            SQLITE_OPERATION_TIMEOUT_MS,\n+            (Consumer<List<ModelSchema>> onResult, Consumer<DataStoreException> onError) ->\n+                sqliteStorageAdapter.initialize(context, onResult, onError)\n+        );\n+\n+        List<Class<? extends Model>> expectedModels = new ArrayList<>(modelProvider.models());\n+        expectedModels.add(StorageItemChange.Record.class); // Internal\n+        expectedModels.add(PersistentModelVersion.class); // Internal\n+        assertEquals(expectedModels.size(), setupResults.size());\n+    }\n+\n+    /**\n+     * Drop all tables and database, terminate and delete the database.\n+     * @throws DataStoreException from possible underlying DataStore exceptions\n+     */\n+    @After\n+    public void tearDown() throws DataStoreException {\n+        sqliteStorageAdapter.terminate();\n+        context.deleteDatabase(DATABASE_NAME);\n+    }\n+\n+    <T extends Model> void saveModel(@NonNull T model) throws DataStoreException {", "originalCommit": "cc2f31027e03d1a496bed2fc674898b7590a020f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMzE5OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379623198", "bodyText": "this seems dubious. If we have >5 second round trips to AppSync, we have bigger problems. I suspect there\u2019s something else going on here aside from the timeout being too short. Did you measure the response time of the actual network call?", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:10:10Z", "path": "testutils/src/main/java/com/amplifyframework/testutils/SynchronousApi.java", "diffHunk": "@@ -45,6 +46,10 @@\n  * performing various operations.\n  */\n public final class SynchronousApi {\n+\n+    private static final long EXTENDED_TIMEOUT_IN_MILLISECONDS =\n+            TimeUnit.SECONDS.toMillis(10); // 5 seconds is insufficient", "originalCommit": "cc2f31027e03d1a496bed2fc674898b7590a020f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY0MDk2MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379640960", "bodyText": "Actually, the problem existed mainly for the tests that were authenticated via IAM. I believe the most significant delay stemmed from IAM authentication rather than the AppSync itself. I can isolate the extended timeout just for just those tests if you would prefer it that way?", "author": "raphkim", "createdAt": "2020-02-14T20:57:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMzE5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY5NDQzMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/263#discussion_r379694431", "bodyText": "Ahh okay! Hm, you could. Or at least a comment. A self-documenting approach would be to name the timeout like IAM_PLUS_APPSYNC_TIMEOUT or something", "author": "jamesonwilliams", "createdAt": "2020-02-14T23:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYyMzE5OA=="}], "type": "inlineReview"}, {"oid": "44f10a27884bfac102bb138e2c09f30f2925ae85", "url": "https://github.com/aws-amplify/amplify-android/commit/44f10a27884bfac102bb138e2c09f30f2925ae85", "message": "Update copyright year", "committedDate": "2020-02-14T21:23:03Z", "type": "commit"}, {"oid": "7fb36a2abb3df74774b9f112ad5950a9381d2e6f", "url": "https://github.com/aws-amplify/amplify-android/commit/7fb36a2abb3df74774b9f112ad5950a9381d2e6f", "message": "Remove time threshold for auth failure since latch takes care of it", "committedDate": "2020-02-14T21:52:27Z", "type": "commit"}]}