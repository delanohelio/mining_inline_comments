{"pr_number": 622, "pr_title": "Show and hide dev menu on device shake or keyboard shortcut", "pr_createdAt": "2020-07-02T18:44:15Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/622", "timeline": [{"oid": "2416f3bce777a4b79a7e5e9816bf998dd1c601d3", "url": "https://github.com/aws-amplify/amplify-android/commit/2416f3bce777a4b79a7e5e9816bf998dd1c601d3", "message": "created activity to display dev menu from context and updated package name", "committedDate": "2020-06-24T18:41:41Z", "type": "commit"}, {"oid": "0fbba26fe8dcf30cc52c61b0465f7450caa27181", "url": "https://github.com/aws-amplify/amplify-android/commit/0fbba26fe8dcf30cc52c61b0465f7450caa27181", "message": "start the developer menu activity and display developer menu on bottom of screen", "committedDate": "2020-06-24T23:49:57Z", "type": "commit"}, {"oid": "fe55183e7c1e640cce2d383d7048a9664c0bc4a1", "url": "https://github.com/aws-amplify/amplify-android/commit/fe55183e7c1e640cce2d383d7048a9664c0bc4a1", "message": "changed styling of dev menu to overlay current view", "committedDate": "2020-06-26T15:04:40Z", "type": "commit"}, {"oid": "d5d1d3706b4580ff63d8bb1248969a5196db7a38", "url": "https://github.com/aws-amplify/amplify-android/commit/d5d1d3706b4580ff63d8bb1248969a5196db7a38", "message": "Merge branch 'main' into eeatonaws-dev-menu", "committedDate": "2020-06-26T15:10:02Z", "type": "commit"}, {"oid": "3782d18333b185ece108abda0004066a45b7d474", "url": "https://github.com/aws-amplify/amplify-android/commit/3782d18333b185ece108abda0004066a45b7d474", "message": "updated copyright year", "committedDate": "2020-06-29T20:33:08Z", "type": "commit"}, {"oid": "c7835d544c14244e76378be421f6efed13cb881b", "url": "https://github.com/aws-amplify/amplify-android/commit/c7835d544c14244e76378be421f6efed13cb881b", "message": "Merge branch 'main' into eeatonaws-dev-menu", "committedDate": "2020-06-29T22:12:54Z", "type": "commit"}, {"oid": "52b2dbce3cb491ea6ee6823e7e8e5cea6d8855cd", "url": "https://github.com/aws-amplify/amplify-android/commit/52b2dbce3cb491ea6ee6823e7e8e5cea6d8855cd", "message": "only display dev menu if in debug mode", "committedDate": "2020-06-30T16:44:27Z", "type": "commit"}, {"oid": "f08434b9b85c84306bfe396e190946d43998e126", "url": "https://github.com/aws-amplify/amplify-android/commit/f08434b9b85c84306bfe396e190946d43998e126", "message": "Merge branch 'DevMenu' into eeatonaws-dev-menu and fix merge conflict.", "committedDate": "2020-06-30T16:52:01Z", "type": "commit"}, {"oid": "71a07d475dee8b572fd77c031805f1649475322c", "url": "https://github.com/aws-amplify/amplify-android/commit/71a07d475dee8b572fd77c031805f1649475322c", "message": "activate dev menu on device shake or keyboard shortcut", "committedDate": "2020-07-01T21:22:18Z", "type": "commit"}, {"oid": "36481de3107cc22c71b57c0257b33ac63cfd1dd9", "url": "https://github.com/aws-amplify/amplify-android/commit/36481de3107cc22c71b57c0257b33ac63cfd1dd9", "message": "Merge branch 'main' into eeatonaws-dev-menu", "committedDate": "2020-07-01T22:14:19Z", "type": "commit"}, {"oid": "ae96c687d4c01486acf0047a5362d6384513d27f", "url": "https://github.com/aws-amplify/amplify-android/commit/ae96c687d4c01486acf0047a5362d6384513d27f", "message": "adjusted shake threshold", "committedDate": "2020-07-02T18:31:13Z", "type": "commit"}, {"oid": "59f95d076adafdd81a4e5db3428fc9de81962044", "url": "https://github.com/aws-amplify/amplify-android/commit/59f95d076adafdd81a4e5db3428fc9de81962044", "message": "Merge branch 'DevMenu' into eeatonaws-dev-menu", "committedDate": "2020-07-02T18:36:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI0ODUxOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450248519", "bodyText": "These should probably be listed above the event listener, especially since the listener references shakeStart.", "author": "TrekSoft", "createdAt": "2020-07-06T14:11:47Z", "path": "core/src/main/java/com/amplifyframework/core/DeveloperMenuActivity.java", "diffHunk": "@@ -16,16 +16,112 @@\n package com.amplifyframework.core;\n \n import android.app.Activity;\n+import android.content.Context;\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n import android.os.Bundle;\n+import android.view.KeyEvent;\n+import android.view.View;\n+\n+import com.amplifyframework.util.Time;\n \n /**\n  * This is the activity to display the developer menu.\n  */\n public final class DeveloperMenuActivity extends Activity {\n+    // A device movement is classified as a shake if the acceleration\n+    // is above this threshold.\n+    private static final double SHAKE_THRESHOLD = 11.7;\n+    // The minimum duration (in milliseconds) that the device needs to\n+    // be shaken in order to make the developer menu appear or disappear.\n+    private static final int SHAKE_TIME = 500;\n+\n+    // Listen to accelerometer sensor events.\n+    private final SensorEventListener sensorEventListener = new SensorEventListener() {\n+        @Override\n+        public void onSensorChanged(SensorEvent sensorEvent) {\n+            float xAccel = sensorEvent.values[0]; // acceleration in the x-direction\n+            float yAccel = sensorEvent.values[1]; // acceleration in the y-direction\n+            float zAccel = sensorEvent.values[2]; // acceleration in the z-direction\n+            double curAcceleration = Math.sqrt(((xAccel * xAccel) + (yAccel * yAccel) + (zAccel * zAccel)));\n+            if (curAcceleration > SHAKE_THRESHOLD) {\n+                long currentTime = Time.now();\n+                if (shakeStart == 0) {\n+                    shakeStart = currentTime;\n+                } else if (currentTime - shakeStart > SHAKE_TIME) {\n+                    changeVisibility();\n+                    shakeStart = 0;\n+                }\n+            }\n+        }\n+\n+        @Override\n+        public void onAccuracyChanged(Sensor sensor, int accuracy) { }\n+    };\n+\n+    // Manager for the device's sensors.\n+    private SensorManager sensorManager;", "originalCommit": "59f95d076adafdd81a4e5db3428fc9de81962044", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI1MDUxMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450250512", "bodyText": "Should super.onKeyUp only be called if it's not matching the keycode? It seems like something that should always be called.", "author": "TrekSoft", "createdAt": "2020-07-06T14:14:45Z", "path": "core/src/main/java/com/amplifyframework/core/DeveloperMenuActivity.java", "diffHunk": "@@ -16,16 +16,112 @@\n package com.amplifyframework.core;\n \n import android.app.Activity;\n+import android.content.Context;\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n import android.os.Bundle;\n+import android.view.KeyEvent;\n+import android.view.View;\n+\n+import com.amplifyframework.util.Time;\n \n /**\n  * This is the activity to display the developer menu.\n  */\n public final class DeveloperMenuActivity extends Activity {\n+    // A device movement is classified as a shake if the acceleration\n+    // is above this threshold.\n+    private static final double SHAKE_THRESHOLD = 11.7;\n+    // The minimum duration (in milliseconds) that the device needs to\n+    // be shaken in order to make the developer menu appear or disappear.\n+    private static final int SHAKE_TIME = 500;\n+\n+    // Listen to accelerometer sensor events.\n+    private final SensorEventListener sensorEventListener = new SensorEventListener() {\n+        @Override\n+        public void onSensorChanged(SensorEvent sensorEvent) {\n+            float xAccel = sensorEvent.values[0]; // acceleration in the x-direction\n+            float yAccel = sensorEvent.values[1]; // acceleration in the y-direction\n+            float zAccel = sensorEvent.values[2]; // acceleration in the z-direction\n+            double curAcceleration = Math.sqrt(((xAccel * xAccel) + (yAccel * yAccel) + (zAccel * zAccel)));\n+            if (curAcceleration > SHAKE_THRESHOLD) {\n+                long currentTime = Time.now();\n+                if (shakeStart == 0) {\n+                    shakeStart = currentTime;\n+                } else if (currentTime - shakeStart > SHAKE_TIME) {\n+                    changeVisibility();\n+                    shakeStart = 0;\n+                }\n+            }\n+        }\n+\n+        @Override\n+        public void onAccuracyChanged(Sensor sensor, int accuracy) { }\n+    };\n+\n+    // Manager for the device's sensors.\n+    private SensorManager sensorManager;\n+    // The accelerometer sensor associated with the device.\n+    private Sensor accelerometer;\n+    // The time (in milliseconds) that the device started shaking\n+    // (or 0 if the device is not shaking).\n+    private long shakeStart;\n+    // The parent layout for the developer menu.\n+    private View devMenuLayout;\n \n     @Override\n     protected void onCreate(Bundle savedInstanceState) {\n         super.onCreate(savedInstanceState);\n         setContentView(R.layout.activity_dev_menu);\n+        sensorManager = (SensorManager) getSystemService(Context.SENSOR_SERVICE);\n+        if (sensorManager != null) {\n+            accelerometer = sensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);\n+        }\n+        devMenuLayout = findViewById(R.id.devLayout);\n+        devMenuLayout.setFocusable(true);\n+        devMenuLayout.setVisibility(View.GONE);\n+        shakeStart = 0;\n+    }\n+\n+    @Override\n+    protected void onResume() {\n+        if (accelerometer != null) {\n+            sensorManager.registerListener(sensorEventListener, accelerometer, SensorManager.SENSOR_DELAY_NORMAL);\n+        }\n+        super.onResume();\n+    }\n+\n+    @Override\n+    protected void onPause() {\n+        if (accelerometer != null) {\n+            sensorManager.unregisterListener(sensorEventListener);\n+        }\n+        super.onPause();\n+    }\n+\n+    @Override\n+    public boolean onKeyUp(int keyCode, KeyEvent event) {\n+        // KEYCODE_MENU is the code for pressing ctrl\n+        // (or command) + m\n+        if (keyCode == KeyEvent.KEYCODE_MENU) {\n+            changeVisibility();\n+            return true;\n+        } else {\n+            return super.onKeyUp(keyCode, event);", "originalCommit": "59f95d076adafdd81a4e5db3428fc9de81962044", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI3NzI5Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450277296", "bodyText": "In examples in the Android documentation, they override onKeyUp in a similar manner (only returning super.onKeyUp if the keycode doesn't match a certain value). Also, if I change the code to always return super.onKeyUp, even if the keycode matches the one for ctrl+m, then the visibility of the developer menu is only changed the first two times I press ctrl+m.", "author": "eeatonaws", "createdAt": "2020-07-06T14:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI1MDUxMg=="}], "type": "inlineReview"}, {"oid": "e860ea2b7300e055bca4f7f63c49c133d31734c6", "url": "https://github.com/aws-amplify/amplify-android/commit/e860ea2b7300e055bca4f7f63c49c133d31734c6", "message": "reordered fields in DeveloperMenuActivity", "committedDate": "2020-07-06T14:34:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2MjQyNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450362425", "bodyText": "If I'm reading this correctly, Amplify would keep the accelerometer active at all times, to receive sensor data, so it can detect a shake. This will drain the battery, so we need a different solution. What mechanisms can you put in place to limit the lifecycle of the accelerometer? How can you prevent this from running \"most of the time\", when Amplify is in production?", "author": "jamesonwilliams", "createdAt": "2020-07-06T17:06:07Z", "path": "core/src/main/java/com/amplifyframework/core/DeveloperMenuActivity.java", "diffHunk": "@@ -16,16 +16,112 @@\n package com.amplifyframework.core;\n \n import android.app.Activity;\n+import android.content.Context;\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n import android.os.Bundle;\n+import android.view.KeyEvent;\n+import android.view.View;\n+\n+import com.amplifyframework.util.Time;\n \n /**\n  * This is the activity to display the developer menu.\n  */\n public final class DeveloperMenuActivity extends Activity {\n+    // A device movement is classified as a shake if the acceleration\n+    // is above this threshold.\n+    private static final double SHAKE_THRESHOLD = 11.7;\n+    // The minimum duration (in milliseconds) that the device needs to\n+    // be shaken in order to make the developer menu appear or disappear.\n+    private static final int SHAKE_TIME = 500;\n+\n+    // Manager for the device's sensors.\n+    private SensorManager sensorManager;\n+    // The accelerometer sensor associated with the device.\n+    private Sensor accelerometer;\n+    // The time (in milliseconds) that the device started shaking\n+    // (or 0 if the device is not shaking).\n+    private long shakeStart;\n+    // The parent layout for the developer menu.\n+    private View devMenuLayout;\n+\n+    // Listen to accelerometer sensor events.\n+    private final SensorEventListener sensorEventListener = new SensorEventListener() {\n+        @Override\n+        public void onSensorChanged(SensorEvent sensorEvent) {\n+            float xAccel = sensorEvent.values[0]; // acceleration in the x-direction\n+            float yAccel = sensorEvent.values[1]; // acceleration in the y-direction\n+            float zAccel = sensorEvent.values[2]; // acceleration in the z-direction\n+            double curAcceleration = Math.sqrt(((xAccel * xAccel) + (yAccel * yAccel) + (zAccel * zAccel)));\n+            if (curAcceleration > SHAKE_THRESHOLD) {\n+                long currentTime = Time.now();\n+                if (shakeStart == 0) {\n+                    shakeStart = currentTime;\n+                } else if (currentTime - shakeStart > SHAKE_TIME) {\n+                    changeVisibility();\n+                    shakeStart = 0;\n+                }\n+            }\n+        }\n+\n+        @Override\n+        public void onAccuracyChanged(Sensor sensor, int accuracy) { }\n+    };\n \n     @Override\n     protected void onCreate(Bundle savedInstanceState) {\n         super.onCreate(savedInstanceState);\n         setContentView(R.layout.activity_dev_menu);\n+        sensorManager = (SensorManager) getSystemService(Context.SENSOR_SERVICE);\n+        if (sensorManager != null) {\n+            accelerometer = sensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER);\n+        }\n+        devMenuLayout = findViewById(R.id.devLayout);\n+        devMenuLayout.setFocusable(true);\n+        devMenuLayout.setVisibility(View.GONE);\n+        shakeStart = 0;\n+    }\n+\n+    @Override\n+    protected void onResume() {\n+        if (accelerometer != null) {\n+            sensorManager.registerListener(sensorEventListener, accelerometer, SensorManager.SENSOR_DELAY_NORMAL);", "originalCommit": "e860ea2b7300e055bca4f7f63c49c133d31734c6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2NTIxOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450365219", "bodyText": "When you say \"Amplify is in production\", are you referring to when the developer is using Amplify in their app and their app is in production (release build)?", "author": "eeatonaws", "createdAt": "2020-07-06T17:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2MjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4NTE2NA==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450385164", "bodyText": "Yes!", "author": "jamesonwilliams", "createdAt": "2020-07-06T17:50:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2MjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM4ODI4OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450388288", "bodyText": "The developer menu will only be activated for a debuggable build, not for release builds (I added a check in Amplify.java in a previous PR that only starts the developer menu activity if the build is debuggable).", "author": "eeatonaws", "createdAt": "2020-07-06T17:56:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2MjQyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ0NjE2MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450446161", "bodyText": "Okay, great. Thanks for reminding me. It's my job to be paranoid about it. :-D", "author": "jamesonwilliams", "createdAt": "2020-07-06T19:53:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDM2MjQyNQ=="}], "type": "inlineReview"}, {"oid": "79bead5640b823697e44c5b5480093dd1b98da10", "url": "https://github.com/aws-amplify/amplify-android/commit/79bead5640b823697e44c5b5480093dd1b98da10", "message": "factor shake detection logic out into separate class", "committedDate": "2020-07-06T19:00:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ5ODc5MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450498790", "bodyText": "Still sort of \"leaking\" a detail of the ShakeDetector, here. I'd grab this off the context internally.", "author": "jamesonwilliams", "createdAt": "2020-07-06T21:51:58Z", "path": "core/src/main/java/com/amplifyframework/core/DeveloperMenuActivity.java", "diffHunk": "@@ -16,16 +16,65 @@\n package com.amplifyframework.core;\n \n import android.app.Activity;\n+import android.content.Context;\n+import android.hardware.SensorManager;", "originalCommit": "79bead5640b823697e44c5b5480093dd1b98da10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ5ODkyNg==", "url": "https://github.com/aws-amplify/amplify-android/pull/622#discussion_r450498926", "bodyText": "You'll want to add a unit test for this.", "author": "jamesonwilliams", "createdAt": "2020-07-06T21:52:17Z", "path": "core/src/main/java/com/amplifyframework/core/ShakeDetector.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core;\n+\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n+\n+import com.amplifyframework.util.Time;\n+\n+/**\n+ * Detects a device shake event.\n+ */\n+public final class ShakeDetector {", "originalCommit": "79bead5640b823697e44c5b5480093dd1b98da10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}