{"pr_number": 217, "pr_title": "[API] Fixes #187: Subscription blocking + web socket connection error not correctly reported", "pr_createdAt": "2020-01-03T20:08:08Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/217", "timeline": [{"oid": "3c9f09a0e956aaac05a2a24c7b1984965dd4c4aa", "url": "https://github.com/aws-amplify/amplify-android/commit/3c9f09a0e956aaac05a2a24c7b1984965dd4c4aa", "message": "Fix for issue #187", "committedDate": "2020-01-03T19:56:35Z", "type": "commit"}, {"oid": "c78c140afa0167baa493885a58979ef4d1b77416", "url": "https://github.com/aws-amplify/amplify-android/commit/c78c140afa0167baa493885a58979ef4d1b77416", "message": "Fixed linting issues", "committedDate": "2020-01-03T20:02:59Z", "type": "commit"}, {"oid": "c51b91881729a6e9116470c545ef0ad26bfdf541", "url": "https://github.com/aws-amplify/amplify-android/commit/c51b91881729a6e9116470c545ef0ad26bfdf541", "message": "Reset connection failure on new request", "committedDate": "2020-01-03T20:04:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2MzU5Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362963592", "bodyText": "This variable was named connectionAcknowledgement since it was in response to a connection_ack message type. If we use it for two distinct (though closely related purposes), perhaps it should be renamed as connectionResponsesPending, or something.", "author": "jamesonwilliams", "createdAt": "2020-01-03T21:15:16Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -195,6 +200,10 @@ private void processJsonMessage(WebSocket webSocket, String message) throws ApiE\n                     );\n                     connectionAcknowledgement.countDown();\n                     break;\n+                case CONNECTION_ERROR:\n+                    connectionFailure = message;\n+                    connectionAcknowledgement.countDown();", "originalCommit": "c51b91881729a6e9116470c545ef0ad26bfdf541", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NjE0NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362966145", "bodyText": "Makes sense", "author": "TrekSoft", "createdAt": "2020-01-03T21:24:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2MzU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NTEwNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362965105", "bodyText": "Since this is in response to a bug report, and is the primary intent of the PR, we should add some test to cover this scenario.", "author": "jamesonwilliams", "createdAt": "2020-01-03T21:20:51Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionEndpoint.java", "diffHunk": "@@ -77,23 +77,32 @@\n \n         if (webSocket == null) {\n             try {\n+                connectionFailure = null;\n                 webSocket = createWebSocket();\n             } catch (ApiException exception) {\n                 responseListener.onError(new ApiException(\n                         \"Failed to create websocket for subscription\",\n                         exception,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n             }\n \n             try {\n                 connectionAcknowledgement.await(CONNECTION_ACKNOWLEDGEMENT_TIMEOUT, TimeUnit.SECONDS);\n-            } catch (InterruptedException interruptedException) {\n+            } catch (InterruptedException interruptedException) { }\n+\n+            if (connectionAcknowledgement.getCount() != 0) {\n                 responseListener.onError(new ApiException(\n                         \"Subscription timed out waiting for acknowledgement\",\n-                        interruptedException,\n                         AmplifyException.TODO_RECOVERY_SUGGESTION\n                 ));\n+                return null;\n+            } else if (connectionFailure != null) {\n+                responseListener.onError(\n+                    new ApiException(connectionFailure, \"Check if you are authorized to make this subscription\")", "originalCommit": "c51b91881729a6e9116470c545ef0ad26bfdf541", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NjI0Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362966246", "bodyText": "Alright - also in running the integration tests I'm seeing a problem with a normal subscription now so trying to figure out the issue.", "author": "TrekSoft", "createdAt": "2020-01-03T21:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NTEwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NjcyMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r362966723", "bodyText": "It might be the race condition we were talking about earlier, where a couple of different tests try to use subscriptions for the same model type, but the order of execution of the tests matters, or something?", "author": "jamesonwilliams", "createdAt": "2020-01-03T21:27:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk2NTEwNQ=="}], "type": "inlineReview"}, {"oid": "554986ae59ae9e3d82c98ab33edb217b6eb67d84", "url": "https://github.com/aws-amplify/amplify-android/commit/554986ae59ae9e3d82c98ab33edb217b6eb67d84", "message": "Adds/fixes integ tests", "committedDate": "2020-01-06T16:21:04Z", "type": "commit"}, {"oid": "9973478f35e7eb02d0e18b2e16de35e04170057e", "url": "https://github.com/aws-amplify/amplify-android/commit/9973478f35e7eb02d0e18b2e16de35e04170057e", "message": "Fixes integ tests", "committedDate": "2020-01-06T16:36:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODQzMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363498431", "bodyText": "is this in-line with the recent changes that Jameson made to accommodate lambdas?", "author": "raphkim", "createdAt": "2020-01-06T21:46:40Z", "path": "aws-api/src/main/java/com/amplifyframework/api/aws/SubscriptionOperation.java", "diffHunk": "@@ -47,12 +49,14 @@ private SubscriptionOperation(\n             @NonNull final OkHttpClient client,\n             @NonNull final GraphQLRequest<T> graphQLRequest,\n             @NonNull final GraphQLResponse.Factory responseFactory,\n-            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener) {\n+            @NonNull final StreamListener<GraphQLResponse<T>, ApiException> subscriptionListener,", "originalCommit": "9973478f35e7eb02d0e18b2e16de35e04170057e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5OTI0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r364499241", "bodyText": "Updated PR to account for this", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:45:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzQ5ODQzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyNzY5Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363527696", "bodyText": "Instead of defining this constant, you could consider to use TimeUnit.SECONDS.toMilliseconds(1) as an in-line constant - or atlernately, use a semantic label, like:\nprivate static final int MAX_SUBSCRIPTION_FAILURE_TIME_MS = TimeUnit.SECONDS.toMillseconds(1);\n\nwhich sort of achieves two purposes of documentation - how long it is, and what it purpose is", "author": "jamesonwilliams", "createdAt": "2020-01-06T23:15:46Z", "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -45,6 +47,9 @@\n     private static final String PERSON_API_NAME = \"personApi\";\n     private static final String PROJECT_API_NAME = \"projectApi\";\n     private static final String BLOG_API_NAME = \"blogApi\";\n+    private static final String NOTES_WITH_AUTH_API_NAME = \"notesWithAuthApi\";\n+\n+    private static final int ONE_SECOND_OF_MILLISECONDS = 1000;", "originalCommit": "9973478f35e7eb02d0e18b2e16de35e04170057e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5ODkyMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r364498922", "bodyText": "Updated PR", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:44:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyNzY5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyODE2Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r363528167", "bodyText": "Ah crumbs. I think this is why I had left this part of the method as blocking. If the subscription call returns before getting acknowledgement, we have this new issue - how to do we convey the acknowledgement to the user? It used to be synonymous with getting a subscription ID back.\nThe user would also need to sleep for a random amount of time, like this test does.\nIf that part is now async, we can provide the information with a callback. Like:\n/**\n * Subscribe to mutations that occur for a given model class.\n * @param clazz Type of model being subscribed\n * @param subscriptionType type of events to subscribe to\n * @param onSubscriptionStarted Called when a subscription begins; a subscription ID is passed\n * @param onNextItem Called when a new subscription item is available\n * @param onSubscriptionFailed Called when the subscription terminates due to a failure\n * @param onSubscriptionCompleted Called when a subscription terminates gracefully\n */\n<T extends Model> void subscribe(\n    Class<T> clazz,\n    SubscriptionType subscriptionType,\n    Consumer<String> onSubscriptionStarted,\n    Consumer<T> onNextItem,\n    Consumer<ApiException> onSubscriptionFailed,\n    Action onSubscriptionCompleted\n);\n\nAm (irrelevant) note on mechanics, here -- you can use the Sleep#milliseconds(long) test utility to clean things up a bit and get rid of this exception block.", "author": "jamesonwilliams", "createdAt": "2020-01-06T23:17:32Z", "path": "aws-api/src/androidTest/java/com/amplifyframework/api/aws/CodeGenerationInstrumentationTest.java", "diffHunk": "@@ -118,6 +123,12 @@ public void subscribeReceivesMutationEvent() {\n         SynchronousApi.Subscription<Person> subscription =\n             api.onCreate(PERSON_API_NAME, Person.class);\n \n+        // Give the subscription time to complete the connection before running the mutation.\n+        // This should happen within 1 second - if not, it's good that this fails so we can investigate.\n+        try {\n+            Thread.sleep(ONE_SECOND_OF_MILLISECONDS);\n+        } catch (InterruptedException exception) { }", "originalCommit": "9973478f35e7eb02d0e18b2e16de35e04170057e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDQ5OTA4Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/217#discussion_r364499086", "bodyText": "Updated PR to do this", "author": "jamesonwilliams", "createdAt": "2020-01-08T23:44:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzUyODE2Nw=="}], "type": "inlineReview"}, {"oid": "06e1c03dcf102dc5634601fd80da1fc47c6a7874", "url": "https://github.com/aws-amplify/amplify-android/commit/06e1c03dcf102dc5634601fd80da1fc47c6a7874", "message": "Merge remote-tracking branch 'origin/master' into fix187", "committedDate": "2020-01-08T23:38:08Z", "type": "commit"}, {"oid": "0acb9a08ad0f02eebfe176d0323b94fcf89c126c", "url": "https://github.com/aws-amplify/amplify-android/commit/0acb9a08ad0f02eebfe176d0323b94fcf89c126c", "message": "Remove wait from GraphQLInstrumentationTest", "committedDate": "2020-01-08T23:39:50Z", "type": "commit"}]}