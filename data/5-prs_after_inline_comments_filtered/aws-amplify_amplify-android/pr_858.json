{"pr_number": 858, "pr_title": "fix(aws-datastore): make subscription timeout model count dependent", "pr_createdAt": "2020-09-25T10:24:00Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/858", "timeline": [{"oid": "9c721b54a544044ce38ec2aba203b0ebf2b4891e", "url": "https://github.com/aws-amplify/amplify-android/commit/9c721b54a544044ce38ec2aba203b0ebf2b4891e", "message": "make orchestrator timeout model count dependent", "committedDate": "2020-09-25T10:22:12Z", "type": "commit"}, {"oid": "a35a6302434e8014d19280f143f87a82f3f32710", "url": "https://github.com/aws-amplify/amplify-android/commit/a35a6302434e8014d19280f143f87a82f3f32710", "message": "add timeout extension to subscription processor", "committedDate": "2020-09-25T17:42:17Z", "type": "commit"}, {"oid": "5e7255e2c944c993331b21f95537e4ec96b0f3cd", "url": "https://github.com/aws-amplify/amplify-android/commit/5e7255e2c944c993331b21f95537e4ec96b0f3cd", "message": "adjust time unit", "committedDate": "2020-09-25T18:06:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTI0MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495209241", "bodyText": "Here, the timeout is being applied \"outside of\" stopApiSync(). For startApiSync(), though, the timeout is applied inside, on the syncProcessor.hydrate(). Is there any way to change this, so that the blocking timeout happens at the same abstraction level, on start/stop APIs, as opposed to on stop, and on a detail of start?", "author": "jamesonwilliams", "createdAt": "2020-09-25T20:13:06Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +321,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean subscribed = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);", "originalCommit": "5e7255e2c944c993331b21f95537e4ec96b0f3cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIzOTY4Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495239686", "bodyText": "For the start scenario, we also have to take into account that we block inside the SubscriptionProcessor as well as on the call to syncProcessor.hydrate() as you pointed out. So if we move the timeout higher in the call hierarchy (for start), we'll have to make sure that timeout is doubled since the worst case scenario would be for both SubscriptionProcessor and SyncProcessor to take numberOfModels* TIMEOUT_SECONDS_PER_MODEL seconds", "author": "rjuliano", "createdAt": "2020-09-25T21:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTI0MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM4MjUyOQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498382529", "bodyText": "I think this effort is unnecessary. Correct me if i'm wrong, but shouldn't blockingAwait() be applied to any operation where you want to ensure that it is completed before moving onto the next instruction? What is the purpose of putting a blocking await on the entire startApiSync() method instead of on its components that actually need it?", "author": "raphkim", "createdAt": "2020-10-01T16:45:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTI0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTkxMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495209913", "bodyText": "I could be wrong, here, but I believe this timeout should be way shorter. Starting the subscription to the local storage should be O(ms), to complete a CPU-bound operation.\nThe sync and subscription timeouts are different. Both involve k-many network operations. They're like the opposite, basically.\nShould the storage observer timeout be more like ~2 seconds?", "author": "jamesonwilliams", "createdAt": "2020-09-25T20:14:49Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -241,11 +251,14 @@ private Completable transitionToApiSync(Mode current) {\n     private void startObservingStorageChanges() {\n         LOG.info(\"Starting to observe local storage changes.\");\n         try {\n-            mutationOutbox.load()\n+            boolean subscribed = mutationOutbox.load()\n                 .andThen(Completable.create(emitter -> {\n                     storageObserver.startObservingStorageChanges(emitter::onComplete);\n                     currentMode.set(Mode.LOCAL_ONLY);\n-                })).blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                })).blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);\n+            if (!subscribed) {\n+                throw new TimeoutException(\"Subscription timed out.\");\n+            }", "originalCommit": "5e7255e2c944c993331b21f95537e4ec96b0f3cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIxNjY0Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495216646", "bodyText": "I think that sounds about right. This chunk of code reads from the sqlite db and loads any existing mutations into memory and then starts observing any new changes after that. 2 seconds should be sufficient here since it's not really dependent on the number of models", "author": "rjuliano", "createdAt": "2020-09-25T20:30:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTkxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI0MTQ4OA==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495241488", "bodyText": "^ Ah good call out, though. We should find out whether or not this triggers loading of the queue from SQL. A disk-bound timeout will be different than a CPU-bound timeout.", "author": "jamesonwilliams", "createdAt": "2020-09-25T21:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIwOTkxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIyMTIwMQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495221201", "bodyText": "Probably need a different error message here since stopApiSync is not just related to subscriptions. It also stops the mutation processor.", "author": "rjuliano", "createdAt": "2020-09-25T20:42:21Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +321,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean subscribed = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);\n+            if (!subscribed) {\n+                throw new TimeoutException(\"Subscription timed out.\");", "originalCommit": "5e7255e2c944c993331b21f95537e4ec96b0f3cd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTI0MjQ2NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r495242465", "bodyText": "The \"do online stuff\" orchestrator mode is currently called SYNC_VIA_API. If we change this language here, we should keep both in sync. Maybe it would make more sense to simply call this ONLINE mode? startOnlineBehaviors() and stopOnlineBehaviors()?\nNote: we should do this in a separate PR.", "author": "jamesonwilliams", "createdAt": "2020-09-25T21:25:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTIyMTIwMQ=="}], "type": "inlineReview"}, {"oid": "d29b25a43e3313b44f273da6e5174347a7b594f4", "url": "https://github.com/aws-amplify/amplify-android/commit/d29b25a43e3313b44f273da6e5174347a7b594f4", "message": "reduce local storage observe timeout", "committedDate": "2020-10-01T16:26:21Z", "type": "commit"}, {"oid": "452158568309a34aab4e18e9722e77c2b4529e43", "url": "https://github.com/aws-amplify/amplify-android/commit/452158568309a34aab4e18e9722e77c2b4529e43", "message": "redescribe error message for stop api sync timeout", "committedDate": "2020-10-01T16:45:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDA0Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620047", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new TimeoutException(\"Subscription timed out.\");\n          \n          \n            \n                            throw new TimeoutException(\"Timed out while preparing local-only mode.\");", "author": "jamesonwilliams", "createdAt": "2020-10-02T05:05:54Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -241,11 +252,14 @@ private Completable transitionToApiSync(Mode current) {\n     private void startObservingStorageChanges() {\n         LOG.info(\"Starting to observe local storage changes.\");\n         try {\n-            mutationOutbox.load()\n+            boolean subscribed = mutationOutbox.load()\n                 .andThen(Completable.create(emitter -> {\n                     storageObserver.startObservingStorageChanges(emitter::onComplete);\n                     currentMode.set(Mode.LOCAL_ONLY);\n-                })).blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                })).blockingAwait(LOCAL_OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+            if (!subscribed) {\n+                throw new TimeoutException(\"Subscription timed out.\");", "originalCommit": "452158568309a34aab4e18e9722e77c2b4529e43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDE1NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620155", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                throw new TimeoutException(\"Subscription timed out.\");\n          \n          \n            \n                                throw new TimeoutException(\"Timed out while performing initial model sync.\");", "author": "jamesonwilliams", "createdAt": "2020-10-02T05:06:32Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -272,8 +286,11 @@ private Completable startApiSync() {\n \n             LOG.debug(\"About to hydrate...\");\n             try {\n-                syncProcessor.hydrate()\n-                    .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                boolean subscribed = syncProcessor.hydrate()\n+                    .blockingAwait(adjustedTimeoutSeconds, TimeUnit.SECONDS);\n+                if (!subscribed) {\n+                    throw new TimeoutException(\"Subscription timed out.\");", "originalCommit": "452158568309a34aab4e18e9722e77c2b4529e43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDI2Mg==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620262", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new TimeoutException(\"Operation timed out.\");\n          \n          \n            \n                            throw new TimeoutException(\"Timed out while waiting for API synchronization to end.\");", "author": "jamesonwilliams", "createdAt": "2020-10-02T05:07:03Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +322,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean stopped = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(LOCAL_OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+            if (!stopped) {\n+                throw new TimeoutException(\"Operation timed out.\");", "originalCommit": "452158568309a34aab4e18e9722e77c2b4529e43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODYyMDM1OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/858#discussion_r498620359", "bodyText": "This is probably actually be a network op, since it has to send the stop messages on the WebSocket subscription. May want to use the long timeout for this one.", "author": "jamesonwilliams", "createdAt": "2020-10-02T05:07:42Z", "path": "aws-datastore/src/main/java/com/amplifyframework/datastore/syncengine/Orchestrator.java", "diffHunk": "@@ -305,9 +322,12 @@ private Completable startApiSync() {\n \n     private void stopApiSyncBlocking() {\n         try {\n-            stopApiSync()\n+            boolean stopped = stopApiSync()\n                 .subscribeOn(startStopScheduler)\n-                .blockingAwait(OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);\n+                .blockingAwait(LOCAL_OP_TIMEOUT_SECONDS, TimeUnit.SECONDS);", "originalCommit": "452158568309a34aab4e18e9722e77c2b4529e43", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e4f8141f0d769ee91f8fabb1d83c5491f961a349", "url": "https://github.com/aws-amplify/amplify-android/commit/e4f8141f0d769ee91f8fabb1d83c5491f961a349", "message": "Apply suggestions from code review\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>", "committedDate": "2020-10-05T21:15:16Z", "type": "commit"}, {"oid": "e4f8141f0d769ee91f8fabb1d83c5491f961a349", "url": "https://github.com/aws-amplify/amplify-android/commit/e4f8141f0d769ee91f8fabb1d83c5491f961a349", "message": "Apply suggestions from code review\n\nCo-authored-by: Jameson Williams <jhwill@amazon.com>", "committedDate": "2020-10-05T21:15:16Z", "type": "forcePushed"}]}