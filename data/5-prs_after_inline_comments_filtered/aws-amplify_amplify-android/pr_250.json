{"pr_number": 250, "pr_title": "Category tweaks", "pr_createdAt": "2020-01-29T03:14:45Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/250", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEzNzg1OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/250#discussion_r373137859", "bodyText": "We discussed a bug about this :)\nShould have validateConfigured() and throwIfConfigured() separately to clearly indicate two validation cases", "author": "raphkim", "createdAt": "2020-01-30T19:07:55Z", "path": "core/src/main/java/com/amplifyframework/core/category/Category.java", "diffHunk": "@@ -167,35 +162,56 @@ public final P getPlugin(@NonNull final String pluginKey) {\n      */\n     @NonNull\n     public final Set<P> getPlugins() {\n-        return new HashSet<>(plugins.values());\n+        return Immutable.of(new HashSet<>(plugins.values()));\n     }\n \n     /**\n      * Obtain the registered plugin for this category.\n      * @return The only registered plugin for this category\n      * @throws IllegalStateException\n      *         If the category is not configured, or if there are no\n-     *         plugins associated to the category\n+     *         plugins associated to the category, or if Amplify has not\n+     *         been configured\n      */\n     @NonNull\n-    protected final P getSelectedPlugin() {\n-        if (!isConfigured) {\n-            throw new IllegalStateException(\"This category is not yet configured.\" +\n-                    \"Make sure you added it with Amplify.addPlugin and then called Amplify.config\");\n+    protected final P getSelectedPlugin() throws IllegalStateException {\n+        try {\n+            validateConfigurationState(ConfigurationState.CONFIGURED);\n+        } catch (AmplifyException amplifyException) {\n+            // Every category behavior calls getSelectedPlugin(), so we can't realistically\n+            // ask each one to catch a (checked) AmplifyException.\n+            throw new IllegalStateException(amplifyException);\n         }\n+\n         if (plugins.isEmpty()) {\n             throw new IllegalStateException(\n-                    \"Tried to get a plugin but that plugin was not present.\" +\n-                    \"Check if the plugin was added originally or perhaps was already removed.\"\n+                \"Tried to get a plugin but that plugin was not present. \" +\n+                \"Check if the plugin was added originally or perhaps was already removed.\"\n             );\n-        }\n-        if (plugins.size() > 1) {\n+        } else if (plugins.size() > 1) {\n             throw new IllegalStateException(\n-                    \"Tried to get a default plugin but there are more than one to choose from in this category.\" +\n-                    \"Call getPlugin(pluginKey) to choose the specific plugin you want to use in this case.\"\n+                \"Tried to get a default plugin but there are more than one to choose from in this category. \" +\n+                \"Call getPlugin(pluginKey) to choose the specific plugin you want to use in this case.\"\n             );\n         }\n \n         return getPlugins().iterator().next();\n     }\n+\n+    private void validateConfigurationState(ConfigurationState targetState) throws AmplifyException {\n+        synchronized (configurationState) {\n+            if (!configurationState.get().equals(targetState)) {\n+                throw new AmplifyException(\n+                    \"Amplify was already configured.\",\n+                    \"Be sure to only call Amplify.configure once\"\n+                );\n+            }\n+        }\n+    }", "originalCommit": "933556349e7ee1399904fa086e746c8a54f2d636", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMyODg4Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/250#discussion_r374328887", "bodyText": "Fixing! Thanks for the catch.", "author": "jamesonwilliams", "createdAt": "2020-02-03T20:40:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzEzNzg1OQ=="}], "type": "inlineReview"}, {"oid": "0c46ab6d17685a1a11cf8bd43eab58badc3f0301", "url": "https://github.com/aws-amplify/amplify-android/commit/0c46ab6d17685a1a11cf8bd43eab58badc3f0301", "message": "[core] unit tests and tweaks for Category", "committedDate": "2020-02-03T21:41:40Z", "type": "commit"}, {"oid": "0c46ab6d17685a1a11cf8bd43eab58badc3f0301", "url": "https://github.com/aws-amplify/amplify-android/commit/0c46ab6d17685a1a11cf8bd43eab58badc3f0301", "message": "[core] unit tests and tweaks for Category", "committedDate": "2020-02-03T21:41:40Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1NjY1Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/250#discussion_r375456657", "bodyText": "isn't this just\nif (!isConfigured()) {\n    throw ...\n}\n\n?", "author": "raphkim", "createdAt": "2020-02-05T19:19:42Z", "path": "core/src/main/java/com/amplifyframework/core/category/Category.java", "diffHunk": "@@ -167,35 +176,46 @@ public final P getPlugin(@NonNull final String pluginKey) {\n      */\n     @NonNull\n     public final Set<P> getPlugins() {\n-        return new HashSet<>(plugins.values());\n+        return Immutable.of(new HashSet<>(plugins.values()));\n     }\n \n     /**\n      * Obtain the registered plugin for this category.\n      * @return The only registered plugin for this category\n      * @throws IllegalStateException\n      *         If the category is not configured, or if there are no\n-     *         plugins associated to the category\n+     *         plugins associated to the category, or if Amplify has not\n+     *         been configured\n      */\n     @NonNull\n-    protected final P getSelectedPlugin() {\n-        if (!isConfigured) {\n-            throw new IllegalStateException(\"This category is not yet configured.\" +\n-                    \"Make sure you added it with Amplify.addPlugin and then called Amplify.config\");\n+    protected final P getSelectedPlugin() throws IllegalStateException {\n+        synchronized (configurationState) {\n+            if (!ConfigurationState.CONFIGURED.equals(configurationState.get())) {\n+                throw new IllegalStateException(\n+                    \"Category \" + getCategoryType() + \" is not configured. \" +\n+                    \"Ensure that you have configured the category before trying to use it.\"\n+                );\n+            }\n         }", "originalCommit": "0c46ab6d17685a1a11cf8bd43eab58badc3f0301", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk5NjgwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/250#discussion_r375996802", "bodyText": "Yes! I'll do it this way instead.", "author": "jamesonwilliams", "createdAt": "2020-02-06T18:08:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ1NjY1Nw=="}], "type": "inlineReview"}, {"oid": "3059b2585bc7825c155425fda0395e2ceaca0a17", "url": "https://github.com/aws-amplify/amplify-android/commit/3059b2585bc7825c155425fda0395e2ceaca0a17", "message": "Merge remote-tracking branch 'origin/master' into category_tweaks", "committedDate": "2020-02-16T06:09:51Z", "type": "commit"}, {"oid": "5418eb1360ada4fbc32f23fa8eddb848ae3d875f", "url": "https://github.com/aws-amplify/amplify-android/commit/5418eb1360ada4fbc32f23fa8eddb848ae3d875f", "message": "Address Raph's feedback", "committedDate": "2020-02-16T06:14:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MTk5Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/250#discussion_r380261996", "bodyText": "What's the benefit to specifying the runtime exception in the method header? Also, that won't force calling methods to catch/throw it will it?", "author": "TrekSoft", "createdAt": "2020-02-17T16:00:01Z", "path": "core/src/main/java/com/amplifyframework/core/category/Category.java", "diffHunk": "@@ -146,17 +153,17 @@ public final void removePlugin(@NonNull P plugin) {\n      * Retrieve a plugin by its key.\n      * @param pluginKey A key that identifies a plugin implementation\n      * @return The plugin object associated to pluginKey, if registered\n-     * @throws IllegalStateException If there is no plugin with the given key\n+     * @throws IllegalStateException If the requested plugin does not exist\n      */\n     @NonNull\n-    public final P getPlugin(@NonNull final String pluginKey) {\n+    public final P getPlugin(@NonNull final String pluginKey) throws IllegalStateException {", "originalCommit": "5418eb1360ada4fbc32f23fa8eddb848ae3d875f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2ODQwMA==", "url": "https://github.com/aws-amplify/amplify-android/pull/250#discussion_r380268400", "bodyText": "My intention here was just to provide clear documentation on what can happen. Since IllegalStateException derives from RuntimeException, the caller still won't need to try-catch it explicitly.\nHowever, I didn't honestly know the best practice on this. Should one put runtime exceptions on the method signature, or not? Apparently, the guidance is to not do this. Here's a StackOverflow post about it, which contains this quote from Oracle documentation:\n\nHaving to add runtime exceptions in every method declaration would reduce a program's clarity.\n\nAnyway, these are all over the code-base at this point. I'll do a separate CR to remove them all in one pass.", "author": "jamesonwilliams", "createdAt": "2020-02-17T16:12:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI2MTk5Ng=="}], "type": "inlineReview"}, {"oid": "1294ed30fc79e92f604685821fd59602bb87dca4", "url": "https://github.com/aws-amplify/amplify-android/commit/1294ed30fc79e92f604685821fd59602bb87dca4", "message": "Merge branch 'master' into category_tweaks", "committedDate": "2020-02-17T16:13:53Z", "type": "commit"}]}