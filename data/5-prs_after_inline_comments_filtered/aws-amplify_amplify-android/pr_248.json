{"pr_number": 248, "pr_title": "[Storage] Support getUrl()", "pr_createdAt": "2020-01-29T01:06:14Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/248", "timeline": [{"oid": "ffc04058fd1b54b5351e11ed1bf11181c51f9eb6", "url": "https://github.com/aws-amplify/amplify-android/commit/ffc04058fd1b54b5351e11ed1bf11181c51f9eb6", "message": "[Storage] Support getUrl()", "committedDate": "2020-02-11T22:22:32Z", "type": "commit"}, {"oid": "d493155341c0525728e622ba3dfe5c61ee417458", "url": "https://github.com/aws-amplify/amplify-android/commit/d493155341c0525728e622ba3dfe5c61ee417458", "message": "Make getURL non-blocking operation", "committedDate": "2020-02-11T22:56:19Z", "type": "commit"}, {"oid": "1f010c3bb60e9bb6377d45703537734adda59c31", "url": "https://github.com/aws-amplify/amplify-android/commit/1f010c3bb60e9bb6377d45703537734adda59c31", "message": "Fix inaccurate copyright year for newly added classes", "committedDate": "2020-02-11T22:56:38Z", "type": "commit"}, {"oid": "d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "url": "https://github.com/aws-amplify/amplify-android/commit/d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "message": "Minor cleanup", "committedDate": "2020-02-11T23:26:22Z", "type": "commit"}, {"oid": "d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "url": "https://github.com/aws-amplify/amplify-android/commit/d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "message": "Minor cleanup", "committedDate": "2020-02-11T23:26:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMDUzNQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r379630535", "bodyText": "Later there is getRequest().weBelieveItsNotNull() so if the superclass constructor doesn\u2019t require non-null, then this constructor should.", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:29:18Z", "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/operation/AWSS3StorageGetPresignedUrlOperation.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.s3.operation;\n+\n+import android.annotation.SuppressLint;\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.core.Consumer;\n+import com.amplifyframework.storage.StorageException;\n+import com.amplifyframework.storage.operation.StorageGetUrlOperation;\n+import com.amplifyframework.storage.result.StorageGetUrlResult;\n+import com.amplifyframework.storage.s3.request.AWSS3StorageGetPresignedUrlRequest;\n+import com.amplifyframework.storage.s3.service.StorageService;\n+import com.amplifyframework.storage.s3.utils.S3RequestUtils;\n+\n+import java.net.URL;\n+import java.util.concurrent.ExecutorService;\n+\n+/**\n+ * An operation to retrieve pre-signed object URL from AWS S3.\n+ */\n+public final class AWSS3StorageGetPresignedUrlOperation\n+        extends StorageGetUrlOperation<AWSS3StorageGetPresignedUrlRequest> {\n+    private final StorageService storageService;\n+    private final ExecutorService executorService;\n+    private final Consumer<StorageGetUrlResult> onResult;\n+    private final Consumer<StorageException> onError;\n+\n+    /**\n+     * Constructs a new AWSS3StorageGetUrlOperation.\n+     * @param storageService S3 client wrapper\n+     * @param executorService Executor service used for running\n+     *                        blocking operations on a separate thread\n+     * @param request getUrl request parameters\n+     * @param onSuccess Notified when URL is generated.\n+     * @param onError Notified upon URL generation error\n+     */\n+    public AWSS3StorageGetPresignedUrlOperation(\n+            @NonNull StorageService storageService,\n+            @NonNull ExecutorService executorService,\n+            @NonNull AWSS3StorageGetPresignedUrlRequest request,\n+            @NonNull Consumer<StorageGetUrlResult> onSuccess,\n+            @NonNull Consumer<StorageException> onError\n+    ) {\n+        super(request);", "originalCommit": "d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMjA0OQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r379632049", "bodyText": "Should it be called generatePresignedUrl to make clear that the URL doesn\u2019t already exist. Otherwise right now this looks like an accessory method to a cached variable", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:33:29Z", "path": "aws-storage-s3/src/main/java/com/amplifyframework/storage/s3/service/StorageService.java", "diffHunk": "@@ -32,6 +33,14 @@\n  */\n public interface StorageService {\n \n+    /**\n+     * Generate pre-signed download URL for an object.\n+     * @param serviceKey key to uniquely specify item to generate URL for\n+     * @param expires Number of seconds before URL expires\n+     * @return A pre-signed URL\n+     */\n+    URL getPresignedUrl(@NonNull String serviceKey, int expires);", "originalCommit": "d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzNjMzOA==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r385436338", "bodyText": "The storage service isn't exposed to the customer anyways so I think it's okay. I gave it the get prefix to be more aligned with getUrl() public API.", "author": "raphkim", "createdAt": "2020-02-27T23:50:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMjA0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMjQxMw==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r379632413", "bodyText": "Frequently these are ordered towards the top to sit near the constructor(s), if any.", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:34:23Z", "path": "core/src/main/java/com/amplifyframework/storage/result/StorageGetUrlResult.java", "diffHunk": "@@ -0,0 +1,55 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.result;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.amplifyframework.core.async.Result;\n+\n+import java.net.URL;\n+import java.util.Objects;\n+\n+/**\n+ * The result of a call to get an item's URL from the Storage category.\n+ */\n+public final class StorageGetUrlResult implements Result {\n+    private final URL url;\n+\n+    private StorageGetUrlResult(URL url) {\n+        this.url = url;\n+    }\n+\n+    /**\n+     * Gets the presigned URL.\n+     * @return presigned URL\n+     */\n+    @NonNull\n+    public URL getUrl() {\n+        return url;\n+    }\n+\n+    /**\n+     * Creates a new StorageGetUrlResult containing the presigned URL\n+     * of requested object.\n+     * @param url The presigned URL\n+     * @return A StorageGetUrlResult\n+     */\n+    @NonNull\n+    public static StorageGetUrlResult fromUrl(@NonNull URL url) {\n+        return new StorageGetUrlResult(Objects.requireNonNull(url));", "originalCommit": "d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzNjg2MQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r385436861", "bodyText": "Fixed.", "author": "raphkim", "createdAt": "2020-02-27T23:51:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMjQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzE5NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r379633195", "bodyText": "Do you want to validate anything about the provided values before you build the instance? I.e. a range on the int, null-ness is the provided objects?", "author": "jamesonwilliams", "createdAt": "2020-02-14T20:36:34Z", "path": "core/src/main/java/com/amplifyframework/storage/options/StorageGetUrlOptions.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.storage.options;\n+\n+import com.amplifyframework.core.async.Options;\n+import com.amplifyframework.storage.StorageAccessLevel;\n+\n+/**\n+ * Options to specify attributes of get URL API invocation.\n+ */\n+public final class StorageGetUrlOptions implements Options {\n+    private final StorageAccessLevel accessLevel;\n+    private final String targetIdentityId;\n+    private final int expires;\n+\n+    StorageGetUrlOptions(final Builder builder) {\n+        this.accessLevel = builder.getAccessLevel();\n+        this.targetIdentityId = builder.getTargetIdentityId();\n+        this.expires = builder.getExpires();\n+    }\n+\n+    /**\n+     * Gets the storage access level.\n+     * @return Storage access level\n+     */\n+    public StorageAccessLevel getAccessLevel() {\n+        return accessLevel;\n+    }\n+\n+    /**\n+     * Gets the target identity ID.\n+     * @return target identity ID\n+     */\n+    public String getTargetIdentityId() {\n+        return targetIdentityId;\n+    }\n+\n+    /**\n+     * Gets the number of seconds before the URL expires.\n+     * @return number of seconds before the URL expires\n+     */\n+    public int getExpires() {\n+        return expires;\n+    }\n+\n+    /**\n+     * Factory method to create a new instance of the\n+     * {@link StorageGetUrlOptions.Builder}.  The builder can be\n+     * used to configure properties and then construct a new immutable\n+     * instance of the StorageGetUrlOptions.\n+     * @return An instance of the {@link StorageGetUrlOptions.Builder}\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Factory method to create builder which is configured to prepare\n+     * object instances with the same field values as the provided\n+     * options. This can be used as a starting ground to create a\n+     * new clone of the provided options, which shares some common\n+     * configuration.\n+     * @param options Options to populate into a new builder configuration\n+     * @return A Builder instance that has been configured using the\n+     *         values in the provided options\n+     */\n+    public static Builder from(StorageGetUrlOptions options) {\n+        return builder()\n+            .accessLevel(options.getAccessLevel())\n+            .targetIdentityId(options.getTargetIdentityId())\n+            .expires(options.getExpires());\n+    }\n+\n+    /**\n+     * Constructs a default instance of the {@link StorageGetUrlOptions}.\n+     * @return default instance of StorageGetUrlOptions\n+     */\n+    public static StorageGetUrlOptions defaultInstance() {\n+        return builder().build();\n+    }\n+\n+    /**\n+     * A utility that can be used to configure and construct immutable\n+     * instances of the {@link StorageGetUrlOptions}, by chaining\n+     * fluent configuration method calls.\n+     */\n+    public static final class Builder {\n+        private StorageAccessLevel accessLevel;\n+        private String targetIdentityId;\n+        private int expires;\n+\n+        /**\n+         * Configures the storage access level to set on new\n+         * StorageGetUrlOptions instances.\n+         * @param accessLevel Storage access level for new StorageGetUrlOptions instances\n+         * @return Current Builder instance, for fluent method chaining\n+         */\n+        public Builder accessLevel(StorageAccessLevel accessLevel) {\n+            this.accessLevel = accessLevel;\n+            return this;\n+        }\n+\n+        /**\n+         * Configures the target identity ID that will be used on newly\n+         * built StorageGetUrlOptions.\n+         * @param targetIdentityId Target identity ID for new StorageGetUrlOptions instances\n+         * @return Current Builder instance, for fluent method chaining\n+         */\n+        public Builder targetIdentityId(String targetIdentityId) {\n+            this.targetIdentityId = targetIdentityId;\n+            return this;\n+        }\n+\n+        /**\n+         * Configures the number of seconds left until URL expires on new\n+         * StorageGetUrlOptions instances.\n+         * StorageGetUrlOptions instances.\n+         * @param accessLevel Storage access level for new StorageGetUrlOptions instances\n+         * @return Current Builder instance, for fluent method chaining\n+         */\n+        public Builder expires(int accessLevel) {\n+            this.expires = expires;\n+            return this;\n+        }\n+\n+        /**\n+         * Constructs and returns a new immutable instance of the\n+         * StorageGetUrlOptions, using the configurations that\n+         * have been provided the current instance of the Builder.\n+         * @return A new immutable instance of StorageGetUrlOptions\n+         */\n+        public StorageGetUrlOptions build() {\n+            return new StorageGetUrlOptions(this);", "originalCommit": "d157f01b9119ba3c02f16586a92fc4ef1e3733b9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQzNjc5NQ==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r385436795", "bodyText": "To be revisited in StorageOptions PR", "author": "raphkim", "createdAt": "2020-02-27T23:51:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTYzMzE5NQ=="}], "type": "inlineReview"}, {"oid": "434c411bd1cf260538e2c3024d802f65768c9774", "url": "https://github.com/aws-amplify/amplify-android/commit/434c411bd1cf260538e2c3024d802f65768c9774", "message": "Merge branch 'master' of https://github.com/aws-amplify/amplify-android into geturl", "committedDate": "2020-02-14T22:30:15Z", "type": "commit"}, {"oid": "55cbd1fbae54cf0d0bf1361de69a22ec19cf8284", "url": "https://github.com/aws-amplify/amplify-android/commit/55cbd1fbae54cf0d0bf1361de69a22ec19cf8284", "message": "Merge branch 'master' of https://github.com/aws-amplify/amplify-android into geturl", "committedDate": "2020-02-27T19:11:52Z", "type": "commit"}, {"oid": "6047604b361f1efcab8ef871769589a439b89c28", "url": "https://github.com/aws-amplify/amplify-android/commit/6047604b361f1efcab8ef871769589a439b89c28", "message": "Add getUrl to Storage component test", "committedDate": "2020-02-27T23:29:53Z", "type": "commit"}, {"oid": "afc024c0d1e2cecddae70a2f514fadad0d9098e3", "url": "https://github.com/aws-amplify/amplify-android/commit/afc024c0d1e2cecddae70a2f514fadad0d9098e3", "message": "Fix error in get URL options", "committedDate": "2020-02-27T23:36:03Z", "type": "commit"}, {"oid": "52d855b8261e191d979c8ff63069155cadd0b5b4", "url": "https://github.com/aws-amplify/amplify-android/commit/52d855b8261e191d979c8ff63069155cadd0b5b4", "message": "Minor fix", "committedDate": "2020-02-27T23:51:51Z", "type": "commit"}, {"oid": "f5ac332b08f4d9531972f3b2b4c6e3ff6e1c8884", "url": "https://github.com/aws-amplify/amplify-android/commit/f5ac332b08f4d9531972f3b2b4c6e3ff6e1c8884", "message": "Merge branch 'master' of https://github.com/aws-amplify/amplify-android into geturl", "committedDate": "2020-02-28T19:05:00Z", "type": "commit"}, {"oid": "02653e56d8047d4fd96482c09cfabb2d4f553ce7", "url": "https://github.com/aws-amplify/amplify-android/commit/02653e56d8047d4fd96482c09cfabb2d4f553ce7", "message": "Update StorageGetUrlOptions to match refactored pattern", "committedDate": "2020-02-28T19:30:25Z", "type": "commit"}, {"oid": "02653e56d8047d4fd96482c09cfabb2d4f553ce7", "url": "https://github.com/aws-amplify/amplify-android/commit/02653e56d8047d4fd96482c09cfabb2d4f553ce7", "message": "Update StorageGetUrlOptions to match refactored pattern", "committedDate": "2020-02-28T19:30:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTg4ODQ4MA==", "url": "https://github.com/aws-amplify/amplify-android/pull/248#discussion_r385888480", "bodyText": "It would probably work without this random URL if you use Robolectric, which will provide an implementation of andorid's URL. (But, Robolectric is slow. So I do like your solution, too.)\nYou could pull this out to a RandomURL.url() test util! Like:\npublic static URL url() {\n    try {\n        return new URL(... params ...);\n    } catch (MalformedURLException exception) {\n        throw new RuntimeException(exception);\n    }\n}", "author": "jamesonwilliams", "createdAt": "2020-02-28T19:46:29Z", "path": "aws-storage-s3/src/test/java/com/amplifyframework/storage/s3/StorageComponentTest.java", "diffHunk": "@@ -93,6 +97,48 @@ private static StorageCategoryConfiguration buildConfiguration() {\n         return configuration;\n     }\n \n+    /**\n+     * Test that calling get URL method from Storage category correctly invokes\n+     * the registered AWSS3StoragePlugin instance and returns a {@link URL}\n+     * instance for that download.\n+     * @throws StorageException when an error is encountered while generating\n+     *         URL from storage service\n+     */\n+    @Test\n+    public void testGenerateUrlGetsPresignedUrl() throws StorageException {\n+        final String fromRemoteKey = RandomString.string();\n+        final URL urlFromRemoteKey;\n+        try {\n+            // URL instance cannot be mocked so just make one\n+            // https://{random-host}:0/{fromRemoteKey}\n+            urlFromRemoteKey = new URL(", "originalCommit": "02653e56d8047d4fd96482c09cfabb2d4f553ce7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}