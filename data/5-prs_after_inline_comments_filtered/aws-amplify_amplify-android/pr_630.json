{"pr_number": 630, "pr_title": "Move shake detection logic into ShakeDetector and add unit tests for ShakeDetector", "pr_createdAt": "2020-07-07T21:20:24Z", "pr_url": "https://github.com/aws-amplify/amplify-android/pull/630", "timeline": [{"oid": "2416f3bce777a4b79a7e5e9816bf998dd1c601d3", "url": "https://github.com/aws-amplify/amplify-android/commit/2416f3bce777a4b79a7e5e9816bf998dd1c601d3", "message": "created activity to display dev menu from context and updated package name", "committedDate": "2020-06-24T18:41:41Z", "type": "commit"}, {"oid": "0fbba26fe8dcf30cc52c61b0465f7450caa27181", "url": "https://github.com/aws-amplify/amplify-android/commit/0fbba26fe8dcf30cc52c61b0465f7450caa27181", "message": "start the developer menu activity and display developer menu on bottom of screen", "committedDate": "2020-06-24T23:49:57Z", "type": "commit"}, {"oid": "fe55183e7c1e640cce2d383d7048a9664c0bc4a1", "url": "https://github.com/aws-amplify/amplify-android/commit/fe55183e7c1e640cce2d383d7048a9664c0bc4a1", "message": "changed styling of dev menu to overlay current view", "committedDate": "2020-06-26T15:04:40Z", "type": "commit"}, {"oid": "d5d1d3706b4580ff63d8bb1248969a5196db7a38", "url": "https://github.com/aws-amplify/amplify-android/commit/d5d1d3706b4580ff63d8bb1248969a5196db7a38", "message": "Merge branch 'main' into eeatonaws-dev-menu", "committedDate": "2020-06-26T15:10:02Z", "type": "commit"}, {"oid": "3782d18333b185ece108abda0004066a45b7d474", "url": "https://github.com/aws-amplify/amplify-android/commit/3782d18333b185ece108abda0004066a45b7d474", "message": "updated copyright year", "committedDate": "2020-06-29T20:33:08Z", "type": "commit"}, {"oid": "c7835d544c14244e76378be421f6efed13cb881b", "url": "https://github.com/aws-amplify/amplify-android/commit/c7835d544c14244e76378be421f6efed13cb881b", "message": "Merge branch 'main' into eeatonaws-dev-menu", "committedDate": "2020-06-29T22:12:54Z", "type": "commit"}, {"oid": "52b2dbce3cb491ea6ee6823e7e8e5cea6d8855cd", "url": "https://github.com/aws-amplify/amplify-android/commit/52b2dbce3cb491ea6ee6823e7e8e5cea6d8855cd", "message": "only display dev menu if in debug mode", "committedDate": "2020-06-30T16:44:27Z", "type": "commit"}, {"oid": "f08434b9b85c84306bfe396e190946d43998e126", "url": "https://github.com/aws-amplify/amplify-android/commit/f08434b9b85c84306bfe396e190946d43998e126", "message": "Merge branch 'DevMenu' into eeatonaws-dev-menu and fix merge conflict.", "committedDate": "2020-06-30T16:52:01Z", "type": "commit"}, {"oid": "71a07d475dee8b572fd77c031805f1649475322c", "url": "https://github.com/aws-amplify/amplify-android/commit/71a07d475dee8b572fd77c031805f1649475322c", "message": "activate dev menu on device shake or keyboard shortcut", "committedDate": "2020-07-01T21:22:18Z", "type": "commit"}, {"oid": "36481de3107cc22c71b57c0257b33ac63cfd1dd9", "url": "https://github.com/aws-amplify/amplify-android/commit/36481de3107cc22c71b57c0257b33ac63cfd1dd9", "message": "Merge branch 'main' into eeatonaws-dev-menu", "committedDate": "2020-07-01T22:14:19Z", "type": "commit"}, {"oid": "ae96c687d4c01486acf0047a5362d6384513d27f", "url": "https://github.com/aws-amplify/amplify-android/commit/ae96c687d4c01486acf0047a5362d6384513d27f", "message": "adjusted shake threshold", "committedDate": "2020-07-02T18:31:13Z", "type": "commit"}, {"oid": "59f95d076adafdd81a4e5db3428fc9de81962044", "url": "https://github.com/aws-amplify/amplify-android/commit/59f95d076adafdd81a4e5db3428fc9de81962044", "message": "Merge branch 'DevMenu' into eeatonaws-dev-menu", "committedDate": "2020-07-02T18:36:44Z", "type": "commit"}, {"oid": "e860ea2b7300e055bca4f7f63c49c133d31734c6", "url": "https://github.com/aws-amplify/amplify-android/commit/e860ea2b7300e055bca4f7f63c49c133d31734c6", "message": "reordered fields in DeveloperMenuActivity", "committedDate": "2020-07-06T14:34:22Z", "type": "commit"}, {"oid": "79bead5640b823697e44c5b5480093dd1b98da10", "url": "https://github.com/aws-amplify/amplify-android/commit/79bead5640b823697e44c5b5480093dd1b98da10", "message": "factor shake detection logic out into separate class", "committedDate": "2020-07-06T19:00:05Z", "type": "commit"}, {"oid": "533629c1b58b9d257f4f293f2d88732992bf5bab", "url": "https://github.com/aws-amplify/amplify-android/commit/533629c1b58b9d257f4f293f2d88732992bf5bab", "message": "added buttons to dev menu and did basic styling", "committedDate": "2020-07-06T21:10:07Z", "type": "commit"}, {"oid": "7790dbc1043732c7eb0060dbe125b5918b1292b5", "url": "https://github.com/aws-amplify/amplify-android/commit/7790dbc1043732c7eb0060dbe125b5918b1292b5", "message": "Merge branch 'DevMenu' into eeatonaws-dev-menu", "committedDate": "2020-07-06T21:11:44Z", "type": "commit"}, {"oid": "0e2118fd60e69e4186e452562260c5c3144dcd19", "url": "https://github.com/aws-amplify/amplify-android/commit/0e2118fd60e69e4186e452562260c5c3144dcd19", "message": "changed XML IDs from camel case to lower snake case", "committedDate": "2020-07-06T22:03:31Z", "type": "commit"}, {"oid": "920324b5be73e2a56d2b251957b2b4bacf3d24a1", "url": "https://github.com/aws-amplify/amplify-android/commit/920324b5be73e2a56d2b251957b2b4bacf3d24a1", "message": "move SensorManager out of activity and into ShakeDetector", "committedDate": "2020-07-07T15:16:16Z", "type": "commit"}, {"oid": "e731a750599d61ab034a124c9617ecfc77eaec85", "url": "https://github.com/aws-amplify/amplify-android/commit/e731a750599d61ab034a124c9617ecfc77eaec85", "message": "wrote unit tests for ShakeDetector", "committedDate": "2020-07-07T21:16:26Z", "type": "commit"}, {"oid": "ba110f5ac1e338a6870eca7357f02c8434180657", "url": "https://github.com/aws-amplify/amplify-android/commit/ba110f5ac1e338a6870eca7357f02c8434180657", "message": "Merge branch 'DevMenu' into eeatonaws-dev-menu", "committedDate": "2020-07-07T21:17:11Z", "type": "commit"}, {"oid": "12cdbe20dcbdde774cee97e23c3c6d3a047e1b6b", "url": "https://github.com/aws-amplify/amplify-android/commit/12cdbe20dcbdde774cee97e23c3c6d3a047e1b6b", "message": "fixed lint errors", "committedDate": "2020-07-07T21:33:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1MTg0Nw==", "url": "https://github.com/aws-amplify/amplify-android/pull/630#discussion_r451151847", "bodyText": "Thanks for writing milliseconds in the comment. Even so, I'd bake the unit into the variable name. Ambiguity of time and data storage size units are common, but easily avoidable. e.g. SENSOR_DATA_POLLING_INTERVAL_MS?", "author": "jamesonwilliams", "createdAt": "2020-07-07T21:23:54Z", "path": "core/src/test/java/com/amplifyframework/core/ShakeDetectorTest.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core;\n+\n+import android.content.Context;\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n+\n+import com.amplifyframework.testutils.Resources;\n+import com.amplifyframework.testutils.Sleep;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import io.reactivex.Completable;\n+import io.reactivex.schedulers.Schedulers;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Tests the {@link ShakeDetector} behavior.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class ShakeDetectorTest {\n+    // Amount of time in milliseconds between sending sensor\n+    // events to the sensor listener.\n+    private static final int SENSOR_DATA_DELAY = 65;", "originalCommit": "ba110f5ac1e338a6870eca7357f02c8434180657", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1MjI2Ng==", "url": "https://github.com/aws-amplify/amplify-android/pull/630#discussion_r451152266", "bodyText": "Naming: SHAKE_RESULT_TIMEOUT_SECS?", "author": "jamesonwilliams", "createdAt": "2020-07-07T21:24:47Z", "path": "core/src/test/java/com/amplifyframework/core/ShakeDetectorTest.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core;\n+\n+import android.content.Context;\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n+\n+import com.amplifyframework.testutils.Resources;\n+import com.amplifyframework.testutils.Sleep;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import io.reactivex.Completable;\n+import io.reactivex.schedulers.Schedulers;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Tests the {@link ShakeDetector} behavior.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class ShakeDetectorTest {\n+    // Amount of time in milliseconds between sending sensor\n+    // events to the sensor listener.\n+    private static final int SENSOR_DATA_DELAY = 65;\n+    // Maximum amount of time in seconds before a test times out if the callback\n+    // method has not been called.\n+    private static final int TIMEOUT = 5;", "originalCommit": "ba110f5ac1e338a6870eca7357f02c8434180657", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1MzgyNw==", "url": "https://github.com/aws-amplify/amplify-android/pull/630#discussion_r451153827", "bodyText": "I deliberated on whether or not you could use a ParameterizedRobolectricTestRunner for the test runner. Then, you could run the same test boy against different .csv. However, it is probably overkill. It is an interesting tool to be aware of, though. I've never actually used that one. Only Parameterized in backend development, and RobolectricTestRunner in front-end development; never the combo!", "author": "jamesonwilliams", "createdAt": "2020-07-07T21:28:01Z", "path": "core/src/test/java/com/amplifyframework/core/ShakeDetectorTest.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core;\n+\n+import android.content.Context;\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n+\n+import com.amplifyframework.testutils.Resources;\n+import com.amplifyframework.testutils.Sleep;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import io.reactivex.Completable;\n+import io.reactivex.schedulers.Schedulers;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Tests the {@link ShakeDetector} behavior.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class ShakeDetectorTest {\n+    // Amount of time in milliseconds between sending sensor\n+    // events to the sensor listener.\n+    private static final int SENSOR_DATA_DELAY = 65;\n+    // Maximum amount of time in seconds before a test times out if the callback\n+    // method has not been called.\n+    private static final int TIMEOUT = 5;\n+\n+    /**\n+     * Test that the callback method is called when a shake\n+     * event is triggered.\n+     */\n+    @Test\n+    public void shakeTriggersCallback() {\n+        simulateSensorEvent(\"shake-accel-values.csv\");", "originalCommit": "ba110f5ac1e338a6870eca7357f02c8434180657", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE1NTEwMg==", "url": "https://github.com/aws-amplify/amplify-android/pull/630#discussion_r451155102", "bodyText": "Maybe throw new RuntimeException(relfectionFailure)? (change name of e)", "author": "jamesonwilliams", "createdAt": "2020-07-07T21:30:39Z", "path": "core/src/test/java/com/amplifyframework/core/ShakeDetectorTest.java", "diffHunk": "@@ -0,0 +1,177 @@\n+/*\n+ * Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\").\n+ * You may not use this file except in compliance with the License.\n+ * A copy of the License is located at\n+ *\n+ *  http://aws.amazon.com/apache2.0\n+ *\n+ * or in the \"license\" file accompanying this file. This file is distributed\n+ * on an \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either\n+ * express or implied. See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ */\n+\n+package com.amplifyframework.core;\n+\n+import android.content.Context;\n+import android.hardware.Sensor;\n+import android.hardware.SensorEvent;\n+import android.hardware.SensorEventListener;\n+import android.hardware.SensorManager;\n+\n+import com.amplifyframework.testutils.Resources;\n+import com.amplifyframework.testutils.Sleep;\n+\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+\n+import java.lang.reflect.Field;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+import io.reactivex.Completable;\n+import io.reactivex.schedulers.Schedulers;\n+\n+import static org.mockito.ArgumentMatchers.any;\n+import static org.mockito.ArgumentMatchers.anyInt;\n+import static org.mockito.Mockito.doAnswer;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+/**\n+ * Tests the {@link ShakeDetector} behavior.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+public class ShakeDetectorTest {\n+    // Amount of time in milliseconds between sending sensor\n+    // events to the sensor listener.\n+    private static final int SENSOR_DATA_DELAY = 65;\n+    // Maximum amount of time in seconds before a test times out if the callback\n+    // method has not been called.\n+    private static final int TIMEOUT = 5;\n+\n+    /**\n+     * Test that the callback method is called when a shake\n+     * event is triggered.\n+     */\n+    @Test\n+    public void shakeTriggersCallback() {\n+        simulateSensorEvent(\"shake-accel-values.csv\");\n+    }\n+\n+    /**\n+     * Test that the callback method is not called when\n+     * no shake is detected.\n+     */\n+    @Test(expected = RuntimeException.class)\n+    public void noShakeDetected() {\n+        simulateSensorEvent(\"no-shake-accel-values.csv\");\n+    }\n+\n+    /**\n+     * Test that the callback method is not called\n+     * when the sensor listener has not been registered.\n+     */\n+    @Test(expected = RuntimeException.class)\n+    public void beforeSensorListenerRegistered() {\n+        Completable.create(emitter -> {\n+            ShakeDetector sd = new ShakeDetector(mock(Context.class), emitter::onComplete);\n+        }).observeOn(Schedulers.io())\n+                .subscribeOn(Schedulers.io())\n+                .timeout(TIMEOUT, TimeUnit.SECONDS)\n+                .blockingAwait();\n+    }\n+\n+    /**\n+     * Test that the callback method is not called\n+     * after the sensor listener has been unregistered.\n+     */\n+    @Test(expected = RuntimeException.class)\n+    public void afterSensorListenerUnregistered() {\n+        Completable.create(emitter -> {\n+            ShakeDetector sd = new ShakeDetector(mock(Context.class), emitter::onComplete);\n+            sd.startDetecting();\n+            sd.stopDetecting();\n+        }).observeOn(Schedulers.io())\n+                .subscribeOn(Schedulers.io())\n+                .timeout(TIMEOUT, TimeUnit.SECONDS)\n+                .blockingAwait();\n+    }\n+\n+    /**\n+     * For each line in the CSV file with the given name, creates and starts a thread that sends\n+     * a sensor event with the corresponding data in the CSV file to the sensor listener and waits\n+     * for the callback method to be called (times out after TIMEOUT seconds).\n+     * @param accelDataFileName Name of the CSV file containing acceleration data.\n+     */\n+    private void simulateSensorEvent(String accelDataFileName) {\n+        Context mockContext = mock(Context.class);\n+        SensorManager mockSensorManager = mock(SensorManager.class);\n+        when(mockContext.getSystemService(Context.SENSOR_SERVICE)).thenReturn(mockSensorManager);\n+        when(mockSensorManager.getDefaultSensor(Sensor.TYPE_ACCELEROMETER)).thenReturn(mock(Sensor.class));\n+        AtomicReference<Thread> streamingThread = new AtomicReference<>();\n+        doAnswer(invocation -> {\n+            int indexOfListener = 0; // First argument passed to registerListener(...)\n+            SensorEventListener listener = invocation.getArgument(indexOfListener);\n+            streamingThread.set(createStreamingThread(processAccelCsv(accelDataFileName), listener));\n+            streamingThread.get().start();\n+            return true;\n+        }).when(mockSensorManager).registerListener(any(SensorEventListener.class), any(Sensor.class), anyInt());\n+\n+        Completable.create(emitter -> {\n+            ShakeDetector sd = new ShakeDetector(mockContext, emitter::onComplete);\n+            sd.startDetecting();\n+        }).observeOn(Schedulers.io())\n+                .subscribeOn(Schedulers.io())\n+                .timeout(TIMEOUT, TimeUnit.SECONDS)\n+                .blockingAwait();\n+    }\n+\n+    /**\n+     * Converts each line in the CSV file with the given name to a float[].\n+     * @param fileName Name of CSV file containing the acceleration data.\n+     * @return List of float[] where each element in the List corresponds to\n+     *         one line in the CSV file.\n+     */\n+    private List<float[]> processAccelCsv(String fileName) {\n+        List<float[]> sensorValues = new ArrayList<>();\n+        for (String line : Resources.readLines(fileName)) {\n+            String[] currentLine = line.split(\",\");\n+            float[] accelValues = new float[currentLine.length];\n+            for (int i = 0; i < currentLine.length; i++) {\n+                accelValues[i] = Float.parseFloat(currentLine[i]);\n+            }\n+            sensorValues.add(accelValues);\n+        }\n+        return sensorValues;\n+    }\n+\n+    /**\n+     * Creates a new thread that when started will send a sensor event to the given\n+     * SensorEventListener for each element in the given List.\n+     * @param sensorValues List where each element represents the acceleration in the x, y, and z directions.\n+     * @param listener SensorEventListener object.\n+     * @return a Thread object.\n+     */\n+    private Thread createStreamingThread(List<float[]> sensorValues, SensorEventListener listener) {\n+        return new Thread(() -> {\n+            for (float[] accelValues: sensorValues) {\n+                SensorEvent mockEvent = mock(SensorEvent.class);\n+                try {\n+                    Field sensorValuesField = SensorEvent.class.getField(\"values\");\n+                    sensorValuesField.setAccessible(true);\n+                    sensorValuesField.set(mockEvent, accelValues);\n+                    listener.onSensorChanged(mockEvent);\n+                    Sleep.milliseconds(SENSOR_DATA_DELAY);\n+                } catch (NoSuchFieldException | IllegalAccessException e) {\n+                    e.printStackTrace();", "originalCommit": "ba110f5ac1e338a6870eca7357f02c8434180657", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "480c6423a454de4753eaed33aa3bda3842e96b12", "url": "https://github.com/aws-amplify/amplify-android/commit/480c6423a454de4753eaed33aa3bda3842e96b12", "message": "changed name of constants and throw RuntimeException if creating a thread fails", "committedDate": "2020-07-07T21:41:24Z", "type": "commit"}]}