{"pr_number": 8508, "pr_title": "Allow to supply SHA512 in installApplication #8494", "pr_createdAt": "2020-11-26T18:28:53Z", "pr_url": "https://github.com/enonic/xp/pull/8508", "timeline": [{"oid": "83ac448d346ab66bd41106e71e15aa4dbe711ad8", "url": "https://github.com/enonic/xp/commit/83ac448d346ab66bd41106e71e15aa4dbe711ad8", "message": "Allow to supply SHA512 in installApplication #8494", "committedDate": "2020-11-26T18:30:38Z", "type": "forcePushed"}, {"oid": "8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d", "url": "https://github.com/enonic/xp/commit/8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d", "message": "Allow to supply SHA512 in installApplication #8494", "committedDate": "2020-11-27T07:55:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQ3MzEzOQ==", "url": "https://github.com/enonic/xp/pull/8508#discussion_r531473139", "bodyText": "can be replaced by UncheckedIOException", "author": "anatol-sialitski", "createdAt": "2020-11-27T09:16:07Z", "path": "modules/core/core-app/src/main/java/com/enonic/xp/core/impl/app/ApplicationLoader.java", "diffHunk": "@@ -21,51 +24,84 @@ public ApplicationLoader( final Consumer<Event> eventConsumer )\n         this.eventConsumer = eventConsumer;\n     }\n \n-    public ByteSource load( URL url )\n+    public ByteSource load( final URL url, final byte[] messageDigest )\n     {\n         try\n         {\n-            URLConnection connection = url.openConnection();\n+            final URLConnection connection = url.openConnection();\n \n-            ByteArrayOutputStream os = null;\n-\n-            try (final InputStream is = connection.getInputStream())\n+            final InputStream inputStream = connection.getInputStream();\n+            final DigestInputStream digestInputStream = new DigestInputStream( inputStream, MessageDigests.sha512() );\n+            final ProgressInputStream progressInputStream =\n+                new ProgressInputStream( digestInputStream, connection.getContentLengthLong(), url.toString() );\n+            try (inputStream; digestInputStream; progressInputStream)\n             {\n-                int totalLength = connection.getContentLength();\n-                int bytesRead;\n-                int totalRead = 0;\n-                int lastPct = 0;\n-                byte[] buffer = new byte[8192];\n-                os = new ByteArrayOutputStream();\n-\n-                while ( ( bytesRead = is.read( buffer ) ) != -1 )\n-                {\n-                    os.write( buffer, 0, bytesRead );\n-                    totalRead += bytesRead;\n-\n-                    int currentPct = (int) Math.min( 100, Math.round( totalRead * 100. / totalLength ) );\n-\n-                    if ( lastPct != currentPct )\n-                    {\n-                        eventConsumer.accept( ApplicationEvents.progress( url.toString(), currentPct ) );\n-                        lastPct = currentPct;\n-                    }\n-                }\n-                os.flush();\n+                final byte[] bytes = progressInputStream.readAllBytes();\n \n-                return ByteSource.wrap( os.toByteArray() );\n-            }\n-            finally\n-            {\n-                if ( os != null )\n+                if ( messageDigest != null && !MessageDigest.isEqual( messageDigest, digestInputStream.getMessageDigest().digest() ) )\n                 {\n-                    os.close();\n+                    throw new IllegalArgumentException( \"MessageDigest does not match\" );\n                 }\n+                return ByteSource.wrap( bytes );\n             }\n         }\n         catch ( IOException e )\n         {\n             throw new RuntimeException( \"Failed to load application from \" + url );", "originalCommit": "8d91ca7a83bd6f5e84c58a4bc32572c04fbf357d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2987061d89047c7efee3052a74eda40fcd7d5045", "url": "https://github.com/enonic/xp/commit/2987061d89047c7efee3052a74eda40fcd7d5045", "message": "Allow to supply SHA512 in installApplication #8494", "committedDate": "2020-11-27T10:47:21Z", "type": "commit"}, {"oid": "2987061d89047c7efee3052a74eda40fcd7d5045", "url": "https://github.com/enonic/xp/commit/2987061d89047c7efee3052a74eda40fcd7d5045", "message": "Allow to supply SHA512 in installApplication #8494", "committedDate": "2020-11-27T10:47:21Z", "type": "forcePushed"}]}