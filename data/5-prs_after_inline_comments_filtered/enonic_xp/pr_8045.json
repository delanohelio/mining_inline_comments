{"pr_number": 8045, "pr_title": "Implement upload of project icon #8044", "pr_createdAt": "2020-04-22T19:27:41Z", "pr_url": "https://github.com/enonic/xp/pull/8045", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzMzOTM0NA==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r413339344", "bodyText": "This is a controller class which does waaay too much.\nLet see how to split it up.", "author": "rymsha", "createdAt": "2020-04-22T21:17:13Z", "path": "modules/admin/admin-impl/src/main/java/com/enonic/xp/admin/impl/rest/resource/project/icon/ProjectIconResource.java", "diffHunk": "@@ -0,0 +1,192 @@\n+package com.enonic.xp.admin.impl.rest.resource.project.icon;\n+\n+import java.awt.image.BufferedImage;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.io.UncheckedIOException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+\n+import javax.annotation.security.RolesAllowed;\n+import javax.imageio.ImageIO;\n+import javax.imageio.ImageWriter;\n+import javax.ws.rs.DefaultValue;\n+import javax.ws.rs.GET;\n+import javax.ws.rs.Path;\n+import javax.ws.rs.PathParam;\n+import javax.ws.rs.Produces;\n+import javax.ws.rs.QueryParam;\n+import javax.ws.rs.WebApplicationException;\n+import javax.ws.rs.core.CacheControl;\n+import javax.ws.rs.core.Response;\n+\n+import org.osgi.service.component.annotations.Component;\n+import org.osgi.service.component.annotations.Reference;\n+\n+import com.google.common.hash.HashCode;\n+import com.google.common.hash.Hashing;\n+import com.google.common.io.ByteSource;\n+\n+import com.enonic.xp.admin.impl.rest.resource.content.ResolvedImage;\n+import com.enonic.xp.attachment.Attachment;\n+import com.enonic.xp.home.HomeDir;\n+import com.enonic.xp.image.ImageHelper;\n+import com.enonic.xp.jaxrs.JaxRsComponent;\n+import com.enonic.xp.project.Project;\n+import com.enonic.xp.project.ProjectName;\n+import com.enonic.xp.project.ProjectService;\n+import com.enonic.xp.repository.RepositoryService;\n+import com.enonic.xp.security.RoleKeys;\n+import com.enonic.xp.util.HexEncoder;\n+import com.enonic.xp.util.ImmutableFilesHelper;\n+\n+import static com.enonic.xp.admin.impl.rest.resource.ResourceConstants.REST_ROOT;\n+import static com.google.common.base.Strings.isNullOrEmpty;\n+\n+@Path(REST_ROOT + \"project/icon\")\n+@Produces(\"image/*\")\n+@RolesAllowed({RoleKeys.ADMIN_LOGIN_ID, RoleKeys.ADMIN_ID})\n+@Component(immediate = true, property = \"group=admin\")\n+public final class ProjectIconResource", "originalCommit": "97ef3076d25c3f3de0082df000d62b1e518c6dc5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29c487618648aea1aade659658ba00b5fd2568c1", "url": "https://github.com/enonic/xp/commit/29c487618648aea1aade659658ba00b5fd2568c1", "message": "Implement upload of project icon #8044", "committedDate": "2020-04-23T14:35:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNzAxMA==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414007010", "bodyText": "I think you need to introduce ModifyProjectParams\nAlso, what is size? dimension?", "author": "rymsha", "createdAt": "2020-04-23T17:58:14Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/project/ProjectService.java", "diffHunk": "@@ -9,6 +10,8 @@\n \n     Project modify( final ModifyProjectParams params );\n \n+    void modifyIcon( final ProjectName projectName, final CreateAttachment icon, final int size );", "originalCommit": "29c487618648aea1aade659658ba00b5fd2568c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA0NTU2MQ==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414045561", "bodyText": "To which width image will be scaled (if it's bigger). But size I like more than width  as a param here.", "author": "vbradnitski", "createdAt": "2020-04-23T18:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwNzAxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDAwODgxNA==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414008814", "bodyText": "No TODOs, please", "author": "rymsha", "createdAt": "2020-04-23T18:00:52Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -85,6 +85,45 @@ public static ImageWriter getWriterByFormat( final String format )\n         }\n     }\n \n+    public static String getFormatByMimeType( final String mimeType )\n+        throws IOException\n+    {\n+        final Iterator<ImageWriter> i = ImageIO.getImageWritersByMIMEType( mimeType );\n+        if ( !i.hasNext() )\n+        {\n+            throw new IOException( \"The image-based media type \" + mimeType + \" is not supported for writing\" );\n+        }\n+\n+        return i.next().getOriginatingProvider().getFormatNames()[0];\n+    }\n+\n+    public static ByteSource serializeImage( final BufferedImage bufferedImage, final String mimeType, final int quality )\n+        throws IOException\n+    {\n+        final byte[] serializedImage;\n+        //TODO If/Else due to a difference of treatment between admin and portal. Should be uniform", "originalCommit": "29c487618648aea1aade659658ba00b5fd2568c1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "url": "https://github.com/enonic/xp/commit/b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "message": "Implement upload of project icon #8044", "committedDate": "2020-04-23T19:09:22Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5Njk5OQ==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414096999", "bodyText": "Format is only part of hash, right? If so, it should be private", "author": "rymsha", "createdAt": "2020-04-23T20:20:48Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -85,6 +85,44 @@ public static ImageWriter getWriterByFormat( final String format )\n         }\n     }\n \n+    public static String getFormatByMimeType( final String mimeType )", "originalCommit": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MTIzNw==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414351237", "bodyText": "no, we have deprecated api method to fetch it.", "author": "vbradnitski", "createdAt": "2020-04-24T07:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5Njk5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5ODk3OA==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414098978", "bodyText": "Float is slower and less precise.\nAnyway let's make a more generic solution.", "author": "rymsha", "createdAt": "2020-04-23T20:24:05Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -203,6 +241,18 @@ public static BufferedImage scaleSquare( final BufferedImage source, final int s\n         return getScaledInstance( cropped, size, size );\n     }\n \n+    public static BufferedImage scaleWidth( BufferedImage source, final int size )\n+    {\n+        int width = source.getWidth();\n+        int height = source.getHeight();\n+        float scale = (float) size / (float) width;", "originalCommit": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA5OTQ1MQ==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414099451", "bodyText": "newWidth instead of size\nAPI should have more generic method. This one is too specific", "author": "rymsha", "createdAt": "2020-04-23T20:25:00Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -203,6 +241,18 @@ public static BufferedImage scaleSquare( final BufferedImage source, final int s\n         return getScaledInstance( cropped, size, size );\n     }\n \n+    public static BufferedImage scaleWidth( BufferedImage source, final int size )", "originalCommit": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMTk4MA==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414101980", "bodyText": "Avoid ByteSource in API. byte[] is ok here", "author": "rymsha", "createdAt": "2020-04-23T20:29:14Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/image/ImageHelper.java", "diffHunk": "@@ -85,6 +85,44 @@ public static ImageWriter getWriterByFormat( final String format )\n         }\n     }\n \n+    public static String getFormatByMimeType( final String mimeType )\n+        throws IOException\n+    {\n+        final Iterator<ImageWriter> i = ImageIO.getImageWritersByMIMEType( mimeType );\n+        if ( !i.hasNext() )\n+        {\n+            throw new IOException( \"The image-based media type \" + mimeType + \" is not supported for writing\" );\n+        }\n+\n+        return i.next().getOriginatingProvider().getFormatNames()[0];\n+    }\n+\n+    public static ByteSource serializeImage( final BufferedImage bufferedImage, final String mimeType, final int quality )", "originalCommit": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwMzYyNg==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414103626", "bodyText": "width?", "author": "rymsha", "createdAt": "2020-04-23T20:31:56Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/project/ModifyProjectIconParams.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.enonic.xp.project;\n+\n+import com.google.common.base.Preconditions;\n+\n+import com.enonic.xp.annotation.PublicApi;\n+import com.enonic.xp.attachment.CreateAttachment;\n+\n+@PublicApi\n+public final class ModifyProjectIconParams\n+{\n+    private final ProjectName name;\n+\n+    private final CreateAttachment icon;\n+\n+    private final int size;", "originalCommit": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDEwNTI3NA==", "url": "https://github.com/enonic/xp/pull/8045#discussion_r414105274", "bodyText": "debug.", "author": "rymsha", "createdAt": "2020-04-23T20:34:52Z", "path": "modules/core/core-project/src/main/java/com/enonic/xp/core/impl/project/ProjectServiceImpl.java", "diffHunk": "@@ -161,6 +162,43 @@ private Project doModify( final ModifyProjectParams params )\n         return Project.from( updatedRepository );\n     }\n \n+    @Override\n+    public void modifyIcon( final ModifyProjectIconParams params )\n+    {\n+        callWithUpdateContext( ( () -> {\n+            doModifyIcon( params );\n+            LOG.info( \"Icon for project updated: \" + params.getName() );", "originalCommit": "b1d7b62cb445ef69be8bc81c43f0e8829b0846a5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1439e0adf72f3bef7bb65162b1e43f08a4581f9e", "url": "https://github.com/enonic/xp/commit/1439e0adf72f3bef7bb65162b1e43f08a4581f9e", "message": "Implement upload of project icon #8044", "committedDate": "2020-04-24T10:39:10Z", "type": "commit"}, {"oid": "1439e0adf72f3bef7bb65162b1e43f08a4581f9e", "url": "https://github.com/enonic/xp/commit/1439e0adf72f3bef7bb65162b1e43f08a4581f9e", "message": "Implement upload of project icon #8044", "committedDate": "2020-04-24T10:39:10Z", "type": "forcePushed"}]}