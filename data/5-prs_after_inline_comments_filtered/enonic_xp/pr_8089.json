{"pr_number": 8089, "pr_title": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "pr_createdAt": "2020-05-15T18:11:49Z", "pr_url": "https://github.com/enonic/xp/pull/8089", "timeline": [{"oid": "c0a1cd9f5ae959f760280cba9822528d87a6d02a", "url": "https://github.com/enonic/xp/commit/c0a1cd9f5ae959f760280cba9822528d87a6d02a", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-15T21:10:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3NDc1Mg==", "url": "https://github.com/enonic/xp/pull/8089#discussion_r425974752", "bodyText": "For simplicity it can be just boolean", "author": "rymsha", "createdAt": "2020-05-15T18:25:35Z", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/vacuum/versiontable/VersionTableCleanupTask.java", "diffHunk": "@@ -222,4 +208,9 @@ public void setVersionService( final VersionService versionService )\n     {\n         this.versionService = versionService;\n     }\n+\n+    private enum Status\n+    {\n+        NOT_STARTED, IN_PROGRESS", "originalCommit": "e1c1b217b2181fba709b10682f48dc4e161a7f28", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3NTI1MA==", "url": "https://github.com/enonic/xp/pull/8089#discussion_r425975250", "bodyText": "generify Object", "author": "rymsha", "createdAt": "2020-05-15T18:26:34Z", "path": "modules/core/core-api/src/main/java/com/enonic/xp/node/AbstractQuery.java", "diffHunk": "@@ -44,6 +45,8 @@\n \n     private final boolean explain;\n \n+    private final Consumer<Object> batchCallback;", "originalCommit": "e1c1b217b2181fba709b10682f48dc4e161a7f28", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwOTY1Ng==", "url": "https://github.com/enonic/xp/pull/8089#discussion_r426409656", "bodyText": "Or, for now remove generic <Object>", "author": "rymsha", "createdAt": "2020-05-18T07:07:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTk3NTI1MA=="}], "type": "inlineReview"}, {"oid": "f8c12958fb296ef643077c628b371d0799318752", "url": "https://github.com/enonic/xp/commit/f8c12958fb296ef643077c628b371d0799318752", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-16T16:02:53Z", "type": "forcePushed"}, {"oid": "3c3d93dfa5f686ddc3e690ec763792afc8376635", "url": "https://github.com/enonic/xp/commit/3c3d93dfa5f686ddc3e690ec763792afc8376635", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-16T16:04:57Z", "type": "forcePushed"}, {"oid": "b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc", "url": "https://github.com/enonic/xp/commit/b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-16T16:06:24Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQwOTQxMQ==", "url": "https://github.com/enonic/xp/pull/8089#discussion_r426409411", "bodyText": "should not be here", "author": "rymsha", "createdAt": "2020-05-18T07:06:58Z", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/dump/RepoDumper.java", "diffHunk": "@@ -2,13 +2,15 @@\n \n import java.time.Duration;\n import java.time.Instant;\n+import java.util.HashSet;\n import java.util.Set;\n+import java.util.function.Consumer;\n import java.util.stream.Collectors;\n \n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import com.google.common.collect.Sets;\n+import jdk.net.SocketFlow;", "originalCommit": "b9cb8ff02850348ffde6ea3fbd39da7aa80cbbdc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5ccece9d6f5790213cde7fe0425dd744e60e7bf3", "url": "https://github.com/enonic/xp/commit/5ccece9d6f5790213cde7fe0425dd744e60e7bf3", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-18T08:22:25Z", "type": "forcePushed"}, {"oid": "32178fdd9feb2131e0a0e6d1b0ecf1929d9998b2", "url": "https://github.com/enonic/xp/commit/32178fdd9feb2131e0a0e6d1b0ecf1929d9998b2", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-18T08:25:06Z", "type": "forcePushed"}, {"oid": "063581d7b46b4a231c5f3bd1aa588f21a046fea4", "url": "https://github.com/enonic/xp/commit/063581d7b46b4a231c5f3bd1aa588f21a046fea4", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-18T09:46:39Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUxOTg1OA==", "url": "https://github.com/enonic/xp/pull/8089#discussion_r426519858", "bodyText": "will be better to use isEmpty", "author": "anatol-sialitski", "createdAt": "2020-05-18T10:16:14Z", "path": "modules/core/core-repo/src/main/java/com/enonic/xp/repo/impl/vacuum/versiontable/VersionTableCleanupTask.java", "diffHunk": "@@ -181,28 +147,56 @@ private boolean versionUsedInAnyBranch( final Repository repository, final NodeV\n         return false;\n     }\n \n-    private NodeVersionQuery createQuery( final NodeVersionId lastVersionId )\n+    private NodeVersionQuery createQuery( final Repository repository )\n     {\n         final NodeVersionQuery.Builder builder = NodeVersionQuery.create();\n \n-        if ( lastVersionId != null )\n+        builder.addQueryFilter( RangeFilter.create().\n+            fieldName( VersionIndexPath.TIMESTAMP.getPath() ).\n+            to( ValueFactory.newDateTime( this.until ) ).\n+            build() );\n+\n+        builder.size( -1 ).\n+            batchSize( 100 ).\n+            batchCallback( result -> this.handleBatchCallback( (SearchResult) result, repository, builder.build() ) );\n+\n+        return builder.build();\n+    }\n+\n+    private void handleBatchCallback( final SearchResult searchResult, final Repository repository,\n+                                      final NodeVersionQuery nodeVersionQuery )\n+    {\n+        final List<NodeVersionDocumentId> toBeDeleted = Lists.newArrayList();\n+\n+        final long versionTotal = searchResult.getTotalHits();\n+        if ( !this.repositoryCleanStarted )\n         {\n-            final RangeFilter versionIdFilter = RangeFilter.create().\n-                fieldName( VersionIndexPath.VERSION_ID.getPath() ).\n-                from( ValueFactory.newString( lastVersionId.toString() ) ).\n-                build();\n-            builder.addQueryFilter( versionIdFilter );\n+            if ( listener != null )\n+            {\n+                listener.vacuumingVersionRepository( repository.getId(), versionTotal );\n+\n+            }\n+            this.repositoryCleanStarted = true;\n         }\n \n-        final RangeFilter mustBeOlderThanFilter = RangeFilter.create().\n-            fieldName( VersionIndexPath.TIMESTAMP.getPath() ).\n-            to( ValueFactory.newDateTime( this.until ) ).\n-            build();\n+        if ( searchResult.getHits().getSize() == 0 )", "originalCommit": "063581d7b46b4a231c5f3bd1aa588f21a046fea4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "url": "https://github.com/enonic/xp/commit/c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-18T10:23:49Z", "type": "commit"}, {"oid": "c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "url": "https://github.com/enonic/xp/commit/c6d9d9c5e66b7bf8d0b99b2643034b36eec1b434", "message": "Vacuum and Dump fail on big repository (XP 6.15) #8069", "committedDate": "2020-05-18T10:23:49Z", "type": "forcePushed"}]}