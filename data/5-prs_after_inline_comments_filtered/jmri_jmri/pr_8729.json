{"pr_number": 8729, "pr_title": "Fix for zimo mx 1, mxulf to initialize programmer properly ", "pr_createdAt": "2020-06-24T12:27:52Z", "pr_url": "https://github.com/JMRI/JMRI/pull/8729", "timeline": [{"oid": "c1674f4183a5aa9e12296b323a4679b11611294d", "url": "https://github.com/JMRI/JMRI/commit/c1674f4183a5aa9e12296b323a4679b11611294d", "message": "The programmerManager and default programmer is being created before hardware is initialized for the Zimo MXULF and MX-1 drivers. This fix forces the code to recreate the program managers after the COM port is open and the hardware is initialized.", "committedDate": "2020-06-24T02:52:23Z", "type": "commit"}, {"oid": "7ccee7aef6e09515161dbcf68f0e1d761fe959c3", "url": "https://github.com/JMRI/JMRI/commit/7ccee7aef6e09515161dbcf68f0e1d761fe959c3", "message": "Merge branch 'master' of https://github.com/JMRI/JMRI", "committedDate": "2020-06-24T12:22:01Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg1OTIxNg==", "url": "https://github.com/JMRI/JMRI/pull/8729#discussion_r444859216", "bodyText": "An alternative approach could possibly not create the default programmer at all and defer creation until this point,  This seemed safer as I did not know the consequences for the former approach. Other better alternatives could also exist?\nThis fix restores CV read / write when using decoder pro with the zimo MXULF.  When the default programmer was created the traffic controller had not been initialized yet so the default programmer had a traffic controller with a value of null.  At this point in the code the traffic controller exists so when the programmer is re-create it has a non-null traffic controller which uses the binary protocol.", "author": "AlgerP572", "createdAt": "2020-06-24T12:31:56Z", "path": "java/src/jmri/jmrix/zimo/Mx1SystemConnectionMemo.java", "diffHunk": "@@ -141,6 +141,11 @@ public boolean provides(Class<?> type) {\n      * hexfile.HexFileFrame and locormi.LnMessageClient\n      */\n     public void configureManagers() {\n+        \n+        /* Already created during config with default settings. Recreating\n+        * now that the traffic controller exists\n+        */\n+        programmerManager = null;", "originalCommit": "c1674f4183a5aa9e12296b323a4679b11611294d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg3ODMzOQ==", "url": "https://github.com/JMRI/JMRI/pull/8729#discussion_r444878339", "bodyText": "I think it would be better to defer creation until after the traffic controller is created.\nIt is possible the earlier creation is technical debt from a previous incarnation.", "author": "pabender", "createdAt": "2020-06-24T13:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg1OTIxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTA0MzM4Ng==", "url": "https://github.com/JMRI/JMRI/pull/8729#discussion_r445043386", "bodyText": "Possibly, I'm not super familiar with the architecture.  Let me try to understand if we could defer creation easily or not.  Is using the configure managers method the preferred approach?  I'll try to get all creation to occur within this method.", "author": "AlgerP572", "createdAt": "2020-06-24T17:06:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDg1OTIxNg=="}], "type": "inlineReview"}, {"oid": "5467470588a8d02cf8f451761bc7671f656cac71", "url": "https://github.com/JMRI/JMRI/commit/5467470588a8d02cf8f451761bc7671f656cac71", "message": "Address code review comment. Hard coding return true for GlobalProgrammerManager and return false for AddressedProgramManager.  This allows creation of the ProgrammerManager Instance to be defered until collaborating objects have been created.", "committedDate": "2020-06-25T03:49:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTI5Mjg1Mg==", "url": "https://github.com/JMRI/JMRI/pull/8729#discussion_r445292852", "bodyText": "@pabender The above fix eliminates the need to reset the program manager to null and it creates the program manager with the traffic controller.  I have tested the fix and I am able to read /write my decoders again. \ud83d\udc4d", "author": "AlgerP572", "createdAt": "2020-06-25T03:56:57Z", "path": "java/src/jmri/jmrix/zimo/Mx1SystemConnectionMemo.java", "diffHunk": "@@ -141,11 +141,6 @@ public boolean provides(Class<?> type) {\n      * hexfile.HexFileFrame and locormi.LnMessageClient\n      */\n     public void configureManagers() {\n-        \n-        /* Already created during config with default settings. Recreating\n-        * now that the traffic controller exists\n-        */\n-        programmerManager = null;", "originalCommit": "5467470588a8d02cf8f451761bc7671f656cac71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ3MzM3MA==", "url": "https://github.com/JMRI/JMRI/pull/8729#discussion_r445473370", "bodyText": "I found the above to lines were the only place that the ProgrammerManger was used before the traffic controller has existed,  Returning true or false directly here allows the creation of the program manager to be deferred and also seems consistent with what was done in this method for the other manager types.", "author": "AlgerP572", "createdAt": "2020-06-25T10:53:32Z", "path": "java/src/jmri/jmrix/zimo/Mx1SystemConnectionMemo.java", "diffHunk": "@@ -83,11 +83,11 @@ public boolean provides(Class<?> type) {\n         if (getDisabled()) {\n             return false;\n         }\n-        if (type.equals(jmri.GlobalProgrammerManager.class)) {\n-            return getProgrammerManager().isGlobalProgrammerAvailable();\n+        if (type.equals(jmri.GlobalProgrammerManager.class)) {            \n+            return true;\n         }\n-        if (type.equals(jmri.AddressedProgrammerManager.class)) {\n-            return getProgrammerManager().isAddressedModePossible();\n+        if (type.equals(jmri.AddressedProgrammerManager.class)) {            \n+            return false;", "originalCommit": "5467470588a8d02cf8f451761bc7671f656cac71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTUyODA0NQ==", "url": "https://github.com/JMRI/JMRI/pull/8729#discussion_r445528045", "bodyText": "I don\u2019t think the problem is that the traffic controller doesn\u2019t exist, but that the programmer manager doesn\u2019t exist the first time the provided method is called.\nThis fix is consistent with other systems that use this configuration approach however.", "author": "pabender", "createdAt": "2020-06-25T12:43:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTQ3MzM3MA=="}], "type": "inlineReview"}]}