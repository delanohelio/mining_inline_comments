{"pr_number": 8262, "pr_title": "AbstractThrottle updateFunction", "pr_createdAt": "2020-03-21T03:04:02Z", "pr_url": "https://github.com/JMRI/JMRI/pull/8262", "timeline": [{"oid": "573f44c4734a45dcd041ab5f5b6d627bff392bcb", "url": "https://github.com/JMRI/JMRI/commit/573f44c4734a45dcd041ab5f5b6d627bff392bcb", "message": "Add updateFunction to AbstractThrottle", "committedDate": "2020-03-21T02:49:19Z", "type": "commit"}, {"oid": "319de66a0b1d18f597fae3ba4b16f22c6f9f5cdf", "url": "https://github.com/JMRI/JMRI/commit/319de66a0b1d18f597fae3ba4b16f22c6f9f5cdf", "message": "update hardware Thhrottles", "committedDate": "2020-03-21T02:50:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NDQyOA==", "url": "https://github.com/JMRI/JMRI/pull/8262#discussion_r395994428", "bodyText": "I have mixed emotions about this change.\nYou've taken a set of small functions and combined their logic into one.  This is the opposite of the way good coding practice should have us moving.  Codeclimate correctly flags this by noting\n\nThe updateFunction method is Long (179 lines) which makes it difficult to understand\nThe updateFunction method has a large cognitive complexity (59) which exceeds  the 20 we have set in our configuration\n\nBut, I see that you're taking this from several places and putting it into one, and that generally is a good thing.\nBut I think we can do better, and here's how:\nChange the f0..f28 variables in AbstractThrottle to be an array with 29 entries\nre-write this method so it uses the array and constructs the property change values instead of using the constants.  (see the jmri.Throttle interface which defines them)\nYou'll also need to modify any throttle that extends AbstractThrottle and uses the f0..f28 values directly, which increase the footprint of this PR, but the code will be cleaner.  (These are protected values, so they aren't externally visible, except in the AbstractThrottle and it's decendents ).", "author": "pabender", "createdAt": "2020-03-21T13:52:19Z", "path": "java/src/jmri/jmrix/AbstractThrottle.java", "diffHunk": "@@ -836,378 +836,452 @@ public float getSpeedIncrement() {\n      */\n     @Override\n     public void setF0(boolean f0) {\n-        boolean old = this.f0;\n-        this.f0 = f0;\n+        updateFunction(0,f0);\n         sendFunctionGroup1();\n-        if (old != this.f0) {\n-            notifyPropertyChangeListener(Throttle.F0, old, this.f0);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF1(boolean f1) {\n-        boolean old = this.f1;\n-        this.f1 = f1;\n+        updateFunction(1,f1);\n         sendFunctionGroup1();\n-        if (old != this.f1) {\n-            notifyPropertyChangeListener(Throttle.F1, old, this.f1);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF2(boolean f2) {\n-        boolean old = this.f2;\n-        this.f2 = f2;\n+        updateFunction(2,f2);\n         sendFunctionGroup1();\n-        if (old != this.f2) {\n-            notifyPropertyChangeListener(Throttle.F2, old, this.f2);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF3(boolean f3) {\n-        boolean old = this.f3;\n-        this.f3 = f3;\n+        updateFunction(3,f3);\n         sendFunctionGroup1();\n-        if (old != this.f3) {\n-            notifyPropertyChangeListener(Throttle.F3, old, this.f3);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF4(boolean f4) {\n-        boolean old = this.f4;\n-        this.f4 = f4;\n+        updateFunction(4,f4);\n         sendFunctionGroup1();\n-        if (old != this.f4) {\n-            notifyPropertyChangeListener(Throttle.F4, old, this.f4);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF5(boolean f5) {\n-        boolean old = this.f5;\n-        this.f5 = f5;\n+        updateFunction(5,f5);\n         sendFunctionGroup2();\n-        if (old != this.f5) {\n-            notifyPropertyChangeListener(Throttle.F5, old, this.f5);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF6(boolean f6) {\n-        boolean old = this.f6;\n-        this.f6 = f6;\n+        updateFunction(6,f6);\n         sendFunctionGroup2();\n-        if (old != this.f6) {\n-            notifyPropertyChangeListener(Throttle.F6, old, this.f6);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF7(boolean f7) {\n-        boolean old = this.f7;\n-        this.f7 = f7;\n+        updateFunction(7,f7);\n         sendFunctionGroup2();\n-        if (old != this.f7) {\n-            notifyPropertyChangeListener(Throttle.F7, old, this.f7);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF8(boolean f8) {\n-        boolean old = this.f8;\n-        this.f8 = f8;\n+        updateFunction(8,f8);\n         sendFunctionGroup2();\n-        if (old != this.f8) {\n-            notifyPropertyChangeListener(Throttle.F8, old, this.f8);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF9(boolean f9) {\n-        boolean old = this.f9;\n-        this.f9 = f9;\n+        updateFunction(9,f9);\n         sendFunctionGroup3();\n-        if (old != this.f9) {\n-            notifyPropertyChangeListener(Throttle.F9, old, this.f9);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF10(boolean f10) {\n-        boolean old = this.f10;\n-        this.f10 = f10;\n+        updateFunction(10,f10);\n         sendFunctionGroup3();\n-        if (old != this.f10) {\n-            notifyPropertyChangeListener(Throttle.F10, old, this.f10);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF11(boolean f11) {\n-        boolean old = this.f11;\n-        this.f11 = f11;\n+        updateFunction(11,f11);\n         sendFunctionGroup3();\n-        if (old != this.f11) {\n-            notifyPropertyChangeListener(Throttle.F11, old, this.f11);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF12(boolean f12) {\n-        boolean old = this.f12;\n-        this.f12 = f12;\n+        updateFunction(12,f12);\n         sendFunctionGroup3();\n-        if (old != this.f12) {\n-            notifyPropertyChangeListener(Throttle.F12, old, this.f12);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF13(boolean f13) {\n-        boolean old = this.f13;\n-        this.f13 = f13;\n+        updateFunction(13,f13);\n         sendFunctionGroup4();\n-        if (old != this.f13) {\n-            notifyPropertyChangeListener(Throttle.F13, old, this.f13);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF14(boolean f14) {\n-        boolean old = this.f14;\n-        this.f14 = f14;\n+        updateFunction(14,f14);\n         sendFunctionGroup4();\n-        if (old != this.f14) {\n-            notifyPropertyChangeListener(Throttle.F14, old, this.f14);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF15(boolean f15) {\n-        boolean old = this.f15;\n-        this.f15 = f15;\n+        updateFunction(15,f15);\n         sendFunctionGroup4();\n-        if (old != this.f15) {\n-            notifyPropertyChangeListener(Throttle.F15, old, this.f15);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF16(boolean f16) {\n-        boolean old = this.f16;\n-        this.f16 = f16;\n+        updateFunction(16,f16);\n         sendFunctionGroup4();\n-        if (old != this.f16) {\n-            notifyPropertyChangeListener(Throttle.F16, old, this.f16);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF17(boolean f17) {\n-        boolean old = this.f17;\n-        this.f17 = f17;\n+        updateFunction(17,f17);\n         sendFunctionGroup4();\n-        if (old != this.f17) {\n-            notifyPropertyChangeListener(Throttle.F17, old, this.f17);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF18(boolean f18) {\n-        boolean old = this.f18;\n-        this.f18 = f18;\n+        updateFunction(18,f18);\n         sendFunctionGroup4();\n-        if (old != this.f18) {\n-            notifyPropertyChangeListener(Throttle.F18, old, this.f18);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF19(boolean f19) {\n-        boolean old = this.f19;\n-        this.f19 = f19;\n+        updateFunction(19,f19);\n         sendFunctionGroup4();\n-        if (old != this.f19) {\n-            notifyPropertyChangeListener(Throttle.F19, old, this.f19);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF20(boolean f20) {\n-        boolean old = this.f20;\n-        this.f20 = f20;\n+        updateFunction(20,f20);\n         sendFunctionGroup4();\n-        if (old != this.f20) {\n-            notifyPropertyChangeListener(Throttle.F20, old, this.f20);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF21(boolean f21) {\n-        boolean old = this.f21;\n-        this.f21 = f21;\n+        updateFunction(21,f21);\n         sendFunctionGroup5();\n-        if (old != this.f21) {\n-            notifyPropertyChangeListener(Throttle.F21, old, this.f21);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF22(boolean f22) {\n-        boolean old = this.f22;\n-        this.f22 = f22;\n+        updateFunction(22,f22);\n         sendFunctionGroup5();\n-        if (old != this.f22) {\n-            notifyPropertyChangeListener(Throttle.F22, old, this.f22);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF23(boolean f23) {\n-        boolean old = this.f23;\n-        this.f23 = f23;\n+        updateFunction(23,f23);\n         sendFunctionGroup5();\n-        if (old != this.f23) {\n-            notifyPropertyChangeListener(Throttle.F23, old, this.f23);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF24(boolean f24) {\n-        boolean old = this.f24;\n-        this.f24 = f24;\n+        updateFunction(24,f24);\n         sendFunctionGroup5();\n-        if (old != this.f24) {\n-            notifyPropertyChangeListener(Throttle.F24, old, this.f24);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF25(boolean f25) {\n-        boolean old = this.f25;\n-        this.f25 = f25;\n+        updateFunction(25,f25);\n         sendFunctionGroup5();\n-        if (old != this.f25) {\n-            notifyPropertyChangeListener(Throttle.F25, old, this.f25);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF26(boolean f26) {\n-        boolean old = this.f26;\n-        this.f26 = f26;\n+        updateFunction(26,f26);\n         sendFunctionGroup5();\n-        if (old != this.f26) {\n-            notifyPropertyChangeListener(Throttle.F26, old, this.f26);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF27(boolean f27) {\n-        boolean old = this.f27;\n-        this.f27 = f27;\n+        updateFunction(27,f27);\n         sendFunctionGroup5();\n-        if (old != this.f27) {\n-            notifyPropertyChangeListener(Throttle.F27, old, this.f27);\n-        }\n     }\n \n     /**\n      * {@inheritDoc}\n      */\n     @Override\n     public void setF28(boolean f28) {\n-        boolean old = this.f28;\n-        this.f28 = f28;\n+        updateFunction(28,f28);\n         sendFunctionGroup5();\n-        if (old != this.f28) {\n-            notifyPropertyChangeListener(Throttle.F28, old, this.f28);\n+    }\n+    \n+    /**\n+     * Update the state of a single function.\n+     * Updates function value and ChangeListener.\n+     * Does not send outward message TO hardware.\n+     * @param fn Function Number 0-28\n+     * @param state On - True, Off - False\n+     */\n+    public void updateFunction(int fn, boolean state) {", "originalCommit": "319de66a0b1d18f597fae3ba4b16f22c6f9f5cdf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwNzA5NQ==", "url": "https://github.com/JMRI/JMRI/pull/8262#discussion_r396007095", "bodyText": "Incidentally, if you want to get this merged in as is, I would be happy to take on the changes I suggest.", "author": "pabender", "createdAt": "2020-03-21T16:35:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NDQyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAzODUxNQ==", "url": "https://github.com/JMRI/JMRI/pull/8262#discussion_r396038515", "bodyText": "Thanks for the comments, I was contemplating an Enum for the functions but an Array much easier, please see update.", "author": "icklesteve", "createdAt": "2020-03-21T23:29:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTk5NDQyOA=="}], "type": "inlineReview"}, {"oid": "298437a87f71f0067a63043a6e5c60a8c6dd844c", "url": "https://github.com/JMRI/JMRI/commit/298437a87f71f0067a63043a6e5c60a8c6dd844c", "message": "move function booleans to array", "committedDate": "2020-03-21T23:13:22Z", "type": "commit"}, {"oid": "8f665c14edf5b4defe1082116c262d0ce3d3f888", "url": "https://github.com/JMRI/JMRI/commit/8f665c14edf5b4defe1082116c262d0ce3d3f888", "message": "Most Throttles to new method", "committedDate": "2020-03-21T23:16:15Z", "type": "commit"}, {"oid": "5685fe45e045eb8b7742252f67548d3494895d54", "url": "https://github.com/JMRI/JMRI/commit/5685fe45e045eb8b7742252f67548d3494895d54", "message": "Update TamsThrottle.java", "committedDate": "2020-03-21T23:25:27Z", "type": "commit"}, {"oid": "f315a604712f3f3f198965979aabaa3f69f5eb08", "url": "https://github.com/JMRI/JMRI/commit/f315a604712f3f3f198965979aabaa3f69f5eb08", "message": "update LocoNetSlot / LocoNetThrottle", "committedDate": "2020-03-21T23:26:40Z", "type": "commit"}, {"oid": "5b495dc97194d911b3e1ba3f305d1a5288b0f1bd", "url": "https://github.com/JMRI/JMRI/commit/5b495dc97194d911b3e1ba3f305d1a5288b0f1bd", "message": "Update XNetThrottle.java", "committedDate": "2020-03-21T23:26:59Z", "type": "commit"}, {"oid": "05cdd15aa6308f946a242d674ef9983e41cb307b", "url": "https://github.com/JMRI/JMRI/commit/05cdd15aa6308f946a242d674ef9983e41cb307b", "message": "Update EcosDccThrottle.java", "committedDate": "2020-03-22T00:08:42Z", "type": "commit"}]}