{"pr_number": 8910, "pr_title": "Separate topic strings for MQTT turnout send and receive", "pr_createdAt": "2020-08-09T20:25:20Z", "pr_url": "https://github.com/JMRI/JMRI/pull/8910", "timeline": [{"oid": "b00ea288644fa7698517f52166ab8f5b289cb7c4", "url": "https://github.com/JMRI/JMRI/commit/b00ea288644fa7698517f52166ab8f5b289cb7c4", "message": "separate topic strings for send and receive", "committedDate": "2020-08-09T20:23:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzYyODM0Mg==", "url": "https://github.com/JMRI/JMRI/pull/8910#discussion_r467628342", "bodyText": "Noticed now that this state is removed. This is not the same as inconsistent.\nMOVING is a controlled state showing that the turnout is switching position. It should not be removed.", "author": "elestedt", "createdAt": "2020-08-09T21:00:48Z", "path": "java/src/jmri/jmrix/mqtt/MqttTurnout.java", "diffHunk": "@@ -12,85 +12,83 @@\n public class MqttTurnout extends AbstractTurnout implements MqttEventListener {\n \n     private final MqttAdapter mqttAdapter;\n-    private final String topic;\n-    private final static String stateTopicPrefix = \"state/\";\n-    private final static String commandTopicPrefix = \"command/\";\n+    private final String sendTopic;\n+    private final String rcvTopic;\n \n     /**\n      * Requires, but does not check, that the system name and topic be consistent\n      * @param ma Adapter to reference for connection\n      * @param systemName System name of turnout\n-     * @param topic MQTT topic being used\n+     * @param sendTopicFormat MQTT topic to use when sending (full string, including systemName part)\n+     * @param sendTopicFormat MQTT topic to use when receiving (full string, including systemName part)\n      */\n-    MqttTurnout(MqttAdapter ma, String systemName, String topic) {\n+    MqttTurnout(MqttAdapter ma, String systemName, String sendTopic, String rcvTopic) {\n         super(systemName);\n-        this.topic = topic;\n+        this.sendTopic = sendTopic;\n+        this.rcvTopic  = rcvTopic;\n         mqttAdapter = ma;\n-        mqttAdapter.subscribe(getStateTopicPrefix() + topic, this);\n-        _validFeedbackNames = new String[] {\"DIRECT\", \"ONESENSOR\", \"TWOSENSOR\", \"DELAYED\", \"MONITORING\", \"EXACT\"};\n-        _validFeedbackModes = new int[] {DIRECT, ONESENSOR, TWOSENSOR, DELAYED, MONITORING, EXACT};\n+        mqttAdapter.subscribe(rcvTopic, this);  // only receive receive topic, not send one\n+        _validFeedbackNames = new String[] {\"DIRECT\", \"ONESENSOR\", \"TWOSENSOR\", \"DELAYED\", \"MONITORING\"};\n+        _validFeedbackModes = new int[] {DIRECT, ONESENSOR, TWOSENSOR, DELAYED, MONITORING};\n         _validFeedbackTypes = DIRECT | ONESENSOR | TWOSENSOR | DELAYED | MONITORING;\n     }\n \n-    private String getStateTopicPrefix() {\n-        return (getFeedbackMode() == EXACT ? stateTopicPrefix : \"\");\n-    }\n-\n-    private String getCommandTopicPrefix() {\n-        return (getFeedbackMode() == EXACT ? commandTopicPrefix : \"\");\n-    }\n-\n-    @Override\n-    public void setFeedbackMode(int mode) throws IllegalArgumentException {\n-        mqttAdapter.unsubscribe(getStateTopicPrefix() + topic, this);\n-        try {\n-            super.setFeedbackMode(mode);\n-        } finally {\n-            mqttAdapter.subscribe(getStateTopicPrefix() + topic, this);\n-        }\n-    }\n-\n     public void setParser(MqttContentParser<Turnout> parser) {\n         this.parser = parser;\n     }\n-    \n+        \n     MqttContentParser<Turnout> parser = new MqttContentParser<Turnout>() {\n         private final static String closedText = \"CLOSED\";\n         private final static String thrownText = \"THROWN\";\n         private final static String unknownText = \"UNKNOWN\";\n         private final static String inconsistentText = \"INCONSISTENT\";\n-        private final static String movingText = \"MOVING\";", "originalCommit": "b00ea288644fa7698517f52166ab8f5b289cb7c4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9a371fc0fecdc8cb6c530b493e22d1a0f30f325d", "url": "https://github.com/JMRI/JMRI/commit/9a371fc0fecdc8cb6c530b493e22d1a0f30f325d", "message": "migrate", "committedDate": "2020-08-09T21:05:01Z", "type": "commit"}, {"oid": "0d3950f509252c7bbc89fc031f5ba5ae123e7b80", "url": "https://github.com/JMRI/JMRI/commit/0d3950f509252c7bbc89fc031f5ba5ae123e7b80", "message": "doc, javadoc", "committedDate": "2020-08-09T21:05:16Z", "type": "commit"}, {"oid": "9890b298578f7ef9722492a99f2d955f907ec8b6", "url": "https://github.com/JMRI/JMRI/commit/9890b298578f7ef9722492a99f2d955f907ec8b6", "message": "add sensors", "committedDate": "2020-08-09T21:52:30Z", "type": "commit"}, {"oid": "e9f407a774d65adcb91eef84adcba713d42dcd3b", "url": "https://github.com/JMRI/JMRI/commit/e9f407a774d65adcb91eef84adcba713d42dcd3b", "message": "javadoc", "committedDate": "2020-08-09T23:05:28Z", "type": "commit"}]}