{"pr_number": 9174, "pr_title": "Update slot status after a slot move message.", "pr_createdAt": "2020-11-24T18:26:24Z", "pr_url": "https://github.com/JMRI/JMRI/pull/9174", "timeline": [{"oid": "62b20b3fd4cf39dc1f640483d337ae31acae302a", "url": "https://github.com/JMRI/JMRI/commit/62b20b3fd4cf39dc1f640483d337ae31acae302a", "message": "Update slot status after a slot move message.", "committedDate": "2020-11-24T18:17:57Z", "type": "commit"}, {"oid": "6d3abcc4d8ee232b5df0be0e080ffb06aaca7d98", "url": "https://github.com/JMRI/JMRI/commit/6d3abcc4d8ee232b5df0be0e080ffb06aaca7d98", "message": "iI should actually call the routine, it would help just a tad.", "committedDate": "2020-11-24T21:08:19Z", "type": "commit"}, {"oid": "c3480d3042156defb33d7c2c486887a320329ce4", "url": "https://github.com/JMRI/JMRI/commit/c3480d3042156defb33d7c2c486887a320329ce4", "message": "Merge branch 'master' into 20201124-ReadSlotAfterMove", "committedDate": "2020-11-30T20:10:19Z", "type": "commit"}, {"oid": "80ddc673eef358d04052fbaae9dfe14523f447fb", "url": "https://github.com/JMRI/JMRI/commit/80ddc673eef358d04052fbaae9dfe14523f447fb", "message": "Use a delayedslot read to update slot\nafter setting to common, dispatching, true moveing.\nWhen disposing only set common if currently inuse, let CS do its stuff\nDont set slot common after dispatch, the move could be rejected, just get the new status.", "committedDate": "2020-12-02T20:19:07Z", "type": "commit"}, {"oid": "7dce855381a687afd6b4c0d90bab3e89740c3fdc", "url": "https://github.com/JMRI/JMRI/commit/7dce855381a687afd6b4c0d90bab3e89740c3fdc", "message": "Merge branch 'master' into 20201124-ReadSlotAfterMove", "committedDate": "2020-12-02T20:31:14Z", "type": "commit"}, {"oid": "99eb84c2b7277e7306c4fa19750cdd066892daf1", "url": "https://github.com/JMRI/JMRI/commit/99eb84c2b7277e7306c4fa19750cdd066892daf1", "message": "remove spaces at eol", "committedDate": "2020-12-02T20:37:06Z", "type": "commit"}, {"oid": "a9dd762d9da066b5359a51129f9ccceefc82912f", "url": "https://github.com/JMRI/JMRI/commit/a9dd762d9da066b5359a51129f9ccceefc82912f", "message": "shorten delay", "committedDate": "2020-12-03T14:34:43Z", "type": "commit"}, {"oid": "104e4803af00e15b0396a1f9dddbfd2994a01337", "url": "https://github.com/JMRI/JMRI/commit/104e4803af00e15b0396a1f9dddbfd2994a01337", "message": "Merge branch 'master' into temp20201202", "committedDate": "2020-12-03T14:39:45Z", "type": "commit"}, {"oid": "ecf544d71318a1a3207d4a13c63a590f43796e95", "url": "https://github.com/JMRI/JMRI/commit/ecf544d71318a1a3207d4a13c63a590f43796e95", "message": "ifixes", "committedDate": "2020-12-03T19:53:15Z", "type": "commit"}, {"oid": "9d4b9ab7c33f14df9384efcb5f0a6a0bb5e37178", "url": "https://github.com/JMRI/JMRI/commit/9d4b9ab7c33f14df9384efcb5f0a6a0bb5e37178", "message": "Merge branch 'master' into 20201124-ReadSlotAfterMove", "committedDate": "2020-12-03T19:53:59Z", "type": "commit"}, {"oid": "a25a678d688c61573600722386bb5673df7a63fc", "url": "https://github.com/JMRI/JMRI/commit/a25a678d688c61573600722386bb5673df7a63fc", "message": "Refocus to the effects of changing to common, the slot move\nwas a bit of a red herring", "committedDate": "2020-12-03T20:02:57Z", "type": "commit"}, {"oid": "4bb107defd53b39aec108cac1a6aacf58ab997f1", "url": "https://github.com/JMRI/JMRI/commit/4bb107defd53b39aec108cac1a6aacf58ab997f1", "message": "Alter tests for new slot refresh", "committedDate": "2020-12-04T01:00:12Z", "type": "commit"}, {"oid": "6e50edb2147465962f6dbf8a12f1d91a50b45061", "url": "https://github.com/JMRI/JMRI/commit/6e50edb2147465962f6dbf8a12f1d91a50b45061", "message": "iAdd refresh button to Loconet Slot Monitor.:wq!", "committedDate": "2020-12-04T01:41:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3OTg3OA==", "url": "https://github.com/JMRI/JMRI/pull/9174#discussion_r536179878", "bodyText": "I expected Spotbugs to fail on this. meterTask is first assigned to null and then assigned to a TimerTask. Spotbugs normally doesn't accept this since the null value is not used.", "author": "danielb987", "createdAt": "2020-12-04T15:27:26Z", "path": "java/src/jmri/jmrix/loconet/SlotManager.java", "diffHunk": "@@ -781,6 +782,55 @@ protected void respondToAddrRequest(LocoNetMessage m, int i) {\n         }\n     }\n \n+    /**\n+     * If it is a slot being sent COMMON,\n+     *  after a delay, get the new status of the slot\n+     * If it is a true slot move, not dispatch or null\n+     *  after a delay, get the new status of the from slot, which varies by CS.\n+     *  the to slot should come in the reply.\n+     * @param m a LocoNet message\n+     * @param i the slot to which it is directed\n+     */\n+    protected void getMoreDetailsForSlot(LocoNetMessage m, int i) {\n+        // is called any time a LocoNet message is received.\n+        // sets up delayed slot read to update our effected slots to match the CS\n+        if (m.getOpCode() == LnConstants.OPC_SLOT_STAT1 &&\n+                ((m.getElement(2) & LnConstants.LOCOSTAT_MASK) == LnConstants.LOCO_COMMON ) ) {\n+            // Changing a slot to common. Depending on a CS and its OpSw, and throttle speed \n+            // it could have its status changed a number of ways.\n+            sendReadSlotDelayed(i,100);\n+        } else if (m.getOpCode() == LnConstants.OPC_MOVE_SLOTS) {\n+            // if a true move get the new from slot status\n+            // the to slot status is sent in the reply\n+            int slotTwo;\n+            slotTwo = m.getElement(2);\n+            if (i != 0 && slotTwo != 0) {\n+                sendReadSlotDelayed(i,100);\n+            }\n+       }\n+    }\n+\n+    /**\n+     * Scedule a delayed slot read.\n+     * @param slotNo - the slot.\n+     * @param delay - delay in msecs.\n+     */\n+    protected void sendReadSlotDelayed(int slotNo, long delay) {\n+        java.util.TimerTask meterTask = null;\n+        meterTask = new java.util.TimerTask() {", "originalCommit": "6e50edb2147465962f6dbf8a12f1d91a50b45061", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjk3NTM4MQ==", "url": "https://github.com/JMRI/JMRI/pull/9174#discussion_r536975381", "bodyText": "@Pugwash1\nI think it would be good to fix this before merge of this PR. I think Spotbugs should have failed on this and even if it didn't now, it may fail later on this.\njava.util.TimerTask meterTask = new java.util.TimerTask() {", "author": "danielb987", "createdAt": "2020-12-06T07:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjE3OTg3OA=="}], "type": "inlineReview"}, {"oid": "2293b829be7f62acd30f67ced8d357c5c3af4f83", "url": "https://github.com/JMRI/JMRI/commit/2293b829be7f62acd30f67ced8d357c5c3af4f83", "message": "This should keep Dan and Oracle  happy. It looks cleaner.\nBut, from docs.oracle.com \"It's not always necessary to assign a value when a field is declared.\n   Fields that are declared but not initialized will be set to a reasonable default by the compiler.\n   Generally speaking, this default will be zero or null, depending on the data type.\n   Relying on such default values, however, is generally considered bad programming style.\"", "committedDate": "2020-12-06T18:24:14Z", "type": "commit"}]}