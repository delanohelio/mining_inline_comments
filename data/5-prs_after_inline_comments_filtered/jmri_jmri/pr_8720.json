{"pr_number": 8720, "pr_title": "Ensure STLR NamedBeans dispose of listeners", "pr_createdAt": "2020-06-21T13:08:54Z", "pr_url": "https://github.com/JMRI/JMRI/pull/8720", "timeline": [{"oid": "e269197d779bb51ea81b7910f4a3f73fa5652e72", "url": "https://github.com/JMRI/JMRI/commit/e269197d779bb51ea81b7910f4a3f73fa5652e72", "message": "Ensure Reporters dispose of listeners", "committedDate": "2020-06-21T12:59:34Z", "type": "commit"}, {"oid": "705135ad468354d8e3f64abc9d2dfb37099478ea", "url": "https://github.com/JMRI/JMRI/commit/705135ad468354d8e3f64abc9d2dfb37099478ea", "message": "Update RpsReporter.java", "committedDate": "2020-06-21T13:05:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIyNTQ4NQ==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443225485", "bodyText": "The expected behavior of NamedBean.dispose() is that the NamedBean is no longer valid after the dispose call.\nWhat this means is that when the call to get the number of property change listeners is made after the call to dispose a numeric result is not the only valid outcome.\nAn exception may occur and, as a developer, I would anticipate this occurring based on the Javadoc.", "author": "pabender", "createdAt": "2020-06-21T14:33:06Z", "path": "java/test/jmri/implementation/AbstractReporterTestBase.java", "diffHunk": "@@ -78,6 +78,14 @@ public void testPropertyChange() {\n         // Check that LastReport was not seen (no change on null)\n         Assert.assertFalse(\"LastReport seen after null\", lastReportSeen);\n     }\n+    \n+    @Test\n+    public void testDispose() {\n+        r.addPropertyChangeListener(new TestReporterListener());\n+        Assert.assertEquals(\"controller listener added\", 1, r.getNumPropertyChangeListeners());\n+        r.dispose();\n+        Assert.assertEquals(\"controller listeners remaining\", 0, r.getNumPropertyChangeListeners());", "originalCommit": "705135ad468354d8e3f64abc9d2dfb37099478ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIzMDczNA==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443230734", "bodyText": "Have modified the test to comply with the NamedBean.getNumPropertyChangeListeners Javadoc, \"Number of current listeners. May return -1 if the information is not available for some reason.\"", "author": "icklesteve", "createdAt": "2020-06-21T15:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzIyNTQ4NQ=="}], "type": "inlineReview"}, {"oid": "43185bb5d146e43270821e78d2b62ea4f73ccc95", "url": "https://github.com/JMRI/JMRI/commit/43185bb5d146e43270821e78d2b62ea4f73ccc95", "message": "Update AbstractReporterTestBase.java\n\nAdd test for 0 listeners on creation.\nEnsure listeners less than 1, ie 0 or -1", "committedDate": "2020-06-21T15:19:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0NzEyOA==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443247128", "bodyText": "This is still making a call to the object after the dispose call.", "author": "pabender", "createdAt": "2020-06-21T18:58:42Z", "path": "java/test/jmri/implementation/AbstractReporterTestBase.java", "diffHunk": "@@ -78,6 +78,15 @@ public void testPropertyChange() {\n         // Check that LastReport was not seen (no change on null)\n         Assert.assertFalse(\"LastReport seen after null\", lastReportSeen);\n     }\n+    \n+    @Test\n+    public void testDispose() {\n+        Assert.assertEquals(\"starts 0 listeners\", 0, r.getNumPropertyChangeListeners());\n+        r.addPropertyChangeListener(new TestReporterListener());\n+        Assert.assertEquals(\"controller listener added\", 1, r.getNumPropertyChangeListeners());\n+        r.dispose();\n+        Assert.assertTrue(\"controller listeners remaining < 1\", r.getNumPropertyChangeListeners() < 1);", "originalCommit": "43185bb5d146e43270821e78d2b62ea4f73ccc95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0OTE1OA==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443249158", "bodyText": "My suggestion for fixing this is that it is a valid result for a runtime exception to be thrown here.  So put a try catch block around the assert.  If a runtime exception  is thrown, that passes the test.", "author": "pabender", "createdAt": "2020-06-21T19:24:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0NzEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI4NTIxNA==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443285214", "bodyText": "Thanks for fix suggestion, try catch block added.", "author": "icklesteve", "createdAt": "2020-06-22T02:02:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzI0NzEyOA=="}], "type": "inlineReview"}, {"oid": "5f2e3ecdce5fa8c638a5c4e4699dd7a061dcc8e1", "url": "https://github.com/JMRI/JMRI/commit/5f2e3ecdce5fa8c638a5c4e4699dd7a061dcc8e1", "message": "reporter tests add exception condition", "committedDate": "2020-06-22T01:56:41Z", "type": "commit"}, {"oid": "723b0b02c7d9b14f5be2741ec05505a9e7c31314", "url": "https://github.com/JMRI/JMRI/commit/723b0b02c7d9b14f5be2741ec05505a9e7c31314", "message": "add sensor turnout light tests", "committedDate": "2020-06-22T01:57:24Z", "type": "commit"}, {"oid": "5578afe7c29d6123e582e3a7e71baf7e5e7ac1ba", "url": "https://github.com/JMRI/JMRI/commit/5578afe7c29d6123e582e3a7e71baf7e5e7ac1ba", "message": "add missing super disposes", "committedDate": "2020-06-22T01:58:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNjAyMw==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443326023", "bodyText": "This needs to specifically be a RuntimeException and not just an Exception.", "author": "pabender", "createdAt": "2020-06-22T05:37:17Z", "path": "java/test/jmri/implementation/AbstractLightTestBase.java", "diffHunk": "@@ -75,6 +75,20 @@ public void testDispose() {\n         t.dispose();\n         Assert.assertEquals(\"controller listeners remaining\", 0, numListeners());\n     }\n+    \n+    @Test\n+    public void testRemoveListenerOnDispose() {\n+        Assert.assertEquals(\"starts 0 listeners\", 0, t.getNumPropertyChangeListeners());\n+        t.addPropertyChangeListener(new Listen());\n+        Assert.assertEquals(\"controller listener added\", 1, t.getNumPropertyChangeListeners());\n+        t.dispose();\n+        try {\n+            Assert.assertTrue(\"controller listeners remaining < 1\", t.getNumPropertyChangeListeners() < 1);\n+        }\n+        catch ( Exception e){", "originalCommit": "5578afe7c29d6123e582e3a7e71baf7e5e7ac1ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNjE2Mg==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443326162", "bodyText": "This needs to specifically be a RuntimeException and not just an Exception.", "author": "pabender", "createdAt": "2020-06-22T05:37:48Z", "path": "java/test/jmri/implementation/AbstractReporterTestBase.java", "diffHunk": "@@ -80,12 +80,17 @@ public void testPropertyChange() {\n     }\n     \n     @Test\n-    public void testDispose() {\n+    public void testAddRemoveListener() {\n         Assert.assertEquals(\"starts 0 listeners\", 0, r.getNumPropertyChangeListeners());\n         r.addPropertyChangeListener(new TestReporterListener());\n         Assert.assertEquals(\"controller listener added\", 1, r.getNumPropertyChangeListeners());\n         r.dispose();\n-        Assert.assertTrue(\"controller listeners remaining < 1\", r.getNumPropertyChangeListeners() < 1);\n+        try {\n+            Assert.assertTrue(\"controller listeners remaining < 1\", r.getNumPropertyChangeListeners() < 1);\n+        }\n+        catch ( Exception e){", "originalCommit": "5578afe7c29d6123e582e3a7e71baf7e5e7ac1ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNjIzOQ==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443326239", "bodyText": "This needs to specifically be a RuntimeException and not just an Exception.", "author": "pabender", "createdAt": "2020-06-22T05:38:06Z", "path": "java/test/jmri/implementation/AbstractSensorTestBase.java", "diffHunk": "@@ -83,6 +83,20 @@ public void testDispose() throws JmriException {\n         t.dispose();\n         Assert.assertEquals(\"controller listeners remaining\", 0, numListeners());\n     }\n+    \n+    @Test\n+    public void testRemoveListenerOnDispose() {\n+        Assert.assertEquals(\"starts 0 listeners\", 0, t.getNumPropertyChangeListeners());\n+        t.addPropertyChangeListener(new Listen());\n+        Assert.assertEquals(\"controller listener added\", 1, t.getNumPropertyChangeListeners());\n+        t.dispose();\n+        try {\n+            Assert.assertTrue(\"controller listeners remaining < 1\", t.getNumPropertyChangeListeners() < 1);\n+        }\n+        catch ( Exception e){", "originalCommit": "5578afe7c29d6123e582e3a7e71baf7e5e7ac1ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzMyNjI4OQ==", "url": "https://github.com/JMRI/JMRI/pull/8720#discussion_r443326289", "bodyText": "This needs to specifically be a RuntimeException and not just an Exception.", "author": "pabender", "createdAt": "2020-06-22T05:38:21Z", "path": "java/test/jmri/implementation/AbstractTurnoutTestBase.java", "diffHunk": "@@ -100,6 +100,20 @@ public void testDispose() {\n         t.dispose();\n         Assert.assertEquals(\"controller listeners remaining\", 0, numListeners());\n     }\n+    \n+    @Test\n+    public void testRemoveListenerOnDispose() {\n+        int startListeners =  t.getNumPropertyChangeListeners();\n+        t.addPropertyChangeListener(new Listen());\n+        Assert.assertEquals(\"controller listener added\", startListeners+1, t.getNumPropertyChangeListeners());\n+        t.dispose();\n+        try {\n+            Assert.assertTrue(\"controller listeners remaining < 1\", t.getNumPropertyChangeListeners() < 1);\n+        }\n+        catch ( Exception e){", "originalCommit": "5578afe7c29d6123e582e3a7e71baf7e5e7ac1ba", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "26ebc8f5fffeb857e4abb6f6dd3fbed416686c0a", "url": "https://github.com/JMRI/JMRI/commit/26ebc8f5fffeb857e4abb6f6dd3fbed416686c0a", "message": "move Exception to RuntimeException", "committedDate": "2020-06-22T11:03:07Z", "type": "commit"}]}