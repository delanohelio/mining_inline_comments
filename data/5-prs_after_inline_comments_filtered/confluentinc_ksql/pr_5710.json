{"pr_number": 5710, "pr_title": "refactor: move queryID generator out of physical plan", "pr_createdAt": "2020-06-26T19:09:31Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5710", "timeline": [{"oid": "4e13d0571947c468a1530dcc07854bb791ece848", "url": "https://github.com/confluentinc/ksql/commit/4e13d0571947c468a1530dcc07854bb791ece848", "message": "refactor: move queryID generator out of physical plan", "committedDate": "2020-06-26T19:07:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNTU2OA==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447225568", "bodyText": "nit: unused import?", "author": "vcrfxia", "createdAt": "2020-06-29T20:12:44Z", "path": "ksqldb-engine/src/test/java/io/confluent/ksql/testutils/AnalysisTestUtil.java", "diffHunk": "@@ -28,6 +28,7 @@\n import io.confluent.ksql.parser.tree.Statement;\n import io.confluent.ksql.planner.LogicalPlanner;\n import io.confluent.ksql.planner.plan.OutputNode;\n+import io.confluent.ksql.query.id.SequentialQueryIdGenerator;", "originalCommit": "4e13d0571947c468a1530dcc07854bb791ece848", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNzk4MA==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447227980", "bodyText": "What happened to this toUpperCase() call? I don't see it in the migrated code.", "author": "vcrfxia", "createdAt": "2020-06-29T20:17:11Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/KsqlStructuredDataOutputNode.java", "diffHunk": "@@ -83,15 +80,8 @@ public SourceName getIntoSourceName() {\n   }\n \n   @Override\n-  public QueryId getQueryId(final QueryIdGenerator queryIdGenerator) {\n-    final String base = queryIdGenerator.getNext().toUpperCase();", "originalCommit": "4e13d0571947c468a1530dcc07854bb791ece848", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzODE0OA==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447238148", "bodyText": "they all actually return numbers, so it's kind-of irrelevant. I'll add it back for consistency, but we should probably change the API to just return a number.", "author": "agavra", "createdAt": "2020-06-29T20:36:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNzk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwNzA2MQ==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447307061", "bodyText": "Looks like it was added back in one place but not another (https://github.com/confluentinc/ksql/blob/master/ksqldb-engine/src/main/java/io/confluent/ksql/engine/QueryIdUtil.java#L58) :) If they're always numbers I'm fine with leaving it off, though.", "author": "vcrfxia", "createdAt": "2020-06-29T23:01:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNzk4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzMwOTU5Mg==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447309592", "bodyText": "\ud83e\udd26 shouldn't make a difference, but i'll change it in the next PR to be safe", "author": "agavra", "createdAt": "2020-06-29T23:08:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIyNzk4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMDYwNQ==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447230605", "bodyText": "Why is there no check here on whether the sink specifies CREATE OR REPLACE or not?", "author": "vcrfxia", "createdAt": "2020-06-29T20:22:11Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/engine/QueryIdUtil.java", "diffHunk": "@@ -0,0 +1,78 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.engine;\n+\n+import com.google.common.collect.Iterables;\n+import io.confluent.ksql.metastore.MetaStore;\n+import io.confluent.ksql.metastore.model.DataSource.DataSourceType;\n+import io.confluent.ksql.name.SourceName;\n+import io.confluent.ksql.planner.plan.KsqlStructuredDataOutputNode;\n+import io.confluent.ksql.planner.plan.OutputNode;\n+import io.confluent.ksql.query.QueryId;\n+import io.confluent.ksql.query.id.QueryIdGenerator;\n+import io.confluent.ksql.util.KsqlException;\n+import java.util.Set;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+/**\n+ * Utility for constructing {@link QueryId}s - separate from {@code EngineExecutor} for\n+ * easy access to unit testing.\n+ */\n+final class QueryIdUtil {\n+\n+  private QueryIdUtil() {\n+  }\n+\n+  /**\n+   * Builds a {@link QueryId} for a physical plan specification.\n+   *\n+   * @param metaStore   the meta store representing the current state of the engine\n+   * @param idGenerator generates query ids\n+   * @param outputNode  the logical plan\n+   * @return the {@link QueryId} to be used\n+   */\n+  static QueryId buildId(\n+      final MetaStore metaStore,\n+      final QueryIdGenerator idGenerator,\n+      final OutputNode outputNode\n+  ) {\n+    if (!outputNode.getSinkName().isPresent()) {\n+      return new QueryId(String.valueOf(Math.abs(ThreadLocalRandom.current().nextLong())));\n+    }\n+\n+    final KsqlStructuredDataOutputNode structured = (KsqlStructuredDataOutputNode) outputNode;\n+    if (!structured.createInto()) {\n+      return new QueryId(\"INSERTQUERY_\" + idGenerator.getNext());\n+    }\n+\n+    final SourceName sink = outputNode.getSinkName().get();\n+    final Set<String> queriesForSink = metaStore.getQueriesWithSink(sink);\n+    if (queriesForSink.size() > 1) {\n+      throw new KsqlException(\"REPLACE for sink \" + sink + \" is not supported because there are \"", "originalCommit": "4e13d0571947c468a1530dcc07854bb791ece848", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0MDMyNA==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447240324", "bodyText": "it'll actually fail before this point if it isn't a create or replace, but i'll make it explicit", "author": "agavra", "createdAt": "2020-06-29T20:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMDYwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0MjA0MQ==", "url": "https://github.com/confluentinc/ksql/pull/5710#discussion_r447242041", "bodyText": "On second thought, I'm going to leave it like that - whether or not the statement is CREATE OR REPLACE is not the responsibility of the queryID generation. If it's attempting to create an already existing statement without OR REPLACE it should fail in the metastore (putSource specifically)", "author": "agavra", "createdAt": "2020-06-29T20:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzMDYwNQ=="}], "type": "inlineReview"}, {"oid": "8f12043f3ce32a08aae89ba4104cec24fadd2b30", "url": "https://github.com/confluentinc/ksql/commit/8f12043f3ce32a08aae89ba4104cec24fadd2b30", "message": "chore: address comments", "committedDate": "2020-06-29T20:43:52Z", "type": "commit"}]}