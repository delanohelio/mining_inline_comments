{"pr_number": 4591, "pr_title": "test: Add ImmutabilityTest", "pr_createdAt": "2020-02-19T12:45:52Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4591", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1MDk3Mg==", "url": "https://github.com/confluentinc/ksql/pull/4591#discussion_r381450972", "bodyText": "It would be preferable to have all the protocol model classes immutable.\nAll you need to do is change the JsonObject to ImmutableMap.  This is actually preferable, as exposing properties is currently exposing mutable internal state, which ain't pretty.\n public final ImmutableMap<String, Object> properties;\n\n...   \n\nthis.properties = properties == null \n    ? ImmutableMap.of()\n     : ImmutableMap.copyOf(properties);", "author": "big-andy-coates", "createdAt": "2020-02-19T18:08:26Z", "path": "ksql-api/src/main/java/io/confluent/ksql/api/server/protocol/InsertsStreamArgs.java", "diffHunk": "@@ -16,15 +16,13 @@\n package io.confluent.ksql.api.server.protocol;\n \n import com.fasterxml.jackson.annotation.JsonProperty;\n-import com.google.errorprone.annotations.Immutable;\n import io.vertx.core.json.JsonObject;\n import java.util.Map;\n import java.util.Objects;\n \n /**\n  * Represents the arguments to an insert stream request\n  */\n-@Immutable", "originalCommit": "99bdd2052fb150342536cdbb966867298b016d26", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTU5NTA1Mw==", "url": "https://github.com/confluentinc/ksql/pull/4591#discussion_r381595053", "bodyText": "Exposing an ImmutableMap doesn't work as it complains that the value (Object) in the Immutable map is not itself Immutable.\nThis all starts to get complicated. I also notice that the current KsqlRequest class which does something similar (has properties) is not marked as Immutable:\nhttps://github.com/confluentinc/ksql/blob/master/ksql-rest-model/src/main/java/io/confluent/ksql/rest/entity/KsqlRequest.java", "author": "purplefox", "createdAt": "2020-02-19T22:55:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1MDk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYwMTc1NA==", "url": "https://github.com/confluentinc/ksql/pull/4591#discussion_r381601754", "bodyText": "Using ImmutableMap to take a copy of a map passed into an object is not going to give you the encapsulation you require unless the keys and values in the map are themselves immutable.\nI notice quite a few places in the code we're talking \"immutable\" copies of Map<String, ?> or Map<String, Object> so this pattern currently seems broken anyway.", "author": "purplefox", "createdAt": "2020-02-19T23:13:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1MDk3Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4MjUxMQ==", "url": "https://github.com/confluentinc/ksql/pull/4591#discussion_r381982511", "bodyText": "Yep, fair enough.", "author": "big-andy-coates", "createdAt": "2020-02-20T12:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1MDk3Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1MTkxMg==", "url": "https://github.com/confluentinc/ksql/pull/4591#discussion_r381451912", "bodyText": "As above.", "author": "big-andy-coates", "createdAt": "2020-02-19T18:10:12Z", "path": "ksql-api/src/main/java/io/confluent/ksql/api/server/protocol/QueryResponseMetadata.java", "diffHunk": "@@ -15,14 +15,12 @@\n \n package io.confluent.ksql.api.server.protocol;\n \n-import com.google.errorprone.annotations.Immutable;\n import java.util.List;\n import java.util.Objects;\n \n /**\n  * Represents the metadata of a query stream response\n  */\n-@Immutable", "originalCommit": "99bdd2052fb150342536cdbb966867298b016d26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTQ1MjA4NQ==", "url": "https://github.com/confluentinc/ksql/pull/4591#discussion_r381452085", "bodyText": "As above.", "author": "big-andy-coates", "createdAt": "2020-02-19T18:10:31Z", "path": "ksql-api/src/main/java/io/confluent/ksql/api/server/protocol/QueryStreamArgs.java", "diffHunk": "@@ -16,15 +16,13 @@\n package io.confluent.ksql.api.server.protocol;\n \n import com.fasterxml.jackson.annotation.JsonProperty;\n-import com.google.errorprone.annotations.Immutable;\n import io.vertx.core.json.JsonObject;\n import java.util.Map;\n import java.util.Objects;\n \n /**\n  * Represents the arguments to a query stream request\n  */\n-@Immutable", "originalCommit": "99bdd2052fb150342536cdbb966867298b016d26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "79e0c81d7403be2d3f39bbe2eacaa0ce144188a8", "url": "https://github.com/confluentinc/ksql/commit/79e0c81d7403be2d3f39bbe2eacaa0ce144188a8", "message": "Make QueryResponseMetadata immutable", "committedDate": "2020-02-28T10:15:31Z", "type": "commit"}, {"oid": "79e0c81d7403be2d3f39bbe2eacaa0ce144188a8", "url": "https://github.com/confluentinc/ksql/commit/79e0c81d7403be2d3f39bbe2eacaa0ce144188a8", "message": "Make QueryResponseMetadata immutable", "committedDate": "2020-02-28T10:15:31Z", "type": "forcePushed"}]}