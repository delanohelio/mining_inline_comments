{"pr_number": 4717, "pr_title": "fix: create schemas at topic creation", "pr_createdAt": "2020-03-05T22:53:45Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4717", "timeline": [{"oid": "fe23730e722a6d3f1d9cfac1480f76d12d882123", "url": "https://github.com/confluentinc/ksql/commit/fe23730e722a6d3f1d9cfac1480f76d12d882123", "message": "fix: create schemas at topic creation", "committedDate": "2020-03-06T01:12:28Z", "type": "forcePushed"}, {"oid": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "url": "https://github.com/confluentinc/ksql/commit/0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "message": "fix: create schemas at topic creation", "committedDate": "2020-03-06T17:52:50Z", "type": "commit"}, {"oid": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "url": "https://github.com/confluentinc/ksql/commit/0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "message": "fix: create schemas at topic creation", "committedDate": "2020-03-06T17:52:50Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMjQ0MA==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389722440", "bodyText": "I don't think we should make this public.  It's an internal impl detail of the engine and should IMHO remain that way.\nIf you just parse, prepare + execute the query against a sandbox of the engine, (as the rest api normally does), then you'll get back a query, and you can get the schema from that query.\nYes, this is executing some bits we don't need. But it maintains better decoupling in the code IMHO.\nIf we really want to expose logical plans, then we should expose them through the engine.", "author": "big-andy-coates", "createdAt": "2020-03-09T14:24:29Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/engine/QueryEngine.java", "diffHunk": "@@ -42,7 +42,7 @@\n import org.slf4j.LoggerFactory;\n \n // CHECKSTYLE_RULES.OFF: ClassDataAbstractionCoupling\n-class QueryEngine {\n+public class QueryEngine {", "originalCommit": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxMzE2OA==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389813168", "bodyText": "I'm happy with your suggestion and will do that.", "author": "agavra", "createdAt": "2020-03-09T16:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMjQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMzA4MQ==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389723081", "bodyText": "I'd personally handle this as a separate injector.  Keep this injector focused on topic creation.\nI can see that topic creation is related to schema creation - but the injectors are chained anyway.", "author": "big-andy-coates", "createdAt": "2020-03-09T14:25:27Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/topic/TopicCreateInjector.java", "diffHunk": "@@ -53,18 +63,25 @@\n \n   private final KafkaTopicClient topicClient;\n   private final MetaStore metaStore;\n+  private final SchemaRegistryClient srClient;", "originalCommit": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgxNDI3NQ==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389814275", "bodyText": "At first I had tried doing that and now I can't remember why I didn't end up going that route. I'll go ahead and do that.", "author": "agavra", "createdAt": "2020-03-09T16:39:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyMzA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcyNzAzMg==", "url": "https://github.com/confluentinc/ksql/pull/4717#discussion_r389727032", "bodyText": "I think this is missing some tests around what happens if schema registration fails...", "author": "big-andy-coates", "createdAt": "2020-03-09T14:31:03Z", "path": "ksql-engine/src/test/java/io/confluent/ksql/topic/TopicCreateInjectorTest.java", "diffHunk": "@@ -425,6 +440,74 @@ public void shouldCreateMissingTopicWithDefaultCleanupPolicyForWindowedTables()\n         ImmutableMap.of());\n   }\n \n+  @Test\n+  public void shouldNotRegisterSchemaIfSchemaRegistryIsDisabled() {\n+    // Given:\n+    config = new KsqlConfig(ImmutableMap.of());\n+    givenStatement(\"CREATE STREAM x (f1 VARCHAR) WITH(kafka_topic='expectedName', value_format='AVRO', partitions=1);\");\n+    when(builder.build()).thenReturn(new TopicProperties(\"expectedName\", 10, (short) 10));\n+\n+    // When:\n+    injector.inject(statement, builder);\n+\n+    // Then:\n+    verifyNoMoreInteractions(schemaRegistryClient);\n+  }", "originalCommit": "0f0b1f5f9f7aaa6627bfa2a3cdb8866669bad932", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "313c30fd1b58c4d8471d153ecc9645961d5059a6", "url": "https://github.com/confluentinc/ksql/commit/313c30fd1b58c4d8471d153ecc9645961d5059a6", "message": "refactor: apply andys requested changes", "committedDate": "2020-03-09T18:56:12Z", "type": "commit"}, {"oid": "4970d0634b22dcc16f42514c1e79882b6bb5f174", "url": "https://github.com/confluentinc/ksql/commit/4970d0634b22dcc16f42514c1e79882b6bb5f174", "message": "chore: uncomment sr url", "committedDate": "2020-03-10T22:25:51Z", "type": "commit"}]}