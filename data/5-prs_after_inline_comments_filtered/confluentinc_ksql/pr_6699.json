{"pr_number": 6699, "pr_title": "fix: Fixes bug in latests-by-offset when using nulls and sessions windows", "pr_createdAt": "2020-12-01T23:30:58Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6699", "timeline": [{"oid": "8befb9aa8019c4ff97e8e0a3084a64e778f4d15a", "url": "https://github.com/confluentinc/ksql/commit/8befb9aa8019c4ff97e8e0a3084a64e778f4d15a", "message": "fix: ignore nulls when merging session windows, if specified", "committedDate": "2020-12-01T23:28:14Z", "type": "commit"}, {"oid": "d917459b00d8daf3650b07e443db44de71dd826d", "url": "https://github.com/confluentinc/ksql/commit/d917459b00d8daf3650b07e443db44de71dd826d", "message": "fix: ignore nulls when merging session windows, if specified", "committedDate": "2020-12-01T23:28:19Z", "type": "commit"}, {"oid": "5c88e17d8db8434b468d50745002b771a7ab4662", "url": "https://github.com/confluentinc/ksql/commit/5c88e17d8db8434b468d50745002b771a7ab4662", "message": "fix compilation error", "committedDate": "2020-12-02T00:31:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyMzcxOQ==", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r533823719", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // Deal with overflow - we assume if one is positive and the other negative then the\n          \n          \n            \n                    // sequence has overflowed - in which case the latest is the one with the smallest sequence\n          \n          \n            \n                    final long sequence1 = struct1.getInt64(SEQ_FIELD);\n          \n          \n            \n                    final long sequence2 = struct2.getInt64(SEQ_FIELD);\n          \n          \n            \n                    if (sequence1 < 0 && sequence2 >= 0) {\n          \n          \n            \n                      return 1;\n          \n          \n            \n                    } else if (sequence2 < 0 && sequence1 >= 0) {\n          \n          \n            \n                      return -1;\n          \n          \n            \n                    } else {\n          \n          \n            \n                      return Long.compare(sequence1, sequence2);\n          \n          \n            \n                    }\n          \n          \n            \n                    return INTERMEDIATE_STRUCT_COMPARATOR.compare(struct1, struct2);", "author": "agavra", "createdAt": "2020-12-02T00:58:27Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/KudafByOffsetUtils.java", "diffHunk": "@@ -64,6 +64,29 @@\n     }\n   };\n \n+  static final Comparator<Struct> INTERMEDIATE_STRUCT_COMPARATOR_IGNORE_NULLS =\n+      (struct1, struct2) -> {\n+        // Ignore nulls: If one of the structs has a null value, then return the other irrespective\n+        // of sequence.\n+        if (struct1.get(VAL_FIELD) == null) {\n+          return -1;\n+        } else if (struct2.get(VAL_FIELD) == null) {\n+          return 1;\n+        }\n+\n+        // Deal with overflow - we assume if one is positive and the other negative then the\n+        // sequence has overflowed - in which case the latest is the one with the smallest sequence\n+        final long sequence1 = struct1.getInt64(SEQ_FIELD);\n+        final long sequence2 = struct2.getInt64(SEQ_FIELD);\n+        if (sequence1 < 0 && sequence2 >= 0) {\n+          return 1;\n+        } else if (sequence2 < 0 && sequence1 >= 0) {\n+          return -1;\n+        } else {\n+          return Long.compare(sequence1, sequence2);\n+        }", "originalCommit": "5c88e17d8db8434b468d50745002b771a7ab4662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNDA5Mg==", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r533824092", "bodyText": "nit: makes sense to make this decision once instead of every time we call merge", "author": "agavra", "createdAt": "2020-12-02T00:59:18Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/LatestByOffset.java", "diffHunk": "@@ -220,7 +222,13 @@ public Struct aggregate(final T current, final Struct aggregate) {\n       public Struct merge(final Struct aggOne, final Struct aggTwo) {\n         // When merging we need some way of evaluating the \"latest' one.\n         // We do this by keeping track of the sequence of when it was originally processed\n-        if (INTERMEDIATE_STRUCT_COMPARATOR.compare(aggOne, aggTwo) >= 0) {\n+        final Comparator<Struct> comparator;\n+        if (ignoreNulls) {", "originalCommit": "5c88e17d8db8434b468d50745002b771a7ab4662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzgyNDU2OA==", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r533824568", "bodyText": "nit: what if they're both null? then we should probably return 0 (I don't think it'll make a difference, but better to be correct)", "author": "agavra", "createdAt": "2020-12-02T01:00:29Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/KudafByOffsetUtils.java", "diffHunk": "@@ -64,6 +64,29 @@\n     }\n   };\n \n+  static final Comparator<Struct> INTERMEDIATE_STRUCT_COMPARATOR_IGNORE_NULLS =\n+      (struct1, struct2) -> {\n+        // Ignore nulls: If one of the structs has a null value, then return the other irrespective\n+        // of sequence.", "originalCommit": "5c88e17d8db8434b468d50745002b771a7ab4662", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1e400153df72a77c3977177e87567bc52fbeb087", "url": "https://github.com/confluentinc/ksql/commit/1e400153df72a77c3977177e87567bc52fbeb087", "message": "address comments", "committedDate": "2020-12-04T01:04:24Z", "type": "commit"}, {"oid": "ff6521eb2d34c18c67c6c530b190ddd99db69822", "url": "https://github.com/confluentinc/ksql/commit/ff6521eb2d34c18c67c6c530b190ddd99db69822", "message": "address comments", "committedDate": "2020-12-04T01:38:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIzMTM2Nw==", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r536231367", "bodyText": "this condition will never be hit - it needs to be the first in the if/else branches", "author": "agavra", "createdAt": "2020-12-04T16:42:13Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/KudafByOffsetUtils.java", "diffHunk": "@@ -64,6 +64,21 @@\n     }\n   };\n \n+  static final Comparator<Struct> INTERMEDIATE_STRUCT_COMPARATOR_IGNORE_NULLS =\n+      (struct1, struct2) -> {\n+        // Ignore nulls: If one of the structs has a null value, then return the other irrespective\n+        // of sequence.\n+        if (struct1.get(VAL_FIELD) == null) {\n+          return -1;\n+        } else if (struct2.get(VAL_FIELD) == null) {\n+          return 1;\n+        } else if (struct1.get(VAL_FIELD) == null && struct2.get(VAL_FIELD) == null) {\n+          return 0;\n+        }", "originalCommit": "ff6521eb2d34c18c67c6c530b190ddd99db69822", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3ODM0OA==", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r536478348", "bodyText": "These are what happens when you work on the 3 PRs in parallel and the release", "author": "vpapavas", "createdAt": "2020-12-05T01:50:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIzMTM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjIzMjY0MQ==", "url": "https://github.com/confluentinc/ksql/pull/6699#discussion_r536232641", "bodyText": "we should not be relying on static state - if people create two different latest by offests (one to ignore nulls and one not to) whichever is created second will override the comparator for the first. Instead, it should be created when latestN method is called as a local variable and referenced in the anonymous class\nIn general, if you see code with static, non-final state it's probably a bug and best to avoid.", "author": "agavra", "createdAt": "2020-12-04T16:44:09Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/function/udaf/offset/LatestByOffset.java", "diffHunk": "@@ -50,6 +52,7 @@ private LatestByOffset() {\n   }\n \n   static AtomicLong sequence = new AtomicLong();\n+  private static Comparator<Struct> comparator;", "originalCommit": "ff6521eb2d34c18c67c6c530b190ddd99db69822", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "897a4c99df2bbbb773233a15bf9483c4635252aa", "url": "https://github.com/confluentinc/ksql/commit/897a4c99df2bbbb773233a15bf9483c4635252aa", "message": "Trigger Build", "committedDate": "2020-12-04T19:24:44Z", "type": "commit"}, {"oid": "6f5329ff8c5f7ea167f5e8d9ebc3ee7a90732a27", "url": "https://github.com/confluentinc/ksql/commit/6f5329ff8c5f7ea167f5e8d9ebc3ee7a90732a27", "message": "address comments", "committedDate": "2020-12-04T20:10:49Z", "type": "commit"}, {"oid": "15389d3b1bc4506f860d9403abdec90f9b72c520", "url": "https://github.com/confluentinc/ksql/commit/15389d3b1bc4506f860d9403abdec90f9b72c520", "message": "add plans", "committedDate": "2020-12-04T22:21:04Z", "type": "commit"}]}