{"pr_number": 5697, "pr_title": "test: fix flaky ClientIntegrationTest#shouldListQueries() (MINOR)", "pr_createdAt": "2020-06-26T02:29:14Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5697", "timeline": [{"oid": "40a15d901900b7da0c01e1675347cfedf7d69d9f", "url": "https://github.com/confluentinc/ksql/commit/40a15d901900b7da0c01e1675347cfedf7d69d9f", "message": "test: add print statements to debug list queries test", "committedDate": "2020-06-26T02:28:30Z", "type": "commit"}, {"oid": "6e8f02e1adaa8ff0f23e9d1754a630ca33351f03", "url": "https://github.com/confluentinc/ksql/commit/6e8f02e1adaa8ff0f23e9d1754a630ca33351f03", "message": "test: update logging", "committedDate": "2020-06-26T04:56:39Z", "type": "commit"}, {"oid": "051f1cfc2d76b4130af236a5f95ec37517623ff8", "url": "https://github.com/confluentinc/ksql/commit/051f1cfc2d76b4130af236a5f95ec37517623ff8", "message": "Merge branch 'master' into list-queries-debug", "committedDate": "2020-06-26T17:23:15Z", "type": "commit"}, {"oid": "b14dbcb9971d1c2fb188b0e3c9796d94da6802fb", "url": "https://github.com/confluentinc/ksql/commit/b14dbcb9971d1c2fb188b0e3c9796d94da6802fb", "message": "test: undisable test", "committedDate": "2020-06-26T17:23:34Z", "type": "commit"}, {"oid": "93bd30697b4a88517a2a96848ad18c65d5c9ce06", "url": "https://github.com/confluentinc/ksql/commit/93bd30697b4a88517a2a96848ad18c65d5c9ce06", "message": "test: fix flaky test", "committedDate": "2020-06-26T19:53:22Z", "type": "commit"}, {"oid": "1ebeff085ea1ac7b68c3c52c3eae7ac035be0e39", "url": "https://github.com/confluentinc/ksql/commit/1ebeff085ea1ac7b68c3c52c3eae7ac035be0e39", "message": "test: improve debugability", "committedDate": "2020-06-26T19:55:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNTQ0Ng==", "url": "https://github.com/confluentinc/ksql/pull/5697#discussion_r447135446", "bodyText": "I wonder if this can affect stability of any of the other tests - is there a way to assert this in the @Before or @After methods?", "author": "agavra", "createdAt": "2020-06-29T17:29:09Z", "path": "ksqldb-api-client/src/test/java/io/confluent/ksql/api/client/integration/ClientIntegrationTest.java", "diffHunk": "@@ -708,31 +707,38 @@ public void shouldListTopics() throws Exception {\n     final List<TopicInfo> topics = client.listTopics().get();\n \n     // Then\n-    assertThat(topics, containsInAnyOrder(\n+    assertThat(\"\" + topics, topics, containsInAnyOrder(\n         topicInfo(TEST_TOPIC),\n         topicInfo(EMPTY_TEST_TOPIC),\n         topicInfo(EMPTY_TEST_TOPIC_2),\n         topicInfo(AGG_TABLE)\n     ));\n   }\n \n-  @Ignore // temporarily disable while flakiness is being investigated\n   @Test\n-  public void shouldListQueries() throws Exception {\n+  public void shouldListQueries() {\n     // When\n-    final List<QueryInfo> queries = client.listQueries().get();\n+    // Try multiple times to allow time for queries started by the other tests to finish terminating", "originalCommit": "1ebeff085ea1ac7b68c3c52c3eae7ac035be0e39", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzIzNTE0OA==", "url": "https://github.com/confluentinc/ksql/pull/5697#discussion_r447235148", "bodyText": "I considered that but doing so would mean one failing test could cause all other tests to fail. For example, if a test starts a persistent query and fails before it's able to terminate it, then all subsequent tests will fail in the @Before or @After which doesn't seem great.\nI also considered adding this assertion to the end of each test that starts a transient query, so that those tests wait for the transient query to be fully terminated before the test completes. However this isn't great either because the list queries test still needs this retry loop, in case someone adds a new test that starts a transient query and forgets to add the assertion block to the end.\nIn light of that, I thought it made the most sense to have tests that require a certain number of queries assert that at the start of the test. WDYT?", "author": "vcrfxia", "createdAt": "2020-06-29T20:30:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNTQ0Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0MzEzMg==", "url": "https://github.com/confluentinc/ksql/pull/5697#discussion_r447243132", "bodyText": "that's fair enough \ud83d\udc4d", "author": "agavra", "createdAt": "2020-06-29T20:45:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzEzNTQ0Ng=="}], "type": "inlineReview"}]}