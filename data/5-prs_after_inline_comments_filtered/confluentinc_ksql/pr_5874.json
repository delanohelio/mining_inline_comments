{"pr_number": 5874, "pr_title": "fix: change default grace period to zero", "pr_createdAt": "2020-07-23T22:40:15Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5874", "timeline": [{"oid": "da93e0d18613cccb20ce31597653a9a7f93eee37", "url": "https://github.com/confluentinc/ksql/commit/da93e0d18613cccb20ce31597653a9a7f93eee37", "message": "chore: switching to suppress branch", "committedDate": "2020-07-23T19:46:02Z", "type": "commit"}, {"oid": "fe6b04e410b34f2f291ab50d3fc6a30c48487016", "url": "https://github.com/confluentinc/ksql/commit/fe6b04e410b34f2f291ab50d3fc6a30c48487016", "message": "fix: change default grace period to zero", "committedDate": "2020-07-23T21:47:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NzQxMg==", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r459777412", "bodyText": "nit: I think this code would be easier to read if we had:\nif (!original.getRefinementInfo().isPresent || !original.getWindowExpression().isPresent()) {\n  return original.getWindowExpression();\n}\n\nRefinementInfo refinement = optional.get();\nWindowExpression window = optional.get();\n...", "author": "agavra", "createdAt": "2020-07-23T23:11:25Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/RewrittenAnalysis.java", "diffHunk": "@@ -113,7 +123,49 @@ public ImmutableAnalysis original() {\n \n   @Override\n   public Optional<WindowExpression> getWindowExpression() {\n-    return original.getWindowExpression();\n+    if (original.getRefinementInfo().isPresent()", "originalCommit": "fe6b04e410b34f2f291ab50d3fc6a30c48487016", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI5NTY5Mw==", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r460295693", "bodyText": "We should still check if there is a grace period though right, because if there is we also just return the original window expression", "author": "nae701", "createdAt": "2020-07-24T21:27:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NzQxMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDMwMTkxOA==", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r460301918", "bodyText": "yes we do need to check that", "author": "agavra", "createdAt": "2020-07-24T21:46:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NzQxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NzY4Nw==", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r459777687", "bodyText": "nit: can be static final", "author": "agavra", "createdAt": "2020-07-23T23:12:18Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/RewrittenAnalysis.java", "diffHunk": "@@ -113,7 +123,49 @@ public ImmutableAnalysis original() {\n \n   @Override\n   public Optional<WindowExpression> getWindowExpression() {\n-    return original.getWindowExpression();\n+    if (original.getRefinementInfo().isPresent()\n+        && original.getRefinementInfo().get().getOutputRefinement() == OutputRefinement.FINAL\n+        && !original.getWindowExpression().get()\n+        .getKsqlWindowExpression().getGracePeriod().isPresent()) {\n+      final KsqlWindowExpression ksqlWindowNew;\n+      final KsqlWindowExpression ksqlWindowOld =\n+          original.getWindowExpression().get().getKsqlWindowExpression();\n+      final WindowTimeClause zeroGracePeriod = new WindowTimeClause(0L, TimeUnit.MILLISECONDS);", "originalCommit": "fe6b04e410b34f2f291ab50d3fc6a30c48487016", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4MjE5OQ==", "url": "https://github.com/confluentinc/ksql/pull/5874#discussion_r459782199", "bodyText": "nit: we're not checking isPresent here, which I think is causing https://jenkins.confluent.io/job/confluentinc-pr/job/ksql/job/PR-5874/1/testReport/junit/io.confluent.ksql.planner/LogicalPlannerTest/shouldThrowOnNonWindowedAggregationSuppressions/ to fail", "author": "agavra", "createdAt": "2020-07-23T23:27:06Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/analyzer/RewrittenAnalysis.java", "diffHunk": "@@ -113,7 +123,49 @@ public ImmutableAnalysis original() {\n \n   @Override\n   public Optional<WindowExpression> getWindowExpression() {\n-    return original.getWindowExpression();\n+    if (original.getRefinementInfo().isPresent()\n+        && original.getRefinementInfo().get().getOutputRefinement() == OutputRefinement.FINAL\n+        && !original.getWindowExpression().get()", "originalCommit": "fe6b04e410b34f2f291ab50d3fc6a30c48487016", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "74531cbdc3a9fc9380655e3be482644ee813d3d7", "url": "https://github.com/confluentinc/ksql/commit/74531cbdc3a9fc9380655e3be482644ee813d3d7", "message": "test: add unit tests for rewritten window default grace 0", "committedDate": "2020-07-24T20:58:30Z", "type": "commit"}, {"oid": "a5673085b90fefd8a235f6db2440b273251c3878", "url": "https://github.com/confluentinc/ksql/commit/a5673085b90fefd8a235f6db2440b273251c3878", "message": "chore: remove unused import", "committedDate": "2020-07-24T20:59:33Z", "type": "commit"}, {"oid": "41eec3c013f0987056d885ab60e0426a5e62270a", "url": "https://github.com/confluentinc/ksql/commit/41eec3c013f0987056d885ab60e0426a5e62270a", "message": "chore: add license", "committedDate": "2020-07-24T21:08:33Z", "type": "commit"}, {"oid": "cc616f35593bbe729d4e347a0babefd08987830a", "url": "https://github.com/confluentinc/ksql/commit/cc616f35593bbe729d4e347a0babefd08987830a", "message": "fix: check if grace is present before rewrite", "committedDate": "2020-07-24T21:38:53Z", "type": "commit"}, {"oid": "e0a520ffaa544f9ed3beecb2c778e75a7b54c581", "url": "https://github.com/confluentinc/ksql/commit/e0a520ffaa544f9ed3beecb2c778e75a7b54c581", "message": "fix: default grace 0 only for suppressions", "committedDate": "2020-07-24T22:43:41Z", "type": "commit"}, {"oid": "926c120e57db123c42c3eec15a9a21ea91c27d98", "url": "https://github.com/confluentinc/ksql/commit/926c120e57db123c42c3eec15a9a21ea91c27d98", "message": "chore: clarify if conditon and invert logic for better readability", "committedDate": "2020-07-25T21:26:49Z", "type": "commit"}]}