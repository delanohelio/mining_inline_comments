{"pr_number": 6665, "pr_title": "fix: don't create threads per request", "pr_createdAt": "2020-11-24T03:21:12Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6665", "timeline": [{"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "url": "https://github.com/confluentinc/ksql/commit/8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "message": "fix: creating threads per request", "committedDate": "2020-11-24T18:21:19Z", "type": "commit"}, {"oid": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "url": "https://github.com/confluentinc/ksql/commit/8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "message": "fix: creating threads per request", "committedDate": "2020-11-24T18:21:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNzc2OA==", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r529807768", "bodyText": "If someone has interrupted this thread, you can just skip awaiting termination of the executorService and log the exception.  I don't think there's any point in resetting the interrupt flag.  That's kind of the reverse of the pattern:\nhttps://docs.oracle.com/javase/tutorial/essential/concurrency/interrupt.html", "author": "AlanConfluent", "createdAt": "2020-11-24T18:56:46Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/KsqlRestApplication.java", "diffHunk": "@@ -486,6 +492,14 @@ public void shutdown() {\n       log.error(\"Exception while waiting for pull query metrics to close\", e);\n     }\n \n+    try {\n+      pullExecutorService.shutdown();\n+      pullExecutorService.awaitTermination(\n+          Duration.ofSeconds(10).toMillis(), TimeUnit.MILLISECONDS);\n+    } catch (final InterruptedException e) {\n+      Thread.currentThread().interrupt();", "originalCommit": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMjg4Ng==", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r529812886", "bodyText": "This is actually discussed in good detail here: https://stackoverflow.com/questions/3976344/handling-interruptedexception-in-java\nI think if there's a notion that the caller of this method may want to check the status of the flag, then there's a pattern for catch InterruptedException and reset the flag via Thread.currentThread().interrupt(); as you're doing.  If there were other things further along that might block and throw InterruptedException, it might make sense to do what you're doing to effectively pass on the flag so the next thing doesn't block either.  I'll leave it to you to assess that.  You should probably still log the exception.", "author": "AlanConfluent", "createdAt": "2020-11-24T19:05:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNzc2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTc2MDA4Mw==", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r535760083", "bodyText": "It's closed in the Autoclosable of HARouting now, basically how Andy had fixed it", "author": "vpapavas", "createdAt": "2020-12-04T01:05:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgwNzc2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDI4NQ==", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r529810285", "bodyText": "Can we avoid passing down a general-purpose ExecutorService? It seems very easy to \"abuse\" if down the line someone needs a thread pool they'll think \"oh look, I can just use this one that's already here!\" and \"steal\" threads from the pull queries.\nI'm about to hop on a meeting but I'll take a deeper look in a bit. I think it might be worth refactoring HARouting so that we can pass one instance down (or create on when we create the engine).", "author": "agavra", "createdAt": "2020-11-24T19:00:52Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/KsqlExecutionContext.java", "diffHunk": "@@ -154,6 +155,7 @@ PullQueryResult executePullQuery(\n       ConfiguredStatement<Query> statement,\n       RoutingFilterFactory routingFilterFactory,\n       RoutingOptions routingOptions,\n+      ExecutorService executorService,", "originalCommit": "8d2ed9cb2da134a3f2c6f8393eeffc7969e0401a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk1OTgyOA==", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r529959828", "bodyText": "Yes, I agree and I thought about it as well. The current problem is that the HARouting takes as argument the pull physical plan so that it can execute it when the query is served locally. I haven't come up with an idea on how to refactor this.", "author": "vpapavas", "createdAt": "2020-11-24T22:45:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDI4NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTk3NzQxNw==", "url": "https://github.com/confluentinc/ksql/pull/6665#discussion_r529977417", "bodyText": "You can pass the PullPhysicalPlan as an argument of HARouting.handlePullQuery rather than injecting into the constructor.  I think you would have to do the same with ConfiguredStatement<Query> statement, LogicalSchema outputSchema,  and QueryId queryId.  That should allow HARouting to be a singleton.", "author": "AlanConfluent", "createdAt": "2020-11-24T23:02:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTgxMDI4NQ=="}], "type": "inlineReview"}, {"oid": "b490cf9488eadddd9ffee59a38487820d82187e6", "url": "https://github.com/confluentinc/ksql/commit/b490cf9488eadddd9ffee59a38487820d82187e6", "message": "make HARouting singleton", "committedDate": "2020-12-03T18:47:52Z", "type": "commit"}, {"oid": "35d4e9df556fba4d67e4e979e09645bd1d2089ff", "url": "https://github.com/confluentinc/ksql/commit/35d4e9df556fba4d67e4e979e09645bd1d2089ff", "message": "working on fixing tests", "committedDate": "2020-12-03T20:40:14Z", "type": "commit"}, {"oid": "52571b45305da6ea335fe0b4788a60af0a2c4db2", "url": "https://github.com/confluentinc/ksql/commit/52571b45305da6ea335fe0b4788a60af0a2c4db2", "message": "use enabled ksql client in test", "committedDate": "2020-12-03T23:08:03Z", "type": "commit"}, {"oid": "83f5df083174e6f083bbd86f8864d4b708ae1550", "url": "https://github.com/confluentinc/ksql/commit/83f5df083174e6f083bbd86f8864d4b708ae1550", "message": "Trigger Build", "committedDate": "2020-12-04T22:12:27Z", "type": "commit"}, {"oid": "c7fecbf3571e10902af5ac7e74d35194669e8c49", "url": "https://github.com/confluentinc/ksql/commit/c7fecbf3571e10902af5ac7e74d35194669e8c49", "message": "fix tests?", "committedDate": "2020-12-05T01:48:14Z", "type": "commit"}]}