{"pr_number": 5879, "pr_title": "fix: create the metastore backups directory if it does not exist", "pr_createdAt": "2020-07-24T20:33:02Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5879", "timeline": [{"oid": "c9d5ed792e162fdeacd047499dfe8d7b643abafa", "url": "https://github.com/confluentinc/ksql/commit/c9d5ed792e162fdeacd047499dfe8d7b643abafa", "message": "fix: create the metastore backups directory if it does not exist", "committedDate": "2020-07-24T20:38:05Z", "type": "commit"}, {"oid": "c9d5ed792e162fdeacd047499dfe8d7b643abafa", "url": "https://github.com/confluentinc/ksql/commit/c9d5ed792e162fdeacd047499dfe8d7b643abafa", "message": "fix: create the metastore backups directory if it does not exist", "committedDate": "2020-07-24T20:38:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjM2NQ==", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460276365", "bodyText": "nit: can we de-dup this code from enforceStreamStateDirAvailability() in KsqlServerMain? Not required if it's annoying to de-dup (especially since we're trying to keep this patch small in order to cherry-pick) but it's weird to me that we have the same code in two places.", "author": "vcrfxia", "createdAt": "2020-07-24T20:37:35Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +225,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {", "originalCommit": "e9d54734a6827bf92e54e82697463128dcd22d48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4MjgxNg==", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460282816", "bodyText": "Right, I see it. But I have the extra step to restrict the permissions to the KSQL server user only. I'd like to do that in the state directory too, but I don't know why the directory is not too restrictive. I'd rather investigate more and do it in another follow-up PR.", "author": "spena", "createdAt": "2020-07-24T20:52:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NjM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NzU1Ng==", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460277556", "bodyText": "Does it make sense to explicitly set permissions here? I see we don't do that for the Kafka Streams state directory. I'm in favor of consistency unless there's a good reason to deviate.", "author": "vcrfxia", "createdAt": "2020-07-24T20:40:22Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +222,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {\n+    if (!backupsDir.exists()) {\n+      if (!backupsDir.mkdirs()) {\n+        throw new KsqlServerException(\"Couldn't create the backups directory: \"\n+            + backupsDir.getPath()\n+            + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+            + \"\\n or its parent directory is readable/writable by KSQL server\"\n+            + \"\\n or change it to a readable/writable directory by setting '\"\n+            + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+            + \"' config in the properties file.\"\n+        );\n+      }\n+\n+      try {\n+        Files.setPosixFilePermissions(backupsDir.toPath(),", "originalCommit": "c9d5ed792e162fdeacd047499dfe8d7b643abafa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4MTkzNA==", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460281934", "bodyText": "I'd like to keep the metastore directory restricted from other uses to access the data. By default, the directory created has drwxrwxr-x which is opened to any user in the system. It's up to the user to specify a directory that has restricted permissions only to the required users, but if KSQL creates it automatically, then I set those here too.\nI don't know why the streams state directory is not protected. We might want to do that. I won't do it in this patch until I understand their reason.", "author": "spena", "createdAt": "2020-07-24T20:50:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3NzU1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3ODAwMA==", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460278000", "bodyText": "Why do we need execute permissions? I see we have a similar check for the Kafka Streams state directory so I assume there's good reason. Curious what it is.", "author": "vcrfxia", "createdAt": "2020-07-24T20:41:19Z", "path": "ksqldb-rest-app/src/main/java/io/confluent/ksql/rest/server/CommandTopicBackupImpl.java", "diffHunk": "@@ -222,4 +222,50 @@ private BackupReplayFile newReplayFile() {\n         ? Optional.of(new BackupReplayFile(latestBakFile))\n         : Optional.empty();\n   }\n+\n+  private void ensureDirectoryExists(final File backupsDir) {\n+    if (!backupsDir.exists()) {\n+      if (!backupsDir.mkdirs()) {\n+        throw new KsqlServerException(\"Couldn't create the backups directory: \"\n+            + backupsDir.getPath()\n+            + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+            + \"\\n or its parent directory is readable/writable by KSQL server\"\n+            + \"\\n or change it to a readable/writable directory by setting '\"\n+            + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+            + \"' config in the properties file.\"\n+        );\n+      }\n+\n+      try {\n+        Files.setPosixFilePermissions(backupsDir.toPath(),\n+            PosixFilePermissions.fromString(\"rwx------\"));\n+      } catch (final IOException e) {\n+        throw new KsqlServerException(String.format(\n+            \"Couldn't set POSIX permissions on the backups directory: %s. Error = %s\",\n+            backupsDir.getPath(), e.getMessage()));\n+      }\n+    }\n+\n+    if (!backupsDir.isDirectory()) {\n+      throw new KsqlServerException(backupsDir.getPath()\n+          + \" is not a directory.\"\n+          + \"\\n Make sure the directory exists and is readable/writable for KSQL server \"\n+          + \"\\n or its parent directory is readable/writable by KSQL server\"\n+          + \"\\n or change it to a readable/writable directory by setting '\"\n+          + KsqlConfig.KSQL_METASTORE_BACKUP_LOCATION\n+          + \"' config in the properties file.\"\n+      );\n+    }\n+\n+    if (!backupsDir.canWrite() || !backupsDir.canRead() || !backupsDir.canExecute()) {", "originalCommit": "c9d5ed792e162fdeacd047499dfe8d7b643abafa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI4MDYzOQ==", "url": "https://github.com/confluentinc/ksql/pull/5879#discussion_r460280639", "bodyText": "Directories need to have execute permissions in order to create files in it. By default, a new directory has rwx. If you remove the x, then you get a permissions denied.\n$ mkdir /tmp/dir\n$ chmod a-x /tmp/dir\n$ ls -dl /tmp/dir\ndrw-rw-r-- 2 sergio sergio 4096 Jul 24 15:46 /tmp/dir\n$ echo file > /tmp/dir/file\nbash: /tmp/dir/file: Permission denied\n$", "author": "spena", "createdAt": "2020-07-24T20:47:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDI3ODAwMA=="}], "type": "inlineReview"}]}