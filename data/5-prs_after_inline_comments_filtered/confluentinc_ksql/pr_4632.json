{"pr_number": 4632, "pr_title": "fix: change default exception handling for timestamp extractors", "pr_createdAt": "2020-02-26T00:53:20Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4632", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2NTMyMg==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385265322", "bodyText": "You might want to implement from KsqlTimestampExtractor to we can support this on CSAS/CTAS statements too.", "author": "spena", "createdAt": "2020-02-27T17:38:25Z", "path": "ksql-streams/src/main/java/io/confluent/ksql/execution/streams/timestamp/LoggingTimestampExtractor.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.execution.streams.timestamp;\n+\n+import static io.confluent.ksql.serde.util.SerdeProcessingLogMessageFactory.deserializationErrorMsg;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import io.confluent.ksql.logging.processing.ProcessingLogger;\n+import java.util.Objects;\n+import org.apache.kafka.clients.consumer.ConsumerRecord;\n+import org.apache.kafka.streams.processor.TimestampExtractor;\n+\n+/**\n+ * A wrapper around {@code TimestampExtractor} that can be configured to suppress any\n+ * errors and instead returns a negative timestamp (indicating to streams that the message\n+ * should be ignored). Additionally, this class ensures that any errors are logged to the\n+ * processing log (even the fatal ones) for visibility.\n+ */\n+public class LoggingTimestampExtractor implements TimestampExtractor {", "originalCommit": "bd10cfba4aab634f85965d8fa5493114f921ce30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNzUyMg==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385317522", "bodyText": "I think it's already supported because this just wraps other extractors (we always return this extractor). I'm not sure exactly what you mean here?", "author": "agavra", "createdAt": "2020-02-27T19:16:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2NTMyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTQwMzQwOQ==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385403409", "bodyText": "ah KsqlTimestampExtractor is something new. I'll do this", "author": "agavra", "createdAt": "2020-02-27T22:16:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2NTMyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2ODIzOQ==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385268239", "bodyText": "Will this allow KSQL to display the row with ROWTIME = -1 in case of a failure?\nI'm trying to understand how the FailOnInvalidTimestamp will work in this situation. If a -1 is found on the row, then the FailOnInvalidTimestamp will throw an exception which this code will catch and log it to the processing log. But it returns a -1 back to stream, so the stream will set it to as ROWTIME, won't it?", "author": "spena", "createdAt": "2020-02-27T17:43:55Z", "path": "ksql-streams/src/main/java/io/confluent/ksql/execution/streams/timestamp/LoggingTimestampExtractor.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.execution.streams.timestamp;\n+\n+import static io.confluent.ksql.serde.util.SerdeProcessingLogMessageFactory.deserializationErrorMsg;\n+\n+import com.google.common.annotations.VisibleForTesting;\n+import io.confluent.ksql.logging.processing.ProcessingLogger;\n+import java.util.Objects;\n+import org.apache.kafka.clients.consumer.ConsumerRecord;\n+import org.apache.kafka.streams.processor.TimestampExtractor;\n+\n+/**\n+ * A wrapper around {@code TimestampExtractor} that can be configured to suppress any\n+ * errors and instead returns a negative timestamp (indicating to streams that the message\n+ * should be ignored). Additionally, this class ensures that any errors are logged to the\n+ * processing log (even the fatal ones) for visibility.\n+ */\n+public class LoggingTimestampExtractor implements TimestampExtractor {\n+\n+  private final TimestampExtractor delegate;\n+  private final ProcessingLogger logger;\n+  private final boolean failOnError;\n+\n+  public LoggingTimestampExtractor(\n+      final TimestampExtractor delegate,\n+      final ProcessingLogger logger,\n+      final boolean failOnError\n+  ) {\n+    this.delegate = Objects.requireNonNull(delegate, \"delegate\");\n+    this.logger = Objects.requireNonNull(logger, \"logger\");\n+    this.failOnError = failOnError;\n+  }\n+\n+  @Override\n+  public long extract(final ConsumerRecord<Object, Object> record, final long partitionTime) {\n+    try {\n+      return delegate.extract(record, partitionTime);\n+    } catch (final Exception e) {\n+      logger.error(deserializationErrorMsg(e, record));\n+      if (failOnError) {\n+        throw e;\n+      }\n+      return -1L;", "originalCommit": "bd10cfba4aab634f85965d8fa5493114f921ce30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNjkzNQ==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385316935", "bodyText": "any negative timestamp causes the event to be ignored by Kafka Streams. That means that if this wraps FailOnInvalidTimestamp but you set ksql.timestamp.throw.on.invalid to false then it will suppress the throw and just ignore the message", "author": "agavra", "createdAt": "2020-02-27T19:15:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI2ODIzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3NTQ5OA==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385275498", "bodyText": "Use this for the logger name instead of the id directly:\nfinal QueryId queryId = queryBuilder.getQueryId();\nfinal QueryContext queryContex = source.getProperties().getQueryContext()\nfinal String loggerNamePrefix = QueryLoggerUtil.queryLoggerName(queryId, queryContext);\n\nThis way you will get a more specific logger prefix that tells you where in the query plan the message was generated.", "author": "rodesai", "createdAt": "2020-02-27T17:57:28Z", "path": "ksql-streams/src/main/java/io/confluent/ksql/execution/streams/SourceBuilder.java", "diffHunk": "@@ -314,7 +315,13 @@ private static TimestampExtractor timestampExtractor(\n         .map(Column::index)\n         .orElse(-1);\n \n-    return timestampPolicy.create(timestampIndex);\n+    return timestampPolicy.create(\n+        timestampIndex,\n+        ksqlConfig.getBoolean(KsqlConfig.KSQL_TIMESTAMP_THROW_ON_INVALID),\n+        queryBuilder.getProcessingLogContext()\n+            .getLoggerFactory()\n+            .getLogger(queryBuilder.getQueryId().getId())", "originalCommit": "bd10cfba4aab634f85965d8fa5493114f921ce30", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3Nzg4NA==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385277884", "bodyText": "I'd use a different message type for this error. Deserialization error messages generally mean the serde couldn't deserialize the record in the topic, and contain a base64 encoded representation of the data inside (in a field called recordB64). The data written out here represents something different - KSQL's view of the row once it's been deserialized.", "author": "rodesai", "createdAt": "2020-02-27T18:01:53Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/util/SerdeProcessingLogMessageFactory.java", "diffHunk": "@@ -34,6 +36,20 @@ private SerdeProcessingLogMessageFactory() {\n   public static Function<ProcessingLogConfig, SchemaAndValue> deserializationErrorMsg(\n       final Throwable exception,\n       final Optional<byte[]> record\n+  ) {\n+    return message(exception, () -> record.map(Base64.getEncoder()::encodeToString).orElse(null));\n+  }\n+\n+  public static Function<ProcessingLogConfig, SchemaAndValue> deserializationErrorMsg(", "originalCommit": "bd10cfba4aab634f85965d8fa5493114f921ce30", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI4NTExNA==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385285114", "bodyText": "You should be able to use the existing record processing error (EngineProcessingLogMessageFactory.recordProcessingError)", "author": "rodesai", "createdAt": "2020-02-27T18:16:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3Nzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMxNjEzMg==", "url": "https://github.com/confluentinc/ksql/pull/4632#discussion_r385316132", "bodyText": "i was debating which I should do since this felt like a type of deserialization error to me, but I'll update it to a new type (I can see both sides)", "author": "agavra", "createdAt": "2020-02-27T19:14:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTI3Nzg4NA=="}], "type": "inlineReview"}, {"oid": "ba8cea08d2b72b5a45e392a565cc43941748ee5b", "url": "https://github.com/confluentinc/ksql/commit/ba8cea08d2b72b5a45e392a565cc43941748ee5b", "message": "fix: change default exception handling for ksql timestamp extractors", "committedDate": "2020-02-28T23:22:44Z", "type": "forcePushed"}, {"oid": "5b36b47df39ede62e8f28448c0b5b77102df75c0", "url": "https://github.com/confluentinc/ksql/commit/5b36b47df39ede62e8f28448c0b5b77102df75c0", "message": "fix: change default exception handling for ksql timestamp extractors", "committedDate": "2020-03-02T18:06:37Z", "type": "forcePushed"}, {"oid": "571760b13cea3872e67b19e4210f87eb7bd772e4", "url": "https://github.com/confluentinc/ksql/commit/571760b13cea3872e67b19e4210f87eb7bd772e4", "message": "fix: change default exception handling for ksql timestamp extractors", "committedDate": "2020-03-02T21:00:48Z", "type": "forcePushed"}, {"oid": "a28de9705b3209a1c5b45fe6b6e10e9724033d16", "url": "https://github.com/confluentinc/ksql/commit/a28de9705b3209a1c5b45fe6b6e10e9724033d16", "message": "fix: change default exception handling for ksql timestamp extractors", "committedDate": "2020-03-02T21:11:19Z", "type": "forcePushed"}, {"oid": "2272e45949129ceea498c4ae945a04bca1c2d613", "url": "https://github.com/confluentinc/ksql/commit/2272e45949129ceea498c4ae945a04bca1c2d613", "message": "fix: change default exception handling for ksql timestamp extractors", "committedDate": "2020-03-02T22:53:39Z", "type": "commit"}, {"oid": "2272e45949129ceea498c4ae945a04bca1c2d613", "url": "https://github.com/confluentinc/ksql/commit/2272e45949129ceea498c4ae945a04bca1c2d613", "message": "fix: change default exception handling for ksql timestamp extractors", "committedDate": "2020-03-02T22:53:39Z", "type": "forcePushed"}]}