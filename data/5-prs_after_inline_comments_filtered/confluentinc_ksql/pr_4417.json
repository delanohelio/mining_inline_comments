{"pr_number": 4417, "pr_title": "fix: Fixes ImmutabilityTest to run on new types.  Also simplifies lag object structure", "pr_createdAt": "2020-01-31T20:20:21Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4417", "timeline": [{"oid": "2ad0e72258f49f4f0ca45759a6ee4b808c97fb6d", "url": "https://github.com/confluentinc/ksql/commit/2ad0e72258f49f4f0ca45759a6ee4b808c97fb6d", "message": "fix: Fixes ImmutabilityTest to run on new types.  Also simplifies lag object structure", "committedDate": "2020-01-31T20:17:27Z", "type": "commit"}, {"oid": "5deeeac28b22e046c72d3523e4f80340f7c8cba4", "url": "https://github.com/confluentinc/ksql/commit/5deeeac28b22e046c72d3523e4f80340f7c8cba4", "message": "Style", "committedDate": "2020-01-31T20:17:27Z", "type": "commit"}, {"oid": "6f2ef0fb2cb752d796e1cf5c7e36f0f5b4b98278", "url": "https://github.com/confluentinc/ksql/commit/6f2ef0fb2cb752d796e1cf5c7e36f0f5b4b98278", "message": "Fixes ClusterStatusResourceTest", "committedDate": "2020-01-31T20:36:23Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY5MDQ4OQ==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r373690489", "bodyText": "nit: remove a", "author": "vpapavas", "createdAt": "2020-01-31T21:20:06Z", "path": "ksql-rest-model/src/main/java/io/confluent/ksql/rest/entity/StateStoreLags.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.entity;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.errorprone.annotations.Immutable;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represents a the lags associated with a particular state store on a particular host.", "originalCommit": "6f2ef0fb2cb752d796e1cf5c7e36f0f5b4b98278", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY5ODM3Ng==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r373698376", "bodyText": "Removed!", "author": "AlanConfluent", "createdAt": "2020-01-31T21:41:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY5MDQ4OQ=="}], "type": "inlineReview"}, {"oid": "3d24a74b9c8f9758b82fed420c98a352b42d6b89", "url": "https://github.com/confluentinc/ksql/commit/3d24a74b9c8f9758b82fed420c98a352b42d6b89", "message": "Feedback", "committedDate": "2020-01-31T21:35:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzMjQzOQ==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r374032439", "bodyText": "why not more EMPTY_STATE_STORE_LAGS into getStateStoreLags?", "author": "big-andy-coates", "createdAt": "2020-02-03T10:43:38Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/LagReportingAgent.java", "diffHunk": "@@ -174,9 +172,9 @@ public void receiveHostLag(final LagReportingMessage lagReportingMessage) {\n       final HostInfo host, final QueryStateStoreId queryStateStoreId, final int partition) {\n     final Set<HostInfo> aliveHosts = aliveHostsRef.get();\n     final LagInfoEntity lagInfo = receivedLagInfo\n-        .getOrDefault(host, EMPTY_HOST_LAG_INFO).getLagInfo()\n-        .getOrDefault(queryStateStoreId, Collections.emptyMap())\n-        .getOrDefault(partition, null);\n+        .getOrDefault(host, EMPTY_HOST_STORE_LAGS)\n+        .getStateStoreLagsOrDefault(queryStateStoreId, EMPTY_STATE_STORE_LAGS)", "originalCommit": "3d24a74b9c8f9758b82fed420c98a352b42d6b89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxMDk4MQ==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r374310981", "bodyText": "I'll change it to return an optional, as suggested below.", "author": "AlanConfluent", "createdAt": "2020-02-03T20:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzMjQzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzNDExMw==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r374034113", "bodyText": "don't return null for unknown partition.\nEither:\n\nreturn some kind of empty lag info\nor else encode the fact that the method might not return a value by returning Optional<LagInfoEntity>,\nor throw an exception if this is not expected.", "author": "big-andy-coates", "createdAt": "2020-02-03T10:47:17Z", "path": "ksql-rest-model/src/main/java/io/confluent/ksql/rest/entity/StateStoreLags.java", "diffHunk": "@@ -0,0 +1,81 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.entity;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.errorprone.annotations.Immutable;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represents the lags associated with a particular state store on a particular host.\n+ */\n+@Immutable\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class StateStoreLags {\n+\n+  private final ImmutableMap<Integer, LagInfoEntity> lagByPartition;\n+\n+  @JsonCreator\n+  public StateStoreLags(\n+      @JsonProperty(\"lagByPartition\") final Map<Integer, LagInfoEntity> lagByPartition) {\n+    this.lagByPartition = ImmutableMap.copyOf(requireNonNull(lagByPartition, \"lagByPartition\"));\n+  }\n+\n+  public LagInfoEntity getLagByPartition(final int partition) {\n+    return lagByPartition.get(partition);", "originalCommit": "3d24a74b9c8f9758b82fed420c98a352b42d6b89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMxMTE4OA==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r374311188", "bodyText": "I changed it to return Optional", "author": "AlanConfluent", "createdAt": "2020-02-03T20:01:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzNDExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzNDgwOQ==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r374034809", "bodyText": "As with the other get method - avoid returning nulls.", "author": "big-andy-coates", "createdAt": "2020-02-03T10:48:50Z", "path": "ksql-rest-model/src/main/java/io/confluent/ksql/rest/entity/HostStoreLags.java", "diffHunk": "@@ -0,0 +1,91 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"; you may not use\n+ * this file except in compliance with the License. You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.rest.entity;\n+\n+import static com.google.common.base.MoreObjects.toStringHelper;\n+import static java.util.Objects.requireNonNull;\n+\n+import com.fasterxml.jackson.annotation.JsonCreator;\n+import com.fasterxml.jackson.annotation.JsonIgnoreProperties;\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.collect.ImmutableMap;\n+import com.google.errorprone.annotations.Immutable;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+/**\n+ * Represents a host's lag information, and when the lag information was collected.\n+ */\n+@Immutable\n+@JsonIgnoreProperties(ignoreUnknown = true)\n+public class HostStoreLags {\n+\n+  private final ImmutableMap<QueryStateStoreId, StateStoreLags> stateStoreLags;\n+  private final long updateTimeMs;\n+\n+  @JsonCreator\n+  public HostStoreLags(\n+      @JsonProperty(\"stateStoreLags\") final Map<QueryStateStoreId, StateStoreLags> stateStoreLags,\n+      @JsonProperty(\"updateTimeMs\") final long updateTimeMs) {\n+    this.stateStoreLags = ImmutableMap.copyOf(requireNonNull(stateStoreLags, \"stateStoreLags\"));\n+    this.updateTimeMs = updateTimeMs;\n+  }\n+\n+  public StateStoreLags getStateStoreLags(final QueryStateStoreId queryStateStoreId) {\n+    return stateStoreLags.get(queryStateStoreId);", "originalCommit": "3d24a74b9c8f9758b82fed420c98a352b42d6b89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDMyNjAwMA==", "url": "https://github.com/confluentinc/ksql/pull/4417#discussion_r374326000", "bodyText": "I changed it to return Optional", "author": "AlanConfluent", "createdAt": "2020-02-03T20:33:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzNDgwOQ=="}], "type": "inlineReview"}]}