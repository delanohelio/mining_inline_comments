{"pr_number": 5816, "pr_title": "feat(client): return query ID when persistent query started via Java client", "pr_createdAt": "2020-07-12T08:19:09Z", "pr_url": "https://github.com/confluentinc/ksql/pull/5816", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2MjU5Mg==", "url": "https://github.com/confluentinc/ksql/pull/5816#discussion_r453762592", "bodyText": "In that case can we fail the CompletableFuture?", "author": "purplefox", "createdAt": "2020-07-13T16:07:56Z", "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/ExecuteStatementResult.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.api.client;\n+\n+import java.util.Optional;\n+\n+/**\n+ * The result of executing a 'CREATE', 'CREATE ... AS * SELECT', 'DROP', 'TERMINATE', or 'INSERT\n+ * INTO ... AS SELECT' statement on the ksqlDB server.\n+ */\n+public interface ExecuteStatementResult {\n+\n+  /**\n+   * Returns the ID of a newly started persistent query, if applicable. The return value is empty\n+   * for all statements other than 'CREATE ... AS * SELECT' and 'INSERT * INTO ... AS SELECT'\n+   * statements, as only these statements start persistent queries. For statements that start\n+   * persistent queries, the return value may still be empty if either:\n+   *\n+   * <p><ul>\n+   *   <li> The statement was not executed on the server by the time the server response was sent.\n+   *   This typically does not happen under normal server operation, but may happen if the ksqlDB\n+   *   server's command runner thread is stuck, or if the configured value for\n+   *   {@code ksql.server.command.response.timeout.ms} is too low", "originalCommit": "c2a032ec529494ee99a8673d62e3cfddf1088a85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgwMjE4Ng==", "url": "https://github.com/confluentinc/ksql/pull/5816#discussion_r453802186", "bodyText": "Failing the CompletableFuture would be misleading because the statement is not failed. Rather, the server accepted the statement and is planning to execute it (pardon the personification), but just hadn't actually done it yet by the time the HTTP response was ended.", "author": "vcrfxia", "createdAt": "2020-07-13T17:12:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2MjU5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2MzgxNA==", "url": "https://github.com/confluentinc/ksql/pull/5816#discussion_r453763814", "bodyText": "I think you can replace this with Optional.ofNullable(commandStatus.getString(\"queryId\"));", "author": "purplefox", "createdAt": "2020-07-13T16:09:55Z", "path": "ksqldb-api-client/src/main/java/io/confluent/ksql/api/client/impl/DdlDmlResponseHandlers.java", "diffHunk": "@@ -33,14 +35,24 @@ private DdlDmlResponseHandlers() {\n \n   static void handleExecuteStatementResponse(\n       final JsonObject ksqlEntity,\n-      final CompletableFuture<Void> cf\n+      final CompletableFuture<ExecuteStatementResult> cf\n   ) {\n     if (!isCommandStatusEntity(ksqlEntity)) {\n       handleUnexpectedEntity(ksqlEntity, cf);\n       return;\n     }\n \n-    cf.complete(null);\n+    try {\n+      final JsonObject commandStatus = ksqlEntity.getJsonObject(\"commandStatus\");\n+      final Optional<String> queryId = commandStatus.getString(\"queryId\") != null", "originalCommit": "c2a032ec529494ee99a8673d62e3cfddf1088a85", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzgwMjI2NQ==", "url": "https://github.com/confluentinc/ksql/pull/5816#discussion_r453802265", "bodyText": "Ah, thanks for the tip!", "author": "vcrfxia", "createdAt": "2020-07-13T17:12:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc2MzgxNA=="}], "type": "inlineReview"}, {"oid": "f4a540a4abf41828842b5aa61eb999d12058907c", "url": "https://github.com/confluentinc/ksql/commit/f4a540a4abf41828842b5aa61eb999d12058907c", "message": "feat(client): return query ID when persistent query started via Java client", "committedDate": "2020-07-15T01:23:12Z", "type": "commit"}, {"oid": "271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "url": "https://github.com/confluentinc/ksql/commit/271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "message": "chore: feedback", "committedDate": "2020-07-15T01:26:07Z", "type": "commit"}, {"oid": "271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "url": "https://github.com/confluentinc/ksql/commit/271b1fcf4e8e241e6fdf751f5bb3b926296bcee1", "message": "chore: feedback", "committedDate": "2020-07-15T01:26:07Z", "type": "forcePushed"}, {"oid": "497cbca30722c0ea511416b9fe221fd71731a8f3", "url": "https://github.com/confluentinc/ksql/commit/497cbca30722c0ea511416b9fe221fd71731a8f3", "message": "Merge branch 'master' into java-client-dxl-query-id", "committedDate": "2020-07-15T04:46:31Z", "type": "commit"}]}