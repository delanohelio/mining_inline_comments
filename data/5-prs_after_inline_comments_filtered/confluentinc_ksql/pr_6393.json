{"pr_number": 6393, "pr_title": "Join format mismatch", "pr_createdAt": "2020-10-09T13:49:51Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6393", "timeline": [{"oid": "85cf3ea0197fcf9f70fff5637cc9dae9a4872216", "url": "https://github.com/confluentinc/ksql/commit/85cf3ea0197fcf9f70fff5637cc9dae9a4872216", "message": "chore: joins on sources with different key formats\n\nfixes: https://github.com/confluentinc/ksql/issues/6213\n\nJoins prefer the format of the left source and will repartition the right source if needed, unless:\n* the right source is a table\n* the right source is not already being repartitioned to facilitate the join and the left source is being repartitioned already.", "committedDate": "2020-10-09T13:10:44Z", "type": "commit"}, {"oid": "0d31bd8a0661485f35916627de22274514ff7b1d", "url": "https://github.com/confluentinc/ksql/commit/0d31bd8a0661485f35916627de22274514ff7b1d", "message": "test: historical plans", "committedDate": "2020-10-09T13:10:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzODU1NA==", "url": "https://github.com/confluentinc/ksql/pull/6393#discussion_r502538554", "bodyText": "\ud83d\ude22 why not have JoiningNode implement copyWithFormat() instead of setFormat?", "author": "agavra", "createdAt": "2020-10-09T16:18:20Z", "path": "ksqldb-engine/src/main/java/io/confluent/ksql/planner/plan/PlanNode.java", "diffHunk": "@@ -42,7 +41,6 @@\n import java.util.stream.Collectors;\n import java.util.stream.Stream;\n \n-@Immutable", "originalCommit": "85cf3ea0197fcf9f70fff5637cc9dae9a4872216", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzIyMzAzNA==", "url": "https://github.com/confluentinc/ksql/pull/6393#discussion_r503223034", "bodyText": "Because the note is already part of the logical plan. So it would need to swap itself out, which would mean the parent nodes reference would need to change to the node. Ergo, the parent node would need to be mutable.\nThe general direction is to move more and more logic from the Analyzer into the logical plan nodes, as this allows us to make use of the plan hierarchy and polymorphism to drive decision making. So more and more, the logical plan nodes, as they are today, will become more mutable.\nFor example, the final user-provided projection can be used to limit the number of columns we need to extract from each source.  The final projection node can inform parent nodes of the required columns. This would allow us to, for example, limit the columns we repartition to only those needed down stream, not the whole message: this could potentially be a massive saving.\nIf we want an immutable logical model, then we'll need a two-step process, i.e. a set of builder nodes, that can be baked into a immutable model.\nI'm a big fan of immutability, especially in the presence of multi-threading. However, in this case, I'm not sure it actually buys us much, at least not at the moment.", "author": "big-andy-coates", "createdAt": "2020-10-12T11:15:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjUzODU1NA=="}], "type": "inlineReview"}, {"oid": "3e1396b71adf972230d314c749d11a22676dde02", "url": "https://github.com/confluentinc/ksql/commit/3e1396b71adf972230d314c749d11a22676dde02", "message": "Merge branch 'master' into join_format_mismatch", "committedDate": "2020-10-12T11:24:23Z", "type": "commit"}, {"oid": "258d0afe7292df40cef6a624b0cb00825ea52d7b", "url": "https://github.com/confluentinc/ksql/commit/258d0afe7292df40cef6a624b0cb00825ea52d7b", "message": "Merge branch 'master' into join_format_mismatch", "committedDate": "2020-10-12T20:21:36Z", "type": "commit"}, {"oid": "17d21c4c9cb39b0fd9eede223d2baa188d2a98ca", "url": "https://github.com/confluentinc/ksql/commit/17d21c4c9cb39b0fd9eede223d2baa188d2a98ca", "message": "Merge branch 'master' into join_format_mismatch", "committedDate": "2020-10-13T09:56:40Z", "type": "commit"}]}