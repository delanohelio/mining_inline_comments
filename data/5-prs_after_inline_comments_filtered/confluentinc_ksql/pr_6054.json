{"pr_number": 6054, "pr_title": "Single value wrapping", "pr_createdAt": "2020-08-19T21:38:14Z", "pr_url": "https://github.com/confluentinc/ksql/pull/6054", "timeline": [{"oid": "f59dc5fde87400af1fca3c4ab4da834da1da45ba", "url": "https://github.com/confluentinc/ksql/commit/f59dc5fde87400af1fca3c4ab4da834da1da45ba", "message": "refactor: better fix for protobuf not supporting unwrapped values\n\nfixes: https://github.com/confluentinc/ksql/issues/5994\n\nBetter fix for the above issue. Previous fix didn't fit right.\n\nThis fix introduces a `SerdeFeature` enum and an associated `supportedFeatures()` method on `Format`. This allows formats to define the features it supports.  This will work well when we come to 'User defined formats'.\n\nIf the user supplies `WRAP_SINGLE_VALUES` in the `WITH` clause, this will map to either `SerdeOption.WRAP_SINGLE_VALUES` or `SerdeOption.UNWRAP_SINGLE_VALUES`.  These two options map to `SerdeFeature.WRAP_SINGLES` and `SerdeFeature.UNWRAP_SINGLES`, respectively.\n\nIf the user doesn't supply `WRAP_SINGLE_VALUES` then no option is set and the format is free to use its default format. Though this requires a follow up change to allow the default to be 'unwrapped'.\n\nThe default value for the config that provides the default for single value wrapping has been removed. This is to allow formats to define what they do by default, rather than having it enforced by the system. For example, JSON will wrap by default, where as KAFKA will be unwrapped by default.", "committedDate": "2020-08-19T21:33:46Z", "type": "commit"}, {"oid": "124a8784e78b520cd064f5a02c14a2a6f6d1ad04", "url": "https://github.com/confluentinc/ksql/commit/124a8784e78b520cd064f5a02c14a2a6f6d1ad04", "message": "test: test changes", "committedDate": "2020-08-19T21:34:22Z", "type": "commit"}, {"oid": "40141e27010ec4b934f94adc82ccd3cc4f6acce1", "url": "https://github.com/confluentinc/ksql/commit/40141e27010ec4b934f94adc82ccd3cc4f6acce1", "message": "docs: doc updates", "committedDate": "2020-08-19T21:51:09Z", "type": "commit"}, {"oid": "c3703faa4e3e86bfded2b8707be9c7457b2171a7", "url": "https://github.com/confluentinc/ksql/commit/c3703faa4e3e86bfded2b8707be9c7457b2171a7", "message": "test: historic plans", "committedDate": "2020-08-19T21:54:30Z", "type": "commit"}, {"oid": "c3703faa4e3e86bfded2b8707be9c7457b2171a7", "url": "https://github.com/confluentinc/ksql/commit/c3703faa4e3e86bfded2b8707be9c7457b2171a7", "message": "test: historic plans", "committedDate": "2020-08-19T21:54:30Z", "type": "forcePushed"}, {"oid": "9080ec8549ac352e1242f9a31164e1cad83ecc97", "url": "https://github.com/confluentinc/ksql/commit/9080ec8549ac352e1242f9a31164e1cad83ecc97", "message": "refactor: validated set of options", "committedDate": "2020-08-19T22:14:18Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyOTQ0MA==", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474029440", "bodyText": "How come ProtobufFormat has WRAP_SINGLES in its set of supported features, but the Kafka and delimited formats have the empty supported feature sets? Seems inconsistent in that I'd expect Kafka and delimited to have UNWRAP_SINGLES in their supported feature sets to parallel this.", "author": "vcrfxia", "createdAt": "2020-08-20T14:32:36Z", "path": "ksqldb-serde/src/main/java/io/confluent/ksql/serde/protobuf/ProtobufFormat.java", "diffHunk": "@@ -16,17 +16,24 @@\n package io.confluent.ksql.serde.protobuf;\n \n import com.google.common.collect.ImmutableMap;\n+import com.google.common.collect.ImmutableSet;\n import io.confluent.connect.protobuf.ProtobufData;\n import io.confluent.connect.protobuf.ProtobufDataConfig;\n import io.confluent.kafka.schemaregistry.ParsedSchema;\n import io.confluent.kafka.schemaregistry.protobuf.ProtobufSchema;\n import io.confluent.ksql.serde.FormatInfo;\n import io.confluent.ksql.serde.KsqlSerdeFactory;\n+import io.confluent.ksql.serde.SerdeFeature;\n import io.confluent.ksql.serde.connect.ConnectFormat;\n+import java.util.Set;\n import org.apache.kafka.connect.data.Schema;\n \n public class ProtobufFormat extends ConnectFormat {\n \n+  private static final Set<SerdeFeature> SUPPORTED_FEATURES = ImmutableSet.of(\n+      SerdeFeature.WRAP_SINGLES", "originalCommit": "9080ec8549ac352e1242f9a31164e1cad83ecc97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMyODI1NQ==", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474328255", "bodyText": "The next PR will add UNWRAP_SINGLES for KAFKA and DELIMITED, it's just not possible right now due to some other issues that are best kept to their own PR.", "author": "big-andy-coates", "createdAt": "2020-08-20T23:37:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAyOTQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMjMxNA==", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474032314", "bodyText": "The mapping between SerdeOption and SerdeFeature always be 1-to-1, right? What's the purpose of having SerdeOption wrap SerdeFeature?", "author": "vcrfxia", "createdAt": "2020-08-20T14:36:32Z", "path": "ksqldb-common/src/main/java/io/confluent/ksql/serde/SerdeOption.java", "diffHunk": "@@ -16,29 +16,42 @@\n package io.confluent.ksql.serde;\n \n import com.fasterxml.jackson.annotation.JsonCreator;\n-import com.google.common.collect.ImmutableSet;\n-import java.util.Set;\n+import java.util.Objects;\n \n public enum SerdeOption {", "originalCommit": "9080ec8549ac352e1242f9a31164e1cad83ecc97", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMzMDg1Mg==", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474330852", "bodyText": "My bad, I didn't really explain the intent here!\nThe PR was raised because the current system, where we only have UNWRAP_SINGLE_VALUES as a SerdeOption, isn't enough to express having some formats that don't support wrapping, e.g. KAFKA, some that only support wrapping, e.g. PROTOBUF, and some that support both.  Hence adding the WRAP_SINGLE_VALUES to the enum.\nThe use of SerdeFeature will become apparent in the next PR.  SerdeFeatures will be passed to the Serde along with the schema so that they can do what's needed.\n\nThe mapping between SerdeOption and SerdeFeature always be 1-to-1, right?\n\nNo, when we add WRAP_SINGLE_KEY and UNWRAP_SINGLE_KEY they'll also use SerdeFeature.WRAP_SINGLES and SerdeFeature.UNWRAP_SINGLES.  (This is needed for KLIP-33, which is why I'm working on it).\nOnce this is done, we'll have SerdeOptions, which sets at a topic schema level what options are on and which is serialized as part of the query plan, and SerdeFeatures which control the same at the key/value level and are passed to serde instances.\nIn the future it may be possible to do away with SerdeOption in favour of just using SerdeFeatures tracked at the key and value level, but that's a bigger change, and isn't trivial, as it's ingrained in the plan and in the code.\nHope that helps explain the why of this PR.", "author": "big-andy-coates", "createdAt": "2020-08-20T23:46:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMjMxNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDM0NTA5MQ==", "url": "https://github.com/confluentinc/ksql/pull/6054#discussion_r474345091", "bodyText": "Super helpful. Thanks, Andy!", "author": "vcrfxia", "createdAt": "2020-08-21T00:38:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDAzMjMxNA=="}], "type": "inlineReview"}, {"oid": "58e01be53f34c42efbf540fa69b6f8f8b1c25c0d", "url": "https://github.com/confluentinc/ksql/commit/58e01be53f34c42efbf540fa69b6f8f8b1c25c0d", "message": "Update docs/operate-and-deploy/installation/server-config/config-reference.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>", "committedDate": "2020-08-21T11:22:27Z", "type": "commit"}, {"oid": "f32f9ec6e90349435d0abb58f0f89250c2d1acec", "url": "https://github.com/confluentinc/ksql/commit/f32f9ec6e90349435d0abb58f0f89250c2d1acec", "message": "Update docs/operate-and-deploy/installation/server-config/config-reference.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>", "committedDate": "2020-08-21T11:22:34Z", "type": "commit"}, {"oid": "61bda7112b3c12362f01c2055b660848f900368f", "url": "https://github.com/confluentinc/ksql/commit/61bda7112b3c12362f01c2055b660848f900368f", "message": "Update docs/operate-and-deploy/installation/server-config/config-reference.md\n\nCo-authored-by: Jim Galasyn <jim.galasyn@confluent.io>", "committedDate": "2020-08-21T11:22:41Z", "type": "commit"}, {"oid": "fa6d3501d610086508bc24fa0af5ea31ddba8397", "url": "https://github.com/confluentinc/ksql/commit/fa6d3501d610086508bc24fa0af5ea31ddba8397", "message": "test: fix test", "committedDate": "2020-08-21T11:23:08Z", "type": "commit"}, {"oid": "0fdab8a0f2eed4a097cfa1d5e078cf233144e1e2", "url": "https://github.com/confluentinc/ksql/commit/0fdab8a0f2eed4a097cfa1d5e078cf233144e1e2", "message": "test: fix test", "committedDate": "2020-08-21T12:50:11Z", "type": "commit"}, {"oid": "05fb229679e630a568144da3d1eff58657f0fedc", "url": "https://github.com/confluentinc/ksql/commit/05fb229679e630a568144da3d1eff58657f0fedc", "message": "test: fix test", "committedDate": "2020-08-21T14:50:11Z", "type": "commit"}, {"oid": "c9449e101b2c32d92fc4405f370e21aed98f8cd5", "url": "https://github.com/confluentinc/ksql/commit/c9449e101b2c32d92fc4405f370e21aed98f8cd5", "message": "test: fix test", "committedDate": "2020-08-21T15:53:06Z", "type": "commit"}, {"oid": "41bd071e9fdbde7ac1c30742bc0363ada5ab958d", "url": "https://github.com/confluentinc/ksql/commit/41bd071e9fdbde7ac1c30742bc0363ada5ab958d", "message": "test: fix test", "committedDate": "2020-08-21T16:10:49Z", "type": "commit"}]}