{"pr_number": 4733, "pr_title": "feat: support for tunable retention, grace period for windowed tables", "pr_createdAt": "2020-03-07T08:58:08Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4733", "timeline": [{"oid": "ae1de49115a35845aa43baaa8f566ad8642ebc67", "url": "https://github.com/confluentinc/ksql/commit/ae1de49115a35845aa43baaa8f566ad8642ebc67", "message": "feat: support for tunable retention, grace period for windowed tables\n\n - Fixes #4157, adding SQL syntax for specifying retention, grace period\n - Added functional tests\n\nfeat: initial commit for tunable retention\n\nfeat: hacky test now works", "committedDate": "2020-03-09T18:44:58Z", "type": "forcePushed"}, {"oid": "bc6bc8dd0c41ad6ceb3322b58b083783f4300383", "url": "https://github.com/confluentinc/ksql/commit/bc6bc8dd0c41ad6ceb3322b58b083783f4300383", "message": "refactor: introduce abstraction for passing window's time clauses", "committedDate": "2020-03-10T18:51:12Z", "type": "forcePushed"}, {"oid": "810072c3c80f2dea118890d13fa3b361c6951686", "url": "https://github.com/confluentinc/ksql/commit/810072c3c80f2dea118890d13fa3b361c6951686", "message": "refactor: introduce abstraction for passing window's time clauses", "committedDate": "2020-03-10T20:10:24Z", "type": "forcePushed"}, {"oid": "091043edfc6bd93fc58d784f08fdd9be7d61c125", "url": "https://github.com/confluentinc/ksql/commit/091043edfc6bd93fc58d784f08fdd9be7d61c125", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-12T00:12:53Z", "type": "forcePushed"}, {"oid": "65cde4873a350a72a572afdfbaaff909c1b39eb1", "url": "https://github.com/confluentinc/ksql/commit/65cde4873a350a72a572afdfbaaff909c1b39eb1", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T15:33:11Z", "type": "forcePushed"}, {"oid": "5ed68718d934caf2dc3462343ec1bcb55847e416", "url": "https://github.com/confluentinc/ksql/commit/5ed68718d934caf2dc3462343ec1bcb55847e416", "message": "feat: support for tunable retention, grace period for windowed tables\n\n - Fixes #4157, adding SQL syntax for specifying retention, grace period\n - Added functional tests\n\nfeat: initial commit for tunable retention\n\nfeat: hacky test now works", "committedDate": "2020-03-13T17:16:10Z", "type": "commit"}, {"oid": "724b2bb8bac81f6d0db2f63bd41871bad1bcfb8c", "url": "https://github.com/confluentinc/ksql/commit/724b2bb8bac81f6d0db2f63bd41871bad1bcfb8c", "message": "refactor: add an overload in MaterializedFactory", "committedDate": "2020-03-13T17:16:10Z", "type": "commit"}, {"oid": "d70e8b86fbc9afe027c09d251a3d65b8f0a80e8a", "url": "https://github.com/confluentinc/ksql/commit/d70e8b86fbc9afe027c09d251a3d65b8f0a80e8a", "message": "refactor: introduce abstraction for passing window's time clauses", "committedDate": "2020-03-13T17:16:11Z", "type": "commit"}, {"oid": "f08fe813e5d44fe325e69814574bcb759e57a1b5", "url": "https://github.com/confluentinc/ksql/commit/f08fe813e5d44fe325e69814574bcb759e57a1b5", "message": "test: enhancing unit tests around retention/grace period parameters", "committedDate": "2020-03-13T17:16:11Z", "type": "commit"}, {"oid": "82dd65f83d13adee72c351e1dcddc2e312a7af00", "url": "https://github.com/confluentinc/ksql/commit/82dd65f83d13adee72c351e1dcddc2e312a7af00", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T17:16:11Z", "type": "forcePushed"}, {"oid": "73c459c6cd355f6330fd962aae3e70e2570ef63f", "url": "https://github.com/confluentinc/ksql/commit/73c459c6cd355f6330fd962aae3e70e2570ef63f", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T18:22:46Z", "type": "forcePushed"}, {"oid": "77276c8f9c823c67a86f2551b09914957c05333e", "url": "https://github.com/confluentinc/ksql/commit/77276c8f9c823c67a86f2551b09914957c05333e", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T18:52:50Z", "type": "forcePushed"}, {"oid": "07035ebdebfdda5d0506066e115f634f9013aecb", "url": "https://github.com/confluentinc/ksql/commit/07035ebdebfdda5d0506066e115f634f9013aecb", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T19:13:16Z", "type": "forcePushed"}, {"oid": "1f367ac0c8b6d2c83cb3b3dd8edc1c606519228f", "url": "https://github.com/confluentinc/ksql/commit/1f367ac0c8b6d2c83cb3b3dd8edc1c606519228f", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T20:29:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2MDI0Mw==", "url": "https://github.com/confluentinc/ksql/pull/4733#discussion_r392460243", "bodyText": "why not java.time.Duration? seems to do the same thing but with more utility methods. Happy either way", "author": "agavra", "createdAt": "2020-03-13T20:38:33Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/windows/WindowTimeClause.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Copyright 2020 Confluent Inc.\n+ *\n+ * Licensed under the Confluent Community License (the \"License\"); you may not use\n+ * this file except in compliance with the License.  You may obtain a copy of the\n+ * License at\n+ *\n+ * http://www.confluent.io/confluent-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n+ * WARRANTIES OF ANY KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations under the License.\n+ */\n+\n+package io.confluent.ksql.execution.windows;\n+\n+import static java.util.Objects.requireNonNull;\n+\n+import com.google.errorprone.annotations.Immutable;\n+import java.time.Duration;\n+import java.util.Objects;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Pojo for a time clause added to a window expression\n+ */\n+@Immutable\n+public class WindowTimeClause {", "originalCommit": "1f367ac0c8b6d2c83cb3b3dd8edc1c606519228f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ3NDU0MQ==", "url": "https://github.com/confluentinc/ksql/pull/4733#discussion_r392474541", "bodyText": "we need this class mostly because we print the expressions in the toString method.. If we eagerly convert to Duration, we lose information on the actual SQL clause i.e 60 SECONDS vs 1 MINUTE", "author": "vinothchandar", "createdAt": "2020-03-13T21:02:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2MDI0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2MjYxOQ==", "url": "https://github.com/confluentinc/ksql/pull/4733#discussion_r392462619", "bodyText": "not sure how much extra values these assertions give and they force us to use spys. is there any way we can check that the properties are being set on the table instead?", "author": "agavra", "createdAt": "2020-03-13T20:42:11Z", "path": "ksqldb-streams/src/test/java/io/confluent/ksql/execution/streams/StreamAggregateBuilderTest.java", "diffHunk": "@@ -420,14 +438,17 @@ public void shouldBuildTumblingWindowedAggregateCorrectly() {\n \n     // Then:\n     assertThat(result.getTable(), is(windowedWithWindowBounds));\n+    verify(gracePeriodClause).toDuration();\n+    verify(retentionClause).toDuration();", "originalCommit": "1f367ac0c8b6d2c83cb3b3dd8edc1c606519228f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ3NTc2Mg==", "url": "https://github.com/confluentinc/ksql/pull/4733#discussion_r392475762", "bodyText": "Like I mentioned.. KTable does not allow me to read these properties out.. So had the spys ensure if grace period and retention are set, then some code uses them as Duration..", "author": "vinothchandar", "createdAt": "2020-03-13T21:05:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2MjYxOQ=="}], "type": "inlineReview"}, {"oid": "febc520ea4e4e4b0905e0eb4db925cc803aed3dd", "url": "https://github.com/confluentinc/ksql/commit/febc520ea4e4e4b0905e0eb4db925cc803aed3dd", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T21:09:47Z", "type": "commit"}, {"oid": "febc520ea4e4e4b0905e0eb4db925cc803aed3dd", "url": "https://github.com/confluentinc/ksql/commit/febc520ea4e4e4b0905e0eb4db925cc803aed3dd", "message": "docs: document retention,grace period for window queries", "committedDate": "2020-03-13T21:09:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4ODQzMQ==", "url": "https://github.com/confluentinc/ksql/pull/4733#discussion_r392488431", "bodyText": "this is what ends up being included in the query plan, do we need to encode the retention and gracePeriod here?", "author": "agavra", "createdAt": "2020-03-13T21:25:41Z", "path": "ksqldb-execution/src/main/java/io/confluent/ksql/execution/windows/TumblingWindowExpression.java", "diffHunk": "@@ -21,44 +21,37 @@\n import io.confluent.ksql.model.WindowType;\n import io.confluent.ksql.parser.NodeLocation;\n import io.confluent.ksql.serde.WindowInfo;\n-import java.time.Duration;\n import java.util.Objects;\n import java.util.Optional;\n-import java.util.concurrent.TimeUnit;\n \n @Immutable\n public class TumblingWindowExpression extends KsqlWindowExpression {\n \n-  private final long size;\n-  private final TimeUnit sizeUnit;\n+  private final WindowTimeClause size;\n \n-  public TumblingWindowExpression(final long size, final TimeUnit sizeUnit) {\n-    this(Optional.empty(), size, sizeUnit);\n+  public TumblingWindowExpression(final WindowTimeClause size) {\n+    this(Optional.empty(), size, Optional.empty(), Optional.empty());\n   }\n \n   public TumblingWindowExpression(\n       final Optional<NodeLocation> location,\n-      final long size,\n-      final TimeUnit sizeUnit\n+      final WindowTimeClause size,\n+      final Optional<WindowTimeClause> retention,\n+      final Optional<WindowTimeClause> gracePeriod\n   ) {\n-    super(location);\n-    this.size = size;\n-    this.sizeUnit = requireNonNull(sizeUnit, \"sizeUnit\");\n+    super(location, retention, gracePeriod);\n+    this.size = requireNonNull(size, \"size\");\n   }\n \n   @Override\n   public WindowInfo getWindowInfo() {\n     return WindowInfo.of(\n         WindowType.TUMBLING,\n-        Optional.of(Duration.ofNanos(sizeUnit.toNanos(size)))", "originalCommit": "febc520ea4e4e4b0905e0eb4db925cc803aed3dd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUwMzkyOQ==", "url": "https://github.com/confluentinc/ksql/pull/4733#discussion_r392503929", "bodyText": "I would like to context on this. I may not be fully understanding this. If this will affect recoverability i.e take the cluster down and when queries are recreated, then we probably need to..", "author": "vinothchandar", "createdAt": "2020-03-13T21:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4ODQzMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjUyNjE1Mg==", "url": "https://github.com/confluentinc/ksql/pull/4733#discussion_r392526152", "bodyText": "@rodesai as well..\nSince rohan confirmed that the window expression is what we use, added cases in SqlFormatterTest around the two clauses.. They are working as expected.. (parsing, formatting)", "author": "vinothchandar", "createdAt": "2020-03-13T23:24:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4ODQzMQ=="}], "type": "inlineReview"}, {"oid": "e83b08c05eebdd1111e8b641510bcf770e946b8c", "url": "https://github.com/confluentinc/ksql/commit/e83b08c05eebdd1111e8b641510bcf770e946b8c", "message": "test: add grace period/retention cases for sql formatter test", "committedDate": "2020-03-13T23:22:24Z", "type": "commit"}]}