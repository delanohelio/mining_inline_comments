{"pr_number": 4633, "pr_title": "Use the new topics endpoint in Connect REST API to describe the topics of a connector", "pr_createdAt": "2020-02-26T01:08:40Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4633", "timeline": [{"oid": "5f7b34515d1d8ecec8aaad2e8639bcdf435178d6", "url": "https://github.com/confluentinc/ksql/commit/5f7b34515d1d8ecec8aaad2e8639bcdf435178d6", "message": "feat: use TypeReference instead of Class when reading json responses from Connect", "committedDate": "2020-02-26T06:53:05Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NTQ1MA==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r386675450", "bodyText": "is there any reason we can't use Map<String, ActiveTopicsInfo> for this API?", "author": "agavra", "createdAt": "2020-03-02T21:57:43Z", "path": "ksql-engine/src/main/java/io/confluent/ksql/services/DefaultConnectClient.java", "diffHunk": "@@ -214,6 +224,33 @@ public DefaultConnectClient(\n     }\n   }\n \n+  @Override\n+  public ConnectResponse<Map<String, Map<String, List<String>>>> topics(final String connector) {", "originalCommit": "0dd0a0be11087bc80029236164de5839485260e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3MjUyMw==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r388472523", "bodyText": "The reason is that the key is the actual name of the connector and not connector : <connector name>\nMaybe my json foo is missing a way to deserialize this with a JsonCreator and the constructor, but based on what I know it can't be done with jackson and the return type that you mention (which is a bummer but we use that notation in other endpoints already). The return type is a bit verbose, indeed.", "author": "kkonstantine", "createdAt": "2020-03-05T18:14:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NTQ1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NjEwMA==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r386676100", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              protected static final String TOPICS_KEY = \"topics\";\n          \n          \n            \n              static final String TOPICS_KEY = \"topics\";\n          \n      \n    \n    \n  \n\nnit: since this is final, might as well make it package-private", "author": "agavra", "createdAt": "2020-03-02T21:59:05Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/DescribeConnectorExecutor.java", "diffHunk": "@@ -46,6 +45,8 @@\n public final class DescribeConnectorExecutor {\n \n   private static final Logger LOG = LoggerFactory.getLogger(DescribeConnectorExecutor.class);\n+  @VisibleForTesting\n+  protected static final String TOPICS_KEY = \"topics\";", "originalCommit": "0dd0a0be11087bc80029236164de5839485260e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3MzE3OQ==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r388473179", "bodyText": "I don't use package private that much for members that are meant to be visible in tests, but happy to adjust if that's the default in the project.", "author": "kkonstantine", "createdAt": "2020-03-05T18:15:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NjEwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NjUyMQ==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r386676521", "bodyText": "we should remove this method from the Connector class altogether as I believe this was the only place this was used (EDIT: see comment below)", "author": "agavra", "createdAt": "2020-03-02T21:59:56Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/DescribeConnectorExecutor.java", "diffHunk": "@@ -137,16 +145,4 @@ public DescribeConnectorExecutor() {\n \n     return Optional.of(description);\n   }\n-\n-  private List<String> getTopics(final Admin admin, final Optional<Connector> connector)\n-      throws Exception {\n-    if (!connector.isPresent()) {\n-      return ImmutableList.of();\n-    }\n-\n-    return admin.listTopics().names().get(5, TimeUnit.SECONDS)\n-        .stream()\n-        .filter(connector.get()::matches)", "originalCommit": "0dd0a0be11087bc80029236164de5839485260e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY3OTg3OQ==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r388679879", "bodyText": "Removed. Seems that there's no need for Connector#matches and Connector#mapToSource as well as their respect member fields. I removed a couple unit tests that were built around those two methods and will wait for a full build to see what else might need adjustment (I have some issues running the full test suite locally).", "author": "kkonstantine", "createdAt": "2020-03-06T02:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY3NjUyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY5MjMwOA==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r386692308", "bodyText": "we should use the information here before getting the data sources above (basically instead of calling matches on L106 above we should check topics#contains)", "author": "agavra", "createdAt": "2020-03-02T22:34:16Z", "path": "ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/DescribeConnectorExecutor.java", "diffHunk": "@@ -114,16 +115,23 @@ public DescribeConnectorExecutor() {\n       sources = ImmutableList.of();\n     }\n \n-    List<KsqlWarning> warnings;\n-    List<String> topics;\n-    try {\n-      topics = getTopics(serviceContext.getAdminClient(), connector);\n-      warnings = ImmutableList.of();\n-    } catch (final Exception e) {\n+    final ConnectResponse<Map<String, Map<String, List<String>>>> topicsResponse = serviceContext\n+        .getConnectClient()\n+        .topics(connectorName);\n+\n+    final List<KsqlWarning> warnings;\n+    final List<String> topics;", "originalCommit": "0dd0a0be11087bc80029236164de5839485260e0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODY4MTk4OQ==", "url": "https://github.com/confluentinc/ksql/pull/4633#discussion_r388681989", "bodyText": "Moved up with a small optimization to avoid hitting the topics endpoint if the first REST call did not return the connector's info. But if the doubly nested if does look great or you think it's worth calling regardless I can change the if/else", "author": "kkonstantine", "createdAt": "2020-03-06T02:23:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY5MjMwOA=="}], "type": "inlineReview"}, {"oid": "e32f177a86a403716716b19dfc653fb810856a12", "url": "https://github.com/confluentinc/ksql/commit/e32f177a86a403716716b19dfc653fb810856a12", "message": "feat: extend ConnectClient to add topics method", "committedDate": "2020-03-06T01:23:24Z", "type": "commit"}, {"oid": "1ff683bdce91c84426e60f4f0c2c5b73dbba47ec", "url": "https://github.com/confluentinc/ksql/commit/1ff683bdce91c84426e60f4f0c2c5b73dbba47ec", "message": "feat: use ConnectClient#topics to describe a connector's topics", "committedDate": "2020-03-06T01:23:24Z", "type": "commit"}, {"oid": "96b2dba253a2cd2913674693c68d1b43d52514b8", "url": "https://github.com/confluentinc/ksql/commit/96b2dba253a2cd2913674693c68d1b43d52514b8", "message": "test: adapt tests to the new topics method", "committedDate": "2020-03-06T01:23:24Z", "type": "commit"}, {"oid": "f8465ea945a94d7915be51f55843b334fed24f3c", "url": "https://github.com/confluentinc/ksql/commit/f8465ea945a94d7915be51f55843b334fed24f3c", "message": "feat: use TypeReference instead of Class when reading json responses from Connect", "committedDate": "2020-03-06T01:23:24Z", "type": "commit"}, {"oid": "81176925254ef18f58d3f64d78139b5ba14ef35e", "url": "https://github.com/confluentinc/ksql/commit/81176925254ef18f58d3f64d78139b5ba14ef35e", "message": "fix: use the correct endpoint for connector topics", "committedDate": "2020-03-06T01:23:24Z", "type": "commit"}, {"oid": "2915ea8a35042973ef505c529057967d24e83581", "url": "https://github.com/confluentinc/ksql/commit/2915ea8a35042973ef505c529057967d24e83581", "message": "fix: use the correct endpoint for connector topics in test too", "committedDate": "2020-03-06T01:23:24Z", "type": "commit"}, {"oid": "9644053344e3d9bd2dfc831fcae3aad3875b1b89", "url": "https://github.com/confluentinc/ksql/commit/9644053344e3d9bd2dfc831fcae3aad3875b1b89", "message": "fix: remove topic-prefix as a requirement from connector configuration", "committedDate": "2020-03-06T01:23:24Z", "type": "commit"}, {"oid": "9644053344e3d9bd2dfc831fcae3aad3875b1b89", "url": "https://github.com/confluentinc/ksql/commit/9644053344e3d9bd2dfc831fcae3aad3875b1b89", "message": "fix: remove topic-prefix as a requirement from connector configuration", "committedDate": "2020-03-06T01:23:24Z", "type": "forcePushed"}, {"oid": "455024508986e26273668b7ec704b7daf28f8154", "url": "https://github.com/confluentinc/ksql/commit/455024508986e26273668b7ec704b7daf28f8154", "message": "fix: remove unused imports", "committedDate": "2020-03-06T02:20:49Z", "type": "commit"}, {"oid": "234d4d8e014df1366cf8f648158192d85f6915ef", "url": "https://github.com/confluentinc/ksql/commit/234d4d8e014df1366cf8f648158192d85f6915ef", "message": "Update ksql-rest-app/src/main/java/io/confluent/ksql/rest/server/execution/DescribeConnectorExecutor.java\r\n\r\nstyle: prefer package private access for fields visible for testing\n\nCo-Authored-By: Almog Gavra <almog@confluent.io>", "committedDate": "2020-03-06T02:59:10Z", "type": "commit"}, {"oid": "e1acf0782ad0b04e1df165ab6a177e66e135a9ca", "url": "https://github.com/confluentinc/ksql/commit/e1acf0782ad0b04e1df165ab6a177e66e135a9ca", "message": "fix: remove unused local variable from JdbcSource", "committedDate": "2020-03-06T06:41:24Z", "type": "commit"}, {"oid": "d26dbe7f7257608cc8a9e6bf634488b479912b80", "url": "https://github.com/confluentinc/ksql/commit/d26dbe7f7257608cc8a9e6bf634488b479912b80", "message": "test: adapt test to not expect a call to topics for unknown connectors", "committedDate": "2020-03-06T18:18:26Z", "type": "commit"}, {"oid": "8b46738c488f6db9d96e51c4c4a1a8c88bdbcfcc", "url": "https://github.com/confluentinc/ksql/commit/8b46738c488f6db9d96e51c4c4a1a8c88bdbcfcc", "message": "fix: minor cleanup", "committedDate": "2020-03-09T19:31:01Z", "type": "commit"}]}