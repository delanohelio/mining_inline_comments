{"pr_number": 4351, "pr_title": "fix: Make null key serialization/deserialization symmetrical", "pr_createdAt": "2020-01-19T16:47:18Z", "pr_url": "https://github.com/confluentinc/ksql/pull/4351", "timeline": [{"oid": "2c738c50ecfc5d6feecc5567b81f9aa46d447c38", "url": "https://github.com/confluentinc/ksql/commit/2c738c50ecfc5d6feecc5567b81f9aa46d447c38", "message": "added test", "committedDate": "2020-01-19T17:08:06Z", "type": "commit"}, {"oid": "82f23495bae88897c19d38de03d4c39343988e5c", "url": "https://github.com/confluentinc/ksql/commit/82f23495bae88897c19d38de03d4c39343988e5c", "message": "fix: Make sure null key is preserved during serialization/deserialization", "committedDate": "2020-01-19T17:08:06Z", "type": "commit"}, {"oid": "cf9a3a516ab6613c4f7e8538bc699f26f033c4fe", "url": "https://github.com/confluentinc/ksql/commit/cf9a3a516ab6613c4f7e8538bc699f26f033c4fe", "message": "fixed merge conflict", "committedDate": "2020-01-19T17:12:29Z", "type": "commit"}, {"oid": "cf9a3a516ab6613c4f7e8538bc699f26f033c4fe", "url": "https://github.com/confluentinc/ksql/commit/cf9a3a516ab6613c4f7e8538bc699f26f033c4fe", "message": "fixed merge conflict", "committedDate": "2020-01-19T17:12:29Z", "type": "forcePushed"}, {"oid": "a8c591b2386a8d9aa7569140f7f690b71c42b8bd", "url": "https://github.com/confluentinc/ksql/commit/a8c591b2386a8d9aa7569140f7f690b71c42b8bd", "message": "updated test", "committedDate": "2020-01-19T19:56:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY2MDc2NA==", "url": "https://github.com/confluentinc/ksql/pull/4351#discussion_r368660764", "bodyText": "nit: if primitive is null, then could return after line 142.", "author": "big-andy-coates", "createdAt": "2020-01-20T17:26:22Z", "path": "ksql-serde/src/main/java/io/confluent/ksql/serde/kafka/KafkaSerdeFactory.java", "diffHunk": "@@ -142,7 +142,7 @@ public Struct deserialize(final String topic, final byte[] bytes) {\n         final Object primitive = delegate.deserialize(topic, bytes);\n         final Struct struct = new Struct(schema);\n         struct.put(field, primitive);\n-        return struct;\n+        return primitive == null ? null : struct;", "originalCommit": "a8c591b2386a8d9aa7569140f7f690b71c42b8bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY2MzU3Nw==", "url": "https://github.com/confluentinc/ksql/pull/4351#discussion_r368663577", "bodyText": "if its null, then assert its null... weird asserting! ;)\nAlso, this means all of the tests will pass if deserialize always returns null.\nI think it would be more explicit if we revert this change and instead have explicit tests that test we:\na) serialize null as null , and\nb) deserialize null as null.\nJust played around with this, so may as well share the code.\ni.e. we revert this to:\n  assertThat(result, is(struct));\nAnd replace shouldHandleNulls with:\n@Test\n  public void shouldSerializeNullAsNull() {\n    // Given:\n    final PersistenceSchema schema = schemaWithFieldOfType(SqlTypes.INTEGER);\n\n    final Serde<Object> serde = factory.createSerde(schema, ksqlConfig, srClientFactory);\n\n    // When:\n    final byte[] result = serde.serializer().serialize(\"topic\", null);\n\n    // Then:\n    assertThat(result, is(nullValue()));\n  }\n\n  @Test\n  public void shouldDeserializeNullAsNull() {\n    // Given:\n    final PersistenceSchema schema = schemaWithFieldOfType(SqlTypes.INTEGER);\n\n    final Serde<Object> serde = factory.createSerde(schema, ksqlConfig, srClientFactory);\n\n    // When:\n    final Object result = serde.deserializer().deserialize(\"topic\", null);\n\n    // Then:\n    assertThat(result, is(nullValue()));\n  }", "author": "big-andy-coates", "createdAt": "2020-01-20T17:33:56Z", "path": "ksql-serde/src/test/java/io/confluent/ksql/serde/kafka/KafkaSerdeFactoryTest.java", "diffHunk": "@@ -192,7 +194,11 @@ private void shouldHandle(final SqlType fieldSchema, final Object value) {\n     final Object result = serde.deserializer().deserialize(\"topic\", bytes);\n \n     // Then:\n-    assertThat(result, is(struct));\n+    if (value == null) {\n+      assertThat(result, is(nullValue()));\n+    } else {\n+      assertThat(result, is(struct));\n+    }", "originalCommit": "a8c591b2386a8d9aa7569140f7f690b71c42b8bd", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "aff74b09867d0fedfc4bb1af4dd68729844113ef", "url": "https://github.com/confluentinc/ksql/commit/aff74b09867d0fedfc4bb1af4dd68729844113ef", "message": "Review updates", "committedDate": "2020-01-20T18:50:02Z", "type": "commit"}]}