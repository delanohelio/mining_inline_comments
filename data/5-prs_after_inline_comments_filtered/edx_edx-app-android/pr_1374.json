{"pr_number": 1374, "pr_title": "AndroidX Migration", "pr_createdAt": "2020-02-19T15:05:33Z", "pr_url": "https://github.com/edx/edx-app-android/pull/1374", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDkxNTUyOA==", "url": "https://github.com/edx/edx-app-android/pull/1374#discussion_r390915528", "bodyText": "This class is never used, we can remove this.", "author": "farhan-arshad-dev", "createdAt": "2020-03-11T11:45:54Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/base/CustomTypefaceSpan.java", "diffHunk": "@@ -3,11 +3,12 @@\n import android.content.Context;\n import android.graphics.Paint;\n import android.graphics.Typeface;\n-import android.support.v4.util.LruCache;\n import android.text.Spannable;\n import android.text.TextPaint;\n import android.text.style.MetricAffectingSpan;\n \n+import androidx.collection.LruCache;\n+", "originalCommit": "079f858987593205d18dadf44662a44385c44e1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI0OTY1Mg==", "url": "https://github.com/edx/edx-app-android/pull/1374#discussion_r394249652", "bodyText": "try to run the test without runOnUiThread, tests are running locally.", "author": "farhan-arshad-dev", "createdAt": "2020-03-18T10:37:22Z", "path": "OpenEdXMobile/src/androidTest/java/org/edx/mobile/test/screenshot/test/LaunchScreenshotTests.java", "diffHunk": "@@ -18,9 +20,14 @@\n     public ActivityTestRule<LaunchActivity> mActivityRule =\n             new ActivityTestRule<>(LaunchActivity.class, true, true);\n \n+    @Rule\n+    public TestName testName = new TestName();\n+\n     @Test\n     public void testScreenshot_recordLaunchActivity() throws Throwable {\n-        View view = mActivityRule.getActivity().findViewById(android.R.id.content);\n-        Screenshot.snap(view).record();\n+        Activity activity = mActivityRule.getActivity();\n+        activity.runOnUiThread(() -> {", "originalCommit": "c3876f2fa1d7b699f2e4d072225c1cdc981c6b65", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI0OTc1NA==", "url": "https://github.com/edx/edx-app-android/pull/1374#discussion_r394249754", "bodyText": "try to run the test without runOnUiThread, tests are running locally.", "author": "farhan-arshad-dev", "createdAt": "2020-03-18T10:37:33Z", "path": "OpenEdXMobile/src/androidTest/java/org/edx/mobile/view/PresenterActivityScreenshotTest.java", "diffHunk": "@@ -51,15 +52,19 @@\n     @Before\n     public void before() {\n         this.presenter = mock(getPresenterType());\n-        ((EdxInstrumentationTestApplication) InstrumentationRegistry.getTargetContext().getApplicationContext()).setNextPresenter(presenter);\n+        ((EdxInstrumentationTestApplication) InstrumentationRegistry.getInstrumentation().\n+                getTargetContext().getApplicationContext()).setNextPresenter(presenter);\n         this.activity = mActivityRule.launchActivity(null);\n         // To simplify tests, we automatically execute view methods on the application's UI thread.\n         this.view = UiThreadInvocationHandler.newProxyInstance(uiThreadTestRule, activity.view, getViewType());\n     }\n \n     @After\n     public void after() {\n-        Screenshot.snap(activity.findViewById(android.R.id.content)).setName(getClass().getName() + \"_\" + testName.getMethodName()).record();\n+        activity.runOnUiThread(() -> {\n+            Screenshot.snap(activity.findViewById(android.R.id.content)).setName(getClass().getName() + \"_\" + testName.getMethodName()).record();", "originalCommit": "c3876f2fa1d7b699f2e4d072225c1cdc981c6b65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTQ3MTk2MA==", "url": "https://github.com/edx/edx-app-android/pull/1374#discussion_r395471960", "bodyText": "Without this statement here's the exception that gets raised:\nCalledFromWrongThreadException: Only the original thread that created a view hierarchy can touch its views.", "author": "miankhalid", "createdAt": "2020-03-20T07:32:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI0OTc1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDI2Nzg5MQ==", "url": "https://github.com/edx/edx-app-android/pull/1374#discussion_r394267891", "bodyText": "Please mention the purpose/inspiration ref for these changes.", "author": "farhan-arshad-dev", "createdAt": "2020-03-18T11:09:30Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/http/util/Tls12SocketFactory.java", "diffHunk": "@@ -95,9 +101,19 @@ private Socket patch(Socket s) {\n     public static OkHttpClient.Builder enableTls12OnPreLollipop(OkHttpClient.Builder client) {\n         if (Build.VERSION.SDK_INT < 22) {\n             try {\n-                final SSLContext sslContext = SSLContext.getInstance(\"TLSv1.2\");\n-                sslContext.init(null, null, null);\n-                client.sslSocketFactory(new Tls12SocketFactory(sslContext.getSocketFactory()));\n+                final TrustManagerFactory trustManagerFactory = TrustManagerFactory.getInstance(\n+                        TrustManagerFactory.getDefaultAlgorithm());\n+                trustManagerFactory.init((KeyStore) null);\n+                final TrustManager[] trustManagers = trustManagerFactory.getTrustManagers();\n+                if (trustManagers.length != 1 || !(trustManagers[0] instanceof X509TrustManager)) {\n+                    throw new IllegalStateException(\"Unexpected default trust managers:\"\n+                            + Arrays.toString(trustManagers));\n+                }\n+                final X509TrustManager trustManager = (X509TrustManager) trustManagers[0];\n+\n+                final SSLContext sslContext = SSLContext.getInstance(\"TLS\");\n+                sslContext.init(null, new TrustManager[]{trustManager}, null);\n+                client.sslSocketFactory(new Tls12SocketFactory(sslContext.getSocketFactory()), trustManager);", "originalCommit": "291dbbb8968ca1afba0979bdbd61e6ac78d1e3b2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8cd11462447056b6d50bd81f0efbb3e97b7061f6", "url": "https://github.com/edx/edx-app-android/commit/8cd11462447056b6d50bd81f0efbb3e97b7061f6", "message": "Fix package issues after rebase on master", "committedDate": "2020-03-20T06:20:25Z", "type": "forcePushed"}, {"oid": "a01f0c25b5c3a46ce27a38a49170193373397d67", "url": "https://github.com/edx/edx-app-android/commit/a01f0c25b5c3a46ce27a38a49170193373397d67", "message": "Migrate to support library v28", "committedDate": "2020-03-20T18:25:13Z", "type": "commit"}, {"oid": "8f24c819d36e46cf63fadcfb97e4b248fe7bf8e1", "url": "https://github.com/edx/edx-app-android/commit/8f24c819d36e46cf63fadcfb97e4b248fe7bf8e1", "message": "Run automated AndroidX migration\n\n- Using Android Studio's migration option\n- Also ran the following bash script\nhttps://gist.github.com/dlew/5db1b780896bbc6f542e7c00a11db6a0\n- Plus some handpicked package changes\n\nAlso removed an extra file after the rebase.", "committedDate": "2020-03-20T18:25:15Z", "type": "commit"}, {"oid": "b12d4cf91e5fe87a211d4a725ab682927897ac1b", "url": "https://github.com/edx/edx-app-android/commit/b12d4cf91e5fe87a211d4a725ab682927897ac1b", "message": "Stop ignoring gradle.properties to enable Jetifier for Travis\n\nAlso increase Gradle build's heap to avoid OOM during build", "committedDate": "2020-03-20T18:39:47Z", "type": "commit"}, {"oid": "2c9a19413797a944b3b595da998679c0baed7fb2", "url": "https://github.com/edx/edx-app-android/commit/2c9a19413797a944b3b595da998679c0baed7fb2", "message": "Add androidX variant of Roboguice lib\n\nComment out gradle implementation in favor of jar library.", "committedDate": "2020-03-20T18:39:47Z", "type": "commit"}, {"oid": "0452d45d0fef4a7dad77c2448875cb2bb2347bdb", "url": "https://github.com/edx/edx-app-android/commit/0452d45d0fef4a7dad77c2448875cb2bb2347bdb", "message": "Update Gradle wrapper & Groovy version\n\nAn error that has been fixed as part of this commit.\nError: << was deprecated in Gradle 4.x and removed in Gradle 5.0\nFix: << has been replaced with doLast.\n\nMore info here:\nhttps://docs.gradle.org/current/userguide/upgrading_version_4.html#changes_5.0\n\nPointing to Gradle 5 support PR for gradle plugin and modifying\nsettings.gradle to checkout specific commit.", "committedDate": "2020-03-20T18:39:47Z", "type": "commit"}, {"oid": "3f5e569c2a204505f04d5f2a4dcd6d05331645ae", "url": "https://github.com/edx/edx-app-android/commit/3f5e569c2a204505f04d5f2a4dcd6d05331645ae", "message": "Separate out version constants", "committedDate": "2020-03-20T18:39:50Z", "type": "forcePushed"}, {"oid": "64f7da2f7a3798bd90acf564f9a9be1e6f96a9f2", "url": "https://github.com/edx/edx-app-android/commit/64f7da2f7a3798bd90acf564f9a9be1e6f96a9f2", "message": "Add shadows (Robolectric) for support-v4 package\n\nIssue: \"org.robolectric:shadows-supportv4:{latest_version}\" library\nThis library from Robolectric doesn't support AndroidX and internally\nuses support-v4 package.\n\nReference Issue: https://github.com/robolectric/robolectric/issues/3985\n\nTemporary Resolution:\nAs a workaround I've switched to using a clone of this library which\nsupports AndroidX. Inspiration taken from here:\nhttps://github.com/robolectric/robolectric/issues/3985#issuecomment-441390867\n\nActual Resolution:\nIf this passes our tests, a future task should be created to start using\nFragmentScenario from package -> androidx.fragment:fragment-testing\n\nOfficial Doc: https://developer.android.com/training/basics/fragments/testing", "committedDate": "2020-03-20T18:52:51Z", "type": "commit"}, {"oid": "2e852fc2808bcd2f52e3c9732253d53b3e37e143", "url": "https://github.com/edx/edx-app-android/commit/2e852fc2808bcd2f52e3c9732253d53b3e37e143", "message": "Update test related libraries\n\nUpdated test related libraries and a test that was failing in\nWebViewActivityTest class due to usage of AssertJ library's assertThat\nfunction (which doesn't support AndroidX views).\n\nReason:\nAssertJ has been deprecated and doesn't support AndroidX classes.\nRef: https://github.com/square/assertj-android\nInstead of AssertJ we should move towards Truth library that they\nrecommend instead.\nRef: https://truth.dev/comparison.html", "committedDate": "2020-03-20T18:57:11Z", "type": "commit"}, {"oid": "09bfc946bb2aa63727763cd89e5ebbf294c7abf5", "url": "https://github.com/edx/edx-app-android/commit/09bfc946bb2aa63727763cd89e5ebbf294c7abf5", "message": "Separate out version constants", "committedDate": "2020-03-20T18:57:32Z", "type": "forcePushed"}, {"oid": "4e7d1dcacbc6d4827dc234a03dc919c58a9df411", "url": "https://github.com/edx/edx-app-android/commit/4e7d1dcacbc6d4827dc234a03dc919c58a9df411", "message": "Update mockito library and its dexmaker\n\nMockito: https://site.mockito.org/\nDexmaker: https://github.com/linkedin/dexmaker", "committedDate": "2020-03-20T18:59:47Z", "type": "commit"}, {"oid": "0ed01e6e641fd5ebe1908cb7934058d6462d7323", "url": "https://github.com/edx/edx-app-android/commit/0ed01e6e641fd5ebe1908cb7934058d6462d7323", "message": "Fix screenshot test cases\n\n- Updated Screenshot testing library\n- Fixed screenshot tests running on wrong thread\nInstead of ActivityRule we should be using ActivityScenario which is a\nnewer API that allows running a test on main thread.\nBut for now Activity's runOnUiThread function has been used to make\ntests pass through minimal change.\n\n- Also Updated screenshots\nAfter running record statement screenshots' directory gets updated and\nprevious screenshots + directory need to be deleted.\n\nAlso updated the naming convention of screenshot generation of test in\nLaunchScreenshotTests class.", "committedDate": "2020-03-20T19:00:32Z", "type": "commit"}, {"oid": "1fae03aeacdd0bc125e919a5b2cc9f8616d0ccf9", "url": "https://github.com/edx/edx-app-android/commit/1fae03aeacdd0bc125e919a5b2cc9f8616d0ccf9", "message": "Separate out version constants", "committedDate": "2020-03-20T19:00:33Z", "type": "forcePushed"}, {"oid": "722e35f06a67823cf53f968662203c3347e168cc", "url": "https://github.com/edx/edx-app-android/commit/722e35f06a67823cf53f968662203c3347e168cc", "message": "Separate out version constants", "committedDate": "2020-03-20T19:07:00Z", "type": "forcePushed"}, {"oid": "96c47503bc31792dfe6783b505a49da37af076e3", "url": "https://github.com/edx/edx-app-android/commit/96c47503bc31792dfe6783b505a49da37af076e3", "message": "Fix code issues after the migration", "committedDate": "2020-03-20T19:12:48Z", "type": "commit"}, {"oid": "4cb4c2a0a7246e3dfec5fb1248da1f8bf62251c7", "url": "https://github.com/edx/edx-app-android/commit/4cb4c2a0a7246e3dfec5fb1248da1f8bf62251c7", "message": "Fix Glide related issues\n\nFixed Glide's custom Transformation class after lib upgrade\nNote: Inspiration for code in updateDiskCacheKey function has been taken\nfrom various classes that extend BitmapTransformation e.g. CenterCrop &\nCenterInside inside Glide's `com.bumptech.glide.load.resource.bitmap`\npackage.", "committedDate": "2020-03-20T19:12:48Z", "type": "commit"}, {"oid": "3f7c7a00c88f52fd6ff195456f8e67193b654a3f", "url": "https://github.com/edx/edx-app-android/commit/3f7c7a00c88f52fd6ff195456f8e67193b654a3f", "message": "Update okhttp3 and make Glide use our okhttp3 integration\n\nWe can't upgrade to okhttp3 v4.x since it requires the minSdkVersion set\nto Lollipop which isn't possible for us, so we are using the v3.12.x\nto cater KitKat devices.\n(p.s. okhttp3 v3.12.x will be maintained till December 31, 2020.)\n\nRef: https://square.github.io/okhttp/#requirements\nFor more info:\nhttps://medium.com/square-corner-blog/okhttp-3-13-requires-android-5-818bb78d07ce\n\nTLS socket factory class has been updated to use X509TrustManager\n\nAlso, set message to being non-null in response builder", "committedDate": "2020-03-20T19:12:48Z", "type": "commit"}, {"oid": "cb630d4a664a8d41b52c6167b26a837a906d936c", "url": "https://github.com/edx/edx-app-android/commit/cb630d4a664a8d41b52c6167b26a837a906d936c", "message": "Separate out signing related configurations to a separate module\n\nRelease configurations have been moved out of gradle.properties & app's\nbuild.gradle file to a separate folder named `signing` which will now\ncontain the .keystore file, keystore.properties file & signing.gradle\nscript (which will only be executed if the build's type is release).\n\nFor more info:\nhttps://developer.android.com/studio/publish/app-signing#secure-shared-keystore\nhttps://stackoverflow.com/a/50966504/1402616\n\nREADME has also been updated for building a release.\nBonus: Auto-links inside the README have been wrapped inside <> for\nbetter performance during live preview inside Android Studio.", "committedDate": "2020-03-20T19:12:48Z", "type": "commit"}, {"oid": "7c53409b51b38fc172a4d2ae1324b95e9ab1d838", "url": "https://github.com/edx/edx-app-android/commit/7c53409b51b38fc172a4d2ae1324b95e9ab1d838", "message": "Separate out version constants", "committedDate": "2020-03-20T19:12:48Z", "type": "commit"}, {"oid": "7c53409b51b38fc172a4d2ae1324b95e9ab1d838", "url": "https://github.com/edx/edx-app-android/commit/7c53409b51b38fc172a4d2ae1324b95e9ab1d838", "message": "Separate out version constants", "committedDate": "2020-03-20T19:12:48Z", "type": "forcePushed"}]}