{"pr_number": 1363, "pr_title": "Update mobile payment banner functionality", "pr_createdAt": "2020-01-15T11:02:07Z", "pr_url": "https://github.com/edx/edx-app-android/pull/1363", "timeline": [{"oid": "3622173e307a00ac9e0e8255beaeaba9cb51cc86", "url": "https://github.com/edx/edx-app-android/commit/3622173e307a00ac9e0e8255beaeaba9cb51cc86", "message": "Enhance feature based content locking and payment banner experience.\n\n- LEARNER-7549\n- LEARNER-7602", "committedDate": "2020-01-18T08:54:37Z", "type": "forcePushed"}, {"oid": "d5a6030e61bfa3066a5b1ed51cdfe8d420e5f203", "url": "https://github.com/edx/edx-app-android/commit/d5a6030e61bfa3066a5b1ed51cdfe8d420e5f203", "message": "Enhance feature based content locking and payment banner experience.\n\n- LEARNER-7549\n- LEARNER-7602", "committedDate": "2020-01-18T09:17:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NTIwMw==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r371655203", "bodyText": "this event is triggered only to send the course data to the course navigation screen. am I right?", "author": "farhan-arshad-dev", "createdAt": "2020-01-28T08:11:19Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseOutlineFragment.java", "diffHunk": "@@ -595,21 +591,19 @@ public void onResponse(Call<CourseUpgradeResponse> call, Response<CourseUpgradeR\n                     if (getActivity() != null) {\n                         // Set the revenue cookie\n                         EdxCookieManager.getSharedInstance(getActivity()).setMobileCookie();\n-                        final CourseUpgradeResponse courseUpgradeResponse = response.body();\n-                        if (courseUpgradeResponse != null && courseUpgradeResponse.showUpsell()\n-                                && !TextUtils.isEmpty(courseUpgradeResponse.getBasketUrl())) {\n-                            viewUpgradeToVerifiedFooter.setVisibility(View.VISIBLE);\n-                            if (!TextUtils.isEmpty(courseUpgradeResponse.getPrice())) {\n-                                tvUpgradePrice.setText(courseUpgradeResponse.getPrice());\n-                            } else {\n-                                tvUpgradePrice.setVisibility(View.GONE);\n-                            }\n-                            btnUpgradeCourse.setOnClickListener(view ->\n-                                    environment.getRouter().showCourseUpgradeWebViewActivity(\n-                                            getActivity(), courseUpgradeResponse.getBasketUrl()\n-                                    ));\n+                        courseUpgradeData = response.body();\n+                        if (courseUpgradeData != null && courseUpgradeData.showUpsell()\n+                                && !TextUtils.isEmpty(courseUpgradeData.getBasketUrl())) {\n+                            PaymentsBannerFragment.Companion.loadPaymentsBannerFragment(\n+                                    R.id.fragment_container, courseData, null,\n+                                    courseUpgradeData, true, getChildFragmentManager(), true);\n+                            EventBus.getDefault().postSticky(new CourseUpgradeDataReceivedEvent(", "originalCommit": "7147a9c68d806ebbbb0e60604d9d33e401d5548b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1OTQwNA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r371659404", "bodyText": "This should be triggered before the if condition after Line# 594 because it's a sticky event, and should be trigger again after performing payment.", "author": "farhan-arshad-dev", "createdAt": "2020-01-28T08:22:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzNjE2MQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r372236161", "bodyText": "this line of code deserves java doc, we need to trigger the event.", "author": "farhan-arshad-dev", "createdAt": "2020-01-29T08:04:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjIzNzc3Ng==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r372237776", "bodyText": "there is no need to trigger this event in a case when the app gets the response before moving to the other screen. otherwise, a particular fragment/activity will get the data twice.", "author": "farhan-arshad-dev", "createdAt": "2020-01-29T08:09:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NTIwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM0NjU4Mw==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373346583", "bodyText": "fixed!", "author": "farhan", "createdAt": "2020-01-31T07:31:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTY1NTIwMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcxMTk2Nw==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r371711967", "bodyText": "IMO, we have to use the Parcelalbe introduce in android instated of.", "author": "farhan-arshad-dev", "createdAt": "2020-01-28T10:12:39Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/model/api/CourseUpgradeResponse.java", "diffHunk": "@@ -2,7 +2,9 @@\n \n import com.google.gson.annotations.SerializedName;\n \n-public class CourseUpgradeResponse {\n+import java.io.Serializable;\n+\n+public class CourseUpgradeResponse implements Serializable {", "originalCommit": "7147a9c68d806ebbbb0e60604d9d33e401d5548b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM1MDUxNA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373350514", "bodyText": "done!", "author": "farhan", "createdAt": "2020-01-31T07:46:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcxMTk2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0MTU3OA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r371741578", "bodyText": "We have to check the following conditions here.\n\nFirebase is enabled.\nFirebase remote config for Revenue is enabled.\nCourseUpgrade->ShowUpsell is true.", "author": "farhan-arshad-dev", "createdAt": "2020-01-28T11:14:06Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/adapters/CourseUnitPagerAdapter.java", "diffHunk": "@@ -79,7 +84,11 @@ public Fragment getItem(int pos) {\n         CourseUnitFragment unitFragment;\n         final boolean isYoutubeVideo = (minifiedUnit instanceof VideoBlockModel && ((VideoBlockModel) minifiedUnit).getData().encodedVideos.getYoutubeVideoInfo() != null);\n         if (minifiedUnit.getAuthorizationDenialReason() == AuthorizationDenialReason.FEATURE_BASED_ENROLLMENTS) {\n-            unitFragment = CourseUnitMobileNotSupportedFragment.newInstance(minifiedUnit);\n+//            if (MPB is enabled on firebase config) {\n+            unitFragment = LockedCourseUnitFragment.newInstance(minifiedUnit, courseData, courseUpgradeData);", "originalCommit": "7147a9c68d806ebbbb0e60604d9d33e401d5548b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUyMDYzMg==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373520632", "bodyText": "fixed as per discussion", "author": "farhan", "createdAt": "2020-01-31T14:55:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0MTU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0NTc3MA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r371745770", "bodyText": "There should be logic to remove PaymentsBannerFragment in case of getCourseUpgradeStatus onFailure after successfully performing the payment.", "author": "farhan-arshad-dev", "createdAt": "2020-01-28T11:24:30Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseOutlineFragment.java", "diffHunk": "@@ -618,7 +612,6 @@ public void onResponse(Call<CourseUpgradeResponse> call, Response<CourseUpgradeR\n                 public void onFailure(Call<CourseUpgradeResponse> call, Throwable t) {\n                     // Setting the call to null ensures that only 1 request is enqueued at a specific point in time\n                     getCourseUpgradeStatus = null;\n-                    viewUpgradeToVerifiedFooter.setVisibility(View.GONE);", "originalCommit": "7147a9c68d806ebbbb0e60604d9d33e401d5548b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM1MjE3MQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373352171", "bodyText": "done!", "author": "farhan", "createdAt": "2020-01-31T07:52:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTc0NTc3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1MjEzMQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r372852131", "bodyText": "We have to use the blockId instated of and remove minifiedBlockId from the method definition as to make parity with SegmentAnalytics.", "author": "farhan-arshad-dev", "createdAt": "2020-01-30T09:54:20Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/module/analytics/FirebaseAnalytics.java", "diffHunk": "@@ -184,6 +184,18 @@ public void trackDownloadComplete(String videoId, String courseId,\n         logFirebaseEvent(event.getName(), event.getBundle());\n     }\n \n+    @Override\n+    public void trackCourseUpgradeSuccess(String blockId, String courseId, String minifiedBlockId) {\n+        final FirebaseEvent event = new FirebaseEvent(Events.COURSE_UPGRADE_SUCCESS,\n+                Values.USER_COURSE_UPGRADE_SUCCESS);\n+        event.putCourseId(courseId);\n+        event.putString(Keys.BLOCK_ID, minifiedBlockId);", "originalCommit": "7a476155b1cf27f6ee126d2a62687a6af4241012", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxNzg1MQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373517851", "bodyText": "Its in parity with trackCourseComponentViewed function.", "author": "farhan", "createdAt": "2020-01-31T14:50:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1MjEzMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2NDAxNQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r372864015", "bodyText": "After the parity of Firebase and Segment analytics need to remove the minifiedBlockId.", "author": "farhan-arshad-dev", "createdAt": "2020-01-30T10:18:07Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/module/analytics/Analytics.java", "diffHunk": "@@ -131,6 +131,15 @@ void trackVideoSeek(String videoId, Double oldTime, Double newTime,\n     void trackDownloadComplete(String videoId, String courseId,\n                                String unitUrl);\n \n+    /**\n+     * Track user's successful course upgrade.\n+     *\n+     * @param blockId         ID of the locked course unit from which the user is redirected to upgrade screen.\n+     * @param courseId        ID of the course which user has upgraded.\n+     * @param minifiedBlockId Block ID of the locked course unit from which the user is redirected to upgrade screen.\n+     */\n+    void trackCourseUpgradeSuccess(String blockId, String courseId, String minifiedBlockId);", "originalCommit": "7a476155b1cf27f6ee126d2a62687a6af4241012", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxNzc4OA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373517788", "bodyText": "Its in parity with trackCourseComponentViewed function.", "author": "farhan", "createdAt": "2020-01-31T14:50:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg2NDAxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5MTMyNQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r372891325", "bodyText": "There is no need to overload the method, the other method is not called from anywhere else.", "author": "farhan-arshad-dev", "createdAt": "2020-01-30T11:16:03Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/Router.java", "diffHunk": "@@ -198,50 +203,43 @@ public void showCourseAnnouncementFromNotification(@NonNull Context context, @No\n                 .startActivities();\n     }\n \n-    public void showCourseContainerOutline(Activity activity, EnrolledCoursesResponse model,\n+    public void showCourseContainerOutline(Activity activity, EnrolledCoursesResponse courseData,", "originalCommit": "7a476155b1cf27f6ee126d2a62687a6af4241012", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxNjE3NQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373516175", "bodyText": "done", "author": "farhan", "createdAt": "2020-01-31T14:47:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5MTMyNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5NTA0Ng==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r372895046", "bodyText": "code can be replaced by\nfinal CourseComponent courseUnit = (CourseComponent) getIntent().getSerializableExtra(Router.EXTRA_COURSE_UNIT);", "author": "farhan-arshad-dev", "createdAt": "2020-01-30T11:25:30Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseUpgradeWebViewActivity.java", "diffHunk": "@@ -30,7 +39,13 @@ protected void onCreate(Bundle savedInstanceState) {\n \n     @Override\n     public Fragment getFirstFragment() {\n+        final EnrolledCoursesResponse courseData = (EnrolledCoursesResponse) getIntent().getSerializableExtra(Router.EXTRA_COURSE_DATA);\n+        final Serializable serializable = getIntent().getSerializableExtra(Router.EXTRA_COURSE_UNIT);\n+        CourseComponent courseUnit = null;\n+        if (serializable != null) {\n+            courseUnit = (CourseComponent) serializable;\n+        }", "originalCommit": "7a476155b1cf27f6ee126d2a62687a6af4241012", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxNTQwNQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373515405", "bodyText": "done", "author": "farhan", "createdAt": "2020-01-31T14:46:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5NTA0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5ODA2Ng==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r372898066", "bodyText": "can be replaced by\n                // Fire analytics\n                final CourseComponent courseUnit = (CourseComponent) arguments.getSerializable(Router.EXTRA_COURSE_UNIT);\n                if (courseUnit != null) {\n                    analyticsRegistry.trackCourseUpgradeSuccess(courseUnit.getId(),\n                            courseData.getCourse().getId(), courseUnit.getBlockId());\n                } else {\n                    analyticsRegistry.trackCourseUpgradeSuccess(null,\n                            courseData.getCourse().getId(), null);\n                }", "author": "farhan-arshad-dev", "createdAt": "2020-01-30T11:32:19Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseUpgradeWebViewFragment.java", "diffHunk": "@@ -69,9 +90,40 @@ public void onStop() {\n         if (getActivity() != null && authWebView.getWebView() != null) {\n             final String url = authWebView.getWebView().getUrl();\n             if (url != null && url.contains(\"checkout/receipt\")) {\n-                getActivity().finish();\n+                onCoursePaymentSuccessful();\n             }\n+        }\n+    }\n \n+    public void onCoursePaymentSuccessful() {\n+        // Finish activity\n+        final Activity activity = getActivity();\n+        if( activity != null) {\n+            activity.finish();\n+        }\n+\n+        final Bundle arguments = getArguments();\n+        if (arguments != null) {\n+            final EnrolledCoursesResponse courseData =\n+                    (EnrolledCoursesResponse) arguments.getSerializable(Router.EXTRA_COURSE_DATA);\n+\n+            // Fire Course Upgraded event\n+            EventBus.getDefault().postSticky(new CourseUpgradedEvent(courseData.getCourse().getId()));\n+\n+            // Fire analytics\n+            final Serializable serializable = arguments.getSerializable(Router.EXTRA_COURSE_UNIT);\n+            CourseComponent courseUnit;\n+            if (serializable != null) {\n+                courseUnit = (CourseComponent) serializable;\n+                analyticsRegistry.trackCourseUpgradeSuccess(courseUnit.getId(),\n+                        courseData.getCourse().getId(), courseUnit.getBlockId());\n+            } else {\n+                analyticsRegistry.trackCourseUpgradeSuccess(null,\n+                        courseData.getCourse().getId(), null);\n+            }", "originalCommit": "7a476155b1cf27f6ee126d2a62687a6af4241012", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxNDg1Nw==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r373514857", "bodyText": "done", "author": "farhan", "createdAt": "2020-01-31T14:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5ODA2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUxMDc5MQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374510791", "bodyText": "removeStickyEvent should be called only on the CourseOutlineActivity otherwise other screens won't be closed.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T07:32:33Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseUnitNavigationActivity.java", "diffHunk": "@@ -276,4 +278,9 @@ public boolean showGoogleCastButton() {\n         }\n         return super.showGoogleCastButton();\n     }\n+\n+    public void onEvent(CourseUpgradedEvent event) {\n+        EventBus.getDefault().removeStickyEvent(CourseUpgradedEvent.class);", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUxMDk4NA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374510984", "bodyText": "removeStickyEvent should be called only on the CourseOutlineActivity otherwise other screens won't be closed.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T07:33:04Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseOutlineFragment.java", "diffHunk": "@@ -777,6 +778,16 @@ public void onEvent(CourseDashboardRefreshEvent e) {\n         fetchCourseComponent();\n     }\n \n+    public void onEvent(CourseUpgradedEvent event) {\n+        EventBus.getDefault().removeStickyEvent(CourseUpgradedEvent.class);", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4MzA3Nw==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374583077", "bodyText": "Need to remove extra line.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T10:16:23Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/module/analytics/Analytics.java", "diffHunk": "@@ -670,6 +682,8 @@ void trackCastDeviceConnectionChanged(@NonNull String eventName, @NonNull String\n         String REGISTRATION_SUCCESS = \"Registration Success\";\n         String COURSE_ENROLL_CLICKED = \"Course Enroll Clicked\";\n         String COURSE_ENROLL_SUCCESS = \"Course Enroll Success\";\n+        String COURSE_UPGRADE_SUCCESS = \"Course Upgrade Success\";\n+", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MzE0MA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374643140", "bodyText": "done", "author": "farhan", "createdAt": "2020-02-04T12:32:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4MzA3Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4ODQ0OA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374588448", "bodyText": "Need to remove redundant cast.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T10:26:51Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseBaseActivity.java", "diffHunk": "@@ -104,12 +106,14 @@ protected void onDestroy() {\n     public void onSaveInstanceState(Bundle outState) {\n         super.onSaveInstanceState(outState);\n         outState.putSerializable(Router.EXTRA_COURSE_DATA, courseData);\n+        outState.putParcelable(Router.EXTRA_COURSE_UPGRADE_DATA, courseUpgradeData);\n         outState.putString(Router.EXTRA_COURSE_COMPONENT_ID, courseComponentId);\n     }\n \n     protected void restore(Bundle savedInstanceState) {\n         blocksApiVersion = config.getApiUrlVersionConfig().getBlocksApiVersion();\n         courseData = (EnrolledCoursesResponse) savedInstanceState.getSerializable(Router.EXTRA_COURSE_DATA);\n+        courseUpgradeData = (CourseUpgradeResponse) savedInstanceState.getParcelable(Router.EXTRA_COURSE_UPGRADE_DATA);", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MjkzOA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374642938", "bodyText": "done", "author": "farhan", "createdAt": "2020-02-04T12:31:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4ODQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4OTI5NA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374589294", "bodyText": "Need auto-format.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T10:28:26Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseOutlineActivity.java", "diffHunk": "@@ -1,30 +1,60 @@\n package org.edx.mobile.view;\n \n+import android.app.Activity;\n+import android.content.Intent;\n import android.os.Bundle;\n import android.support.v4.app.Fragment;\n \n import org.edx.mobile.base.BaseSingleFragmentActivity;\n+import org.edx.mobile.event.CourseUpgradedEvent;\n+import org.edx.mobile.model.api.CourseUpgradeResponse;\n import org.edx.mobile.model.api.EnrolledCoursesResponse;\n import org.edx.mobile.module.analytics.Analytics;\n \n+import de.greenrobot.event.EventBus;\n import roboguice.inject.InjectExtra;\n \n+import static org.edx.mobile.view.Router.EXTRA_BUNDLE;\n+import static org.edx.mobile.view.Router.EXTRA_COURSE_COMPONENT_ID;\n+import static org.edx.mobile.view.Router.EXTRA_COURSE_DATA;\n+import static org.edx.mobile.view.Router.EXTRA_COURSE_UPGRADE_DATA;\n+import static org.edx.mobile.view.Router.EXTRA_IS_VIDEOS_MODE;\n+import static org.edx.mobile.view.Router.EXTRA_LAST_ACCESSED_ID;\n+\n public class CourseOutlineActivity extends BaseSingleFragmentActivity {\n-    @InjectExtra(Router.EXTRA_BUNDLE)\n+    @InjectExtra(EXTRA_BUNDLE)\n     private Bundle courseBundle;\n \n-    @InjectExtra(value = Router.EXTRA_COURSE_COMPONENT_ID, optional = true)\n+    @InjectExtra(value = EXTRA_COURSE_COMPONENT_ID, optional = true)\n     private String courseComponentId = null;\n \n-    @InjectExtra(Router.EXTRA_IS_VIDEOS_MODE)\n+    @InjectExtra(EXTRA_IS_VIDEOS_MODE)\n     private boolean isVideoMode = false;\n \n+    public static Intent newIntent(Activity activity,\n+                             EnrolledCoursesResponse courseData,\n+                             CourseUpgradeResponse courseUpgradeData,\n+                             String courseComponentId, String lastAccessedId,\n+                             boolean isVideosMode) {\n+        Bundle courseBundle = new Bundle();\n+        courseBundle.putSerializable(EXTRA_COURSE_DATA, courseData);\n+        courseBundle.putParcelable(EXTRA_COURSE_UPGRADE_DATA, courseUpgradeData);\n+        courseBundle.putString(EXTRA_COURSE_COMPONENT_ID, courseComponentId);\n+\n+        final Intent intent = new Intent(activity, CourseOutlineActivity.class);\n+        intent.putExtra(EXTRA_BUNDLE, courseBundle);\n+        intent.putExtra(EXTRA_LAST_ACCESSED_ID, lastAccessedId);\n+        intent.putExtra(EXTRA_IS_VIDEOS_MODE, isVideosMode);\n+\n+        return intent;\n+    }\n+", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MjQ2NA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374642464", "bodyText": "done", "author": "farhan", "createdAt": "2020-02-04T12:30:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4OTI5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4OTU2MA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374589560", "bodyText": "courseBundle should be final.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T10:28:55Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseOutlineActivity.java", "diffHunk": "@@ -1,30 +1,60 @@\n package org.edx.mobile.view;\n \n+import android.app.Activity;\n+import android.content.Intent;\n import android.os.Bundle;\n import android.support.v4.app.Fragment;\n \n import org.edx.mobile.base.BaseSingleFragmentActivity;\n+import org.edx.mobile.event.CourseUpgradedEvent;\n+import org.edx.mobile.model.api.CourseUpgradeResponse;\n import org.edx.mobile.model.api.EnrolledCoursesResponse;\n import org.edx.mobile.module.analytics.Analytics;\n \n+import de.greenrobot.event.EventBus;\n import roboguice.inject.InjectExtra;\n \n+import static org.edx.mobile.view.Router.EXTRA_BUNDLE;\n+import static org.edx.mobile.view.Router.EXTRA_COURSE_COMPONENT_ID;\n+import static org.edx.mobile.view.Router.EXTRA_COURSE_DATA;\n+import static org.edx.mobile.view.Router.EXTRA_COURSE_UPGRADE_DATA;\n+import static org.edx.mobile.view.Router.EXTRA_IS_VIDEOS_MODE;\n+import static org.edx.mobile.view.Router.EXTRA_LAST_ACCESSED_ID;\n+\n public class CourseOutlineActivity extends BaseSingleFragmentActivity {\n-    @InjectExtra(Router.EXTRA_BUNDLE)\n+    @InjectExtra(EXTRA_BUNDLE)\n     private Bundle courseBundle;\n \n-    @InjectExtra(value = Router.EXTRA_COURSE_COMPONENT_ID, optional = true)\n+    @InjectExtra(value = EXTRA_COURSE_COMPONENT_ID, optional = true)\n     private String courseComponentId = null;\n \n-    @InjectExtra(Router.EXTRA_IS_VIDEOS_MODE)\n+    @InjectExtra(EXTRA_IS_VIDEOS_MODE)\n     private boolean isVideoMode = false;\n \n+    public static Intent newIntent(Activity activity,\n+                             EnrolledCoursesResponse courseData,\n+                             CourseUpgradeResponse courseUpgradeData,\n+                             String courseComponentId, String lastAccessedId,\n+                             boolean isVideosMode) {\n+        Bundle courseBundle = new Bundle();", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY0MjA3MQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374642071", "bodyText": "done", "author": "farhan", "createdAt": "2020-02-04T12:29:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU4OTU2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU5MDQ5Nw==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374590497", "bodyText": "IMO, first consume the event and then remove it.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T10:30:47Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseOutlineActivity.java", "diffHunk": "@@ -39,4 +69,9 @@ public Fragment getFirstFragment() {\n         fragment.setArguments(getIntent().getExtras());\n         return fragment;\n     }\n+\n+    public void onEvent(CourseUpgradedEvent event) {\n+        EventBus.getDefault().removeStickyEvent(CourseUpgradedEvent.class);", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NjI0Mg==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374656242", "bodyText": "as per discussion, code is equally good in this way", "author": "farhan", "createdAt": "2020-02-04T13:01:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDU5MDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYwMDk0MA==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374600940", "bodyText": "courseData can be removed, this is used only to get the courseId that we can get through courseUnit like the following statement\ncourseUnit.getRoot().getCourseId();\n\nps: please remove the passing of courseData from the paranet activities/fragment too, if not necessory.", "author": "farhan-arshad-dev", "createdAt": "2020-02-04T10:52:12Z", "path": "OpenEdXMobile/src/main/java/org/edx/mobile/view/CourseUpgradeWebViewFragment.java", "diffHunk": "@@ -69,9 +88,38 @@ public void onStop() {\n         if (getActivity() != null && authWebView.getWebView() != null) {\n             final String url = authWebView.getWebView().getUrl();\n             if (url != null && url.contains(\"checkout/receipt\")) {\n-                getActivity().finish();\n+                onCoursePaymentSuccessful();\n             }\n+        }\n+    }\n \n+    public void onCoursePaymentSuccessful() {\n+        // Finish activity\n+        final Activity activity = getActivity();\n+        if( activity != null) {\n+            activity.finish();\n+        }\n+\n+        final Bundle arguments = getArguments();\n+        if (arguments != null) {\n+            final EnrolledCoursesResponse courseData =", "originalCommit": "395b5ab72403917ae45491412235f369abce3c48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDY1NTg2MQ==", "url": "https://github.com/edx/edx-app-android/pull/1363#discussion_r374655861", "bodyText": "We need it when the user will be redirected from the Course Dashboard screen.", "author": "farhan", "createdAt": "2020-02-04T13:00:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDYwMDk0MA=="}], "type": "inlineReview"}, {"oid": "41c1a72dd3150bd5ddc586ecc0c016a51a2064d5", "url": "https://github.com/edx/edx-app-android/commit/41c1a72dd3150bd5ddc586ecc0c016a51a2064d5", "message": "Fix sticky notification issue", "committedDate": "2020-02-06T13:21:22Z", "type": "forcePushed"}, {"oid": "3c833d14dc7dd07d09e54b8584eef3e9f84b1b85", "url": "https://github.com/edx/edx-app-android/commit/3c833d14dc7dd07d09e54b8584eef3e9f84b1b85", "message": "Fix sticky notification issue", "committedDate": "2020-02-07T06:45:44Z", "type": "forcePushed"}, {"oid": "44f5ca2b621cc7b7140694fe9c36819d6d7ebca6", "url": "https://github.com/edx/edx-app-android/commit/44f5ca2b621cc7b7140694fe9c36819d6d7ebca6", "message": "Enhance feature based content locking and payment banner experience.\n\n- LEARNER-7549\n- LEARNER-7602", "committedDate": "2020-02-07T14:08:07Z", "type": "forcePushed"}, {"oid": "0a62838502a43612a6b82782314db0360e0bf117", "url": "https://github.com/edx/edx-app-android/commit/0a62838502a43612a6b82782314db0360e0bf117", "message": "Enhance feature based content locking and payment banner experience.\n\n- LEARNER-7549\n- LEARNER-7602\n- LEARNER-7608\ni", "committedDate": "2020-02-07T14:10:23Z", "type": "commit"}, {"oid": "0a62838502a43612a6b82782314db0360e0bf117", "url": "https://github.com/edx/edx-app-android/commit/0a62838502a43612a6b82782314db0360e0bf117", "message": "Enhance feature based content locking and payment banner experience.\n\n- LEARNER-7549\n- LEARNER-7602\n- LEARNER-7608\ni", "committedDate": "2020-02-07T14:10:23Z", "type": "forcePushed"}]}