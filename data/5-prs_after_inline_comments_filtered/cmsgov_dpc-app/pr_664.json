{"pr_number": 664, "pr_title": "DPC-1171: Queue NPE fixes", "pr_createdAt": "2020-03-06T16:35:25Z", "pr_url": "https://github.com/CMSgov/dpc-app/pull/664", "timeline": [{"oid": "f677f15104e0e3a7d577d24d5035784cc731ac60", "url": "https://github.com/CMSgov/dpc-app/commit/f677f15104e0e3a7d577d24d5035784cc731ac60", "message": "Fix for NPE on queue stop", "committedDate": "2020-03-05T15:51:52Z", "type": "commit"}, {"oid": "66101ef10a40041e4fc4b540106fe831975aff00", "url": "https://github.com/CMSgov/dpc-app/commit/66101ef10a40041e4fc4b540106fe831975aff00", "message": "Refactors the queue listener so it doesn't stop on error", "committedDate": "2020-03-05T20:42:59Z", "type": "commit"}, {"oid": "57209c078bbe51b3bc87966afcdd95db6ff0a62b", "url": "https://github.com/CMSgov/dpc-app/commit/57209c078bbe51b3bc87966afcdd95db6ff0a62b", "message": "DPC-1171: Improves failure unit tests to trigger multiple exceptions", "committedDate": "2020-03-06T16:42:24Z", "type": "commit"}, {"oid": "4cfd6869f06431066f082592f93cdded1fbf74c1", "url": "https://github.com/CMSgov/dpc-app/commit/4cfd6869f06431066f082592f93cdded1fbf74c1", "message": "DPC-1171: Batch aggregator needs unit test update to match refactor", "committedDate": "2020-03-06T16:43:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNTk0Nw==", "url": "https://github.com/CMSgov/dpc-app/pull/664#discussion_r389735947", "bodyText": "Instead of using a defer, I suggest that you use fromCallable. This would handle the case if claimBatch threw an exception.", "author": "RickHawesUSDS", "createdAt": "2020-03-09T14:44:15Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -110,21 +111,38 @@ public Boolean isRunning() {\n      * The main run-loop of the engine.\n      */\n     protected void pollQueue() {\n-        queueRunning.set(true);\n-        subscribe = Observable.fromCallable(() -> this.queue.claimBatch(aggregatorID))\n-                .doOnNext(job -> logger.trace(\"Polling queue for job\"))\n-                .doOnError(error -> logger.error(\"Unable to complete job.\", error))\n-                .onErrorResumeNext(Observable.empty()) // Keep the queue running on error\n-                .filter(Optional::isPresent)\n-                .map(Optional::get)\n+        this.subscribe = this.createQueueObserver()\n                 .repeatWhen(completed -> {\n-                    logger.debug(String.format(\"No job, polling again in %d milliseconds\", operationsConfig.getPollingFrequency()));\n+                    logger.debug(String.format(\"Configuring queue to poll every %d milliseconds\", operationsConfig.getPollingFrequency()));\n                     return completed.delay(operationsConfig.getPollingFrequency(), TimeUnit.MILLISECONDS);\n                 })\n-                .subscribe(this::processJobBatch, error -> {\n-                    logger.error(\"Fatal error processing the queue! Queue processing is stopping!\", error);\n-                    queueRunning.set(false);\n-                });\n+                .doOnEach(item -> logger.trace(\"Processing item: \" + item.toString()))\n+                .doOnError(error -> logger.error(\"Unable to complete job.\", error))\n+                .retry()\n+                .filter(Optional::isPresent)\n+                .map(Optional::get)\n+                .subscribe(\n+                        this::processJobBatch,\n+                        error -> {\n+                            logger.error(\"Error processing queue. Exiting...\", error);\n+                            queueRunning.set(false);\n+                        },\n+                        () -> {\n+                            logger.info(\"Finished processing queue. Exiting...\");\n+                            queueRunning.set(false);\n+                        }\n+                );\n+    }\n+\n+    /**\n+     * Creates an observer to monitor the queue\n+     */\n+    private Observable<Optional<JobQueueBatch>> createQueueObserver() {\n+        // Create using defer. This ensures that no events are omitted before a subscriber connects", "originalCommit": "4cfd6869f06431066f082592f93cdded1fbf74c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1MzQ5Mg==", "url": "https://github.com/CMSgov/dpc-app/pull/664#discussion_r389753492", "bodyText": "Changed.", "author": "ronaldheft-usds", "createdAt": "2020-03-09T15:09:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNTk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNjQwOA==", "url": "https://github.com/CMSgov/dpc-app/pull/664#discussion_r389736408", "bodyText": "What happens if claimBatch throws an exception? I believe you need a try-catch here.", "author": "RickHawesUSDS", "createdAt": "2020-03-09T14:44:54Z", "path": "dpc-aggregation/src/main/java/gov/cms/dpc/aggregation/engine/AggregationEngine.java", "diffHunk": "@@ -110,21 +111,38 @@ public Boolean isRunning() {\n      * The main run-loop of the engine.\n      */\n     protected void pollQueue() {\n-        queueRunning.set(true);\n-        subscribe = Observable.fromCallable(() -> this.queue.claimBatch(aggregatorID))\n-                .doOnNext(job -> logger.trace(\"Polling queue for job\"))\n-                .doOnError(error -> logger.error(\"Unable to complete job.\", error))\n-                .onErrorResumeNext(Observable.empty()) // Keep the queue running on error\n-                .filter(Optional::isPresent)\n-                .map(Optional::get)\n+        this.subscribe = this.createQueueObserver()\n                 .repeatWhen(completed -> {\n-                    logger.debug(String.format(\"No job, polling again in %d milliseconds\", operationsConfig.getPollingFrequency()));\n+                    logger.debug(String.format(\"Configuring queue to poll every %d milliseconds\", operationsConfig.getPollingFrequency()));\n                     return completed.delay(operationsConfig.getPollingFrequency(), TimeUnit.MILLISECONDS);\n                 })\n-                .subscribe(this::processJobBatch, error -> {\n-                    logger.error(\"Fatal error processing the queue! Queue processing is stopping!\", error);\n-                    queueRunning.set(false);\n-                });\n+                .doOnEach(item -> logger.trace(\"Processing item: \" + item.toString()))\n+                .doOnError(error -> logger.error(\"Unable to complete job.\", error))\n+                .retry()\n+                .filter(Optional::isPresent)\n+                .map(Optional::get)\n+                .subscribe(\n+                        this::processJobBatch,\n+                        error -> {\n+                            logger.error(\"Error processing queue. Exiting...\", error);\n+                            queueRunning.set(false);\n+                        },\n+                        () -> {\n+                            logger.info(\"Finished processing queue. Exiting...\");\n+                            queueRunning.set(false);\n+                        }\n+                );\n+    }\n+\n+    /**\n+     * Creates an observer to monitor the queue\n+     */\n+    private Observable<Optional<JobQueueBatch>> createQueueObserver() {\n+        // Create using defer. This ensures that no events are omitted before a subscriber connects\n+        return Observable.defer(() -> {\n+            logger.trace(\"Polling queue for job...\");\n+            return Observable.just(this.queue.claimBatch(this.aggregatorID));\n+        });", "originalCommit": "4cfd6869f06431066f082592f93cdded1fbf74c1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc1NTcwNg==", "url": "https://github.com/CMSgov/dpc-app/pull/664#discussion_r389755706", "bodyText": "The claimBatchException test (https://github.com/CMSgov/dpc-app/pull/664/files#diff-418a41c6b353afb120cabe81362f9772R97) validates the queue resumes processing and a try/catch is not needed.\nThe retry call (https://github.com/CMSgov/dpc-app/pull/664/files#diff-55cd831b5f1a3adf606630144e38cf13R121) in the observer chain picks up the exception and calls the observer to re-call claimBatch. Additionally, the error message is logged out with the doOnError call (https://github.com/CMSgov/dpc-app/pull/664/files#diff-55cd831b5f1a3adf606630144e38cf13R120).", "author": "ronaldheft-usds", "createdAt": "2020-03-09T15:12:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTczNjQwOA=="}], "type": "inlineReview"}, {"oid": "3bcfec404195e893cbb936396bb382ae0f45cdf1", "url": "https://github.com/CMSgov/dpc-app/commit/3bcfec404195e893cbb936396bb382ae0f45cdf1", "message": "Switch to using fromCallable, which includes defer", "committedDate": "2020-03-09T14:53:05Z", "type": "commit"}]}