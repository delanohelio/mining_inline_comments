{"pr_number": 310, "pr_title": "FM-189: Add Timing.TimingRepeatComponent.DurationUnit property", "pr_createdAt": "2020-12-07T18:47:21Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/310", "timeline": [{"oid": "902d07d50fcb2d3f773ea9a83ba0abe5a60312ad", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/902d07d50fcb2d3f773ea9a83ba0abe5a60312ad", "message": "Merge pull request #1 from openmrs/master\n\nBump lombok to 1.18.16", "committedDate": "2020-11-10T14:50:38Z", "type": "commit"}, {"oid": "b74f15ec4eacc3fd5fc199a92c35deeaa66d85c7", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/b74f15ec4eacc3fd5fc199a92c35deeaa66d85c7", "message": "Merge pull request #2 from openmrs/master\n\nupdate", "committedDate": "2020-12-07T18:41:37Z", "type": "commit"}, {"oid": "0b1498da6a81939c234e903594e4a3e505bb2a34", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/0b1498da6a81939c234e903594e4a3e505bb2a34", "message": "Add Timing.TimingRepeatComponent.DurationUnit property", "committedDate": "2020-12-07T18:43:54Z", "type": "commit"}, {"oid": "c497db7a7a6d69c9ca179fba22ee6b5accf6173b", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/c497db7a7a6d69c9ca179fba22ee6b5accf6173b", "message": "mapping with concept UUID", "committedDate": "2020-12-09T19:31:44Z", "type": "commit"}, {"oid": "0267bd0f00106132609f226ddeaed8914ad0afba", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/0267bd0f00106132609f226ddeaed8914ad0afba", "message": "Merge pull request #3 from openmrs/master\n\nupdate", "committedDate": "2020-12-09T19:34:52Z", "type": "commit"}, {"oid": "f964e24a6d9aa8da3a5034289f05ae5f3de8f1fc", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f964e24a6d9aa8da3a5034289f05ae5f3de8f1fc", "message": "Merge pull request #4 from theanandankit/master\n\nupdate", "committedDate": "2020-12-09T19:36:47Z", "type": "commit"}, {"oid": "56eecb3ccb7da28b2f8b389957443d5057ee7d1d", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/56eecb3ccb7da28b2f8b389957443d5057ee7d1d", "message": "Merge remote-tracking branch 'origin/FM2-189' into FM2-189", "committedDate": "2020-12-09T19:37:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDI0MDg0Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/310#discussion_r540240846", "bodyText": "So these aren't actually what the UUIDs for these concepts would look like in practice. If you look at the concepts as displayed on openconceptlab.org, you'll see an \"External ID\". That (at least for CIEL) corresponds to the UUID as it would exist in the OpenMRS concept dictionary. For example, CIEL:1822 (Hour) has an external id of \"1822AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\" (this is actually the pattern for CIEL concept UUIDs: the concept id padded with As to reach 36 characters).\nThat said, I don't want to have concept ids hard-coded in the translator like this. I'd prefer if we did something closer to what we have for ObservationCategoryMap which maps between the FHIR Observation Category terminology set and OpenMRS concept classes. This support requires a few different components:\n\n\nWe have a translator, ObservationCategoryTranslator and a corresponding implementation which adds the observation category to the FHIR resource.\n\n\nWe have a simple table that stores mappings between OpenMRS concept classes and the FHIR Observation Category. This table is defined by this class.\n\n\nFinally, we have this simple class which defines the lookups to get the category given the concept class UUID and to get the concept class UUID using the category.\n\n\nThe flexibility afforded by this model is that we're able to map arbitrary OpenMRS concept dictionaries (not all of which use the CIEL concepts) to the corresponding FHIR terminology. Does that make some kind of sense?", "author": "ibacher", "createdAt": "2020-12-10T15:03:51Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/DurationUnitTranslatorImpl.java", "diffHunk": "@@ -0,0 +1,36 @@\n+package org.openmrs.module.fhir2.api.translators.impl;\n+\n+import org.hl7.fhir.r4.model.Timing;\n+import org.openmrs.DrugOrder;\n+import org.openmrs.module.fhir2.api.translators.DurationUnitTranslator;\n+\n+import javax.annotation.Nonnull;\n+\n+public class DurationUnitTranslatorImpl implements DurationUnitTranslator {\n+\n+\t@Override\n+\tpublic Timing.UnitsOfTime toFhirResource(@Nonnull DrugOrder drugOrder) {\n+\n+\t\tString unitUUID = drugOrder.getDurationUnits().getUuid();\n+\n+\t\tswitch (unitUUID) {\n+\n+\t\t\tcase \"162583\":", "originalCommit": "56eecb3ccb7da28b2f8b389957443d5057ee7d1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5369ffc1b59b6b2cc4f46baa93425d4fb95bfb51", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/5369ffc1b59b6b2cc4f46baa93425d4fb95bfb51", "message": "liquibase modified", "committedDate": "2020-12-12T19:46:03Z", "type": "commit"}, {"oid": "a4ef743fce88dbde48b6407b3206d40fe027e817", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/a4ef743fce88dbde48b6407b3206d40fe027e817", "message": "small change in liquibase file", "committedDate": "2020-12-13T11:13:05Z", "type": "commit"}, {"oid": "1f85eb6909a1ce0b740c52b3bd4b5e61de9565d9", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/1f85eb6909a1ce0b740c52b3bd4b5e61de9565d9", "message": "small change in liquibase file", "committedDate": "2020-12-13T11:33:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQzMTQwNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/310#discussion_r542431407", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (drugOrder.getDurationUnits().getUuid() == null) {\n          \n          \n            \n            \t\tif (drugOrder.getDurationUnits() == null || drugOrder.getDurationUnits().getUuid() == null) {", "author": "ibacher", "createdAt": "2020-12-14T14:35:03Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/impl/DurationUnitTranslatorImpl.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+\n+package org.openmrs.module.fhir2.api.translators.impl;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.r4.model.Timing;\n+import org.openmrs.DrugOrder;\n+import org.openmrs.module.fhir2.api.mappings.DurationUnitMap;\n+import org.openmrs.module.fhir2.api.translators.DurationUnitTranslator;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+public class DurationUnitTranslatorImpl implements DurationUnitTranslator {\n+\t\n+\t@Autowired\n+\tprivate DurationUnitMap durationUnitMap;\n+\t\n+\t@Override\n+\tpublic Timing.UnitsOfTime toFhirResource(@Nonnull DrugOrder drugOrder) {\n+\t\t\n+\t\tif (drugOrder.getDurationUnits().getUuid() == null) {", "originalCommit": "1f85eb6909a1ce0b740c52b3bd4b5e61de9565d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQzNTEzMg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/310#discussion_r542435132", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\t\treturn (Timing.UnitsOfTime) sessionFactory.getCurrentSession().createCriteria(FhirDurationUnitMap.class)\n          \n          \n            \n            \t\t\treturn sessionFactory.getCurrentSession().createCriteria(FhirDurationUnitMap.class,  Timing.UnitsOfTime.class)", "author": "ibacher", "createdAt": "2020-12-14T14:40:06Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/mappings/DurationUnitMap.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.mappings;\n+\n+import static org.hibernate.criterion.Restrictions.eq;\n+\n+import javax.annotation.Nonnull;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.hibernate.HibernateException;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Projections;\n+import org.hl7.fhir.r4.model.Timing;\n+import org.openmrs.module.fhir2.model.FhirDurationUnitMap;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Slf4j\n+public class DurationUnitMap {\n+\t\n+\t@Autowired\n+\t@Qualifier(\"sessionFactory\")\n+\tprivate SessionFactory sessionFactory;\n+\t\n+\tpublic Timing.UnitsOfTime getDurationUnit(@Nonnull String conceptUuid) {\n+\t\t\n+\t\ttry {\n+\t\t\treturn (Timing.UnitsOfTime) sessionFactory.getCurrentSession().createCriteria(FhirDurationUnitMap.class)", "originalCommit": "1f85eb6909a1ce0b740c52b3bd4b5e61de9565d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQzNjk3NQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/310#discussion_r542436975", "bodyText": "I don't love swallowing random exceptions like this; I think I'd rather tend to fail the operation (i.e. just throw the exception) with the possible exception of NonUniqueResultException. That we can do something useful with if we catch it.", "author": "ibacher", "createdAt": "2020-12-14T14:42:32Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/mappings/DurationUnitMap.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.mappings;\n+\n+import static org.hibernate.criterion.Restrictions.eq;\n+\n+import javax.annotation.Nonnull;\n+\n+import lombok.extern.slf4j.Slf4j;\n+import org.hibernate.HibernateException;\n+import org.hibernate.SessionFactory;\n+import org.hibernate.criterion.Projections;\n+import org.hl7.fhir.r4.model.Timing;\n+import org.openmrs.module.fhir2.model.FhirDurationUnitMap;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.beans.factory.annotation.Qualifier;\n+import org.springframework.stereotype.Component;\n+\n+@Component\n+@Slf4j\n+public class DurationUnitMap {\n+\t\n+\t@Autowired\n+\t@Qualifier(\"sessionFactory\")\n+\tprivate SessionFactory sessionFactory;\n+\t\n+\tpublic Timing.UnitsOfTime getDurationUnit(@Nonnull String conceptUuid) {\n+\t\t\n+\t\ttry {\n+\t\t\treturn (Timing.UnitsOfTime) sessionFactory.getCurrentSession().createCriteria(FhirDurationUnitMap.class)\n+\t\t\t        .createAlias(\"concept\", \"c\").add(eq(\"c.uuid\", conceptUuid))\n+\t\t\t        .setProjection(Projections.property(\"unit_of_time\")).uniqueResult();\n+\t\t}\n+\t\tcatch (HibernateException e) {", "originalCommit": "1f85eb6909a1ce0b740c52b3bd4b5e61de9565d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQzNzk1MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/310#discussion_r542437950", "bodyText": "Should this map between the DrugOrder or the Concept? If we define this to take a concept then it could be more generally useful, if we need these mappings in other places.", "author": "ibacher", "createdAt": "2020-12-14T14:43:43Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/translators/DurationUnitTranslator.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.api.translators;\n+\n+import javax.annotation.Nonnull;\n+\n+import org.hl7.fhir.r4.model.Timing;\n+import org.openmrs.DrugOrder;\n+\n+public interface DurationUnitTranslator extends ToFhirTranslator<DrugOrder, Timing.UnitsOfTime> {\n+\t\n+\t@Override\n+\tTiming.UnitsOfTime toFhirResource(@Nonnull DrugOrder drugOrder);", "originalCommit": "1f85eb6909a1ce0b740c52b3bd4b5e61de9565d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQzOTg3Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/310#discussion_r542439877", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t@JoinColumn(nullable = false, name = \"concept_uuid\")\n          \n          \n            \n            \t@JoinColumn(nullable = false, name = \"concept_id\")", "author": "ibacher", "createdAt": "2020-12-14T14:46:22Z", "path": "api/src/main/java/org/openmrs/module/fhir2/model/FhirDurationUnitMap.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * This Source Code Form is subject to the terms of the Mozilla Public License,\n+ * v. 2.0. If a copy of the MPL was not distributed with this file, You can\n+ * obtain one at http://mozilla.org/MPL/2.0/. OpenMRS is also distributed under\n+ * the terms of the Healthcare Disclaimer located at http://openmrs.org/license.\n+ *\n+ * Copyright (C) OpenMRS Inc. OpenMRS is a registered trademark and the OpenMRS\n+ * graphic logo is a trademark of OpenMRS Inc.\n+ */\n+package org.openmrs.module.fhir2.model;\n+\n+import javax.persistence.Column;\n+import javax.persistence.Entity;\n+import javax.persistence.EnumType;\n+import javax.persistence.Enumerated;\n+import javax.persistence.GeneratedValue;\n+import javax.persistence.GenerationType;\n+import javax.persistence.Id;\n+import javax.persistence.JoinColumn;\n+import javax.persistence.ManyToOne;\n+import javax.persistence.Table;\n+\n+import java.util.Date;\n+import java.util.UUID;\n+\n+import lombok.Data;\n+import lombok.EqualsAndHashCode;\n+import org.hibernate.search.annotations.Field;\n+import org.hl7.fhir.r4.model.Timing;\n+import org.openmrs.Auditable;\n+import org.openmrs.Concept;\n+import org.openmrs.Retireable;\n+import org.openmrs.User;\n+\n+@Data\n+@EqualsAndHashCode(onlyExplicitlyIncluded = true, callSuper = false)\n+@Entity\n+@Table(name = \"fhir_duration_unit_map\")\n+public class FhirDurationUnitMap implements Auditable, Retireable {\n+\t\n+\t@EqualsAndHashCode.Include\n+\t@Id\n+\t@GeneratedValue(strategy = GenerationType.AUTO)\n+\t@Column(name = \"duration_unit_map_id\")\n+\tprivate Integer id;\n+\t\n+\t@ManyToOne(optional = false)\n+\t@JoinColumn(nullable = false, name = \"concept_uuid\")", "originalCommit": "1f85eb6909a1ce0b740c52b3bd4b5e61de9565d9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0cd6b236a05e90f796bc1c4d96bb276b7abb2d6d", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/0cd6b236a05e90f796bc1c4d96bb276b7abb2d6d", "message": "durationUnitTranslatorImpl test added", "committedDate": "2020-12-15T18:22:39Z", "type": "commit"}, {"oid": "1b835bb3e72133a4887b5b4acea24e3f0b27619e", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/1b835bb3e72133a4887b5b4acea24e3f0b27619e", "message": "small change in test", "committedDate": "2020-12-16T08:42:44Z", "type": "commit"}, {"oid": "79f1394f5636f673b48d17f5dc10d4f65a01ca29", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/79f1394f5636f673b48d17f5dc10d4f65a01ca29", "message": "test updated with mapping", "committedDate": "2020-12-18T12:27:50Z", "type": "commit"}]}