{"pr_number": 197, "pr_title": "FM2-209: Implement search for MedicationRequest Resource", "pr_createdAt": "2020-06-08T11:44:11Z", "pr_url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197", "timeline": [{"oid": "f80ec983ab98a6284557879a385855041192580e", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/f80ec983ab98a6284557879a385855041192580e", "message": "FM2-209: Implement search for MedicationRequest Resource", "committedDate": "2020-06-08T11:39:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNjM4NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436636384", "bodyText": "@ibacher  Need some clarity especially on this case and this case   because I am still struggling to understand the two despite reading up from the documentation", "author": "reagan-meant", "createdAt": "2020-06-08T11:48:47Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/dao/impl/FhirMedicationRequestDaoImpl.java", "diffHunk": "@@ -9,14 +9,62 @@\n  */\n package org.openmrs.module.fhir2.api.dao.impl;\n \n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n import lombok.AccessLevel;\n import lombok.Setter;\n+import org.hibernate.Criteria;\n import org.openmrs.DrugOrder;\n+import org.openmrs.module.fhir2.FhirConstants;\n import org.openmrs.module.fhir2.api.dao.FhirMedicationRequestDao;\n+import org.openmrs.module.fhir2.api.search.param.SearchParameterMap;\n import org.springframework.stereotype.Component;\n \n @Component\n @Setter(AccessLevel.PACKAGE)\n public class FhirMedicationRequestDaoImpl extends BaseFhirDao<DrugOrder> implements FhirMedicationRequestDao {\n \t\n+\t@Override\n+\tprotected void setupSearchParams(Criteria criteria, SearchParameterMap theParams) {\n+\t\ttheParams.getParameters().forEach(entry -> {\n+\t\t\tswitch (entry.getKey()) {\n+\t\t\t\tcase FhirConstants.ENCOUNTER_REFERENCE_SEARCH_HANDLER:\n+\t\t\t\t\tentry.getValue().forEach(p -> handleEncounterReference(\"e\", (ReferenceAndListParam) p.getParam())\n+\t\t\t\t\t        .ifPresent(c -> criteria.createAlias(\"encounter\", \"e\").add(c)));\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.PATIENT_REFERENCE_SEARCH_HANDLER:\n+\t\t\t\t\tentry.getValue().forEach(patientReference -> handlePatientReference(criteria,\n+\t\t\t\t\t    (ReferenceAndListParam) patientReference.getParam(), \"person\"));\n+\t\t\t\t\tbreak;\n+\t\t\t\tcase FhirConstants.CODED_SEARCH_HANDLER:", "originalCommit": "f80ec983ab98a6284557879a385855041192580e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMjc5MQ==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436702791", "bodyText": "@reagan-meant They are intended to cover to slightly different types of cases. So the CODED_SEARCH_HANDLER should presumably be used where the code search parameter is provided and the MEDICATION_REFERENCE_SEARCH_HANDLER where a medication reference is provided. The difference between these is present because the medication requested can be represented either as a coded concept or as a reference to a Medication resource.\nSearches by code should look something like this: http://www.nlm.nih.gov/research/umls/rxnorm|206917 (this is the FHIR representation of the RxNORM code for concept 206917, which is an 800mg oral tablet of ibuprofen). Searches by medication, however, will be by a FHIR reference to the medication in question. That means they look like this: Medication/92035b29-ff19-44f2-a4cb-64beeb36b64d (this is the FHIR representation for a reference to the Medication\u2014OpenMRS Drug\u2014with a uuid of 92035b29-ff19-44f2-a4cb-64beeb36b64d; this could be the uuid of, say, an 800mg oral tablet of ibuprofen).\nThe query we want to generate for the former looks something like this:\nselect do.*\nfrom drug_order do\n    join drug d on do.drug_inventory_id = d.drug_id\n    join concept c on d.concept_id = c.concept_id\n    join concept_reference_map crm on c.concept_id = crm.concept_id\n    join concept_reference_term crt on crm.concept_reference_term_id = crt.concept_reference_term_id\n    join concept_source cs on crt.concept_source_id = cs.concept_source_id\n    join fhir_concept_source fcs on cs.concept_source_id = fcs.concept_source_id\nwhere fcs.url = 'http://www.nlm.nih.gov/research/umls/rxnorm' and crt.code = '206917'\nThe query we want to generate for the latter looks something like this:\nselect do.*\nfrom drug_order do\n    join drug d on do.drug_inventory_id = d.drug_id\nwhere d.uuid = '92035b29-ff19-44f2-a4cb-64beeb36b64d'\nDoes that clarify things a bit? Basically, we want to handle the code search parameter the way we handle other coded values, but the the medication search parameter the way we handle other reference values (like PARTICIPANT_REFERENCE_SEARCH_HANDLER)", "author": "ibacher", "createdAt": "2020-06-08T13:31:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNjM4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjc3Mzc1Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436773752", "bodyText": "Thanks alot @ibacher , This makes a whole lot of sense now. will have a better PR soon", "author": "reagan-meant", "createdAt": "2020-06-08T14:56:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzNjM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzA4Mg==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436703082", "bodyText": "Always have a newline at the end of a file", "author": "ibacher", "createdAt": "2020-06-08T13:31:48Z", "path": "api/src/main/java/org/openmrs/module/fhir2/api/impl/FhirMedicationRequestServiceImpl.java", "diffHunk": "@@ -12,22 +12,54 @@\n import lombok.AccessLevel;\n import lombok.Getter;\n import lombok.Setter;\n+\n+import java.util.Collection;\n+\n import org.hl7.fhir.r4.model.MedicationRequest;\n+import org.openmrs.DrugOrder;\n+import org.openmrs.module.fhir2.FhirConstants;\n import org.openmrs.module.fhir2.api.FhirMedicationRequestService;\n+import org.openmrs.module.fhir2.api.dao.FhirDao;\n import org.openmrs.module.fhir2.api.dao.FhirMedicationRequestDao;\n+import org.openmrs.module.fhir2.api.search.SearchQuery;\n+import org.openmrs.module.fhir2.api.search.param.SearchParameterMap;\n import org.openmrs.module.fhir2.api.translators.MedicationRequestTranslator;\n+import org.openmrs.module.fhir2.api.translators.OpenmrsFhirTranslator;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n+import ca.uhn.fhir.rest.api.server.IBundleProvider;\n+import ca.uhn.fhir.rest.param.ReferenceAndListParam;\n+import ca.uhn.fhir.rest.param.TokenAndListParam;\n+\n @Component\n @Setter(AccessLevel.PACKAGE)\n @Getter(AccessLevel.PROTECTED)\n-public class FhirMedicationRequestServiceImpl extends BaseFhirService<MedicationRequest, org.openmrs.DrugOrder> implements FhirMedicationRequestService {\n-\t\n+public class FhirMedicationRequestServiceImpl extends BaseFhirService<MedicationRequest, org.openmrs.DrugOrder>\n+\t\timplements FhirMedicationRequestService {\n+\n \t@Autowired\n \tprivate MedicationRequestTranslator translator;\n-\t\n+\n \t@Autowired\n \tprivate FhirMedicationRequestDao dao;\n+\n+\t@Autowired\n+\tprivate SearchQuery<DrugOrder, MedicationRequest, FhirMedicationRequestDao, MedicationRequestTranslator> searchQuery;\n+\n+\t@Override\n+\tpublic IBundleProvider searchForMedicationRequests(ReferenceAndListParam patientReference, ReferenceAndListParam encounterReference, TokenAndListParam code,\n+\t\t\tReferenceAndListParam participantReference, ReferenceAndListParam medicationReference) {\n+\n+\t\t\t\tSearchParameterMap theParams = new SearchParameterMap()\n+\t\t        .addParameter(FhirConstants.ENCOUNTER_REFERENCE_SEARCH_HANDLER, encounterReference)\n+\t\t        .addParameter(FhirConstants.PATIENT_REFERENCE_SEARCH_HANDLER, patientReference)\n+\t\t\t\t.addParameter(FhirConstants.CODED_SEARCH_HANDLER, code)\n+\t\t\t\t.addParameter(FhirConstants.PARTICIPANT_REFERENCE_SEARCH_HANDLER, participantReference)\n+\t\t\t\t.addParameter(FhirConstants.MEDICATION_REFERENCE_SEARCH_HANDLER, medicationReference);\n+\n+\t\treturn searchQuery.getQueryResults(theParams, dao, translator);\n+\t}\n+\n \t\n-}\n+}", "originalCommit": "f80ec983ab98a6284557879a385855041192580e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMzNDk3Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437334977", "bodyText": "Noted", "author": "reagan-meant", "createdAt": "2020-06-09T11:25:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzIyMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436703223", "bodyText": "Don't use * imports", "author": "ibacher", "createdAt": "2020-06-08T13:31:59Z", "path": "api/src/main/java/org/openmrs/module/fhir2/providers/r3/MedicationRequestFhirResourceProvider.java", "diffHunk": "@@ -11,17 +11,28 @@\n \n import javax.validation.constraints.NotNull;\n \n-import ca.uhn.fhir.rest.annotation.IdParam;\n-import ca.uhn.fhir.rest.annotation.Read;\n+import ca.uhn.fhir.rest.annotation.*;", "originalCommit": "f80ec983ab98a6284557879a385855041192580e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMzNDgwMw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437334803", "bodyText": "Oooh yes...though I have noticed a couple of other resources where its being use...may need some simple refactor in them", "author": "reagan-meant", "createdAt": "2020-06-09T11:24:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzIyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzg4NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r436703884", "bodyText": "This should initially be developed in the R4 ResourceProvider and then added to R3 afterwards.", "author": "ibacher", "createdAt": "2020-06-08T13:33:00Z", "path": "api/src/main/java/org/openmrs/module/fhir2/providers/r3/MedicationRequestFhirResourceProvider.java", "diffHunk": "@@ -49,4 +60,28 @@ public MedicationRequest getMedicationRequestById(@IdParam @NotNull IdType id) {\n \t\t\n \t\treturn MedicationRequest30_40.convertMedicationRequest(medicationRequest);\n \t}\n+\n+\t@Search", "originalCommit": "f80ec983ab98a6284557879a385855041192580e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzMzMzcwOA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437333708", "bodyText": "Do you mean I shouldnt write code in the R3 providers? Because I have tried implementing it in both", "author": "reagan-meant", "createdAt": "2020-06-09T11:22:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzg4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ0NzA0NA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437447044", "bodyText": "No, I just don't see the R4 provider as part of this PR? At the end of the day, it's best if we have both.", "author": "ibacher", "createdAt": "2020-06-09T14:02:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcwMzg4NA=="}], "type": "inlineReview"}, {"oid": "4e8b604465c83c40da25a96241365dc874cf165a", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/4e8b604465c83c40da25a96241365dc874cf165a", "message": " FM2-209: Implement search for MedicationRequest Resource", "committedDate": "2020-06-09T11:18:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1NjY5MA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437456690", "bodyText": "@ibacher do you mean this for r4 ?", "author": "reagan-meant", "createdAt": "2020-06-09T14:15:08Z", "path": "api/src/main/java/org/openmrs/module/fhir2/providers/r4/MedicationRequestFhirResourceProvider.java", "diffHunk": "@@ -48,4 +57,29 @@ public MedicationRequest getMedicationRequestByUuid(@IdParam @NotNull IdType id)\n \t\treturn medicationRequest;\n \t}\n \t\n+\t\n+\t@Search\n+\t@SuppressWarnings(\"unused\")\n+\tpublic IBundleProvider searchForMedicationRequests(", "originalCommit": "4e8b604465c83c40da25a96241365dc874cf165a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ3NTcyNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437475727", "bodyText": "Yep!", "author": "ibacher", "createdAt": "2020-06-09T14:39:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1NjY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU0MTc4Nw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437541787", "bodyText": "@ibacher does it satisfy the requirements?", "author": "reagan-meant", "createdAt": "2020-06-09T15:56:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1NjY5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODExODE4Ng==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r438118186", "bodyText": "It looks right to me", "author": "ibacher", "createdAt": "2020-06-10T13:24:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ1NjY5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4ODg0OA==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437488848", "bodyText": "@reagan-meant  Can we have a get() method which just gets the resources once instead of querying the database repeatedly? Please use this comment throughout the PR.", "author": "varung-31", "createdAt": "2020-06-09T14:56:06Z", "path": "api/src/test/java/org/openmrs/module/fhir2/providers/r4/MedicationRequestFhirResourceProviderTest.java", "diffHunk": "@@ -73,4 +89,97 @@ public void getMedicationRequestByUuid_shouldThrowResourceNotFoundException() {\n \t\tMedicationRequest medicationRequest = resourceProvider.getMedicationRequestByUuid(id);\n \t\tassertThat(medicationRequest, nullValue());\n \t}\n+\n+\t\n+\t@Test\n+\tpublic void searchMedicationRequest_shouldReturnMatchingMedicationRequestUsingCode() {\n+\t\n+\t\twhen(fhirMedicationRequestService.searchForMedicationRequests(any(), any(), any(), any(), any()))\n+\t\t\t\t.thenReturn(new BaseFhirIBundleResourceProviderTest<>(Collections.singletonList(medicationRequest), 10, 1));\n+\t\t\n+\t\tTokenAndListParam code = new TokenAndListParam();\n+\t\tTokenParam codingToken = new TokenParam();\n+\t\tcodingToken.setValue(\"1000\");\n+\t\tcode.addAnd(codingToken);\n+\t\t\n+\t\tIBundleProvider results = resourceProvider.searchForMedicationRequests(null, null, null, code, null, null);\n+\t\tassertThat(results, notNullValue());\n+\t\tassertThat(results.getResources(1, 5), hasSize(equalTo(1)));\n+\t\tassertThat(results.getResources(1, 5).get(0), notNullValue());", "originalCommit": "4e8b604465c83c40da25a96241365dc874cf165a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzU0MjgzNw==", "url": "https://github.com/openmrs/openmrs-module-fhir2/pull/197#discussion_r437542837", "bodyText": "Let me do so @varung-31", "author": "reagan-meant", "createdAt": "2020-06-09T15:57:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQ4ODg0OA=="}], "type": "inlineReview"}, {"oid": "6795213811d0c7fdb282a12fffda9ac779c55560", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/6795213811d0c7fdb282a12fffda9ac779c55560", "message": "FM2-209: Implement search for MedicationRequest Resource", "committedDate": "2020-06-10T12:16:12Z", "type": "commit"}, {"oid": "667ee1107bac3b09eee6d0c09bb5cbb528725f40", "url": "https://github.com/openmrs/openmrs-module-fhir2/commit/667ee1107bac3b09eee6d0c09bb5cbb528725f40", "message": " FM2-209: Implement search for MedicationRequest Resource", "committedDate": "2020-06-12T09:24:13Z", "type": "commit"}]}