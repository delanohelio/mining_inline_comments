{"pr_number": 2090, "pr_title": "Add job serializer IMDG Map, Cache & Observable tests", "pr_createdAt": "2020-03-24T10:05:18Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2090", "timeline": [{"oid": "14d9cbafd1ec82b1df05f289eff5fb4a337c8975", "url": "https://github.com/hazelcast/hazelcast-jet/commit/14d9cbafd1ec82b1df05f289eff5fb4a337c8975", "message": "Add job serializer supporting IMDG Map, Cache & Observable tests", "committedDate": "2020-03-24T10:02:50Z", "type": "commit"}, {"oid": "4701651bf04c658d3e6c48125a42e7780f610079", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4701651bf04c658d3e6c48125a42e7780f610079", "message": "Add job serializer supporting IMDG Map, Cache & Observable tests", "committedDate": "2020-03-24T10:06:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE0MDQxNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2090#discussion_r397140415", "bodyText": "This should be two tests. Or you can do map reading and writing in one pipeline, I think that's fine.", "author": "viliam-durina", "createdAt": "2020-03-24T13:12:50Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/core/JobSerializerTest.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.core;\n+\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.config.SerializerConfig;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.SimpleTestInClusterSupport;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+import com.hazelcast.jet.pipeline.Sources;\n+import com.hazelcast.jet.pipeline.test.TestSources;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.StreamSerializer;\n+import com.hazelcast.test.HazelcastSerialClassRunner;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.io.IOException;\n+import java.util.AbstractMap.SimpleEntry;\n+import java.util.Map.Entry;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.hazelcast.jet.core.JobStatus.COMPLETED;\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(HazelcastSerialClassRunner.class)\n+public class JobSerializerTest extends SimpleTestInClusterSupport {\n+\n+    private static final String MAP_NAME = \"map\";\n+    private static final String CACHE_NAME = \"cache\";\n+    private static final String OBSERVABLE_NAME = \"observable\";\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        JetConfig config = new JetConfig();\n+        config.getHazelcastConfig()\n+              .addCacheConfig(new CacheSimpleConfig().setName(CACHE_NAME))\n+              .getSerializationConfig()\n+              .addSerializerConfig(new SerializerConfig().setTypeClass(Value.class).setClass(ValueSerializer.class));\n+        initializeWithClient(1, config, null);\n+    }\n+\n+    @Test\n+    public void when_serializerIsRegistered_then_itIsAvailableForLocalMapSourceAndSink() {", "originalCommit": "4701651bf04c658d3e6c48125a42e7780f610079", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE0MDY3MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2090#discussion_r397140671", "bodyText": "Easier might be to do newJob(...).join().", "author": "viliam-durina", "createdAt": "2020-03-24T13:13:13Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/core/JobSerializerTest.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.core;\n+\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.config.SerializerConfig;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.SimpleTestInClusterSupport;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+import com.hazelcast.jet.pipeline.Sources;\n+import com.hazelcast.jet.pipeline.test.TestSources;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.StreamSerializer;\n+import com.hazelcast.test.HazelcastSerialClassRunner;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.io.IOException;\n+import java.util.AbstractMap.SimpleEntry;\n+import java.util.Map.Entry;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.hazelcast.jet.core.JobStatus.COMPLETED;\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(HazelcastSerialClassRunner.class)\n+public class JobSerializerTest extends SimpleTestInClusterSupport {\n+\n+    private static final String MAP_NAME = \"map\";\n+    private static final String CACHE_NAME = \"cache\";\n+    private static final String OBSERVABLE_NAME = \"observable\";\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        JetConfig config = new JetConfig();\n+        config.getHazelcastConfig()\n+              .addCacheConfig(new CacheSimpleConfig().setName(CACHE_NAME))\n+              .getSerializationConfig()\n+              .addSerializerConfig(new SerializerConfig().setTypeClass(Value.class).setClass(ValueSerializer.class));\n+        initializeWithClient(1, config, null);\n+    }\n+\n+    @Test\n+    public void when_serializerIsRegistered_then_itIsAvailableForLocalMapSourceAndSink() {\n+        // Given\n+        Pipeline sinkPipeline = Pipeline.create();\n+        sinkPipeline.readFrom(TestSources.items(13))\n+                    .map(i -> new SimpleEntry<>(i, new Value(i)))\n+                    .writeTo(Sinks.map(MAP_NAME));\n+\n+        // When\n+        // Then\n+        assertJobStatusEventually(instance().newJob(sinkPipeline, jobConfig()), COMPLETED);", "originalCommit": "4701651bf04c658d3e6c48125a42e7780f610079", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE0MjE5Mg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2090#discussion_r397142192", "bodyText": "count() is simpler than reduce().", "author": "viliam-durina", "createdAt": "2020-03-24T13:15:45Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/core/JobSerializerTest.java", "diffHunk": "@@ -0,0 +1,161 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.core;\n+\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.config.SerializerConfig;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.SimpleTestInClusterSupport;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+import com.hazelcast.jet.pipeline.Sources;\n+import com.hazelcast.jet.pipeline.test.TestSources;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.StreamSerializer;\n+import com.hazelcast.test.HazelcastSerialClassRunner;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+\n+import java.io.IOException;\n+import java.util.AbstractMap.SimpleEntry;\n+import java.util.Map.Entry;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import static com.hazelcast.jet.core.JobStatus.COMPLETED;\n+import static org.junit.Assert.assertEquals;\n+\n+@RunWith(HazelcastSerialClassRunner.class)\n+public class JobSerializerTest extends SimpleTestInClusterSupport {\n+\n+    private static final String MAP_NAME = \"map\";\n+    private static final String CACHE_NAME = \"cache\";\n+    private static final String OBSERVABLE_NAME = \"observable\";\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        JetConfig config = new JetConfig();\n+        config.getHazelcastConfig()\n+              .addCacheConfig(new CacheSimpleConfig().setName(CACHE_NAME))\n+              .getSerializationConfig()\n+              .addSerializerConfig(new SerializerConfig().setTypeClass(Value.class).setClass(ValueSerializer.class));\n+        initializeWithClient(1, config, null);\n+    }\n+\n+    @Test\n+    public void when_serializerIsRegistered_then_itIsAvailableForLocalMapSourceAndSink() {\n+        // Given\n+        Pipeline sinkPipeline = Pipeline.create();\n+        sinkPipeline.readFrom(TestSources.items(13))\n+                    .map(i -> new SimpleEntry<>(i, new Value(i)))\n+                    .writeTo(Sinks.map(MAP_NAME));\n+\n+        // When\n+        // Then\n+        assertJobStatusEventually(instance().newJob(sinkPipeline, jobConfig()), COMPLETED);\n+\n+        // Given\n+        Pipeline sourcePipeline = Pipeline.create();\n+        sourcePipeline.readFrom(Sources.<Integer, Value>map(MAP_NAME))\n+                      .map(Entry::getValue)\n+                      .writeTo(Sinks.logger());\n+\n+        // When\n+        // Then\n+        assertJobStatusEventually(instance().newJob(sourcePipeline, jobConfig()), COMPLETED);\n+    }\n+\n+    @Test\n+    public void when_serializerIsRegistered_then_itIsAvailableForLocalCacheSourceAndSink() {\n+        // Given\n+        Pipeline sinkPipeline = Pipeline.create();\n+        sinkPipeline.readFrom(TestSources.items(13))\n+                    .map(i -> new SimpleEntry<>(i, new Value(i)))\n+                    .writeTo(Sinks.cache(CACHE_NAME));\n+\n+        // When\n+        // Then\n+        assertJobStatusEventually(instance().newJob(sinkPipeline, jobConfig()), COMPLETED);\n+\n+        // Given\n+        Pipeline sourcePipeline = Pipeline.create();\n+        sourcePipeline.readFrom(Sources.<Integer, Value>cache(CACHE_NAME))\n+                      .map(Entry::getValue)\n+                      .writeTo(Sinks.logger());\n+\n+        // When\n+        // Then\n+        assertJobStatusEventually(instance().newJob(sourcePipeline, jobConfig()), COMPLETED);\n+    }\n+\n+    @Test\n+    public void when_serializerIsRegistered_then_itIsAvailableForLocalObservableSink() throws Exception {\n+        // Given\n+        Pipeline pipeline = Pipeline.create();\n+        pipeline.readFrom(TestSources.items(1, 2))\n+                .map(Value::new)\n+                .writeTo(Sinks.observable(OBSERVABLE_NAME));\n+\n+        // When\n+        Observable<Value> observable = instance().getObservable(OBSERVABLE_NAME);\n+        CompletableFuture<Integer> summer = observable\n+                .toFuture(values -> values.map(Value::value).reduce(0, Integer::sum));", "originalCommit": "4701651bf04c658d3e6c48125a42e7780f610079", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7a9c5dd199b79783874164fcb57dd50aef6b2bcf", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7a9c5dd199b79783874164fcb57dd50aef6b2bcf", "message": "Refactor tests", "committedDate": "2020-03-24T13:53:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIzNDc5Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2090#discussion_r397234793", "bodyText": "We should not register the serializer for the cluster: the test is supposed to test that even if it's not set for the cluster, it works if it's set for the job.", "author": "viliam-durina", "createdAt": "2020-03-24T15:18:22Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/core/JobSerializerTest.java", "diffHunk": "@@ -0,0 +1,207 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.core;\n+\n+import com.hazelcast.cache.ICache;\n+import com.hazelcast.config.CacheSimpleConfig;\n+import com.hazelcast.config.SerializerConfig;\n+import com.hazelcast.jet.Observable;\n+import com.hazelcast.jet.SimpleTestInClusterSupport;\n+import com.hazelcast.jet.config.JetConfig;\n+import com.hazelcast.jet.config.JobConfig;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.Sinks;\n+import com.hazelcast.jet.pipeline.Sources;\n+import com.hazelcast.jet.pipeline.test.AssertionSinks;\n+import com.hazelcast.jet.pipeline.test.TestSources;\n+import com.hazelcast.map.IMap;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.StreamSerializer;\n+import com.hazelcast.test.HazelcastSerialClassRunner;\n+import org.junit.BeforeClass;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.testcontainers.shaded.com.google.common.collect.ImmutableMap;\n+import org.testcontainers.shaded.com.google.common.collect.ImmutableSet;\n+\n+import javax.cache.Cache;\n+import java.io.IOException;\n+import java.util.AbstractMap.SimpleEntry;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.TimeUnit;\n+\n+import static java.util.Arrays.asList;\n+import static org.hamcrest.Matchers.containsInAnyOrder;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertThat;\n+\n+@RunWith(HazelcastSerialClassRunner.class)\n+public class JobSerializerTest extends SimpleTestInClusterSupport {\n+\n+    private static final String SOURCE_MAP_NAME = \"source-map\";\n+    private static final String SINK_MAP_NAME = \"sink-map\";\n+    private static final String SOURCE_CACHE_NAME = \"source-cache\";\n+    private static final String SINK_CACHE_NAME = \"sink-cache\";\n+    private static final String OBSERVABLE_NAME = \"observable\";\n+\n+    @BeforeClass\n+    public static void beforeClass() {\n+        JetConfig config = new JetConfig();\n+        config.getHazelcastConfig()\n+              .addCacheConfig(new CacheSimpleConfig().setName(SOURCE_CACHE_NAME))\n+              .addCacheConfig(new CacheSimpleConfig().setName(SINK_CACHE_NAME))\n+              .getSerializationConfig()\n+              .addSerializerConfig(new SerializerConfig().setTypeClass(Value.class).setClass(ValueSerializer.class));", "originalCommit": "7a9c5dd199b79783874164fcb57dd50aef6b2bcf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f8a77b3d3ff4f1f75ce365694353c1557d9933f9", "url": "https://github.com/hazelcast/hazelcast-jet/commit/f8a77b3d3ff4f1f75ce365694353c1557d9933f9", "message": "Configure serializer on client instead of member", "committedDate": "2020-03-24T15:39:33Z", "type": "commit"}, {"oid": "b1f2ef2477c1ae16ec7ded7246317e7b26c834cd", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b1f2ef2477c1ae16ec7ded7246317e7b26c834cd", "message": "Add job serializers map/cache negative scenarios", "committedDate": "2020-03-24T19:37:33Z", "type": "commit"}]}