{"pr_number": 2149, "pr_title": "[008] Add Stage Rebalancing", "pr_createdAt": "2020-04-07T12:45:51Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2149", "timeline": [{"oid": "209f7c5f7fd97966fe9ce19c1c2114a1377d4b3c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/209f7c5f7fd97966fe9ce19c1c2114a1377d4b3c", "message": "Add tests (incomplete)", "committedDate": "2020-04-09T07:23:24Z", "type": "forcePushed"}, {"oid": "9fa712039509532e3a5461233dd9aef5af27845a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9fa712039509532e3a5461233dd9aef5af27845a", "message": "Simplify mapUsingServiceAsync", "committedDate": "2020-04-10T17:06:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA3MTQzNw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r408071437", "bodyText": "when_writeToMultipleStagesToSingleSink_then_allItemsShouldBeOnSink (to conform to convention)?", "author": "gierlachg", "createdAt": "2020-04-14T11:43:23Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/SinksTest.java", "diffHunk": "@@ -117,7 +117,7 @@ public void when_setLocalParallelism_then_sinkHasIt() {\n     }\n \n     @Test\n-    public void whenDrainToMultipleStagesToSingleSink_thenAllItemsShouldBeOnSink() {\n+    public void whenWriteToMultipleStagesToSingleSink_thenAllItemsShouldBeOnSink() {", "originalCommit": "db7b55a622c89b1d74dc17c60ee83255231c5e74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA3Mzk0MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r408073940", "bodyText": "Does it make sense to add RebalanceStreamStageTest? If not, maybe rename to simply RebalanceStageTest?", "author": "gierlachg", "createdAt": "2020-04-14T11:48:06Z", "path": "hazelcast-jet-core/src/test/java/com/hazelcast/jet/pipeline/RebalanceBatchStageTest.java", "diffHunk": "@@ -0,0 +1,334 @@\n+package com.hazelcast.jet.pipeline;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.accumulator.LongAccumulator;\n+import com.hazelcast.jet.aggregate.AggregateOperation1;\n+import com.hazelcast.jet.aggregate.AggregateOperations;\n+import com.hazelcast.jet.core.DAG;\n+import com.hazelcast.jet.core.Edge;\n+import com.hazelcast.jet.datamodel.Tuple2;\n+import com.hazelcast.jet.datamodel.Tuple3;\n+import com.hazelcast.jet.pipeline.test.AssertionSinks;\n+import org.junit.Test;\n+\n+import javax.annotation.Nonnull;\n+import java.util.ArrayList;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Map.Entry;\n+import java.util.stream.IntStream;\n+import java.util.stream.Stream;\n+\n+import static com.hazelcast.jet.core.test.JetAssert.assertFalse;\n+import static com.hazelcast.jet.datamodel.Tuple2.tuple2;\n+import static com.hazelcast.jet.datamodel.Tuple3.tuple3;\n+import static com.hazelcast.jet.pipeline.BatchAggregateTest.FORMAT_FN;\n+import static com.hazelcast.jet.pipeline.BatchAggregateTest.FORMAT_FN_2;\n+import static com.hazelcast.jet.pipeline.BatchAggregateTest.FORMAT_FN_3;\n+import static com.hazelcast.jet.pipeline.test.AssertionSinks.assertAnyOrder;\n+import static java.util.Collections.singletonList;\n+import static java.util.Spliterators.spliteratorUnknownSize;\n+import static java.util.function.Function.identity;\n+import static java.util.stream.Collectors.groupingBy;\n+import static java.util.stream.Collectors.summingLong;\n+import static java.util.stream.Collectors.toList;\n+import static java.util.stream.StreamSupport.stream;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertNull;\n+import static org.junit.Assert.assertTrue;\n+\n+public class RebalanceBatchStageTest extends PipelineTestSupport {", "originalCommit": "db7b55a622c89b1d74dc17c60ee83255231c5e74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODA3OTg2OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r408079869", "bodyText": "Maybe computeIfAbsent would be better here as it leaves the map unmodified (so for instance one could print existing one for debugging purposes)?", "author": "gierlachg", "createdAt": "2020-04-14T11:59:07Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/pipeline/PipelineImpl.java", "diffHunk": "@@ -160,12 +206,8 @@ void makeNamesUnique() {\n         }\n     }\n \n-    public void attachFiles(@Nonnull Map<String, File> filesToAttach) {\n-        this.attachedFiles.putAll(filesToAttach);\n-    }\n-\n-    @Nonnull\n-    public Map<String, File> attachedFiles() {\n-        return Collections.unmodifiableMap(attachedFiles);\n+    private void register(Transform stage) {\n+        List<Transform> prev = adjacencyMap.put(stage, new ArrayList<>());", "originalCommit": "db7b55a622c89b1d74dc17c60ee83255231c5e74", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6f0d1d020a38b718b311dff61dfc33ca5e690566", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6f0d1d020a38b718b311dff61dfc33ca5e690566", "message": "Add stage.rebalance()", "committedDate": "2020-04-14T14:59:02Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM3NzcxMA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r409377710", "bodyText": "shouldn't it be @Nullable then?", "author": "cangencer", "createdAt": "2020-04-16T08:32:11Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/core/DAG.java", "diffHunk": "@@ -220,18 +220,17 @@ public DAG edge(@Nonnull Edge edge) {\n     }\n \n     /**\n-     * Returns the vertex with the given name.\n+     * Returns the vertex with the given name, or {@code null} if there is no\n+     * vertex with that name.\n      */\n-    @Nonnull\n     public Vertex getVertex(@Nonnull String vertexName) {", "originalCommit": "a0c77f2fc8cfe667f6077b5cf92b7627b3f36670", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM4MjA1Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r409382056", "bodyText": "missing @Nonnull and @since tags", "author": "cangencer", "createdAt": "2020-04-16T08:39:02Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/GeneralStage.java", "diffHunk": "@@ -846,6 +850,12 @@\n     @Nonnull\n     <K> GeneralStageWithKey<T, K> groupingKey(@Nonnull FunctionEx<? super T, ? extends K> keyFn);\n \n+    @Nonnull\n+    <K> GeneralStage<T> rebalance(FunctionEx<? super T, ? extends K> keyFn);", "originalCommit": "a0c77f2fc8cfe667f6077b5cf92b7627b3f36670", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM4MjMxNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r409382315", "bodyText": "missing @since tag", "author": "cangencer", "createdAt": "2020-04-16T08:39:26Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/GeneralStage.java", "diffHunk": "@@ -846,6 +850,12 @@\n     @Nonnull\n     <K> GeneralStageWithKey<T, K> groupingKey(@Nonnull FunctionEx<? super T, ? extends K> keyFn);\n \n+    @Nonnull\n+    <K> GeneralStage<T> rebalance(FunctionEx<? super T, ? extends K> keyFn);\n+\n+    @Nonnull\n+    GeneralStage<T> rebalance();", "originalCommit": "a0c77f2fc8cfe667f6077b5cf92b7627b3f36670", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d2fabb65e52c205eb6ec92b7d46087fd0cc55f17", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d2fabb65e52c205eb6ec92b7d46087fd0cc55f17", "message": "Javadoc for stage.rebalance()", "committedDate": "2020-04-16T14:12:00Z", "type": "forcePushed"}, {"oid": "c6fa692e23b9e355a84abe7273c61f4e0b2bd7e6", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c6fa692e23b9e355a84abe7273c61f4e0b2bd7e6", "message": "Deprecate old methods that do repartitioning", "committedDate": "2020-04-20T13:59:50Z", "type": "forcePushed"}, {"oid": "d10b2c3f1ad56a20e9b352dc0ecacbca9bf5a4ae", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d10b2c3f1ad56a20e9b352dc0ecacbca9bf5a4ae", "message": "Clean up existing code", "committedDate": "2020-04-21T15:15:14Z", "type": "forcePushed"}, {"oid": "064316f1b34e0fd1f90f318aa1ac8a67a6d37fc7", "url": "https://github.com/hazelcast/hazelcast-jet/commit/064316f1b34e0fd1f90f318aa1ac8a67a6d37fc7", "message": "Improve existing code", "committedDate": "2020-04-27T14:18:49Z", "type": "commit"}, {"oid": "456bd82770ce11dc244a2d95e04a46d251796b97", "url": "https://github.com/hazelcast/hazelcast-jet/commit/456bd82770ce11dc244a2d95e04a46d251796b97", "message": "Add stage.rebalance()", "committedDate": "2020-04-27T14:18:49Z", "type": "commit"}, {"oid": "7210c281e65764e6a1cb01d4e1b85f15f348f032", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7210c281e65764e6a1cb01d4e1b85f15f348f032", "message": "Deprecate old methods that do repartitioning", "committedDate": "2020-04-27T14:18:49Z", "type": "commit"}, {"oid": "6fd731d28be66e32eff5d7d6c42300a731552c22", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6fd731d28be66e32eff5d7d6c42300a731552c22", "message": "Update the TDD to reflect later decisions", "committedDate": "2020-04-27T14:18:50Z", "type": "commit"}, {"oid": "9b1549c13229ba6b3099ff6f2edff3e1a9868603", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9b1549c13229ba6b3099ff6f2edff3e1a9868603", "message": "Work around JDK 8 compiler bugs", "committedDate": "2020-04-27T14:18:50Z", "type": "commit"}, {"oid": "9429c68fb0397176a594c16665f066a699065972", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9429c68fb0397176a594c16665f066a699065972", "message": "Update NPM due to vulnerabilities", "committedDate": "2020-04-27T14:18:50Z", "type": "commit"}, {"oid": "d03fc5066e6648409ee60e41ef6d8a5d2a3106b7", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d03fc5066e6648409ee60e41ef6d8a5d2a3106b7", "message": "Add to website docs", "committedDate": "2020-04-27T14:18:50Z", "type": "commit"}, {"oid": "17a3f8963ff16e7d31d7577b4940b2a584b493a7", "url": "https://github.com/hazelcast/hazelcast-jet/commit/17a3f8963ff16e7d31d7577b4940b2a584b493a7", "message": "Tweaks", "committedDate": "2020-04-27T14:18:51Z", "type": "commit"}, {"oid": "754b2da4609fdd0ca6ce36270968789ded524881", "url": "https://github.com/hazelcast/hazelcast-jet/commit/754b2da4609fdd0ca6ce36270968789ded524881", "message": "Improve rebalance Javadoc", "committedDate": "2020-04-27T14:18:51Z", "type": "commit"}, {"oid": "754b2da4609fdd0ca6ce36270968789ded524881", "url": "https://github.com/hazelcast/hazelcast-jet/commit/754b2da4609fdd0ca6ce36270968789ded524881", "message": "Improve rebalance Javadoc", "committedDate": "2020-04-27T14:18:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5MTY0Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r417091643", "bodyText": "Rename to setPartitionKeyFnForInput to match public FunctionEx<?, ?> partitionKeyFnForInput(int ordinal)", "author": "frant-hartm", "createdAt": "2020-04-29T06:27:34Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/pipeline/transform/AbstractTransform.java", "diffHunk": "@@ -69,9 +77,24 @@ public int localParallelism() {\n         return localParallelism;\n     }\n \n-    @Nonnull\n-    Optimization getOptimization() {\n-        return optimization;\n+    @Override\n+    public void setRebalanceInput(int ordinal, boolean value) {\n+        upstreamRebalancingFlags[ordinal] = value;\n+    }\n+\n+    @Override\n+    public void setRebalanceKeyForInput(int ordinal, FunctionEx<?, ?> keyFn) {\n+        upstreamPartitionKeyFns[ordinal] = keyFn;\n+    }", "originalCommit": "754b2da4609fdd0ca6ce36270968789ded524881", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NzIxOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r417097218", "bodyText": "Shouldn't these have @since tags because this is public API?", "author": "frant-hartm", "createdAt": "2020-04-29T06:42:49Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/GeneralStage.java", "diffHunk": "@@ -941,6 +943,127 @@\n     @Nonnull\n     <K> GeneralStageWithKey<T, K> groupingKey(@Nonnull FunctionEx<? super T, ? extends K> keyFn);\n \n+    /**\n+     * Returns a new stage that applies data rebalancing to the output of this\n+     * stage. By default, Jet prefers to process the data locally, on the\n+     * cluster member where it was originally received. This is generally a\n+     * good option because it eliminates unneeded network traffic. However, if\n+     * the data volume is highly skewed across members, for example when using\n+     * a non-distributed data source, you can tell Jet to rebalance the data by\n+     * sending some to the other members.\n+     * <p>\n+     * To implement rebalancing, Jet uses a <em>distributed unicast</em> data\n+     * routing pattern on the DAG edge from this stage's vertex to the next one.\n+     * It routes the data in a round-robin fashion, sending each item to the\n+     * next member (member list includes the local one as well). If a given\n+     * member's queue is overloaded and applying backpressure, it skips it and\n+     * retries in the next round. With this scheme you get perfectly balanced\n+     * item counts on each member under light load, but under heavier load it\n+     * favors throughput: if the network becomes a bottleneck, most data may\n+     * stay local.\n+     * <p>\n+     * These are some basic invariants:\n+     * <ol><li>\n+     *     The rebalancing stage does not transform data, it just changes the\n+     *     physical layout of computation.\n+     * </li><li>\n+     *     If rebalancing is inapplicable due to the nature of the downstream\n+     *     stage (for example, a non-parallelizable operation like stateful\n+     *     mapping), the rebalancing stage is removed from the execution plan.\n+     * </li><li>\n+     *     If the downstream stage already does rebalancing for correctness (e.g.,\n+     *     grouping by key implies partitioning by that key), this rebalancing\n+     *     stage is optimized away.\n+     * </li></ol>\n+     * Aggregation is a special case because it is implemented with two\n+     * vertices at the Core DAG level. The first vertex accumulates local\n+     * partial results and the second one combines them globally. There are two\n+     * cases:\n+     * <ol><li>\n+     *     {@code stage.rebalance().groupingKey(keyFn).aggregate(...)}: here Jet\n+     *     removes the first (local) aggregation vertex and goes straight to\n+     *     distributed aggregation without combining. The data is rebalanced\n+     *     through partitioning.\n+     * </li><li>\n+     *     {@code stage.rebalance().aggregate(...)}: in this case the second vertex\n+     *     is non-parallelizable and must execute on a single member. Therefore Jet\n+     *     keeps both vertices and applies rebalancing before the first one.\n+     * </li></ol>\n+     *\n+     * @return a new stage using the same transform as this one, only with a\n+     *         rebalancing flag raised that will affect data routing into the next\n+     *         stage.\n+     * @since 4.2\n+     */\n+    @Nonnull\n+    GeneralStage<T> rebalance();", "originalCommit": "754b2da4609fdd0ca6ce36270968789ded524881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEzMzgwOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r417133808", "bodyText": "I see a @since tag three lines above your comment :)", "author": "mtopolnik", "createdAt": "2020-04-29T08:00:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NzIxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NzQ1NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r417097454", "bodyText": "Is this visible on the DAG we print to the log?", "author": "frant-hartm", "createdAt": "2020-04-29T06:43:26Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/pipeline/GeneralStage.java", "diffHunk": "@@ -941,6 +943,127 @@\n     @Nonnull\n     <K> GeneralStageWithKey<T, K> groupingKey(@Nonnull FunctionEx<? super T, ? extends K> keyFn);\n \n+    /**\n+     * Returns a new stage that applies data rebalancing to the output of this\n+     * stage. By default, Jet prefers to process the data locally, on the\n+     * cluster member where it was originally received. This is generally a\n+     * good option because it eliminates unneeded network traffic. However, if\n+     * the data volume is highly skewed across members, for example when using\n+     * a non-distributed data source, you can tell Jet to rebalance the data by\n+     * sending some to the other members.\n+     * <p>\n+     * To implement rebalancing, Jet uses a <em>distributed unicast</em> data\n+     * routing pattern on the DAG edge from this stage's vertex to the next one.\n+     * It routes the data in a round-robin fashion, sending each item to the\n+     * next member (member list includes the local one as well). If a given\n+     * member's queue is overloaded and applying backpressure, it skips it and\n+     * retries in the next round. With this scheme you get perfectly balanced\n+     * item counts on each member under light load, but under heavier load it\n+     * favors throughput: if the network becomes a bottleneck, most data may\n+     * stay local.\n+     * <p>\n+     * These are some basic invariants:\n+     * <ol><li>\n+     *     The rebalancing stage does not transform data, it just changes the\n+     *     physical layout of computation.\n+     * </li><li>\n+     *     If rebalancing is inapplicable due to the nature of the downstream\n+     *     stage (for example, a non-parallelizable operation like stateful\n+     *     mapping), the rebalancing stage is removed from the execution plan.\n+     * </li><li>\n+     *     If the downstream stage already does rebalancing for correctness (e.g.,\n+     *     grouping by key implies partitioning by that key), this rebalancing\n+     *     stage is optimized away.", "originalCommit": "754b2da4609fdd0ca6ce36270968789ded524881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEzNDM0OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2149#discussion_r417134349", "bodyText": "The effects of rebalancing are visible in the DAG, but never as a \"rebalancing vertex\". It just changes the DAG", "author": "mtopolnik", "createdAt": "2020-04-29T08:01:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA5NzQ1NA=="}], "type": "inlineReview"}, {"oid": "ce3b7d162fe4be4f922aba3a6bba157defe144ae", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ce3b7d162fe4be4f922aba3a6bba157defe144ae", "message": "Address review", "committedDate": "2020-04-29T13:52:04Z", "type": "commit"}]}