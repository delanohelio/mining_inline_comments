{"pr_number": 2248, "pr_title": "[005] - Fix problems in productionalized CDC code", "pr_createdAt": "2020-05-12T12:11:03Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2248", "timeline": [{"oid": "60c326b25c9a7e1bc56a4ac7c317287653a7218a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/60c326b25c9a7e1bc56a4ac7c317287653a7218a", "message": "Set Jet version for website replacement script", "committedDate": "2020-05-12T06:30:15Z", "type": "commit"}, {"oid": "4edb48ed6e9d387a08aa24246580e4ce39c88547", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4edb48ed6e9d387a08aa24246580e4ce39c88547", "message": "Change type of serialization used", "committedDate": "2020-05-12T06:40:30Z", "type": "commit"}, {"oid": "a53fbbfaaa376eaae975cbc12064e7cdf4d26e7f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a53fbbfaaa376eaae975cbc12064e7cdf4d26e7f", "message": "Use JSON convenience instead of Jackson jr", "committedDate": "2020-05-12T10:08:13Z", "type": "commit"}, {"oid": "73bd41ca81629a4ce2c59acdd9a557aa8e1b49e9", "url": "https://github.com/hazelcast/hazelcast-jet/commit/73bd41ca81629a4ce2c59acdd9a557aa8e1b49e9", "message": "Fix jar assembly", "committedDate": "2020-05-12T10:08:43Z", "type": "commit"}, {"oid": "2e5db9ffd16579bfd386113e97f85c706a266132", "url": "https://github.com/hazelcast/hazelcast-jet/commit/2e5db9ffd16579bfd386113e97f85c706a266132", "message": "Remove redundant cast", "committedDate": "2020-05-12T11:24:18Z", "type": "commit"}, {"oid": "3d0a87e2beb2efa4299bf0fb3bc6c44e039a3956", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3d0a87e2beb2efa4299bf0fb3bc6c44e039a3956", "message": "Fix some website content", "committedDate": "2020-05-13T11:47:48Z", "type": "commit"}, {"oid": "fe83154cda3fbf649a35994a18c295ed92b89a71", "url": "https://github.com/hazelcast/hazelcast-jet/commit/fe83154cda3fbf649a35994a18c295ed92b89a71", "message": "Re-implement CDC specific map sinks", "committedDate": "2020-05-14T11:24:03Z", "type": "commit"}, {"oid": "413937b2cb6b7317e5c84509fce6c631d61927cf", "url": "https://github.com/hazelcast/hazelcast-jet/commit/413937b2cb6b7317e5c84509fce6c631d61927cf", "message": "Make jackson annotations part of the main CDC jar", "committedDate": "2020-05-14T11:57:38Z", "type": "commit"}, {"oid": "16ad3b0872c4b895e546b27645847a70e402d886", "url": "https://github.com/hazelcast/hazelcast-jet/commit/16ad3b0872c4b895e546b27645847a70e402d886", "message": "Adjust tutorial to latest changes", "committedDate": "2020-05-14T12:05:45Z", "type": "commit"}, {"oid": "a59106887703490494daac5408771f3c49d8de01", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a59106887703490494daac5408771f3c49d8de01", "message": "Merge branch 'master' into cdc-fixes", "committedDate": "2020-05-14T13:17:46Z", "type": "commit"}, {"oid": "701f42a903d2d35ecef0908a59673c69b4011caa", "url": "https://github.com/hazelcast/hazelcast-jet/commit/701f42a903d2d35ecef0908a59673c69b4011caa", "message": "Adapt to latest json convenience changes", "committedDate": "2020-05-15T05:28:37Z", "type": "commit"}, {"oid": "9ef66ff6aa2402357010fa73701d2629aa37ef96", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9ef66ff6aa2402357010fa73701d2629aa37ef96", "message": "Add CDC map sink to sources & sinks page", "committedDate": "2020-05-15T06:39:11Z", "type": "commit"}, {"oid": "4bb9f77b46043deed30f5f479e44492cd5396d39", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4bb9f77b46043deed30f5f479e44492cd5396d39", "message": "Revert some changes in the tutorial", "committedDate": "2020-05-15T06:54:09Z", "type": "commit"}, {"oid": "ce0aca55ed49d9ebf81d29f0b7d19c9d46f75191", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ce0aca55ed49d9ebf81d29f0b7d19c9d46f75191", "message": "Change licensing of the CDC modules", "committedDate": "2020-05-15T07:29:37Z", "type": "commit"}, {"oid": "df1d4e6be0596f6ee1cc8216c22629a70eaf5c24", "url": "https://github.com/hazelcast/hazelcast-jet/commit/df1d4e6be0596f6ee1cc8216c22629a70eaf5c24", "message": "Fix javadoc", "committedDate": "2020-05-15T08:13:59Z", "type": "commit"}, {"oid": "6f1dd23fd08921e489c04cabbd48b1549fc85822", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6f1dd23fd08921e489c04cabbd48b1549fc85822", "message": "Extract some common processor code", "committedDate": "2020-05-15T11:07:10Z", "type": "commit"}, {"oid": "2574aadd70d20f8eddcba4b4eae81585da8ad60f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/2574aadd70d20f8eddcba4b4eae81585da8ad60f", "message": "Force total parallelism of sink to 1", "committedDate": "2020-05-18T06:50:26Z", "type": "commit"}, {"oid": "e04c2b46a5ec47e783aed646821b32bb59401168", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e04c2b46a5ec47e783aed646821b32bb59401168", "message": "Merge branch 'master' into cdc-fixes", "committedDate": "2020-05-18T06:55:54Z", "type": "commit"}, {"oid": "dafdb7c8c76c887a2fe1d0a99bc9648d771e0ce2", "url": "https://github.com/hazelcast/hazelcast-jet/commit/dafdb7c8c76c887a2fe1d0a99bc9648d771e0ce2", "message": "Re-add dependency exclusion from master", "committedDate": "2020-05-18T07:40:39Z", "type": "commit"}, {"oid": "ecb771581dff407afb78761b76f47006964c1cf1", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ecb771581dff407afb78761b76f47006964c1cf1", "message": "Proper fix for licenses", "committedDate": "2020-05-18T07:53:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5MjM4NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2248#discussion_r426592384", "bodyText": "this method can be inlined into the serializer", "author": "cangencer", "createdAt": "2020-05-18T12:35:43Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/ChangeRecordImpl.java", "diffHunk": "@@ -102,26 +98,15 @@ public String toString() {\n         return toJson();\n     }\n \n-    @Override\n-    public int getFactoryId() {\n-        return CdcJsonDataSerializerHook.FACTORY_ID;\n-    }\n-\n-    @Override\n-    public int getClassId() {\n-        return CdcJsonDataSerializerHook.CHANGE_RECORD;\n-    }\n-\n-    @Override\n-    public void writeData(ObjectDataOutput out) throws IOException {\n+    void writeData(ObjectDataOutput out) throws IOException {\n         out.writeUTF(keyJson);\n         out.writeUTF(valueJson);\n     }\n \n-    @Override\n-    public void readData(ObjectDataInput in) throws IOException {\n-        keyJson = in.readUTF();\n-        valueJson = in.readUTF();\n+    static ChangeRecordImpl readData(ObjectDataInput in) throws IOException {\n+        String keyJson = in.readUTF();", "originalCommit": "ecb771581dff407afb78761b76f47006964c1cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NDAxNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2248#discussion_r426664015", "bodyText": "The fields used are implementation details (to some extent) and I didn't want to add getters for them (that aren't part of the interface). The read/write methods seemed a better solution to me (they aren't the overriding ones from the other serialization, but are similar and confusing maybe) and I used them everywhere for consistency. Will inline them.", "author": "jbartok", "createdAt": "2020-05-18T14:23:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5MjM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5MjU4Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2248#discussion_r426592586", "bodyText": "it would be better to inline the serialization methods if you're using StreamSerializer", "author": "cangencer", "createdAt": "2020-05-18T12:36:05Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/CdcSource.java", "diffHunk": "@@ -234,26 +233,16 @@ public void setOffset(Map<String, ?> partition, Map<String, ?> offset) {\n             partitionsToOffset.put(partition, offset);\n         }\n \n-        @Override\n-        public int getFactoryId() {\n-            return CdcJsonDataSerializerHook.FACTORY_ID;\n-        }\n-\n-        @Override\n-        public int getClassId() {\n-            return CdcJsonDataSerializerHook.SOURCE_STATE;\n-        }\n-\n-        @Override\n-        public void writeData(ObjectDataOutput out) throws IOException {\n+        void writeData(ObjectDataOutput out) throws IOException {", "originalCommit": "ecb771581dff407afb78761b76f47006964c1cf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NjYzNw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2248#discussion_r426596637", "bodyText": "again can be inlined", "author": "cangencer", "createdAt": "2020-05-18T12:43:05Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/RecordPartImpl.java", "diffHunk": "@@ -77,23 +79,13 @@ public String toString() {\n         return toJson();\n     }\n \n-    @Override\n-    public int getFactoryId() {\n-        return CdcJsonDataSerializerHook.FACTORY_ID;\n-    }\n-\n-    @Override\n-    public int getClassId() {\n-        return CdcJsonDataSerializerHook.RECORD_PART;\n-    }\n-\n-    @Override\n-    public void writeData(ObjectDataOutput out) throws IOException {\n+    void writeData(ObjectDataOutput out) throws IOException {\n         out.writeUTF(json);\n     }\n \n-    @Override\n-    public void readData(ObjectDataInput in) throws IOException {\n-        json = in.readUTF();\n+    static RecordPartImpl readData(ObjectDataInput in) throws IOException {\n+        String json = in.readUTF();", "originalCommit": "ecb771581dff407afb78761b76f47006964c1cf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5ODMzNA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2248#discussion_r426598334", "bodyText": "too much duplication with UpdateMapP", "author": "cangencer", "createdAt": "2020-05-18T12:45:58Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/UpdateMapWithMaterializedValuesP.java", "diffHunk": "@@ -0,0 +1,217 @@\n+/*\n+ * Copyright (c) 2008-2020, Hazelcast, Inc. All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.impl.connector;\n+\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.internal.serialization.SerializationService;\n+import com.hazelcast.jet.core.Inbox;\n+import com.hazelcast.jet.core.JetDataSerializerHook;\n+import com.hazelcast.jet.core.Outbox;\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.map.EntryProcessor;\n+import com.hazelcast.map.IMap;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.IdentifiedDataSerializable;\n+\n+import javax.annotation.CheckReturnValue;\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class UpdateMapWithMaterializedValuesP<T, K, V> extends AsyncHazelcastWriterP {", "originalCommit": "ecb771581dff407afb78761b76f47006964c1cf1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY0NjExOQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2248#discussion_r426646119", "bodyText": "My opinion was (and is) that forcing further reuse/code share would hurt understandability greatly, but on the other hand I can definitely give it one more try.", "author": "jbartok", "createdAt": "2020-05-18T13:58:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5ODMzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwMDI2OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2248#discussion_r426600269", "bodyText": "would be better to call this PartitionService, and then you can initialize it in init() automatically and allow it to be used from subclasses automatically.", "author": "cangencer", "createdAt": "2020-05-18T12:49:03Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/connector/AsyncHazelcastWriterP.java", "diffHunk": "@@ -158,4 +164,32 @@ private boolean asyncCallsDone() {\n         checkError();\n         return allWritten;\n     }\n+\n+    static class PartitionInfo {", "originalCommit": "ecb771581dff407afb78761b76f47006964c1cf1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e826cc53ba19537cc6daf529887258139074c8ce", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e826cc53ba19537cc6daf529887258139074c8ce", "message": "Inline some methods used for serialization", "committedDate": "2020-05-18T14:37:24Z", "type": "commit"}, {"oid": "fb6f9f81f8b67dd53d59f6980749ff5c1be3fe8e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/fb6f9f81f8b67dd53d59f6980749ff5c1be3fe8e", "message": "Rename Apache license header file", "committedDate": "2020-05-19T05:55:34Z", "type": "commit"}, {"oid": "5f497ad9817cb0126691cec52ebb1ec51084eb55", "url": "https://github.com/hazelcast/hazelcast-jet/commit/5f497ad9817cb0126691cec52ebb1ec51084eb55", "message": "Merge branch 'master' into cdc-fixes", "committedDate": "2020-05-19T06:35:14Z", "type": "commit"}, {"oid": "b49840fc7f61bf2e501d493a077943e3048c8084", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b49840fc7f61bf2e501d493a077943e3048c8084", "message": "Adapt to latest changes", "committedDate": "2020-05-19T06:36:36Z", "type": "commit"}, {"oid": "cb1ddb0f7aaa5619c0f705aba0531894173991de", "url": "https://github.com/hazelcast/hazelcast-jet/commit/cb1ddb0f7aaa5619c0f705aba0531894173991de", "message": "Move CdcSinks to another PR", "committedDate": "2020-05-19T07:52:08Z", "type": "commit"}]}