{"pr_number": 2142, "pr_title": "[005] Productionize CDC sources", "pr_createdAt": "2020-04-06T09:39:15Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2142", "timeline": [{"oid": "7e879d970ac41afbd1189af8a01106830033e32b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7e879d970ac41afbd1189af8a01106830033e32b", "message": "Add 'main' part of CDC module", "committedDate": "2020-04-06T07:45:45Z", "type": "commit"}, {"oid": "1e78e8ac35026c1ff681e788761518c26f82173e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1e78e8ac35026c1ff681e788761518c26f82173e", "message": "Add 'test' part of CDC module", "committedDate": "2020-04-06T09:18:57Z", "type": "commit"}, {"oid": "731e4ad75c35d814b05b999ea5e35a0364a51cc8", "url": "https://github.com/hazelcast/hazelcast-jet/commit/731e4ad75c35d814b05b999ea5e35a0364a51cc8", "message": "Use MongodDBContainer from contrib jar", "committedDate": "2020-04-06T12:24:02Z", "type": "commit"}, {"oid": "1d4b39c129267b887069fe73bdef0bcf000d6bdd", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1d4b39c129267b887069fe73bdef0bcf000d6bdd", "message": "Finish all CDC source builders", "committedDate": "2020-04-07T12:25:38Z", "type": "commit"}, {"oid": "60d93eaf8f8e9a295df9b61e598050ef3a16bf7e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/60d93eaf8f8e9a295df9b61e598050ef3a16bf7e", "message": "Remove ObjectMapper from event objects", "committedDate": "2020-04-08T06:20:43Z", "type": "commit"}, {"oid": "eadc258b7876141957623888a1ba51fdea56e4db", "url": "https://github.com/hazelcast/hazelcast-jet/commit/eadc258b7876141957623888a1ba51fdea56e4db", "message": "Introduce per-db modules, add distribution jars", "committedDate": "2020-04-08T13:56:48Z", "type": "commit"}, {"oid": "6d2daa3030c7ffa6197ddbf5dddbde35bb78e24c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6d2daa3030c7ffa6197ddbf5dddbde35bb78e24c", "message": "Fix excessive lambda usage", "committedDate": "2020-04-09T06:35:07Z", "type": "commit"}, {"oid": "fa14f6d19775de3dcd6ebc3b42d414cb555fcb5b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/fa14f6d19775de3dcd6ebc3b42d414cb555fcb5b", "message": "Remove some TODOs", "committedDate": "2020-04-09T08:41:49Z", "type": "commit"}, {"oid": "216a4c64b114a1dfd93efff29cefa5bd0879bcf6", "url": "https://github.com/hazelcast/hazelcast-jet/commit/216a4c64b114a1dfd93efff29cefa5bd0879bcf6", "message": "Update changelogs, release notes and readmes", "committedDate": "2020-04-09T08:42:19Z", "type": "commit"}, {"oid": "4a8c1e8b314bc63ba5db1e8be6986a1613015ed3", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4a8c1e8b314bc63ba5db1e8be6986a1613015ed3", "message": "Delete code meant for 4.2", "committedDate": "2020-04-09T09:29:32Z", "type": "commit"}, {"oid": "f89fb362c8f0dde6f4f51540b54bfcd9a7c7dbec", "url": "https://github.com/hazelcast/hazelcast-jet/commit/f89fb362c8f0dde6f4f51540b54bfcd9a7c7dbec", "message": "Make value parsing stricter", "committedDate": "2020-04-09T09:40:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA2MDQ5Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406060496", "bodyText": "this can be package private", "author": "eminn", "createdAt": "2020-04-09T09:02:03Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/impl/KafkaConnectSource.java", "diffHunk": "@@ -0,0 +1,180 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.instance.impl.HazelcastInstanceFactory;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.pipeline.SourceBuilder;\n+import org.apache.kafka.connect.connector.ConnectorContext;\n+import org.apache.kafka.connect.source.SourceConnector;\n+import org.apache.kafka.connect.source.SourceRecord;\n+import org.apache.kafka.connect.source.SourceTask;\n+import org.apache.kafka.connect.source.SourceTaskContext;\n+import org.apache.kafka.connect.storage.OffsetStorageReader;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static com.hazelcast.jet.impl.util.ExceptionUtil.rethrow;\n+\n+public class KafkaConnectSource {", "originalCommit": "216a4c64b114a1dfd93efff29cefa5bd0879bcf6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjA5MjA3Nw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406092077", "bodyText": "I think we can inline these getXXX(JsonNode) methods", "author": "eminn", "createdAt": "2020-04-09T09:56:35Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/impl/JsonParsing.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.hazelcast.jet.cdc.ParsingException;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Optional;\n+\n+public final class JsonParsing {\n+\n+    private static final ThreadLocal<ObjectMapper> OBJECT_MAPPER_TL = ThreadLocal.withInitial(() ->\n+            new ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false));\n+\n+    private JsonParsing() {\n+    }\n+\n+    public static JsonNode parse(String json) throws ParsingException {\n+        try {\n+            ObjectMapper mapper = OBJECT_MAPPER_TL.get();\n+            return mapper.readTree(json);\n+        } catch (Exception e) {\n+            throw new ParsingException(e.getMessage(), e);\n+        }\n+    }\n+\n+    public static Optional<JsonNode> getChild(JsonNode node, String key) {\n+        JsonNode subNode = node.get(key);\n+        if (subNode == null || subNode.isNull()) {\n+            return Optional.empty();\n+        } else {\n+            return Optional.of(subNode);\n+        }\n+    }\n+\n+    public static <T> T mapToObj(JsonNode node, Class<T> clazz) throws ParsingException {\n+        try {\n+            ObjectMapper mapper = OBJECT_MAPPER_TL.get();\n+            return mapper.treeToValue(node, clazz);\n+        } catch (Exception e) {\n+            throw new ParsingException(e.getMessage(), e);\n+        }\n+    }\n+\n+    public static <T> Optional<List<Optional<T>>> getList(JsonNode node, String key, Class<T> clazz) {\n+        JsonNode value = node.get(key);\n+        return getList(clazz, value);\n+    }\n+\n+    public static Optional<Object> getObject(JsonNode node, String key) {\n+        Object value = node.get(key);\n+        return getObject(value);", "originalCommit": "f89fb362c8f0dde6f4f51540b54bfcd9a7c7dbec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwMzc2NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406103764", "bodyText": "orz -> or", "author": "eminn", "createdAt": "2020-04-09T10:17:08Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,182 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body orz", "originalCommit": "f89fb362c8f0dde6f4f51540b54bfcd9a7c7dbec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEwMzkxMg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406103912", "bodyText": "ducument -> document", "author": "eminn", "createdAt": "2020-04-09T10:17:29Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEvent.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.io.Serializable;\n+\n+/**\n+ * Information pertaining to a single data change event (insertion,\n+ * delete or update), affecting either a single database record\n+ * (in the case of relational databases) or document (in the case of\n+ * NoSQL databases).\n+ * <p>\n+ * Each event has a <i>key</i>, which identifies the particular\n+ * record or document being affected, and a <i>value</i>, which\n+ * describes the actual change itself.\n+ * <p>\n+ * Most events have an <i>operation</i> associated with them which\n+ * specifies the type of change being described (insertion, delete or\n+ * update). This is really a property of the value, it's only replicated\n+ * at this level for convenience. Only some special events, like\n+ * heartbeats don't have an operation value.\n+ * <p>\n+ * There is also a <i>timestamp</i> which specifies the moment in time when\n+ * the event happened. This timestamp is \"real\" in the sense that it\n+ * comes from the database change-log, so it's not \"processing time\",\n+ * it's not the moment when the event was observed by our system. Keep\n+ * in mind though that not all events come from the change-log. The\n+ * change-log goes back in time only to a limited extent, all older\n+ * events are parts of a database snapshot constructed when we start\n+ * monitoring the database and their timestamps are accordingly\n+ * artificial. Identifying snapshot events is possible most of the time,\n+ * because their operation will be {@link Operation#SYNC} instead of\n+ * {@link Operation#INSERT} (one notable exception being MySQL).\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public interface ChangeEvent extends Serializable  { //todo: use better serialization\n+\n+    /**\n+     * Convenience method, see {@link ChangeEventValue#timestamp()} for\n+     * details.\n+     */\n+    default long timestamp() throws ParsingException {\n+        return value().timestamp();\n+    }\n+\n+    /**\n+     * Convenience method, see {@link ChangeEventValue#operation()} for\n+     * details.\n+     */\n+    @Nonnull\n+    default Operation operation() throws ParsingException {\n+        return value().operation();\n+    }\n+\n+    /**\n+     * Identifies the particular record or document being affected\n+     * by the change event.\n+     */\n+    @Nonnull\n+    ChangeEventKey key();\n+\n+    /**\n+     * Describes the actual change affected on the record or ducument", "originalCommit": "f89fb362c8f0dde6f4f51540b54bfcd9a7c7dbec", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f05c7660cd1387a7ebe2fd545f9c05fd813cc181", "url": "https://github.com/hazelcast/hazelcast-jet/commit/f05c7660cd1387a7ebe2fd545f9c05fd813cc181", "message": "Address review concerns", "committedDate": "2020-04-09T10:29:14Z", "type": "commit"}, {"oid": "3db1a09a5c3a02ce18f32d18e68f654b9094edd9", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3db1a09a5c3a02ce18f32d18e68f654b9094edd9", "message": "Address review concerns", "committedDate": "2020-04-09T10:48:29Z", "type": "commit"}, {"oid": "5859544b4557013d8ac2bf5c067c517d60e0483a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/5859544b4557013d8ac2bf5c067c517d60e0483a", "message": "Switch (de)serialization to StreamSerializer", "committedDate": "2020-04-09T12:29:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NzQ4OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406257488", "bodyText": "MySql -> Mysql", "author": "eminn", "createdAt": "2020-04-09T14:45:03Z", "path": "extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/MySqlIntegrationTest.java", "diffHunk": "@@ -0,0 +1,200 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.mysql;\n+\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Job;\n+import com.hazelcast.jet.accumulator.LongAccumulator;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.cdc.ChangeEventElement;\n+import com.hazelcast.jet.cdc.ChangeEventValue;\n+import com.hazelcast.jet.cdc.Operation;\n+import com.hazelcast.jet.cdc.ParsingException;\n+import com.hazelcast.jet.cdc.mysql.data.Customer;\n+import com.hazelcast.jet.cdc.mysql.data.Order;\n+import com.hazelcast.jet.cdc.mysql.data.OrderPrimaryKey;\n+import com.hazelcast.jet.core.JetTestSupport;\n+import com.hazelcast.jet.core.JobStatus;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+import com.hazelcast.jet.pipeline.test.AssertionCompletedException;\n+import com.hazelcast.test.HazelcastTestSupport;\n+import org.junit.Rule;\n+import org.junit.Test;\n+import org.testcontainers.containers.MySQLContainer;\n+\n+import javax.annotation.Nonnull;\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.Date;\n+import java.util.concurrent.CompletionException;\n+import java.util.concurrent.ThreadLocalRandom;\n+\n+import static com.hazelcast.jet.cdc.Operation.DELETE;\n+import static com.hazelcast.jet.pipeline.test.AssertionSinks.assertCollectedEventually;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+import static org.testcontainers.containers.MySQLContainer.MYSQL_PORT;\n+\n+public class MySqlIntegrationTest extends AbstractIntegrationTest {", "originalCommit": "5859544b4557013d8ac2bf5c067c517d60e0483a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg3MTk3MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r407871971", "bodyText": "Same as below.", "author": "jbartok", "createdAt": "2020-04-14T05:15:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NzQ4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NzYzNA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406257634", "bodyText": "MySql -> Mysql, even though I'm not sure, JDBC connector uses this way internally.", "author": "eminn", "createdAt": "2020-04-09T14:45:16Z", "path": "extensions/cdc-mysql/src/main/java/com/hazelcast/jet/cdc/mysql/MySqlCdcSources.java", "diffHunk": "@@ -0,0 +1,204 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.mysql;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.cdc.impl.AbstractSourceBuilder;\n+import com.hazelcast.jet.cdc.impl.ChangeEventJsonImpl;\n+import com.hazelcast.jet.cdc.impl.PropertyRules;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+import org.apache.kafka.connect.data.Values;\n+\n+/**\n+ * Contains factory methods for creating change data capture sources\n+ * based on MySQL databases.\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public final class MySqlCdcSources {", "originalCommit": "5859544b4557013d8ac2bf5c067c517d60e0483a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg3MTg5OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r407871898", "bodyText": "Seems harder to read to me... MySQL would be the perfectly correct version, but that doesn't work with the camel-hump format, so MySql seems a good compromise. If you don't have strong feelings/arguments about it, I won't change it.", "author": "jbartok", "createdAt": "2020-04-14T05:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NzYzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI2Mjc5NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406262795", "bodyText": "I think this should be in the CDC core module along with the base class.", "author": "eminn", "createdAt": "2020-04-09T14:52:03Z", "path": "extensions/cdc-mysql/src/test/java/com/hazelcast/jet/cdc/mysql/GenericDebeziumIntegrationTest.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.mysql;\n+\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.Job;\n+import com.hazelcast.jet.accumulator.LongAccumulator;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.cdc.ChangeEventElement;\n+import com.hazelcast.jet.cdc.ChangeEventValue;\n+import com.hazelcast.jet.cdc.DebeziumCdcSources;\n+import com.hazelcast.jet.cdc.Operation;\n+import com.hazelcast.jet.cdc.mysql.data.Customer;\n+import com.hazelcast.jet.core.JetTestSupport;\n+import com.hazelcast.jet.core.JobStatus;\n+import com.hazelcast.jet.pipeline.Pipeline;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+import com.hazelcast.jet.pipeline.test.AssertionCompletedException;\n+import com.hazelcast.test.HazelcastTestSupport;\n+import org.junit.Test;\n+import org.testcontainers.containers.MySQLContainer;\n+\n+import java.sql.Connection;\n+import java.sql.DriverManager;\n+import java.util.concurrent.CompletionException;\n+\n+import static com.hazelcast.jet.cdc.Operation.DELETE;\n+import static com.hazelcast.jet.pipeline.test.AssertionSinks.assertCollectedEventually;\n+import static org.junit.Assert.assertTrue;\n+import static org.junit.Assert.fail;\n+import static org.testcontainers.containers.MySQLContainer.MYSQL_PORT;\n+\n+public class GenericDebeziumIntegrationTest extends AbstractIntegrationTest {", "originalCommit": "5859544b4557013d8ac2bf5c067c517d60e0483a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4ODM2Nw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406288367", "bodyText": "Do we really want to make this MongoDb specific concern first class citizen of the API ? Also given the fact that we are not including it in this round.", "author": "eminn", "createdAt": "2020-04-09T15:28:12Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEventValue.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Value (body) portion of a {@link ChangeEvent}, describes the actual\n+ * change that has been done to the affected database record or\n+ * document.\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public interface ChangeEventValue extends ChangeEventElement {\n+\n+    /**\n+     * Specifies the moment in time when the event happened. This\n+     * timestamp is \"real\" in the sense that it comes from the database\n+     * change-log, so it's not \"processing time\", it's not the moment\n+     * when the event was observed by our system. Keep in mind though\n+     * that not all events come from the change-log. The change-log goes\n+     * back in time only to a limited extent, all older events are parts\n+     * of a database snapshot constructed when we start monitoring the\n+     * database and their timestamps are accordingly artificial.\n+     * Identifying snapshot events is possible most of the time, because\n+     * their operation will be {@link Operation#SYNC} instead of\n+     * {@link Operation#INSERT} (one notable exception being MySQL).\n+     *\n+     * @throws ParsingException if no parsable timestamp field present\n+     */\n+    long timestamp() throws ParsingException;\n+\n+    /**\n+     * Specifies the type of change being described (insertion, delete or\n+     * update). Only some special events, like heartbeats don't have an\n+     * operation value.\n+     *\n+     * @return {@link Operation#UNSPECIFIED} if this {@code ChangeEventValue}\n+     * doesn't have an operation field or appropriate {@link Operation}\n+     * that matches what's found in the operation field\n+     * @throws ParsingException if there is an operation field, but it's\n+     *                          value is not among the handled ones.\n+     */\n+    @Nonnull\n+    Operation operation() throws ParsingException;\n+\n+    /**\n+     * Describes how the database record or document looked like BEFORE\n+     * applying the change event. Not provided for MongoDB updates.\n+     *\n+     * @throws ParsingException if this {@code ChangeEventValue} doesn't\n+     *                          have a 'before' sub-element\n+     */\n+    @Nonnull\n+    ChangeEventElement before() throws ParsingException;\n+\n+    /**\n+     * Describes how the database record or document looks like AFTER\n+     * the change event has been applied. Not provided for MongoDB updates.\n+     *\n+     * @throws ParsingException if this {@code ChangeEventValue} doesn't\n+     *                          have an 'after' sub-element\n+     */\n+    @Nonnull\n+    ChangeEventElement after() throws ParsingException;\n+\n+    /**\n+     * Describes the change being done by the event. Only used by\n+     * MongoDB updates.\n+     *\n+     * @throws ParsingException if this {@code ChangeEventValue} doesn't\n+     *                          have an 'patch' sub-element\n+     */\n+    @Nonnull\n+    ChangeEventElement change() throws ParsingException;", "originalCommit": "5859544b4557013d8ac2bf5c067c517d60e0483a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjYyOTk3Mg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406629972", "bodyText": "Assuming I remove it, what will I do when I do want to include Mongo later? Just add the method then, would that be ok?", "author": "jbartok", "createdAt": "2020-04-10T06:57:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4ODM2Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjY0NzM1OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406647359", "bodyText": "No, maybe from scratch mongo source can emit a different event which contains patch and filter fields in case of an update event.", "author": "eminn", "createdAt": "2020-04-10T07:51:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI4ODM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1NjkzMQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406456931", "bodyText": "effort", "author": "eminn", "createdAt": "2020-04-09T20:25:32Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {\n+\n+    /**\n+     * Maps the entire element to an instance of the specified class.\n+     * <p>\n+     * For databases providing standard JSON syntax, parsing it is based\n+     * on <a href=\"https://github.com/FasterXML/jackson-databind\">Jackson Databind</a>,\n+     * in particular on the Jackson {@code ObjectMapper}, so the\n+     * parameter class needs to be annotated accordingly.\n+     * <p>\n+     * Certain databases have limitations, for example MongoDB, which\n+     * uses an extended JSON syntax, mapping is only supported to\n+     * instances of the {@code org.bson.Document} class.\n+     *\n+     * @return optional {@code Object} value, which is empty only if\n+     * the specified key is not found or if it's value is null\n+     * @throws ParsingException if the whole structure containing this\n+     *                          element is unparsable or the mapping\n+     *                          fails to produce a result\n+     */\n+    @Nonnull\n+    <T> T mapToObj(Class<T> clazz) throws ParsingException;\n+\n+    /**\n+     * Best effor method for finding the specified (top level) key in", "originalCommit": "5859544b4557013d8ac2bf5c067c517d60e0483a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1Nzg2Mg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r406457862", "bodyText": "I think we can move this to impl package and make it package private", "author": "eminn", "createdAt": "2020-04-09T20:27:21Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/HazelcastListDatabaseHistory.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.instance.impl.HazelcastInstanceFactory;\n+import com.hazelcast.internal.util.Preconditions;\n+import io.debezium.config.Configuration;\n+import io.debezium.document.Document;\n+import io.debezium.document.DocumentReader;\n+import io.debezium.document.DocumentWriter;\n+import io.debezium.relational.history.AbstractDatabaseHistory;\n+import io.debezium.relational.history.DatabaseHistoryException;\n+import io.debezium.relational.history.DatabaseHistoryListener;\n+import io.debezium.relational.history.HistoryRecord;\n+import io.debezium.relational.history.HistoryRecordComparator;\n+\n+import java.io.IOException;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Database history implementation backed by Hazelcast IList {@link IList}.\n+ *\n+ * @since 4.1\n+ */\n+public class HazelcastListDatabaseHistory extends AbstractDatabaseHistory {", "originalCommit": "5859544b4557013d8ac2bf5c067c517d60e0483a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg4NDY3NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r407884675", "bodyText": "Have moved it, but it has to remain public (I think it's is being used via reflection).", "author": "jbartok", "createdAt": "2020-04-14T05:58:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjQ1Nzg2Mg=="}], "type": "inlineReview"}, {"oid": "4207fec181c5f470f8858a1d854779ef0aaeb625", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4207fec181c5f470f8858a1d854779ef0aaeb625", "message": "Move generic connector test to core module", "committedDate": "2020-04-14T05:38:07Z", "type": "commit"}, {"oid": "3055a3b56c5e4a50d450841b430a4b0dd42085e5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3055a3b56c5e4a50d450841b430a4b0dd42085e5", "message": "Use uniform package names", "committedDate": "2020-04-14T05:49:47Z", "type": "commit"}, {"oid": "6f14b2badc6e3f8fd819094a877406cc8c6bce45", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6f14b2badc6e3f8fd819094a877406cc8c6bce45", "message": "Move database history implementation to the right package", "committedDate": "2020-04-14T05:54:43Z", "type": "commit"}, {"oid": "7102bd5ba2a34495b51e33211adde91a1846e6fc", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7102bd5ba2a34495b51e33211adde91a1846e6fc", "message": "Remove MongoDB specific parts of the interface", "committedDate": "2020-04-14T06:08:38Z", "type": "commit"}, {"oid": "d4019f8370fa0063bea15cbe50ee056fe5b43c15", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d4019f8370fa0063bea15cbe50ee056fe5b43c15", "message": "Complete javadoc", "committedDate": "2020-04-14T06:53:25Z", "type": "commit"}, {"oid": "938a663cdbeba19f711711842f97f6567c7c60c1", "url": "https://github.com/hazelcast/hazelcast-jet/commit/938a663cdbeba19f711711842f97f6567c7c60c1", "message": "Merge branch 'master' into cdc", "committedDate": "2020-04-14T08:30:13Z", "type": "commit"}, {"oid": "9d798b2e3213c241ac7d9392ce2acd6875788890", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9d798b2e3213c241ac7d9392ce2acd6875788890", "message": "TDD update & API changes", "committedDate": "2020-04-15T07:41:57Z", "type": "commit"}, {"oid": "418effe1cef52d4eaaacb317e799280b0975f140", "url": "https://github.com/hazelcast/hazelcast-jet/commit/418effe1cef52d4eaaacb317e799280b0975f140", "message": "Simplify implementation using SMT", "committedDate": "2020-04-21T11:38:12Z", "type": "commit"}, {"oid": "a9804203bf924565e2b4a6d2a28cdb7f7720dd86", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a9804203bf924565e2b4a6d2a28cdb7f7720dd86", "message": "Merge branch 'master' into cdc", "committedDate": "2020-04-23T11:20:08Z", "type": "commit"}, {"oid": "37fd6c7f75dc44f0a0c683828b2761b83d326665", "url": "https://github.com/hazelcast/hazelcast-jet/commit/37fd6c7f75dc44f0a0c683828b2761b83d326665", "message": "Add perf-testing conclusions (so far)", "committedDate": "2020-04-23T11:57:36Z", "type": "commit"}, {"oid": "1b22a15ea95f99906c5556afbc53a2f1caba4fe5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1b22a15ea95f99906c5556afbc53a2f1caba4fe5", "message": "Update design document for latest changes", "committedDate": "2020-04-24T07:34:22Z", "type": "commit"}, {"oid": "ac5b00b25f154454719e865133e5a73e0827a1f6", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ac5b00b25f154454719e865133e5a73e0827a1f6", "message": "Clean-up CDC design doc", "committedDate": "2020-04-27T05:38:17Z", "type": "commit"}, {"oid": "c6e788102eb855b2297eef4e0666344e6007e110", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c6e788102eb855b2297eef4e0666344e6007e110", "message": "Update MySQL test container", "committedDate": "2020-04-27T06:59:59Z", "type": "commit"}, {"oid": "ccca759e71fe6b2f29e924810be331ffa813bb7e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ccca759e71fe6b2f29e924810be331ffa813bb7e", "message": "Update CDC Tutorial to latest version", "committedDate": "2020-04-27T07:00:17Z", "type": "commit"}, {"oid": "a2f9267944d743e44b246df861a6b4e68a39f1fa", "url": "https://github.com/hazelcast/hazelcast-jet/commit/a2f9267944d743e44b246df861a6b4e68a39f1fa", "message": "Merge branch 'master' into cdc", "committedDate": "2020-04-27T07:25:56Z", "type": "commit"}, {"oid": "1b5e171486ecae71b79e813b21cff0165921a040", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1b5e171486ecae71b79e813b21cff0165921a040", "message": "Fix jet versions in various places", "committedDate": "2020-04-27T07:29:29Z", "type": "commit"}, {"oid": "508479653e83eb1b5889bbc227087565e7d486f1", "url": "https://github.com/hazelcast/hazelcast-jet/commit/508479653e83eb1b5889bbc227087565e7d486f1", "message": "Revert accidental changes", "committedDate": "2020-04-27T10:42:17Z", "type": "commit"}, {"oid": "ea3e5cad4eccad3ead6930d65aea054b0cda782b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ea3e5cad4eccad3ead6930d65aea054b0cda782b", "message": "Add CDC to sources page, start CDC deployment guide", "committedDate": "2020-04-27T11:11:23Z", "type": "commit"}, {"oid": "2bc4ed54852a7fcc17e34329950eba263955b1ea", "url": "https://github.com/hazelcast/hazelcast-jet/commit/2bc4ed54852a7fcc17e34329950eba263955b1ea", "message": "Write CDC deployment guide", "committedDate": "2020-04-28T09:21:22Z", "type": "commit"}, {"oid": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "url": "https://github.com/hazelcast/hazelcast-jet/commit/cfbf3c2d3912de73ede62bbb70747382608db9f8", "message": "Update version in release notes and  changelog", "committedDate": "2020-04-28T09:27:55Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3NDM4MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r416574380", "bodyText": "Could you please explain what is the heartbeat events ?", "author": "eminn", "createdAt": "2020-04-28T12:32:51Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEvent.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Information pertaining to a single data change event (insertion,\n+ * delete or update), affecting either a single database record\n+ * (in the case of relational databases) or document (in the case of\n+ * NoSQL databases).\n+ * <p>\n+ * Each event has a <i>key</i>, which identifies the particular\n+ * record or document being affected, and a <i>value</i>, which\n+ * describes the actual change itself.\n+ * <p>\n+ * Most events have an <i>operation</i> associated with them which\n+ * specifies the type of change being described (insertion, delete or\n+ * update). This is really a property of the value, it's only replicated\n+ * at this level for convenience. Only some special events, like\n+ * heartbeats don't have an operation value.", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MTYwNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417071606", "bodyText": "If you set heartbeat.interval.ms in the Debezium connectors' config (not just the MySQL one, but in general), they will produce periodic heartbeat events. I haven't exposed this in our sources, but it's possible to enable (via com.hazelcast.jet.cdc.impl.AbstractSourceBuilder.setCustomProperty) and encounter them while using CDC via Jet. But is it worth a more than cursory mention in our Javadoc? Don't know. They get some mention, because they are the reason Operation.UNSPECIFIED exists... What would you like me to change?", "author": "jbartok", "createdAt": "2020-04-29T05:17:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3NDM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzEyNjAwOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417126008", "bodyText": "I see, I mean we can at least provide a link to it's definition and configuration ? I'm also fine if the explanation above present in Javadoc", "author": "eminn", "createdAt": "2020-04-29T07:46:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3NDM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg2NTc2MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417865761", "bodyText": "Ok. I don't want to explain too much, because I don't want to encourage anybody to use the heartbeats in Jet, but will add some clarifications.", "author": "jbartok", "createdAt": "2020-04-30T09:07:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3NDM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MjkzNA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417072934", "bodyText": "how is ChangeEventElement different than JsonNode? I don't see anything specific to a ChangeEvent in this interface", "author": "cangencer", "createdAt": "2020-04-29T05:22:17Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NjY5MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417076691", "bodyText": "Made more sense when we didn't yet exclude MongoDB. There it had nothing to do with JsonNode. But even now, do we really want to have JsonNode in our API? Even if we do the same thing?", "author": "jbartok", "createdAt": "2020-04-29T05:36:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MjkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NzE5Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417077193", "bodyText": "I don't see an issue, it's well documented and has more capabilities? I believe we are going to be shading Jackson as part of our public API?", "author": "cangencer", "createdAt": "2020-04-29T05:38:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MjkzNA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1ODU0NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417858544", "bodyText": "This is not exactly how I ended up, JsonNode is gone too now, since moving to Jackson jr, but ChangeEventElement is greatly simplified now, we no longer implement parsing shenanigans, everything is in Jackson code. Take a look if you can.", "author": "jbartok", "createdAt": "2020-04-30T08:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MjkzNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MzI3MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417073270", "bodyText": "why you would need this?", "author": "cangencer", "createdAt": "2020-04-29T05:23:39Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/impl/AbstractSourceBuilder.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.pipeline.SourceBuilder;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Properties;\n+\n+public abstract class AbstractSourceBuilder<SELF extends AbstractSourceBuilder<SELF>> {", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NzIyNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417077226", "bodyText": "Initially I was expecting a lot of common functionality in the builders of the various sources, but it wasn't so, due to lots of subtle differences. But, the generic method for setting any kind of Debezium property is common and some other internal code. Do you think it would be better not to have it?", "author": "jbartok", "createdAt": "2020-04-29T05:38:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MzI3MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MzUyMw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417073523", "bodyText": "how do these lists get cleaned up?", "author": "cangencer", "createdAt": "2020-04-29T05:24:28Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/impl/HazelcastListDatabaseHistory.java", "diffHunk": "@@ -0,0 +1,103 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.instance.impl.HazelcastInstanceFactory;\n+import com.hazelcast.internal.util.Preconditions;\n+import io.debezium.config.Configuration;\n+import io.debezium.document.Document;\n+import io.debezium.document.DocumentReader;\n+import io.debezium.document.DocumentWriter;\n+import io.debezium.relational.history.AbstractDatabaseHistory;\n+import io.debezium.relational.history.DatabaseHistoryException;\n+import io.debezium.relational.history.DatabaseHistoryListener;\n+import io.debezium.relational.history.HistoryRecord;\n+import io.debezium.relational.history.HistoryRecordComparator;\n+\n+import java.io.IOException;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Database history implementation backed by Hazelcast IList {@link IList}.\n+ *\n+ * @since 4.1\n+ */\n+public class HazelcastListDatabaseHistory extends AbstractDatabaseHistory {", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3OTg4Nw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417079887", "bodyText": "No idea, this was code I inherited and never thought of checking. Will do so now.", "author": "jbartok", "createdAt": "2020-04-29T05:48:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MzUyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg3ODc0MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417878740", "bodyText": "Fixed clean-up in it (has a stop() method, which is called by the connector and the list will be destroyed there).", "author": "jbartok", "createdAt": "2020-04-30T09:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MzUyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3MzkwOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417073908", "bodyText": "should be required", "author": "cangencer", "createdAt": "2020-04-29T05:26:04Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/impl/PropertyRules.java", "diffHunk": "@@ -0,0 +1,53 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.Set;\n+\n+public class PropertyRules {\n+\n+    private final Set<String> mandatories = new HashSet<>();", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NDk2MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417074961", "bodyText": "keep in mind when you return Optional, it's creating more garbage", "author": "cangencer", "createdAt": "2020-04-29T05:30:13Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {\n+\n+    /**\n+     * Maps the entire element to an instance of the specified class.\n+     * <p>\n+     * For databases providing standard JSON syntax, parsing it is based\n+     * on <a\n+     * href=\"https://github.com/FasterXML/jackson-databind\">Jackson\n+     * Databind</a>, in particular on the Jackson {@code ObjectMapper},\n+     * so the parameter class needs to be annotated accordingly.\n+     *\n+     * @return optional {@code Object} value, which is empty only if the\n+     * specified key is not found or if it's value is null\n+     * @throws ParsingException if the whole structure containing this\n+     *                          element is unparsable or the mapping\n+     *                          fails to produce a result\n+     */\n+    @Nonnull\n+    <T> T mapToObj(Class<T> clazz) throws ParsingException;\n+\n+    /**\n+     * Returns the value of the specified (top level) key in the\n+     * underlying JSON message as a child {@code ChangeEventElement}.\n+     *\n+     * @return optional {@code ChangeEventElement}, which is empty if\n+     * the specified key is not found or if the value is null.\n+     * @throws ParsingException if the underlying JSON message, or any\n+     *                          of its parent messages are unparsable\n+     */\n+    Optional<ChangeEventElement> getChild(String key) throws ParsingException;", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA4MDY1OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417080659", "bodyText": "I know, but I wanted to keep ParsingException for actual parsing errors... maybe use NoSuchElementException instead of some Optionals + some hasXXX where absolutely necessary? will give it a try", "author": "jbartok", "createdAt": "2020-04-29T05:51:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NDk2MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1OTQ2OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417859469", "bodyText": "All Optionals are gone now, together with any parsing code of our own.", "author": "jbartok", "createdAt": "2020-04-30T08:56:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NDk2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NTE3OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417075178", "bodyText": "missing annotations (same for other methods)", "author": "cangencer", "createdAt": "2020-04-29T05:31:06Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,189 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.List;\n+import java.util.Optional;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {\n+\n+    /**\n+     * Maps the entire element to an instance of the specified class.\n+     * <p>\n+     * For databases providing standard JSON syntax, parsing it is based\n+     * on <a\n+     * href=\"https://github.com/FasterXML/jackson-databind\">Jackson\n+     * Databind</a>, in particular on the Jackson {@code ObjectMapper},\n+     * so the parameter class needs to be annotated accordingly.\n+     *\n+     * @return optional {@code Object} value, which is empty only if the\n+     * specified key is not found or if it's value is null\n+     * @throws ParsingException if the whole structure containing this\n+     *                          element is unparsable or the mapping\n+     *                          fails to produce a result\n+     */\n+    @Nonnull\n+    <T> T mapToObj(Class<T> clazz) throws ParsingException;", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NTI3Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417075273", "bodyText": "missing annotations", "author": "cangencer", "createdAt": "2020-04-29T05:31:20Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/DebeziumCdcSources.java", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+import com.hazelcast.jet.cdc.impl.AbstractSourceBuilder;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+\n+/**\n+ * Contains factory methods for creating change data capture sources\n+ *\n+ * @since 4.1\n+ */\n+@EvolvingApi\n+public final class DebeziumCdcSources {\n+\n+    private DebeziumCdcSources() {\n+    }\n+\n+    /**\n+     * Creates a CDC source that streams change data from your Debezium\n+     * supported database to the Hazelcast Jet pipeline.\n+     *\n+     * @param name       name of this source, needs to be unique, will be\n+     *                   passed to the underlying Kafka Connect source\n+     * @return builder that can be used to set source properties and also\n+     * to construct the source once configuration is done\n+     */\n+    public static Builder debezium(String name, String connectorClass) {", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzA3NTM0MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r417075341", "bodyText": "4.2", "author": "cangencer", "createdAt": "2020-04-29T05:31:36Z", "path": "extensions/cdc-core/src/main/java/com/hazelcast/jet/cdc/Operation.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+/**\n+ * Describes the nature of the event in CDC data. Equivalent to various\n+ * actions that can affect a database record: insertion, update and\n+ * deletion. Has some extra special values like \"sync\" which is just\n+ * like an insert, but originates from a database snapshot (as opposed\n+ * database changelog) and \"unspecified\" which is used for a few special\n+ * CDC events, like heartbeats.\n+ *\n+ * @since 4.1", "originalCommit": "cfbf3c2d3912de73ede62bbb70747382608db9f8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "8b0e868c64d63a8ef287aca8a281f8ee304781c8", "url": "https://github.com/hazelcast/hazelcast-jet/commit/8b0e868c64d63a8ef287aca8a281f8ee304781c8", "message": "Update @since annotations", "committedDate": "2020-04-29T06:02:32Z", "type": "commit"}, {"oid": "c2c5ec614f8a67d43857336fff72f9426f128398", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c2c5ec614f8a67d43857336fff72f9426f128398", "message": "Add missing @Nonnull annotations", "committedDate": "2020-04-29T06:17:39Z", "type": "commit"}, {"oid": "4b38a66af99ed065130709953d908de78c9f7909", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4b38a66af99ed065130709953d908de78c9f7909", "message": "Rename stuff", "committedDate": "2020-04-29T06:21:32Z", "type": "commit"}, {"oid": "489fa94f74442ace165a08b56f718641c806ade5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/489fa94f74442ace165a08b56f718641c806ade5", "message": "Move common extensions dependency to main pom", "committedDate": "2020-04-29T06:25:27Z", "type": "commit"}, {"oid": "d2a880121681eadcaa70ada569c5ba846a6980c9", "url": "https://github.com/hazelcast/hazelcast-jet/commit/d2a880121681eadcaa70ada569c5ba846a6980c9", "message": "Rename cdc-core to cdc-debezium", "committedDate": "2020-04-29T07:25:05Z", "type": "commit"}, {"oid": "bdea45e3b332207c81b5c7f32d66406b2db6e0b3", "url": "https://github.com/hazelcast/hazelcast-jet/commit/bdea45e3b332207c81b5c7f32d66406b2db6e0b3", "message": "Replace Jackson Databind with jr, adapt API accordingly", "committedDate": "2020-04-30T07:57:06Z", "type": "commit"}, {"oid": "936fff21d622926b2dc42b428127d259567127e8", "url": "https://github.com/hazelcast/hazelcast-jet/commit/936fff21d622926b2dc42b428127d259567127e8", "message": "Add missing @Nonnull annotations", "committedDate": "2020-04-30T08:58:29Z", "type": "commit"}, {"oid": "630c148b818a6aff4ee0ba72173b39982702e66f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/630c148b818a6aff4ee0ba72173b39982702e66f", "message": "Add some explanations related to heartbeat events", "committedDate": "2020-04-30T09:05:20Z", "type": "commit"}, {"oid": "c366fa62dea53be2feadd5569c3fa61151831549", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c366fa62dea53be2feadd5569c3fa61151831549", "message": "Add proper clean-up to database history", "committedDate": "2020-04-30T09:29:02Z", "type": "commit"}, {"oid": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3231a8abfab24e8bbb632e748f45add4a94ba39b", "message": "Merge branch 'master' into cdc", "committedDate": "2020-04-30T10:15:15Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNzM0OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418107348", "bodyText": "wouldn't it be better to just use toString() here?", "author": "cangencer", "createdAt": "2020-04-30T15:44:13Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Map;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {\n+\n+    /**\n+     * Maps the entire element to an instance of the specified class.\n+     * <p>\n+     * Parsing it is based on <a href=\"https://github.com/FasterXML/jackson-jr\">Jackson jr</a>,\n+     * with <a href=\"https://github.com/FasterXML/jackson-jr/tree/master/jr-annotation-support\">annotation support</a>,\n+     * so the parameter class can be annotated accordingly.\n+     *\n+     * @return object of type {@code T}, obtained as the result of the\n+     * mapping\n+     * @throws ParsingException if the whole structure containing this\n+     *                          element is unparsable or the mapping\n+     *                          fails to produce a result\n+     */\n+    @Nonnull\n+    <T> T asPojo(@Nonnull Class<T> clazz) throws ParsingException;\n+\n+    /**\n+     * Presents a parsed form of the underlying JSON message, as a\n+     * {@code Map}. The keys in the map are the top level fields from\n+     * the JSON and the values can range from simple strings, numbers,\n+     * collections and sub-maps.\n+     * <p>\n+     * Parsing it is based on <a href=\"https://github.com/FasterXML/jackson-jr\">Jackson jr</a>,\n+     * that's where further details can be found.\n+     *\n+     * @return {@code Map} representation of the JSON data\n+     * @throws ParsingException if the underlying JSON message, or any\n+     *                          of its parent messages are unparsable\n+     */\n+    @Nonnull\n+    Map<String, Object> asMap() throws ParsingException;\n+\n+    /**\n+     * Returns raw JSON string which the content of this event element\n+     * is based on. To be used when parsing fails for some reason (for\n+     * example on some untested DB-connector version combination).\n+     */\n+    @Nonnull\n+    String asJson();", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI0ODQ0NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419248445", "bodyText": "In my opinion no, because a separate method can provide a clear contract and format of the String it returns, while people would not expect that much from toString(). As far as I know it's good design not to rely on any particular format of what toString() provides. I would not use toString() for this, even though we could.", "author": "jbartok", "createdAt": "2020-05-04T07:15:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI0ODc2NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419248765", "bodyText": "I would even prefer to remove the asJson method completely to using toString().", "author": "jbartok", "createdAt": "2020-05-04T07:16:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1MDg4MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419250881", "bodyText": "If JSON is the primary representation, it can be OK to use toString for it. An overriding method can narrow down the contract of toString, there are precedents for this in the JDK. toString can also delegate to asJson.", "author": "mtopolnik", "createdAt": "2020-05-04T07:21:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMyMDM4NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419320384", "bodyText": "Ok. toString() already delegates to asJson(). Beyond that I prefer to keep asJson(), but am ok with both versions. Pls. decide.", "author": "jbartok", "createdAt": "2020-05-04T09:42:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNzM0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM0MDIwNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419340206", "bodyText": "I'm OK with both methods.", "author": "mtopolnik", "createdAt": "2020-05-04T10:22:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwNzM0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwOTQ2Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418109463", "bodyText": "javadoc seems outdated", "author": "cangencer", "createdAt": "2020-04-30T15:47:17Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Map;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1ODQ2Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419258466", "bodyText": "Yes, seems like I forgot about a few javadoc, changing.", "author": "jbartok", "createdAt": "2020-05-04T07:38:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwOTQ2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODEwOTk5MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418109991", "bodyText": "I would prefer ChangeRecord", "author": "cangencer", "createdAt": "2020-04-30T15:48:04Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/ChangeEvent.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Information pertaining to a single data change event (insertion,\n+ * delete or update), affecting either a single database record (in the\n+ * case of relational databases) or document (in the case of NoSQL\n+ * databases).\n+ * <p>\n+ * Each event has a <i>key</i>, which identifies the particular record\n+ * or document being affected, and a <i>value</i>, which describes the\n+ * actual change itself.\n+ * <p>\n+ * Most events have an <i>operation</i> associated with them which\n+ * specifies the type of change being described (insertion, delete or\n+ * update). This is really a property of the value, it's only replicated\n+ * at this level for convenience. Only some special events, like\n+ * heartbeats don't have an operation value. (Heartbeat events are not\n+ * something we encourage the usage of, but since no functionality of\n+ * the underlying Debezium connectors is disabled they are still\n+ * theoretically possible to enable and be observed in Jet.)\n+ * <p>\n+ * There is also a <i>timestamp</i> which specifies the moment in time\n+ * when the event happened. This timestamp is \"real\" in the sense that\n+ * it comes from the database change-log, so it's not \"processing time\",\n+ * it's not the moment when the event was observed by our system. Keep\n+ * in mind though that not all events come from the change-log. The\n+ * change-log goes back in time only to a limited extent, all older\n+ * events are parts of a database snapshot constructed when we start\n+ * monitoring the database and their timestamps are accordingly\n+ * artificial. Identifying snapshot events is possible most of the time,\n+ * because their operation will be {@link Operation#SYNC} instead of\n+ * {@link Operation#INSERT} (one notable exception being MySQL).\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public interface ChangeEvent {", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMjk3Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418112976", "bodyText": "this name should be changed to. something like RecordPart ?", "author": "cangencer", "createdAt": "2020-04-30T15:52:15Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Map;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMzQ4Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418113483", "bodyText": "what's the point of rethrowing here? what's wrong with IOException?", "author": "cangencer", "createdAt": "2020-04-30T15:52:56Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/ChangeEventElementJsonImpl.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.fasterxml.jackson.jr.annotationsupport.JacksonAnnotationExtension;\n+import com.fasterxml.jackson.jr.ob.JSON;\n+import com.hazelcast.jet.cdc.ChangeEventElement;\n+import com.hazelcast.jet.cdc.ParsingException;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.IdentifiedDataSerializable;\n+\n+import javax.annotation.Nonnull;\n+import java.io.IOException;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+class ChangeEventElementJsonImpl implements ChangeEventElement, IdentifiedDataSerializable {\n+\n+    private static final JSON J = JSON.builder().register(JacksonAnnotationExtension.std).build();\n+\n+    private String json;\n+    private Map<String, Object> content;\n+\n+    ChangeEventElementJsonImpl() { //needed for deserialization\n+    }\n+\n+    ChangeEventElementJsonImpl(@Nonnull String json) {\n+        this.json = Objects.requireNonNull(json);\n+    }\n+\n+    @Override\n+    @Nonnull\n+    public <T> T asPojo(@Nonnull Class<T> clazz) throws ParsingException {\n+        Objects.requireNonNull(clazz, \"class\");\n+        try {\n+            return J.beanFrom(clazz, json);\n+        } catch (IOException e) {\n+            throw new ParsingException(e.getMessage(), e);", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTI1ODIzNA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419258234", "bodyText": "I use ParsingException to signal various failures in parsing, which in my mind is not I/O (failing to receive the JSON string from somewhere, that would be I/O, parsing it after it's in memory, that doesn't seem to be... arguable).\nAnyways, beyond my rumblings, IOException is too generic, even Jackson jr have their own JsonProcessingException.\nI can change it if you feel strongly about it, I don't mind, just wanted to clarify my reasoning.", "author": "jbartok", "createdAt": "2020-05-04T07:38:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExMzQ4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODExNzQwMA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418117400", "bodyText": "this is a private class but extended by a public one. You can just convert this class to non-abstract and use it inside the actual builders, then you don't need this SELF either.", "author": "cangencer", "createdAt": "2020-04-30T15:58:38Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/AbstractSourceBuilder.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.pipeline.SourceBuilder;\n+import com.hazelcast.jet.pipeline.StreamSource;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Objects;\n+import java.util.Properties;\n+\n+public abstract class AbstractSourceBuilder<SELF extends AbstractSourceBuilder<SELF>> {", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI3ODgxNw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418278817", "bodyText": "toObject", "author": "cangencer", "createdAt": "2020-04-30T20:46:08Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Map;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {\n+\n+    /**\n+     * Maps the entire element to an instance of the specified class.\n+     * <p>\n+     * Parsing it is based on <a href=\"https://github.com/FasterXML/jackson-jr\">Jackson jr</a>,\n+     * with <a href=\"https://github.com/FasterXML/jackson-jr/tree/master/jr-annotation-support\">annotation support</a>,\n+     * so the parameter class can be annotated accordingly.\n+     *\n+     * @return object of type {@code T}, obtained as the result of the\n+     * mapping\n+     * @throws ParsingException if the whole structure containing this\n+     *                          element is unparsable or the mapping\n+     *                          fails to produce a result\n+     */\n+    @Nonnull\n+    <T> T asPojo(@Nonnull Class<T> clazz) throws ParsingException;", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI3ODg3NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418278875", "bodyText": "toMap", "author": "cangencer", "createdAt": "2020-04-30T20:46:14Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/ChangeEventElement.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+import java.util.Map;\n+\n+/**\n+ * Arbitrary part of a {@link ChangeEvent}, as big as the whole body or\n+ * as small as a single patch expression, based on a complete JSON\n+ * expression. Contains various methods for retrieving component values\n+ * or for mapping itself to data objects.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public interface ChangeEventElement {\n+\n+    /**\n+     * Maps the entire element to an instance of the specified class.\n+     * <p>\n+     * Parsing it is based on <a href=\"https://github.com/FasterXML/jackson-jr\">Jackson jr</a>,\n+     * with <a href=\"https://github.com/FasterXML/jackson-jr/tree/master/jr-annotation-support\">annotation support</a>,\n+     * so the parameter class can be annotated accordingly.\n+     *\n+     * @return object of type {@code T}, obtained as the result of the\n+     * mapping\n+     * @throws ParsingException if the whole structure containing this\n+     *                          element is unparsable or the mapping\n+     *                          fails to produce a result\n+     */\n+    @Nonnull\n+    <T> T asPojo(@Nonnull Class<T> clazz) throws ParsingException;\n+\n+    /**\n+     * Presents a parsed form of the underlying JSON message, as a\n+     * {@code Map}. The keys in the map are the top level fields from\n+     * the JSON and the values can range from simple strings, numbers,\n+     * collections and sub-maps.\n+     * <p>\n+     * Parsing it is based on <a href=\"https://github.com/FasterXML/jackson-jr\">Jackson jr</a>,\n+     * that's where further details can be found.\n+     *\n+     * @return {@code Map} representation of the JSON data\n+     * @throws ParsingException if the underlying JSON message, or any\n+     *                          of its parent messages are unparsable\n+     */\n+    @Nonnull\n+    Map<String, Object> asMap() throws ParsingException;", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI3OTk4Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418279983", "bodyText": "probably non-issue for now, but doesn't this mean we always force conversion to JSON rather than being able to access the Struct directly?  maybe worth thinking about in the future.", "author": "cangencer", "createdAt": "2020-04-30T20:48:33Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/CdcSource.java", "diffHunk": "@@ -0,0 +1,201 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.instance.impl.HazelcastInstanceFactory;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.pipeline.SourceBuilder;\n+import io.debezium.transforms.ExtractNewRecordState;\n+import org.apache.kafka.connect.connector.ConnectorContext;\n+import org.apache.kafka.connect.data.Struct;\n+import org.apache.kafka.connect.data.Values;\n+import org.apache.kafka.connect.source.SourceConnector;\n+import org.apache.kafka.connect.source.SourceRecord;\n+import org.apache.kafka.connect.source.SourceTask;\n+import org.apache.kafka.connect.source.SourceTaskContext;\n+import org.apache.kafka.connect.storage.OffsetStorageReader;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static com.hazelcast.jet.impl.util.ExceptionUtil.rethrow;\n+\n+class CdcSource {\n+\n+    private final SourceConnector connector;\n+    private final SourceTask task;\n+    private final Map<String, String> taskConfig;\n+    private final ExtractNewRecordState<SourceRecord> smt;\n+\n+    /**\n+     * Key represents the partition which the record originated from. Value\n+     * represents the offset within that partition. Kafka Connect represents\n+     * the partition and offset as arbitrary values so that is why it is\n+     * stored as map.\n+     * See {@link SourceRecord} for more information regarding the format.\n+     */\n+    private Map<Map<String, ?>, Map<String, ?>> partitionsToOffset = new HashMap<>();\n+    private boolean taskInit;\n+\n+    CdcSource(Processor.Context ctx, Properties properties) {\n+        try {\n+            String connectorClazz = properties.getProperty(\"connector.class\");\n+            Class<?> connectorClass = Thread.currentThread().getContextClassLoader().loadClass(connectorClazz);\n+            connector = (SourceConnector) connectorClass.getConstructor().newInstance();\n+            connector.initialize(new JetConnectorContext());\n+            connector.start((Map) injectHazelcastInstanceNameProperty(ctx, properties));\n+\n+            smt = initSmt();\n+\n+            taskConfig = connector.taskConfigs(1).get(0);\n+            task = (SourceTask) connector.taskClass().getConstructor().newInstance();\n+        } catch (Exception e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    public void fillBuffer(SourceBuilder.TimestampedSourceBuffer<ChangeEvent> buf) {\n+        if (!taskInit) {\n+            task.initialize(new JetSourceTaskContext());\n+            task.start(taskConfig);\n+            taskInit = true;\n+        }\n+        try {\n+            List<SourceRecord> records = task.poll();\n+            if (records == null) {\n+                return;\n+            }\n+\n+            for (SourceRecord record : records) {\n+                boolean added = addToBuffer(record, buf);\n+                if (added) {\n+                    partitionsToOffset.put(record.sourcePartition(), record.sourceOffset());\n+                }\n+            }\n+        } catch (InterruptedException e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    private boolean addToBuffer(SourceRecord record, SourceBuilder.TimestampedSourceBuffer<ChangeEvent> buf) {\n+        record = smt.apply(record);\n+        if (record != null) {\n+            ChangeEvent event = extractEvent(record);\n+            long timestamp = extractTimestamp(record);\n+            buf.add(event, timestamp);\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    public void destroy() {\n+        try {\n+            task.stop();\n+        } finally {\n+            connector.stop();\n+        }\n+    }\n+\n+    public Map<Map<String, ?>, Map<String, ?>> createSnapshot() {\n+        return partitionsToOffset;\n+    }\n+\n+    public void restoreSnapshot(List<Map<Map<String, ?>, Map<String, ?>>> snapshots) {\n+        this.partitionsToOffset = snapshots.get(0);\n+    }\n+\n+    private static ExtractNewRecordState<SourceRecord> initSmt() {\n+        ExtractNewRecordState<SourceRecord> smt = new ExtractNewRecordState<>();\n+\n+        Map<String, String> config = new HashMap<>();\n+        config.put(\"add.fields\", \"op, ts_ms\");\n+        config.put(\"delete.handling.mode\", \"rewrite\");\n+        smt.configure(config);\n+\n+        return smt;\n+    }\n+\n+    private static ChangeEvent extractEvent(SourceRecord record) {\n+        String keyJson = Values.convertToString(record.keySchema(), record.key());", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzNzQyNg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419337426", "bodyText": "Yes, it does. But Struct is on hand Kafka Connect code and on the other hand terribly hard to work with. So I don't think we will ever want to directly work with it. But if we will at some point, we can change this and other implementation stuff, it's not exposed.", "author": "jbartok", "createdAt": "2020-05-04T10:16:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI3OTk4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MDg5OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418280899", "bodyText": "does this mean we lose the history once the job stops / is suspended? how is this used?", "author": "cangencer", "createdAt": "2020-04-30T20:50:11Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/HazelcastListDatabaseHistory.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.instance.impl.HazelcastInstanceFactory;\n+import io.debezium.config.Configuration;\n+import io.debezium.document.Document;\n+import io.debezium.document.DocumentReader;\n+import io.debezium.document.DocumentWriter;\n+import io.debezium.relational.history.AbstractDatabaseHistory;\n+import io.debezium.relational.history.DatabaseHistoryException;\n+import io.debezium.relational.history.DatabaseHistoryListener;\n+import io.debezium.relational.history.HistoryRecord;\n+import io.debezium.relational.history.HistoryRecordComparator;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Database history implementation backed by Hazelcast IList {@link IList}.\n+ *\n+ * @since 4.2\n+ */\n+public class HazelcastListDatabaseHistory extends AbstractDatabaseHistory {\n+\n+    /**\n+     * Hazelcast IList {@link IList} name property.\n+     */\n+    public static final String LIST_NAME_PROPERTY = \"database.history.hazelcast.list.name\";\n+\n+    private volatile String instanceName;\n+    private volatile String listName;\n+\n+    private volatile IList<byte[]> list;\n+\n+    @Override\n+    public void configure(Configuration config, HistoryRecordComparator comparator,\n+                          DatabaseHistoryListener listener, boolean useCatalogBeforeSchema) {\n+        super.configure(config, comparator, listener, useCatalogBeforeSchema);\n+\n+        instanceName = config.getString(\"database.history.hazelcast.instance.name\");\n+        Objects.requireNonNull(instanceName, \"instance name\");\n+\n+        listName = config.getString(LIST_NAME_PROPERTY);\n+        Objects.requireNonNull(listName, \"list name\");\n+    }\n+\n+    @Override\n+    public void start() {\n+        super.start();\n+\n+        HazelcastInstance instance = HazelcastInstanceFactory.getHazelcastInstance(instanceName);\n+        list = instance.getList(listName);\n+    }\n+\n+\n+    @Override\n+    protected void storeRecord(HistoryRecord historyRecord) throws DatabaseHistoryException {\n+        list.add(DocumentWriter.defaultWriter().writeAsBytes(historyRecord.document()));\n+    }\n+\n+    @Override\n+    protected void recoverRecords(Consumer<HistoryRecord> consumer) {\n+        try {\n+            for (byte[] r : list) {\n+                Document doc = DocumentReader.defaultReader().read(r);\n+                consumer.accept(new HistoryRecord(doc));\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @Override\n+    public void stop() {\n+        super.stop();\n+        list.destroy();", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4MjY1Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419382656", "bodyText": "Yeah, this was wrong. I've lost test I had for job restart when I've split the PR branch in two. Have put it back now. For now I've removed the list.destroy() from the above stop() method. It works properly now, but there is again no clean-up for the list. Have to think about that a bit more, figure out what to do.", "author": "jbartok", "createdAt": "2020-05-04T11:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MDg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM5MzM1NQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419393355", "bodyText": "I think I'll have to give these lists a job specific name and clean them up the same way snapshot maps are cleaned up in JobRepository.cleanup(). Let's see, will reexamine with a fresh mind.", "author": "jbartok", "createdAt": "2020-05-04T12:18:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MDg5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkxMjA4Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419912086", "bodyText": "I have implemented the above solution (based on the assumption that the source should have the same life-cycle as the Jet job): the lists have a job specific name now and will be cleaned up by the periodic scan implemented in JobRepository.cleanup(), once the job is no longer active. Pls. review this specifically (last commit).", "author": "jbartok", "createdAt": "2020-05-05T07:25:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MDg5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MTUzNw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418281537", "bodyText": "whats smt?", "author": "cangencer", "createdAt": "2020-04-30T20:51:32Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/CdcSource.java", "diffHunk": "@@ -0,0 +1,201 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.instance.impl.HazelcastInstanceFactory;\n+import com.hazelcast.jet.JetInstance;\n+import com.hazelcast.jet.cdc.ChangeEvent;\n+import com.hazelcast.jet.core.Processor;\n+import com.hazelcast.jet.pipeline.SourceBuilder;\n+import io.debezium.transforms.ExtractNewRecordState;\n+import org.apache.kafka.connect.connector.ConnectorContext;\n+import org.apache.kafka.connect.data.Struct;\n+import org.apache.kafka.connect.data.Values;\n+import org.apache.kafka.connect.source.SourceConnector;\n+import org.apache.kafka.connect.source.SourceRecord;\n+import org.apache.kafka.connect.source.SourceTask;\n+import org.apache.kafka.connect.source.SourceTaskContext;\n+import org.apache.kafka.connect.storage.OffsetStorageReader;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import static com.hazelcast.jet.impl.util.ExceptionUtil.rethrow;\n+\n+class CdcSource {\n+\n+    private final SourceConnector connector;\n+    private final SourceTask task;\n+    private final Map<String, String> taskConfig;\n+    private final ExtractNewRecordState<SourceRecord> smt;", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTMzODI3MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419338270", "bodyText": "Single Message Transform (https://docs.confluent.io/current/connect/transforms/index.html), but yeah, I see what you mean, no point in being cryptic in the code. Will rename it.", "author": "jbartok", "createdAt": "2020-05-04T10:18:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI4MTUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ1OTg3Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418459873", "bodyText": "we can keep this as toString()", "author": "cangencer", "createdAt": "2020-05-01T08:25:22Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/ChangeEvent.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nonnull;\n+\n+/**\n+ * Information pertaining to a single data change event (insertion,\n+ * delete or update), affecting either a single database record (in the\n+ * case of relational databases) or document (in the case of NoSQL\n+ * databases).\n+ * <p>\n+ * Each event has a <i>key</i>, which identifies the particular record\n+ * or document being affected, and a <i>value</i>, which describes the\n+ * actual change itself.\n+ * <p>\n+ * Most events have an <i>operation</i> associated with them which\n+ * specifies the type of change being described (insertion, delete or\n+ * update). This is really a property of the value, it's only replicated\n+ * at this level for convenience. Only some special events, like\n+ * heartbeats don't have an operation value. (Heartbeat events are not\n+ * something we encourage the usage of, but since no functionality of\n+ * the underlying Debezium connectors is disabled they are still\n+ * theoretically possible to enable and be observed in Jet.)\n+ * <p>\n+ * There is also a <i>timestamp</i> which specifies the moment in time\n+ * when the event happened. This timestamp is \"real\" in the sense that\n+ * it comes from the database change-log, so it's not \"processing time\",\n+ * it's not the moment when the event was observed by our system. Keep\n+ * in mind though that not all events come from the change-log. The\n+ * change-log goes back in time only to a limited extent, all older\n+ * events are parts of a database snapshot constructed when we start\n+ * monitoring the database and their timestamps are accordingly\n+ * artificial. Identifying snapshot events is possible most of the time,\n+ * because their operation will be {@link Operation#SYNC} instead of\n+ * {@link Operation#INSERT} (one notable exception being MySQL).\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public interface ChangeEvent {\n+\n+    /**\n+     * Specifies the moment in time when the event happened. This\n+     * timestamp is \"real\" in the sense that it comes from the database\n+     * change-log, so it's not \"processing time\", it's not the moment\n+     * when the event was observed by our system. Keep in mind though\n+     * that not all events come from the change-log. The change-log goes\n+     * back in time only to a limited extent, all older events are parts\n+     * of a database snapshot constructed when we start monitoring the\n+     * database and their timestamps are accordingly artificial.\n+     * Identifying snapshot events is possible most of the time, because\n+     * their operation will be {@link Operation#SYNC} instead of\n+     * {@link Operation#INSERT} (one notable exception being MySQL).\n+     *\n+     * @throws ParsingException if no parsable timestamp field present\n+     */\n+    long timestamp() throws ParsingException;\n+\n+    /**\n+     * Specifies the type of change being described (insertion, delete or\n+     * update). Only some special events, like heartbeats don't have an\n+     * operation value.\n+     *\n+     * @return {@link Operation#UNSPECIFIED} if this {@code ChangeEventValue}\n+     * doesn't have an operation field or appropriate {@link Operation}\n+     * that matches what's found in the operation field\n+     * @throws ParsingException if there is an operation field, but it's\n+     *                          value is not among the handled ones.\n+     */\n+    @Nonnull\n+    Operation operation() throws ParsingException;\n+\n+    /**\n+     * Identifies the particular record or document being affected\n+     * by the change event.\n+     */\n+    @Nonnull\n+    ChangeEventElement key();\n+\n+    /**\n+     * Describes the actual change affected on the record or document\n+     * by the change event.\n+     */\n+    @Nonnull\n+    ChangeEventElement value();\n+\n+    /**\n+     * Returns raw JSON string which the content of this event is\n+     * based on. Mean to be used when higher level parsing (see other\n+     * methods) fails for some reason (for example on some untested\n+     * DB-connector version combination).\n+     */\n+    @Nonnull\n+    String asJson();", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2MTM0Mw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r418461343", "bodyText": "seems now you have to pay cost of comparison twice: once per figuring out the string mapping, and then the other conditional operation you will do for the operation. Why not just publish it as string and refer to constants?", "author": "cangencer", "createdAt": "2020-05-01T08:31:07Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/Operation.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nullable;\n+import java.util.Objects;\n+\n+/**\n+ * Describes the nature of the event in CDC data. Equivalent to various\n+ * actions that can affect a database record: insertion, update and\n+ * deletion. Has some extra special values like \"sync\" which is just\n+ * like an insert, but originates from a database snapshot (as opposed\n+ * database changelog) and \"unspecified\" which is used for a few special\n+ * CDC events, like heartbeats.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public enum Operation {\n+    /**\n+     * Change event doesn't have an operation field, for example\n+     * heartbeats.\n+     */\n+    UNSPECIFIED(null),\n+    /**\n+     * Just like {@link #INSERT}, but coming from the DB snapshot (as\n+     * opposed to trailing the DB changelog).\n+     */\n+    SYNC(\"r\"),\n+    /**\n+     * Record insertion, sourced from the DB changelog.\n+     */\n+    INSERT(\"c\"),\n+    /**\n+     * Record update, sourced from the DB changelog.\n+     */\n+    UPDATE(\"u\"),\n+    /**\n+     * Record deletion, sourced from the DB changelog.\n+     */\n+    DELETE(\"d\");\n+\n+    private final String id;\n+\n+    Operation(String id) {\n+        this.id = id;\n+    }\n+\n+    /**\n+     * Parses the string constants used in CDC messages for describing\n+     * operations into enum instances.\n+     * <p>\n+     * Null will be parsed as {@link #UNSPECIFIED}.\n+     *\n+     * @throws ParsingException if the input string doesn't represent\n+     * an expected value.\n+     */\n+    public static Operation get(@Nullable String id) throws ParsingException {\n+        Operation[] values = values();", "originalCommit": "3231a8abfab24e8bbb632e748f45add4a94ba39b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM4ODk1MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r419388950", "bodyText": "I've tried a couple of versions, but I couldn't find one that I liked... Considering that the calls in questions will be made only on demand and that the operation values doesn't play any part in serde either, I'm leaning towards keeping it as is, for the moment. Will give it another look tomorrow, with a fresh mind.", "author": "jbartok", "createdAt": "2020-05-04T12:09:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2MTM0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0NDE1NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420044154", "bodyText": "What was about it that you didn't like? I think you'll be creating more garbage by creating the extra Operation objects, without adding much value. When used with the map sink for example you'll need to do conditional operations on it.", "author": "cangencer", "createdAt": "2020-05-05T11:39:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2MTM0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwNTk0OA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420605948", "bodyText": "Index based lookup in array type of solution is pushed (and benchmarked).", "author": "jbartok", "createdAt": "2020-05-06T07:53:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQ2MTM0Mw=="}], "type": "inlineReview"}, {"oid": "abb9b10b101adf34fa83b308a8074c1a9e83e927", "url": "https://github.com/hazelcast/hazelcast-jet/commit/abb9b10b101adf34fa83b308a8074c1a9e83e927", "message": "Update javadoc", "committedDate": "2020-05-04T07:40:18Z", "type": "commit"}, {"oid": "6d4a1f3bcc0ec9719543fa107e4142ec8f36e6a9", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6d4a1f3bcc0ec9719543fa107e4142ec8f36e6a9", "message": "Rename 'event' to 'record'", "committedDate": "2020-05-04T08:38:03Z", "type": "commit"}, {"oid": "ae9aff20224c34e50bfd5aafc6411e281b26f7e7", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ae9aff20224c34e50bfd5aafc6411e281b26f7e7", "message": "Replace inheritance with delegation in builders", "committedDate": "2020-05-04T10:11:22Z", "type": "commit"}, {"oid": "1cfe97707123336b1c1ee91c9ea6e79d5256291b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/1cfe97707123336b1c1ee91c9ea6e79d5256291b", "message": "Rename methods", "committedDate": "2020-05-04T10:13:56Z", "type": "commit"}, {"oid": "2ef49b1b60893b03cbe78c45f08dd670cdc98163", "url": "https://github.com/hazelcast/hazelcast-jet/commit/2ef49b1b60893b03cbe78c45f08dd670cdc98163", "message": "Rename internal transform", "committedDate": "2020-05-04T10:46:45Z", "type": "commit"}, {"oid": "dd9c80653aedfa24b0db2a67f0d2007bf20ceecb", "url": "https://github.com/hazelcast/hazelcast-jet/commit/dd9c80653aedfa24b0db2a67f0d2007bf20ceecb", "message": "Use Log4j 2 SLF4J Binding for connector logging", "committedDate": "2020-05-04T10:47:17Z", "type": "commit"}, {"oid": "46e2fb792ae26f5084a702e189c144ab2cf08d20", "url": "https://github.com/hazelcast/hazelcast-jet/commit/46e2fb792ae26f5084a702e189c144ab2cf08d20", "message": "Add test for job restart, fix schema history", "committedDate": "2020-05-04T11:53:44Z", "type": "commit"}, {"oid": "7a0ccab3892a1a2897411e041e52ab06acafb4a3", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7a0ccab3892a1a2897411e041e52ab06acafb4a3", "message": "Implement clean-up for db history lists", "committedDate": "2020-05-05T07:33:10Z", "type": "commit"}, {"oid": "7a0ccab3892a1a2897411e041e52ab06acafb4a3", "url": "https://github.com/hazelcast/hazelcast-jet/commit/7a0ccab3892a1a2897411e041e52ab06acafb4a3", "message": "Implement clean-up for db history lists", "committedDate": "2020-05-05T07:33:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0NDQ4OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420044489", "bodyText": "the names here don't seem aligned with the actual types", "author": "cangencer", "createdAt": "2020-05-05T11:40:03Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/CdcJsonDataSerializerHook.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.internal.serialization.DataSerializerHook;\n+import com.hazelcast.internal.serialization.impl.FactoryIdHelper;\n+import com.hazelcast.nio.serialization.DataSerializableFactory;\n+import com.hazelcast.nio.serialization.IdentifiedDataSerializable;\n+\n+import static com.hazelcast.jet.impl.JetFactoryIdHelper.JET_CDC_JSON_DS_FACTORY;\n+import static com.hazelcast.jet.impl.JetFactoryIdHelper.JET_CDC_JSON_DS_FACTORY_ID;\n+\n+public class CdcJsonDataSerializerHook implements DataSerializerHook {\n+\n+    public static final int ELEMENT = 1;\n+    public static final int EVENT = 2;\n+\n+    public static final int FACTORY_ID = FactoryIdHelper.getFactoryId(JET_CDC_JSON_DS_FACTORY, JET_CDC_JSON_DS_FACTORY_ID);\n+\n+    @Override\n+    public int getFactoryId() {\n+        return FACTORY_ID;\n+    }\n+\n+    @Override\n+    public DataSerializableFactory createFactory() {\n+        return new Factory();\n+    }\n+\n+    private static class Factory implements DataSerializableFactory {\n+        @Override\n+        public IdentifiedDataSerializable create(int typeId) {\n+            switch (typeId) {\n+                case ELEMENT:", "originalCommit": "7a0ccab3892a1a2897411e041e52ab06acafb4a3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4004efb14b46259a2e67b588038c74b175ac1384", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4004efb14b46259a2e67b588038c74b175ac1384", "message": "Rename serialization related constants", "committedDate": "2020-05-06T06:23:52Z", "type": "commit"}, {"oid": "142b3f873cfad238c82b8dae21b19aa0eb038261", "url": "https://github.com/hazelcast/hazelcast-jet/commit/142b3f873cfad238c82b8dae21b19aa0eb038261", "message": "Optimize String -> Operation parsing", "committedDate": "2020-05-06T06:53:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwMDI1MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420600250", "bodyText": "I think you don't need offset here, just use an array of size [max] and you can skip the subtraction altogether, simplifying the code.", "author": "cangencer", "createdAt": "2020-05-06T07:41:41Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/Operation.java", "diffHunk": "@@ -0,0 +1,113 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Describes the nature of the event in CDC data. Equivalent to various\n+ * actions that can affect a database record: insertion, update and\n+ * deletion. Has some extra special values like \"sync\" which is just\n+ * like an insert, but originates from a database snapshot (as opposed\n+ * database changelog) and \"unspecified\" which is used for a few special\n+ * CDC events, like heartbeats.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public enum Operation {\n+    /**\n+     * {@code ChangeRecord} doesn't have an operation field, for example\n+     * heartbeats.\n+     */\n+    UNSPECIFIED(null),\n+    /**\n+     * Just like {@link #INSERT}, but coming from the DB snapshot (as\n+     * opposed to trailing the DB changelog).\n+     */\n+    SYNC('r'),\n+    /**\n+     * Record insertion, sourced from the DB changelog.\n+     */\n+    INSERT('c'),\n+    /**\n+     * Record update, sourced from the DB changelog.\n+     */\n+    UPDATE('u'),\n+    /**\n+     * Record deletion, sourced from the DB changelog.\n+     */\n+    DELETE('d');\n+\n+    private static final int OFFSET;\n+    private static final Operation[] ARRAY;\n+\n+    static {\n+        int min = Character.MAX_VALUE;\n+        int max = Character.MIN_VALUE;\n+        for (Operation op : values()) {\n+            if (op.id == null) {\n+                continue;\n+            }\n+            min = op.id < min ? op.id : min;\n+            max = op.id > max ? op.id : max;\n+        }\n+\n+        OFFSET = min;\n+\n+        ARRAY = new Operation[max - min + 1];\n+        for (Operation op : values()) {\n+            if (op.id == null) {\n+                continue;\n+            }\n+            ARRAY[op.id - OFFSET] = op;\n+        }\n+    }\n+\n+    private final Character id;\n+\n+    Operation(Character id) {\n+        this.id = id;\n+    }\n+\n+    /**\n+     * Parses the string constants used in CDC messages for describing\n+     * operations into enum instances.\n+     * <p>\n+     * Null will be parsed as {@link #UNSPECIFIED}.\n+     *\n+     * @throws ParsingException if the input string doesn't represent\n+     * an expected value.\n+     */\n+    public static Operation get(@Nullable String string) throws ParsingException {\n+        if (string == null) {\n+            return UNSPECIFIED;\n+        }\n+\n+        if (string.length() == 1) {\n+            char id = string.charAt(0);\n+            Operation op = ARRAY[id - OFFSET];", "originalCommit": "142b3f873cfad238c82b8dae21b19aa0eb038261", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwNjI4MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420606281", "bodyText": "Ok", "author": "jbartok", "createdAt": "2020-05-06T07:53:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwMDI1MA=="}], "type": "inlineReview"}, {"oid": "511993f0bd20b804e8fbf195312815cdb33e2478", "url": "https://github.com/hazelcast/hazelcast-jet/commit/511993f0bd20b804e8fbf195312815cdb33e2478", "message": "Optimize String -> Operation parsing", "committedDate": "2020-05-06T07:44:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwMTAzOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420601038", "bodyText": "does these need to be volatile? probably not?", "author": "cangencer", "createdAt": "2020-05-06T07:43:18Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/HazelcastListDatabaseHistory.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.collection.IList;\n+import com.hazelcast.core.HazelcastInstance;\n+import com.hazelcast.instance.impl.HazelcastInstanceFactory;\n+import io.debezium.config.Configuration;\n+import io.debezium.document.Document;\n+import io.debezium.document.DocumentReader;\n+import io.debezium.document.DocumentWriter;\n+import io.debezium.relational.history.AbstractDatabaseHistory;\n+import io.debezium.relational.history.DatabaseHistoryException;\n+import io.debezium.relational.history.DatabaseHistoryListener;\n+import io.debezium.relational.history.HistoryRecord;\n+import io.debezium.relational.history.HistoryRecordComparator;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Database history implementation backed by Hazelcast IList {@link IList}.\n+ *\n+ * @since 4.2\n+ */\n+public class HazelcastListDatabaseHistory extends AbstractDatabaseHistory {\n+\n+    private volatile String instanceName;\n+    private volatile String listName;\n+\n+    private volatile IList<byte[]> list;", "originalCommit": "142b3f873cfad238c82b8dae21b19aa0eb038261", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDY0MzYyNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420643625", "bodyText": "Is read and written by different threads and not safely published. But anyways, let's see if we can move this whole thing into the snapshot.", "author": "jbartok", "createdAt": "2020-05-06T09:02:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwMTAzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MDM1MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420740350", "bodyText": "Have made the schema history part of the snapshot. There are two relatively shady parts in the change, I would be thankful if you would take a look at those:\n\n\nsee how I use DatabaseHistoryImpl.container().setHistory(...) to pass the right record list to DatabaseHistoryImpl; DatabaseHistoryImpl gets initilized by the surrounded SourceTask.start(...) and this happens on a blocking worker thread\n\n\nin CdcSource.State I've used a CopyOnWriteArrayList for the schema history; the reasoning here was that items get added to this list on some internal debezium snapshot thread, while restore and our snapshotting reads it on a blocking worker thread, so I need to ensure proper visibility + the list is written only on schema changes, which should be a rare event after the initial db snapshot so the garbage created should be a one-time hit; I think it's correct, but doesn't feel right so I'm open to suggestions...", "author": "jbartok", "createdAt": "2020-05-06T12:10:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYwMTAzOA=="}], "type": "inlineReview"}, {"oid": "8b2b06ce6ccbd933c3fddf1f4df579a6f1ea2b2a", "url": "https://github.com/hazelcast/hazelcast-jet/commit/8b2b06ce6ccbd933c3fddf1f4df579a6f1ea2b2a", "message": "Optimize String -> Operation parsing", "committedDate": "2020-05-06T08:33:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYyNTA1NA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420625054", "bodyText": "Maybe some nicer name instead of string? Like a name for the field in CDC terminology.", "author": "mtopolnik", "createdAt": "2020-05-06T08:29:49Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/Operation.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Describes the nature of the event in CDC data. Equivalent to various\n+ * actions that can affect a database record: insertion, update and\n+ * deletion. Has some extra special values like \"sync\" which is just\n+ * like an insert, but originates from a database snapshot (as opposed\n+ * database changelog) and \"unspecified\" which is used for a few special\n+ * CDC events, like heartbeats.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public enum Operation {\n+    /**\n+     * {@code ChangeRecord} doesn't have an operation field, for example\n+     * heartbeats.\n+     */\n+    UNSPECIFIED(null),\n+    /**\n+     * Just like {@link #INSERT}, but coming from the DB snapshot (as\n+     * opposed to trailing the DB changelog).\n+     */\n+    SYNC('r'),\n+    /**\n+     * Record insertion, sourced from the DB changelog.\n+     */\n+    INSERT('c'),\n+    /**\n+     * Record update, sourced from the DB changelog.\n+     */\n+    UPDATE('u'),\n+    /**\n+     * Record deletion, sourced from the DB changelog.\n+     */\n+    DELETE('d');\n+\n+    private final Character id;\n+\n+    Operation(Character id) {\n+        this.id = id;\n+    }\n+\n+    /**\n+     * Parses the string constants used in CDC messages for describing\n+     * operations into enum instances.\n+     * <p>\n+     * Null will be parsed as {@link #UNSPECIFIED}.\n+     *\n+     * @throws ParsingException if the input string doesn't represent\n+     * an expected value.\n+     */\n+    public static Operation get(@Nullable String string) throws ParsingException {", "originalCommit": "511993f0bd20b804e8fbf195312815cdb33e2478", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDYzMDMyOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420630328", "bodyText": "This can throw ArrayIndexOutOfBoundsException. We should have a unit test that catches these problems.", "author": "mtopolnik", "createdAt": "2020-05-06T08:39:04Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/Operation.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.jet.annotation.EvolvingApi;\n+\n+import javax.annotation.Nullable;\n+\n+/**\n+ * Describes the nature of the event in CDC data. Equivalent to various\n+ * actions that can affect a database record: insertion, update and\n+ * deletion. Has some extra special values like \"sync\" which is just\n+ * like an insert, but originates from a database snapshot (as opposed\n+ * database changelog) and \"unspecified\" which is used for a few special\n+ * CDC events, like heartbeats.\n+ *\n+ * @since 4.2\n+ */\n+@EvolvingApi\n+public enum Operation {\n+    /**\n+     * {@code ChangeRecord} doesn't have an operation field, for example\n+     * heartbeats.\n+     */\n+    UNSPECIFIED(null),\n+    /**\n+     * Just like {@link #INSERT}, but coming from the DB snapshot (as\n+     * opposed to trailing the DB changelog).\n+     */\n+    SYNC('r'),\n+    /**\n+     * Record insertion, sourced from the DB changelog.\n+     */\n+    INSERT('c'),\n+    /**\n+     * Record update, sourced from the DB changelog.\n+     */\n+    UPDATE('u'),\n+    /**\n+     * Record deletion, sourced from the DB changelog.\n+     */\n+    DELETE('d');\n+\n+    private final Character id;\n+\n+    Operation(Character id) {\n+        this.id = id;\n+    }\n+\n+    /**\n+     * Parses the string constants used in CDC messages for describing\n+     * operations into enum instances.\n+     * <p>\n+     * Null will be parsed as {@link #UNSPECIFIED}.\n+     *\n+     * @throws ParsingException if the input string doesn't represent\n+     * an expected value.\n+     */\n+    public static Operation get(@Nullable String string) throws ParsingException {\n+        if (string == null) {\n+            return UNSPECIFIED;\n+        }\n+\n+        if (string.length() == 1) {\n+            char id = string.charAt(0);\n+            Operation op = Lookup.get(id);\n+            if (op != null) {\n+                return op;\n+            }\n+        }\n+\n+        throw new ParsingException(\"'\" + string + \"' is not a valid operation id\");\n+    }\n+\n+    private static class Lookup {\n+\n+        private static final int OFFSET;\n+        private static final Operation[] ARRAY;\n+\n+        static {\n+            int min = Character.MAX_VALUE;\n+            int max = Character.MIN_VALUE;\n+            for (Operation op : values()) {\n+                if (op.id == null) {\n+                    continue;\n+                }\n+                min = op.id < min ? op.id : min;\n+                max = op.id > max ? op.id : max;\n+            }\n+\n+            OFFSET = min;\n+\n+            ARRAY = new Operation[max - min + 1];\n+            for (Operation op : values()) {\n+                if (op.id == null) {\n+                    continue;\n+                }\n+                ARRAY[op.id - OFFSET] = op;\n+            }\n+        }\n+\n+        static Operation get(char id) {", "originalCommit": "511993f0bd20b804e8fbf195312815cdb33e2478", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c0a7130f19b510c289f73133bcb723bdd9065fe6", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c0a7130f19b510c289f73133bcb723bdd9065fe6", "message": "Fix String -> Operation parsing", "committedDate": "2020-05-06T09:00:59Z", "type": "commit"}, {"oid": "46a5bcdfc31d1fa52d0eb0e4a2f4042f64edc123", "url": "https://github.com/hazelcast/hazelcast-jet/commit/46a5bcdfc31d1fa52d0eb0e4a2f4042f64edc123", "message": "Further refine String -> Operation parsing", "committedDate": "2020-05-06T10:14:42Z", "type": "commit"}, {"oid": "3242edabdbe3acb8815f297119c4c2c7dc71da25", "url": "https://github.com/hazelcast/hazelcast-jet/commit/3242edabdbe3acb8815f297119c4c2c7dc71da25", "message": "Add missing copyright notice", "committedDate": "2020-05-06T10:17:26Z", "type": "commit"}, {"oid": "035b8e3a37961616a6609b15de87408eba879a0f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/035b8e3a37961616a6609b15de87408eba879a0f", "message": "Make schema history part of the snapshot", "committedDate": "2020-05-06T11:59:19Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1NTI5MQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420755291", "bodyText": "you can use writeObject to write a List.", "author": "cangencer", "createdAt": "2020-05-06T12:35:58Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/CdcSource.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.jet.cdc.ChangeRecord;\n+import com.hazelcast.jet.pipeline.SourceBuilder;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.IdentifiedDataSerializable;\n+import io.debezium.transforms.ExtractNewRecordState;\n+import org.apache.kafka.connect.connector.ConnectorContext;\n+import org.apache.kafka.connect.data.Struct;\n+import org.apache.kafka.connect.data.Values;\n+import org.apache.kafka.connect.source.SourceConnector;\n+import org.apache.kafka.connect.source.SourceRecord;\n+import org.apache.kafka.connect.source.SourceTask;\n+import org.apache.kafka.connect.source.SourceTaskContext;\n+import org.apache.kafka.connect.storage.OffsetStorageReader;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import static com.hazelcast.jet.impl.util.ExceptionUtil.rethrow;\n+\n+public class CdcSource {\n+\n+    private final SourceConnector connector;\n+    private final SourceTask task;\n+    private final Map<String, String> taskConfig;\n+    private final ExtractNewRecordState<SourceRecord> transform;\n+\n+    private State state = new State();\n+    private boolean taskInit;\n+\n+    CdcSource(Properties properties) {\n+        try {\n+            String connectorClazz = properties.getProperty(\"connector.class\");\n+            Class<?> connectorClass = Thread.currentThread().getContextClassLoader().loadClass(connectorClazz);\n+            connector = (SourceConnector) connectorClass.getConstructor().newInstance();\n+            connector.initialize(new JetConnectorContext());\n+            connector.start((Map) properties);\n+\n+            transform = initTransform();\n+\n+            taskConfig = connector.taskConfigs(1).get(0);\n+            task = (SourceTask) connector.taskClass().getConstructor().newInstance();\n+        } catch (Exception e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    public void fillBuffer(SourceBuilder.TimestampedSourceBuffer<ChangeRecord> buf) {\n+        if (!taskInit) {\n+            task.initialize(new JetSourceTaskContext());\n+            DatabaseHistoryImpl.container().setHistory(state.getHistoryRecords());\n+            task.start(taskConfig);\n+            DatabaseHistoryImpl.container().setHistory(null);\n+            taskInit = true;\n+        }\n+        try {\n+            List<SourceRecord> records = task.poll();\n+            if (records == null) {\n+                return;\n+            }\n+\n+            for (SourceRecord record : records) {\n+                boolean added = addToBuffer(record, buf);\n+                if (added) {\n+                    state.setOffset(record.sourcePartition(), record.sourceOffset());\n+                }\n+            }\n+        } catch (InterruptedException e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    private boolean addToBuffer(SourceRecord sourceRecord, SourceBuilder.TimestampedSourceBuffer<ChangeRecord> buf) {\n+        sourceRecord = transform.apply(sourceRecord);\n+        if (sourceRecord != null) {\n+            ChangeRecord changeRecord = toChangeRecord(sourceRecord);\n+            long timestamp = extractTimestamp(sourceRecord);\n+            buf.add(changeRecord, timestamp);\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    public void destroy() {\n+        try {\n+            task.stop();\n+        } finally {\n+            connector.stop();\n+        }\n+    }\n+\n+    public State createSnapshot() {\n+        return state;\n+    }\n+\n+    public void restoreSnapshot(List<State> snapshots) {\n+        this.state = snapshots.get(0);\n+    }\n+\n+    private static ExtractNewRecordState<SourceRecord> initTransform() {\n+        ExtractNewRecordState<SourceRecord> transform = new ExtractNewRecordState<>();\n+\n+        Map<String, String> config = new HashMap<>();\n+        config.put(\"add.fields\", \"op, ts_ms\");\n+        config.put(\"delete.handling.mode\", \"rewrite\");\n+        transform.configure(config);\n+\n+        return transform;\n+    }\n+\n+    private static ChangeRecord toChangeRecord(SourceRecord record) {\n+        String keyJson = Values.convertToString(record.keySchema(), record.key());\n+        String valueJson = Values.convertToString(record.valueSchema(), record.value());\n+        return new ChangeRecordImpl(keyJson, valueJson);\n+    }\n+\n+    private static long extractTimestamp(SourceRecord record) {\n+        if (record.valueSchema().field(\"__ts_ms\") == null) {\n+            return 0L;\n+        } else {\n+            return ((Struct) record.value()).getInt64(\"__ts_ms\");\n+        }\n+    }\n+\n+    private class JetSourceTaskContext implements SourceTaskContext {\n+        @Override\n+        public Map<String, String> configs() {\n+            return taskConfig;\n+        }\n+\n+        @Override\n+        public OffsetStorageReader offsetStorageReader() {\n+            return new SourceOffsetStorageReader();\n+        }\n+    }\n+\n+    private class SourceOffsetStorageReader implements OffsetStorageReader {\n+        @Override\n+        public <V> Map<String, Object> offset(Map<String, V> partition) {\n+            return offsets(Collections.singletonList(partition)).get(partition);\n+        }\n+\n+        @Override\n+        public <V> Map<Map<String, V>, Map<String, Object>> offsets(Collection<Map<String, V>> partitions) {\n+            Map<Map<String, V>, Map<String, Object>> map = new HashMap<>();\n+            for (Map<String, V> partition : partitions) {\n+                Map<String, Object> offset = (Map<String, Object>) state.getOffset(partition);\n+                map.put(partition, offset);\n+            }\n+            return map;\n+        }\n+    }\n+\n+    private static class JetConnectorContext implements ConnectorContext {\n+        @Override\n+        public void requestTaskReconfiguration() {\n+            // no-op since it is not supported\n+        }\n+\n+        @Override\n+        public void raiseError(Exception e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    public static final class State implements IdentifiedDataSerializable {\n+\n+        /**\n+         * Key represents the partition which the record originated from. Value\n+         * represents the offset within that partition. Kafka Connect represents\n+         * the partition and offset as arbitrary values so that is why it is\n+         * stored as map.\n+         * See {@link SourceRecord} for more information regarding the format.\n+         */\n+        private final Map<Map<String, ?>, Map<String, ?>> partitionsToOffset = new HashMap<>();\n+        private final List<byte[]> historyRecords = new CopyOnWriteArrayList<>();\n+\n+        public Map<String, ?> getOffset(Map<String, ?> partition) {\n+            return partitionsToOffset.get(partition);\n+        }\n+\n+        public void setOffset(Map<String, ?> partition, Map<String, ?> offset) {\n+            partitionsToOffset.put(partition, offset);\n+        }\n+\n+        public List<byte[]> getHistoryRecords() {\n+            return historyRecords;\n+        }\n+\n+        @Override\n+        public int getFactoryId() {\n+            return CdcJsonDataSerializerHook.FACTORY_ID;\n+        }\n+\n+        @Override\n+        public int getClassId() {\n+            return CdcJsonDataSerializerHook.SOURCE_STATE;\n+        }\n+\n+        @Override\n+        public void writeData(ObjectDataOutput out) throws IOException {\n+            out.writeObject(partitionsToOffset);\n+\n+            List<byte[]> records = historyRecords;", "originalCommit": "035b8e3a37961616a6609b15de87408eba879a0f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc2MzgyNA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420763824", "bodyText": "For some reason I though this would be more space-efficient, but I should have checked. Will revisit.", "author": "jbartok", "createdAt": "2020-05-06T12:50:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1NTI5MQ=="}], "type": "inlineReview"}, {"oid": "b00261a7956d9ec2cd3cc846ae0f6861fe7dd173", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b00261a7956d9ec2cd3cc846ae0f6861fe7dd173", "message": "simplify history", "committedDate": "2020-05-06T13:56:09Z", "type": "commit"}, {"oid": "b42cf0f367dd6476fb49938ac45231d9d975f67e", "url": "https://github.com/hazelcast/hazelcast-jet/commit/b42cf0f367dd6476fb49938ac45231d9d975f67e", "message": "minor cleanup", "committedDate": "2020-05-06T13:58:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1NzIxNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420757215", "bodyText": "should be clear this is a concurrentlist I think", "author": "cangencer", "createdAt": "2020-05-06T12:39:20Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/DatabaseHistoryImpl.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import io.debezium.document.Document;\n+import io.debezium.document.DocumentReader;\n+import io.debezium.document.DocumentWriter;\n+import io.debezium.relational.history.AbstractDatabaseHistory;\n+import io.debezium.relational.history.DatabaseHistoryException;\n+import io.debezium.relational.history.HistoryRecord;\n+\n+import javax.annotation.Nullable;\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+import java.util.function.Consumer;\n+\n+public class DatabaseHistoryImpl extends AbstractDatabaseHistory {\n+\n+    private static final ThreadLocal<Container> CONTEXT = ThreadLocal.withInitial(Container::new);\n+\n+    private final List<byte[]> history;", "originalCommit": "035b8e3a37961616a6609b15de87408eba879a0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc1OTI0Nw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r420759247", "bodyText": "you don't need this method because it's nested class", "author": "cangencer", "createdAt": "2020-05-06T12:42:43Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/CdcSource.java", "diffHunk": "@@ -0,0 +1,248 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.jet.cdc.ChangeRecord;\n+import com.hazelcast.jet.pipeline.SourceBuilder;\n+import com.hazelcast.nio.ObjectDataInput;\n+import com.hazelcast.nio.ObjectDataOutput;\n+import com.hazelcast.nio.serialization.IdentifiedDataSerializable;\n+import io.debezium.transforms.ExtractNewRecordState;\n+import org.apache.kafka.connect.connector.ConnectorContext;\n+import org.apache.kafka.connect.data.Struct;\n+import org.apache.kafka.connect.data.Values;\n+import org.apache.kafka.connect.source.SourceConnector;\n+import org.apache.kafka.connect.source.SourceRecord;\n+import org.apache.kafka.connect.source.SourceTask;\n+import org.apache.kafka.connect.source.SourceTaskContext;\n+import org.apache.kafka.connect.storage.OffsetStorageReader;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Properties;\n+import java.util.concurrent.CopyOnWriteArrayList;\n+\n+import static com.hazelcast.jet.impl.util.ExceptionUtil.rethrow;\n+\n+public class CdcSource {\n+\n+    private final SourceConnector connector;\n+    private final SourceTask task;\n+    private final Map<String, String> taskConfig;\n+    private final ExtractNewRecordState<SourceRecord> transform;\n+\n+    private State state = new State();\n+    private boolean taskInit;\n+\n+    CdcSource(Properties properties) {\n+        try {\n+            String connectorClazz = properties.getProperty(\"connector.class\");\n+            Class<?> connectorClass = Thread.currentThread().getContextClassLoader().loadClass(connectorClazz);\n+            connector = (SourceConnector) connectorClass.getConstructor().newInstance();\n+            connector.initialize(new JetConnectorContext());\n+            connector.start((Map) properties);\n+\n+            transform = initTransform();\n+\n+            taskConfig = connector.taskConfigs(1).get(0);\n+            task = (SourceTask) connector.taskClass().getConstructor().newInstance();\n+        } catch (Exception e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    public void fillBuffer(SourceBuilder.TimestampedSourceBuffer<ChangeRecord> buf) {\n+        if (!taskInit) {\n+            task.initialize(new JetSourceTaskContext());\n+            DatabaseHistoryImpl.container().setHistory(state.getHistoryRecords());\n+            task.start(taskConfig);\n+            DatabaseHistoryImpl.container().setHistory(null);\n+            taskInit = true;\n+        }\n+        try {\n+            List<SourceRecord> records = task.poll();\n+            if (records == null) {\n+                return;\n+            }\n+\n+            for (SourceRecord record : records) {\n+                boolean added = addToBuffer(record, buf);\n+                if (added) {\n+                    state.setOffset(record.sourcePartition(), record.sourceOffset());\n+                }\n+            }\n+        } catch (InterruptedException e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    private boolean addToBuffer(SourceRecord sourceRecord, SourceBuilder.TimestampedSourceBuffer<ChangeRecord> buf) {\n+        sourceRecord = transform.apply(sourceRecord);\n+        if (sourceRecord != null) {\n+            ChangeRecord changeRecord = toChangeRecord(sourceRecord);\n+            long timestamp = extractTimestamp(sourceRecord);\n+            buf.add(changeRecord, timestamp);\n+            return true;\n+        }\n+        return false;\n+    }\n+\n+    public void destroy() {\n+        try {\n+            task.stop();\n+        } finally {\n+            connector.stop();\n+        }\n+    }\n+\n+    public State createSnapshot() {\n+        return state;\n+    }\n+\n+    public void restoreSnapshot(List<State> snapshots) {\n+        this.state = snapshots.get(0);\n+    }\n+\n+    private static ExtractNewRecordState<SourceRecord> initTransform() {\n+        ExtractNewRecordState<SourceRecord> transform = new ExtractNewRecordState<>();\n+\n+        Map<String, String> config = new HashMap<>();\n+        config.put(\"add.fields\", \"op, ts_ms\");\n+        config.put(\"delete.handling.mode\", \"rewrite\");\n+        transform.configure(config);\n+\n+        return transform;\n+    }\n+\n+    private static ChangeRecord toChangeRecord(SourceRecord record) {\n+        String keyJson = Values.convertToString(record.keySchema(), record.key());\n+        String valueJson = Values.convertToString(record.valueSchema(), record.value());\n+        return new ChangeRecordImpl(keyJson, valueJson);\n+    }\n+\n+    private static long extractTimestamp(SourceRecord record) {\n+        if (record.valueSchema().field(\"__ts_ms\") == null) {\n+            return 0L;\n+        } else {\n+            return ((Struct) record.value()).getInt64(\"__ts_ms\");\n+        }\n+    }\n+\n+    private class JetSourceTaskContext implements SourceTaskContext {\n+        @Override\n+        public Map<String, String> configs() {\n+            return taskConfig;\n+        }\n+\n+        @Override\n+        public OffsetStorageReader offsetStorageReader() {\n+            return new SourceOffsetStorageReader();\n+        }\n+    }\n+\n+    private class SourceOffsetStorageReader implements OffsetStorageReader {\n+        @Override\n+        public <V> Map<String, Object> offset(Map<String, V> partition) {\n+            return offsets(Collections.singletonList(partition)).get(partition);\n+        }\n+\n+        @Override\n+        public <V> Map<Map<String, V>, Map<String, Object>> offsets(Collection<Map<String, V>> partitions) {\n+            Map<Map<String, V>, Map<String, Object>> map = new HashMap<>();\n+            for (Map<String, V> partition : partitions) {\n+                Map<String, Object> offset = (Map<String, Object>) state.getOffset(partition);\n+                map.put(partition, offset);\n+            }\n+            return map;\n+        }\n+    }\n+\n+    private static class JetConnectorContext implements ConnectorContext {\n+        @Override\n+        public void requestTaskReconfiguration() {\n+            // no-op since it is not supported\n+        }\n+\n+        @Override\n+        public void raiseError(Exception e) {\n+            throw rethrow(e);\n+        }\n+    }\n+\n+    public static final class State implements IdentifiedDataSerializable {\n+\n+        /**\n+         * Key represents the partition which the record originated from. Value\n+         * represents the offset within that partition. Kafka Connect represents\n+         * the partition and offset as arbitrary values so that is why it is\n+         * stored as map.\n+         * See {@link SourceRecord} for more information regarding the format.\n+         */\n+        private final Map<Map<String, ?>, Map<String, ?>> partitionsToOffset = new HashMap<>();\n+        private final List<byte[]> historyRecords = new CopyOnWriteArrayList<>();\n+\n+        public Map<String, ?> getOffset(Map<String, ?> partition) {\n+            return partitionsToOffset.get(partition);\n+        }\n+\n+        public void setOffset(Map<String, ?> partition, Map<String, ?> offset) {\n+            partitionsToOffset.put(partition, offset);\n+        }\n+\n+        public List<byte[]> getHistoryRecords() {", "originalCommit": "035b8e3a37961616a6609b15de87408eba879a0f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5c43955ac0d66dc5831e983ed636af8189b147a1", "url": "https://github.com/hazelcast/hazelcast-jet/commit/5c43955ac0d66dc5831e983ed636af8189b147a1", "message": "Adjust latest refactorings", "committedDate": "2020-05-07T06:11:35Z", "type": "commit"}, {"oid": "6322f62bbb30693113e119e6f5646cba49214e49", "url": "https://github.com/hazelcast/hazelcast-jet/commit/6322f62bbb30693113e119e6f5646cba49214e49", "message": "Add comments to hacky code", "committedDate": "2020-05-07T06:21:06Z", "type": "commit"}, {"oid": "f663648d0e3852f5f66954de82a94806cf341e8b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/f663648d0e3852f5f66954de82a94806cf341e8b", "message": "Simplify serde code", "committedDate": "2020-05-07T07:01:57Z", "type": "commit"}, {"oid": "e33e623f886f6bf3b3c5303da56c1a0a0a508ba6", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e33e623f886f6bf3b3c5303da56c1a0a0a508ba6", "message": "Make cdc-mysql jar dependent on cdc-debezium to save space", "committedDate": "2020-05-07T10:04:38Z", "type": "commit"}, {"oid": "4af8765bc1e53dba2ba2aafa2d4186b0cd314c3f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/4af8765bc1e53dba2ba2aafa2d4186b0cd314c3f", "message": "Speed-up CDC tests", "committedDate": "2020-05-07T12:05:11Z", "type": "commit"}, {"oid": "5024333d501a5ad1b030d2ee204981877ce58550", "url": "https://github.com/hazelcast/hazelcast-jet/commit/5024333d501a5ad1b030d2ee204981877ce58550", "message": "Implement specialized CDC sinks", "committedDate": "2020-05-11T07:46:25Z", "type": "commit"}, {"oid": "0b6f9f6760b8c57acb8c1d9b74e3414e335f2000", "url": "https://github.com/hazelcast/hazelcast-jet/commit/0b6f9f6760b8c57acb8c1d9b74e3414e335f2000", "message": "Merge branch 'master' into cdc", "committedDate": "2020-05-11T07:55:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg1MDMxNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r422850315", "bodyText": "typo, remote", "author": "cangencer", "createdAt": "2020-05-11T07:52:59Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/CdcSinks.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.function.BiFunctionEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.impl.connector.HazelcastWriters;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.Sinks;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+import static com.hazelcast.jet.cdc.Operation.DELETE;\n+\n+/**\n+ * Contains factory methods for change data capture specific pipeline\n+ * sinks. As a consequence these sinks take {@link ChangeRecord} items\n+ * as their input.\n+ * <p>\n+ * The local parallelism for these sinks in this class is typically 1,\n+ * check the documentation of individual methods.\n+ *\n+ * @since 4.2\n+ */\n+public final class CdcSinks {\n+\n+    private static final int PREFERRED_LOCAL_PARALLELISM = 1;\n+\n+    private CdcSinks() {\n+    }\n+\n+    /**\n+     * Returns a sink which maintains an up-to-date image of a change\n+     * data capture stream in the form of an {@code IMap}. By image we\n+     * mean that the map should always escribe the end result of merging\n+     * all the change events seen so far.\n+     * <p>\n+     * For each item the sink receives it uses the {@code keyFn} to\n+     * determine which map key the change event applies to. Then, based\n+     * on the {@code ChangeRecord}'s {@code Operation} it determines\n+     * eiher to:\n+     * <ul>\n+     *   <li>delete the key from the map\n+     *          ({@link Operation#DELETE})</li>\n+     *   <li>insert a new value for the key\n+     *          ({@link Operation#SYNC} & {@link Operation#INSERT})</li>\n+     *   <li>update the current value for the key\n+     *          ({@link Operation#UPDATE})</li>\n+     * </ul>\n+     * For insert and update operations the new value to use is\n+     * determined from the input record by using the provided\n+     * {@code valueFn}. <strong>IMPORTANT</strong> to note that if the\n+     * {@code valueFn} returns {@code null}, then the key will be\n+     * deleted from the map no matter the operation (ie. even for update\n+     * and insert records).\n+     * <p>\n+     * For the functionality of this sink it is vital that the order of\n+     * the input items is preserved so the sink is non-distributed and\n+     * its local parallelism is forced to 1. This way only a single\n+     * instance will be created for each pipeline.\n+     *\n+     * @since 4.2\n+     */\n+    @Nonnull\n+    public static <K, V> Sink<ChangeRecord> map(\n+            @Nonnull String map,\n+            @Nonnull FunctionEx<ChangeRecord, K> keyFn,\n+            @Nonnull FunctionEx<ChangeRecord, V> valueFn\n+    ) {\n+        return Sinks.fromProcessor(\"localMapCdcSink(\" + map + ')',\n+                metaSupplier(map, null, keyFn, valueFn));\n+    }\n+\n+    /**\n+     * Returns a sink equivalent to {@link #map}, but for a map in a\n+     * remote Hazelcast cluster identified by the supplied {@code\n+     * ClientConfig}.\n+     * <p>\n+     * Due to the used API, the remote cluster must be at least 3.11.\n+     *\n+     * @since 4.2\n+     */\n+    @Nonnull\n+    public static <K, V> Sink<ChangeRecord> removeMap(", "originalCommit": "5024333d501a5ad1b030d2ee204981877ce58550", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMjg1MDQxNw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r422850417", "bodyText": "should also take a variant with IMap<K,V>", "author": "cangencer", "createdAt": "2020-05-11T07:53:11Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/CdcSinks.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc;\n+\n+import com.hazelcast.client.config.ClientConfig;\n+import com.hazelcast.function.BiFunctionEx;\n+import com.hazelcast.function.FunctionEx;\n+import com.hazelcast.jet.core.ProcessorMetaSupplier;\n+import com.hazelcast.jet.impl.connector.HazelcastWriters;\n+import com.hazelcast.jet.pipeline.Sink;\n+import com.hazelcast.jet.pipeline.Sinks;\n+\n+import javax.annotation.Nonnull;\n+import javax.annotation.Nullable;\n+\n+import static com.hazelcast.jet.cdc.Operation.DELETE;\n+\n+/**\n+ * Contains factory methods for change data capture specific pipeline\n+ * sinks. As a consequence these sinks take {@link ChangeRecord} items\n+ * as their input.\n+ * <p>\n+ * The local parallelism for these sinks in this class is typically 1,\n+ * check the documentation of individual methods.\n+ *\n+ * @since 4.2\n+ */\n+public final class CdcSinks {\n+\n+    private static final int PREFERRED_LOCAL_PARALLELISM = 1;\n+\n+    private CdcSinks() {\n+    }\n+\n+    /**\n+     * Returns a sink which maintains an up-to-date image of a change\n+     * data capture stream in the form of an {@code IMap}. By image we\n+     * mean that the map should always escribe the end result of merging\n+     * all the change events seen so far.\n+     * <p>\n+     * For each item the sink receives it uses the {@code keyFn} to\n+     * determine which map key the change event applies to. Then, based\n+     * on the {@code ChangeRecord}'s {@code Operation} it determines\n+     * eiher to:\n+     * <ul>\n+     *   <li>delete the key from the map\n+     *          ({@link Operation#DELETE})</li>\n+     *   <li>insert a new value for the key\n+     *          ({@link Operation#SYNC} & {@link Operation#INSERT})</li>\n+     *   <li>update the current value for the key\n+     *          ({@link Operation#UPDATE})</li>\n+     * </ul>\n+     * For insert and update operations the new value to use is\n+     * determined from the input record by using the provided\n+     * {@code valueFn}. <strong>IMPORTANT</strong> to note that if the\n+     * {@code valueFn} returns {@code null}, then the key will be\n+     * deleted from the map no matter the operation (ie. even for update\n+     * and insert records).\n+     * <p>\n+     * For the functionality of this sink it is vital that the order of\n+     * the input items is preserved so the sink is non-distributed and\n+     * its local parallelism is forced to 1. This way only a single\n+     * instance will be created for each pipeline.\n+     *\n+     * @since 4.2\n+     */\n+    @Nonnull\n+    public static <K, V> Sink<ChangeRecord> map(", "originalCommit": "5024333d501a5ad1b030d2ee204981877ce58550", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "79dfb6ae0d6aafcec4d649dd4f8d7821db52b06c", "url": "https://github.com/hazelcast/hazelcast-jet/commit/79dfb6ae0d6aafcec4d649dd4f8d7821db52b06c", "message": "Remove jackson-jr dependencies", "committedDate": "2020-05-11T08:05:34Z", "type": "commit"}, {"oid": "70b444d50aa6b9753044d1a5411a149580550dfd", "url": "https://github.com/hazelcast/hazelcast-jet/commit/70b444d50aa6b9753044d1a5411a149580550dfd", "message": "Fix minor issues", "committedDate": "2020-05-11T08:06:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAwMDI2Ng==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r423000266", "bodyText": "when do we use IdentifiedDataSerializable and when just SerializerHook? seems for data types we use SerializerHook?", "author": "cangencer", "createdAt": "2020-05-11T12:22:48Z", "path": "extensions/cdc-debezium/src/main/java/com/hazelcast/jet/cdc/impl/CdcJsonDataSerializerHook.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright 2020 Hazelcast Inc.\n+ *\n+ * Licensed under the Hazelcast Community License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ * http://hazelcast.com/hazelcast-community-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.hazelcast.jet.cdc.impl;\n+\n+import com.hazelcast.internal.serialization.DataSerializerHook;\n+import com.hazelcast.internal.serialization.impl.FactoryIdHelper;\n+import com.hazelcast.nio.serialization.DataSerializableFactory;\n+import com.hazelcast.nio.serialization.IdentifiedDataSerializable;\n+\n+import static com.hazelcast.jet.impl.JetFactoryIdHelper.JET_CDC_JSON_DS_FACTORY;\n+import static com.hazelcast.jet.impl.JetFactoryIdHelper.JET_CDC_JSON_DS_FACTORY_ID;\n+\n+public class CdcJsonDataSerializerHook implements DataSerializerHook {", "originalCommit": "70b444d50aa6b9753044d1a5411a149580550dfd", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxMjYyNQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2142#discussion_r423012625", "bodyText": "I wasn't really understanding what I was doing... will cover/fix in separate PR.", "author": "jbartok", "createdAt": "2020-05-11T12:45:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAwMDI2Ng=="}], "type": "inlineReview"}, {"oid": "11abc59d8ca9ca144d51536c991dbe43446fd9dd", "url": "https://github.com/hazelcast/hazelcast-jet/commit/11abc59d8ca9ca144d51536c991dbe43446fd9dd", "message": "Adjust title", "committedDate": "2020-05-11T12:32:18Z", "type": "commit"}, {"oid": "e7711570b4e2ff0ce6997e358841a950b131e7e3", "url": "https://github.com/hazelcast/hazelcast-jet/commit/e7711570b4e2ff0ce6997e358841a950b131e7e3", "message": "Fix weird string concatenations", "committedDate": "2020-05-11T12:44:22Z", "type": "commit"}]}