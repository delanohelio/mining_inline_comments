{"pr_number": 2566, "pr_title": "Define package of the class before defining the class in JetClassLoader", "pr_createdAt": "2020-09-25T15:27:53Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2566", "timeline": [{"oid": "9e74929a5b60948e944cdf65c097a263833cf83f", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9e74929a5b60948e944cdf65c097a263833cf83f", "message": "define package of the class before defining the class in JetClassLoader", "committedDate": "2020-09-25T15:20:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2NDMwOQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566#discussion_r495764309", "bodyText": "This method was deprecated in java9. I've read a bit why, but am not sure how to fix it in java8. But it's only an issue if multiple class loaders define the same packages, but I'd say it's not common. The purpose of defining the package is to make package annotations available, and if one uses package annotations, he doesn't use a package name that's likely to be used in some other library...\nSo consider this comment just a thinking aloud, we can live with this code for a while :)", "author": "viliam-durina", "createdAt": "2020-09-28T08:16:06Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/deployment/JetClassLoader.java", "diffHunk": "@@ -80,9 +80,37 @@ public JetClassLoader(\n                     + \" or start all members with it on classpath\");\n         }\n         byte[] classBytes = uncheckCall(() -> IOUtil.toByteArray(classBytesStream));\n+        definePackage(name);\n         return defineClass(name, classBytes, 0, classBytes.length);\n     }\n \n+    /**\n+     * Defines the package if it is not already defined for the given class\n+     * name.\n+     *\n+     * @param className the class name\n+     */\n+    private void definePackage(String className) {\n+        if (isEmpty(className)) {\n+            return;\n+        }\n+        int lastDotIndex = className.lastIndexOf('.');\n+        if (lastDotIndex == -1) {\n+            return;\n+        }\n+        String packageName = className.substring(0, lastDotIndex);\n+        if (getPackage(packageName) != null) {", "originalCommit": "9e74929a5b60948e944cdf65c097a263833cf83f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2ODc3MA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566#discussion_r495768770", "bodyText": "Maybe we can rather rely on ignoring the IArgExc. Or re-verify there just, as URLClassLoader does.", "author": "viliam-durina", "createdAt": "2020-09-28T08:24:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2NDMwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc2NzgwOA==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2566#discussion_r495767808", "bodyText": "This is certainly not correct. I'm not sure but i think that the values need to be loaded from the manifest file, or rather we can just pass in nulls, as I saw in several examples on the web. We certainly should not pass jet's meta informations to user's packages.", "author": "viliam-durina", "createdAt": "2020-09-28T08:22:33Z", "path": "hazelcast-jet-core/src/main/java/com/hazelcast/jet/impl/deployment/JetClassLoader.java", "diffHunk": "@@ -80,9 +80,37 @@ public JetClassLoader(\n                     + \" or start all members with it on classpath\");\n         }\n         byte[] classBytes = uncheckCall(() -> IOUtil.toByteArray(classBytesStream));\n+        definePackage(name);\n         return defineClass(name, classBytes, 0, classBytes.length);\n     }\n \n+    /**\n+     * Defines the package if it is not already defined for the given class\n+     * name.\n+     *\n+     * @param className the class name\n+     */\n+    private void definePackage(String className) {\n+        if (isEmpty(className)) {\n+            return;\n+        }\n+        int lastDotIndex = className.lastIndexOf('.');\n+        if (lastDotIndex == -1) {\n+            return;\n+        }\n+        String packageName = className.substring(0, lastDotIndex);\n+        if (getPackage(packageName) != null) {\n+            return;\n+        }\n+        Package clPackage = JetClassLoader.class.getPackage();\n+        try {\n+            definePackage(packageName, clPackage.getSpecificationTitle(), clPackage.getSpecificationVersion(),\n+                    clPackage.getSpecificationVendor(), clPackage.getImplementationTitle(),\n+                    clPackage.getImplementationVersion(), clPackage.getImplementationVendor(), null);", "originalCommit": "9e74929a5b60948e944cdf65c097a263833cf83f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c93aa3b58c0b5c45b15236a15e0daf0e5197fb22", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c93aa3b58c0b5c45b15236a15e0daf0e5197fb22", "message": "pass null while defining package instead of our metadata", "committedDate": "2020-09-30T05:53:18Z", "type": "commit"}, {"oid": "9ec8860c4e50569dc28086ade9486cb9f675a043", "url": "https://github.com/hazelcast/hazelcast-jet/commit/9ec8860c4e50569dc28086ade9486cb9f675a043", "message": "checkstyle", "committedDate": "2020-09-30T06:07:24Z", "type": "commit"}]}