{"pr_number": 2552, "pr_title": "Fix S3SinkTest Issue", "pr_createdAt": "2020-09-23T07:15:33Z", "pr_url": "https://github.com/hazelcast/hazelcast-jet/pull/2552", "timeline": [{"oid": "188e18dda1ef5cc3b4d7e385357569858ca51e3b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/188e18dda1ef5cc3b4d7e385357569858ca51e3b", "message": "Add new method that suppresses exceptions in AssertTrueEventually\n\nUse this AssertTrueEventuallyAndSuppressExceptions method in S3SinkTests. Also, use the latest versions of S3 APIs that are recommended.", "committedDate": "2020-09-22T13:04:12Z", "type": "commit"}, {"oid": "c0b241bc90b4681be663ddc50cfa7a4c359fd432", "url": "https://github.com/hazelcast/hazelcast-jet/commit/c0b241bc90b4681be663ddc50cfa7a4c359fd432", "message": "Add a conditional wait after cleanup.", "committedDate": "2020-09-23T06:57:12Z", "type": "commit"}, {"oid": "32cf368c70a0dc61f5652e475c7a71512a9da416", "url": "https://github.com/hazelcast/hazelcast-jet/commit/32cf368c70a0dc61f5652e475c7a71512a9da416", "message": "Change the logging level to INFO.", "committedDate": "2020-09-23T09:36:30Z", "type": "commit"}, {"oid": "60288182fc15a0972263d45757d5f5b86835d9be", "url": "https://github.com/hazelcast/hazelcast-jet/commit/60288182fc15a0972263d45757d5f5b86835d9be", "message": "Address the review comments\n\n- Add logging to cleanup step\n- Remove the AssertTrueEventuallyAndSuppressException method.\nAdd try catch block into the test instead of using that method.", "committedDate": "2020-09-24T10:20:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0MDc3OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2552#discussion_r494240779", "bodyText": "we can move this to a method for readibility and for re-use:\nclient.listObjectsV2(ListObjectsV2Request.builder().bucket(bucketName).build())", "author": "gurbuzali", "createdAt": "2020-09-24T11:33:19Z", "path": "extensions/s3/src/test/java/com/hazelcast/jet/s3/S3SinkTest.java", "diffHunk": "@@ -51,6 +54,24 @@ public void deleteObjects() {\n         if (!identifiers.isEmpty()) {\n             client.deleteObjects(b -> b.bucket(bucketName).delete(d -> d.objects(identifiers)));\n         }\n+\n+        int sleepMillis = (int) (SECONDS.toMillis(WAIT_AFTER_CLEANUP_IN_SECS) / 10);\n+        long deadline = System.currentTimeMillis() + SECONDS.toMillis(WAIT_AFTER_CLEANUP_IN_SECS);\n+        int keyCount;\n+        while ((keyCount = client.listObjectsV2(ListObjectsV2Request", "originalCommit": "60288182fc15a0972263d45757d5f5b86835d9be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0MTg0Nw==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2552#discussion_r494241847", "bodyText": "start method name with lower case", "author": "gurbuzali", "createdAt": "2020-09-24T11:35:16Z", "path": "extensions/s3/src/test/java/com/hazelcast/jet/s3/S3TestBase.java", "diffHunk": "@@ -168,6 +170,23 @@ void deleteBucket(S3Client client, String bucket) {\n         }\n     }\n \n+    Stream<String> S3ObjectToLines(S3Object o, S3Client client, String bucketName) {", "originalCommit": "60288182fc15a0972263d45757d5f5b86835d9be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0Mjg3Mg==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2552#discussion_r494242872", "bodyText": "the exception from the issue is NoSuchKeyException not NoSuchBucketException\nI think we can use the parent S3Exception here", "author": "gurbuzali", "createdAt": "2020-09-24T11:37:15Z", "path": "extensions/s3/src/test/java/com/hazelcast/jet/s3/S3TestBase.java", "diffHunk": "@@ -168,6 +170,23 @@ void deleteBucket(S3Client client, String bucket) {\n         }\n     }\n \n+    Stream<String> S3ObjectToLines(S3Object o, S3Client client, String bucketName) {\n+        try {\n+            ResponseInputStream<GetObjectResponse> is = client.getObject(req -> req.bucket(bucketName).key(o.key()), toInputStream());\n+            try (BufferedReader reader = new BufferedReader(new InputStreamReader(is, CHARSET))) {\n+                // materialize the stream, since we can't read it afterwards\n+                return reader.lines().collect(Collectors.toList()).stream();\n+            } catch (IOException e) {\n+                throw new AssertionError(\"Error reading file \", e);\n+            }\n+        } catch (NoSuchBucketException e) {", "originalCommit": "60288182fc15a0972263d45757d5f5b86835d9be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0Mzg5OQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2552#discussion_r494243899", "bodyText": "you can pass the exception to the logger.warning as an argument instead of print stacktrace", "author": "gurbuzali", "createdAt": "2020-09-24T11:39:15Z", "path": "extensions/s3/src/test/java/com/hazelcast/jet/s3/S3TestBase.java", "diffHunk": "@@ -168,6 +170,23 @@ void deleteBucket(S3Client client, String bucket) {\n         }\n     }\n \n+    Stream<String> S3ObjectToLines(S3Object o, S3Client client, String bucketName) {\n+        try {\n+            ResponseInputStream<GetObjectResponse> is = client.getObject(req -> req.bucket(bucketName).key(o.key()), toInputStream());\n+            try (BufferedReader reader = new BufferedReader(new InputStreamReader(is, CHARSET))) {\n+                // materialize the stream, since we can't read it afterwards\n+                return reader.lines().collect(Collectors.toList()).stream();\n+            } catch (IOException e) {\n+                throw new AssertionError(\"Error reading file \", e);\n+            }\n+        } catch (NoSuchBucketException e) {\n+            logger.warning(\"S3 side is having eventual consistency issue that it could not\" +\n+                    \" find the key that is listed before. We ignore this issue.\");\n+            e.printStackTrace();", "originalCommit": "60288182fc15a0972263d45757d5f5b86835d9be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDI0NTYwOQ==", "url": "https://github.com/hazelcast/hazelcast-jet/pull/2552#discussion_r494245609", "bodyText": "why copy/paste inputStreamToLines here ? we can just call it\nreturn inputStreamToLines(client.getObject(req -> req.bucket(bucketName).key(o.key()), toInputStream()));", "author": "gurbuzali", "createdAt": "2020-09-24T11:42:28Z", "path": "extensions/s3/src/test/java/com/hazelcast/jet/s3/S3TestBase.java", "diffHunk": "@@ -168,6 +170,23 @@ void deleteBucket(S3Client client, String bucket) {\n         }\n     }\n \n+    Stream<String> S3ObjectToLines(S3Object o, S3Client client, String bucketName) {\n+        try {\n+            ResponseInputStream<GetObjectResponse> is = client.getObject(req -> req.bucket(bucketName).key(o.key()), toInputStream());\n+            try (BufferedReader reader = new BufferedReader(new InputStreamReader(is, CHARSET))) {", "originalCommit": "60288182fc15a0972263d45757d5f5b86835d9be", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "82d53e6b4682295f20a2a6463415d63cc534b1b5", "url": "https://github.com/hazelcast/hazelcast-jet/commit/82d53e6b4682295f20a2a6463415d63cc534b1b5", "message": "Address the review comments", "committedDate": "2020-09-24T12:43:49Z", "type": "commit"}, {"oid": "ba9eedc6dfb6167acce127a7b0980501353f669b", "url": "https://github.com/hazelcast/hazelcast-jet/commit/ba9eedc6dfb6167acce127a7b0980501353f669b", "message": "Fix checkstyle issue (Line length)", "committedDate": "2020-09-24T12:45:43Z", "type": "commit"}]}