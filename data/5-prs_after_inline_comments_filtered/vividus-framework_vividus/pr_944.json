{"pr_number": 944, "pr_title": "[web-app] Throw user-friendly error when missing main application page URL is used", "pr_createdAt": "2020-09-15T13:33:57Z", "pr_url": "https://github.com/vividus-framework/vividus/pull/944", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MzE2MA==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r488673160", "bodyText": "Please update:\n\nUnit tests\nTransformer documentation\nAdd property name into message", "author": "ikalinin1", "createdAt": "2020-09-15T13:36:50Z", "path": "vividus-plugin-web-app-to-rest-api/src/main/java/org/vividus/transformer/SiteMapTableTransformer.java", "diffHunk": "@@ -58,10 +58,17 @@\n                 Set<String> siteMapRelativeUrls;\n                 try\n                 {\n-                    siteMapRelativeUrls = filterResults(siteMapParser.parse(true, mainApplicationPage,\n+                    if (mainApplicationPage != null)\n+                    {\n+                        siteMapRelativeUrls = filterResults(siteMapParser.parse(true, mainApplicationPage,\n                             siteMapRelativeUrl).stream()\n                             .map(SiteMapURL::getUrl)\n                             .map(URL::toString));\n+                    }\n+                    else\n+                    {\n+                        throw new IllegalArgumentException(\"URL of the main application page should be non-blank\");", "originalCommit": "f30b776dc5b2727d1008a191cac673874b8e8c02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3NDEyMA==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r488674120", "bodyText": "How does org.vividus.transformer.HeadlessCrawlerTableTransformer works without main page URL?", "author": "ikalinin1", "createdAt": "2020-09-15T13:38:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MzE2MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MTkzMQ==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r488671931", "bodyText": "unit tests ?", "author": "valfirst", "createdAt": "2020-09-15T13:35:17Z", "path": "vividus-plugin-web-app-to-rest-api/src/main/java/org/vividus/transformer/SiteMapTableTransformer.java", "diffHunk": "@@ -58,10 +58,17 @@\n                 Set<String> siteMapRelativeUrls;\n                 try\n                 {\n-                    siteMapRelativeUrls = filterResults(siteMapParser.parse(true, mainApplicationPage,\n+                    if (mainApplicationPage != null)\n+                    {\n+                        siteMapRelativeUrls = filterResults(siteMapParser.parse(true, mainApplicationPage,\n                             siteMapRelativeUrl).stream()\n                             .map(SiteMapURL::getUrl)\n                             .map(URL::toString));\n+                    }\n+                    else\n+                    {\n+                        throw new IllegalArgumentException(\"URL of the main application page should be non-blank\");", "originalCommit": "f30b776dc5b2727d1008a191cac673874b8e8c02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MjI3Ng==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r488672276", "bodyText": "use org.apache.commons.lang3.Validate instead", "author": "valfirst", "createdAt": "2020-09-15T13:35:42Z", "path": "vividus-plugin-web-app-to-rest-api/src/main/java/org/vividus/transformer/SiteMapTableTransformer.java", "diffHunk": "@@ -58,10 +58,17 @@\n                 Set<String> siteMapRelativeUrls;\n                 try\n                 {\n-                    siteMapRelativeUrls = filterResults(siteMapParser.parse(true, mainApplicationPage,\n+                    if (mainApplicationPage != null)\n+                    {\n+                        siteMapRelativeUrls = filterResults(siteMapParser.parse(true, mainApplicationPage,\n                             siteMapRelativeUrl).stream()\n                             .map(SiteMapURL::getUrl)\n                             .map(URL::toString));\n+                    }\n+                    else\n+                    {\n+                        throw new IllegalArgumentException(\"URL of the main application page should be non-blank\");", "originalCommit": "f30b776dc5b2727d1008a191cac673874b8e8c02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODY3MzcyMg==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r488673722", "bodyText": "also I believe the fix should be implemented in getMainApplicationPageUri() to avoid the same issue in HeadlessCrawlerTableTransformer", "author": "valfirst", "createdAt": "2020-09-15T13:37:31Z", "path": "vividus-plugin-web-app-to-rest-api/src/main/java/org/vividus/transformer/SiteMapTableTransformer.java", "diffHunk": "@@ -58,10 +58,17 @@\n                 Set<String> siteMapRelativeUrls;\n                 try\n                 {\n-                    siteMapRelativeUrls = filterResults(siteMapParser.parse(true, mainApplicationPage,\n+                    if (mainApplicationPage != null)", "originalCommit": "f30b776dc5b2727d1008a191cac673874b8e8c02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1183dad26d1690f5261171c13ad9ca7c39232cef", "url": "https://github.com/vividus-framework/vividus/commit/1183dad26d1690f5261171c13ad9ca7c39232cef", "message": "fix 784 issue", "committedDate": "2020-09-16T13:06:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTc1ODYyMQ==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r489758621", "bodyText": "I believe there is no reason to check the value each time the method invoked, consider caching the result (Suppliers.memoize?)", "author": "valfirst", "createdAt": "2020-09-16T21:15:19Z", "path": "vividus-plugin-web-app-to-rest-api/src/main/java/org/vividus/transformer/AbstractFetchingUrlsTableTransformer.java", "diffHunk": "@@ -109,7 +111,9 @@ public void setHttpRedirectsProvider(HttpRedirectsProvider httpRedirectsProvider\n \n     protected URI getMainApplicationPageUri()\n     {\n-        return webApplicationConfiguration.getMainApplicationPageUrl();\n+        URI mainApplicationPageUrl = webApplicationConfiguration.getMainApplicationPageUrl();\n+        isTrue(mainApplicationPageUrl != null, \"URL of the main application page should be non-blank\");\n+        return mainApplicationPageUrl;", "originalCommit": "1183dad26d1690f5261171c13ad9ca7c39232cef", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDMzMTgwMg==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r490331802", "bodyText": "mainApplicationPageUriSupplier", "author": "valfirst", "createdAt": "2020-09-17T15:12:35Z", "path": "vividus-plugin-web-app-to-rest-api/src/main/java/org/vividus/transformer/AbstractFetchingUrlsTableTransformer.java", "diffHunk": "@@ -42,6 +47,12 @@\n     private WebApplicationConfiguration webApplicationConfiguration;\n     private HttpRedirectsProvider httpRedirectsProvider;\n     private boolean filterRedirects;\n+    private final Supplier<URI> pageURLSupplier = Suppliers.memoize(() ->", "originalCommit": "afc374a98b88e2d59d271e9605b31ea1896c60df", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f735675672f572571fed775bfab55eee7e9dcc51", "url": "https://github.com/vividus-framework/vividus/commit/f735675672f572571fed775bfab55eee7e9dcc51", "message": "Fix 784 issue", "committedDate": "2020-09-18T10:15:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3Mzc2MA==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r490873760", "bodyText": "Could you please refactor to check in one place?\nWe have a similar check here: https://github.com/vividus-framework/vividus/blob/master/vividus-plugin-web-app/src/main/java/org/vividus/bdd/steps/ui/web/PageSteps.java#L92-L99", "author": "ikalinin1", "createdAt": "2020-09-18T11:09:13Z", "path": "vividus-plugin-web-app-to-rest-api/src/main/java/org/vividus/transformer/AbstractFetchingUrlsTableTransformer.java", "diffHunk": "@@ -42,6 +47,12 @@\n     private WebApplicationConfiguration webApplicationConfiguration;\n     private HttpRedirectsProvider httpRedirectsProvider;\n     private boolean filterRedirects;\n+    private final Supplier<URI> mainApplicationPageUriSupplier = Suppliers.memoize(() ->\n+    {\n+        URI mainApplicationPageUrl = webApplicationConfiguration.getMainApplicationPageUrl();", "originalCommit": "f735675672f572571fed775bfab55eee7e9dcc51", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjYxODI3Mw==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r496618273", "bodyText": "resolve this", "author": "TatianaTochko", "createdAt": "2020-09-29T10:43:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg3Mzc2MA=="}], "type": "inlineReview"}, {"oid": "dcec0c76149d978d7722c24a59f5b72f0e7de248", "url": "https://github.com/vividus-framework/vividus/commit/dcec0c76149d978d7722c24a59f5b72f0e7de248", "message": "Fix issue 784: main page url is missing in properties\n\nIt is impossible to run stories if one story is set to be skipped where main page url is missing in properties. Fix NPE", "committedDate": "2020-09-29T14:19:48Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjgzOTY3MA==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r496839670", "bodyText": "it won't work in this way, because Supplier is shared across threads now, but configuration storage is not, it may lead to wrong URL returned from the cache", "author": "valfirst", "createdAt": "2020-09-29T15:51:53Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/ui/web/configuration/WebApplicationConfiguration.java", "diffHunk": "@@ -29,11 +34,18 @@\n     private int tabletScreenResolutionWidthThreshold;\n     private String applicationEnvironmentType;\n     private final ThreadLocal<ConfigurationStorage> configurationStorage;\n+    private final Supplier<URI> mainApplicationPageUriSupplier;\n \n     public WebApplicationConfiguration(String mainApplicationPageUrlString, AuthenticationMode authenticationMode)\n     {\n         configurationStorage = ThreadLocal.withInitial(() ->\n             new ConfigurationStorage(mainApplicationPageUrlString, authenticationMode));\n+        mainApplicationPageUriSupplier = Suppliers.memoize(() ->\n+        {\n+            URI mainApplicationPageUrl = configurationStorage.get().getMainApplicationPageUri();\n+            isTrue(mainApplicationPageUrl != null, \"URL of the main application page should be non-blank\");\n+            return mainApplicationPageUrl;\n+        });", "originalCommit": "dcec0c76149d978d7722c24a59f5b72f0e7de248", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5b6dc6f8191c112e083d0a804e804d501f7ade81", "url": "https://github.com/vividus-framework/vividus/commit/5b6dc6f8191c112e083d0a804e804d501f7ade81", "message": "Fix issue 784: main page url is missing in properties\n\nIt is impossible to run stories if one story is set to be skipped where main page url is missing in properties. Fix NPE", "committedDate": "2020-09-30T15:02:38Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA0OTgwNw==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r498049807", "bodyText": "to remove?", "author": "valfirst", "createdAt": "2020-10-01T07:51:17Z", "path": "vividus-plugin-web-app-to-rest-api/src/test/java/org/vividus/bdd/steps/integration/ResourceCheckStepsTests.java", "diffHunk": "@@ -336,10 +327,10 @@ void shouldFilterResourceByRegExpCheckDesiredResourcesAnPostAttachment()\n     {\n         mockResourceValidator();\n         runExecutor();\n-        mockWebApplicationConfiguration();\n+        //mockWebApplicationConfiguration();", "originalCommit": "5b6dc6f8191c112e083d0a804e804d501f7ade81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA1MDMwMA==", "url": "https://github.com/vividus-framework/vividus/pull/944#discussion_r498050300", "bodyText": "return mainApplicationPageUriSupplier.get() ?", "author": "valfirst", "createdAt": "2020-10-01T07:52:10Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/ui/web/configuration/WebApplicationConfiguration.java", "diffHunk": "@@ -128,7 +139,7 @@ public void setApplicationEnvironmentType(String applicationEnvironmentType)\n \n         private URI getMainApplicationPageUri()\n         {\n-            return mainApplicationPageUri;\n+            return Optional.ofNullable(mainApplicationPageUriSupplier.get()).get();", "originalCommit": "5b6dc6f8191c112e083d0a804e804d501f7ade81", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cdc38316a5f8b5e3926980570e55c5a50c6aa5aa", "url": "https://github.com/vividus-framework/vividus/commit/cdc38316a5f8b5e3926980570e55c5a50c6aa5aa", "message": "Fix issue 784: main page url is missing in properties\n\nIt is impossible to run stories if one story is set to be skipped where main page url is missing in properties. Fix NPE", "committedDate": "2020-10-01T09:13:42Z", "type": "commit"}, {"oid": "cdc38316a5f8b5e3926980570e55c5a50c6aa5aa", "url": "https://github.com/vividus-framework/vividus/commit/cdc38316a5f8b5e3926980570e55c5a50c6aa5aa", "message": "Fix issue 784: main page url is missing in properties\n\nIt is impossible to run stories if one story is set to be skipped where main page url is missing in properties. Fix NPE", "committedDate": "2020-10-01T09:13:42Z", "type": "forcePushed"}]}