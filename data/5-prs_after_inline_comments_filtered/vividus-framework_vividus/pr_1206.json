{"pr_number": 1206, "pr_title": "Add function for only update existing execution statuses in zephyr-exporter", "pr_createdAt": "2020-12-08T08:02:43Z", "pr_url": "https://github.com/vividus-framework/vividus/pull/1206", "timeline": [{"oid": "0468d7480c8a78d6be4357d1f4ff034a36e5b558", "url": "https://github.com/vividus-framework/vividus/commit/0468d7480c8a78d6be4357d1f4ff034a36e5b558", "message": "Add function for only update existing execution statuses in zephyr-exporter", "committedDate": "2020-12-08T08:18:53Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEzOTg3Mg==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538139872", "bodyText": "move configuration of ObjectMapper to constructor to avoid possible duplicate re-configuration", "author": "valfirst", "createdAt": "2020-12-08T08:37:48Z", "path": "vividus-to-zephyr-exporter/src/main/java/org/vividus/zephyr/exporter/ZephyrExporter.java", "diffHunk": "@@ -40,18 +41,21 @@\n     private final JiraFacade jiraFacade;\n     private IZephyrFacade zephyrFacade;\n     private TestCaseParser testCaseParser;\n+    private ZephyrExporterProperties zephyrExporterProperties;\n \n-    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser)\n-            throws IOException\n+    private final ObjectMapper objectMapper = new ObjectMapper();\n+\n+    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser,\n+            ZephyrExporterProperties zephyrExporterProperties) throws IOException\n     {\n         this.jiraFacade = jiraFacade;\n         this.zephyrFacade = zephyrFacade;\n         this.testCaseParser = testCaseParser;\n+        this.zephyrExporterProperties = zephyrExporterProperties;\n     }\n \n     public void exportResults() throws IOException\n     {\n-        ObjectMapper objectMapper = new ObjectMapper();\n         objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n         objectMapper.configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true);\n         objectMapper.registerModule(new SimpleModule().addDeserializer(TestCase.class, new TestCaseDeserializer()));", "originalCommit": "0468d7480c8a78d6be4357d1f4ff034a36e5b558", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0MTQwNw==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538141407", "bodyText": "shouldn't the export fail if test execution is not found?", "author": "valfirst", "createdAt": "2020-12-08T08:40:03Z", "path": "vividus-to-zephyr-exporter/src/main/java/org/vividus/zephyr/exporter/ZephyrExporter.java", "diffHunk": "@@ -60,20 +64,30 @@ public void exportResults() throws IOException\n         ZephyrConfiguration configuration = zephyrFacade.prepareConfiguration();\n         for (TestCase testCase : testCasesForImporting)\n         {\n-            createNewTestExecution(testCase, configuration, objectMapper);\n+            exportTestExecution(testCase, configuration);\n         }\n     }\n \n-    private void createNewTestExecution(TestCase testCase, ZephyrConfiguration configuration, ObjectMapper objectMapper)\n-            throws IOException\n+    private void exportTestExecution(TestCase testCase, ZephyrConfiguration configuration) throws IOException\n     {\n         JiraEntity issue = jiraFacade.getIssue(testCase.getKey());\n         ZephyrExecution execution = new ZephyrExecution(configuration, issue.getId(), testCase.getStatus());\n-        String createExecution = objectMapper.writeValueAsString(execution);\n-        int executionId = zephyrFacade.createExecution(createExecution);\n+        int executionId;\n \n-        String executionBody = objectMapper.writeValueAsString(new ExecutionStatus(\n+        if (zephyrExporterProperties.getUpdateExecutionStatusesOnly())\n+        {\n+            executionId = zephyrFacade.findExecutionId(issue.getId());", "originalCommit": "0468d7480c8a78d6be4357d1f4ff034a36e5b558", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MDE1Nw==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538190157", "bodyText": "No, because it made for setup statuses for only created executions (in allure them can be more than created in jira)", "author": "abudevich", "createdAt": "2020-12-08T09:48:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0MTQwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODIwMTI1OQ==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538201259", "bodyText": "ok, then maybe some logging makes sense?", "author": "valfirst", "createdAt": "2020-12-08T10:03:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0MTQwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE0MTc3Ng==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538141776", "bodyText": "it's better to return OptionalInt instead of using -1 as missing value flag", "author": "valfirst", "createdAt": "2020-12-08T08:40:40Z", "path": "vividus-to-zephyr-exporter/src/main/java/org/vividus/zephyr/facade/ZephyrFacade.java", "diffHunk": "@@ -142,4 +142,14 @@ private String findFolderId(String cycleId, String projectAndVersionUrlQuery) th\n         });\n         return testStatusPerZephyrIdMapping;\n     }\n+\n+    @Override\n+    public Integer findExecutionId(String issueId) throws IOException\n+    {\n+        String json = client.executeGet(ZAPI_ENDPOINT + \"execution?issueId=\" + issueId);\n+        List<Integer> executionId = JsonPathUtils.getData(json, String.format(\"$..[?(@.versionName=='%s' &&\"\n+                + \" @.cycleName=='%s' && @.folderName=='%s')].id\", zephyrExporterConfiguration.getVersionName(),\n+                zephyrExporterConfiguration.getCycleName(), zephyrExporterConfiguration.getFolderName()));\n+        return executionId.size() != 0 ? executionId.get(0) : -1;", "originalCommit": "0468d7480c8a78d6be4357d1f4ff034a36e5b558", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "57a1b7634a4cdf1117d281db036e79ad512d8ad4", "url": "https://github.com/vividus-framework/vividus/commit/57a1b7634a4cdf1117d281db036e79ad512d8ad4", "message": "Add function for only update existing execution statuses in zephyr-exporter", "committedDate": "2020-12-08T09:44:35Z", "type": "forcePushed"}, {"oid": "c70e17eca6a669b09cbf47009d83e6904c0a0413", "url": "https://github.com/vividus-framework/vividus/commit/c70e17eca6a669b09cbf47009d83e6904c0a0413", "message": "Add function for only update existing execution statuses in zephyr-exporter", "committedDate": "2020-12-08T11:53:13Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMyNzgzMA==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538327830", "bodyText": "maybe\nnew ObjectMapper().configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)..configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true).registerModule(new SimpleModule().addDeserializer(TestCase.class, new TestCaseDeserializer()));", "author": "uarlouski", "createdAt": "2020-12-08T12:47:25Z", "path": "vividus-to-zephyr-exporter/src/main/java/org/vividus/zephyr/exporter/ZephyrExporter.java", "diffHunk": "@@ -37,43 +41,63 @@\n \n public class ZephyrExporter\n {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ZephyrExporter.class);\n+\n     private final JiraFacade jiraFacade;\n     private IZephyrFacade zephyrFacade;\n     private TestCaseParser testCaseParser;\n+    private ZephyrExporterProperties zephyrExporterProperties;\n+\n+    private final ObjectMapper objectMapper = new ObjectMapper();\n \n-    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser)\n-            throws IOException\n+    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser,\n+            ZephyrExporterProperties zephyrExporterProperties) throws IOException\n     {\n         this.jiraFacade = jiraFacade;\n         this.zephyrFacade = zephyrFacade;\n         this.testCaseParser = testCaseParser;\n-    }\n+        this.zephyrExporterProperties = zephyrExporterProperties;\n \n-    public void exportResults() throws IOException\n-    {\n-        ObjectMapper objectMapper = new ObjectMapper();\n         objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n         objectMapper.configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true);\n         objectMapper.registerModule(new SimpleModule().addDeserializer(TestCase.class, new TestCaseDeserializer()));", "originalCommit": "c70e17eca6a669b09cbf47009d83e6904c0a0413", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMyOTQ0Ng==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538329446", "bodyText": "use {} for parameters in loggers", "author": "uarlouski", "createdAt": "2020-12-08T12:49:13Z", "path": "vividus-to-zephyr-exporter/src/main/java/org/vividus/zephyr/exporter/ZephyrExporter.java", "diffHunk": "@@ -37,43 +41,63 @@\n \n public class ZephyrExporter\n {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ZephyrExporter.class);\n+\n     private final JiraFacade jiraFacade;\n     private IZephyrFacade zephyrFacade;\n     private TestCaseParser testCaseParser;\n+    private ZephyrExporterProperties zephyrExporterProperties;\n+\n+    private final ObjectMapper objectMapper = new ObjectMapper();\n \n-    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser)\n-            throws IOException\n+    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser,\n+            ZephyrExporterProperties zephyrExporterProperties) throws IOException\n     {\n         this.jiraFacade = jiraFacade;\n         this.zephyrFacade = zephyrFacade;\n         this.testCaseParser = testCaseParser;\n-    }\n+        this.zephyrExporterProperties = zephyrExporterProperties;\n \n-    public void exportResults() throws IOException\n-    {\n-        ObjectMapper objectMapper = new ObjectMapper();\n         objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n         objectMapper.configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true);\n         objectMapper.registerModule(new SimpleModule().addDeserializer(TestCase.class, new TestCaseDeserializer()));\n+    }\n \n+    public void exportResults() throws IOException\n+    {\n         List<TestCase> testCasesForImporting = testCaseParser.createTestCases(objectMapper);\n         ZephyrConfiguration configuration = zephyrFacade.prepareConfiguration();\n         for (TestCase testCase : testCasesForImporting)\n         {\n-            createNewTestExecution(testCase, configuration, objectMapper);\n+            exportTestExecution(testCase, configuration);\n         }\n     }\n \n-    private void createNewTestExecution(TestCase testCase, ZephyrConfiguration configuration, ObjectMapper objectMapper)\n-            throws IOException\n+    private void exportTestExecution(TestCase testCase, ZephyrConfiguration configuration) throws IOException\n     {\n         JiraEntity issue = jiraFacade.getIssue(testCase.getKey());\n         ZephyrExecution execution = new ZephyrExecution(configuration, issue.getId(), testCase.getStatus());\n-        String createExecution = objectMapper.writeValueAsString(execution);\n-        int executionId = zephyrFacade.createExecution(createExecution);\n+        OptionalInt executionId;\n \n-        String executionBody = objectMapper.writeValueAsString(new ExecutionStatus(\n+        if (zephyrExporterProperties.getUpdateExecutionStatusesOnly())\n+        {\n+            executionId = zephyrFacade.findExecutionId(issue.getId());\n+        }\n+        else\n+        {\n+            String createExecution = objectMapper.writeValueAsString(execution);\n+            executionId = OptionalInt.of(zephyrFacade.createExecution(createExecution));\n+        }\n+        if (executionId.isPresent())\n+        {\n+            String executionBody = objectMapper.writeValueAsString(new ExecutionStatus(\n                 String.valueOf(configuration.getTestStatusPerZephyrIdMapping().get(execution.getTestCaseStatus()))));\n-        zephyrFacade.updateExecutionStatus(executionId, executionBody);\n+            zephyrFacade.updateExecutionStatus(executionId.getAsInt(), executionBody);\n+        }\n+        else\n+        {\n+            LOGGER.info(\"Test case result for \" + testCase.getKey() + \" was not exported, \"", "originalCommit": "c70e17eca6a669b09cbf47009d83e6904c0a0413", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODMzMDE0Mw==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538330143", "bodyText": "imho not readable", "author": "uarlouski", "createdAt": "2020-12-08T12:49:55Z", "path": "vividus-to-zephyr-exporter/src/main/java/org/vividus/zephyr/facade/ZephyrFacade.java", "diffHunk": "@@ -142,4 +143,14 @@ private String findFolderId(String cycleId, String projectAndVersionUrlQuery) th\n         });\n         return testStatusPerZephyrIdMapping;\n     }\n+\n+    @Override\n+    public OptionalInt findExecutionId(String issueId) throws IOException\n+    {\n+        String json = client.executeGet(ZAPI_ENDPOINT + \"execution?issueId=\" + issueId);\n+        List<Integer> executionId = JsonPathUtils.getData(json, String.format(\"$..[?(@.versionName=='%s' &&\"\n+                + \" @.cycleName=='%s' && @.folderName=='%s')].id\", zephyrExporterConfiguration.getVersionName(),\n+                zephyrExporterConfiguration.getCycleName(), zephyrExporterConfiguration.getFolderName()));", "originalCommit": "c70e17eca6a669b09cbf47009d83e6904c0a0413", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "325e635058dc71bbae32adada0ae52938ecb66fe", "url": "https://github.com/vividus-framework/vividus/commit/325e635058dc71bbae32adada0ae52938ecb66fe", "message": "Add function for only update existing execution statuses in zephyr-exporter", "committedDate": "2020-12-08T13:03:12Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM1NDQ0NA==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538354444", "bodyText": "testCase  is not used in the log message", "author": "valfirst", "createdAt": "2020-12-08T13:14:54Z", "path": "vividus-to-zephyr-exporter/src/main/java/org/vividus/zephyr/exporter/ZephyrExporter.java", "diffHunk": "@@ -37,43 +41,62 @@\n \n public class ZephyrExporter\n {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ZephyrExporter.class);\n+\n     private final JiraFacade jiraFacade;\n     private IZephyrFacade zephyrFacade;\n     private TestCaseParser testCaseParser;\n+    private ZephyrExporterProperties zephyrExporterProperties;\n+\n+    private final ObjectMapper objectMapper = new ObjectMapper();\n \n-    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser)\n-            throws IOException\n+    public ZephyrExporter(JiraFacade jiraFacade, ZephyrFacade zephyrFacade, TestCaseParser testCaseParser,\n+            ZephyrExporterProperties zephyrExporterProperties) throws IOException\n     {\n         this.jiraFacade = jiraFacade;\n         this.zephyrFacade = zephyrFacade;\n         this.testCaseParser = testCaseParser;\n+        this.zephyrExporterProperties = zephyrExporterProperties;\n+\n+        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false)\n+            .configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true)\n+            .registerModule(new SimpleModule().addDeserializer(TestCase.class, new TestCaseDeserializer()));\n     }\n \n     public void exportResults() throws IOException\n     {\n-        ObjectMapper objectMapper = new ObjectMapper();\n-        objectMapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n-        objectMapper.configure(MapperFeature.SORT_PROPERTIES_ALPHABETICALLY, true);\n-        objectMapper.registerModule(new SimpleModule().addDeserializer(TestCase.class, new TestCaseDeserializer()));\n-\n         List<TestCase> testCasesForImporting = testCaseParser.createTestCases(objectMapper);\n         ZephyrConfiguration configuration = zephyrFacade.prepareConfiguration();\n         for (TestCase testCase : testCasesForImporting)\n         {\n-            createNewTestExecution(testCase, configuration, objectMapper);\n+            exportTestExecution(testCase, configuration);\n         }\n     }\n \n-    private void createNewTestExecution(TestCase testCase, ZephyrConfiguration configuration, ObjectMapper objectMapper)\n-            throws IOException\n+    private void exportTestExecution(TestCase testCase, ZephyrConfiguration configuration) throws IOException\n     {\n         JiraEntity issue = jiraFacade.getIssue(testCase.getKey());\n         ZephyrExecution execution = new ZephyrExecution(configuration, issue.getId(), testCase.getStatus());\n-        String createExecution = objectMapper.writeValueAsString(execution);\n-        int executionId = zephyrFacade.createExecution(createExecution);\n+        OptionalInt executionId;\n \n-        String executionBody = objectMapper.writeValueAsString(new ExecutionStatus(\n+        if (zephyrExporterProperties.getUpdateExecutionStatusesOnly())\n+        {\n+            executionId = zephyrFacade.findExecutionId(issue.getId());\n+        }\n+        else\n+        {\n+            String createExecution = objectMapper.writeValueAsString(execution);\n+            executionId = OptionalInt.of(zephyrFacade.createExecution(createExecution));\n+        }\n+        if (executionId.isPresent())\n+        {\n+            String executionBody = objectMapper.writeValueAsString(new ExecutionStatus(\n                 String.valueOf(configuration.getTestStatusPerZephyrIdMapping().get(execution.getTestCaseStatus()))));\n-        zephyrFacade.updateExecutionStatus(executionId, executionBody);\n+            zephyrFacade.updateExecutionStatus(executionId.getAsInt(), executionBody);\n+        }\n+        else\n+        {\n+            LOGGER.info(\"Test case result was not exported, because execution does not exist\", testCase);", "originalCommit": "325e635058dc71bbae32adada0ae52938ecb66fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODM1NTA1Ng==", "url": "https://github.com/vividus-framework/vividus/pull/1206#discussion_r538355056", "bodyText": "please add an empty line after the field", "author": "valfirst", "createdAt": "2020-12-08T13:15:36Z", "path": "vividus-to-zephyr-exporter/src/test/java/org/vividus/zephyr/exporter/ZephyrExporterTests.java", "diffHunk": "@@ -34,14 +43,22 @@\n import org.vividus.jira.JiraFacade;\n import org.vividus.jira.model.JiraEntity;\n import org.vividus.zephyr.configuration.ZephyrConfiguration;\n+import org.vividus.zephyr.configuration.ZephyrExporterProperties;\n import org.vividus.zephyr.facade.ZephyrFacade;\n import org.vividus.zephyr.model.TestCase;\n import org.vividus.zephyr.model.TestCaseStatus;\n import org.vividus.zephyr.parser.TestCaseParser;\n \n-@ExtendWith(MockitoExtension.class)\n+@ExtendWith({MockitoExtension.class, TestLoggerFactoryExtension.class})\n class ZephyrExporterTests\n {\n+    private static final String TEST_CASE_KEY1 = \"TEST-1\";\n+    private static final String TEST_CASE_KEY2 = \"TEST-2\";\n+    private static final String ISSUE_ID1 = \"1\";\n+    private static final String ISSUE_ID2 = \"2\";\n+    private static final String STATUS_UPDATE_JSON = \"{\\\"status\\\":\\\"-1\\\"}\";\n+\n+    private final TestLogger testLogger = TestLoggerFactory.getTestLogger(ZephyrExporter.class);", "originalCommit": "325e635058dc71bbae32adada0ae52938ecb66fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "482dddfe6b42361880fdb66c12ba93a9db77caf3", "url": "https://github.com/vividus-framework/vividus/commit/482dddfe6b42361880fdb66c12ba93a9db77caf3", "message": "Add function for only update existing execution statuses in zephyr-exporter", "committedDate": "2020-12-08T14:03:00Z", "type": "commit"}, {"oid": "482dddfe6b42361880fdb66c12ba93a9db77caf3", "url": "https://github.com/vividus-framework/vividus/commit/482dddfe6b42361880fdb66c12ba93a9db77caf3", "message": "Add function for only update existing execution statuses in zephyr-exporter", "committedDate": "2020-12-08T14:03:00Z", "type": "forcePushed"}]}