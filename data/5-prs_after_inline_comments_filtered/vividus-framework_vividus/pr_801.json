{"pr_number": 801, "pr_title": "Add step adding headers to proxied requests with given URL pattern", "pr_createdAt": "2020-08-05T09:16:08Z", "pr_url": "https://github.com/vividus-framework/vividus/pull/801", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTYxNDY3MQ==", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r465614671", "bodyText": "String urlPattern why not use some flexible mechanism to match URLs like Patter or StringComparisonRule ?", "author": "ikalinin1", "createdAt": "2020-08-05T10:02:06Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -238,6 +241,30 @@ public String toString()\n         });\n     }\n \n+    /**\n+     * Add headers to proxy request that will be used while sending request with given urlPattern\n+     * @param headers ExamplesTable representing list of headers with columns \"name\" and \"value\" specifying HTTP header\n+     * names and values respectively\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     */\n+    @When(\"I add headers to proxied requests with URL pattern `$urlPattern`:$headers\")\n+    public void addHeadersToProxyRequest(ExamplesTable headers, String urlPattern)", "originalCommit": "4f472dc6ae013ebf9010e3347360e7bad0857fa8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "290237ce59e0014da8957e84e7f15498baa4ad2f", "url": "https://github.com/vividus-framework/vividus/commit/290237ce59e0014da8957e84e7f15498baa4ad2f", "message": "Add step adding headers to proxied requests with given URL pattern", "committedDate": "2020-08-05T11:45:29Z", "type": "forcePushed"}, {"oid": "f78097103925022f069363418ec4d97333d4d98f", "url": "https://github.com/vividus-framework/vividus/commit/f78097103925022f069363418ec4d97333d4d98f", "message": "Add step adding headers to proxied requests with given URL pattern", "committedDate": "2020-08-05T13:28:20Z", "type": "commit"}, {"oid": "f78097103925022f069363418ec4d97333d4d98f", "url": "https://github.com/vividus-framework/vividus/commit/f78097103925022f069363418ec4d97333d4d98f", "message": "Add step adding headers to proxied requests with given URL pattern", "committedDate": "2020-08-05T13:28:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5MjIxMg==", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r466192212", "bodyText": "@valfirst  in the current implementation, the filter will be cleared off on before scenario hook.\nIs it expected behavior?\nShouldn't we support filters that will work whole run time? (For example, if we need to pass basic authentication for some of the requests)\nAnd I think we should give the user the possibility to clear the filters via step.", "author": "ikalinin1", "createdAt": "2020-08-06T07:12:02Z", "path": "vividus-plugin-web-app/src/main/java/org/vividus/proxy/steps/ProxySteps.java", "diffHunk": "@@ -238,6 +243,32 @@ public String toString()\n         });\n     }\n \n+    /**\n+     * Add headers to proxy request that will be used while sending request with given urlPattern\n+     * @param headers ExamplesTable representing list of headers with columns \"name\" and \"value\" specifying HTTP header\n+     * names and values respectively\n+     * @param comparisonRule String comparison rule: \"is equal to\", \"contains\", \"does not contain\"\n+     * @param urlPattern The string value of URL-pattern to filter by\n+     */\n+    @When(\"I add headers to proxied requests with URL pattern which $comparisonRule `$urlPattern`:$headers\")\n+    public void addHeadersToProxyRequest(StringComparisonRule comparisonRule, String urlPattern, ExamplesTable headers)\n+    {\n+        DefaultHttpHeaders httpHeaders = new DefaultHttpHeaders();\n+        headers.getRowsAsParameters(true)\n+                .forEach(row -> httpHeaders.add(\n+                        row.valueAs(\"name\", String.class),\n+                        (Object) row.valueAs(\"value\", String.class)\n+                ));\n+        Matcher<String> expected = comparisonRule.createMatcher(urlPattern);\n+        proxy.addRequestFilter((request, contents, messageInfo) -> {", "originalCommit": "f78097103925022f069363418ec4d97333d4d98f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIyNjY4Ng==", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r481226686", "bodyText": "that's a good point, but it's out of scope this PR", "author": "valfirst", "createdAt": "2020-09-01T15:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjE5MjIxMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzMDI5OA==", "url": "https://github.com/vividus-framework/vividus/pull/801#discussion_r481230298", "bodyText": "I believe unit test should be expanded a bit to invoke the filter actually (and 2 unit tests will be required: when URL matches and doesn't match to the rule)", "author": "valfirst", "createdAt": "2020-09-01T15:27:01Z", "path": "vividus-plugin-web-app/src/test/java/org/vividus/proxy/steps/ProxyStepsTests.java", "diffHunk": "@@ -261,6 +267,17 @@ void testWaitRequestInProxyLog()\n                         httpMethod, URL_PATTERN).equals(e.toString())));\n     }\n \n+    @Test\n+    void testAddHeadersToProxyRequest()\n+    {\n+        HttpRequest request = mock(HttpRequest.class);\n+        HttpMessageContents contents = mock(HttpMessageContents.class);\n+        HttpMessageInfo message = mock(HttpMessageInfo.class);\n+        ExamplesTable headers = new ExamplesTable(\"|name|value|\\n|name1|value1|\");\n+        proxySteps.addHeadersToProxyRequest(StringComparisonRule.IS_EQUAL_TO, URL_PATTERN, headers);\n+        verify(proxy).addRequestFilter(argThat(filter -> filter.filterRequest(request, contents, message) == null));", "originalCommit": "f78097103925022f069363418ec4d97333d4d98f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9640c50934152d9bedf9b5fb67bb30e7d7d3438d", "url": "https://github.com/vividus-framework/vividus/commit/9640c50934152d9bedf9b5fb67bb30e7d7d3438d", "message": "Merge branch 'master' into proxy-request-headers", "committedDate": "2020-10-06T08:39:44Z", "type": "commit"}, {"oid": "66895b9c900a9ddd74f60ec3efd79782ca108255", "url": "https://github.com/vividus-framework/vividus/commit/66895b9c900a9ddd74f60ec3efd79782ca108255", "message": "Fix merge issue in docs", "committedDate": "2020-10-06T08:44:07Z", "type": "commit"}, {"oid": "c90ce574e167e3b99683d87055e2fb5dfa740507", "url": "https://github.com/vividus-framework/vividus/commit/c90ce574e167e3b99683d87055e2fb5dfa740507", "message": "Add requirementId to integration test", "committedDate": "2020-10-06T08:45:17Z", "type": "commit"}, {"oid": "beb96e444554b4c4c054ba4a57973a5cb5ff827e", "url": "https://github.com/vividus-framework/vividus/commit/beb96e444554b4c4c054ba4a57973a5cb5ff827e", "message": "Add more unit tests", "committedDate": "2020-10-06T09:51:27Z", "type": "commit"}]}