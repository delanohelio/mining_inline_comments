{"pr_number": 876, "pr_title": "Add new step for waiting for presence of element by JSON path using polling interval", "pr_createdAt": "2020-09-01T10:04:50Z", "pr_url": "https://github.com/vividus-framework/vividus/pull/876", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4OTQzMA==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481089430", "bodyText": "I think it makes sense to have 2 implementations of waiter:\n\nduration based\nretry times based\n\nin this case logic won't be mixed up", "author": "valfirst", "createdAt": "2020-09-01T12:10:26Z", "path": "vividus-util/src/main/java/org/vividus/util/wait/Waiter.java", "diffHunk": "@@ -28,24 +29,35 @@\n {\n     private final long durationInMillis;\n     private final long pollingTimeoutMillis;\n+    private final int pollingRetries;\n \n     public Waiter(WaitMode waitMode)\n     {\n         durationInMillis = waitMode.getDuration().toMillis();\n         pollingTimeoutMillis = waitMode.calculatePollingTimeout(TimeUnit.MILLISECONDS);\n+        pollingRetries = waitMode.getRetryTimes();\n     }\n \n-    public <T, E extends Exception> T wait(FailableSupplier<T, E> valueProvider, Predicate<T> stopCondition) throws E\n+    public Waiter(Duration pollingTimeoutMillis, int pollingRetries)\n     {\n-        long endTime = System.currentTimeMillis() + durationInMillis;\n+        this.durationInMillis = 0;\n+        this.pollingTimeoutMillis = pollingTimeoutMillis.toMillis();\n+        this.pollingRetries = pollingRetries;\n+    }\n \n+    public <T, E extends Exception> T wait(FailableSupplier<T, E> valueProvider, Predicate<T> stopCondition) throws E\n+    {\n         T value;\n+        long endTime = System.currentTimeMillis() + durationInMillis;\n+        int counter = 0;\n         do\n         {\n             value = valueProvider.get();\n             Sleeper.sleep(pollingTimeoutMillis, TimeUnit.MILLISECONDS);\n+            counter++;\n         }\n-        while (!stopCondition.test(value) && System.currentTimeMillis() <= endTime);\n+        while (!stopCondition.test(value) && (durationInMillis > 0\n+                ? System.currentTimeMillis() <= endTime : counter < pollingRetries));", "originalCommit": "6253c88b3531a6f8627fa02c4280ffc8e3d00ca3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA4OTc3OQ==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481089779", "bodyText": "there should be 2 unit tests, such if-s can't be used in unit tests", "author": "valfirst", "createdAt": "2020-09-01T12:11:10Z", "path": "vividus-plugin-rest-api/src/test/java/org/vividus/bdd/steps/api/JsonResponseValidationStepsTests.java", "diffHunk": "@@ -400,7 +401,16 @@ void shouldWaitForJsonElement()\n                 .thenReturn(createHttpResponse(JSON));\n         when(httpTestContext.getJsonContext()).thenReturn(JSON);\n         int retryTimes = 4;\n-        jsonResponseValidationSteps.waitForJsonElement(STRING_PATH, Duration.ofSeconds(2), retryTimes, stepsToExecute);\n+        if (withPollingInterval)", "originalCommit": "6253c88b3531a6f8627fa02c4280ffc8e3d00ca3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA5MTk3Nw==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481091977", "bodyText": "When I wait for presence of element by `$jsonPath` with `$pollingInterval` polling interval retrying $retryTimes times$stepsToExecute", "author": "valfirst", "createdAt": "2020-09-01T12:15:29Z", "path": "vividus-plugin-rest-api/src/main/java/org/vividus/bdd/steps/api/JsonResponseValidationSteps.java", "diffHunk": "@@ -308,9 +308,39 @@ public void waitForJsonFieldAppearance(String jsonPath, String resourceUrl, Dura\n             + \"$stepsToExecute\")\n     public void waitForJsonElement(String jsonPath, Duration duration, int retryTimes, SubSteps stepsToExecute)\n     {\n-        new Waiter(new WaitMode(duration, retryTimes)).wait(\n-                () -> stepsToExecute.execute(Optional.empty()),\n-                () -> isJsonElementSearchCompleted(httpTestContext.getResponse(), jsonPath)\n+        waitForJsonElement(new Waiter(new WaitMode(duration, retryTimes)), jsonPath, stepsToExecute);\n+    }\n+\n+    /**\n+     * Execute a specified amount of retries using polling interval of time until\n+     * HTTP response body contains an element by the specified JSON path.\n+     * <p>\n+     * <b>Actions performed:</b>\n+     * </p>\n+     * <ul>\n+     * <li>Execute sub-steps</li>\n+     * <li>Check if HTTP response is present and response body contains an element by JSON path</li>\n+     * <li>Stop step execution if HTTP response is not present or JSON element is found, otherwise\n+     * sleep for the calculated part of specified polling interval and repeat actions from the start</li>\n+     * </ul>\n+     * @param jsonPath JSON path of element to find\n+     * @param interval Duration of time to wait\n+     * @param retryTimes Number of attempts\n+     * @param stepsToExecute Steps to execute at each wait iteration\n+     */\n+    @When(\"I wait for presence of element by `$jsonPath` with polling interval `$interval` retrying $retryTimes times\"\n+            + \"$stepsToExecute\")", "originalCommit": "6253c88b3531a6f8627fa02c4280ffc8e3d00ca3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA5MjEyOQ==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481092129", "bodyText": "also please add docs for new step", "author": "valfirst", "createdAt": "2020-09-01T12:15:46Z", "path": "vividus-plugin-rest-api/src/main/java/org/vividus/bdd/steps/api/JsonResponseValidationSteps.java", "diffHunk": "@@ -308,9 +308,39 @@ public void waitForJsonFieldAppearance(String jsonPath, String resourceUrl, Dura\n             + \"$stepsToExecute\")\n     public void waitForJsonElement(String jsonPath, Duration duration, int retryTimes, SubSteps stepsToExecute)\n     {\n-        new Waiter(new WaitMode(duration, retryTimes)).wait(\n-                () -> stepsToExecute.execute(Optional.empty()),\n-                () -> isJsonElementSearchCompleted(httpTestContext.getResponse(), jsonPath)\n+        waitForJsonElement(new Waiter(new WaitMode(duration, retryTimes)), jsonPath, stepsToExecute);\n+    }\n+\n+    /**\n+     * Execute a specified amount of retries using polling interval of time until\n+     * HTTP response body contains an element by the specified JSON path.\n+     * <p>\n+     * <b>Actions performed:</b>\n+     * </p>\n+     * <ul>\n+     * <li>Execute sub-steps</li>\n+     * <li>Check if HTTP response is present and response body contains an element by JSON path</li>\n+     * <li>Stop step execution if HTTP response is not present or JSON element is found, otherwise\n+     * sleep for the calculated part of specified polling interval and repeat actions from the start</li>\n+     * </ul>\n+     * @param jsonPath JSON path of element to find\n+     * @param interval Duration of time to wait\n+     * @param retryTimes Number of attempts\n+     * @param stepsToExecute Steps to execute at each wait iteration\n+     */\n+    @When(\"I wait for presence of element by `$jsonPath` with polling interval `$interval` retrying $retryTimes times\"\n+            + \"$stepsToExecute\")", "originalCommit": "6253c88b3531a6f8627fa02c4280ffc8e3d00ca3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA5MjU2Mg==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481092562", "bodyText": "pollingRetries -> retryTimes - to keep naming consistency", "author": "valfirst", "createdAt": "2020-09-01T12:16:33Z", "path": "vividus-util/src/main/java/org/vividus/util/wait/Waiter.java", "diffHunk": "@@ -28,24 +29,35 @@\n {\n     private final long durationInMillis;\n     private final long pollingTimeoutMillis;\n+    private final int pollingRetries;", "originalCommit": "6253c88b3531a6f8627fa02c4280ffc8e3d00ca3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd612a60734a844b92f38385752549ae3da784fd", "url": "https://github.com/vividus-framework/vividus/commit/bd612a60734a844b92f38385752549ae3da784fd", "message": "Add new step for waiting for presence of element by JSON path using polling interval", "committedDate": "2020-09-01T18:00:48Z", "type": "forcePushed"}, {"oid": "b3ece3feaf0dd7e4a70b92fad899605bae262308", "url": "https://github.com/vividus-framework/vividus/commit/b3ece3feaf0dd7e4a70b92fad899605bae262308", "message": "Add new step for waiting for presence of element by JSON path using polling interval", "committedDate": "2020-09-01T18:23:35Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NTQ1Mg==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481855452", "bodyText": "protected?", "author": "valfirst", "createdAt": "2020-09-02T07:57:27Z", "path": "vividus-util/src/main/java/org/vividus/util/wait/Waiter.java", "diffHunk": "@@ -59,4 +44,9 @@ public Waiter(WaitMode waitMode)\n             alwaysNull -> stopCondition.getAsBoolean()\n         );\n     }\n+\n+    public long getPollingTimeoutMillis()", "originalCommit": "b3ece3feaf0dd7e4a70b92fad899605bae262308", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NTYzNg==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481855636", "bodyText": "package-private ?", "author": "valfirst", "createdAt": "2020-09-02T07:57:39Z", "path": "vividus-util/src/main/java/org/vividus/util/wait/Waiter.java", "diffHunk": "@@ -16,38 +16,23 @@\n \n package org.vividus.util.wait;\n \n-import java.util.concurrent.TimeUnit;\n import java.util.function.BooleanSupplier;\n import java.util.function.Predicate;\n \n import org.apache.commons.lang3.function.FailableRunnable;\n import org.apache.commons.lang3.function.FailableSupplier;\n-import org.vividus.util.Sleeper;\n \n-public final class Waiter\n+public abstract class Waiter\n {\n-    private final long durationInMillis;\n     private final long pollingTimeoutMillis;\n \n-    public Waiter(WaitMode waitMode)\n+    public Waiter(long pollingTimeoutMillis)", "originalCommit": "b3ece3feaf0dd7e4a70b92fad899605bae262308", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg1NzYzMg==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r481857632", "bodyText": "you can reduce the polling interval (in the previous unit tests there is a kind of race condition, that's why we need to put some seconds there)", "author": "valfirst", "createdAt": "2020-09-02T07:59:52Z", "path": "vividus-plugin-rest-api/src/test/java/org/vividus/bdd/steps/api/JsonResponseValidationStepsTests.java", "diffHunk": "@@ -407,6 +408,25 @@ void shouldWaitForJsonElement()\n                 verifyMatcher(1));\n     }\n \n+    @Test\n+    void shouldWaitForJsonElementWithPollingInterval()\n+    {\n+        SubSteps stepsToExecute = mock(SubSteps.class);\n+        when(httpTestContext.getResponse())\n+                .thenReturn(createHttpResponse(HTML))\n+                .thenReturn(createHttpResponse(OBJECT_PATH_RESULT))\n+                .thenReturn(new HttpResponse())\n+                .thenReturn(createHttpResponse(JSON));\n+        when(httpTestContext.getJsonContext()).thenReturn(JSON);\n+        int retryTimes = 4;\n+        jsonResponseValidationSteps.waitForJsonElementWithPollingInterval(STRING_PATH,\n+                Duration.ofSeconds(2), retryTimes, stepsToExecute);", "originalCommit": "b3ece3feaf0dd7e4a70b92fad899605bae262308", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjAyNzA5OA==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r482027098", "bodyText": "I believe you can check exact number of invocations here", "author": "valfirst", "createdAt": "2020-09-02T12:25:09Z", "path": "vividus-plugin-rest-api/src/test/java/org/vividus/bdd/steps/api/JsonResponseValidationStepsTests.java", "diffHunk": "@@ -407,6 +408,25 @@ void shouldWaitForJsonElement()\n                 verifyMatcher(1));\n     }\n \n+    @Test\n+    void shouldWaitForJsonElementWithPollingInterval()\n+    {\n+        SubSteps stepsToExecute = mock(SubSteps.class);\n+        when(httpTestContext.getResponse())\n+                .thenReturn(createHttpResponse(HTML))\n+                .thenReturn(createHttpResponse(OBJECT_PATH_RESULT))\n+                .thenReturn(new HttpResponse())\n+                .thenReturn(createHttpResponse(JSON));\n+        when(httpTestContext.getJsonContext()).thenReturn(JSON);\n+        int retryTimes = 4;\n+        jsonResponseValidationSteps.waitForJsonElementWithPollingInterval(STRING_PATH,\n+                Duration.ofSeconds(2), retryTimes, stepsToExecute);\n+        verify(stepsToExecute, atLeast(retryTimes - 1)).execute(Optional.empty());\n+        verify(stepsToExecute, atMost(retryTimes)).execute(Optional.empty());", "originalCommit": "b3ece3feaf0dd7e4a70b92fad899605bae262308", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bb7f4e15931a673f491da9e9ed98cb443ea3a233", "url": "https://github.com/vividus-framework/vividus/commit/bb7f4e15931a673f491da9e9ed98cb443ea3a233", "message": "Add new step for waiting for presence of element by JSON path using polling interval", "committedDate": "2020-09-02T12:51:31Z", "type": "forcePushed"}, {"oid": "bb7f4e15931a673f491da9e9ed98cb443ea3a233", "url": "https://github.com/vividus-framework/vividus/commit/bb7f4e15931a673f491da9e9ed98cb443ea3a233", "message": "Add new step for waiting for presence of element by JSON path using polling interval", "committedDate": "2020-09-02T12:51:31Z", "type": "forcePushed"}, {"oid": "a69ef5cd1bbf60702da9af2d43a4164f93c037d1", "url": "https://github.com/vividus-framework/vividus/commit/a69ef5cd1bbf60702da9af2d43a4164f93c037d1", "message": "Add new step for waiting for presence of element by JSON path using polling interval", "committedDate": "2020-09-02T14:46:09Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjM0MzQ0OA==", "url": "https://github.com/vividus-framework/vividus/pull/876#discussion_r482343448", "bodyText": "add override annotation for both waiters", "author": "uarlouski", "createdAt": "2020-09-02T19:32:02Z", "path": "vividus-util/src/main/java/org/vividus/util/wait/DurationBasedWaiter.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright 2019-2020 the original author or authors.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.vividus.util.wait;\n+\n+import java.util.concurrent.TimeUnit;\n+import java.util.function.Predicate;\n+\n+import org.apache.commons.lang3.function.FailableSupplier;\n+import org.vividus.util.Sleeper;\n+\n+public final class DurationBasedWaiter extends Waiter\n+{\n+    private final long durationInMillis;\n+\n+    public DurationBasedWaiter(WaitMode waitMode)\n+    {\n+        super(waitMode.calculatePollingTimeout(TimeUnit.MILLISECONDS));\n+        durationInMillis = waitMode.getDuration().toMillis();\n+    }\n+\n+    public <T, E extends Exception> T wait(FailableSupplier<T, E> valueProvider, Predicate<T> stopCondition) throws E", "originalCommit": "a69ef5cd1bbf60702da9af2d43a4164f93c037d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1c566a66b63cbd8c20c1f70e593e643af152e2d8", "url": "https://github.com/vividus-framework/vividus/commit/1c566a66b63cbd8c20c1f70e593e643af152e2d8", "message": "Add new step for waiting for presence of element by JSON path using polling interval", "committedDate": "2020-09-02T20:28:10Z", "type": "commit"}, {"oid": "1c566a66b63cbd8c20c1f70e593e643af152e2d8", "url": "https://github.com/vividus-framework/vividus/commit/1c566a66b63cbd8c20c1f70e593e643af152e2d8", "message": "Add new step for waiting for presence of element by JSON path using polling interval", "committedDate": "2020-09-02T20:28:10Z", "type": "forcePushed"}, {"oid": "b9c4fd72032f3c4f04627bbd7f86edad93b85506", "url": "https://github.com/vividus-framework/vividus/commit/b9c4fd72032f3c4f04627bbd7f86edad93b85506", "message": "Improve docs", "committedDate": "2020-09-06T19:08:09Z", "type": "commit"}]}