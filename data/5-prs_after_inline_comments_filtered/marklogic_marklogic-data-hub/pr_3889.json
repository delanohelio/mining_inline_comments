{"pr_number": 3889, "pr_title": "DHFPROD-4880: Using the Java Client for collecting URIs", "pr_createdAt": "2020-04-29T15:19:16Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3889", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQzOTM3MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3889#discussion_r417439370", "bodyText": "We don't need the check since IOUtils.closeQuietly will check and close.", "author": "akshaysonvane", "createdAt": "2020-04-29T16:14:27Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/collector/impl/CollectorImpl.java", "diffHunk": "@@ -96,147 +64,29 @@ public CollectorImpl(HubClient hubClient, String sourceDatabase) {\n                 uriString += \"&options=\" + URLEncoder.encode(objectMapper.writeValueAsString(options), \"UTF-8\");\n             }\n \n-            URI uri = new URI(uriString);\n-\n-            RequestCallback requestCallback = request -> request.getHeaders()\n-                .setAccept(Arrays.asList(MediaType.APPLICATION_OCTET_STREAM, MediaType.ALL));\n+            /**\n+             * The underlying OkHttpClient is used for performance reasons, as trying to invoke a REST extension or\n+             * invoking /v1/eval results in far worse performance. See the comments in DHFPROD-4533 for more information.\n+             */\n+            OkHttpClient ok = (OkHttpClient) stagingClient.getClientImplementation();\n+            Request request = new Request.Builder().url(uriString).get().build();\n+            Response response = ok.newCall(request).execute();\n \n-            // Streams the response instead of loading it all in memory\n-            ResponseExtractor<Void> responseExtractor = response -> {\n-                BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(response.getBody(), \"UTF-8\"));\n+            BufferedReader bufferedReader = null;\n+            try {\n+                bufferedReader = new BufferedReader(response.body().charStream());\n                 String line;\n                 while ((line = bufferedReader.readLine()) != null) {\n                     results.add(line);\n                 }\n-                bufferedReader.close();\n-                return null;\n-            };\n-\n-            hubClient.getStagingRestTemplate().execute(uri, HttpMethod.GET, requestCallback, responseExtractor);\n-\n-            return results;\n-        } catch (Exception e) {\n-            e.printStackTrace();\n-            throw new RuntimeException(e);\n-        }\n-    }\n-\n-    public static RestTemplate newRestTemplate(DatabaseClient collectorClient, String username, String password) {\n-        DatabaseClientFactory.SecurityContext securityContext = collectorClient.getSecurityContext();\n-\n-        BasicCredentialsProvider prov = new BasicCredentialsProvider();\n-        prov.setCredentials(\n-            new AuthScope(collectorClient.getHost(), collectorClient.getPort(), AuthScope.ANY_REALM),\n-            new UsernamePasswordCredentials(username, password));\n-\n-        HttpClientBuilder httpClientBuilder = HttpClientBuilder.create().setDefaultCredentialsProvider(prov);\n-\n-        if (securityContext != null) {\n-            SSLContext sslContext = securityContext.getSSLContext();\n-            if (sslContext != null) {\n-                httpClientBuilder.setSslcontext(sslContext);\n-            }\n-\n-            SSLHostnameVerifier verifier = securityContext.getSSLHostnameVerifier();\n-            X509HostnameVerifier hostnameVerifier = null;\n-            if (verifier == SSLHostnameVerifier.ANY) {\n-                hostnameVerifier = new X509HostnameVerifier() {\n-                    @Override\n-                    public boolean verify(String paramString, SSLSession paramSSLSession) {\n-                        return true;\n-                    }\n-\n-                    @Override\n-                    public void verify(String host, SSLSocket ssl) throws IOException {\n-                    }\n-\n-                    @Override\n-                    public void verify(String host, X509Certificate cert) throws SSLException {\n-                    }\n-\n-                    @Override\n-                    public void verify(String host, String[] cns, String[] subjectAlts) throws SSLException {\n-                    }\n-                };\n-\n-            } else if (verifier == SSLHostnameVerifier.COMMON) {\n-                hostnameVerifier = null;\n-            } else if (verifier == SSLHostnameVerifier.STRICT) {\n-                hostnameVerifier = null;\n-            } else if (verifier != null) {\n-                hostnameVerifier = new HostnameVerifierAdapter(verifier);\n-            }\n-            httpClientBuilder.setHostnameVerifier(hostnameVerifier);\n-        }\n-\n-        HttpClient client = httpClientBuilder.build();\n-\n-        RestTemplate rt = new RestTemplate(new HttpComponentsClientHttpRequestFactory(client));\n-        rt.setErrorHandler(new MgmtResponseErrorHandler());\n-        return rt;\n-    }\n-\n-    static private class HostnameVerifierAdapter implements X509HostnameVerifier {\n-        private SSLHostnameVerifier verifier;\n-\n-        protected HostnameVerifierAdapter(SSLHostnameVerifier verifier) {\n-            this.verifier = verifier;\n-        }\n-\n-        public void verify(String hostname, X509Certificate cert) throws SSLException {\n-            ArrayList<String> cnArray = new ArrayList<>();\n-            try {\n-                LdapName ldapDN = new LdapName(cert.getSubjectX500Principal().getName());\n-                for (Rdn rdn : ldapDN.getRdns()) {\n-                    Object value = rdn.getValue();\n-                    if (\"CN\".equalsIgnoreCase(rdn.getType()) && value instanceof String) {\n-                        cnArray.add((String) value);\n-                    }\n-                }\n-                int type_dnsName = 2;\n-                int type_ipAddress = 7;\n-                ArrayList<String> subjectAltArray = new ArrayList<>();\n-                Collection<List<?>> alts = cert.getSubjectAlternativeNames();\n-                if (alts != null) {\n-                    for (List<?> alt : alts) {\n-                        if (alt != null && alt.size() == 2 && alt.get(1) instanceof String) {\n-                            Integer type = (Integer) alt.get(0);\n-                            if (type == type_dnsName || type == type_ipAddress) {\n-                                subjectAltArray.add((String) alt.get(1));\n-                            }\n-                        }\n-                    }\n+            } finally {\n+                if (bufferedReader != null) {", "originalCommit": "34dbc68895741179a1a686edf73ab0e76a8b0b5b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE5MzkzMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3889#discussion_r418193930", "bodyText": "Antoher option would be to use a try-with-resource statement, since the bufferedReader isn't required outside of the try block. https://docs.oracle.com/javase/tutorial/essential/exceptions/tryResourceClose.html", "author": "ryanjdew", "createdAt": "2020-04-30T18:04:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQzOTM3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODE5Nzg3OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3889#discussion_r418197878", "bodyText": "This PR also requires a rebase", "author": "srinathgit", "createdAt": "2020-04-30T18:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQzOTM3MA=="}], "type": "inlineReview"}, {"oid": "0070b1a698f7c4fd8827a44d91f2d902b2058019", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0070b1a698f7c4fd8827a44d91f2d902b2058019", "message": "DHFPROD-4880: Using the Java Client for collecting URIs\n\nThis is the result of DHFPROD-4533, where performance testing confirmed that this approach of accessing the underlying OkHttpClient results in good performance and the same functional behavior. I ran all the tests locally, and all of them passed.", "committedDate": "2020-05-04T12:53:46Z", "type": "commit"}, {"oid": "0070b1a698f7c4fd8827a44d91f2d902b2058019", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0070b1a698f7c4fd8827a44d91f2d902b2058019", "message": "DHFPROD-4880: Using the Java Client for collecting URIs\n\nThis is the result of DHFPROD-4533, where performance testing confirmed that this approach of accessing the underlying OkHttpClient results in good performance and the same functional behavior. I ran all the tests locally, and all of them passed.", "committedDate": "2020-05-04T12:53:46Z", "type": "forcePushed"}]}