{"pr_number": 4319, "pr_title": "DHFPROD-5265:Create step via Gradle", "pr_createdAt": "2020-07-30T19:17:38Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4319", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzMjM3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4319#discussion_r463232377", "bodyText": "Since this is only needed in the createStepFile method, don't declare it as a class variable - just instantiate it when you need it, as you know you have a HubConfig that you can use to construct it.", "author": "rjrudin", "createdAt": "2020-07-30T19:49:01Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ScaffoldingImpl.java", "diffHunk": "@@ -57,6 +62,9 @@\n     @Autowired\n     private ScaffoldingValidator validator;\n \n+    @Autowired\n+    private StepDefinitionManager stepDefinitionManager;", "originalCommit": "4415448dc457759f3a7967b45bba8eb32001c045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzNTMyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4319#discussion_r463235322", "bodyText": "I like this try/catch, but I think we need separate ones for writing the stepDef and then the step - we should tell Pari exactly which operation failed.", "author": "rjrudin", "createdAt": "2020-07-30T19:54:33Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ScaffoldingImpl.java", "diffHunk": "@@ -77,44 +86,86 @@ public static String getAbsolutePath(String first, String... more) {\n     }\n \n     /**\n-     * Create a step file  based on the given name and type.\n+     * Create a step file  based on the given stepName, stepType, entityType (for non ingestion steps),\n+     *  and stepDefName.\n      *\n-     * @param name\n-     * @param type\n+     * @param stepName\n+     * @param stepType\n+     * @param stepDefName\n+     * @param entityType\n      * @return a Pair with a File representing the created file, and a String representing an optional message that,\n      * if not null, should likely be presented to the caller\n      */\n-    public Pair<File, String> createStepFile(String name, String type) {\n-        StepDefinition.StepDefinitionType stepType = StepDefinition.StepDefinitionType.getStepDefinitionType(type);\n-        Assert.notNull(stepType, \"Unrecognized step type: \" + type);\n-        Assert.isTrue(stepType.equals(StepDefinition.StepDefinitionType.INGESTION) || stepType.equals(StepDefinition.StepDefinitionType.MAPPING),\n-            \"Can only create a step of type 'ingestion' or 'mapping'\");\n-\n-        File stepFile = hubConfig.getHubProject().getStepFile(stepType, name);\n+    public Pair<File, String> createStepFile(String stepName, String stepType, String stepDefName, String entityType) {\n+        StepDefinitionType stepDefType = StepDefinitionType.getStepDefinitionType(stepType);\n+        Assert.notNull(stepDefType, \"Unrecognized step type: \" + stepType);\n+        Assert.isTrue(stepDefType.equals(StepDefinitionType.INGESTION) || stepDefType.equals(StepDefinitionType.MAPPING) ||\n+                stepDefType.equals(StepDefinitionType.CUSTOM),\n+            \"Can only create a step of type 'ingestion', 'mapping' or 'custom'\");\n+\n+\n+        StepDefinition stepDefinition = null;\n+        JsonNode step;\n+        StringBuilder messageBuilder = new StringBuilder();\n+        File stepFile = hubConfig.getHubProject().getStepFile(stepDefType, stepName);\n         if (stepFile.exists()) {\n             throw new IllegalArgumentException(\"Cannot create step; a step file already exists at: \" + stepFile.getAbsolutePath() + \". Please choose a different name for your step.\");\n         }\n         stepFile.getParentFile().mkdirs();\n \n         ObjectMapper objectMapper = new ObjectMapper();\n-        ObjectNode step = objectMapper.createObjectNode();\n-        step.put(\"name\", name);\n-        step.put(\"description\", \"\");\n-\n-        String message = null;\n-        if (StepDefinition.StepDefinitionType.INGESTION.equals(stepType)) {\n-            step.put(\"sourceFormat\", \"json\");\n-            step.put(\"targetFormat\", \"json\");\n-        } else {\n-            step.put(\"targetEntityType\", \"http://example.org/EntityName-1.0.0/EntityName\");\n-            step.put(\"selectedSource\", \"query\");\n-            step.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n-            message = \"The mapping step file will need to be modified before usage, as it has example values for targetEntityType and sourceQuery.\";\n+        ObjectNode stepPayLoad = objectMapper.createObjectNode();\n+        stepPayLoad.put(\"name\", stepName);\n+        stepPayLoad.put(\"description\", \"\");\n+        stepPayLoad.put(\"stepDefinitionType\", stepType);\n+        if(stepDefName != null) {\n+            stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+        }\n+        else {\n+            if(StepDefinitionType.CUSTOM.equals(stepDefType)){\n+                stepDefName = stepName;\n+                stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+            }\n+        }\n+\n+        if (StepDefinitionType.INGESTION.equals(stepDefType)) {\n+            stepPayLoad.put(\"sourceFormat\", \"json\");\n+            stepPayLoad.put(\"targetFormat\", \"json\");\n+        }\n+        else {\n+            stepPayLoad.put(\"selectedSource\", \"query\");\n+            stepPayLoad.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n+            if(entityType != null){\n+                stepPayLoad.put(\"entityType\", entityType);\n+            }\n+        }\n+\n+        if (stepDefName != null && stepDefinitionManager.getStepDefinition(stepDefName, StepDefinitionType.getStepDefinitionType(stepType)) == null) {\n+            stepDefinition = StepDefinition.create(stepDefName, StepDefinitionType.getStepDefinitionType(stepType));\n+            createCustomModule(stepDefName, stepType);\n+            stepDefinition.setModulePath(\"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\");\n+            stepDefinitionManager.saveStepDefinition(stepDefinition);\n+            messageBuilder.append(String.format(\"Created Step definition '%s' of type '%s'.\", stepName, stepType));\n+            messageBuilder.append(\"The module file for the step definition is available at \"\n+                + \"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\" + \". Please run mlWatch while you edit the custom module\\n\");\n+        }\n+        messageBuilder.append(\"Created a step '\" + stepName + \"' of type '\" + stepType + \"' with default properties. It will need to be modified before usage.\");\n+\n+        try {\n+            DatabaseClient stagingClient = hubConfig.newHubClient().getStagingClient();\n+            if(stepDefinition != null) {\n+                ArtifactService artifactService = ArtifactService.on(stagingClient);\n+                artifactService.setArtifact(\"stepDefinition\", stepDefName, objectMapper.valueToTree(stepDefinition));\n+            }\n+            StepService stepService = StepService.on(stagingClient);\n+            step = stepService.saveStep(stepType, stepPayLoad);\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Unable to write step/step-definition to database; cause: \" + e.getMessage(), e);", "originalCommit": "4415448dc457759f3a7967b45bba8eb32001c045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzNTQ4Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4319#discussion_r463235487", "bodyText": "Little nit - do \"step\", not \"Step\", for consistency.", "author": "rjrudin", "createdAt": "2020-07-30T19:54:52Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ScaffoldingImpl.java", "diffHunk": "@@ -77,44 +86,86 @@ public static String getAbsolutePath(String first, String... more) {\n     }\n \n     /**\n-     * Create a step file  based on the given name and type.\n+     * Create a step file  based on the given stepName, stepType, entityType (for non ingestion steps),\n+     *  and stepDefName.\n      *\n-     * @param name\n-     * @param type\n+     * @param stepName\n+     * @param stepType\n+     * @param stepDefName\n+     * @param entityType\n      * @return a Pair with a File representing the created file, and a String representing an optional message that,\n      * if not null, should likely be presented to the caller\n      */\n-    public Pair<File, String> createStepFile(String name, String type) {\n-        StepDefinition.StepDefinitionType stepType = StepDefinition.StepDefinitionType.getStepDefinitionType(type);\n-        Assert.notNull(stepType, \"Unrecognized step type: \" + type);\n-        Assert.isTrue(stepType.equals(StepDefinition.StepDefinitionType.INGESTION) || stepType.equals(StepDefinition.StepDefinitionType.MAPPING),\n-            \"Can only create a step of type 'ingestion' or 'mapping'\");\n-\n-        File stepFile = hubConfig.getHubProject().getStepFile(stepType, name);\n+    public Pair<File, String> createStepFile(String stepName, String stepType, String stepDefName, String entityType) {\n+        StepDefinitionType stepDefType = StepDefinitionType.getStepDefinitionType(stepType);\n+        Assert.notNull(stepDefType, \"Unrecognized step type: \" + stepType);\n+        Assert.isTrue(stepDefType.equals(StepDefinitionType.INGESTION) || stepDefType.equals(StepDefinitionType.MAPPING) ||\n+                stepDefType.equals(StepDefinitionType.CUSTOM),\n+            \"Can only create a step of type 'ingestion', 'mapping' or 'custom'\");\n+\n+\n+        StepDefinition stepDefinition = null;\n+        JsonNode step;\n+        StringBuilder messageBuilder = new StringBuilder();\n+        File stepFile = hubConfig.getHubProject().getStepFile(stepDefType, stepName);\n         if (stepFile.exists()) {\n             throw new IllegalArgumentException(\"Cannot create step; a step file already exists at: \" + stepFile.getAbsolutePath() + \". Please choose a different name for your step.\");\n         }\n         stepFile.getParentFile().mkdirs();\n \n         ObjectMapper objectMapper = new ObjectMapper();\n-        ObjectNode step = objectMapper.createObjectNode();\n-        step.put(\"name\", name);\n-        step.put(\"description\", \"\");\n-\n-        String message = null;\n-        if (StepDefinition.StepDefinitionType.INGESTION.equals(stepType)) {\n-            step.put(\"sourceFormat\", \"json\");\n-            step.put(\"targetFormat\", \"json\");\n-        } else {\n-            step.put(\"targetEntityType\", \"http://example.org/EntityName-1.0.0/EntityName\");\n-            step.put(\"selectedSource\", \"query\");\n-            step.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n-            message = \"The mapping step file will need to be modified before usage, as it has example values for targetEntityType and sourceQuery.\";\n+        ObjectNode stepPayLoad = objectMapper.createObjectNode();\n+        stepPayLoad.put(\"name\", stepName);\n+        stepPayLoad.put(\"description\", \"\");\n+        stepPayLoad.put(\"stepDefinitionType\", stepType);\n+        if(stepDefName != null) {\n+            stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+        }\n+        else {\n+            if(StepDefinitionType.CUSTOM.equals(stepDefType)){\n+                stepDefName = stepName;\n+                stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+            }\n+        }\n+\n+        if (StepDefinitionType.INGESTION.equals(stepDefType)) {\n+            stepPayLoad.put(\"sourceFormat\", \"json\");\n+            stepPayLoad.put(\"targetFormat\", \"json\");\n+        }\n+        else {\n+            stepPayLoad.put(\"selectedSource\", \"query\");\n+            stepPayLoad.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n+            if(entityType != null){\n+                stepPayLoad.put(\"entityType\", entityType);\n+            }\n+        }\n+\n+        if (stepDefName != null && stepDefinitionManager.getStepDefinition(stepDefName, StepDefinitionType.getStepDefinitionType(stepType)) == null) {\n+            stepDefinition = StepDefinition.create(stepDefName, StepDefinitionType.getStepDefinitionType(stepType));\n+            createCustomModule(stepDefName, stepType);\n+            stepDefinition.setModulePath(\"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\");\n+            stepDefinitionManager.saveStepDefinition(stepDefinition);\n+            messageBuilder.append(String.format(\"Created Step definition '%s' of type '%s'.\", stepName, stepType));", "originalCommit": "4415448dc457759f3a7967b45bba8eb32001c045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzNTY2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4319#discussion_r463235667", "bodyText": "Let's put this on a new line.", "author": "rjrudin", "createdAt": "2020-07-30T19:55:11Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ScaffoldingImpl.java", "diffHunk": "@@ -77,44 +86,86 @@ public static String getAbsolutePath(String first, String... more) {\n     }\n \n     /**\n-     * Create a step file  based on the given name and type.\n+     * Create a step file  based on the given stepName, stepType, entityType (for non ingestion steps),\n+     *  and stepDefName.\n      *\n-     * @param name\n-     * @param type\n+     * @param stepName\n+     * @param stepType\n+     * @param stepDefName\n+     * @param entityType\n      * @return a Pair with a File representing the created file, and a String representing an optional message that,\n      * if not null, should likely be presented to the caller\n      */\n-    public Pair<File, String> createStepFile(String name, String type) {\n-        StepDefinition.StepDefinitionType stepType = StepDefinition.StepDefinitionType.getStepDefinitionType(type);\n-        Assert.notNull(stepType, \"Unrecognized step type: \" + type);\n-        Assert.isTrue(stepType.equals(StepDefinition.StepDefinitionType.INGESTION) || stepType.equals(StepDefinition.StepDefinitionType.MAPPING),\n-            \"Can only create a step of type 'ingestion' or 'mapping'\");\n-\n-        File stepFile = hubConfig.getHubProject().getStepFile(stepType, name);\n+    public Pair<File, String> createStepFile(String stepName, String stepType, String stepDefName, String entityType) {\n+        StepDefinitionType stepDefType = StepDefinitionType.getStepDefinitionType(stepType);\n+        Assert.notNull(stepDefType, \"Unrecognized step type: \" + stepType);\n+        Assert.isTrue(stepDefType.equals(StepDefinitionType.INGESTION) || stepDefType.equals(StepDefinitionType.MAPPING) ||\n+                stepDefType.equals(StepDefinitionType.CUSTOM),\n+            \"Can only create a step of type 'ingestion', 'mapping' or 'custom'\");\n+\n+\n+        StepDefinition stepDefinition = null;\n+        JsonNode step;\n+        StringBuilder messageBuilder = new StringBuilder();\n+        File stepFile = hubConfig.getHubProject().getStepFile(stepDefType, stepName);\n         if (stepFile.exists()) {\n             throw new IllegalArgumentException(\"Cannot create step; a step file already exists at: \" + stepFile.getAbsolutePath() + \". Please choose a different name for your step.\");\n         }\n         stepFile.getParentFile().mkdirs();\n \n         ObjectMapper objectMapper = new ObjectMapper();\n-        ObjectNode step = objectMapper.createObjectNode();\n-        step.put(\"name\", name);\n-        step.put(\"description\", \"\");\n-\n-        String message = null;\n-        if (StepDefinition.StepDefinitionType.INGESTION.equals(stepType)) {\n-            step.put(\"sourceFormat\", \"json\");\n-            step.put(\"targetFormat\", \"json\");\n-        } else {\n-            step.put(\"targetEntityType\", \"http://example.org/EntityName-1.0.0/EntityName\");\n-            step.put(\"selectedSource\", \"query\");\n-            step.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n-            message = \"The mapping step file will need to be modified before usage, as it has example values for targetEntityType and sourceQuery.\";\n+        ObjectNode stepPayLoad = objectMapper.createObjectNode();\n+        stepPayLoad.put(\"name\", stepName);\n+        stepPayLoad.put(\"description\", \"\");\n+        stepPayLoad.put(\"stepDefinitionType\", stepType);\n+        if(stepDefName != null) {\n+            stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+        }\n+        else {\n+            if(StepDefinitionType.CUSTOM.equals(stepDefType)){\n+                stepDefName = stepName;\n+                stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+            }\n+        }\n+\n+        if (StepDefinitionType.INGESTION.equals(stepDefType)) {\n+            stepPayLoad.put(\"sourceFormat\", \"json\");\n+            stepPayLoad.put(\"targetFormat\", \"json\");\n+        }\n+        else {\n+            stepPayLoad.put(\"selectedSource\", \"query\");\n+            stepPayLoad.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n+            if(entityType != null){\n+                stepPayLoad.put(\"entityType\", entityType);\n+            }\n+        }\n+\n+        if (stepDefName != null && stepDefinitionManager.getStepDefinition(stepDefName, StepDefinitionType.getStepDefinitionType(stepType)) == null) {\n+            stepDefinition = StepDefinition.create(stepDefName, StepDefinitionType.getStepDefinitionType(stepType));\n+            createCustomModule(stepDefName, stepType);\n+            stepDefinition.setModulePath(\"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\");\n+            stepDefinitionManager.saveStepDefinition(stepDefinition);\n+            messageBuilder.append(String.format(\"Created Step definition '%s' of type '%s'.\", stepName, stepType));\n+            messageBuilder.append(\"The module file for the step definition is available at \"", "originalCommit": "4415448dc457759f3a7967b45bba8eb32001c045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzNjIyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4319#discussion_r463236221", "bodyText": "\"Please run\" sounds like it's required, but it's not - we're just recommending it. Let's instead say \"It is recommended to run './gradlew -i mlWatch' so that as you modify the module, it will be automatically loaded into your application's modules database.\" And let's put that on a new line as well.", "author": "rjrudin", "createdAt": "2020-07-30T19:56:17Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ScaffoldingImpl.java", "diffHunk": "@@ -77,44 +86,86 @@ public static String getAbsolutePath(String first, String... more) {\n     }\n \n     /**\n-     * Create a step file  based on the given name and type.\n+     * Create a step file  based on the given stepName, stepType, entityType (for non ingestion steps),\n+     *  and stepDefName.\n      *\n-     * @param name\n-     * @param type\n+     * @param stepName\n+     * @param stepType\n+     * @param stepDefName\n+     * @param entityType\n      * @return a Pair with a File representing the created file, and a String representing an optional message that,\n      * if not null, should likely be presented to the caller\n      */\n-    public Pair<File, String> createStepFile(String name, String type) {\n-        StepDefinition.StepDefinitionType stepType = StepDefinition.StepDefinitionType.getStepDefinitionType(type);\n-        Assert.notNull(stepType, \"Unrecognized step type: \" + type);\n-        Assert.isTrue(stepType.equals(StepDefinition.StepDefinitionType.INGESTION) || stepType.equals(StepDefinition.StepDefinitionType.MAPPING),\n-            \"Can only create a step of type 'ingestion' or 'mapping'\");\n-\n-        File stepFile = hubConfig.getHubProject().getStepFile(stepType, name);\n+    public Pair<File, String> createStepFile(String stepName, String stepType, String stepDefName, String entityType) {\n+        StepDefinitionType stepDefType = StepDefinitionType.getStepDefinitionType(stepType);\n+        Assert.notNull(stepDefType, \"Unrecognized step type: \" + stepType);\n+        Assert.isTrue(stepDefType.equals(StepDefinitionType.INGESTION) || stepDefType.equals(StepDefinitionType.MAPPING) ||\n+                stepDefType.equals(StepDefinitionType.CUSTOM),\n+            \"Can only create a step of type 'ingestion', 'mapping' or 'custom'\");\n+\n+\n+        StepDefinition stepDefinition = null;\n+        JsonNode step;\n+        StringBuilder messageBuilder = new StringBuilder();\n+        File stepFile = hubConfig.getHubProject().getStepFile(stepDefType, stepName);\n         if (stepFile.exists()) {\n             throw new IllegalArgumentException(\"Cannot create step; a step file already exists at: \" + stepFile.getAbsolutePath() + \". Please choose a different name for your step.\");\n         }\n         stepFile.getParentFile().mkdirs();\n \n         ObjectMapper objectMapper = new ObjectMapper();\n-        ObjectNode step = objectMapper.createObjectNode();\n-        step.put(\"name\", name);\n-        step.put(\"description\", \"\");\n-\n-        String message = null;\n-        if (StepDefinition.StepDefinitionType.INGESTION.equals(stepType)) {\n-            step.put(\"sourceFormat\", \"json\");\n-            step.put(\"targetFormat\", \"json\");\n-        } else {\n-            step.put(\"targetEntityType\", \"http://example.org/EntityName-1.0.0/EntityName\");\n-            step.put(\"selectedSource\", \"query\");\n-            step.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n-            message = \"The mapping step file will need to be modified before usage, as it has example values for targetEntityType and sourceQuery.\";\n+        ObjectNode stepPayLoad = objectMapper.createObjectNode();\n+        stepPayLoad.put(\"name\", stepName);\n+        stepPayLoad.put(\"description\", \"\");\n+        stepPayLoad.put(\"stepDefinitionType\", stepType);\n+        if(stepDefName != null) {\n+            stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+        }\n+        else {\n+            if(StepDefinitionType.CUSTOM.equals(stepDefType)){\n+                stepDefName = stepName;\n+                stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+            }\n+        }\n+\n+        if (StepDefinitionType.INGESTION.equals(stepDefType)) {\n+            stepPayLoad.put(\"sourceFormat\", \"json\");\n+            stepPayLoad.put(\"targetFormat\", \"json\");\n+        }\n+        else {\n+            stepPayLoad.put(\"selectedSource\", \"query\");\n+            stepPayLoad.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n+            if(entityType != null){\n+                stepPayLoad.put(\"entityType\", entityType);\n+            }\n+        }\n+\n+        if (stepDefName != null && stepDefinitionManager.getStepDefinition(stepDefName, StepDefinitionType.getStepDefinitionType(stepType)) == null) {\n+            stepDefinition = StepDefinition.create(stepDefName, StepDefinitionType.getStepDefinitionType(stepType));\n+            createCustomModule(stepDefName, stepType);\n+            stepDefinition.setModulePath(\"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\");\n+            stepDefinitionManager.saveStepDefinition(stepDefinition);\n+            messageBuilder.append(String.format(\"Created Step definition '%s' of type '%s'.\", stepName, stepType));\n+            messageBuilder.append(\"The module file for the step definition is available at \"\n+                + \"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\" + \". Please run mlWatch while you edit the custom module\\n\");", "originalCommit": "4415448dc457759f3a7967b45bba8eb32001c045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzIzNjcyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4319#discussion_r463236725", "bodyText": "For consistency with the message about the step definition, do \"Created step\" instead of \"Created a step\" (I'm very picky about messages we show to users).", "author": "rjrudin", "createdAt": "2020-07-30T19:57:18Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ScaffoldingImpl.java", "diffHunk": "@@ -77,44 +86,86 @@ public static String getAbsolutePath(String first, String... more) {\n     }\n \n     /**\n-     * Create a step file  based on the given name and type.\n+     * Create a step file  based on the given stepName, stepType, entityType (for non ingestion steps),\n+     *  and stepDefName.\n      *\n-     * @param name\n-     * @param type\n+     * @param stepName\n+     * @param stepType\n+     * @param stepDefName\n+     * @param entityType\n      * @return a Pair with a File representing the created file, and a String representing an optional message that,\n      * if not null, should likely be presented to the caller\n      */\n-    public Pair<File, String> createStepFile(String name, String type) {\n-        StepDefinition.StepDefinitionType stepType = StepDefinition.StepDefinitionType.getStepDefinitionType(type);\n-        Assert.notNull(stepType, \"Unrecognized step type: \" + type);\n-        Assert.isTrue(stepType.equals(StepDefinition.StepDefinitionType.INGESTION) || stepType.equals(StepDefinition.StepDefinitionType.MAPPING),\n-            \"Can only create a step of type 'ingestion' or 'mapping'\");\n-\n-        File stepFile = hubConfig.getHubProject().getStepFile(stepType, name);\n+    public Pair<File, String> createStepFile(String stepName, String stepType, String stepDefName, String entityType) {\n+        StepDefinitionType stepDefType = StepDefinitionType.getStepDefinitionType(stepType);\n+        Assert.notNull(stepDefType, \"Unrecognized step type: \" + stepType);\n+        Assert.isTrue(stepDefType.equals(StepDefinitionType.INGESTION) || stepDefType.equals(StepDefinitionType.MAPPING) ||\n+                stepDefType.equals(StepDefinitionType.CUSTOM),\n+            \"Can only create a step of type 'ingestion', 'mapping' or 'custom'\");\n+\n+\n+        StepDefinition stepDefinition = null;\n+        JsonNode step;\n+        StringBuilder messageBuilder = new StringBuilder();\n+        File stepFile = hubConfig.getHubProject().getStepFile(stepDefType, stepName);\n         if (stepFile.exists()) {\n             throw new IllegalArgumentException(\"Cannot create step; a step file already exists at: \" + stepFile.getAbsolutePath() + \". Please choose a different name for your step.\");\n         }\n         stepFile.getParentFile().mkdirs();\n \n         ObjectMapper objectMapper = new ObjectMapper();\n-        ObjectNode step = objectMapper.createObjectNode();\n-        step.put(\"name\", name);\n-        step.put(\"description\", \"\");\n-\n-        String message = null;\n-        if (StepDefinition.StepDefinitionType.INGESTION.equals(stepType)) {\n-            step.put(\"sourceFormat\", \"json\");\n-            step.put(\"targetFormat\", \"json\");\n-        } else {\n-            step.put(\"targetEntityType\", \"http://example.org/EntityName-1.0.0/EntityName\");\n-            step.put(\"selectedSource\", \"query\");\n-            step.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n-            message = \"The mapping step file will need to be modified before usage, as it has example values for targetEntityType and sourceQuery.\";\n+        ObjectNode stepPayLoad = objectMapper.createObjectNode();\n+        stepPayLoad.put(\"name\", stepName);\n+        stepPayLoad.put(\"description\", \"\");\n+        stepPayLoad.put(\"stepDefinitionType\", stepType);\n+        if(stepDefName != null) {\n+            stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+        }\n+        else {\n+            if(StepDefinitionType.CUSTOM.equals(stepDefType)){\n+                stepDefName = stepName;\n+                stepPayLoad.put(\"stepDefinitionName\", stepDefName);\n+            }\n+        }\n+\n+        if (StepDefinitionType.INGESTION.equals(stepDefType)) {\n+            stepPayLoad.put(\"sourceFormat\", \"json\");\n+            stepPayLoad.put(\"targetFormat\", \"json\");\n+        }\n+        else {\n+            stepPayLoad.put(\"selectedSource\", \"query\");\n+            stepPayLoad.put(\"sourceQuery\", \"cts.collectionQuery('changeme')\");\n+            if(entityType != null){\n+                stepPayLoad.put(\"entityType\", entityType);\n+            }\n+        }\n+\n+        if (stepDefName != null && stepDefinitionManager.getStepDefinition(stepDefName, StepDefinitionType.getStepDefinitionType(stepType)) == null) {\n+            stepDefinition = StepDefinition.create(stepDefName, StepDefinitionType.getStepDefinitionType(stepType));\n+            createCustomModule(stepDefName, stepType);\n+            stepDefinition.setModulePath(\"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\");\n+            stepDefinitionManager.saveStepDefinition(stepDefinition);\n+            messageBuilder.append(String.format(\"Created Step definition '%s' of type '%s'.\", stepName, stepType));\n+            messageBuilder.append(\"The module file for the step definition is available at \"\n+                + \"/custom-modules/\" + stepType.toLowerCase() + \"/\" + stepDefName + \"/main.sjs\" + \". Please run mlWatch while you edit the custom module\\n\");\n+        }\n+        messageBuilder.append(\"Created a step '\" + stepName + \"' of type '\" + stepType + \"' with default properties. It will need to be modified before usage.\");", "originalCommit": "4415448dc457759f3a7967b45bba8eb32001c045", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6c9946daf050eac9c0f86eb3c344ce1442683e16", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6c9946daf050eac9c0f86eb3c344ce1442683e16", "message": "DHFPROD-5265:Create step via Gradle", "committedDate": "2020-07-30T20:27:42Z", "type": "commit"}, {"oid": "6c9946daf050eac9c0f86eb3c344ce1442683e16", "url": "https://github.com/marklogic/marklogic-data-hub/commit/6c9946daf050eac9c0f86eb3c344ce1442683e16", "message": "DHFPROD-5265:Create step via Gradle", "committedDate": "2020-07-30T20:27:42Z", "type": "forcePushed"}]}