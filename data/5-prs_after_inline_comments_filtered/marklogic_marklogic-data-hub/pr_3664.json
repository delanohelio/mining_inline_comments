{"pr_number": 3664, "pr_title": "DHFPROD-4337: Middle-tier support upload with various zip types & add\u2026", "pr_createdAt": "2020-03-09T06:40:10Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3664", "timeline": [{"oid": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632", "url": "https://github.com/marklogic/marklogic-data-hub/commit/731ed65bc9aa0d0ffcd9ad381e36df8a6306a632", "message": "DHFPROD-4337: Middle-tier support upload with various zip types & add test cases", "committedDate": "2020-03-09T06:39:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNTI2Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r389625263", "bodyText": "Just use FileCopyUtils here instead:\nByteArraOutputStream out = new ByteArrayOutputStream();\nFileCopyUtils.copy(in, out);\nreturn new ByteArrayInputStream(out.toByteArray());", "author": "rjrudin", "createdAt": "2020-03-09T12:21:14Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/services/DataHubProjectUtils.java", "diffHunk": "@@ -140,4 +167,62 @@ public static void extractZipProject(HubProject project, InputStream in, UIDeplo\n         }\n         listener.onStatusChange(0, String.format(\"Completed extracting the uploaded zip project into (%s)\", currProjectDir.toFile().getAbsolutePath()));\n     }\n+\n+    private static InputStream toByteArrayInputStream(InputStream in) {\n+        if (in instanceof ByteArrayInputStream) {\n+            return in;\n+        }\n+        byte[] buff = new byte[8000];", "originalCommit": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNzc2Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r389627763", "bodyText": "It looks like TestHelper already has properties for test.adminUsername and test.adminPassword, so there's no need to do this - the line doesn't really make sense either, as we can safely assume there's an admin user with the admin role.\nAlso, to mirror similar methods in HubTestBase, call this \"runAsAdminUser\".", "author": "rjrudin", "createdAt": "2020-03-09T12:26:28Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/TestHelper.java", "diffHunk": "@@ -79,6 +79,12 @@ public void authenticateSession() {\n        hubConfig.setCredentials(environmentInfo, dataHubDeveloperUsername, dataHubDeveloperPassword);\n     }\n \n+    public void authenticateSessionAsAdmin() {\n+        createUser(\"admin\", \"admin\",\"admin\");", "originalCommit": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxMzgwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r390513807", "bodyText": "@hao1st  Can't this line be removed? There shouldn't be any reason to try to create an admin user.", "author": "rjrudin", "createdAt": "2020-03-10T18:10:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNzc2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxOTkyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r390519920", "bodyText": "@rjrudin I will fall back it to Environment Manager user instead of user though i did not get why we could not use \"admin\".", "author": "hao1st", "createdAt": "2020-03-10T18:20:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYyNzc2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTYzMTU0MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r389631540", "bodyText": "I highly recommend unit tests to verify this functionality. There's a lot of code being added here, and the new test in EnvironmentControllerTest verifies it at an integration level. But if something goes wrong, it'll be difficult to debug because we don't have any unit tests verifying any of the new logic.\nLooking at what this method outputs, it's not clear to me what this method is doing. The name implies an \"archive folder\" is being returned, so I'm first wondering why a Path or File isn't returned. I also see \"return null\" at the bottom - what does that mean if that happens? Unit tests would both verify that this functionality works correctly and document the purposes of the method as well.", "author": "rjrudin", "createdAt": "2020-03-09T12:34:24Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/services/DataHubProjectUtils.java", "diffHunk": "@@ -140,4 +167,62 @@ public static void extractZipProject(HubProject project, InputStream in, UIDeplo\n         }\n         listener.onStatusChange(0, String.format(\"Completed extracting the uploaded zip project into (%s)\", currProjectDir.toFile().getAbsolutePath()));\n     }\n+\n+    private static InputStream toByteArrayInputStream(InputStream in) {\n+        if (in instanceof ByteArrayInputStream) {\n+            return in;\n+        }\n+        byte[] buff = new byte[8000];\n+        int bytesRead = 0;\n+        ByteArrayOutputStream bao = new ByteArrayOutputStream();\n+        try {\n+            while ((bytesRead = in.read(buff)) != -1) {\n+                bao.write(buff, 0, bytesRead);\n+            }\n+        } catch (IOException e) {\n+            throw new RuntimeException(String.format(\"Failed to convert to ByteArrayInputStream due to (%s)\", e.getMessage()));\n+        }\n+        byte[] data = bao.toByteArray();\n+        ByteArrayInputStream bin = new ByteArrayInputStream(data);\n+        return bin;\n+    }\n+\n+    private static String getArchiveFolderOfZipFile(Path currProjectDir, InputStream in) {", "originalCommit": "731ed65bc9aa0d0ffcd9ad381e36df8a6306a632", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "72ae01e46c47adf2e17aa08f3a0a315896b42e6c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/72ae01e46c47adf2e17aa08f3a0a315896b42e6c", "message": "DHFPROD-4337: refactor & add unit test cases", "committedDate": "2020-03-09T18:10:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNDMyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r390514325", "bodyText": "Just make these methods protected - that's common for unit-testing purposes.", "author": "rjrudin", "createdAt": "2020-03-10T18:11:36Z", "path": "one-ui/src/test/java/com/marklogic/hub/oneui/services/DataHubProjectUtilsTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.marklogic.hub.oneui.services;\n+\n+import com.marklogic.hub.curation.controllers.EnvironmentControllerTest;\n+import java.io.ByteArrayInputStream;\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.InputStream;\n+import java.lang.reflect.InvocationTargetException;\n+import java.lang.reflect.Method;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+\n+public class DataHubProjectUtilsTest {\n+\n+    @Test\n+    public void testExtractZipFileWithoutArchiveFolder() throws Exception {\n+        File file = new File(EnvironmentControllerTest.class.getClassLoader().getResource(\"dhfWithoutArchiveFolder.zip\").getFile());\n+        FileInputStream input = new FileInputStream(file);\n+\n+        Method method = DataHubProjectUtils.class.getDeclaredMethod(\"toByteArrayInputStream\", InputStream.class);", "originalCommit": "72ae01e46c47adf2e17aa08f3a0a315896b42e6c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNTQ5MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r390515490", "bodyText": "@rjrudin it is arguable though i do not feel it is good to do that. But it is harmless for me.", "author": "hao1st", "createdAt": "2020-03-10T18:13:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNDMyNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxODgyMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3664#discussion_r390518820", "bodyText": "Protected methods can still be changed between minor releases. You can also do package-level protection, which works as long as your test class is in the same package as your class.", "author": "rjrudin", "createdAt": "2020-03-10T18:19:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxNDMyNQ=="}], "type": "inlineReview"}, {"oid": "259e26dac7596e23b7eb5a53ed28ed87a3dc796f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/259e26dac7596e23b7eb5a53ed28ed87a3dc796f", "message": "DHFPROD-4337: changed based on comments", "committedDate": "2020-03-10T18:28:03Z", "type": "commit"}, {"oid": "fdc1edf5c4a15db20706d04d9a12ae6dd03e900d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fdc1edf5c4a15db20706d04d9a12ae6dd03e900d", "message": "DHFPROD-4337: fix one test error", "committedDate": "2020-03-10T18:35:01Z", "type": "commit"}]}