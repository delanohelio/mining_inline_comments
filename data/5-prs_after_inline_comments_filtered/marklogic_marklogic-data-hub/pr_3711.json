{"pr_number": 3711, "pr_title": "DHFPROD-4608: Settings for loadData/mapping/matching/merging should b\u2026", "pr_createdAt": "2020-03-17T03:44:36Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3711", "timeline": [{"oid": "1e7e3906dc0ef71b118b3aaf116e1168e6c71854", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1e7e3906dc0ef71b118b3aaf116e1168e6c71854", "message": "DHFPROD-4608: Settings for loadData/mapping/matching/merging should be persisted in filesystem", "committedDate": "2020-03-18T17:50:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3MTA0Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3711#discussion_r394571047", "bodyText": "Use !artifact.has(\"artifactName\") .\nAlso - would this really ever happen? And if it did, wouldn't we want to throw an error? Just logging it and moving on doesn't seem good, as something is really wrong if an artifact doesn't have a name.\nI think this code can assume that artifactName exists. If it doesn't, either the proceeding code will throw an error, or we can eagerly throw an exception. But it seems like the call to save the artifact in ML would have already failed too, right?", "author": "rjrudin", "createdAt": "2020-03-18T18:54:39Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "diffHunk": "@@ -70,16 +76,28 @@ public ObjectNode getArtifactSettings(String artifactType, String artifactName)\n     }\n \n     public ObjectNode updateArtifactSettings(String artifactType, String artifactName, JsonNode settings) {\n-        return (ObjectNode) getArtifactService().setArtifactSettings(artifactType, artifactName, settings);\n+        ObjectNode resp = (ObjectNode) getArtifactService().setArtifactSettings(artifactType, artifactName, settings);\n+        writeArtifactInProject(artifactType, (ObjectNode) settings, true);\n+        return resp;\n     }\n \n     protected ArtifactService getArtifactService() {\n         DatabaseClient dataServicesClient = hubConfig.newStagingClient(null);\n         return ArtifactService.on(dataServicesClient);\n     }\n \n-    protected void writeArtifactInProject(String artifactType, ObjectNode artifact) {\n-        Path fileLocation = buildArtifactProjectLocation(artifactType, getNameFromArtifact(artifactType, artifact), getVersionFromArtifact(artifactType, artifact));\n+    protected void writeArtifactInProject(String artifactType, ObjectNode artifact, boolean isSetting) {\n+        Path fileLocation;\n+        if (!isSetting) {\n+            fileLocation = buildArtifactProjectLocation(artifactType, getNameFromArtifact(artifactType, artifact), getVersionFromArtifact(artifactType, artifact), false);\n+        } else {\n+            if (artifact.get(\"artifactName\") == null ||  artifact.get(\"artifactName\").asText().length() == 0) {", "originalCommit": "1e7e3906dc0ef71b118b3aaf116e1168e6c71854", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3NDY2Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3711#discussion_r394574667", "bodyText": "yes, it is why i just log it and stop here without throwing an exception. I can change !artifact.has(\"artifactName\")", "author": "hao1st", "createdAt": "2020-03-18T19:01:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3MTA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYwNzcxNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3711#discussion_r394607715", "bodyText": "I'm thinking we do want an exception thrown though. It's a big deal if an artifact can't be written to the filesystem, right? A remote user will never see that log message.", "author": "rjrudin", "createdAt": "2020-03-18T20:04:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3MTA0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDYxMzU0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3711#discussion_r394613545", "bodyText": "@rjrudin it is a artifact setting info and should always have an artifactName associated. We double-check it (may be bad data imported) because we do not want to store settings without any artifact. I can throw an exception and I am not sure what exception we should throw.", "author": "hao1st", "createdAt": "2020-03-18T20:16:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDU3MTA0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NDY1NjI3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3711#discussion_r394656277", "bodyText": "Since we assume that artifactName is not null, just let an exception propagate when \"asText()\" is called. If we want something nicer, we can check to see if \"artifactName\" doesn't exist and then do something like this:\nthrow new RuntimeException(\"Unable to write artifact to project folder; no artifactName found\")", "author": "rjrudin", "createdAt": "2020-03-18T21:42:25Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "diffHunk": "@@ -70,16 +76,28 @@ public ObjectNode getArtifactSettings(String artifactType, String artifactName)\n     }\n \n     public ObjectNode updateArtifactSettings(String artifactType, String artifactName, JsonNode settings) {\n-        return (ObjectNode) getArtifactService().setArtifactSettings(artifactType, artifactName, settings);\n+        ObjectNode resp = (ObjectNode) getArtifactService().setArtifactSettings(artifactType, artifactName, settings);\n+        writeArtifactInProject(artifactType, (ObjectNode) settings, true);\n+        return resp;\n     }\n \n     protected ArtifactService getArtifactService() {\n         DatabaseClient dataServicesClient = hubConfig.newStagingClient(null);\n         return ArtifactService.on(dataServicesClient);\n     }\n \n-    protected void writeArtifactInProject(String artifactType, ObjectNode artifact) {\n-        Path fileLocation = buildArtifactProjectLocation(artifactType, getNameFromArtifact(artifactType, artifact), getVersionFromArtifact(artifactType, artifact));\n+    protected void writeArtifactInProject(String artifactType, ObjectNode artifact, boolean isSetting) {\n+        Path fileLocation;\n+        if (!isSetting) {\n+            fileLocation = buildArtifactProjectLocation(artifactType, getNameFromArtifact(artifactType, artifact), getVersionFromArtifact(artifactType, artifact), false);\n+        } else {\n+            if (!artifact.has(\"artifactName\") || artifact.get(\"artifactName\").asText().length() == 0) {\n+                logger.error(\"Failed to write to project folder due to invalid settings! artifactType: (%s), artifact settings: (%s).\", artifactType, artifact.toString());", "originalCommit": "99b9d7547b57077e3b20bdf1e86c13a40b8ec73f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9d4b14f91343c22b1096a084ae3be0dc3a682522", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9d4b14f91343c22b1096a084ae3be0dc3a682522", "message": "DHFPROD-4608: Settings for loadData/mapping/matching/merging should be persisted in filesystem", "committedDate": "2020-03-18T23:26:51Z", "type": "commit"}, {"oid": "110fa637446bd01aa8dd3cbd9b9d58bf75260d6a", "url": "https://github.com/marklogic/marklogic-data-hub/commit/110fa637446bd01aa8dd3cbd9b9d58bf75260d6a", "message": "DHFPROD-4608: use JsonNode has(...) method", "committedDate": "2020-03-18T23:26:51Z", "type": "commit"}, {"oid": "686e5f3c3a7321df24f649b099ab1e82a8621fce", "url": "https://github.com/marklogic/marklogic-data-hub/commit/686e5f3c3a7321df24f649b099ab1e82a8621fce", "message": "DHFPROD-4608: add exception", "committedDate": "2020-03-18T23:27:55Z", "type": "commit"}, {"oid": "686e5f3c3a7321df24f649b099ab1e82a8621fce", "url": "https://github.com/marklogic/marklogic-data-hub/commit/686e5f3c3a7321df24f649b099ab1e82a8621fce", "message": "DHFPROD-4608: add exception", "committedDate": "2020-03-18T23:27:55Z", "type": "forcePushed"}]}