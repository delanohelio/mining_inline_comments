{"pr_number": 4636, "pr_title": "DHFPROD-5950: Exploring curated entities from staging and final databases", "pr_createdAt": "2020-09-29T16:31:26Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4636", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NDgzNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#discussion_r496894835", "bodyText": "To ensure an NPE is never possible here, do \"staging\".equalsIgnoreCase(database)", "author": "rjrudin", "createdAt": "2020-09-29T16:55:31Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/controllers/EntitySearchController.java", "diffHunk": "@@ -138,31 +138,40 @@ public JsonNode getFacetValuesRange(@RequestBody @ApiParam(hidden = true) JsonNo\n     @ResponseBody\n     @Secured(\"ROLE_exportEntityInstances\")\n     @ApiOperation(\"Returns CSV data\")\n-    public ResponseEntity<StreamingResponseBody> export(@RequestParam String queryDocument, @RequestParam String fileType, @RequestParam(required = false) Long limit, final HttpServletResponse response) {\n-        StreamingResponseBody stream = out -> {\n-            newEntitySearchManager().exportByQuery(new ObjectMapper().readTree(queryDocument), fileType, limit, out, response);\n-        };\n-\n+    public ResponseEntity<StreamingResponseBody> export(@RequestParam String queryDocument,\n+                                                        @RequestParam String fileType,\n+                                                        @RequestParam(required = false) Long limit,\n+                                                        final HttpServletResponse response,\n+                                                        @RequestParam(defaultValue = \"final\") String database) {\n+        StreamingResponseBody stream = out -> newEntitySearchManager(database).exportByQuery(new ObjectMapper().readTree(queryDocument), fileType, limit, out, response);\n         return ResponseEntity.ok(stream);\n     }\n \n     @RequestMapping(method = RequestMethod.GET, value = \"/export/query/{queryId}\")\n     @ResponseBody\n     @Secured(\"ROLE_exportEntityInstances\")\n     @ApiOperation(\"Returns CSV data\")\n-    public ResponseEntity<StreamingResponseBody> exportSavedQuery(@PathVariable String queryId, @RequestParam String fileType, @RequestParam(required = false) Long limit, final HttpServletResponse response) {\n-        StreamingResponseBody stream = out -> {\n-            newEntitySearchManager().exportById(queryId, fileType, limit, out, response);\n-        };\n-\n+    public ResponseEntity<StreamingResponseBody> exportSavedQuery(@PathVariable String queryId,\n+                                                                  @RequestParam String fileType,\n+                                                                  @RequestParam(required = false) Long limit,\n+                                                                  final HttpServletResponse response,\n+                                                                  @RequestParam(defaultValue = \"final\") String database) {\n+        StreamingResponseBody stream = out -> newEntitySearchManager(database).exportById(queryId, fileType, limit, out, response);\n         return ResponseEntity.ok(stream);\n     }\n \n-    private EntitySearchManager newEntitySearchManager() {\n-        return new EntitySearchManager(getHubClient());\n+    private EntitySearchManager newEntitySearchManager(String database) {\n+        return new EntitySearchManager(getHubClient(), database);\n     }\n \n     private EntitySearchService getEntitySearchService() {\n+        return getEntitySearchService(\"final\");\n+    }\n+\n+    private EntitySearchService getEntitySearchService(String database) {\n+        if(database.equalsIgnoreCase(\"staging\")) {", "originalCommit": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NTIzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#discussion_r496895237", "bodyText": "Same thing, \"staging\".equals", "author": "rjrudin", "createdAt": "2020-09-29T16:56:09Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -79,17 +76,31 @@\n \n     public static String QUERY_OPTIONS = \"exp-final-entity-options\";\n     private static Map<String, FacetHandler> facetHandlerMap;\n-    private DatabaseClient finalDatabaseClient;\n+    private DatabaseClient databaseClient;\n+    private DatabaseClient savedQueryDatabaseClient;\n     private ModelManager modelManager;\n \n     public EntitySearchManager(HubClient hubClient) {\n-        this.finalDatabaseClient = hubClient.getFinalClient();\n+        this.databaseClient = hubClient.getFinalClient();\n+        this.modelManager = new ModelManager(hubClient);\n+        initializeFacetHandlerMap();\n+    }\n+\n+    public EntitySearchManager(HubClient hubClient, String database) {\n+        if(database.equalsIgnoreCase(\"staging\")) {", "originalCommit": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njg5NjMyOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4636#discussion_r496896329", "bodyText": "The below variable has a really nice name, which raises the question of - what's this client used for? I think it'd be good to name this \"searchDatabaseClient\" or something similar to convey what this one is used for.", "author": "rjrudin", "createdAt": "2020-09-29T16:57:56Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -79,17 +76,31 @@\n \n     public static String QUERY_OPTIONS = \"exp-final-entity-options\";\n     private static Map<String, FacetHandler> facetHandlerMap;\n-    private DatabaseClient finalDatabaseClient;\n+    private DatabaseClient databaseClient;", "originalCommit": "6b7b4f06abc344053a8b987fd3ff812f5ece9a56", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957", "url": "https://github.com/marklogic/marklogic-data-hub/commit/89b7f7a9f132dcc7176ba08996699ccea9227957", "message": "DHFPROD-5950: Exploring curated entities from staging and final databases", "committedDate": "2020-09-29T17:20:33Z", "type": "commit"}, {"oid": "89b7f7a9f132dcc7176ba08996699ccea9227957", "url": "https://github.com/marklogic/marklogic-data-hub/commit/89b7f7a9f132dcc7176ba08996699ccea9227957", "message": "DHFPROD-5950: Exploring curated entities from staging and final databases", "committedDate": "2020-09-29T17:20:33Z", "type": "forcePushed"}]}