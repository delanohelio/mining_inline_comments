{"pr_number": 4843, "pr_title": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "pr_createdAt": "2020-11-10T18:14:16Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4843", "timeline": [{"oid": "1ae55164320975860d0ed9f46ad5ac08fa2422fe", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1ae55164320975860d0ed9f46ad5ac08fa2422fe", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-12T00:34:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2MjA4Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4843#discussion_r521762082", "bodyText": "We know path-namespaces exists in newProps - I don't see the point of this null check here?", "author": "rjrudin", "createdAt": "2020-11-12T01:33:37Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/DeployDatabaseFieldCommand.java", "diffHunk": "@@ -141,6 +142,30 @@ protected void addExistingRangePathIndexes(Fragment newProps, Fragment existingP\n         }\n     }\n \n+    protected void addExistingPathNamespaces(Fragment newProps, Fragment existingProps) {\n+        Element newNamespaces = newProps.getInternalDoc().getRootElement().getChild(\"path-namespaces\", MANAGE_NS);\n+        if(newNamespaces == null) {", "originalCommit": "1ae55164320975860d0ed9f46ad5ac08fa2422fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2MjQzMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4843#discussion_r521762432", "bodyText": "You don't need this check here - prefix is a required field, it's guaranteed to exist.", "author": "rjrudin", "createdAt": "2020-11-12T01:34:48Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/DeployDatabaseFieldCommand.java", "diffHunk": "@@ -141,6 +142,30 @@ protected void addExistingRangePathIndexes(Fragment newProps, Fragment existingP\n         }\n     }\n \n+    protected void addExistingPathNamespaces(Fragment newProps, Fragment existingProps) {\n+        Element newNamespaces = newProps.getInternalDoc().getRootElement().getChild(\"path-namespaces\", MANAGE_NS);\n+        if(newNamespaces == null) {\n+            String esNamespace = \"<path-namespaces><path-namespace><prefix>es</prefix><namespace-uri>http://marklogic.com/entity-services</namespace-uri>\" +\n+                    \"</path-namespace></path-namespaces>\";\n+            newNamespaces = newProps.getInternalDoc().getRootElement().addContent(esNamespace);\n+        }\n+\n+        List<String> newNamespacePrefixes = new ArrayList<>();\n+        newProps.getElements(\"/m:database-properties/m:path-namespaces/m:path-namespace\").forEach(namespace -> {\n+            String prefix = namespace.getChildText(\"prefix\", MANAGE_NS);\n+            if (StringUtils.isNotBlank(prefix)) {", "originalCommit": "1ae55164320975860d0ed9f46ad5ac08fa2422fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2MjYwMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4843#discussion_r521762602", "bodyText": "Same thing, don't need the isNotBlank check - if a path-namespace exists, it's guaranteed to have a prefix.", "author": "rjrudin", "createdAt": "2020-11-12T01:35:28Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/deploy/commands/DeployDatabaseFieldCommand.java", "diffHunk": "@@ -141,6 +142,30 @@ protected void addExistingRangePathIndexes(Fragment newProps, Fragment existingP\n         }\n     }\n \n+    protected void addExistingPathNamespaces(Fragment newProps, Fragment existingProps) {\n+        Element newNamespaces = newProps.getInternalDoc().getRootElement().getChild(\"path-namespaces\", MANAGE_NS);\n+        if(newNamespaces == null) {\n+            String esNamespace = \"<path-namespaces><path-namespace><prefix>es</prefix><namespace-uri>http://marklogic.com/entity-services</namespace-uri>\" +\n+                    \"</path-namespace></path-namespaces>\";\n+            newNamespaces = newProps.getInternalDoc().getRootElement().addContent(esNamespace);\n+        }\n+\n+        List<String> newNamespacePrefixes = new ArrayList<>();\n+        newProps.getElements(\"/m:database-properties/m:path-namespaces/m:path-namespace\").forEach(namespace -> {\n+            String prefix = namespace.getChildText(\"prefix\", MANAGE_NS);\n+            if (StringUtils.isNotBlank(prefix)) {\n+                newNamespacePrefixes.add(prefix);\n+            }\n+        });\n+\n+        for (Element namespace : existingProps.getElements(\"/m:database-properties/m:path-namespaces/m:path-namespace\")) {\n+            String prefix = namespace.getChildText(\"prefix\", MANAGE_NS);\n+            if (StringUtils.isNotBlank(prefix) && !newNamespacePrefixes.contains(prefix)) {", "originalCommit": "1ae55164320975860d0ed9f46ad5ac08fa2422fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTc2NzUyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4843#discussion_r521767522", "bodyText": "No need for a separate test here - just add the path-namespace stuff to the existing DeployDatabaseFieldCommandTest .", "author": "rjrudin", "createdAt": "2020-11-12T01:52:44Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/deploy/commands/DeployExistingNamespacesTest.java", "diffHunk": "@@ -0,0 +1,122 @@\n+package com.marklogic.hub.deploy.commands;\n+\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.DatabaseKind;\n+import com.marklogic.mgmt.api.API;\n+import com.marklogic.mgmt.api.database.Database;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import com.marklogic.mgmt.util.ObjectMapperFactory;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class DeployExistingNamespacesTest extends AbstractHubCoreTest {", "originalCommit": "1ae55164320975860d0ed9f46ad5ac08fa2422fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eb01e4fef2c6d68a5e4305bc781bad99c70126a9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/eb01e4fef2c6d68a5e4305bc781bad99c70126a9", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-12T15:32:41Z", "type": "forcePushed"}, {"oid": "84f930359cf641b482d6262e74e6355e6ad4aa14", "url": "https://github.com/marklogic/marklogic-data-hub/commit/84f930359cf641b482d6262e74e6355e6ad4aa14", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-13T07:00:26Z", "type": "forcePushed"}, {"oid": "1b7e0797f014283cc8c95b08937cd7eec6a008fe", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1b7e0797f014283cc8c95b08937cd7eec6a008fe", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-13T07:02:35Z", "type": "forcePushed"}, {"oid": "345384b5d8acb39ca0bdda6ad8d137e84403c7a1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/345384b5d8acb39ca0bdda6ad8d137e84403c7a1", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-13T15:34:00Z", "type": "forcePushed"}, {"oid": "e41fccfb9777bb7413430bb88e17b781271e01a4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e41fccfb9777bb7413430bb88e17b781271e01a4", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-13T17:27:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzEyMjczOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4843#discussion_r523122739", "bodyText": "The comment above this should be removed now - and really, we ought to explain why the project is being created here. So I think a comment of \"Need to create the project directory before applying properties\" (assuming that is the correct reason).", "author": "rjrudin", "createdAt": "2020-11-13T17:48:28Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/AbstractHubCentralTest.java", "diffHunk": "@@ -127,8 +128,8 @@ protected File getTestProjectDirectory() {\n     @Override\n     protected HubClient runAsUser(String username, String password) {\n         // Initialize a new HubConfigImpl\n-        testHubConfig = hubCentral.newHubConfig(username, password);\n-        testHubConfig.setHubProject(testHubProject);\n+        testHubConfig.createProject(testProjectDirectory);", "originalCommit": "e41fccfb9777bb7413430bb88e17b781271e01a4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eb2e34c7d7b40cacec557078a5c1d31b9ff1c9c3", "url": "https://github.com/marklogic/marklogic-data-hub/commit/eb2e34c7d7b40cacec557078a5c1d31b9ff1c9c3", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-13T17:50:43Z", "type": "commit"}, {"oid": "eb2e34c7d7b40cacec557078a5c1d31b9ff1c9c3", "url": "https://github.com/marklogic/marklogic-data-hub/commit/eb2e34c7d7b40cacec557078a5c1d31b9ff1c9c3", "message": "DHFPROD-5984: Adding indexes to filter on sourceName and sourceType as hub facets", "committedDate": "2020-11-13T17:50:43Z", "type": "forcePushed"}]}