{"pr_number": 4687, "pr_title": "DHFPROD-5999:Clear user artifacts from DHF instance", "pr_createdAt": "2020-10-08T05:55:07Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4687", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTczNDcyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4687#discussion_r501734724", "bodyText": "We want as much logic in ML as possible via data services, so I think an ArtifactService.clearUserArtifacts method is the right approach here.\nPinging @fsnow and @ryanjdew  for thoughts - I was thinking perhaps we should start a \"datahub\" service directory, where we have \"global\" methods like this. We also have a \"system\" service which just has getVersion in it. That arguably should be part of a datahub service.\nBut we can punt on reorganizing things right now, as I think ArtifactService.clearUserArtifacts is reasonable.\nI think the DS endpoint should only clear that database that it's associated with - thus, this method should still exist, and it'll call clearUserArtifacts using both a staging client and a final client.", "author": "rjrudin", "createdAt": "2020-10-08T13:47:49Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/DataHubImpl.java", "diffHunk": "@@ -405,6 +405,24 @@ public void clearUserModules(List<String> resourceNamesToNotDelete) {\n         logger.info(\"Finished clearing user modules\");\n     }\n \n+    public void clearUserArtifacts(){\n+        final HubClient hubClientToUse = hubClient != null ? hubClient : hubConfig.newHubClient();\n+\n+        long start = System.currentTimeMillis();\n+        logger.info(\"Clearing user artifacts as user: \" + hubClientToUse.getUsername());\n+\n+        String query = \"declareUpdate();\\n\" +", "originalCommit": "344740be53779bf712d02bf1ff2053ef4c97d7eb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTg5NzczNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4687#discussion_r501897736", "bodyText": "I agree that is would be nice to compile a list needs like this from the Java middle-tier and move as much of it as possible to be server-side.", "author": "ryanjdew", "createdAt": "2020-10-08T17:40:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTczNDcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTczNjE2NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4687#discussion_r501736164", "bodyText": "A good practice here is to make an assertion on what the exception message contains - that way, we know we're catching the expected exception. Can also catch a more precise exception here - I assume that ML is throwing a FailedRequestException.", "author": "rjrudin", "createdAt": "2020-10-08T13:49:42Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/impl/ClearUserArtifactsTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.marklogic.hub.impl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.test.ReferenceModelProject;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class ClearUserArtifactsTest extends AbstractHubCoreTest {\n+    int initialDbCount;\n+    @BeforeEach\n+    void setUp() {\n+        Assumptions.assumeTrue(isVersionCompatibleWith520Roles());\n+        initialDbCount = Integer.parseInt(getHubClient().getStagingClient().newServerEval().javascript(\"cts.estimate(cts.trueQuery())\").evalAs(String.class));\n+        // These 2 projects contain all kinds of user artifacts\n+        installProjectInFolder(\"test-projects/download-artifacts\");\n+        ReferenceModelProject project = installReferenceModelProject();\n+        project.createRawCustomer(1, \"Jane\");\n+    }\n+\n+    @Test\n+    void clearUserArtifacts() {\n+        try{\n+            new DataHubImpl(runAsDataHubOperator()).clearUserArtifacts();\n+            fail(\"'data-hub-operator' should not be able delete user artifacts\");\n+        }\n+        catch (Exception e){\n+            logger.info(\"'data-hub-operator' cannot delete user artifacts\");", "originalCommit": "344740be53779bf712d02bf1ff2053ef4c97d7eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTczNzMxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4687#discussion_r501737312", "bodyText": "This code is in 3 places here, and @rahulvudutala needed it in a PR, so let's add it to AbstractHubTest - e.g. \"getDocumentCount(DatabaseClient client)\". Try to work this into @rahulvudutala 's PR too.", "author": "rjrudin", "createdAt": "2020-10-08T13:51:11Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/impl/ClearUserArtifactsTest.java", "diffHunk": "@@ -0,0 +1,40 @@\n+package com.marklogic.hub.impl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.test.ReferenceModelProject;\n+import org.junit.jupiter.api.Assumptions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+class ClearUserArtifactsTest extends AbstractHubCoreTest {\n+    int initialDbCount;\n+    @BeforeEach\n+    void setUp() {\n+        Assumptions.assumeTrue(isVersionCompatibleWith520Roles());\n+        initialDbCount = Integer.parseInt(getHubClient().getStagingClient().newServerEval().javascript(\"cts.estimate(cts.trueQuery())\").evalAs(String.class));\n+        // These 2 projects contain all kinds of user artifacts\n+        installProjectInFolder(\"test-projects/download-artifacts\");\n+        ReferenceModelProject project = installReferenceModelProject();\n+        project.createRawCustomer(1, \"Jane\");\n+    }\n+\n+    @Test\n+    void clearUserArtifacts() {\n+        try{\n+            new DataHubImpl(runAsDataHubOperator()).clearUserArtifacts();\n+            fail(\"'data-hub-operator' should not be able delete user artifacts\");\n+        }\n+        catch (Exception e){\n+            logger.info(\"'data-hub-operator' cannot delete user artifacts\");\n+        }\n+        new DataHubImpl(runAsDataHubDeveloper()).clearUserArtifacts();\n+\n+        assertNotNull(getHubClient().getStagingClient().newServerEval().javascript(\"cts.doc('/customer1.json')\").evalAs(JsonNode.class));\n+        //The staging db will have one additional document  '/customer/1.json'\n+        assertEquals(initialDbCount , Integer.parseInt(getHubClient().getStagingClient().newServerEval().javascript(\"cts.estimate(cts.trueQuery())\").evalAs(String.class))-1);", "originalCommit": "344740be53779bf712d02bf1ff2053ef4c97d7eb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4681977b0a03bd5707fb2966aaa27c8a55f8a39", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c4681977b0a03bd5707fb2966aaa27c8a55f8a39", "message": "DHFPROD-5999:Clear user artifacts from DHF instance", "committedDate": "2020-10-08T21:26:24Z", "type": "forcePushed"}, {"oid": "0858c6a8e0fba0cc559f9ecf6bf7c91908a9dbe1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0858c6a8e0fba0cc559f9ecf6bf7c91908a9dbe1", "message": "DHFPROD-5999:Clear user artifacts from DHF instance", "committedDate": "2020-10-09T14:49:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjU1MDkyOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4687#discussion_r502550928", "bodyText": "Can you put this at the bottom of the file? Will help avoid merge conflicts (I'm making changes to this file too)", "author": "rjrudin", "createdAt": "2020-10-09T16:41:46Z", "path": "marklogic-data-hub/src/testFixtures/java/com/marklogic/hub/test/AbstractHubTest.java", "diffHunk": "@@ -207,6 +207,11 @@ protected void setTestUserRoles(String... roles) {\n         user.save();\n     }\n \n+    protected int getDocumentCount(DatabaseClient client) {", "originalCommit": "0858c6a8e0fba0cc559f9ecf6bf7c91908a9dbe1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "50d2f65855a278fa4d205300e3f310a722b0f9d4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/50d2f65855a278fa4d205300e3f310a722b0f9d4", "message": "DHFPROD-5999:Clear user artifacts from DHF instance", "committedDate": "2020-10-09T17:18:47Z", "type": "forcePushed"}, {"oid": "2fd6008ea0e98880806c3a77438a63e0be25638d", "url": "https://github.com/marklogic/marklogic-data-hub/commit/2fd6008ea0e98880806c3a77438a63e0be25638d", "message": "DHFPROD-5999:Clear user artifacts from DHF instance", "committedDate": "2020-10-09T18:30:29Z", "type": "forcePushed"}, {"oid": "45b3d2681275ab5f628cbafb3a06abeaf3212ac1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/45b3d2681275ab5f628cbafb3a06abeaf3212ac1", "message": "DHFPROD-5999:Clear user artifacts from DHF instance", "committedDate": "2020-10-09T18:32:40Z", "type": "commit"}, {"oid": "45b3d2681275ab5f628cbafb3a06abeaf3212ac1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/45b3d2681275ab5f628cbafb3a06abeaf3212ac1", "message": "DHFPROD-5999:Clear user artifacts from DHF instance", "committedDate": "2020-10-09T18:32:40Z", "type": "forcePushed"}]}