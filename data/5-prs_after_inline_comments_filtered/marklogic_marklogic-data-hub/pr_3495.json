{"pr_number": 3495, "pr_title": "DHFPROD-3990:Display project information in UI", "pr_createdAt": "2020-01-23T23:09:17Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3495", "timeline": [{"oid": "46dd34a573b0f3ead2b6eaa571edad9e86875cf8", "url": "https://github.com/marklogic/marklogic-data-hub/commit/46dd34a573b0f3ead2b6eaa571edad9e86875cf8", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-23T23:40:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzMzQ3Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370433477", "bodyText": "This logic is repeated above. Seems like HubProject should have a \"getProjectName()\" method, assuming that project name should always equal the name of the directory?\nAlso, since getProjectDir returns a Path, it seems better to call toFile().getName() instead of messing around with Strings.", "author": "rjrudin", "createdAt": "2020-01-24T01:06:27Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -122,4 +127,18 @@ public JsonNode reset() {\n         obj.put(\"reset\", true);\n         return obj;\n     }\n+\n+    @RequestMapping(value = \"/project-info\", method = RequestMethod.GET)\n+    @ResponseBody\n+    public JsonNode getProjectInfo(HttpSession session) {\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        ObjectNode resp = objectMapper.createObjectNode();\n+        resp.put(\"dhfVersion\", versions.getHubVersion());\n+        String projDir = hubConfig.getHubProject().getProjectDir().toString();\n+        projDir = projDir.substring(projDir.lastIndexOf(File.separator)+1);", "originalCommit": "46dd34a573b0f3ead2b6eaa571edad9e86875cf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzNDE1MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370434151", "bodyText": "This is really \"project name\", right? Not the project directory?", "author": "rjrudin", "createdAt": "2020-01-24T01:09:23Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/MarkLogicAuthenticationManager.java", "diffHunk": "@@ -113,8 +114,12 @@ public Authentication authenticate(Authentication authentication) throws Authent\n             stagingServerAccessible = dataServicesClient.checkConnection().isConnected();\n         } catch (Exception e) {\n         }\n+\n+        String projDir = environmentService.getProjectDirectory();\n+        projDir = projDir.substring(projDir.lastIndexOf(File.separator) + 1);", "originalCommit": "46dd34a573b0f3ead2b6eaa571edad9e86875cf8", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQ3MTk0OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370471949", "bodyText": "Yeah, but we don't have a \"project name\" currently. I talked to @ryanjdew  and he suggested that we use the project directory for now.", "author": "srinathgit", "createdAt": "2020-01-24T04:43:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzNDE1MQ=="}], "type": "inlineReview"}, {"oid": "a6ca76f4561180a91789a967285a9f7b8da2d685", "url": "https://github.com/marklogic/marklogic-data-hub/commit/a6ca76f4561180a91789a967285a9f7b8da2d685", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-24T05:07:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzMjYxNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370432616", "bodyText": "Do we need to add projDir as a security-related property?", "author": "hao1st", "createdAt": "2020-01-24T01:03:13Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/ConnectionAuthenticationToken.java", "diffHunk": "@@ -42,6 +42,7 @@\n     private final Object principal;\n     private boolean hasManagePrivileges = false;\n     private boolean stagingIsAccessible = false;\n+    private String projDir;", "originalCommit": "46dd34a573b0f3ead2b6eaa571edad9e86875cf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDQzMjgwOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370432808", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    resp.put(\"projDir\", authenticationToken.getProjDir());\n          \n          \n            \n                    resp.put(\"projDir\", environmentService.getProjectDirectory());", "author": "hao1st", "createdAt": "2020-01-24T01:04:04Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java", "diffHunk": "@@ -31,10 +33,15 @@\n     @Override\n     public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException {\n         ConnectionAuthenticationToken authenticationToken = (ConnectionAuthenticationToken)authentication;\n+        ObjectMapper mapper = new ObjectMapper();\n+        ObjectNode resp = mapper.createObjectNode();\n+        resp.put(\"isInstalled\", authenticationToken.stagingIsAccessible());\n+        resp.put(\"hasManagePrivileges\", authenticationToken.hasManagePrivileges());\n+        resp.put(\"projDir\", authenticationToken.getProjDir());", "originalCommit": "46dd34a573b0f3ead2b6eaa571edad9e86875cf8", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0558a11c2b8b1d6683661b57474f1f7b9183fc72", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0558a11c2b8b1d6683661b57474f1f7b9183fc72", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-24T06:49:17Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY1OTUzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370659537", "bodyText": "I commented on the JIRA ticket that I think we should get rid of this from the mockup. We don't have a concept of a \"Project Name\", and we shouldn't invent one during development. I think the requirement needs to be removed from the story.\nI can see an argument for the project directory, though I don't think that really needs to be there either.", "author": "rjrudin", "createdAt": "2020-01-24T14:25:45Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java", "diffHunk": "@@ -646,6 +646,11 @@ public void exportProject(File location) {\n         }\n     }\n \n+    @Override", "originalCommit": "0558a11c2b8b1d6683661b57474f1f7b9183fc72", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDgxMDc4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370810780", "bodyText": "I saw your comment and response from @sbayatpur on it. The suggestion from her is to use proj dir name for now. I think we can change it once she decides on 'Project Name'.", "author": "srinathgit", "createdAt": "2020-01-24T19:44:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY1OTUzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY1OTc2MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370659761", "bodyText": "If we keep this, should call this \"projectName\", not \"projDir\"", "author": "rjrudin", "createdAt": "2020-01-24T14:26:09Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/auth/LoginLogoutHandler.java", "diffHunk": "@@ -28,13 +32,21 @@\n \n public class LoginLogoutHandler implements AuthenticationSuccessHandler, LogoutSuccessHandler {\n \n+    @Autowired\n+    HubConfigSession hubConfig;\n+\n     @Override\n     public void onAuthenticationSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) throws IOException {\n         ConnectionAuthenticationToken authenticationToken = (ConnectionAuthenticationToken)authentication;\n+        ObjectMapper mapper = new ObjectMapper();\n+        ObjectNode resp = mapper.createObjectNode();\n+        resp.put(\"isInstalled\", authenticationToken.stagingIsAccessible());\n+        resp.put(\"hasManagePrivileges\", authenticationToken.hasManagePrivileges());\n+        resp.put(\"projDir\", hubConfig.getHubProject().getProjectName());", "originalCommit": "0558a11c2b8b1d6683661b57474f1f7b9183fc72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDY2MDU3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r370660575", "bodyText": "Let's spell these out, there's no benefit in shortening them - so \"projectName\" and \"projectPath\" (I think \"path\" is better than \"dir\" here, particularly because the output of getProjectDir is a Path (which means that method should really be called getProjectPath, but oh well)).", "author": "rjrudin", "createdAt": "2020-01-24T14:27:47Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -122,4 +126,16 @@ public JsonNode reset() {\n         obj.put(\"reset\", true);\n         return obj;\n     }\n+\n+    @RequestMapping(value = \"/project-info\", method = RequestMethod.GET)\n+    @ResponseBody\n+    public JsonNode getProjectInfo(HttpSession session) {\n+        ObjectMapper objectMapper = new ObjectMapper();\n+        ObjectNode resp = objectMapper.createObjectNode();\n+        resp.put(\"dhfVersion\", versions.getHubVersion());\n+        resp.put(\"projName\", hubConfig.getHubProject().getProjectName());", "originalCommit": "0558a11c2b8b1d6683661b57474f1f7b9183fc72", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d27f5cbb7589a76554bd7ea4f08b988778a34034", "url": "https://github.com/marklogic/marklogic-data-hub/commit/d27f5cbb7589a76554bd7ea4f08b988778a34034", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-24T19:40:30Z", "type": "forcePushed"}, {"oid": "a1662a87f426c0f75734cf629f95861538114752", "url": "https://github.com/marklogic/marklogic-data-hub/commit/a1662a87f426c0f75734cf629f95861538114752", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-24T19:42:15Z", "type": "forcePushed"}, {"oid": "9fca0877243ffb8d99b1d8da753e982ff34782c4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/9fca0877243ffb8d99b1d8da753e982ff34782c4", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-24T21:05:23Z", "type": "forcePushed"}, {"oid": "eb2466f33713356a89c7d085047be6fe9a004fc5", "url": "https://github.com/marklogic/marklogic-data-hub/commit/eb2466f33713356a89c7d085047be6fe9a004fc5", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-24T22:58:45Z", "type": "forcePushed"}, {"oid": "45d9a5e85beed5a874bc68585e928a45eed2ea35", "url": "https://github.com/marklogic/marklogic-data-hub/commit/45d9a5e85beed5a874bc68585e928a45eed2ea35", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-26T21:26:02Z", "type": "forcePushed"}, {"oid": "347363ce930447a5010288e9b6b2caa399fe0220", "url": "https://github.com/marklogic/marklogic-data-hub/commit/347363ce930447a5010288e9b6b2caa399fe0220", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-27T04:41:08Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0NTYxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r371245613", "bodyText": "What about tests for this? We'd at least want a smoke test to verify that there's not an e.g. obvious null-pointer exception.\nAlso, I think @hao1st  mentioned this too - based on the current design of oneui, couldn't HubProject be part of EnvironmentService? That would start removing one concern from HubConfig, which is overloaded with concerns right now. I think this would be a good move, as the HubProject is a global object that is part of the environment - it's not specific to a user.", "author": "rjrudin", "createdAt": "2020-01-27T13:43:24Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/controllers/EnvironmentController.java", "diffHunk": "@@ -122,4 +126,16 @@ public JsonNode reset() {\n         obj.put(\"reset\", true);\n         return obj;\n     }\n+\n+    @RequestMapping(value = \"/project-info\", method = RequestMethod.GET)\n+    @ResponseBody\n+    public JsonNode getProjectInfo(HttpSession session) {", "originalCommit": "347363ce930447a5010288e9b6b2caa399fe0220", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQxMzU1OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r371413559", "bodyText": "I will add a test .\nI don't think we can autowire HubProject in EnvironmentService. The first object created in one-ui is HubConfigSession and that is what we are using through out and that's why I had to access HubProject from HubConfigSession", "author": "srinathgit", "createdAt": "2020-01-27T18:41:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0NTYxMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ3MzQzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r371473437", "bodyText": "If HubProjectImpl is autowired in, then it's always available, right?\nI'll approve the PR, I just feel strongly that we need to stop using HubConfig, which is doing far too much, and use HubProject and a doesnt-yet-exist HubClient when possible.", "author": "rjrudin", "createdAt": "2020-01-27T20:47:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0NTYxMw=="}], "type": "inlineReview"}, {"oid": "7cc5643ccc833f7e6344a8c92041054cf9061997", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7cc5643ccc833f7e6344a8c92041054cf9061997", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-27T18:58:25Z", "type": "forcePushed"}, {"oid": "e0fece52a39616ffccbd94005a4da5a2934716c5", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e0fece52a39616ffccbd94005a4da5a2934716c5", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-27T20:07:14Z", "type": "commit"}, {"oid": "e0fece52a39616ffccbd94005a4da5a2934716c5", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e0fece52a39616ffccbd94005a4da5a2934716c5", "message": "DHFPROD-3990:Display project information in UI", "committedDate": "2020-01-27T20:07:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ3MjM5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r371472394", "bodyText": "Couldn't you depend on HubProject instead, since that's not specific to a user?", "author": "rjrudin", "createdAt": "2020-01-27T20:44:39Z", "path": "one-ui/src/main/java/com/marklogic/hub/oneui/services/EnvironmentService.java", "diffHunk": "@@ -15,21 +15,29 @@\n  */\n package com.marklogic.hub.oneui.services;\n \n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.impl.Versions;\n import com.marklogic.hub.oneui.models.EnvironmentInfo;\n+import com.marklogic.hub.oneui.models.HubConfigSession;\n+import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Service;\n \n-import java.io.ByteArrayInputStream;\n-import java.io.ByteArrayOutputStream;\n-import java.io.IOException;\n-import java.io.ObjectInputStream;\n-import java.io.ObjectOutputStream;\n+import java.io.*;\n import java.nio.file.Path;\n import java.nio.file.Paths;\n import java.util.prefs.Preferences;\n \n @Service\n public class EnvironmentService {\n \n+    @Autowired\n+    private HubConfigSession hubConfig;", "originalCommit": "e0fece52a39616ffccbd94005a4da5a2934716c5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ3NDI3NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3495#discussion_r371474275", "bodyText": "No, I tried autowiring HubProject object here but its fields (projDir etc) are not populated and all are null and hence had to get the project from HubConfigSession", "author": "srinathgit", "createdAt": "2020-01-27T20:48:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTQ3MjM5NA=="}], "type": "inlineReview"}]}