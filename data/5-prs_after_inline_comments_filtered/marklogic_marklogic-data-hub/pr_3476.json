{"pr_number": 3476, "pr_title": "DHFPROD-4104:Use DS to perform flow/step CRUD operations", "pr_createdAt": "2020-01-20T06:14:54Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3476", "timeline": [{"oid": "3bd23e6b4bd0311adbe029d253451556078f1119", "url": "https://github.com/marklogic/marklogic-data-hub/commit/3bd23e6b4bd0311adbe029d253451556078f1119", "message": "DHFPROD-4046:Use DS to perform flow/step CRUD operations", "committedDate": "2020-01-21T05:56:21Z", "type": "forcePushed"}, {"oid": "c4538a89ced362510d01b277cca6796d47ed5e71", "url": "https://github.com/marklogic/marklogic-data-hub/commit/c4538a89ced362510d01b277cca6796d47ed5e71", "message": "DHFPROD-4104:Use DS to perform flow/step CRUD operations", "committedDate": "2020-01-21T06:05:31Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAxNzEzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369017137", "bodyText": "I don't think we want this as a field of the class. Since ArtifactService is bound to a DatabaseClient, storing this as a field binds this class to a DatabaseClient, and thus to a single user. That's the main problem with all the DHF Service/Manager classes - they have HubConfig as a field, and thus they're bound to a single user.\nIf the intent was for Service/Manager classes to be Spring-managed singletons, they should be stateless / threadsafe classes. That's unfortunately not the case, due to the HubConfig field. Ideally, HubConfig - or some subset of it - would be passed in as an argument to methods that need it. In the absence of that, an ArtifactService should be instantiated each time it's needed and not stored as a field.", "author": "rjrudin", "createdAt": "2020-01-21T14:02:33Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/FlowManagerImpl.java", "diffHunk": "@@ -59,37 +65,27 @@\n     @Autowired\n     private StepDefinitionManager stepDefinitionManager;\n \n+    private ArtifactService artifactService;", "originalCommit": "c4538a89ced362510d01b277cca6796d47ed5e71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMDI4OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369020289", "bodyText": "@srinathgit  @ryanjdew @aebadirad  I think this is an argument here for a new \"getStagingClient()\" method instead of \"newStagingClient()\".  \"new\" implies that the caller should own the lifecycle of the DatabaseClient, and thus that the caller is free to call \"release\" on it - i.e. \"Give me a new DatabaseClient, and don't worry, I'll release it when I decide I'm done with it\". Whereas \"get\" implies - \"Give me your staging DatabaseClient, instantiating it as needed. I recognize it as 'yours', and thus I won't call release on it.\"\nArguably, \"newStagingClient\" should have been called \"getStagingClient\" in a single-user context as well. But my main point is that \"new\" implies that a new object is being created and thus the caller owns it, whereas \"get\" implies that HubConfig owns the object being returned.", "author": "rjrudin", "createdAt": "2020-01-21T14:08:31Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/FlowManagerImpl.java", "diffHunk": "@@ -344,21 +368,14 @@ protected void deleteDocumentsInDirectory(String directory) {\n             logger.info(format(\"Deleting documents in directory '%s' in staging database\", directory));\n         }\n         DatabaseClient stagingClient = hubConfig.newStagingClient();\n-        try {\n-            stagingClient.newServerEval().javascript(query).evalAs(String.class);\n-        } finally {\n-            stagingClient.release();\n-        }\n+        //Since client is getting reused in one UI, client.release() has to be removed", "originalCommit": "c4538a89ced362510d01b277cca6796d47ed5e71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE2MTMyNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369161325", "bodyText": "I agree with you. \"newStagingClient()\" in HubConfigImpl returns a new client object every time. In HubConfigSession, it looks like the decision was made to reuse the client. I will leave this in place for now", "author": "srinathgit", "createdAt": "2020-01-21T18:13:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMDI4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyMzQ0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369223445", "bodyText": "Yes, we may want to rename the function in the hubconfig interface (as part of another ticket) and leave it to the implementation to determine if it should create a new client every time. The reasoning behind not creating a new client every time in the session implementation is to avoid holding onto plain text credentials by build all the required clients at time of login.", "author": "ryanjdew", "createdAt": "2020-01-21T20:22:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMDI4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMDgzNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369020834", "bodyText": "Same thing - unless this class is intended to be bound to a single user/thread, it should not sure ArtifactService as a field.", "author": "rjrudin", "createdAt": "2020-01-21T14:09:30Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/StepDefinitionManagerImpl.java", "diffHunk": "@@ -42,13 +44,16 @@\n     @Autowired\n     private HubConfig hubConfig;\n \n+    private ArtifactService artifactService;", "originalCommit": "c4538a89ced362510d01b277cca6796d47ed5e71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMTU1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369021557", "bodyText": "The duplication of calling \"valueToTree\" here to convert an object into a JsonNode suggests the concept of an abstract Artifact class that Mapping, StepDefinition, EntityModel, and Flow all extend. Artifact would have an e.g. \"JsonNode toJsonNode()\" method on it. That encapsulates the logic of converting an object to a JsonNode into the object itself, as opposed to exposing and duplicating it across N Manager classes.", "author": "rjrudin", "createdAt": "2020-01-21T14:10:48Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/StepDefinitionManagerImpl.java", "diffHunk": "@@ -68,6 +73,7 @@ public void saveStepDefinition(StepDefinition stepDefinition, boolean autoIncrem\n         } catch (IOException e) {\n             throw new DataHubProjectException(\"Could not write Step to disk for project.\");\n         }\n+        getArtifactService().setArtifact(\"stepDefinitions\", stepDefinition.getName(),mapper.valueToTree(stepDefinition));", "originalCommit": "c4538a89ced362510d01b277cca6796d47ed5e71", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTE1OTEzOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369159138", "bodyText": "Is it ok to move the convertArtifactToJson method to JSONUtils so that all the Manager class can use it ?", "author": "srinathgit", "createdAt": "2020-01-21T18:08:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMTU1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMzc0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3476#discussion_r369023746", "bodyText": "Why even store this as a field? The class already has a dependency on HubConfig. When a HubProject is needed, why not just call hubConfig.getHubProject? Then we don't need a field, and we don't need a PostConstruct method either.", "author": "rjrudin", "createdAt": "2020-01-21T14:14:39Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ScaffoldingImpl.java", "diffHunk": "@@ -34,19 +34,21 @@\n import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n+import org.springframework.web.context.annotation.SessionScope;\n \n+import javax.annotation.PostConstruct;\n import java.io.*;\n import java.nio.charset.StandardCharsets;\n import java.nio.file.Files;\n import java.nio.file.Path;\n import java.util.HashMap;\n import java.util.Map;\n \n+@SessionScope\n @Component\n public class ScaffoldingImpl implements Scaffolding {\n \n-    @Autowired\n-    private HubProject project;\n+    private HubProject project = null;", "originalCommit": "c4538a89ced362510d01b277cca6796d47ed5e71", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "e52c33ef715f89cae3eaef7d04abb068047835b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e52c33ef715f89cae3eaef7d04abb068047835b4", "message": "DHFPROD-4104:Use DS to perform flow/step CRUD operations", "committedDate": "2020-01-21T18:17:10Z", "type": "commit"}, {"oid": "e52c33ef715f89cae3eaef7d04abb068047835b4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e52c33ef715f89cae3eaef7d04abb068047835b4", "message": "DHFPROD-4104:Use DS to perform flow/step CRUD operations", "committedDate": "2020-01-21T18:17:10Z", "type": "forcePushed"}]}