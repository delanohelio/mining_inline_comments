{"pr_number": 4947, "pr_title": "DHFPROD-6297: Add redaction privilege to roles", "pr_createdAt": "2020-12-07T19:35:24Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4947", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5NDA0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537794043", "bodyText": "Let's put this in hub.security and call it RedactionUserTest for consistency with the other role test classes", "author": "rjrudin", "createdAt": "2020-12-07T20:02:49Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/RedactionTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.marklogic.hub.flow;", "originalCommit": "5630b54965fad09c8cd830356f514e5d64e03122", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgyMDUzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537820536", "bodyText": "done", "author": "akshaysonvane", "createdAt": "2020-12-07T20:46:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzc5NDA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDc5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537800794", "bodyText": "Updated the message to reflect this JIRA story and 5.4.0", "author": "rjrudin", "createdAt": "2020-12-07T20:13:57Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/security/DataHubSecurityAdminTest.java", "diffHunk": "@@ -97,7 +97,7 @@ void createCustomRoleInheritingCertainDataHubRoles() {\n         Role customRole = new Role(userWithRoleBeingTestedApi, roleName);\n         customRole.setRole(CreateGranularPrivilegesCommand.ROLES_THAT_CAN_BE_INHERITED);\n \n-        assertEquals(42, customRole.getRole().size(), \"As of DHFPROD-5753 in 5.3.0, 42 roles are expected to be \" +\n+        assertEquals(43, customRole.getRole().size(), \"As of DHFPROD-5753 in 5.3.0, 43 roles are expected to be \" +", "originalCommit": "5630b54965fad09c8cd830356f514e5d64e03122", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgyMDY0NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537820645", "bodyText": "done", "author": "akshaysonvane", "createdAt": "2020-12-07T20:46:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzgwMDc5NA=="}], "type": "inlineReview"}, {"oid": "f6c99dbe147cb6f379cc6e8289b00dad669723ef", "url": "https://github.com/marklogic/marklogic-data-hub/commit/f6c99dbe147cb6f379cc6e8289b00dad669723ef", "message": "DHFPROD-6297: Add redaction privilege to roles", "committedDate": "2020-12-07T20:45:00Z", "type": "forcePushed"}, {"oid": "431e2c88a5cca962f4cef9cda3a93d611c61da8f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/431e2c88a5cca962f4cef9cda3a93d611c61da8f", "message": "DHFPROD-6297: Add redaction privilege to roles", "committedDate": "2020-12-07T22:32:44Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMjY0OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537902648", "bodyText": "You can remove this, the parent class defaults to this", "author": "rjrudin", "createdAt": "2020-12-07T23:09:46Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/security/RedactionUserTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.marklogic.hub.security;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.appdeployer.command.schemas.LoadSchemasCommand;\n+import com.marklogic.client.ResourceNotFoundException;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.impl.FlowRunnerImpl;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.UPDATE;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class RedactionUserTest extends AbstractHubCoreTest {\n+\n+    @BeforeEach\n+    void setUp() {\n+        runAsDataHubDeveloper();", "originalCommit": "431e2c88a5cca962f4cef9cda3a93d611c61da8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYxMzczMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r538613730", "bodyText": "Removed", "author": "akshaysonvane", "createdAt": "2020-12-08T17:09:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMjY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMzMxNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r537903317", "bodyText": "I think we still need to verify that the RunFlowResponse contains an error in stepOutput for the step that failed. It's good to verify that the doc wasn't written too, but the most important thing to verify is that the step failed, and the way to do that is via the RunFlowResponse.", "author": "rjrudin", "createdAt": "2020-12-07T23:11:19Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/security/RedactionUserTest.java", "diffHunk": "@@ -0,0 +1,85 @@\n+package com.marklogic.hub.security;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.appdeployer.command.schemas.LoadSchemasCommand;\n+import com.marklogic.client.ResourceNotFoundException;\n+import com.marklogic.client.io.DocumentMetadataHandle;\n+import com.marklogic.client.io.JacksonHandle;\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.flow.FlowInputs;\n+import com.marklogic.hub.flow.impl.FlowRunnerImpl;\n+import com.marklogic.mgmt.resource.databases.DatabaseManager;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.READ;\n+import static com.marklogic.client.io.DocumentMetadataHandle.Capability.UPDATE;\n+import static org.junit.jupiter.api.Assertions.*;\n+\n+public class RedactionUserTest extends AbstractHubCoreTest {\n+\n+    @BeforeEach\n+    void setUp() {\n+        runAsDataHubDeveloper();\n+        installProjectInFolder(\"test-projects/redaction-test\");\n+        new LoadSchemasCommand().execute(newCommandContext());\n+\n+        ingestDocument();\n+    }\n+\n+    @AfterEach\n+    void tearDown() {\n+        runAsAdmin();\n+        new DatabaseManager(getHubConfig().getManageClient()).clearDatabase(HubConfig.DEFAULT_STAGING_SCHEMAS_DB_NAME);\n+    }\n+\n+    @Test\n+    void testRedactionAsDataHubOperator() {\n+        runFlowAsUser(this::runAsDataHubOperator);\n+        verifyRedactedDoc();\n+    }\n+\n+    @Test\n+    void testRedactionAsHubCentralOperator() {\n+        runFlowAsUser(() -> runAsTestUserWithRoles(\"hub-central-operator\"));\n+        verifyRedactedDoc();\n+    }\n+\n+    @Test\n+    void testRedactionAsAForbiddenUser() {\n+        runFlowAsUser(() -> runAsTestUserWithRoles(\"hub-central-step-runner\"));\n+        verifyRedactedDocNotPresent();", "originalCommit": "431e2c88a5cca962f4cef9cda3a93d611c61da8f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODYxNDIyMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4947#discussion_r538614222", "bodyText": "Done", "author": "akshaysonvane", "createdAt": "2020-12-08T17:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzkwMzMxNw=="}], "type": "inlineReview"}, {"oid": "a405e23976563b66772f5ba978e943953b440802", "url": "https://github.com/marklogic/marklogic-data-hub/commit/a405e23976563b66772f5ba978e943953b440802", "message": "DHFPROD-6297: Add redaction privilege to roles", "committedDate": "2020-12-08T08:44:18Z", "type": "commit"}, {"oid": "a405e23976563b66772f5ba978e943953b440802", "url": "https://github.com/marklogic/marklogic-data-hub/commit/a405e23976563b66772f5ba978e943953b440802", "message": "DHFPROD-6297: Add redaction privilege to roles", "committedDate": "2020-12-08T08:44:18Z", "type": "forcePushed"}]}