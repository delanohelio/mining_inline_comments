{"pr_number": 3573, "pr_title": "DHFPROD-4310: Keep filesystem project in sync when making updates", "pr_createdAt": "2020-02-11T01:15:42Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3573", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMzQ2NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377733465", "bodyText": "This strikes me as something that would be in an ArtifactManager class that depends on both HubProject and ArtifactService. The controller ideally only has one dependency and only calls a single method; its job is then just to collect inputs from the HTTP request and convert those into a single method call, and then convert whatever the output is into something in the HTTP response.\nThat allows the ArtifactManager to be used in any context and keeps the web tier as thin as possible. Is that possible here?", "author": "rjrudin", "createdAt": "2020-02-11T16:05:59Z", "path": "one-ui/src/main/java/com/marklogic/hub/curation/controllers/AbstractArtifactController.java", "diffHunk": "@@ -1,31 +1,49 @@\n package com.marklogic.hub.curation.controllers;\n \n import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n import com.marklogic.client.DatabaseClient;\n import com.marklogic.hub.dataservices.ArtifactService;\n import com.marklogic.hub.oneui.models.HubConfigSession;\n+import com.marklogic.hub.oneui.services.EnvironmentService;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.HttpStatus;\n import org.springframework.http.ResponseEntity;\n \n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+\n public abstract class AbstractArtifactController {\n     @Autowired\n     HubConfigSession hubConfig;\n \n+    @Autowired\n+    EnvironmentService environmentService;\n+\n+    protected ArrayNode allArtifactTypeInfo = null;\n+\n     protected ResponseEntity<JsonNode> getArtifacts() {\n         return new ResponseEntity<>(getArtifactService().getList(this.getArtifactType()), HttpStatus.OK);\n     }\n \n-    protected ResponseEntity<JsonNode> updateArtifact(String artifactName, JsonNode loadDataJson) {\n-        return new ResponseEntity<>(getArtifactService().setArtifact(this.getArtifactType(), artifactName, loadDataJson), HttpStatus.OK);\n+    protected ResponseEntity<JsonNode> updateArtifact(String artifactName, JsonNode artifactJson) throws IOException {\n+        ResponseEntity<JsonNode> resp = new ResponseEntity<>(getArtifactService().setArtifact(this.getArtifactType(), artifactName, artifactJson), HttpStatus.OK);", "originalCommit": "f71bf6c1514ade1b1ed4c95e4aa7028da33f6fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NzU2MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377747561", "bodyText": "It is definitely possible to move it to an Artifact Manager. I thought we wanted to move away from the manager approach, but I guess by having the Artifact Manager we can eventually deprecate the other managers and reduce the overhead of all the managers we maintain that way.", "author": "ryanjdew", "createdAt": "2020-02-11T16:27:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMzQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc2MDI1MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377760251", "bodyText": "I think the pattern of a Manager having dependencies on both ML and the filesystem makes sense, while a Service only depends on ML (and the Service class is code-generated based on a data service). In some use cases, a Controller may only need to talk to a Service. In probably most use cases for now, a Controller will talk to a Manager who knows how to handle operations that involve both ML and the filesystem.", "author": "rjrudin", "createdAt": "2020-02-11T16:47:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMzQ2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzg4NDg0Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377884842", "bodyText": "updated to use an artifact manager", "author": "ryanjdew", "createdAt": "2020-02-11T20:39:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMzQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMzk1Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377733953", "bodyText": "Do we have any use case for versions yet? Or will the value just be \"1\" for everything until we have a use case for separate versions of an artifact?", "author": "rjrudin", "createdAt": "2020-02-11T16:06:43Z", "path": "one-ui/src/main/java/com/marklogic/hub/curation/controllers/AbstractArtifactController.java", "diffHunk": "@@ -46,4 +64,62 @@ protected ArtifactService getArtifactService() {\n     }\n \n     protected abstract String getArtifactType();\n+\n+    protected void writeArtifact(ObjectNode artifact) throws IOException {\n+        Path fileLocation = buildArtifactProjectLocation(getNameFromArtifact(artifact), getVersionFromArtifact(artifact));\n+        // create folders if needed\n+        if (!fileLocation.getParent().toFile().exists()) {\n+            fileLocation.getParent().toFile().mkdirs();\n+        }\n+        Files.write(fileLocation, artifact.toPrettyString().getBytes());\n+    }\n+\n+    protected void deleteArtifact(String artifactName, String artifactVersion) throws IOException {\n+        Path fileLocation = buildArtifactProjectLocation(artifactName, artifactVersion);\n+        Files.deleteIfExists(fileLocation);\n+    }\n+\n+    protected String getNameFromArtifact(ObjectNode artifact) {\n+        ObjectNode artifactTypeInfo = getArtifactTypeInfo();\n+        return artifact.get(artifactTypeInfo.get(\"nameProperty\").asText()).asText();\n+    }\n+\n+    protected String getVersionFromArtifact(ObjectNode artifact) {", "originalCommit": "f71bf6c1514ade1b1ed4c95e4aa7028da33f6fe4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0NTQzNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377745435", "bodyText": "We don't yet. It is more in preparation for when we move mapping to this new pattern. Right now the version is always null and the artifact type info won't provide a version property, so it isn't taken into account.", "author": "ryanjdew", "createdAt": "2020-02-11T16:24:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzczMzk1Mw=="}], "type": "inlineReview"}, {"oid": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "url": "https://github.com/marklogic/marklogic-data-hub/commit/fdcd202669b471ead19b8aeeb145793c97e5ab60", "message": "DHFPROD-4310: Keep filesystem project in sync when making updates", "committedDate": "2020-02-11T20:36:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MjAwNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377962006", "bodyText": "Can this be more strongly typed as an ArrayNode? Or would it be an ObjectNode if there's a single artifact? I'd lean towards an ArrayNode.", "author": "rjrudin", "createdAt": "2020-02-11T23:31:27Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MjI1NQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377962255", "bodyText": "Just to confirm, is this returning a representation of the updated artifact (as opposed to what the artifact currently looks like)? I think that would be good to confirm in the comment.", "author": "rjrudin", "createdAt": "2020-02-11T23:32:13Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);\n+\n+    /**\n+     * Updates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode of the artifact matching a type", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MjY1Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377962653", "bodyText": "Can this be strongly typed as an ObjectNode since it should be a single thing?\nI mention this for a few other methods. I think the distinction would be useful for clients that aren't just going to be a passthrough. And it's more self-documenting to use ObjectNode or ArrayNode if we know it's going to be one or the other.", "author": "rjrudin", "createdAt": "2020-02-11T23:33:25Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);\n+\n+    /**\n+     * Updates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode of the artifact matching a type\n+     */\n+    public JsonNode updateArtifact(String artifactType, String artifactName, JsonNode artifactJson) throws IOException;\n+\n+    /**\n+     * Retrieves an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact matching a type and name\n+     */\n+    public JsonNode getArtifact(String artifactType, String artifactName);", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2Mjk4Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377962983", "bodyText": "Why would this throw an IOException, and what would the client be expected to be able to do with it? I think Java should have made IOException a runtime exception, as it's rare that a client can do anything useful with it.", "author": "rjrudin", "createdAt": "2020-02-11T23:34:29Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);\n+\n+    /**\n+     * Updates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode of the artifact matching a type\n+     */\n+    public JsonNode updateArtifact(String artifactType, String artifactName, JsonNode artifactJson) throws IOException;\n+\n+    /**\n+     * Retrieves an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact matching a type and name\n+     */\n+    public JsonNode getArtifact(String artifactType, String artifactName);\n+\n+    /**\n+     * Deletes an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode\n+     */\n+    public JsonNode deleteArtifact(String artifactType, String artifactName) throws IOException;", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MzA2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377963069", "bodyText": "Is this returning the contents of the artifact before it's deleted?", "author": "rjrudin", "createdAt": "2020-02-11T23:34:46Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);\n+\n+    /**\n+     * Updates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode of the artifact matching a type\n+     */\n+    public JsonNode updateArtifact(String artifactType, String artifactName, JsonNode artifactJson) throws IOException;\n+\n+    /**\n+     * Retrieves an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact matching a type and name\n+     */\n+    public JsonNode getArtifact(String artifactType, String artifactName);\n+\n+    /**\n+     * Deletes an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MzI3NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377963274", "bodyText": "Can this be an ObjectNode?", "author": "rjrudin", "createdAt": "2020-02-11T23:35:25Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);\n+\n+    /**\n+     * Updates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode of the artifact matching a type\n+     */\n+    public JsonNode updateArtifact(String artifactType, String artifactName, JsonNode artifactJson) throws IOException;\n+\n+    /**\n+     * Retrieves an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact matching a type and name\n+     */\n+    public JsonNode getArtifact(String artifactType, String artifactName);\n+\n+    /**\n+     * Deletes an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode\n+     */\n+    public JsonNode deleteArtifact(String artifactType, String artifactName) throws IOException;\n+\n+    /**\n+     * Validates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode with validation details\n+     */\n+    public JsonNode validateArtifact(String artifactType, String artifactName, JsonNode artifactJson);", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2MzMxNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377963315", "bodyText": "Can this be an ObjectNode?", "author": "rjrudin", "createdAt": "2020-02-11T23:35:34Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);\n+\n+    /**\n+     * Updates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode of the artifact matching a type\n+     */\n+    public JsonNode updateArtifact(String artifactType, String artifactName, JsonNode artifactJson) throws IOException;\n+\n+    /**\n+     * Retrieves an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact matching a type and name\n+     */\n+    public JsonNode getArtifact(String artifactType, String artifactName);\n+\n+    /**\n+     * Deletes an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode\n+     */\n+    public JsonNode deleteArtifact(String artifactType, String artifactName) throws IOException;\n+\n+    /**\n+     * Validates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode with validation details\n+     */\n+    public JsonNode validateArtifact(String artifactType, String artifactName, JsonNode artifactJson);\n+\n+    /**\n+     * Retrieves settings of an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact settings matching a type and name\n+     */\n+    public JsonNode getArtifactSettings(String artifactType, String artifactName);", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2NDQwMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377964403", "bodyText": "It looks like the only client of this is an automated test. For that reason, I don't think it should be the interface yet. The fewer methods in an interface, the better. The method in the impl can be public if needed, and the test can just call it directly instead of depending on the interface.", "author": "rjrudin", "createdAt": "2020-02-11T23:39:10Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/ArtifactManager.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+\n+/**\n+ * Handles writing artifacts to ML server and project directory and reading artifacts from ML server\n+ */\n+public interface ArtifactManager {\n+\n+    /**\n+     * Gets artifacts of a given type\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @return JsonNode of the artifacts matching a type\n+     */\n+    public JsonNode getArtifacts(String artifactType);\n+\n+    /**\n+     * Updates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode of the artifact matching a type\n+     */\n+    public JsonNode updateArtifact(String artifactType, String artifactName, JsonNode artifactJson) throws IOException;\n+\n+    /**\n+     * Retrieves an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact matching a type and name\n+     */\n+    public JsonNode getArtifact(String artifactType, String artifactName);\n+\n+    /**\n+     * Deletes an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode\n+     */\n+    public JsonNode deleteArtifact(String artifactType, String artifactName) throws IOException;\n+\n+    /**\n+     * Validates an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactJson - JSON of artifact to persist\n+     * @return JsonNode with validation details\n+     */\n+    public JsonNode validateArtifact(String artifactType, String artifactName, JsonNode artifactJson);\n+\n+    /**\n+     * Retrieves settings of an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @return JsonNode of the artifact settings matching a type and name\n+     */\n+    public JsonNode getArtifactSettings(String artifactType, String artifactName);\n+\n+    /**\n+     * Updates settings of an artifact of a given type and name.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param settings - JSON of artifact settings to persist\n+     * @return JsonNode of the artifact settings matching a type and name\n+     */\n+    public JsonNode updateArtifactSettings(String artifactType, String artifactName, JsonNode settings);\n+\n+    /**\n+     * Provides path to artifact in project for an artifact of a given type, name, and (optionally) version.\n+     *\n+     * @param artifactType - type of artifact the operation is dealing with\n+     * @param artifactName - identifier of the artifact\n+     * @param artifactVersion - version of artifact (optional)\n+     * @return Path to artifact in project\n+     */\n+    public Path buildArtifactProjectLocation(String artifactType, String artifactName, String artifactVersion);", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2OTU4NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r377969584", "bodyText": "I'd really like to get away from anything depending on HubConfig to be a singleton. I took a look at the code, and I think it'd be better for ArtifactManagerImpl not to be a Spring component. Rather, just instantiate one when needed by passing in a HubProject and a DatabaseClient (which would be constructed based on a HubConfig, which the client presumably has access to).\nI looked at how allArtifactTypeInfo is used, because if this is no longer a singleton, there won't be a reason to store that as a class field. I think that's fine though. The data is needed during updateArtifact and deleteArtifact. Those should be very fast operations, such that I think it's fine to make a call to ML each time to get the needed artifact type info (particularly since that endpoint looks like it'll be really fast).", "author": "rjrudin", "createdAt": "2020-02-11T23:55:28Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/ArtifactManagerImpl.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright 2012-2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.marklogic.hub.impl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.DatabaseClient;\n+import com.marklogic.hub.ArtifactManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.dataservices.ArtifactService;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Component;\n+\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+\n+@Component\n+public class ArtifactManagerImpl implements ArtifactManager {\n+    @Autowired\n+    HubConfig hubConfig;", "originalCommit": "fdcd202669b471ead19b8aeeb145793c97e5ab60", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxMjMwMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378012300", "bodyText": "I think we can set member allArtifactTypeInfo as static, and some methods can be public static methods too. My initial thought is why we have to get ArtifactTypeInfo from ML server side if we already know those pre-defined supported artifact types, file extensions ? They can simply set as a final static Map without having to keep the allArtifactTypeInfo object instance with extra Json operations.", "author": "hao1st", "createdAt": "2020-02-12T02:38:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2OTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODAxMjcxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378012718", "bodyText": "If we create different objects for the Singleton (ArtifactManagerImpl), it can cause unnecessary memory footprint...", "author": "hao1st", "createdAt": "2020-02-12T02:40:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2OTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI0NTk5Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378245992", "bodyText": "The memory footprint of ArtifactManagerImpl would be as minimal as possible though, as it would have no state in it. And they'd be eligible for garbage collection immediately after a controller instantiates one and uses it. We'd be better off worrying about creating instances of String.\nIf we feel it's important for ArtifactManagerImpl to be a singleton, then I recommend moving HubConfig from being a class field to being a method argument instead. That's my main goal - that we shouldn't have any classes autowiring in a HubConfig object since that object is tied to one user, and we know that multiple users need to be able to use an object like ArtifactManagerImpl.\nNote that since we don't have a use case for multiple HubProject instances, I think it's fine for that to be a singleton that Spring manages. So having ArtifactManagerImpl autowire in HubProject is fine.", "author": "rjrudin", "createdAt": "2020-02-12T13:23:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2OTU4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODI0NzI1Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378247257", "bodyText": "Also, I think we want the ML endpoint to be the one that knows about artifact type info. That's knowledge that's derived from code in ML.\nI just wouldn't worry about caching this stuff in ML yet, I think it's premature optimization. Artifacts aren't going to be updated/deleted that often - maybe dozens of times a day? Even hundreds a day would be negligible from a performance perspective. This just isn't something we need to optimize yet, or probably ever.", "author": "rjrudin", "createdAt": "2020-02-12T13:25:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk2OTU4NA=="}], "type": "inlineReview"}, {"oid": "5cf19e5862cfcea01c878ab2710996480712c136", "url": "https://github.com/marklogic/marklogic-data-hub/commit/5cf19e5862cfcea01c878ab2710996480712c136", "message": "DHFPROD-4310: Keep filesystem project in sync when making updates", "committedDate": "2020-02-12T20:05:18Z", "type": "commit"}, {"oid": "5cf19e5862cfcea01c878ab2710996480712c136", "url": "https://github.com/marklogic/marklogic-data-hub/commit/5cf19e5862cfcea01c878ab2710996480712c136", "message": "DHFPROD-4310: Keep filesystem project in sync when making updates", "committedDate": "2020-02-12T20:05:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MzQ5NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378543494", "bodyText": "Because subclasses of this class are Spring Controller beans, and thus managed as singletons, I think this still runs into a problem where there's a single ArtifactManager tied to... I guess the first user that hits this? That's my guess - that if a second user logs in, that user will end up using an ArtifactManager that is tied to the first user's HubConfig. I'm not certain though.\nI think the safer approach is just to instantiate an ArtifactManagerImpl when you need it - i.e. have a \"protected ArtifactManager newArtifactManager()\" method that calls \"new ArtifactManagerImpl(this.hubConfig)\". That ensures you get an ArtifactManager tied to the current user session.", "author": "rjrudin", "createdAt": "2020-02-12T22:13:06Z", "path": "one-ui/src/main/java/com/marklogic/hub/curation/controllers/AbstractArtifactController.java", "diffHunk": "@@ -1,49 +1,55 @@\n package com.marklogic.hub.curation.controllers;\n \n import com.fasterxml.jackson.databind.JsonNode;\n-import com.marklogic.client.DatabaseClient;\n-import com.marklogic.hub.dataservices.ArtifactService;\n+import com.fasterxml.jackson.databind.node.ArrayNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.ArtifactManager;\n+import com.marklogic.hub.impl.ArtifactManagerImpl;\n import com.marklogic.hub.oneui.models.HubConfigSession;\n+import org.springframework.beans.factory.InitializingBean;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.http.HttpStatus;\n import org.springframework.http.ResponseEntity;\n \n-public abstract class AbstractArtifactController {\n+import java.io.IOException;\n+\n+public abstract class AbstractArtifactController implements InitializingBean {\n     @Autowired\n-    HubConfigSession hubConfig;\n+    protected HubConfigSession hubConfig;\n \n-    protected ResponseEntity<JsonNode> getArtifacts() {\n-        return new ResponseEntity<>(getArtifactService().getList(this.getArtifactType()), HttpStatus.OK);\n-    }\n+    protected ArtifactManager artifactManager;\n \n-    protected ResponseEntity<JsonNode> updateArtifact(String artifactName, JsonNode loadDataJson) {\n-        return new ResponseEntity<>(getArtifactService().setArtifact(this.getArtifactType(), artifactName, loadDataJson), HttpStatus.OK);\n+    protected ResponseEntity<ArrayNode> getArtifacts() {\n+        return new ResponseEntity<>(artifactManager.getArtifacts(this.getArtifactType()), HttpStatus.OK);\n     }\n \n-    protected ResponseEntity<JsonNode> getArtifact(String artifactName) {\n-        return new ResponseEntity<>(getArtifactService().getArtifact(this.getArtifactType(), artifactName), HttpStatus.OK);\n+    protected ResponseEntity<ObjectNode> updateArtifact(String artifactName, JsonNode artifactJson) {\n+        return new ResponseEntity<>(artifactManager.updateArtifact(this.getArtifactType(), artifactName, artifactJson), HttpStatus.OK);\n     }\n \n-    protected ResponseEntity<JsonNode> deleteArtifact(String artifactName) {\n-        return new ResponseEntity<>(getArtifactService().deleteArtifact(this.getArtifactType(), artifactName), HttpStatus.OK);\n+    protected ResponseEntity<ObjectNode> getArtifact(String artifactName) {\n+        return new ResponseEntity<>(artifactManager.getArtifact(this.getArtifactType(), artifactName), HttpStatus.OK);\n     }\n \n-    protected ResponseEntity<JsonNode> validateArtifact(String artifactName, JsonNode artifactJson) {\n-        return new ResponseEntity<>(getArtifactService().validateArtifact(this.getArtifactType(), artifactName, artifactJson), HttpStatus.OK);\n+    protected void deleteArtifact(String artifactName) throws IOException {\n+       artifactManager.deleteArtifact(this.getArtifactType(), artifactName);\n     }\n \n-    protected ArtifactService getArtifactService() {\n-        DatabaseClient dataServicesClient = hubConfig.newStagingClient(null);\n-        return ArtifactService.on(dataServicesClient);\n+    protected ResponseEntity<ObjectNode> validateArtifact(String artifactName, JsonNode artifactJson) {\n+        return new ResponseEntity<>(artifactManager.validateArtifact(this.getArtifactType(), artifactName, artifactJson), HttpStatus.OK);\n     }\n \n-    protected ResponseEntity<JsonNode> getArtifactSettings(String artifactName) {\n-        return new ResponseEntity<>(getArtifactService().getArtifactSettings(this.getArtifactType(), artifactName), HttpStatus.OK);\n+    protected ResponseEntity<ObjectNode> getArtifactSettings(String artifactName) {\n+        return new ResponseEntity<>(artifactManager.getArtifactSettings(this.getArtifactType(), artifactName), HttpStatus.OK);\n     }\n \n-    protected ResponseEntity<JsonNode> updateArtifactSettings(String artifactName, JsonNode settings) {\n-        return new ResponseEntity<>(getArtifactService().setArtifactSettings(this.getArtifactType(), artifactName, settings), HttpStatus.OK);\n+    protected ResponseEntity<ObjectNode> updateArtifactSettings(String artifactName, JsonNode settings) {\n+        return new ResponseEntity<>(artifactManager.updateArtifactSettings(this.getArtifactType(), artifactName, settings), HttpStatus.OK);\n     }\n \n     protected abstract String getArtifactType();\n+\n+    public void afterPropertiesSet() {\n+        this.artifactManager = new ArtifactManagerImpl(this.hubConfig);", "originalCommit": "5cf19e5862cfcea01c878ab2710996480712c136", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0OTAwMA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378549000", "bodyText": "@rjrudin I believe that the HubConfig has a separate instance for a different session.", "author": "hao1st", "createdAt": "2020-02-12T22:26:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MzQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU2MDExMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378560113", "bodyText": "HubConfigSession is SessionScoped. If we couldn't trust this.artifactManager to not be shared between sessions, I'm not sure how we could trust this.hubConfig to not be shared across sessions.", "author": "ryanjdew", "createdAt": "2020-02-12T22:53:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MzQ5NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU4Njc1MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3573#discussion_r378586751", "bodyText": "I think it's worth testing, just to verify that two users don't end up using the same HubConfig.\nI'm mostly wondering if the scoping is \"lost\" somehow when it's used to construct another object.", "author": "rjrudin", "createdAt": "2020-02-13T00:18:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODU0MzQ5NA=="}], "type": "inlineReview"}]}