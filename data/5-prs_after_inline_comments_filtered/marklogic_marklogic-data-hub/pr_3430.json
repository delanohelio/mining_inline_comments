{"pr_number": 3430, "pr_title": "DHFPROD-3911:Replace jsonPropertyValueQuery with pathRangeQuery", "pr_createdAt": "2020-01-07T08:22:04Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3430", "timeline": [{"oid": "58d25636905e56f68fd132f317b59012179a14e9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/58d25636905e56f68fd132f317b59012179a14e9", "message": "DHFPROD-3911:Replace jsonPropertyValueQuery with pathRangeQuery", "committedDate": "2020-01-08T00:20:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAyMjAzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3430#discussion_r364022039", "bodyText": "I think this is okay. I was initially worried that by throwing the exception, the user would think that hubUpgrade failed. But in reality, almost all of it succeeded except the last step. I think the error message could do a better job in explaining what failed - e.g. \"Error while upgrading project; was not able to add //actionDetails/*/uris path range index to final-database.xml file; cause: \" + ex.getMessage().\n@srinathgit  Thoughts on throwing the error, or just logging it?", "author": "rjrudin", "createdAt": "2020-01-08T00:54:04Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/HubProjectImpl.java", "diffHunk": "@@ -542,6 +555,67 @@ public void upgradeProject() throws IOException {\n         }\n         upgradeFlows();\n         removeEmptyRangeElementIndexArrayFromFinalDatabaseFile();\n+        addPathRangeIndexesToFinalDatabase();\n+    }\n+\n+    private void addPathRangeIndexesToFinalDatabase() {\n+        File finalDbFile = getUserConfigDir().resolve(\"database-fields\").resolve(\"final-database.xml\").toFile();\n+        try {\n+            FileInputStream fileInputStream = new FileInputStream(finalDbFile);\n+            DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();\n+            DocumentBuilder documentBuilder = documentBuilderFactory.newDocumentBuilder();\n+\n+            Document document = documentBuilder.parse(fileInputStream);\n+\n+            XPathFactory xPathFactory = XPathFactory.newInstance();\n+            XPath xPath = xPathFactory.newXPath();\n+\n+            XPathExpression expr = xPath.compile(\"//range-path-index/*[local-name()='path-expression']/text()='//actionDetails/*/uris'\");\n+\n+            Boolean isNodePresent = Boolean.parseBoolean(expr.evaluate(document));\n+\n+            if(!isNodePresent) {\n+                Node node = (Node) xPath\n+                    .evaluate(\"//*[local-name()='range-path-indexes']\", document.getDocumentElement(), XPathConstants.NODE);\n+\n+                Node newNode = node.appendChild(document.createElement(\"range-path-index\"));\n+\n+                Element scalarType = document.createElement(\"scalar-type\");\n+                scalarType.setTextContent(\"string\");\n+\n+                Element collation = document.createElement(\"scalar-type\");\n+                collation.setTextContent(\"http://marklogic.com/collation/\");\n+\n+                Element pathExpression = document.createElement(\"path-expression\");\n+                pathExpression.setTextContent(\"//actionDetails/*/uris\");\n+\n+                Element rangeValuePosition = document.createElement(\"range-value-positions\");\n+                rangeValuePosition.setTextContent(\"true\");\n+\n+                Element invalidValues = document.createElement(\"invalid-values\");\n+                invalidValues.setTextContent(\"reject\");\n+\n+                newNode.appendChild(scalarType);\n+                newNode.appendChild(collation);\n+                newNode.appendChild(pathExpression);\n+                newNode.appendChild(rangeValuePosition);\n+                newNode.appendChild(invalidValues);\n+\n+                TransformerFactory tf = TransformerFactory.newInstance();\n+                Transformer transformer = tf.newTransformer();\n+                transformer.setOutputProperty(OutputKeys.OMIT_XML_DECLARATION, \"yes\");\n+                transformer.setOutputProperty(OutputKeys.INDENT, \"yes\");\n+                transformer.setOutputProperty(OutputKeys.ENCODING, \"UTF-8\");\n+                transformer.setOutputProperty(\"{http://xml.apache.org/xslt}indent-amount\", \"2\");\n+\n+                transformer.transform(new DOMSource(document),\n+                    new StreamResult(new OutputStreamWriter(new FileOutputStream(finalDbFile), \"UTF-8\")));\n+            }\n+        }\n+        catch (Exception e) {\n+            throw new DataHubProjectException(\"Unable to upgrade the project: Failed to add index to final database\", e);", "originalCommit": "58d25636905e56f68fd132f317b59012179a14e9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDA2MDk5Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3430#discussion_r364060996", "bodyText": "I like throwing the exception and will change the error message to the one you had suggested", "author": "srinathgit", "createdAt": "2020-01-08T04:37:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDAyMjAzOQ=="}], "type": "inlineReview"}, {"oid": "b6b6fafadf717f665b42514c9bdf22e4b9608938", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b6b6fafadf717f665b42514c9bdf22e4b9608938", "message": "DHFPROD-3911:Replace jsonPropertyValueQuery with pathRangeQuery", "committedDate": "2020-01-08T04:41:45Z", "type": "commit"}, {"oid": "b6b6fafadf717f665b42514c9bdf22e4b9608938", "url": "https://github.com/marklogic/marklogic-data-hub/commit/b6b6fafadf717f665b42514c9bdf22e4b9608938", "message": "DHFPROD-3911:Replace jsonPropertyValueQuery with pathRangeQuery", "committedDate": "2020-01-08T04:41:45Z", "type": "forcePushed"}]}