{"pr_number": 4257, "pr_title": "DHFPROD-5211: Migrate entities <5.3 to 5.3 for hub central", "pr_createdAt": "2020-07-22T00:38:52Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4257", "timeline": [{"oid": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "url": "https://github.com/marklogic/marklogic-data-hub/commit/8886a9fdc108f3ce19b177dc27b107404c7807c3", "message": "DHFPROD-5211: Migrate entities datahub<5.3 to 5.3 for hub central", "committedDate": "2020-07-22T04:08:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczMDIxNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458730217", "bodyText": "Let's not add a method to this interface. We get almost no value out of the interfaces, except that we imply that the interface will stay constant for someone that wants to use the DHF Java API directly - but we provide no support for that other than publishing the javadocs. Just add the method to EntityManagerImpl and call that directly in the migration class.", "author": "rjrudin", "createdAt": "2020-07-22T11:42:06Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/EntityManager.java", "diffHunk": "@@ -75,6 +81,8 @@\n \n     List<HubEntity> getEntities();\n \n+    List<JsonNode> getEntitiesJsonNode();", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczMDQxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458730418", "bodyText": "Just make this EntityManagerImpl so you can access the method in it.", "author": "rjrudin", "createdAt": "2020-07-22T11:42:29Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczMDg4MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458730880", "bodyText": "Just call this directly in migrateUserArtifacts, the extra method adds a level of indirection without any benefit.", "author": "rjrudin", "createdAt": "2020-07-22T11:43:28Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateFlows() {\n+        flowMigrator.migrateFlows();", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczMTQ3MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458731471", "bodyText": "We can't assume that anything is valid about the entity models in a user's project. So verify that info exists first, then title exists. If neither exists, then log a warning that it couldn't be found and thus the entity model could not be migrated, and move on to the next entity.", "author": "rjrudin", "createdAt": "2020-07-22T11:44:40Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateFlows() {\n+        flowMigrator.migrateFlows();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getEntitiesJsonNode()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+            if(entityModelRequiresMigration(entityModelNode)) {\n+                atLeastOneEntityModelWasMigrated = true;\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczMTcxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458731712", "bodyText": "Same thing here - check to make sure things exist first, and if not, log a warning and move on.", "author": "rjrudin", "createdAt": "2020-07-22T11:45:06Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateFlows() {\n+        flowMigrator.migrateFlows();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getEntitiesJsonNode()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+            if(entityModelRequiresMigration(entityModelNode)) {\n+                atLeastOneEntityModelWasMigrated = true;\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczMzQxNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458733415", "bodyText": "Need to support pathRangeIndex as well.", "author": "rjrudin", "createdAt": "2020-07-22T11:48:23Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateFlows() {\n+        flowMigrator.migrateFlows();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getEntitiesJsonNode()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+            if(entityModelRequiresMigration(entityModelNode)) {\n+                atLeastOneEntityModelWasMigrated = true;\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczNDMwNQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458734305", "bodyText": "I believe you need a \"has\" check on \"$ref\" first - I just did a quick check, and an NPE is thrown on asText() if \"$ref\" doesn't exist.", "author": "rjrudin", "createdAt": "2020-07-22T11:50:12Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateFlows() {\n+        flowMigrator.migrateFlows();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getEntitiesJsonNode()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+            if(entityModelRequiresMigration(entityModelNode)) {\n+                atLeastOneEntityModelWasMigrated = true;\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);\n+                elementRangeIndex.removeAll(rangeIndex);\n+                rangeIndex.addAll(elementRangeIndex);\n+\n+                entityTypePropertiesNode.fieldNames().forEachRemaining(propertyName -> {\n+                    if(rangeIndex.contains(propertyName)) {\n+                        ObjectNode entityPropertyNode = (ObjectNode) entityTypePropertiesNode.get(propertyName);\n+                        if(!isStructuredTypeProperty(entityPropertyNode)) {\n+                            entityPropertyNode.put(\"facetable\", true);\n+                        }\n+                    }\n+                });\n+                entityTypeNode.remove(Arrays.asList(\"elementRangeIndex\", \"rangeIndex\"));\n+\n+                File entityModelFile = Paths.get(hubProject.getHubEntitiesDir().toString(), title + EntityManager.ENTITY_FILE_EXTENSION).toFile();\n+                try {\n+                    writer.writeValue(entityModelFile, entityModelNode);\n+                    logger.warn(format(\"Entity Model '%s' was successfully migrated\", entityModelFile));\n+                } catch (IOException e) {\n+                    logger.error(format(\"Entity Model '%s' migration failed; cause: %s\", entityModelFile, e.getMessage()), e);\n+                }\n+            }\n+        }\n+\n+        if (atLeastOneEntityModelWasMigrated) {\n+            logger.warn(\"Finished migrating entity models.\");\n+            logger.warn(\"Please examine the migrated entities and check the entity type properties defined as element range indexes and path range indexes are having facetable set to true\");\n+        } else {\n+            logger.warn(\"No entity models required migration, so no project files were modified\");\n+        }\n+    }\n+\n+    protected boolean entityModelRequiresMigration(ObjectNode entityModelNode) {\n+        String firstLevelEntityTypeName= entityModelNode.get(\"info\").get(\"title\").asText();\n+        entityModelNode= (ObjectNode) entityModelNode.get(\"definitions\").get(firstLevelEntityTypeName);\n+        return entityModelNode.get(\"rangeIndex\") != null || entityModelNode.get(\"elementRangeIndex\") != null;\n+    }\n+\n+    private boolean isStructuredTypeProperty(ObjectNode entityPropertyNode) {\n+        // check for simple structured type property or simple relationship property\n+        if (entityPropertyNode.get(\"datatype\") == null && entityPropertyNode.get(\"$ref\").asText() != null) {", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczNDYzMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458734632", "bodyText": "Same thing here - be very pessimistic about things not existing. Also check for pathRangeIndex.", "author": "rjrudin", "createdAt": "2020-07-22T11:50:50Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateFlows() {\n+        flowMigrator.migrateFlows();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getEntitiesJsonNode()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+            if(entityModelRequiresMigration(entityModelNode)) {\n+                atLeastOneEntityModelWasMigrated = true;\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);\n+                elementRangeIndex.removeAll(rangeIndex);\n+                rangeIndex.addAll(elementRangeIndex);\n+\n+                entityTypePropertiesNode.fieldNames().forEachRemaining(propertyName -> {\n+                    if(rangeIndex.contains(propertyName)) {\n+                        ObjectNode entityPropertyNode = (ObjectNode) entityTypePropertiesNode.get(propertyName);\n+                        if(!isStructuredTypeProperty(entityPropertyNode)) {\n+                            entityPropertyNode.put(\"facetable\", true);\n+                        }\n+                    }\n+                });\n+                entityTypeNode.remove(Arrays.asList(\"elementRangeIndex\", \"rangeIndex\"));\n+\n+                File entityModelFile = Paths.get(hubProject.getHubEntitiesDir().toString(), title + EntityManager.ENTITY_FILE_EXTENSION).toFile();\n+                try {\n+                    writer.writeValue(entityModelFile, entityModelNode);\n+                    logger.warn(format(\"Entity Model '%s' was successfully migrated\", entityModelFile));\n+                } catch (IOException e) {\n+                    logger.error(format(\"Entity Model '%s' migration failed; cause: %s\", entityModelFile, e.getMessage()), e);\n+                }\n+            }\n+        }\n+\n+        if (atLeastOneEntityModelWasMigrated) {\n+            logger.warn(\"Finished migrating entity models.\");\n+            logger.warn(\"Please examine the migrated entities and check the entity type properties defined as element range indexes and path range indexes are having facetable set to true\");\n+        } else {\n+            logger.warn(\"No entity models required migration, so no project files were modified\");\n+        }\n+    }\n+\n+    protected boolean entityModelRequiresMigration(ObjectNode entityModelNode) {\n+        String firstLevelEntityTypeName= entityModelNode.get(\"info\").get(\"title\").asText();", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczNTUzNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458735536", "bodyText": "For the warning, let's do:\nPlease examine your entity model files to verify that properties that were listed in the rangeIndex, pathRangeIndex, or elementRangeIndex arrays now have \"facetable\":true in their property definition.", "author": "rjrudin", "createdAt": "2020-07-22T11:52:38Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,126 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.EntityManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.entity.DefinitionType;\n+import com.marklogic.hub.entity.HubEntity;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private HubConfig hubConfig;\n+    private EntityManager entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateFlows() {\n+        flowMigrator.migrateFlows();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getEntitiesJsonNode()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+            if(entityModelRequiresMigration(entityModelNode)) {\n+                atLeastOneEntityModelWasMigrated = true;\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);\n+                elementRangeIndex.removeAll(rangeIndex);\n+                rangeIndex.addAll(elementRangeIndex);\n+\n+                entityTypePropertiesNode.fieldNames().forEachRemaining(propertyName -> {\n+                    if(rangeIndex.contains(propertyName)) {\n+                        ObjectNode entityPropertyNode = (ObjectNode) entityTypePropertiesNode.get(propertyName);\n+                        if(!isStructuredTypeProperty(entityPropertyNode)) {\n+                            entityPropertyNode.put(\"facetable\", true);\n+                        }\n+                    }\n+                });\n+                entityTypeNode.remove(Arrays.asList(\"elementRangeIndex\", \"rangeIndex\"));\n+\n+                File entityModelFile = Paths.get(hubProject.getHubEntitiesDir().toString(), title + EntityManager.ENTITY_FILE_EXTENSION).toFile();\n+                try {\n+                    writer.writeValue(entityModelFile, entityModelNode);\n+                    logger.warn(format(\"Entity Model '%s' was successfully migrated\", entityModelFile));\n+                } catch (IOException e) {\n+                    logger.error(format(\"Entity Model '%s' migration failed; cause: %s\", entityModelFile, e.getMessage()), e);\n+                }\n+            }\n+        }\n+\n+        if (atLeastOneEntityModelWasMigrated) {\n+            logger.warn(\"Finished migrating entity models.\");\n+            logger.warn(\"Please examine the migrated entities and check the entity type properties defined as element range indexes and path range indexes are having facetable set to true\");", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczNTgyOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r458735828", "bodyText": "You can just call getAllEntities, right? No need for a new method?", "author": "rjrudin", "createdAt": "2020-07-22T11:53:15Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/EntityManagerImpl.java", "diffHunk": "@@ -491,6 +490,10 @@ protected void addSubProperties(HubEntity entity, List<HubEntity> entityDefiniti\n         return getEntities(Boolean.FALSE);\n     }\n \n+    public List<JsonNode> getEntitiesJsonNode() {", "originalCommit": "8886a9fdc108f3ce19b177dc27b107404c7807c3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7d91a658f5ffc85cbe6bb15aafbc75c8e7d21dae", "url": "https://github.com/marklogic/marklogic-data-hub/commit/7d91a658f5ffc85cbe6bb15aafbc75c8e7d21dae", "message": "Code review changes", "committedDate": "2020-07-23T01:32:39Z", "type": "forcePushed"}, {"oid": "69c5c9f80029ddb398df73d380d46d449196833c", "url": "https://github.com/marklogic/marklogic-data-hub/commit/69c5c9f80029ddb398df73d380d46d449196833c", "message": "DHFPROD-5211: Migrate entities datahub<5.3 to 5.3 for hub central", "committedDate": "2020-07-23T01:36:56Z", "type": "forcePushed"}, {"oid": "06140aad6463887bcb8bf48d5f1edd7cf0aa9c59", "url": "https://github.com/marklogic/marklogic-data-hub/commit/06140aad6463887bcb8bf48d5f1edd7cf0aa9c59", "message": "DHFPROD-5211: Migrate entities datahub<5.3 to 5.3 for hub central", "committedDate": "2020-07-23T01:44:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxMzc0Ng==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r459413746", "bodyText": "This is good - and logging the cause for each issue is good too.", "author": "rjrudin", "createdAt": "2020-07-23T12:33:28Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private static final List<String> removableIndexArrays = Arrays.asList(\"elementRangeIndex\", \"rangeIndex\", \"pathRangeIndex\");\n+    private HubConfig hubConfig;\n+    private EntityManagerImpl entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        flowMigrator.migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getAllEntities()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+\n+            if (entityModelRequiresMigration(entityModelNode)) {\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                elementRangeIndex = elementRangeIndex == null ? new ArrayList<>() : elementRangeIndex;\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);\n+                rangeIndex = rangeIndex == null ? new ArrayList<>() : rangeIndex;\n+                List<String> pathRangeIndex = mapper.convertValue(entityTypeNode.get(\"pathRangeIndex\"), ArrayList.class);\n+                pathRangeIndex = pathRangeIndex == null ? new ArrayList<>() : pathRangeIndex;\n+                Set<String> mergedIndexArrays = new HashSet<>();\n+                Stream.of(elementRangeIndex, rangeIndex, pathRangeIndex).forEach(mergedIndexArrays::addAll);\n+\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+                if (entityTypePropertiesNode == null) {\n+                    logger.warn(\"entityTypePropertiesNode is null\");\n+                    entityTypeNode.remove(removableIndexArrays);\n+                    atLeastOneEntityModelWasMigrated = true;\n+                    continue;\n+                }\n+\n+                entityTypePropertiesNode.fieldNames().forEachRemaining(propertyName -> {\n+                    if (mergedIndexArrays.contains(propertyName)) {\n+                        ObjectNode entityPropertyNode = (ObjectNode) entityTypePropertiesNode.get(propertyName);\n+                        if (!isStructuredTypeProperty(entityPropertyNode)) {\n+                            entityPropertyNode.put(\"facetable\", true);\n+                        }\n+                    }\n+                });\n+                entityTypeNode.remove(removableIndexArrays);\n+\n+                File entityModelFile = Paths.get(hubProject.getHubEntitiesDir().toString(), title + entityManager.ENTITY_FILE_EXTENSION).toFile();\n+                try {\n+                    writer.writeValue(entityModelFile, entityModelNode);\n+                    logger.warn(format(\"Entity Model '%s' was successfully migrated\", entityModelFile));\n+                    atLeastOneEntityModelWasMigrated = true;\n+                } catch (IOException e) {\n+                    logger.error(format(\"Entity Model '%s' migration failed; cause: %s\", entityModelFile, e.getMessage()), e);\n+                }\n+            }\n+        }\n+\n+        if (atLeastOneEntityModelWasMigrated) {\n+            logger.warn(\"Finished migrating entity models.\");\n+            logger.warn(\"Please examine your entity model files to verify that properties that were listed in the rangeIndex, pathRangeIndex, or elementRangeIndex arrays \" +\n+                    \"now have \\\"facetable\\\":true in their property definition.\\n\");\n+        } else {\n+            logger.warn(\"No entity models required migration, so no project files were modified\");\n+        }\n+    }\n+\n+    protected boolean entityModelRequiresMigration(ObjectNode entityModelNode) {\n+        if (!entityModelValidForMigration(entityModelNode)) {\n+            return false;\n+        }\n+        String firstLevelEntityTypeName = entityModelNode.get(\"info\").get(\"title\").asText();\n+        entityModelNode = (ObjectNode) entityModelNode.get(\"definitions\").get(firstLevelEntityTypeName);\n+        return entityModelNode.get(\"rangeIndex\") != null || entityModelNode.get(\"elementRangeIndex\") != null ||\n+                entityModelNode.get(\"pathRangeIndex\") != null;\n+    }\n+\n+    protected boolean entityModelValidForMigration(ObjectNode entityModelNode) {", "originalCommit": "06140aad6463887bcb8bf48d5f1edd7cf0aa9c59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxNDIyOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r459414229", "bodyText": "Going to be a little picky here - I think it's worth verifying that for each property, it both exists and the array has size of 1 or more. That's because I think it's common for entity definitions to be stubbed out with empty arrays. No need to process those.", "author": "rjrudin", "createdAt": "2020-07-23T12:34:24Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private static final List<String> removableIndexArrays = Arrays.asList(\"elementRangeIndex\", \"rangeIndex\", \"pathRangeIndex\");\n+    private HubConfig hubConfig;\n+    private EntityManagerImpl entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        flowMigrator.migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getAllEntities()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+\n+            if (entityModelRequiresMigration(entityModelNode)) {\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                elementRangeIndex = elementRangeIndex == null ? new ArrayList<>() : elementRangeIndex;\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);\n+                rangeIndex = rangeIndex == null ? new ArrayList<>() : rangeIndex;\n+                List<String> pathRangeIndex = mapper.convertValue(entityTypeNode.get(\"pathRangeIndex\"), ArrayList.class);\n+                pathRangeIndex = pathRangeIndex == null ? new ArrayList<>() : pathRangeIndex;\n+                Set<String> mergedIndexArrays = new HashSet<>();\n+                Stream.of(elementRangeIndex, rangeIndex, pathRangeIndex).forEach(mergedIndexArrays::addAll);\n+\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+                if (entityTypePropertiesNode == null) {\n+                    logger.warn(\"entityTypePropertiesNode is null\");\n+                    entityTypeNode.remove(removableIndexArrays);\n+                    atLeastOneEntityModelWasMigrated = true;\n+                    continue;\n+                }\n+\n+                entityTypePropertiesNode.fieldNames().forEachRemaining(propertyName -> {\n+                    if (mergedIndexArrays.contains(propertyName)) {\n+                        ObjectNode entityPropertyNode = (ObjectNode) entityTypePropertiesNode.get(propertyName);\n+                        if (!isStructuredTypeProperty(entityPropertyNode)) {\n+                            entityPropertyNode.put(\"facetable\", true);\n+                        }\n+                    }\n+                });\n+                entityTypeNode.remove(removableIndexArrays);\n+\n+                File entityModelFile = Paths.get(hubProject.getHubEntitiesDir().toString(), title + entityManager.ENTITY_FILE_EXTENSION).toFile();\n+                try {\n+                    writer.writeValue(entityModelFile, entityModelNode);\n+                    logger.warn(format(\"Entity Model '%s' was successfully migrated\", entityModelFile));\n+                    atLeastOneEntityModelWasMigrated = true;\n+                } catch (IOException e) {\n+                    logger.error(format(\"Entity Model '%s' migration failed; cause: %s\", entityModelFile, e.getMessage()), e);\n+                }\n+            }\n+        }\n+\n+        if (atLeastOneEntityModelWasMigrated) {\n+            logger.warn(\"Finished migrating entity models.\");\n+            logger.warn(\"Please examine your entity model files to verify that properties that were listed in the rangeIndex, pathRangeIndex, or elementRangeIndex arrays \" +\n+                    \"now have \\\"facetable\\\":true in their property definition.\\n\");\n+        } else {\n+            logger.warn(\"No entity models required migration, so no project files were modified\");\n+        }\n+    }\n+\n+    protected boolean entityModelRequiresMigration(ObjectNode entityModelNode) {\n+        if (!entityModelValidForMigration(entityModelNode)) {\n+            return false;\n+        }\n+        String firstLevelEntityTypeName = entityModelNode.get(\"info\").get(\"title\").asText();\n+        entityModelNode = (ObjectNode) entityModelNode.get(\"definitions\").get(firstLevelEntityTypeName);\n+        return entityModelNode.get(\"rangeIndex\") != null || entityModelNode.get(\"elementRangeIndex\") != null ||", "originalCommit": "06140aad6463887bcb8bf48d5f1edd7cf0aa9c59", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTY0MTUxOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r459641518", "bodyText": "All the entity properties are iterated over to see if an entityPropertyName exist in one of the index arrays. So if something which is in an index array and not defined in entityTypeProperties will not cause an issue and the index arrays are deleted after adding facetable properties.\nIf the array is empty (size is 0), we delete those arrays on migration. (Since we dont want those references existing after migration)", "author": "rahulvudutala", "createdAt": "2020-07-23T18:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxNDIyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxNjU5Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r459416592", "bodyText": "We unfortunately need null checks on both \"datatype\" and \"items\" here - one may exist, but the other doesn't. We just can't trust that anything about a user's entity definition is valid (I've seen a few support tickets recently where entity models can't be loaded, and the cause is completely invalid ES syntax).", "author": "rjrudin", "createdAt": "2020-07-23T12:38:28Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private static final List<String> removableIndexArrays = Arrays.asList(\"elementRangeIndex\", \"rangeIndex\", \"pathRangeIndex\");\n+    private HubConfig hubConfig;\n+    private EntityManagerImpl entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        flowMigrator.migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getAllEntities()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+\n+            if (entityModelRequiresMigration(entityModelNode)) {\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                elementRangeIndex = elementRangeIndex == null ? new ArrayList<>() : elementRangeIndex;\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);\n+                rangeIndex = rangeIndex == null ? new ArrayList<>() : rangeIndex;\n+                List<String> pathRangeIndex = mapper.convertValue(entityTypeNode.get(\"pathRangeIndex\"), ArrayList.class);\n+                pathRangeIndex = pathRangeIndex == null ? new ArrayList<>() : pathRangeIndex;\n+                Set<String> mergedIndexArrays = new HashSet<>();\n+                Stream.of(elementRangeIndex, rangeIndex, pathRangeIndex).forEach(mergedIndexArrays::addAll);\n+\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+                if (entityTypePropertiesNode == null) {\n+                    logger.warn(\"entityTypePropertiesNode is null\");\n+                    entityTypeNode.remove(removableIndexArrays);\n+                    atLeastOneEntityModelWasMigrated = true;\n+                    continue;\n+                }\n+\n+                entityTypePropertiesNode.fieldNames().forEachRemaining(propertyName -> {\n+                    if (mergedIndexArrays.contains(propertyName)) {\n+                        ObjectNode entityPropertyNode = (ObjectNode) entityTypePropertiesNode.get(propertyName);\n+                        if (!isStructuredTypeProperty(entityPropertyNode)) {\n+                            entityPropertyNode.put(\"facetable\", true);\n+                        }\n+                    }\n+                });\n+                entityTypeNode.remove(removableIndexArrays);\n+\n+                File entityModelFile = Paths.get(hubProject.getHubEntitiesDir().toString(), title + entityManager.ENTITY_FILE_EXTENSION).toFile();\n+                try {\n+                    writer.writeValue(entityModelFile, entityModelNode);\n+                    logger.warn(format(\"Entity Model '%s' was successfully migrated\", entityModelFile));\n+                    atLeastOneEntityModelWasMigrated = true;\n+                } catch (IOException e) {\n+                    logger.error(format(\"Entity Model '%s' migration failed; cause: %s\", entityModelFile, e.getMessage()), e);\n+                }\n+            }\n+        }\n+\n+        if (atLeastOneEntityModelWasMigrated) {\n+            logger.warn(\"Finished migrating entity models.\");\n+            logger.warn(\"Please examine your entity model files to verify that properties that were listed in the rangeIndex, pathRangeIndex, or elementRangeIndex arrays \" +\n+                    \"now have \\\"facetable\\\":true in their property definition.\\n\");\n+        } else {\n+            logger.warn(\"No entity models required migration, so no project files were modified\");\n+        }\n+    }\n+\n+    protected boolean entityModelRequiresMigration(ObjectNode entityModelNode) {\n+        if (!entityModelValidForMigration(entityModelNode)) {\n+            return false;\n+        }\n+        String firstLevelEntityTypeName = entityModelNode.get(\"info\").get(\"title\").asText();\n+        entityModelNode = (ObjectNode) entityModelNode.get(\"definitions\").get(firstLevelEntityTypeName);\n+        return entityModelNode.get(\"rangeIndex\") != null || entityModelNode.get(\"elementRangeIndex\") != null ||\n+                entityModelNode.get(\"pathRangeIndex\") != null;\n+    }\n+\n+    protected boolean entityModelValidForMigration(ObjectNode entityModelNode) {\n+        if (!entityModelNode.has(\"info\")) {\n+            logger.warn(\"Info doesn't exist for the entity model and can not be migrated\");\n+            return false;\n+        }\n+\n+        if (!entityModelNode.get(\"info\").has(\"title\")) {\n+            logger.warn(\"Title doesn't exist for the entity model in the info and can not be migrated\");\n+            return false;\n+        }\n+\n+        if (entityModelNode.get(\"info\").get(\"title\") == null || entityModelNode.get(\"info\").get(\"title\").asText().isEmpty()) {\n+            logger.warn(\"Title is empty for the entity model in the info and can not be migrated\");\n+            return false;\n+        }\n+        String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+\n+        if (!entityModelNode.has(\"definitions\")) {\n+            logger.warn(\"No definitions found in the entity model and can not be migrated\");\n+            return false;\n+        }\n+\n+        if (entityModelNode.get(\"definitions\").get(title) == null) {\n+            logger.warn(format(\"entityType with title %s does not exist in the entityModel\", title));\n+            return false;\n+        }\n+\n+        return true;\n+    }\n+\n+    private boolean isStructuredTypeProperty(ObjectNode entityPropertyNode) {\n+        // check for simple structured type property or simple relationship property\n+        if (entityPropertyNode.get(\"datatype\") == null && entityPropertyNode.get(\"$ref\") != null) {\n+            return true;\n+        }\n+\n+        // check if structured type or relationship type property with array datatype\n+        if (entityPropertyNode.get(\"datatype\").asText().equals(\"array\") && entityPropertyNode.get(\"items\").get(\"$ref\") != null) {", "originalCommit": "06140aad6463887bcb8bf48d5f1edd7cf0aa9c59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQxNzU1NA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r459417554", "bodyText": "Another problem I thought of is that a user may very well have an entity model file with invalid JSON in it. Have seen it happen in support tickets. So we need for \"getAllEntities\" to account for a file being bad. I think modifying that to try/catch an error on each file - instead of throwing it - is a good idea (it'll be beneficial to the current clients of this method too).", "author": "rjrudin", "createdAt": "2020-07-23T12:40:12Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,166 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private static final List<String> removableIndexArrays = Arrays.asList(\"elementRangeIndex\", \"rangeIndex\", \"pathRangeIndex\");\n+    private HubConfig hubConfig;\n+    private EntityManagerImpl entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        flowMigrator.migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getAllEntities()) {", "originalCommit": "06140aad6463887bcb8bf48d5f1edd7cf0aa9c59", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1cd1fecc6edd1793201189105f49c449728fb515", "url": "https://github.com/marklogic/marklogic-data-hub/commit/1cd1fecc6edd1793201189105f49c449728fb515", "message": "DHFPROD-5211: Migrate entities datahub<5.3 to 5.3 for hub central", "committedDate": "2020-07-23T19:47:33Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzNDMyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r460034323", "bodyText": "This makes me nervous here, because we don't have a guarantee that this will overwrite the file that the entity was read from. The risk is that we write a new file and now the old file and migrated file both exist, and the user is then confused about what happened.\nFor this reason, I think it's better to not use getAllEntities() from EntityManagerImpl. Instead, just do listFiles (and filter on name endsWith \".entity.json\") on the entities dir and iterate over the list of files. That way, you know you're overwriting the correct File.", "author": "rjrudin", "createdAt": "2020-07-24T12:55:04Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/hubcentral/migration/HubCentralMigrator.java", "diffHunk": "@@ -0,0 +1,167 @@\n+package com.marklogic.hub.hubcentral.migration;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.client.ext.helper.LoggingObject;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.impl.EntityManagerImpl;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Paths;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.HashSet;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.stream.Stream;\n+\n+public class HubCentralMigrator extends LoggingObject {\n+    private static final List<String> removableIndexArrays = Arrays.asList(\"elementRangeIndex\", \"rangeIndex\", \"pathRangeIndex\");\n+    private HubConfig hubConfig;\n+    private EntityManagerImpl entityManager;\n+    private FlowMigrator flowMigrator;\n+    private ObjectMapper mapper = new ObjectMapper();\n+\n+    public HubCentralMigrator(HubConfig hubConfig) {\n+        this.hubConfig = hubConfig;\n+        this.entityManager = new EntityManagerImpl(hubConfig);\n+        this.flowMigrator = new FlowMigrator(this.hubConfig);\n+    }\n+\n+    /**\n+     * Migrate the entity model, flow and mapping files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    public void migrateUserArtifacts() {\n+        flowMigrator.migrateFlows();\n+        migrateEntityModels();\n+    }\n+\n+    /**\n+     * Migrate the entity model files in a user's local project. Does not make any changes to what's stored in MarkLogic.\n+     */\n+    protected void migrateEntityModels() {\n+        HubProject hubProject = hubConfig.getHubProject();\n+        final File entityModelsDir = hubProject.getHubEntitiesDir().toFile();\n+        if (!entityModelsDir.exists()) {\n+            logger.warn(\"No entities directory exists, so no entity models will be migrated\");\n+            return;\n+        }\n+\n+        logger.warn(\"Beginning migration of entity models in entities directory\");\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        boolean atLeastOneEntityModelWasMigrated = false;\n+\n+        for (JsonNode entityModel : entityManager.getAllEntities()) {\n+            ObjectNode entityModelNode = (ObjectNode) entityModel;\n+\n+            if (entityModelRequiresMigration(entityModelNode)) {\n+                String title = entityModelNode.get(\"info\").get(\"title\").asText();\n+                ObjectNode entityTypeNode = (ObjectNode) entityModelNode.get(\"definitions\").get(title);\n+\n+                List<String> elementRangeIndex = mapper.convertValue(entityTypeNode.get(\"elementRangeIndex\"), ArrayList.class);\n+                elementRangeIndex = elementRangeIndex == null ? new ArrayList<>() : elementRangeIndex;\n+                List<String> rangeIndex = mapper.convertValue(entityTypeNode.get(\"rangeIndex\"), ArrayList.class);\n+                rangeIndex = rangeIndex == null ? new ArrayList<>() : rangeIndex;\n+                List<String> pathRangeIndex = mapper.convertValue(entityTypeNode.get(\"pathRangeIndex\"), ArrayList.class);\n+                pathRangeIndex = pathRangeIndex == null ? new ArrayList<>() : pathRangeIndex;\n+                Set<String> mergedIndexArrays = new HashSet<>();\n+                Stream.of(elementRangeIndex, rangeIndex, pathRangeIndex).forEach(mergedIndexArrays::addAll);\n+\n+                ObjectNode entityTypePropertiesNode = (ObjectNode) entityTypeNode.get(\"properties\");\n+                if (entityTypePropertiesNode == null) {\n+                    logger.warn(\"entityTypePropertiesNode is null\");\n+                    entityTypeNode.remove(removableIndexArrays);\n+                    atLeastOneEntityModelWasMigrated = true;\n+                    continue;\n+                }\n+\n+                entityTypePropertiesNode.fieldNames().forEachRemaining(propertyName -> {\n+                    if (mergedIndexArrays.contains(propertyName)) {\n+                        ObjectNode entityPropertyNode = (ObjectNode) entityTypePropertiesNode.get(propertyName);\n+                        if (!isStructuredTypeProperty(entityPropertyNode)) {\n+                            entityPropertyNode.put(\"facetable\", true);\n+                        }\n+                    }\n+                });\n+                entityTypeNode.remove(removableIndexArrays);\n+\n+                File entityModelFile = Paths.get(hubProject.getHubEntitiesDir().toString(), title + entityManager.ENTITY_FILE_EXTENSION).toFile();", "originalCommit": "1cd1fecc6edd1793201189105f49c449728fb515", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAzNjAxOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4257#discussion_r460036019", "bodyText": "I think this is another reason not to use getAllEntities() - I don't think we want legacy entities included. According to our docs - https://docs.marklogic.com/datahub/upgrade.html - hubUpdate will move legacy entities to the ./entities directory. But in case there's anything left in the legacy entities directory, we don't want to touch those files.", "author": "rjrudin", "createdAt": "2020-07-24T12:58:30Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/impl/EntityManagerImpl.java", "diffHunk": "@@ -244,22 +244,22 @@ private HubModuleManager getPropsMgr() {\n         return new HubModuleManager(timestampFile);\n     }\n \n-    private List<JsonNode> getAllEntities() {\n+    public List<JsonNode> getAllEntities() {\n         List<JsonNode> entities = new ArrayList<>(getAllLegacyEntities());", "originalCommit": "1cd1fecc6edd1793201189105f49c449728fb515", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "900c1ab11f9b018fb5194836b5a403a0aea680a1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/900c1ab11f9b018fb5194836b5a403a0aea680a1", "message": "DHFPROD-5211: Migrate entities datahub<5.3 to 5.3 for hub central", "committedDate": "2020-07-24T16:41:47Z", "type": "commit"}, {"oid": "900c1ab11f9b018fb5194836b5a403a0aea680a1", "url": "https://github.com/marklogic/marklogic-data-hub/commit/900c1ab11f9b018fb5194836b5a403a0aea680a1", "message": "DHFPROD-5211: Migrate entities datahub<5.3 to 5.3 for hub central", "committedDate": "2020-07-24T16:41:47Z", "type": "forcePushed"}]}