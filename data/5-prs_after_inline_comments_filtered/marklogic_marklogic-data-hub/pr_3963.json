{"pr_number": 3963, "pr_title": "DHFPROD-4956:Migrate flows and mappings to flows and steps", "pr_createdAt": "2020-05-15T22:46:54Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3963", "timeline": [{"oid": "224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "url": "https://github.com/marklogic/marklogic-data-hub/commit/224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "message": "DHFPROD-4956:Migrate flows and mappings to flows and steps", "committedDate": "2020-05-17T18:28:04Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzEyNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426277126", "bodyText": "I'm realizing there's a gap in the story now - pinging @bsrikan  about this - what should we do about the pre-5.3 flows and mappings already deployed in ML? I'll open up a new story for that, let's not inflate this story with that question.\nHowever, I do think it's better to make use of installProjectInFolder - that avoids the need to write much code here. And it'll need to be called once we figure out what to do with already-installed files.", "author": "rjrudin", "createdAt": "2020-05-17T16:03:13Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/FlowMigratorTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+\n+class FlowMigratorTest extends AbstractHubCoreTest {\n+    @BeforeEach\n+    void setUp() {\n+        try {\n+            FileUtils.copyDirectory(getResourceFile(\"flow-migration-test/flows\"), getHubConfig().getFlowsDir().toFile());", "originalCommit": "da04a3b12b1543e7f560133266786818193edb84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzIyNA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426277224", "bodyText": "No need to do this - in fact, I think deleting the project directory or data from the db is an anti-pattern because if/when the test fails, it's more difficult to figure out what went wrong. That's why it's better to delete stuff when a test starts as opposed to when a test ends.", "author": "rjrudin", "createdAt": "2020-05-17T16:04:29Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/FlowMigratorTest.java", "diffHunk": "@@ -0,0 +1,65 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+\n+class FlowMigratorTest extends AbstractHubCoreTest {\n+    @BeforeEach\n+    void setUp() {\n+        try {\n+            FileUtils.copyDirectory(getResourceFile(\"flow-migration-test/flows\"), getHubConfig().getFlowsDir().toFile());\n+            FileUtils.copyDirectory(getResourceFile(\"flow-migration-test/mappings\"), getHubConfig().getHubMappingsDir().toFile());\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @AfterEach\n+    void tearDown() {\n+        deleteProjectDir();", "originalCommit": "da04a3b12b1543e7f560133266786818193edb84", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwMzkwNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426303907", "bodyText": "I ran the test locally (it passed), but I think two changes should be made to the test:\n\nNarrow down the test files to the bare minimum of steps needed to verify that everything is working\nAdd assertions to verify that the step references are correct in every flow, and that each step document was created correctly\n\nFor the first item above - the ingestion_only-flow.flow.json file is testing 7 identical scenarios, because every one of the 7 steps is the same from a QA perspective. So we only need one non-custom ingestion step that has a fileLocations. We also need a non-custom ingestion step that doesn't have inputFileType in it so we can verify that the migrator adds sourceFormat=json.\nAs for the logic of - \"Should this step be migrated?\" - the most effective way to do that is to make \"stepRequiresMigration\" a protected method and that pass different kinds of steps into it, verifying that the result is true or false.\nFor the second item - I think it's best to make an assertion on every stepId in the migrated flow document, and also on every property of every migrated step. We specifically want to verify that everything under \"options\" was migrated to top-level properties; that \"fileLocations\" was handled correctly; and that \"options/mapping\" was not migrated (it currently is being migrated, but should not be).\nI also noticed that a \"namespaces: {}\" was added, even though no namespaces exist in the mappings. If that's something we need to account for, then we need a mapping artifact that has namespaces populated so we can verify that the special handling for it worked.\nNote that we really do not want any issues during this migration process; the last thing we want for new users on 5.3 is to migrate their flows and then run into a problem that requires involving Support and makes them think that 5.3 doesn't work. So we need to be certain to cover every scenario and ensure every line of the migrated flows/steps is correct.", "author": "rjrudin", "createdAt": "2020-05-17T20:54:54Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/FlowMigratorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+\n+class FlowMigratorTest extends AbstractHubCoreTest {\n+    @BeforeEach\n+    void setUp() {\n+        try {\n+            FileUtils.copyDirectory(getResourceFile(\"flow-migration-test/flows\"), getHubConfig().getFlowsDir().toFile());\n+            FileUtils.copyDirectory(getResourceFile(\"flow-migration-test/mappings\"), getHubConfig().getHubMappingsDir().toFile());\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @AfterEach\n+    void tearDown() {\n+        deleteProjectDir();\n+    }\n+\n+    @Test\n+    void migrateFlows() {\n+        HubConfig hubConfig = getHubConfig();\n+        HubProject hubProject = hubConfig.getHubProject();\n+        FlowMigrator flowMigrator = new FlowMigrator(getHubConfig());\n+        flowMigrator.migrateFlows();\n+        Path migratedFlows = hubProject.getProjectDir().resolve(\"migrated-flows\");\n+\n+        Assertions.assertTrue(migratedFlows.toFile().exists());\n+        Assertions.assertTrue(migratedFlows.resolve(\"flows\").toFile().listFiles().length > 0);\n+        Assertions.assertTrue(migratedFlows.resolve(\"mappings\").toFile().listFiles().length > 0);\n+\n+        verifyFiles(getResourceFile(\"flow-migration-test/keys/flows\"), hubProject.getFlowsDir().toFile());\n+        verifyFiles(getResourceFile(\"flow-migration-test/keys/steps/ingestion\"), hubProject.getProjectDir().resolve(\"steps\").resolve(\"ingestion\").toFile());\n+        verifyFiles(getResourceFile(\"flow-migration-test/keys/steps/mapping\"), hubProject.getProjectDir().resolve(\"steps\").resolve(\"mapping\").toFile());\n+    }\n+\n+    private void verifyFiles(File expectedDir, File actualDir) {", "originalCommit": "224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNDA0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426304043", "bodyText": "I realized the story isn't clear here - the mapping artifacts should be moved, not copied. That is assuming that we don't need them anymore, which I think is true. I'll double check on 5.0.x \"default\" mappings.", "author": "rjrudin", "createdAt": "2020-05-17T20:56:01Z", "path": "marklogic-data-hub/src/test/java/com/marklogic/hub/flow/impl/FlowMigratorTest.java", "diffHunk": "@@ -0,0 +1,63 @@\n+package com.marklogic.hub.flow.impl;\n+\n+import com.marklogic.hub.AbstractHubCoreTest;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import org.apache.commons.io.FileUtils;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.Assertions;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.skyscreamer.jsonassert.JSONAssert;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.Arrays;\n+\n+class FlowMigratorTest extends AbstractHubCoreTest {\n+    @BeforeEach\n+    void setUp() {\n+        try {\n+            FileUtils.copyDirectory(getResourceFile(\"flow-migration-test/flows\"), getHubConfig().getFlowsDir().toFile());\n+            FileUtils.copyDirectory(getResourceFile(\"flow-migration-test/mappings\"), getHubConfig().getHubMappingsDir().toFile());\n+        } catch (IOException e) {\n+            throw new RuntimeException(e);\n+        }\n+    }\n+\n+    @AfterEach\n+    void tearDown() {\n+        deleteProjectDir();\n+    }\n+\n+    @Test\n+    void migrateFlows() {\n+        HubConfig hubConfig = getHubConfig();\n+        HubProject hubProject = hubConfig.getHubProject();\n+        FlowMigrator flowMigrator = new FlowMigrator(getHubConfig());\n+        flowMigrator.migrateFlows();\n+        Path migratedFlows = hubProject.getProjectDir().resolve(\"migrated-flows\");\n+\n+        Assertions.assertTrue(migratedFlows.toFile().exists());\n+        Assertions.assertTrue(migratedFlows.resolve(\"flows\").toFile().listFiles().length > 0);\n+        Assertions.assertTrue(migratedFlows.resolve(\"mappings\").toFile().listFiles().length > 0);\n+\n+        verifyFiles(getResourceFile(\"flow-migration-test/keys/flows\"), hubProject.getFlowsDir().toFile());\n+        verifyFiles(getResourceFile(\"flow-migration-test/keys/steps/ingestion\"), hubProject.getProjectDir().resolve(\"steps\").resolve(\"ingestion\").toFile());\n+        verifyFiles(getResourceFile(\"flow-migration-test/keys/steps/mapping\"), hubProject.getProjectDir().resolve(\"steps\").resolve(\"mapping\").toFile());", "originalCommit": "224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY4NjM2OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426686369", "bodyText": "Since there will be no default-mapping steps and all mappings are migrated, ./mappings dir is removed.", "author": "srinathgit", "createdAt": "2020-05-18T14:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNDA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1MjQ3MA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426752470", "bodyText": "@srinathgit when I tested this PR, ./mappings dir was not removed.", "author": "bsrikan", "createdAt": "2020-05-18T16:30:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNDA0Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjc1OTg5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426759898", "bodyText": "It is removed in the latest commit", "author": "srinathgit", "createdAt": "2020-05-18T16:43:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjMwNDA0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQxOTk2Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426419963", "bodyText": "Need a space before directory.", "author": "bsrikan", "createdAt": "2020-05-18T07:29:29Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowMigrator.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.marklogic.hub.flow.impl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.FlowManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.MappingManager;\n+import com.marklogic.hub.error.DataHubProjectException;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.StepDefinition;\n+import com.marklogic.hub.step.impl.Step;\n+import org.apache.commons.io.FileUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Map;\n+\n+\n+/**\n+ * Class for migrating pre-5.3.0 flows to  5.3.0 and above versions\n+ */\n+\n+public class FlowMigrator {\n+\n+    private HubProject hubProject;\n+    private MappingManager mappingManager;\n+    private FlowManager flowManager;\n+    protected final Logger logger = LoggerFactory.getLogger(this.getClass());\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    public FlowMigrator(HubConfig hubConfig){\n+        hubProject = hubConfig.getHubProject();\n+        mappingManager = new MappingManagerImpl(hubConfig);\n+        flowManager = new FlowManagerImpl(hubConfig, mappingManager);\n+    }\n+\n+    public void migrateFlows(){\n+        //Backup flows and mappings\n+        Path migratedFlows = hubProject.getProjectDir().resolve(\"migrated-flows\");\n+        try {\n+            migratedFlows.toFile().mkdirs();\n+            FileUtils.copyDirectory(hubProject.getFlowsDir().toFile(), migratedFlows.resolve(\"flows\").toFile());\n+            FileUtils.copyDirectory(hubProject.getHubMappingsDir().toFile(), migratedFlows.resolve(\"mappings\").toFile());\n+            logger.info(\"The original flows and mappings are backed up in migrated-flows/flows and migrated-flows/mappings\"+\n+                \"directory respectively.\");", "originalCommit": "224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzMzQxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426433413", "bodyText": "After migration, not able to run the flow. Used the flows in e2e/qa-project to migrate and run. Get an error like so.:\nUnable to retrieve flow with name: PersonXMLFlow for all the flows.", "author": "bsrikan", "createdAt": "2020-05-18T07:54:38Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowMigrator.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.marklogic.hub.flow.impl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.FlowManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.MappingManager;\n+import com.marklogic.hub.error.DataHubProjectException;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.StepDefinition;\n+import com.marklogic.hub.step.impl.Step;\n+import org.apache.commons.io.FileUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Map;\n+\n+\n+/**\n+ * Class for migrating pre-5.3.0 flows to  5.3.0 and above versions\n+ */\n+\n+public class FlowMigrator {\n+\n+    private HubProject hubProject;\n+    private MappingManager mappingManager;\n+    private FlowManager flowManager;\n+    protected final Logger logger = LoggerFactory.getLogger(this.getClass());\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    public FlowMigrator(HubConfig hubConfig){\n+        hubProject = hubConfig.getHubProject();\n+        mappingManager = new MappingManagerImpl(hubConfig);\n+        flowManager = new FlowManagerImpl(hubConfig, mappingManager);\n+    }\n+\n+    public void migrateFlows(){\n+        //Backup flows and mappings\n+        Path migratedFlows = hubProject.getProjectDir().resolve(\"migrated-flows\");\n+        try {\n+            migratedFlows.toFile().mkdirs();\n+            FileUtils.copyDirectory(hubProject.getFlowsDir().toFile(), migratedFlows.resolve(\"flows\").toFile());\n+            FileUtils.copyDirectory(hubProject.getHubMappingsDir().toFile(), migratedFlows.resolve(\"mappings\").toFile());\n+            logger.info(\"The original flows and mappings are backed up in migrated-flows/flows and migrated-flows/mappings\"+\n+                \"directory respectively.\");\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Couldn't migrate flows as backing up flows failed : \" + e.getMessage());\n+        }\n+\n+        Path stepsDir = hubProject.getProjectDir().resolve(\"steps\");\n+        Path ingestionDir = stepsDir.resolve(StepDefinition.StepDefinitionType.INGESTION.toString());\n+        Path mappingDir = stepsDir.resolve(StepDefinition.StepDefinitionType.MAPPING.toString());\n+\n+        try {\n+            ingestionDir.toFile().mkdirs();\n+            mappingDir.toFile().mkdirs();\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Couldn't migrate flows as creation of step artifact directories  failed : \" + e.getMessage());\n+        }\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        JsonNodeFactory nodeFactory = mapper.getNodeFactory();\n+\n+        flowManager.getLocalFlows().forEach(flow ->{\n+            Map<String, Step> steps = flow.getSteps();\n+            boolean flowRequiresMigration = steps.values().stream().anyMatch(step -> stepRequiresMigration(step));\n+            logger.info(flowRequiresMigration ? \"Migrating flow \" + flow.getName() :\n+                \"Flow \" + flow.getName() + \" contains no ingestion or mapping step. It doesn't require migration\");\n+            if(flowRequiresMigration){\n+                ObjectNode newFlow = nodeFactory.objectNode();\n+                newFlow.put(\"name\", flow.getName());\n+                ObjectNode newSteps = nodeFactory.objectNode();;\n+                for (Map.Entry<String, Step> entry : steps.entrySet()) {\n+                    Step step = entry.getValue();\n+                    if(stepRequiresMigration(step)){\n+                        newSteps.set(entry.getKey(),\n+                            nodeFactory.objectNode().put(\"stepId\",String.join(\"-\", step.getName(), step.getStepDefinitionType().toString())));\n+                        ObjectNode newStepArtifact = createStepArtifact(flow, step);\n+                        Path targetDir = step.getStepDefinitionType().equals(StepDefinition.StepDefinitionType.INGESTION) ? ingestionDir : mappingDir;\n+                        String stepFileName = new StringBuilder(step.getName()).append(\".step.json\").toString();\n+                        File stepFile = targetDir.resolve(stepFileName).toFile();\n+                        logger.info(\"Creating step artifact \"+ stepFile.toString());\n+                        if (stepFile.exists()) {\n+                            String msg = \"Step artifact \" + stepFile.toString() + \" already exists. The step artifact will be written to \";\n+                            //Update step artifact with new name\n+                            String stepName = new StringBuilder(flow.getName()).append(\"-\").append(step.getName()).toString();\n+                            newStepArtifact.put(\"name\", stepName);\n+                            //Update the filename\n+                            stepFileName = new StringBuilder(flow.getName()).append(\"-\").append(stepFileName).toString();\n+                            stepFile = targetDir.resolve(stepFileName).toFile();\n+\n+                            logger.info(msg + stepFile.toString()) ;\n+                        }\n+                        try{\n+                            writer.writeValue(stepFile, newStepArtifact);\n+                            logger.info(\"Step artifact \" + stepFile.toString() + \" successfully created.\");\n+                        }\n+                        catch(IOException e){\n+                            logger.error(\"Step artifact \" + stepFile.toString() + \" creation failed: \" + e.getMessage());\n+                        }\n+                    }\n+                    else {\n+                        logger.info(\"Step \" + step.getName() + \" is not an out of the box ingestion or mapping step. It will remain inline inside the flow artifact\");\n+                        newSteps.set(entry.getKey(), mapper.valueToTree(step));\n+                    }\n+                }\n+                newFlow.set(\"steps\",newSteps);\n+                File flowFile = Paths.get(hubProject.getFlowsDir().toString(), flow.getName() + FlowManager.FLOW_FILE_EXTENSION).toFile();\n+                try{\n+                    writer.writeValue(flowFile, newFlow);\n+                    logger.info(\"Flow \" + flowFile.toString() + \" successfully migrated.\");", "originalCommit": "224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ1MDMzNw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426450337", "bodyText": "The flows should be run after DHFPROD-4951 and DHFPROD-4952 are merged into develop though implementation of DHFPROD-4956 doesn't have dependency on them", "author": "srinathgit", "createdAt": "2020-05-18T08:23:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzMzQxMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzNzAyMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426437023", "bodyText": "ingestion step seems to be show up as \"Unknown\" in the the flow, since its expecting a loadData config", "author": "bsrikan", "createdAt": "2020-05-18T08:00:57Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowMigrator.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.marklogic.hub.flow.impl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.FlowManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.MappingManager;\n+import com.marklogic.hub.error.DataHubProjectException;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.StepDefinition;\n+import com.marklogic.hub.step.impl.Step;\n+import org.apache.commons.io.FileUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Map;\n+\n+\n+/**\n+ * Class for migrating pre-5.3.0 flows to  5.3.0 and above versions\n+ */\n+\n+public class FlowMigrator {\n+\n+    private HubProject hubProject;\n+    private MappingManager mappingManager;\n+    private FlowManager flowManager;\n+    protected final Logger logger = LoggerFactory.getLogger(this.getClass());\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    public FlowMigrator(HubConfig hubConfig){\n+        hubProject = hubConfig.getHubProject();\n+        mappingManager = new MappingManagerImpl(hubConfig);\n+        flowManager = new FlowManagerImpl(hubConfig, mappingManager);\n+    }\n+\n+    public void migrateFlows(){\n+        //Backup flows and mappings\n+        Path migratedFlows = hubProject.getProjectDir().resolve(\"migrated-flows\");\n+        try {\n+            migratedFlows.toFile().mkdirs();\n+            FileUtils.copyDirectory(hubProject.getFlowsDir().toFile(), migratedFlows.resolve(\"flows\").toFile());\n+            FileUtils.copyDirectory(hubProject.getHubMappingsDir().toFile(), migratedFlows.resolve(\"mappings\").toFile());\n+            logger.info(\"The original flows and mappings are backed up in migrated-flows/flows and migrated-flows/mappings\"+\n+                \"directory respectively.\");\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Couldn't migrate flows as backing up flows failed : \" + e.getMessage());\n+        }\n+\n+        Path stepsDir = hubProject.getProjectDir().resolve(\"steps\");\n+        Path ingestionDir = stepsDir.resolve(StepDefinition.StepDefinitionType.INGESTION.toString());\n+        Path mappingDir = stepsDir.resolve(StepDefinition.StepDefinitionType.MAPPING.toString());\n+\n+        try {\n+            ingestionDir.toFile().mkdirs();\n+            mappingDir.toFile().mkdirs();\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Couldn't migrate flows as creation of step artifact directories  failed : \" + e.getMessage());\n+        }\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        JsonNodeFactory nodeFactory = mapper.getNodeFactory();\n+\n+        flowManager.getLocalFlows().forEach(flow ->{\n+            Map<String, Step> steps = flow.getSteps();\n+            boolean flowRequiresMigration = steps.values().stream().anyMatch(step -> stepRequiresMigration(step));\n+            logger.info(flowRequiresMigration ? \"Migrating flow \" + flow.getName() :\n+                \"Flow \" + flow.getName() + \" contains no ingestion or mapping step. It doesn't require migration\");\n+            if(flowRequiresMigration){\n+                ObjectNode newFlow = nodeFactory.objectNode();\n+                newFlow.put(\"name\", flow.getName());\n+                ObjectNode newSteps = nodeFactory.objectNode();;\n+                for (Map.Entry<String, Step> entry : steps.entrySet()) {\n+                    Step step = entry.getValue();\n+                    if(stepRequiresMigration(step)){\n+                        newSteps.set(entry.getKey(),\n+                            nodeFactory.objectNode().put(\"stepId\",String.join(\"-\", step.getName(), step.getStepDefinitionType().toString())));\n+                        ObjectNode newStepArtifact = createStepArtifact(flow, step);\n+                        Path targetDir = step.getStepDefinitionType().equals(StepDefinition.StepDefinitionType.INGESTION) ? ingestionDir : mappingDir;\n+                        String stepFileName = new StringBuilder(step.getName()).append(\".step.json\").toString();\n+                        File stepFile = targetDir.resolve(stepFileName).toFile();\n+                        logger.info(\"Creating step artifact \"+ stepFile.toString());\n+                        if (stepFile.exists()) {\n+                            String msg = \"Step artifact \" + stepFile.toString() + \" already exists. The step artifact will be written to \";\n+                            //Update step artifact with new name\n+                            String stepName = new StringBuilder(flow.getName()).append(\"-\").append(step.getName()).toString();\n+                            newStepArtifact.put(\"name\", stepName);\n+                            //Update the filename\n+                            stepFileName = new StringBuilder(flow.getName()).append(\"-\").append(stepFileName).toString();\n+                            stepFile = targetDir.resolve(stepFileName).toFile();\n+\n+                            logger.info(msg + stepFile.toString()) ;\n+                        }\n+                        try{\n+                            writer.writeValue(stepFile, newStepArtifact);\n+                            logger.info(\"Step artifact \" + stepFile.toString() + \" successfully created.\");\n+                        }\n+                        catch(IOException e){\n+                            logger.error(\"Step artifact \" + stepFile.toString() + \" creation failed: \" + e.getMessage());\n+                        }\n+                    }\n+                    else {\n+                        logger.info(\"Step \" + step.getName() + \" is not an out of the box ingestion or mapping step. It will remain inline inside the flow artifact\");\n+                        newSteps.set(entry.getKey(), mapper.valueToTree(step));\n+                    }\n+                }\n+                newFlow.set(\"steps\",newSteps);\n+                File flowFile = Paths.get(hubProject.getFlowsDir().toString(), flow.getName() + FlowManager.FLOW_FILE_EXTENSION).toFile();\n+                try{\n+                    writer.writeValue(flowFile, newFlow);\n+                    logger.info(\"Flow \" + flowFile.toString() + \" successfully migrated.\");\n+                }\n+                catch(IOException e){\n+                    logger.error(\"Flow artifact \" + flowFile.toString() + \" creation failed: \" + e.getMessage());\n+                }\n+            }\n+        });\n+    }\n+\n+    // Only create step artifacts for ootb ingestion and mapping steps. Other steps(including custom ingestion and mapping)\n+    // will be inline\n+    private boolean stepRequiresMigration(Step step) {\n+        return (StepDefinition.StepDefinitionType.MAPPING.equals(step.getStepDefinitionType()) && \"entity-services-mapping\".equalsIgnoreCase(step.getStepDefinitionName())) ||\n+            (StepDefinition.StepDefinitionType.INGESTION.equals(step.getStepDefinitionType()) &&  \"default-ingestion\".equalsIgnoreCase(step.getStepDefinitionName()));", "originalCommit": "224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ1MDczOA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426450738", "bodyText": "This has to be verified after DHFPROD-4951 and DHFPROD-4952 are merged", "author": "srinathgit", "createdAt": "2020-05-18T08:24:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQzNzAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ0MTE0Mw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426441143", "bodyText": "endpoint http://localhost:8080/api/artifacts/mapping seems to return all the versions of a mapping. Shouldnt it return only the latest version. UI ends up showing all the versions which is not desired.", "author": "bsrikan", "createdAt": "2020-05-18T08:08:08Z", "path": "marklogic-data-hub/src/main/java/com/marklogic/hub/flow/impl/FlowMigrator.java", "diffHunk": "@@ -0,0 +1,191 @@\n+/*\n+ * Copyright (c) 2020 MarkLogic Corporation\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.marklogic.hub.flow.impl;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.fasterxml.jackson.databind.ObjectWriter;\n+import com.fasterxml.jackson.databind.node.JsonNodeFactory;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.marklogic.hub.FlowManager;\n+import com.marklogic.hub.HubConfig;\n+import com.marklogic.hub.HubProject;\n+import com.marklogic.hub.MappingManager;\n+import com.marklogic.hub.error.DataHubProjectException;\n+import com.marklogic.hub.flow.Flow;\n+import com.marklogic.hub.impl.FlowManagerImpl;\n+import com.marklogic.hub.impl.MappingManagerImpl;\n+import com.marklogic.hub.mapping.Mapping;\n+import com.marklogic.hub.step.StepDefinition;\n+import com.marklogic.hub.step.impl.Step;\n+import org.apache.commons.io.FileUtils;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.nio.file.Paths;\n+import java.util.Map;\n+\n+\n+/**\n+ * Class for migrating pre-5.3.0 flows to  5.3.0 and above versions\n+ */\n+\n+public class FlowMigrator {\n+\n+    private HubProject hubProject;\n+    private MappingManager mappingManager;\n+    private FlowManager flowManager;\n+    protected final Logger logger = LoggerFactory.getLogger(this.getClass());\n+    ObjectMapper mapper = new ObjectMapper();\n+\n+    public FlowMigrator(HubConfig hubConfig){\n+        hubProject = hubConfig.getHubProject();\n+        mappingManager = new MappingManagerImpl(hubConfig);\n+        flowManager = new FlowManagerImpl(hubConfig, mappingManager);\n+    }\n+\n+    public void migrateFlows(){\n+        //Backup flows and mappings\n+        Path migratedFlows = hubProject.getProjectDir().resolve(\"migrated-flows\");\n+        try {\n+            migratedFlows.toFile().mkdirs();\n+            FileUtils.copyDirectory(hubProject.getFlowsDir().toFile(), migratedFlows.resolve(\"flows\").toFile());\n+            FileUtils.copyDirectory(hubProject.getHubMappingsDir().toFile(), migratedFlows.resolve(\"mappings\").toFile());\n+            logger.info(\"The original flows and mappings are backed up in migrated-flows/flows and migrated-flows/mappings\"+\n+                \"directory respectively.\");\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Couldn't migrate flows as backing up flows failed : \" + e.getMessage());\n+        }\n+\n+        Path stepsDir = hubProject.getProjectDir().resolve(\"steps\");\n+        Path ingestionDir = stepsDir.resolve(StepDefinition.StepDefinitionType.INGESTION.toString());\n+        Path mappingDir = stepsDir.resolve(StepDefinition.StepDefinitionType.MAPPING.toString());\n+\n+        try {\n+            ingestionDir.toFile().mkdirs();\n+            mappingDir.toFile().mkdirs();\n+        } catch (Exception e) {\n+            throw new RuntimeException(\"Couldn't migrate flows as creation of step artifact directories  failed : \" + e.getMessage());\n+        }\n+\n+        ObjectWriter writer = mapper.writerWithDefaultPrettyPrinter();\n+        JsonNodeFactory nodeFactory = mapper.getNodeFactory();\n+\n+        flowManager.getLocalFlows().forEach(flow ->{\n+            Map<String, Step> steps = flow.getSteps();\n+            boolean flowRequiresMigration = steps.values().stream().anyMatch(step -> stepRequiresMigration(step));\n+            logger.info(flowRequiresMigration ? \"Migrating flow \" + flow.getName() :\n+                \"Flow \" + flow.getName() + \" contains no ingestion or mapping step. It doesn't require migration\");\n+            if(flowRequiresMigration){\n+                ObjectNode newFlow = nodeFactory.objectNode();\n+                newFlow.put(\"name\", flow.getName());\n+                ObjectNode newSteps = nodeFactory.objectNode();;\n+                for (Map.Entry<String, Step> entry : steps.entrySet()) {\n+                    Step step = entry.getValue();\n+                    if(stepRequiresMigration(step)){\n+                        newSteps.set(entry.getKey(),\n+                            nodeFactory.objectNode().put(\"stepId\",String.join(\"-\", step.getName(), step.getStepDefinitionType().toString())));\n+                        ObjectNode newStepArtifact = createStepArtifact(flow, step);\n+                        Path targetDir = step.getStepDefinitionType().equals(StepDefinition.StepDefinitionType.INGESTION) ? ingestionDir : mappingDir;\n+                        String stepFileName = new StringBuilder(step.getName()).append(\".step.json\").toString();\n+                        File stepFile = targetDir.resolve(stepFileName).toFile();\n+                        logger.info(\"Creating step artifact \"+ stepFile.toString());\n+                        if (stepFile.exists()) {\n+                            String msg = \"Step artifact \" + stepFile.toString() + \" already exists. The step artifact will be written to \";\n+                            //Update step artifact with new name\n+                            String stepName = new StringBuilder(flow.getName()).append(\"-\").append(step.getName()).toString();\n+                            newStepArtifact.put(\"name\", stepName);\n+                            //Update the filename\n+                            stepFileName = new StringBuilder(flow.getName()).append(\"-\").append(stepFileName).toString();\n+                            stepFile = targetDir.resolve(stepFileName).toFile();\n+\n+                            logger.info(msg + stepFile.toString()) ;\n+                        }\n+                        try{\n+                            writer.writeValue(stepFile, newStepArtifact);\n+                            logger.info(\"Step artifact \" + stepFile.toString() + \" successfully created.\");\n+                        }\n+                        catch(IOException e){\n+                            logger.error(\"Step artifact \" + stepFile.toString() + \" creation failed: \" + e.getMessage());\n+                        }\n+                    }\n+                    else {\n+                        logger.info(\"Step \" + step.getName() + \" is not an out of the box ingestion or mapping step. It will remain inline inside the flow artifact\");\n+                        newSteps.set(entry.getKey(), mapper.valueToTree(step));\n+                    }\n+                }\n+                newFlow.set(\"steps\",newSteps);\n+                File flowFile = Paths.get(hubProject.getFlowsDir().toString(), flow.getName() + FlowManager.FLOW_FILE_EXTENSION).toFile();\n+                try{\n+                    writer.writeValue(flowFile, newFlow);\n+                    logger.info(\"Flow \" + flowFile.toString() + \" successfully migrated.\");\n+                }\n+                catch(IOException e){\n+                    logger.error(\"Flow artifact \" + flowFile.toString() + \" creation failed: \" + e.getMessage());\n+                }\n+            }\n+        });\n+    }\n+\n+    // Only create step artifacts for ootb ingestion and mapping steps. Other steps(including custom ingestion and mapping)\n+    // will be inline\n+    private boolean stepRequiresMigration(Step step) {\n+        return (StepDefinition.StepDefinitionType.MAPPING.equals(step.getStepDefinitionType()) && \"entity-services-mapping\".equalsIgnoreCase(step.getStepDefinitionName())) ||", "originalCommit": "224d851480d0bf11d3e0c8d9478bda3d57cb99ae", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ0ODg5Nw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3963#discussion_r426448897", "bodyText": "It will only copy the mapping version that is specified in the flow. Also, \"mapping\" object will be removed from the mapping step in my next commit", "author": "srinathgit", "createdAt": "2020-05-18T08:21:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ0MTE0Mw=="}], "type": "inlineReview"}, {"oid": "4245e06774cfd086ffaa3100859abf1125940507", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4245e06774cfd086ffaa3100859abf1125940507", "message": "DHFPROD-4956:Migrate flows and mappings to flows and steps", "committedDate": "2020-05-18T10:39:24Z", "type": "commit"}, {"oid": "4245e06774cfd086ffaa3100859abf1125940507", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4245e06774cfd086ffaa3100859abf1125940507", "message": "DHFPROD-4956:Migrate flows and mappings to flows and steps", "committedDate": "2020-05-18T10:39:24Z", "type": "forcePushed"}]}