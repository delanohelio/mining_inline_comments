{"pr_number": 4672, "pr_title": "DHFPROD-4732: Explore All Data", "pr_createdAt": "2020-10-06T16:15:12Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/4672", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzNjAxMw==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4672#discussion_r500436013", "bodyText": "Any time there's an assertion on a number, it's helpful to have an assertion message to explain why that number is expected. In this case, you're expecting 14 because that's the number of OOTB DH artifacts. That assertion is a little brittle - if we add a new artifact, this test would break, which would be surprising.\nInstead of assuming 14, do a quick newServerEval and run \"cts.estimate(cts.trueQuery())\" to get back the count of expected documents. That allows you to make a better assertion - i.e. that you expect the count to be that of all documents in the database (which the user has read access to).", "author": "rjrudin", "createdAt": "2020-10-06T16:29:55Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/entities/search/EntitySearchManagerTest.java", "diffHunk": "@@ -70,37 +70,29 @@ void searchWithTransformInStagingDatabase() {\n     }\n \n     @Test\n-    void noEntityTypesSelected() {\n-        runAsDataHubDeveloper();\n-        // Need at least one entity model to exist for this scenario\n-        installOnlyReferenceModelEntities(true);\n-\n-        runAsHubCentralUser();\n-\n-        SearchQuery query = new SearchQuery();\n-        DocSearchQueryInfo info = new DocSearchQueryInfo();\n-        info.setEntityTypeIds(Arrays.asList(\" \"));\n-        query.setQuery(info);\n+    void searchAllDataInStagingDatabase() {\n+        validateAllDataSearch(\"staging\");\n+    }\n \n-        String results = new EntitySearchManager(getHubClient(), \"staging\").search(query).get();\n-        ObjectNode node = readJsonObject(results);\n-        assertEquals(0, node.get(\"total\").asInt(), \"When entityTypeIds has values, but they're all empty strings, the \" +\n-            \"backend should return no results, and not throw an error\");\n+    @Test\n+    void searchAllDataInFinalDatabase() {\n+        validateAllDataSearch(\"final\");\n     }\n \n     @Test\n     public void testSearchResultsOnNoData() {\n         runAsDataHubDeveloper();\n-        EntitySearchManager.QUERY_OPTIONS = \"non-existent-options\";\n         String collectionDeleteQuery = \"declareUpdate(); xdmp.collectionDelete(\\\"http://marklogic.com/entity-services/models\\\")\";\n         getHubClient().getFinalClient().newServerEval().javascript(collectionDeleteQuery).evalAs(String.class);\n \n         runAsHubCentralUser();\n-        assertTrue(new EntitySearchManager(getHubClient()).search(new SearchQuery()).get().isEmpty());\n+        StringHandle results = new EntitySearchManager(getHubClient()).search(new SearchQuery());\n+        ObjectNode node = readJsonObject(results.get());\n+        assertEquals(14, node.get(\"total\").asInt());", "originalCommit": "d5048df85722f88c14f12953b5deeec75be023d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzNzIxMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4672#discussion_r500437211", "bodyText": "This needs an assertion message too - why do we expect this exception? And what's the point of a DataHubException - what value is that adding over the original exception?\nI noticed that class is used in 7 places, but there's no code that cares about DataHubException. For that reason, I recommend removing it. It's needlessly wrapping the original exception but not providing any value.", "author": "rjrudin", "createdAt": "2020-10-06T16:31:37Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/entities/search/EntitySearchManagerTest.java", "diffHunk": "@@ -70,37 +70,29 @@ void searchWithTransformInStagingDatabase() {\n     }\n \n     @Test\n-    void noEntityTypesSelected() {\n-        runAsDataHubDeveloper();\n-        // Need at least one entity model to exist for this scenario\n-        installOnlyReferenceModelEntities(true);\n-\n-        runAsHubCentralUser();\n-\n-        SearchQuery query = new SearchQuery();\n-        DocSearchQueryInfo info = new DocSearchQueryInfo();\n-        info.setEntityTypeIds(Arrays.asList(\" \"));\n-        query.setQuery(info);\n+    void searchAllDataInStagingDatabase() {\n+        validateAllDataSearch(\"staging\");\n+    }\n \n-        String results = new EntitySearchManager(getHubClient(), \"staging\").search(query).get();\n-        ObjectNode node = readJsonObject(results);\n-        assertEquals(0, node.get(\"total\").asInt(), \"When entityTypeIds has values, but they're all empty strings, the \" +\n-            \"backend should return no results, and not throw an error\");\n+    @Test\n+    void searchAllDataInFinalDatabase() {\n+        validateAllDataSearch(\"final\");\n     }\n \n     @Test\n     public void testSearchResultsOnNoData() {\n         runAsDataHubDeveloper();\n-        EntitySearchManager.QUERY_OPTIONS = \"non-existent-options\";\n         String collectionDeleteQuery = \"declareUpdate(); xdmp.collectionDelete(\\\"http://marklogic.com/entity-services/models\\\")\";\n         getHubClient().getFinalClient().newServerEval().javascript(collectionDeleteQuery).evalAs(String.class);\n \n         runAsHubCentralUser();\n-        assertTrue(new EntitySearchManager(getHubClient()).search(new SearchQuery()).get().isEmpty());\n+        StringHandle results = new EntitySearchManager(getHubClient()).search(new SearchQuery());\n+        ObjectNode node = readJsonObject(results.get());\n+        assertEquals(14, node.get(\"total\").asInt());\n \n         SearchQuery query = new SearchQuery();\n         query.getQuery().setEntityTypeIds(Arrays.asList(\"Some-entityType\"));\n-        assertTrue(new EntitySearchManager(getHubClient()).search(query).get().isEmpty());\n+        assertThrows(DataHubException.class, () -> new EntitySearchManager(getHubClient()).search(query));", "originalCommit": "d5048df85722f88c14f12953b5deeec75be023d1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0e1fd0965097721e6ebe2bb5cdb090643d1b7e8e", "url": "https://github.com/marklogic/marklogic-data-hub/commit/0e1fd0965097721e6ebe2bb5cdb090643d1b7e8e", "message": "DHFPROD-4732: Explore All Data", "committedDate": "2020-10-06T23:21:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk2MzA0OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4672#discussion_r500963049", "bodyText": "Just do \"throw e\" here - MarkLogicServerException is a subclass of RuntimeException, so there's no need to wrap it (vs something like IOException).", "author": "rjrudin", "createdAt": "2020-10-07T12:15:40Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -146,9 +139,9 @@ public StringHandle search(SearchQuery searchQuery) {\n                         + \"various search features.\");\n             }\n \n-            throw new DataHubException(e.getServerMessage(), e);\n+            throw new RuntimeException(e.getServerMessage(), e);", "originalCommit": "0e1fd0965097721e6ebe2bb5cdb090643d1b7e8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk2MzIzOQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4672#discussion_r500963239", "bodyText": "And this catch block can be removed entirely. Same goes for the code below.", "author": "rjrudin", "createdAt": "2020-10-07T12:15:59Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/entities/search/EntitySearchManager.java", "diffHunk": "@@ -146,9 +139,9 @@ public StringHandle search(SearchQuery searchQuery) {\n                         + \"various search features.\");\n             }\n \n-            throw new DataHubException(e.getServerMessage(), e);\n+            throw new RuntimeException(e.getServerMessage(), e);\n         } catch (Exception e) { //other runtime exceptions\n-            throw new DataHubException(e.getLocalizedMessage(), e);\n+            throw new RuntimeException(e.getLocalizedMessage(), e);", "originalCommit": "0e1fd0965097721e6ebe2bb5cdb090643d1b7e8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDk2MzczMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4672#discussion_r500963731", "bodyText": "Same thing here - \"throw e\" and remove the catch block.", "author": "rjrudin", "createdAt": "2020-10-07T12:16:46Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/managers/ModelManager.java", "diffHunk": "@@ -80,9 +80,9 @@ public JsonNode getModels() {\n             } else { //FailedRequestException || ResourceNotResendableException || other runtime exceptions\n                 logger.error(e.getLocalizedMessage());\n             }\n-            throw new DataHubException(e.getServerMessage(), e);\n+            throw new RuntimeException(e.getServerMessage(), e);", "originalCommit": "0e1fd0965097721e6ebe2bb5cdb090643d1b7e8e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ccc3087a2b1c001dec569dffefa0ecc902d715a3", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ccc3087a2b1c001dec569dffefa0ecc902d715a3", "message": "DHFPROD-4732: Explore All Data", "committedDate": "2020-10-07T16:49:46Z", "type": "forcePushed"}, {"oid": "e1215ab441d1d512f632a7624856cb3d446051f4", "url": "https://github.com/marklogic/marklogic-data-hub/commit/e1215ab441d1d512f632a7624856cb3d446051f4", "message": "DHFPROD-4732: Explore All Data", "committedDate": "2020-10-07T16:51:14Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2NTA5OA==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4672#discussion_r501165098", "bodyText": "Given that this client is used after runAsHubCentralUser is called, I think you should move this line to after runAsHubCentralUser. Looking at the code, it's not clear what user is associated with this DatabaseClient, but it looks like it's supposed to be running as an HC user.", "author": "rjrudin", "createdAt": "2020-10-07T16:53:10Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/entities/search/EntitySearchManagerTest.java", "diffHunk": "@@ -316,4 +312,22 @@ private void validateSearchWithTransform(String databaseType) {\n                 \"entityProperties so that the UI knows what structured values to show for each entity instance\");\n         assertTrue(node.get(\"results\").get(1).has(\"entityProperties\"));\n     }\n+\n+    private void validateAllDataSearch(String databaseType) {\n+        DatabaseClient client = databaseType.equalsIgnoreCase(\"staging\") ? getHubClient().getStagingClient() : getHubClient().getFinalClient();", "originalCommit": "e1215ab441d1d512f632a7624856cb3d446051f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE2NjQxMg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/4672#discussion_r501166412", "bodyText": "The assertion message shouldn't assume what's being returned. The benefit of doing an estimate on trueQuery is that you get a count of all the docs that an HC user can see. Then, you want to make sure that when you do an empty search, you get the same count back. You don't care what the count is, nor do you care what docs should be there - you just care that the two counts are the same. So the assertion message should be along the lines of:\n\"Expected \" + count + \" total documents; an empty search should result in a count equal to all the docs that the user can read in the database\"", "author": "rjrudin", "createdAt": "2020-10-07T16:55:09Z", "path": "marklogic-data-hub-central/src/test/java/com/marklogic/hub/central/entities/search/EntitySearchManagerTest.java", "diffHunk": "@@ -316,4 +312,22 @@ private void validateSearchWithTransform(String databaseType) {\n                 \"entityProperties so that the UI knows what structured values to show for each entity instance\");\n         assertTrue(node.get(\"results\").get(1).has(\"entityProperties\"));\n     }\n+\n+    private void validateAllDataSearch(String databaseType) {\n+        DatabaseClient client = databaseType.equalsIgnoreCase(\"staging\") ? getHubClient().getStagingClient() : getHubClient().getFinalClient();\n+        runAsDataHubDeveloper();\n+        ReferenceModelProject project = installOnlyReferenceModelEntities(true);\n+        deployEntityIndexes();\n+        project.createCustomerInstance(new Customer(1, \"Jane\"), databaseType);\n+        project.createCustomerInstance(new Customer(2, \"Sally\"), databaseType);\n+\n+        runAsHubCentralUser();\n+\n+        String query = \"cts.estimate(cts.trueQuery())\";\n+        int count = Integer.parseInt(client.newServerEval().javascript(query).evalAs(String.class));\n+        StringHandle results = new EntitySearchManager(getHubClient(), databaseType).search(new SearchQuery());\n+        ObjectNode node = readJsonObject(results.get());\n+        assertEquals(count, node.get(\"total\").asInt(), \"OOTB datahub artifacts, Customer and Order entity models and \" +", "originalCommit": "e1215ab441d1d512f632a7624856cb3d446051f4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ff3e8ff5ee6fd542ab28652533db366900ebbbe9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ff3e8ff5ee6fd542ab28652533db366900ebbbe9", "message": "DHFPROD-4732: Explore All Data", "committedDate": "2020-10-07T17:54:04Z", "type": "commit"}, {"oid": "ff3e8ff5ee6fd542ab28652533db366900ebbbe9", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ff3e8ff5ee6fd542ab28652533db366900ebbbe9", "message": "DHFPROD-4732: Explore All Data", "committedDate": "2020-10-07T17:54:04Z", "type": "forcePushed"}]}