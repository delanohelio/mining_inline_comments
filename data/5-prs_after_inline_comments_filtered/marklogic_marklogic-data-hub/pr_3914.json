{"pr_number": 3914, "pr_title": "DHFPROD-4668: Add hub-central-user role", "pr_createdAt": "2020-05-04T21:54:16Z", "pr_url": "https://github.com/marklogic/marklogic-data-hub/pull/3914", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTc5ODczNg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r419798736", "bodyText": "Little typo - have, not has", "author": "rjrudin", "createdAt": "2020-05-05T00:08:25Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/AuthenticationFilter.java", "diffHunk": "@@ -99,13 +99,16 @@ protected AuthenticationToken authenticateUser(String username, String password)\n             }\n             throw e;\n         }\n-\n         List<GrantedAuthority> authorities = new ArrayList<>();\n+        final boolean[] hasLoginAuthority = {false};\n         response.get(\"authorities\").iterator().forEachRemaining(node -> {\n             String authority = node.asText();\n+            hasLoginAuthority[0] = (\"loginToHubCentral\".equals(authority)) || hasLoginAuthority[0];\n             authorities.add(new SimpleGrantedAuthority(\"ROLE_\" + authority));\n         });\n-\n+        if (!hasLoginAuthority[0]) {\n+            throw new InsufficientAuthenticationException(\"User doesn't has necessary privileges to access Hub Central\");", "originalCommit": "074d80d76f676a1b9b7b6f24c732a8a7598aeead", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "099ead27d090c093b5d6ff721978f8326d19449b", "url": "https://github.com/marklogic/marklogic-data-hub/commit/099ead27d090c093b5d6ff721978f8326d19449b", "message": "DHFPROD-4668: Add hub-central-user role", "committedDate": "2020-05-05T15:28:45Z", "type": "forcePushed"}, {"oid": "4c66b430a575acc4a23b97a256a5daeb117be41f", "url": "https://github.com/marklogic/marklogic-data-hub/commit/4c66b430a575acc4a23b97a256a5daeb117be41f", "message": "DHFPROD-4668: Add hub-central-user role", "committedDate": "2020-05-06T16:31:36Z", "type": "forcePushed"}, {"oid": "ea8641a7b01424bf0685dbf070bb74107987e5a6", "url": "https://github.com/marklogic/marklogic-data-hub/commit/ea8641a7b01424bf0685dbf070bb74107987e5a6", "message": "DHFPROD-4668: Add hub-central-user role", "committedDate": "2020-05-07T21:14:39Z", "type": "forcePushed"}, {"oid": "372de2f0de719c18933def822ffa65f51ffbdcee", "url": "https://github.com/marklogic/marklogic-data-hub/commit/372de2f0de719c18933def822ffa65f51ffbdcee", "message": "DHFPROD-4668: Add hub-central-user role", "committedDate": "2020-05-07T23:48:56Z", "type": "commit"}, {"oid": "372de2f0de719c18933def822ffa65f51ffbdcee", "url": "https://github.com/marklogic/marklogic-data-hub/commit/372de2f0de719c18933def822ffa65f51ffbdcee", "message": "DHFPROD-4668: Add hub-central-user role", "committedDate": "2020-05-07T23:48:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421880021", "bodyText": "was this exception causing the clearUserData test to fail?", "author": "bsrikan", "createdAt": "2020-05-08T01:08:34Z", "path": "marklogic-data-hub-central/src/main/java/com/marklogic/hub/central/auth/LoginFailureHandler.java", "diffHunk": "@@ -37,7 +38,11 @@ public void onAuthenticationFailure(HttpServletRequest request, HttpServletRespo\n         String json = node.toString();\n         response.setContentType(\"application/json\");\n         response.setCharacterEncoding(\"UTF-8\");\n-        response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);\n+        if (exception instanceof InsufficientAuthenticationException) {", "originalCommit": "372de2f0de719c18933def822ffa65f51ffbdcee", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg5MzA4OQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421893089", "bodyText": "I don't think so - that test was failing on 9.0-12 because it was depending on granular privileges that are in 10.0-3.", "author": "rjrudin", "createdAt": "2020-05-08T01:56:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkwMDE5MQ==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421900191", "bodyText": "I was referring to the unit test failure for the PR which I think runs on ML 10.0-4:\nhttps://jenkins.marklogic.com/blue/organizations/jenkins/Datahub_CI/detail/PR-3914/16/tests", "author": "bsrikan", "createdAt": "2020-05-08T02:24:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTkyMDc3Mg==", "url": "https://github.com/marklogic/marklogic-data-hub/pull/3914#discussion_r421920772", "bodyText": "It turned out that I was wiping out the granular privileges when attempting to deploy the amp/role for testing in ml-unit-tests here: https://github.com/marklogic/marklogic-data-hub/pull/3914/files#diff-1ec8825c599ca5cc7abf57c14482d7e5R79\nAdding the GranularPrivilegeCommand here addressed the problem.", "author": "ryanjdew", "createdAt": "2020-05-08T03:47:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTg4MDAyMQ=="}], "type": "inlineReview"}]}