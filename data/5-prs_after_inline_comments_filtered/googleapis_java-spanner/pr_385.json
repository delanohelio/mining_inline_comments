{"pr_number": 385, "pr_title": "feat: adds query optimizer statistics support", "pr_createdAt": "2020-08-17T01:53:17Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/385", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwMjcwOA==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471202708", "bodyText": "Used to set the optimizer statistics package through an environment variable, such as:\nexport SPANNER_OPTIMIZER_STATISTICS_PACKAGE=\"custom-package\"", "author": "thiagotnunes", "createdAt": "2020-08-17T02:34:46Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SpannerOptions.java", "diffHunk": "@@ -266,13 +273,21 @@ private SpannerOptions(Builder builder) {\n   private static class SpannerEnvironmentImpl implements SpannerEnvironment {\n     private static final SpannerEnvironmentImpl INSTANCE = new SpannerEnvironmentImpl();\n     private static final String SPANNER_OPTIMIZER_VERSION_ENV_VAR = \"SPANNER_OPTIMIZER_VERSION\";\n+    private static final String SPANNER_OPTIMIZER_STATISTICS_PACKAGE_ENV_VAR =\n+        \"SPANNER_OPTIMIZER_STATISTICS_PACKAGE\";\n \n     private SpannerEnvironmentImpl() {}\n \n     @Override\n     public String getOptimizerVersion() {\n       return MoreObjects.firstNonNull(System.getenv(SPANNER_OPTIMIZER_VERSION_ENV_VAR), \"\");\n     }\n+\n+    @Override", "originalCommit": "b165e3c79ad7ee1945a7b06e1923f4b3b469a2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwMzE5MQ==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471203191", "bodyText": "Used to set the optimizer statistics package through a statement, such as:\nSET OPTIMIZER_STATISTICS_PACKAGE = 'custom-package';", "author": "thiagotnunes", "createdAt": "2020-08-17T02:36:57Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/Connection.java", "diffHunk": "@@ -412,6 +417,25 @@\n    */\n   String getOptimizerVersion();\n \n+  /**\n+   * Sets the query optimizer statistics package\n+   *\n+   * @param optimizerStatisticsPackage The query optimizer statistics package to use. Must be a\n+   *     string composed of letters, numbers, dashes and underscores or an empty string. The empty\n+   *     string will instruct the connection to use the optimizer statistics package that is defined\n+   *     the environment variable <code>SPANNER_OPTIMIZER_STATISTICS_PACKAGE</code>. If no value is\n+   *     specified in the environment variable, the client level query optimizer is used. If none is\n+   *     set, the default query optimizer of Cloud Spanner is used.\n+   */\n+  void setOptimizerStatisticsPackage(String optimizerStatisticsPackage);", "originalCommit": "b165e3c79ad7ee1945a7b06e1923f4b3b469a2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwMzUyNA==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471203524", "bodyText": "Used to get the optimizer statistics package through a statement, such as:\nSHOW VARIABLE OPTIMIZER_STATISTICS_PACKAGE;", "author": "thiagotnunes", "createdAt": "2020-08-17T02:38:41Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/Connection.java", "diffHunk": "@@ -412,6 +417,25 @@\n    */\n   String getOptimizerVersion();\n \n+  /**\n+   * Sets the query optimizer statistics package\n+   *\n+   * @param optimizerStatisticsPackage The query optimizer statistics package to use. Must be a\n+   *     string composed of letters, numbers, dashes and underscores or an empty string. The empty\n+   *     string will instruct the connection to use the optimizer statistics package that is defined\n+   *     the environment variable <code>SPANNER_OPTIMIZER_STATISTICS_PACKAGE</code>. If no value is\n+   *     specified in the environment variable, the client level query optimizer is used. If none is\n+   *     set, the default query optimizer of Cloud Spanner is used.\n+   */\n+  void setOptimizerStatisticsPackage(String optimizerStatisticsPackage);\n+\n+  /**\n+   * Gets the current query optimizer statistics package of this connection.\n+   *\n+   * @return The query optimizer statistics package that is currently used by this connection.\n+   */\n+  String getOptimizerStatisticsPackage();", "originalCommit": "b165e3c79ad7ee1945a7b06e1923f4b3b469a2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwNDA4Mw==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471204083", "bodyText": "Used to parse a client side statement to set the optimizer statistics package.", "author": "thiagotnunes", "createdAt": "2020-08-17T02:41:04Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionStatementExecutor.java", "diffHunk": "@@ -64,6 +64,10 @@\n \n   StatementResult statementShowOptimizerVersion();\n \n+  StatementResult statementSetOptimizerStatisticsPackage(String optimizerStatisticsPackage);", "originalCommit": "b165e3c79ad7ee1945a7b06e1923f4b3b469a2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTIwNDcxMA==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471204710", "bodyText": "Used to parse a client side statement to get the optimizer statistics package.", "author": "thiagotnunes", "createdAt": "2020-08-17T02:44:00Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionStatementExecutor.java", "diffHunk": "@@ -64,6 +64,10 @@\n \n   StatementResult statementShowOptimizerVersion();\n \n+  StatementResult statementSetOptimizerStatisticsPackage(String optimizerStatisticsPackage);\n+\n+  StatementResult statementShowOptimizerStatisticsPackage();", "originalCommit": "b165e3c79ad7ee1945a7b06e1923f4b3b469a2c0", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MTcyNA==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471291724", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             *       SET OPTIMIZER_STATISTICS_PACKAGE='&lt;package&gt;'\n          \n          \n            \n             *       SET OPTIMIZER_STATISTICS_PACKAGE='&lt;package&gt;' | ''", "author": "olavloite", "createdAt": "2020-08-17T07:28:25Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/Connection.java", "diffHunk": "@@ -88,6 +88,11 @@\n  *   <li><code>\n  *       SET OPTIMIZER_VERSION='&lt;version&gt;' | 'LATEST'\n  *       </code>: Sets the value of <code>OPTIMIZER_VERSION</code> for this connection.\n+ *   <li><code>SHOW OPTIMIZER_STATISTICS_PACKAGE</code>: Returns the current value of <code>\n+ *       OPTIMIZER_STATISTICS_PACKAGE</code> of this connection as a {@link ResultSet}\n+ *   <li><code>\n+ *       SET OPTIMIZER_STATISTICS_PACKAGE='&lt;package&gt;'", "originalCommit": "b165e3c79ad7ee1945a7b06e1923f4b3b469a2c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxODY0Mg==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471318642", "bodyText": "Fixed in 88c2033.", "author": "thiagotnunes", "createdAt": "2020-08-17T08:21:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MTcyNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMDkyOQ==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471310929", "bodyText": "I assume that the changes to this file will be removed later, as this is part of the generated code.", "author": "olavloite", "createdAt": "2020-08-17T08:07:36Z", "path": "proto-google-cloud-spanner-v1/src/main/java/com/google/spanner/v1/ExecuteSqlRequest.java", "diffHunk": "@@ -402,6 +402,9 @@ private QueryMode(int value) {\n      * SPANNER_SYS.SUPPORTED_OPTIMIZER_VERSIONS. Executing a SQL statement\n      * with an invalid optimizer version will fail with a syntax error\n      * (`INVALID_ARGUMENT`) status.\n+     * See", "originalCommit": "b165e3c79ad7ee1945a7b06e1923f4b3b469a2c0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxNjE5MQ==", "url": "https://github.com/googleapis/java-spanner/pull/385#discussion_r471316191", "bodyText": "Yes, I added them here, so that the build would pass.", "author": "thiagotnunes", "createdAt": "2020-08-17T08:17:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTMxMDkyOQ=="}], "type": "inlineReview"}, {"oid": "d69f21763a68ce04c3a819d4d574d4dd994e2640", "url": "https://github.com/googleapis/java-spanner/commit/d69f21763a68ce04c3a819d4d574d4dd994e2640", "message": "Merge branch 'master' of github.com:thiagotnunes/java-spanner into adds-query-optimizer-statistics-support", "committedDate": "2021-06-05T05:27:40Z", "type": "forcePushed"}, {"oid": "69e8934ac60bc7f7b1d3d16570855e4d2a213425", "url": "https://github.com/googleapis/java-spanner/commit/69e8934ac60bc7f7b1d3d16570855e4d2a213425", "message": "Merge branch 'master' of https://github.com/googleapis/java-spanner into adds-query-optimizer-statistics-support", "committedDate": "2020-09-07T02:33:51Z", "type": "forcePushed"}, {"oid": "a12b81cc3735bc67619884db6ed46ff0d1cd9f17", "url": "https://github.com/googleapis/java-spanner/commit/a12b81cc3735bc67619884db6ed46ff0d1cd9f17", "message": "feat: adds optimizer_statistics_package option\n\nAdds the possibility to set the optimizer statistics package when\nexecuting queries. This option can be set in different levels as follows:\n1. Through statement hints\n2. Through query level configuration\n3. Through an environment variable\n4. Through application level configuration\n\nIf more than one package is set (in different levels) the precedence is\nfrom 1 to 4 (1 has top priority).", "committedDate": "2021-06-05T05:36:38Z", "type": "commit"}, {"oid": "c16a2dca7e3ef537fde1f58af0b2d32ec8e3f3c3", "url": "https://github.com/googleapis/java-spanner/commit/c16a2dca7e3ef537fde1f58af0b2d32ec8e3f3c3", "message": "test: adds integration tests\n\nAdds integration tests for setting the query options optimizer\nstatistics package.", "committedDate": "2021-06-05T05:36:38Z", "type": "commit"}, {"oid": "217316613ae40006891fd7ce8b0aa2f02536684e", "url": "https://github.com/googleapis/java-spanner/commit/217316613ae40006891fd7ce8b0aa2f02536684e", "message": "fix: addresses PR comments\n\nFix missing value in the documentation of the optimizer statistics\npackage for the connection class.", "committedDate": "2021-06-05T05:36:38Z", "type": "commit"}, {"oid": "5a25b9762f566c09486a390e5564f97a024d48e6", "url": "https://github.com/googleapis/java-spanner/commit/5a25b9762f566c09486a390e5564f97a024d48e6", "message": "fix: adds tests for invalid stats packages\n\nAdds tests for invalid statistics packages (whitespace only ones).", "committedDate": "2021-06-05T05:36:38Z", "type": "commit"}, {"oid": "6a48abef967370c617773c13bc8fd4b8737d17fd", "url": "https://github.com/googleapis/java-spanner/commit/6a48abef967370c617773c13bc8fd4b8737d17fd", "message": "fix: adds integration tests for query options\n\nAdds an integration test to run the sql script with several expectations\nfor the query options. These are tests for the optimizer version and\noptimizer statistics package.", "committedDate": "2021-06-05T05:36:38Z", "type": "commit"}, {"oid": "954dfc8a6a1d39bf05f000f5de44eff0dcae1f2e", "url": "https://github.com/googleapis/java-spanner/commit/954dfc8a6a1d39bf05f000f5de44eff0dcae1f2e", "message": "fix: formatting of ClientSideStatements.json\n\nThis file is using a mix of tabs and spaces. For now I have formatted as\nthe other lines, so that the diff is clear. In a further PR I will\nreformat the whole file to use only spaces.", "committedDate": "2021-06-05T05:36:38Z", "type": "commit"}, {"oid": "954dfc8a6a1d39bf05f000f5de44eff0dcae1f2e", "url": "https://github.com/googleapis/java-spanner/commit/954dfc8a6a1d39bf05f000f5de44eff0dcae1f2e", "message": "fix: formatting of ClientSideStatements.json\n\nThis file is using a mix of tabs and spaces. For now I have formatted as\nthe other lines, so that the diff is clear. In a further PR I will\nreformat the whole file to use only spaces.", "committedDate": "2021-06-05T05:36:38Z", "type": "forcePushed"}, {"oid": "8cf5f104c5ca402af2353c81226755647d084b92", "url": "https://github.com/googleapis/java-spanner/commit/8cf5f104c5ca402af2353c81226755647d084b92", "message": "Merge branch 'master' of github.com:thiagotnunes/java-spanner into adds-query-optimizer-statistics-support", "committedDate": "2021-06-05T05:46:59Z", "type": "commit"}, {"oid": "5d7350c9cf23c1e313b8d2126187b5f9b9a7c668", "url": "https://github.com/googleapis/java-spanner/commit/5d7350c9cf23c1e313b8d2126187b5f9b9a7c668", "message": "tests: fix Connection test\n\nFixes connection test when using environment variables for retrieving\nconfigurations. This only works when a first connection is created, so\nwe moved this specific test to its own subclass.", "committedDate": "2021-06-05T06:03:19Z", "type": "commit"}, {"oid": "c3e365a9a1d4f7ec0225f5cdacaa70d9ff2bb415", "url": "https://github.com/googleapis/java-spanner/commit/c3e365a9a1d4f7ec0225f5cdacaa70d9ff2bb415", "message": "fix: fix clirr checks\n\nProvides default interface implementations and fixes clirr checks", "committedDate": "2021-06-05T06:09:22Z", "type": "commit"}]}