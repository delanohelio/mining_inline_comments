{"pr_number": 675, "pr_title": "chore: add DirectPath fallback integration test", "pr_createdAt": "2020-11-30T22:28:47Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/675", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NTkzNA==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r532945934", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import static com.google.common.truth.Truth.assertThat;\n          \n          \n            \n            import static com.google.common.truth.Truth.assertWithMessage;\n          \n          \n            \n            import static com.google.common.truth.Truth.assertWithMessage;", "author": "yoshi-code-bot", "createdAt": "2020-11-30T22:30:41Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * Copyright 2017 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;", "originalCommit": "143ea64d5c73443bc316a1b33e749d1770819715", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk0NTkzNg==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r532945936", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import com.google.cloud.spanner.SpannerOptions;\n          \n          \n            \n            import com.google.cloud.spanner.Struct;\n          \n          \n            \n            import com.google.cloud.spanner.SpannerOptions;", "author": "yoshi-code-bot", "createdAt": "2020-11-30T22:30:41Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * Copyright 2017 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n+\n+import com.google.api.core.ApiFunction;\n+import com.google.api.gax.core.FixedCredentialsProvider;\n+import com.google.api.gax.grpc.InstantiatingGrpcChannelProvider;\n+import com.google.auth.oauth2.ComputeEngineCredentials;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseClient;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.Key;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.SpannerOptions;\n+import com.google.cloud.spanner.Struct;", "originalCommit": "143ea64d5c73443bc316a1b33e749d1770819715", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "9c44cfc4c8228713539552229f4d9432acc07441", "url": "https://github.com/googleapis/java-spanner/commit/9c44cfc4c8228713539552229f4d9432acc07441", "message": "chore: add DirectPath fallback integration test", "committedDate": "2020-12-01T00:26:02Z", "type": "forcePushed"}, {"oid": "e04a5a5d3a317fc2ea61a10a973ce454e64f23e7", "url": "https://github.com/googleapis/java-spanner/commit/e04a5a5d3a317fc2ea61a10a973ce454e64f23e7", "message": "chore: add DirectPath fallback integration test", "committedDate": "2020-12-01T03:19:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1OTQ4NQ==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r532959485", "bodyText": "Could we print a message / exit the test if something goes wrong here? Also, could we catch only Exception instead of Throwable?", "author": "thiagotnunes", "createdAt": "2020-11-30T23:01:19Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * Copyright 2017 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n+\n+import com.google.api.core.ApiFunction;\n+import com.google.api.gax.core.FixedCredentialsProvider;\n+import com.google.api.gax.grpc.InstantiatingGrpcChannelProvider;\n+import com.google.auth.oauth2.ComputeEngineCredentials;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseClient;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.Key;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.SpannerOptions;\n+import com.google.cloud.spanner.Struct;\n+import com.google.cloud.spanner.TimestampBound;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.common.base.Stopwatch;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.alts.ComputeEngineChannelBuilder;\n+import io.grpc.netty.shaded.io.grpc.netty.NettyChannelBuilder;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelDuplexHandler;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelFactory;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelHandlerContext;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelPromise;\n+import io.grpc.netty.shaded.io.netty.channel.EventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.socket.nio.NioSocketChannel;\n+import io.grpc.netty.shaded.io.netty.util.ReferenceCountUtil;\n+import java.io.IOException;\n+import java.lang.reflect.Field;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.SocketAddress;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * Test DirectPath fallback behavior by injecting a ChannelHandler into the netty stack that will\n+ * disrupt IPv6 communications.\n+ *\n+ * <p>WARNING: this test can only be run on a GCE VM and will explicitly ignore\n+ * GOOGLE_APPLICATION_CREDENTIALS and use the service account associated with the VM.\n+ */\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITDirectPathFallback {\n+  // A threshold of completed read calls to observe to ascertain IPv6 is working.\n+  // This was determined experimentally to account for both gRPC-LB RPCs and Bigtable api RPCs.\n+  private static final int MIN_COMPLETE_READ_CALLS = 40;\n+  private static final int NUM_RPCS_TO_SEND = 20;\n+\n+  // IP address prefixes allocated for DirectPath backends.\n+  private static final String DP_IPV6_PREFIX = \"2001:4860:8040\";\n+  private static final String DP_IPV4_PREFIX = \"34.126\";\n+\n+  @ClassRule public static IntegrationTestEnv env = new IntegrationTestEnv();\n+\n+  private AtomicBoolean blackholeDpAddr = new AtomicBoolean();\n+  private AtomicInteger numBlocked = new AtomicInteger();\n+  private AtomicInteger numDpAddrRead = new AtomicInteger();\n+  private boolean isDpAddr;\n+\n+  private ChannelFactory<NioSocketChannel> channelFactory;\n+  private EventLoopGroup eventLoopGroup;\n+  private RemoteSpannerHelper testHelper;\n+\n+  private static final String TABLE_NAME = \"TestTable\";\n+  private static final List<String> ALL_COLUMNS = Arrays.asList(\"Key\", \"StringValue\");\n+  private static Database db;\n+  private static DatabaseClient client;\n+\n+  private static final String DIRECT_PATH_ENDPOINT = \"aa423245250f2bbf.sandbox.googleapis.com:443\";\n+\n+  public ITDirectPathFallback() {\n+    // Create a transport channel provider that can intercept ipv6 packets.\n+    channelFactory = new MyChannelFactory();\n+    eventLoopGroup = new NioEventLoopGroup();\n+  }\n+\n+  @Before\n+  public void setup() throws IOException {\n+    // Get default spanner options for Ingetration test\n+    SpannerOptions.Builder builder = env.getTestHelper().getOptions().toBuilder();\n+    // Set instrumented transport provider\n+    builder.setChannelProvider(\n+        InstantiatingGrpcChannelProvider.newBuilder()\n+            .setAttemptDirectPath(true)\n+            .setEndpoint(DIRECT_PATH_ENDPOINT)\n+            .setPoolSize(1)\n+            .setChannelConfigurator(\n+                new ApiFunction<ManagedChannelBuilder, ManagedChannelBuilder>() {\n+                  @Override\n+                  public ManagedChannelBuilder apply(ManagedChannelBuilder builder) {\n+                    injectNettyChannelHandler(builder);\n+                    // Fail fast when blackhole is active\n+                    builder.keepAliveTime(1, TimeUnit.SECONDS);\n+                    builder.keepAliveTimeout(1, TimeUnit.SECONDS);\n+                    return builder;\n+                  }\n+                })\n+            .build());\n+    // Forcefully ignore GOOGLE_APPLICATION_CREDENTIALS\n+    builder.setCredentials(\n+        FixedCredentialsProvider.create(ComputeEngineCredentials.create()).getCredentials());\n+\n+    // Create a new testHelper with the instrumented transport provider\n+    try {\n+      testHelper = RemoteSpannerHelper.create(builder.build(), env.getTestHelper().getInstanceId());\n+    } catch (Throwable t) {", "originalCommit": "143ea64d5c73443bc316a1b33e749d1770819715", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4OTQwNA==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533089404", "bodyText": "The original function https://github.com/googleapis/java-spanner/blob/master/google-cloud-spanner/src/main/java/com/google/cloud/spanner/testing/RemoteSpannerHelper.java#L158 throws a Throwable. Since we do not want to catch a Throwable, I directly throw it.", "author": "mohanli-ml", "createdAt": "2020-12-01T05:55:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1OTQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1OTg5Mg==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r532959892", "bodyText": "Do we have to wait for 2 minutes for this test? This slows down the whole integration suite when running locally.", "author": "thiagotnunes", "createdAt": "2020-11-30T23:02:20Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * Copyright 2017 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n+\n+import com.google.api.core.ApiFunction;\n+import com.google.api.gax.core.FixedCredentialsProvider;\n+import com.google.api.gax.grpc.InstantiatingGrpcChannelProvider;\n+import com.google.auth.oauth2.ComputeEngineCredentials;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseClient;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.Key;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.SpannerOptions;\n+import com.google.cloud.spanner.Struct;\n+import com.google.cloud.spanner.TimestampBound;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.common.base.Stopwatch;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.alts.ComputeEngineChannelBuilder;\n+import io.grpc.netty.shaded.io.grpc.netty.NettyChannelBuilder;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelDuplexHandler;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelFactory;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelHandlerContext;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelPromise;\n+import io.grpc.netty.shaded.io.netty.channel.EventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.socket.nio.NioSocketChannel;\n+import io.grpc.netty.shaded.io.netty.util.ReferenceCountUtil;\n+import java.io.IOException;\n+import java.lang.reflect.Field;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.SocketAddress;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * Test DirectPath fallback behavior by injecting a ChannelHandler into the netty stack that will\n+ * disrupt IPv6 communications.\n+ *\n+ * <p>WARNING: this test can only be run on a GCE VM and will explicitly ignore\n+ * GOOGLE_APPLICATION_CREDENTIALS and use the service account associated with the VM.\n+ */\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITDirectPathFallback {\n+  // A threshold of completed read calls to observe to ascertain IPv6 is working.\n+  // This was determined experimentally to account for both gRPC-LB RPCs and Bigtable api RPCs.\n+  private static final int MIN_COMPLETE_READ_CALLS = 40;\n+  private static final int NUM_RPCS_TO_SEND = 20;\n+\n+  // IP address prefixes allocated for DirectPath backends.\n+  private static final String DP_IPV6_PREFIX = \"2001:4860:8040\";\n+  private static final String DP_IPV4_PREFIX = \"34.126\";\n+\n+  @ClassRule public static IntegrationTestEnv env = new IntegrationTestEnv();\n+\n+  private AtomicBoolean blackholeDpAddr = new AtomicBoolean();\n+  private AtomicInteger numBlocked = new AtomicInteger();\n+  private AtomicInteger numDpAddrRead = new AtomicInteger();\n+  private boolean isDpAddr;\n+\n+  private ChannelFactory<NioSocketChannel> channelFactory;\n+  private EventLoopGroup eventLoopGroup;\n+  private RemoteSpannerHelper testHelper;\n+\n+  private static final String TABLE_NAME = \"TestTable\";\n+  private static final List<String> ALL_COLUMNS = Arrays.asList(\"Key\", \"StringValue\");\n+  private static Database db;\n+  private static DatabaseClient client;\n+\n+  private static final String DIRECT_PATH_ENDPOINT = \"aa423245250f2bbf.sandbox.googleapis.com:443\";\n+\n+  public ITDirectPathFallback() {\n+    // Create a transport channel provider that can intercept ipv6 packets.\n+    channelFactory = new MyChannelFactory();\n+    eventLoopGroup = new NioEventLoopGroup();\n+  }\n+\n+  @Before\n+  public void setup() throws IOException {\n+    // Get default spanner options for Ingetration test\n+    SpannerOptions.Builder builder = env.getTestHelper().getOptions().toBuilder();\n+    // Set instrumented transport provider\n+    builder.setChannelProvider(\n+        InstantiatingGrpcChannelProvider.newBuilder()\n+            .setAttemptDirectPath(true)\n+            .setEndpoint(DIRECT_PATH_ENDPOINT)\n+            .setPoolSize(1)\n+            .setChannelConfigurator(\n+                new ApiFunction<ManagedChannelBuilder, ManagedChannelBuilder>() {\n+                  @Override\n+                  public ManagedChannelBuilder apply(ManagedChannelBuilder builder) {\n+                    injectNettyChannelHandler(builder);\n+                    // Fail fast when blackhole is active\n+                    builder.keepAliveTime(1, TimeUnit.SECONDS);\n+                    builder.keepAliveTimeout(1, TimeUnit.SECONDS);\n+                    return builder;\n+                  }\n+                })\n+            .build());\n+    // Forcefully ignore GOOGLE_APPLICATION_CREDENTIALS\n+    builder.setCredentials(\n+        FixedCredentialsProvider.create(ComputeEngineCredentials.create()).getCredentials());\n+\n+    // Create a new testHelper with the instrumented transport provider\n+    try {\n+      testHelper = RemoteSpannerHelper.create(builder.build(), env.getTestHelper().getInstanceId());\n+    } catch (Throwable t) {\n+    }\n+\n+    db =\n+        testHelper.createTestDatabase(\n+            \"CREATE TABLE TestTable (\"\n+                + \"  Key                STRING(MAX) NOT NULL,\"\n+                + \"  StringValue        STRING(MAX),\"\n+                + \") PRIMARY KEY (Key)\",\n+            \"CREATE INDEX TestTableByValue ON TestTable(StringValue)\",\n+            \"CREATE INDEX TestTableByValueDesc ON TestTable(StringValue DESC)\");\n+    client = testHelper.getDatabaseClient(db);\n+    List<Mutation> mutations = new ArrayList<>();\n+    for (int i = 0; i < 3; ++i) {\n+      mutations.add(\n+          Mutation.newInsertOrUpdateBuilder(TABLE_NAME)\n+              .set(\"Key\")\n+              .to(\"k\" + i)\n+              .set(\"StringValue\")\n+              .to(\"v\" + i)\n+              .build());\n+    }\n+    client.write(mutations);\n+  }\n+\n+  @After\n+  public void teardown() {\n+    if (testHelper != null) {\n+      testHelper.cleanUp();\n+      testHelper.getClient().close();\n+    }\n+    if (eventLoopGroup != null) {\n+      eventLoopGroup.shutdownGracefully();\n+    }\n+  }\n+\n+  @Test\n+  public void testFallback() throws InterruptedException, TimeoutException {\n+    // Precondition: wait for DirectPath to connect\n+    assertWithMessage(\"Failed to observe RPCs over DirectPath\").that(exerciseDirectPath()).isTrue();\n+\n+    // Enable the blackhole, which will prevent communication with grpclb and thus DirectPath.\n+    blackholeDpAddr.set(true);\n+\n+    // Send a request, which should be routed over IPv4 and CFE.\n+    client.singleUse(TimestampBound.strong()).readRow(TABLE_NAME, Key.of(\"k0\"), ALL_COLUMNS);\n+\n+    // Verify that the above check was meaningful, by verifying that the blackhole actually dropped\n+    // packets.\n+    assertWithMessage(\"Failed to detect any IPv6 traffic in blackhole\")\n+        .that(numBlocked.get())\n+        .isGreaterThan(0);\n+\n+    // Make sure that the client will start reading from IPv6 again by sending new requests and\n+    // checking the injected IPv6 counter has been updated.\n+    blackholeDpAddr.set(false);\n+\n+    assertWithMessage(\"Failed to upgrade back to DirectPath\").that(exerciseDirectPath()).isTrue();\n+  }\n+\n+  private boolean exerciseDirectPath() throws InterruptedException, TimeoutException {\n+    Stopwatch stopwatch = Stopwatch.createStarted();\n+    numDpAddrRead.set(0);\n+\n+    boolean seenEnough = false;\n+\n+    while (!seenEnough && stopwatch.elapsed(TimeUnit.MINUTES) < 2) {", "originalCommit": "143ea64d5c73443bc316a1b33e749d1770819715", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4ODkxMw==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533088913", "bodyText": "The while loop will wait at most 2 minutes to get directpath traffic. In my manual test, the client should be able to get directpath traffic within a few seconds, then seenEnough becomes true, and the while loop will stop.", "author": "mohanli-ml", "createdAt": "2020-12-01T05:53:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk1OTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDU1NA==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r532960554", "bodyText": "Does this test pass locally? Will be users be able to run these (if not, maybe we should put them under the direct path profile, which is not enabled by default)?", "author": "thiagotnunes", "createdAt": "2020-11-30T23:04:04Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,304 @@\n+/*\n+ * Copyright 2017 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+import static com.google.common.truth.Truth.assertWithMessage;\n+\n+import com.google.api.core.ApiFunction;\n+import com.google.api.gax.core.FixedCredentialsProvider;\n+import com.google.api.gax.grpc.InstantiatingGrpcChannelProvider;\n+import com.google.auth.oauth2.ComputeEngineCredentials;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseClient;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.Key;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.SpannerOptions;\n+import com.google.cloud.spanner.Struct;\n+import com.google.cloud.spanner.TimestampBound;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.common.base.Stopwatch;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.alts.ComputeEngineChannelBuilder;\n+import io.grpc.netty.shaded.io.grpc.netty.NettyChannelBuilder;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelDuplexHandler;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelFactory;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelHandlerContext;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelPromise;\n+import io.grpc.netty.shaded.io.netty.channel.EventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.socket.nio.NioSocketChannel;\n+import io.grpc.netty.shaded.io.netty.util.ReferenceCountUtil;\n+import java.io.IOException;\n+import java.lang.reflect.Field;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.SocketAddress;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * Test DirectPath fallback behavior by injecting a ChannelHandler into the netty stack that will\n+ * disrupt IPv6 communications.\n+ *\n+ * <p>WARNING: this test can only be run on a GCE VM and will explicitly ignore", "originalCommit": "143ea64d5c73443bc316a1b33e749d1770819715", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5MzE0OA==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533093148", "bodyText": "Yes, my local test command mvn -Penable-integration-tests,spanner-directpath-it -DskipUTs=true -DtrimStackTrace=false -Dclirr.skip=true -Denforcer.skip=true -Dit.test=ITDirectPathFallback -DfailIfNoTests=false -Dspanner.directpath_test_scenario=ipv6 -fae verify can pass. I think users should not run this test since users are not supposed to know if the traffic is CFE or DirectPath. And to make sure the test is being running under direct path profile, I added a check at the beginning of the setup() function.", "author": "mohanli-ml", "createdAt": "2020-12-01T06:07:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk2MDU1NA=="}], "type": "inlineReview"}, {"oid": "fc4c71f9c807883ba2ca6abbd9f95cb55c000169", "url": "https://github.com/googleapis/java-spanner/commit/fc4c71f9c807883ba2ca6abbd9f95cb55c000169", "message": "chore: add DirectPath fallback integration test", "committedDate": "2020-12-01T06:09:36Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyNzMzOQ==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533627339", "bodyText": "nit: 2020", "author": "olavloite", "createdAt": "2020-12-01T18:23:22Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,305 @@\n+/*\n+ * Copyright 2017 Google LLC", "originalCommit": "fc4c71f9c807883ba2ca6abbd9f95cb55c000169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYzODU3Nw==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533638577", "bodyText": "Done. Thanks!", "author": "mohanli-ml", "createdAt": "2020-12-01T18:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyNzMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyODUzMg==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533628532", "bodyText": "I assume that this is temporary and will be replaced by a environment variable or similar at a later moment?", "author": "olavloite", "createdAt": "2020-12-01T18:25:15Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,305 @@\n+/*\n+ * Copyright 2017 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertWithMessage;\n+import static com.google.common.truth.TruthJUnit.assume;\n+\n+import com.google.api.core.ApiFunction;\n+import com.google.api.gax.core.FixedCredentialsProvider;\n+import com.google.api.gax.grpc.InstantiatingGrpcChannelProvider;\n+import com.google.auth.oauth2.ComputeEngineCredentials;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseClient;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.Key;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.SpannerOptions;\n+import com.google.cloud.spanner.TimestampBound;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.common.base.Stopwatch;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.alts.ComputeEngineChannelBuilder;\n+import io.grpc.netty.shaded.io.grpc.netty.NettyChannelBuilder;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelDuplexHandler;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelFactory;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelHandlerContext;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelPromise;\n+import io.grpc.netty.shaded.io.netty.channel.EventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.socket.nio.NioSocketChannel;\n+import io.grpc.netty.shaded.io.netty.util.ReferenceCountUtil;\n+import java.io.IOException;\n+import java.lang.reflect.Field;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.SocketAddress;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * Test DirectPath fallback behavior by injecting a ChannelHandler into the netty stack that will\n+ * disrupt IPv6 communications.\n+ *\n+ * <p>WARNING: this test can only be run on a GCE VM and will explicitly ignore\n+ * GOOGLE_APPLICATION_CREDENTIALS and use the service account associated with the VM.\n+ */\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITDirectPathFallback {\n+  // A threshold of completed read calls to observe to ascertain IPv6 is working.\n+  // This was determined experimentally to account for both gRPC-LB RPCs and Bigtable api RPCs.\n+  private static final int MIN_COMPLETE_READ_CALLS = 40;\n+  private static final int NUM_RPCS_TO_SEND = 20;\n+\n+  // IP address prefixes allocated for DirectPath backends.\n+  private static final String DP_IPV6_PREFIX = \"2001:4860:8040\";\n+  private static final String DP_IPV4_PREFIX = \"34.126\";\n+\n+  @ClassRule public static IntegrationTestEnv env = new IntegrationTestEnv();\n+\n+  private AtomicBoolean blackholeDpAddr = new AtomicBoolean();\n+  private AtomicInteger numBlocked = new AtomicInteger();\n+  private AtomicInteger numDpAddrRead = new AtomicInteger();\n+  private boolean isDpAddr;\n+\n+  private ChannelFactory<NioSocketChannel> channelFactory;\n+  private EventLoopGroup eventLoopGroup;\n+  private RemoteSpannerHelper testHelper;\n+\n+  private static final String TABLE_NAME = \"TestTable\";\n+  private static final List<String> ALL_COLUMNS = Arrays.asList(\"Key\", \"StringValue\");\n+  private static Database db;\n+  private static DatabaseClient client;\n+\n+  private static final String DIRECT_PATH_ENDPOINT = \"aa423245250f2bbf.sandbox.googleapis.com:443\";", "originalCommit": "fc4c71f9c807883ba2ca6abbd9f95cb55c000169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0MTE3NA==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533641174", "bodyText": "Yes this is temporary. It will be removed once DirectPath goes to public beta, and this test will use the default Spanner endpoint. I added a TODO here.", "author": "mohanli-ml", "createdAt": "2020-12-01T18:45:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyODUzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyOTg0MQ==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533629841", "bodyText": "nit: Could we remove these indexes? I don't think they are relevant for this test, and creating and maintaining secondary indexes are expensive operations.", "author": "olavloite", "createdAt": "2020-12-01T18:27:21Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDirectPathFallback.java", "diffHunk": "@@ -0,0 +1,305 @@\n+/*\n+ * Copyright 2017 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertWithMessage;\n+import static com.google.common.truth.TruthJUnit.assume;\n+\n+import com.google.api.core.ApiFunction;\n+import com.google.api.gax.core.FixedCredentialsProvider;\n+import com.google.api.gax.grpc.InstantiatingGrpcChannelProvider;\n+import com.google.auth.oauth2.ComputeEngineCredentials;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseClient;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.Key;\n+import com.google.cloud.spanner.Mutation;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.SpannerOptions;\n+import com.google.cloud.spanner.TimestampBound;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.common.base.Stopwatch;\n+import io.grpc.ManagedChannelBuilder;\n+import io.grpc.alts.ComputeEngineChannelBuilder;\n+import io.grpc.netty.shaded.io.grpc.netty.NettyChannelBuilder;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelDuplexHandler;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelFactory;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelHandlerContext;\n+import io.grpc.netty.shaded.io.netty.channel.ChannelPromise;\n+import io.grpc.netty.shaded.io.netty.channel.EventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.nio.NioEventLoopGroup;\n+import io.grpc.netty.shaded.io.netty.channel.socket.nio.NioSocketChannel;\n+import io.grpc.netty.shaded.io.netty.util.ReferenceCountUtil;\n+import java.io.IOException;\n+import java.lang.reflect.Field;\n+import java.net.InetAddress;\n+import java.net.InetSocketAddress;\n+import java.net.SocketAddress;\n+import java.util.ArrayList;\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.TimeoutException;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicInteger;\n+import org.junit.After;\n+import org.junit.Before;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+/**\n+ * Test DirectPath fallback behavior by injecting a ChannelHandler into the netty stack that will\n+ * disrupt IPv6 communications.\n+ *\n+ * <p>WARNING: this test can only be run on a GCE VM and will explicitly ignore\n+ * GOOGLE_APPLICATION_CREDENTIALS and use the service account associated with the VM.\n+ */\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITDirectPathFallback {\n+  // A threshold of completed read calls to observe to ascertain IPv6 is working.\n+  // This was determined experimentally to account for both gRPC-LB RPCs and Bigtable api RPCs.\n+  private static final int MIN_COMPLETE_READ_CALLS = 40;\n+  private static final int NUM_RPCS_TO_SEND = 20;\n+\n+  // IP address prefixes allocated for DirectPath backends.\n+  private static final String DP_IPV6_PREFIX = \"2001:4860:8040\";\n+  private static final String DP_IPV4_PREFIX = \"34.126\";\n+\n+  @ClassRule public static IntegrationTestEnv env = new IntegrationTestEnv();\n+\n+  private AtomicBoolean blackholeDpAddr = new AtomicBoolean();\n+  private AtomicInteger numBlocked = new AtomicInteger();\n+  private AtomicInteger numDpAddrRead = new AtomicInteger();\n+  private boolean isDpAddr;\n+\n+  private ChannelFactory<NioSocketChannel> channelFactory;\n+  private EventLoopGroup eventLoopGroup;\n+  private RemoteSpannerHelper testHelper;\n+\n+  private static final String TABLE_NAME = \"TestTable\";\n+  private static final List<String> ALL_COLUMNS = Arrays.asList(\"Key\", \"StringValue\");\n+  private static Database db;\n+  private static DatabaseClient client;\n+\n+  private static final String DIRECT_PATH_ENDPOINT = \"aa423245250f2bbf.sandbox.googleapis.com:443\";\n+  private static final String ATTEMPT_DIRECT_PATH = \"spanner.attempt_directpath\";\n+\n+  public ITDirectPathFallback() {\n+    // Create a transport channel provider that can intercept ipv6 packets.\n+    channelFactory = new MyChannelFactory();\n+    eventLoopGroup = new NioEventLoopGroup();\n+  }\n+\n+  @Before\n+  public void setup() throws IOException, Throwable {\n+    assume()\n+        .withMessage(\"DirectPath integration tests can only run against DirectPathEnv\")\n+        .that(Boolean.getBoolean(ATTEMPT_DIRECT_PATH))\n+        .isTrue();\n+    // Get default spanner options for Ingetration test\n+    SpannerOptions.Builder builder = env.getTestHelper().getOptions().toBuilder();\n+    // Set instrumented transport provider\n+    builder.setChannelProvider(\n+        InstantiatingGrpcChannelProvider.newBuilder()\n+            .setAttemptDirectPath(true)\n+            .setEndpoint(DIRECT_PATH_ENDPOINT)\n+            .setPoolSize(1)\n+            .setChannelConfigurator(\n+                new ApiFunction<ManagedChannelBuilder, ManagedChannelBuilder>() {\n+                  @Override\n+                  public ManagedChannelBuilder apply(ManagedChannelBuilder builder) {\n+                    injectNettyChannelHandler(builder);\n+                    // Fail fast when blackhole is active\n+                    builder.keepAliveTime(1, TimeUnit.SECONDS);\n+                    builder.keepAliveTimeout(1, TimeUnit.SECONDS);\n+                    return builder;\n+                  }\n+                })\n+            .build());\n+    // Forcefully ignore GOOGLE_APPLICATION_CREDENTIALS\n+    builder.setCredentials(\n+        FixedCredentialsProvider.create(ComputeEngineCredentials.create()).getCredentials());\n+\n+    // Create a new testHelper with the instrumented transport provider\n+    testHelper = RemoteSpannerHelper.create(builder.build(), env.getTestHelper().getInstanceId());\n+\n+    db =\n+        testHelper.createTestDatabase(\n+            \"CREATE TABLE TestTable (\"\n+                + \"  Key                STRING(MAX) NOT NULL,\"\n+                + \"  StringValue        STRING(MAX),\"\n+                + \") PRIMARY KEY (Key)\",\n+            \"CREATE INDEX TestTableByValue ON TestTable(StringValue)\",", "originalCommit": "fc4c71f9c807883ba2ca6abbd9f95cb55c000169", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY0MzE1OA==", "url": "https://github.com/googleapis/java-spanner/pull/675#discussion_r533643158", "bodyText": "Done. Thanks!", "author": "mohanli-ml", "createdAt": "2020-12-01T18:49:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYyOTg0MQ=="}], "type": "inlineReview"}, {"oid": "3d549ed3a14728aba43a1df3a62922c1b52bce61", "url": "https://github.com/googleapis/java-spanner/commit/3d549ed3a14728aba43a1df3a62922c1b52bce61", "message": "chore: add DirectPath fallback integration test", "committedDate": "2020-12-01T18:50:27Z", "type": "commit"}, {"oid": "3d549ed3a14728aba43a1df3a62922c1b52bce61", "url": "https://github.com/googleapis/java-spanner/commit/3d549ed3a14728aba43a1df3a62922c1b52bce61", "message": "chore: add DirectPath fallback integration test", "committedDate": "2020-12-01T18:50:27Z", "type": "forcePushed"}]}