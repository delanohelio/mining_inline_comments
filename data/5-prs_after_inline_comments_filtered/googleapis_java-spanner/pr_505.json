{"pr_number": 505, "pr_title": "fix: AsyncTransactionManager should rollback on close", "pr_createdAt": "2020-10-09T10:23:48Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/505", "timeline": [{"oid": "d79c460bf0d12b272e6ec6db5d55d394918a7beb", "url": "https://github.com/googleapis/java-spanner/commit/d79c460bf0d12b272e6ec6db5d55d394918a7beb", "message": "fix: AsyncTransactionManager should rollback on close\n\nAsyncTransctionManager should rollback the transaction if close is called\nwhile the transaction is still in state STARTED. Failing to do so, will\nkeep the transaction open on the backend for longer than necessary, holding\non to locks until it is garbage collected after 10 seconds.\n\nFixes #504", "committedDate": "2020-10-09T10:21:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ3NzI5Nw==", "url": "https://github.com/googleapis/java-spanner/pull/505#discussion_r502477297", "bodyText": "Can there be a version of close() that propagates the ApiFutrue from rollbackAsync() back to the caller? Otherwise the application could shut down (or, in my case, the test terminate) before the rollback happens.", "author": "elefeint", "createdAt": "2020-10-09T14:43:45Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/AsyncTransactionManagerImpl.java", "diffHunk": "@@ -54,6 +54,9 @@ public void setSpan(Span span) {\n \n   @Override\n   public void close() {\n+    if (txnState == TransactionState.STARTED) {\n+      rollbackAsync();", "originalCommit": "d79c460bf0d12b272e6ec6db5d55d394918a7beb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDE1Nzk4MQ==", "url": "https://github.com/googleapis/java-spanner/pull/505#discussion_r504157981", "bodyText": "I've added a closeAsync() method to the AsyncTransactionManager interface that returns an ApiFuture that is done when everything has been rolled back and released. PTAL.", "author": "olavloite", "createdAt": "2020-10-13T18:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ3NzI5Nw=="}], "type": "inlineReview"}, {"oid": "daed417fdc2453d0365c545083b673eac3c06763", "url": "https://github.com/googleapis/java-spanner/commit/daed417fdc2453d0365c545083b673eac3c06763", "message": "feat: return rollback result from close", "committedDate": "2020-10-13T14:57:48Z", "type": "commit"}, {"oid": "0614cc4ca8b180f9880affb8d40f695b03fd752c", "url": "https://github.com/googleapis/java-spanner/commit/0614cc4ca8b180f9880affb8d40f695b03fd752c", "message": "fix: add ignored diff to clirr", "committedDate": "2020-10-13T15:00:28Z", "type": "commit"}]}