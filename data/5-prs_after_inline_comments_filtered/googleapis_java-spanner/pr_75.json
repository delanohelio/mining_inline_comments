{"pr_number": 75, "pr_title": "Fix: multiple calls to end of span", "pr_createdAt": "2020-02-14T05:39:29Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/75", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTI1ODM1Mw==", "url": "https://github.com/googleapis/java-spanner/pull/75#discussion_r379258353", "bodyText": "tracer.getCurrentSpan() is called outside of scope, which means endSpanWithFailure will execute on either READ_WRITE_TRANSACTION or READ_ONLY_TRANSACTION span instead of WAIT_FOR_SESSION span.", "author": "mayurkale22", "createdAt": "2020-02-14T05:39:57Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -892,7 +892,7 @@ private PooledSession take() throws SpannerException {\n             return s.session;\n           }\n         } catch (Exception e) {\n-          TraceUtil.endSpanWithFailure(tracer.getCurrentSpan(), e);", "originalCommit": "478251f868ba8c668326648b4a1f14e11b6e6881", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1OTYwNQ==", "url": "https://github.com/googleapis/java-spanner/pull/75#discussion_r379559605", "bodyText": "is endSpanWithFailure used anywhere now? If not then please remove it.", "author": "rghetia", "createdAt": "2020-02-14T17:41:37Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/TraceUtil.java", "diffHunk": "@@ -54,6 +54,16 @@\n         \"Status\", AttributeValue.stringAttributeValue(e.getErrorCode().toString()));\n   }\n \n+  static void setWithFailure(Span span, Throwable e) {\n+    if (e instanceof SpannerException) {\n+      span.setStatus(\n+          StatusConverter.fromGrpcStatus(((SpannerException) e).getErrorCode().getGrpcStatus())\n+              .withDescription(e.getMessage()));\n+    } else {\n+      span.setStatus(Status.INTERNAL.withDescription(e.getMessage()));\n+    }\n+  }\n+\n   static void endSpanWithFailure(Span span, Throwable e) {", "originalCommit": "478251f868ba8c668326648b4a1f14e11b6e6881", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTY4MzU5Mw==", "url": "https://github.com/googleapis/java-spanner/pull/75#discussion_r379683593", "bodyText": "This has been used in a few places (ex: singleUse) where span does not end except when there is a failure.\nSee: https://github.com/googleapis/google-cloud-java/pull/2677/files#r157323309 for original reason.", "author": "mayurkale22", "createdAt": "2020-02-14T23:07:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTU1OTYwNQ=="}], "type": "inlineReview"}, {"oid": "30ab679d3217de6d9a98eb0a25d3009f891c81ca", "url": "https://github.com/googleapis/java-spanner/commit/30ab679d3217de6d9a98eb0a25d3009f891c81ca", "message": "attempt to fix tests", "committedDate": "2020-02-20T22:52:11Z", "type": "forcePushed"}, {"oid": "55f9dcb9bfb9385fdc512c411b68cdecccb8b79b", "url": "https://github.com/googleapis/java-spanner/commit/55f9dcb9bfb9385fdc512c411b68cdecccb8b79b", "message": "attempt to fix tests", "committedDate": "2020-02-20T22:54:40Z", "type": "forcePushed"}, {"oid": "02563ec904f38cd74b265ca8981b80d5b543d5f7", "url": "https://github.com/googleapis/java-spanner/commit/02563ec904f38cd74b265ca8981b80d5b543d5f7", "message": "attempt to fix tests", "committedDate": "2020-02-21T00:21:14Z", "type": "forcePushed"}, {"oid": "c0689bd4ecce3dcb6b2397b6dc802b3339372c83", "url": "https://github.com/googleapis/java-spanner/commit/c0689bd4ecce3dcb6b2397b6dc802b3339372c83", "message": "attempt to fix tests", "committedDate": "2020-02-21T00:44:57Z", "type": "forcePushed"}, {"oid": "feb6157e65376998f97c3fc3210ec1a21b99d2c6", "url": "https://github.com/googleapis/java-spanner/commit/feb6157e65376998f97c3fc3210ec1a21b99d2c6", "message": "fix: multiple span.end calling", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "a96f099d68bcaff50d594ca224bdfe663a57fd6a", "url": "https://github.com/googleapis/java-spanner/commit/a96f099d68bcaff50d594ca224bdfe663a57fd6a", "message": "fix: multiple span.end calling", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "1a6376d8dac18a14c9b6903f36adf0ee968044bc", "url": "https://github.com/googleapis/java-spanner/commit/1a6376d8dac18a14c9b6903f36adf0ee968044bc", "message": "fix: multiple span.end calling", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "3d5561b31b63cc02856183f98288667ac2fe0da6", "url": "https://github.com/googleapis/java-spanner/commit/3d5561b31b63cc02856183f98288667ac2fe0da6", "message": "integrate test framework for span", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "5042cae19d985a0de9d397e1f83e77c60640d106", "url": "https://github.com/googleapis/java-spanner/commit/5042cae19d985a0de9d397e1f83e77c60640d106", "message": "add stream=null", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "6082a6dd399f104f24a0d6ae10f5a70a831508b5", "url": "https://github.com/googleapis/java-spanner/commit/6082a6dd399f104f24a0d6ae10f5a70a831508b5", "message": "fix: execute tracer tests in separate execution", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "dbe356e96e799c5ba03534c958edf2f0a7403f48", "url": "https://github.com/googleapis/java-spanner/commit/dbe356e96e799c5ba03534c958edf2f0a7403f48", "message": "format: format pom", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "1bcaee80ce91f1ae285d53359fac6e03c06ceede", "url": "https://github.com/googleapis/java-spanner/commit/1bcaee80ce91f1ae285d53359fac6e03c06ceede", "message": "attempt to fix tests", "committedDate": "2020-02-21T21:58:44Z", "type": "commit"}, {"oid": "1bcaee80ce91f1ae285d53359fac6e03c06ceede", "url": "https://github.com/googleapis/java-spanner/commit/1bcaee80ce91f1ae285d53359fac6e03c06ceede", "message": "attempt to fix tests", "committedDate": "2020-02-21T21:58:44Z", "type": "forcePushed"}, {"oid": "a5c5d01adb036b5ac612506e036af977a7907e18", "url": "https://github.com/googleapis/java-spanner/commit/a5c5d01adb036b5ac612506e036af977a7907e18", "message": "add com.google.errorprone:error_prone_annotations to ignoredDependencies", "committedDate": "2020-02-21T22:03:46Z", "type": "commit"}]}