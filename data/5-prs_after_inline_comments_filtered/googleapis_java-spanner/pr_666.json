{"pr_number": 666, "pr_title": "feat!: customer-managed encryption keys for Spanner", "pr_createdAt": "2020-11-23T02:21:35Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/666", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDEyOA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214128", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n          \n          \n            \n              public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n          \n          \n            \n            \n          \n          \n            \n              @ClassRule\n          \n          \n            \n              public static final String SPANNER_PRODUCTION_ACCOUNT =\n          \n          \n            \n                  \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n          \n          \n            \n              public static final String KMS_KEY_ENCRYPTER_DECRYPTER =\n          \n          \n            \n                  \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n          \n          \n            \n              @ClassRule public static IntegrationTestEnv env = new IntegrationTestEnv();", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:28Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDEzNA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214134", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  dbAdminClient\n          \n          \n            \n                      .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n          \n          \n            \n                  dbAdminClient.dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:29Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    // for (CryptoKey key : keys) {\n+    //   for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+    //       .iterateAll()) {\n+    //     kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+    //   }\n+    // }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDEzOA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214138", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n          \n          \n            \n                final InstanceId instanceId = testHelper.getInstanceId();\n          \n          \n            \n                final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n          \n          \n            \n                final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n          \n          \n            \n                final String backupId = randomBackupId();\n          \n          \n            \n            \n          \n          \n            \n                final CryptoKey key = createKey(randomKeyId());\n          \n          \n            \n                final Database sourceDatabase = dbAdminClient\n          \n          \n            \n                    .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                    .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                    .build();\n          \n          \n            \n                final Backup backup = dbAdminClient\n          \n          \n            \n                    .newBackupBuilder(BackupId.of(\n          \n          \n            \n                        testHelper.getInstanceId(),\n          \n          \n            \n                        backupId\n          \n          \n            \n                    ))\n          \n          \n            \n                    .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                    .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                    .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n          \n          \n            \n                    .build();\n          \n          \n            \n                final Restore restore = dbAdminClient\n          \n          \n            \n              public void createsEncryptedDatabaseBackupAndRestore()\n          \n          \n            \n                  throws ExecutionException, InterruptedException {\n          \n          \n            \n                final Database sourceDatabase =\n          \n          \n            \n                    dbAdminClient\n          \n          \n            \n                        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                        .build();\n          \n          \n            \n                final Backup backup =\n          \n          \n            \n                    dbAdminClient\n          \n          \n            \n                        .newBackupBuilder(BackupId.of(testHelper.getInstanceId(), backupId))\n          \n          \n            \n                        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                        .setExpireTime(\n          \n          \n            \n                            com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n          \n          \n            \n                        .build();\n          \n          \n            \n                final Restore restore =\n          \n          \n            \n                    dbAdminClient\n          \n          \n            \n                        .newRestoreBuilder(\n          \n          \n            \n                            BackupId.of(testHelper.getInstanceId(), backupId),\n          \n          \n            \n                            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId))\n          \n          \n            \n                        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                        .build();", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:29Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    // for (CryptoKey key : keys) {\n+    //   for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+    //       .iterateAll()) {\n+    //     kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+    //   }\n+    // }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDE0NA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214144", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final LocationName locationName = LocationName.of(\n          \n          \n            \n                    testHelper.getOptions().getProjectId(),\n          \n          \n            \n                    KMS_KEY_LOCATION\n          \n          \n            \n                );\n          \n          \n            \n                final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n          \n          \n            \n                final Timestamp.Builder rotationTime = Timestamp\n          \n          \n            \n                    .newBuilder()\n          \n          \n            \n                    .setSeconds(after7DaysInSeconds());\n          \n          \n            \n            \n          \n          \n            \n                final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n          \n          \n            \n                    .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n          \n          \n            \n                    .setNextRotationTime(rotationTime)\n          \n          \n            \n                    .build();\n          \n          \n            \n                final CryptoKey cryptoKey = kmsClient\n          \n          \n            \n                    .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n          \n          \n            \n            \n          \n          \n            \n                final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n          \n          \n            \n                final Binding binding = Binding\n          \n          \n            \n                final LocationName locationName =\n          \n          \n            \n                    LocationName.of(testHelper.getOptions().getProjectId(), KMS_KEY_LOCATION);\n          \n          \n            \n                final Timestamp.Builder rotationTime = Timestamp.newBuilder().setSeconds(after7DaysInSeconds());\n          \n          \n            \n                final CryptoKey cryptoKeyInput =\n          \n          \n            \n                    CryptoKey.newBuilder()\n          \n          \n            \n                        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n          \n          \n            \n                        .setNextRotationTime(rotationTime)\n          \n          \n            \n                        .build();\n          \n          \n            \n                final CryptoKey cryptoKey =\n          \n          \n            \n                    kmsClient.createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n          \n          \n            \n                final Binding binding =\n          \n          \n            \n                    Binding.newBuilder()\n          \n          \n            \n                        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n          \n          \n            \n                        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n          \n          \n            \n                        .build();", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:30Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    // for (CryptoKey key : keys) {\n+    //   for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+    //       .iterateAll()) {\n+    //     kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+    //   }\n+    // }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDE0OA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214148", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    TimeUnit.MILLISECONDS\n          \n          \n            \n                );\n          \n          \n            \n              }\n          \n          \n            \n                    TimeUnit.MILLISECONDS);\n          \n          \n            \n                      KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID));", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:30Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    // for (CryptoKey key : keys) {\n+    //   for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+    //       .iterateAll()) {\n+    //     kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+    //   }\n+    // }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDE1MQ==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214151", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n          \n          \n            \n                    .createDatabase(database, Collections.<String>emptyList());\n          \n          \n            \n                final OperationFuture<Database, CreateDatabaseMetadata> op =\n          \n          \n            \n                    dbAdminClient.createDatabase(database, Collections.<String>emptyList());", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:31Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    // for (CryptoKey key : keys) {\n+    //   for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+    //       .iterateAll()) {\n+    //     kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+    //   }\n+    // }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+\n+  private KeyRing createOrRetrieveKeyRing(final LocationName locationName) {\n+    try {\n+      return kmsClient.getKeyRing(\n+          KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID)\n+      );\n+    } catch (NotFoundException e) {\n+      return kmsClient.createKeyRing(locationName, KMS_KEY_RING_ID, KeyRing.getDefaultInstance());\n+    }\n+  }\n+\n+  private Database createDatabase(final Database database)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n+        .createDatabase(database, Collections.<String>emptyList());", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDE1NA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214154", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient\n          \n          \n            \n                    .createBackup(backup);\n          \n          \n            \n                final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient.createBackup(backup);", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:31Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    // for (CryptoKey key : keys) {\n+    //   for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+    //       .iterateAll()) {\n+    //     kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+    //   }\n+    // }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+\n+  private KeyRing createOrRetrieveKeyRing(final LocationName locationName) {\n+    try {\n+      return kmsClient.getKeyRing(\n+          KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID)\n+      );\n+    } catch (NotFoundException e) {\n+      return kmsClient.createKeyRing(locationName, KMS_KEY_RING_ID, KeyRing.getDefaultInstance());\n+    }\n+  }\n+\n+  private Database createDatabase(final Database database)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n+        .createDatabase(database, Collections.<String>emptyList());\n+    final Database createdDatabase = op.get();\n+    dbs.add(createdDatabase.getId());\n+\n+    return createdDatabase;\n+  }\n+\n+  private Backup createBackup(final Backup backup) throws ExecutionException, InterruptedException {\n+    final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient\n+        .createBackup(backup);", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIxNDE1Ng==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529214156", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final OperationFuture<Database, RestoreDatabaseMetadata> op = dbAdminClient\n          \n          \n            \n                    .restoreDatabase(restore);\n          \n          \n            \n                final Database database = op.get();\n          \n          \n            \n                final OperationFuture<Database, RestoreDatabaseMetadata> op =\n          \n          \n            \n                    dbAdminClient.restoreDatabase(restore);", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:36:31Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,233 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    // for (CryptoKey key : keys) {\n+    //   for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+    //       .iterateAll()) {\n+    //     kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+    //   }\n+    // }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+\n+  private KeyRing createOrRetrieveKeyRing(final LocationName locationName) {\n+    try {\n+      return kmsClient.getKeyRing(\n+          KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID)\n+      );\n+    } catch (NotFoundException e) {\n+      return kmsClient.createKeyRing(locationName, KMS_KEY_RING_ID, KeyRing.getDefaultInstance());\n+    }\n+  }\n+\n+  private Database createDatabase(final Database database)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n+        .createDatabase(database, Collections.<String>emptyList());\n+    final Database createdDatabase = op.get();\n+    dbs.add(createdDatabase.getId());\n+\n+    return createdDatabase;\n+  }\n+\n+  private Backup createBackup(final Backup backup) throws ExecutionException, InterruptedException {\n+    final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient\n+        .createBackup(backup);\n+    final Backup createdBackup = op.get();\n+    dbs.add(createdBackup.getDatabase());\n+    backups.add(backup.getId());\n+\n+    return createdBackup;\n+  }\n+\n+  private Database restoreDatabase(final Restore restore)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, RestoreDatabaseMetadata> op = dbAdminClient\n+        .restoreDatabase(restore);\n+    final Database database = op.get();", "originalCommit": "1b85d7e96ff78524dad4766e6c09527ea4a39cd2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA3Mw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221073", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n          \n          \n            \n              public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n          \n          \n            \n            \n          \n          \n            \n              @ClassRule\n          \n          \n            \n              public static final String SPANNER_PRODUCTION_ACCOUNT =\n          \n          \n            \n                  \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n          \n          \n            \n              public static final String KMS_KEY_ENCRYPTER_DECRYPTER =\n          \n          \n            \n                  \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n          \n          \n            \n              @ClassRule public static IntegrationTestEnv env = new IntegrationTestEnv();", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:20Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA3NA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221074", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n          \n          \n            \n                      .iterateAll()) {\n          \n          \n            \n                    kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n          \n          \n            \n                  }\n          \n          \n            \n                  for (CryptoKeyVersion keyVersion :\n          \n          \n            \n                      kmsClient.listCryptoKeyVersions(key.getName()).iterateAll()) {\n          \n          \n            \n                  dbAdminClient.dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:20Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    for (CryptoKey key : keys) {\n+      for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+          .iterateAll()) {\n+        kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+      }", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA3Ng==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221076", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n          \n          \n            \n                final InstanceId instanceId = testHelper.getInstanceId();\n          \n          \n            \n                final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n          \n          \n            \n                final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n          \n          \n            \n                final String backupId = randomBackupId();\n          \n          \n            \n            \n          \n          \n            \n                final CryptoKey key = createKey(randomKeyId());\n          \n          \n            \n                final Database sourceDatabase = dbAdminClient\n          \n          \n            \n                    .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                    .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                    .build();\n          \n          \n            \n                final Backup backup = dbAdminClient\n          \n          \n            \n                    .newBackupBuilder(BackupId.of(\n          \n          \n            \n                        testHelper.getInstanceId(),\n          \n          \n            \n                        backupId\n          \n          \n            \n                    ))\n          \n          \n            \n                    .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                    .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                    .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n          \n          \n            \n                    .build();\n          \n          \n            \n                final Restore restore = dbAdminClient\n          \n          \n            \n              public void createsEncryptedDatabaseBackupAndRestore()\n          \n          \n            \n                  throws ExecutionException, InterruptedException {\n          \n          \n            \n                final Database sourceDatabase =\n          \n          \n            \n                    dbAdminClient\n          \n          \n            \n                        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                        .build();\n          \n          \n            \n                final Backup backup =\n          \n          \n            \n                    dbAdminClient\n          \n          \n            \n                        .newBackupBuilder(BackupId.of(testHelper.getInstanceId(), backupId))\n          \n          \n            \n                        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n          \n          \n            \n                        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                        .setExpireTime(\n          \n          \n            \n                            com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n          \n          \n            \n                        .build();\n          \n          \n            \n                final Restore restore =\n          \n          \n            \n                    dbAdminClient\n          \n          \n            \n                        .newRestoreBuilder(\n          \n          \n            \n                            BackupId.of(testHelper.getInstanceId(), backupId),\n          \n          \n            \n                            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId))\n          \n          \n            \n                        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n          \n          \n            \n                        .build();", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:20Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    for (CryptoKey key : keys) {\n+      for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+          .iterateAll()) {\n+        kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+      }\n+    }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA4MA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221080", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final LocationName locationName = LocationName.of(\n          \n          \n            \n                    testHelper.getOptions().getProjectId(),\n          \n          \n            \n                    KMS_KEY_LOCATION\n          \n          \n            \n                );\n          \n          \n            \n                final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n          \n          \n            \n                final Timestamp.Builder rotationTime = Timestamp\n          \n          \n            \n                    .newBuilder()\n          \n          \n            \n                    .setSeconds(after7DaysInSeconds());\n          \n          \n            \n            \n          \n          \n            \n                final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n          \n          \n            \n                    .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n          \n          \n            \n                    .setNextRotationTime(rotationTime)\n          \n          \n            \n                    .build();\n          \n          \n            \n                final CryptoKey cryptoKey = kmsClient\n          \n          \n            \n                    .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n          \n          \n            \n            \n          \n          \n            \n                final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n          \n          \n            \n                final Binding binding = Binding\n          \n          \n            \n                final LocationName locationName =\n          \n          \n            \n                    LocationName.of(testHelper.getOptions().getProjectId(), KMS_KEY_LOCATION);\n          \n          \n            \n                final Timestamp.Builder rotationTime = Timestamp.newBuilder().setSeconds(after7DaysInSeconds());\n          \n          \n            \n                final CryptoKey cryptoKeyInput =\n          \n          \n            \n                    CryptoKey.newBuilder()\n          \n          \n            \n                        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n          \n          \n            \n                        .setNextRotationTime(rotationTime)\n          \n          \n            \n                        .build();\n          \n          \n            \n                final CryptoKey cryptoKey =\n          \n          \n            \n                    kmsClient.createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n          \n          \n            \n                final Binding binding =\n          \n          \n            \n                    Binding.newBuilder()\n          \n          \n            \n                        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n          \n          \n            \n                        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n          \n          \n            \n                        .build();", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:20Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    for (CryptoKey key : keys) {\n+      for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+          .iterateAll()) {\n+        kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+      }\n+    }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA4Mg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221082", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    TimeUnit.MILLISECONDS\n          \n          \n            \n                );\n          \n          \n            \n              }\n          \n          \n            \n                    TimeUnit.MILLISECONDS);\n          \n          \n            \n                      KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID));", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:21Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    for (CryptoKey key : keys) {\n+      for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+          .iterateAll()) {\n+        kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+      }\n+    }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA4NA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221084", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n          \n          \n            \n                    .createDatabase(database, Collections.<String>emptyList());\n          \n          \n            \n                final OperationFuture<Database, CreateDatabaseMetadata> op =\n          \n          \n            \n                    dbAdminClient.createDatabase(database, Collections.<String>emptyList());", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:21Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    for (CryptoKey key : keys) {\n+      for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+          .iterateAll()) {\n+        kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+      }\n+    }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+\n+  private KeyRing createOrRetrieveKeyRing(final LocationName locationName) {\n+    try {\n+      return kmsClient.getKeyRing(\n+          KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID)\n+      );\n+    } catch (NotFoundException e) {\n+      return kmsClient.createKeyRing(locationName, KMS_KEY_RING_ID, KeyRing.getDefaultInstance());\n+    }\n+  }\n+\n+  private Database createDatabase(final Database database)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n+        .createDatabase(database, Collections.<String>emptyList());", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA4Ng==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221086", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient\n          \n          \n            \n                    .createBackup(backup);\n          \n          \n            \n                final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient.createBackup(backup);", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:21Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    for (CryptoKey key : keys) {\n+      for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+          .iterateAll()) {\n+        kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+      }\n+    }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+\n+  private KeyRing createOrRetrieveKeyRing(final LocationName locationName) {\n+    try {\n+      return kmsClient.getKeyRing(\n+          KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID)\n+      );\n+    } catch (NotFoundException e) {\n+      return kmsClient.createKeyRing(locationName, KMS_KEY_RING_ID, KeyRing.getDefaultInstance());\n+    }\n+  }\n+\n+  private Database createDatabase(final Database database)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n+        .createDatabase(database, Collections.<String>emptyList());\n+    final Database createdDatabase = op.get();\n+    dbs.add(createdDatabase.getId());\n+\n+    return createdDatabase;\n+  }\n+\n+  private Backup createBackup(final Backup backup) throws ExecutionException, InterruptedException {\n+    final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient\n+        .createBackup(backup);", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIyMTA4Nw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r529221087", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                final OperationFuture<Database, RestoreDatabaseMetadata> op = dbAdminClient\n          \n          \n            \n                    .restoreDatabase(restore);\n          \n          \n            \n                final Database database = op.get();\n          \n          \n            \n                final OperationFuture<Database, RestoreDatabaseMetadata> op =\n          \n          \n            \n                    dbAdminClient.restoreDatabase(restore);", "author": "yoshi-code-bot", "createdAt": "2020-11-24T05:59:21Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITCmek.java", "diffHunk": "@@ -0,0 +1,236 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.it;\n+\n+import static com.google.common.truth.Truth.assertThat;\n+\n+import com.google.api.gax.longrunning.OperationFuture;\n+import com.google.api.gax.rpc.NotFoundException;\n+import com.google.cloud.kms.v1.CryptoKey;\n+import com.google.cloud.kms.v1.CryptoKey.CryptoKeyPurpose;\n+import com.google.cloud.kms.v1.CryptoKeyVersion;\n+import com.google.cloud.kms.v1.KeyManagementServiceClient;\n+import com.google.cloud.kms.v1.KeyRing;\n+import com.google.cloud.kms.v1.KeyRingName;\n+import com.google.cloud.kms.v1.LocationName;\n+import com.google.cloud.spanner.Backup;\n+import com.google.cloud.spanner.BackupId;\n+import com.google.cloud.spanner.Database;\n+import com.google.cloud.spanner.DatabaseAdminClient;\n+import com.google.cloud.spanner.DatabaseId;\n+import com.google.cloud.spanner.EncryptionConfigInfo;\n+import com.google.cloud.spanner.InstanceId;\n+import com.google.cloud.spanner.IntegrationTestEnv;\n+import com.google.cloud.spanner.ParallelIntegrationTest;\n+import com.google.cloud.spanner.Restore;\n+import com.google.cloud.spanner.testing.RemoteSpannerHelper;\n+import com.google.iam.v1.Binding;\n+import com.google.iam.v1.Policy;\n+import com.google.protobuf.Timestamp;\n+import com.google.spanner.admin.database.v1.CreateBackupMetadata;\n+import com.google.spanner.admin.database.v1.CreateDatabaseMetadata;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseMetadata;\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Random;\n+import java.util.concurrent.ExecutionException;\n+import java.util.concurrent.TimeUnit;\n+import org.junit.AfterClass;\n+import org.junit.BeforeClass;\n+import org.junit.ClassRule;\n+import org.junit.Test;\n+import org.junit.experimental.categories.Category;\n+import org.junit.runner.RunWith;\n+import org.junit.runners.JUnit4;\n+\n+@Category(ParallelIntegrationTest.class)\n+@RunWith(JUnit4.class)\n+public class ITCmek {\n+\n+  private static final String BACKUP_ID_PREFIX = \"spanner-test-backup\";\n+  // FIXME: This should not be hardcoded\n+  private static final String KMS_KEY_LOCATION = \"eur5\";\n+  private static final String KMS_KEY_RING_ID = \"spanner-test-keyring\";\n+  private static final String KMS_KEY_ID_PREFIX = \"spanner-test-key\";\n+  private static final List<CryptoKey> keys = new ArrayList<>();\n+  private static final List<DatabaseId> dbs = new ArrayList<>();\n+  private static final List<BackupId> backups = new ArrayList<>();\n+  // FIXME: This should not be hardcoded\n+  public static final String SPANNER_PRODUCTION_ACCOUNT = \"serviceAccount:service-353504090643@gcp-sa-spanner.iam.gserviceaccount.com\";\n+  public static final String KMS_KEY_ENCRYPTER_DECRYPTER = \"roles/cloudkms.cryptoKeyEncrypterDecrypter\";\n+\n+  @ClassRule\n+  public static IntegrationTestEnv env = new IntegrationTestEnv();\n+  private static KeyManagementServiceClient kmsClient;\n+  private static DatabaseAdminClient dbAdminClient;\n+\n+  private static RemoteSpannerHelper testHelper;\n+  private static Random random;\n+\n+  @BeforeClass\n+  public static void beforeClass() throws IOException {\n+    testHelper = env.getTestHelper();\n+    dbAdminClient = testHelper.getClient().getDatabaseAdminClient();\n+    kmsClient = KeyManagementServiceClient.create();\n+    random = new Random();\n+  }\n+\n+  @AfterClass\n+  public static void afterClass() {\n+    for (CryptoKey key : keys) {\n+      for (CryptoKeyVersion keyVersion : kmsClient.listCryptoKeyVersions(key.getName())\n+          .iterateAll()) {\n+        kmsClient.destroyCryptoKeyVersion(keyVersion.getName());\n+      }\n+    }\n+    for (DatabaseId db : dbs) {\n+      dbAdminClient\n+          .dropDatabase(db.getInstanceId().getInstance(), db.getDatabase());\n+    }\n+    for (BackupId backup : backups) {\n+      dbAdminClient.deleteBackup(backup.getInstanceId().getInstance(), backup.getBackup());\n+    }\n+    kmsClient.close();\n+  }\n+\n+  @Test\n+  public void createsEncryptedDatabaseBackupAndRestore() throws ExecutionException, InterruptedException {\n+    final InstanceId instanceId = testHelper.getInstanceId();\n+    final String sourceDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String destinationDatabaseId = testHelper.getUniqueDatabaseId();\n+    final String backupId = randomBackupId();\n+\n+    final CryptoKey key = createKey(randomKeyId());\n+    final Database sourceDatabase = dbAdminClient\n+        .newDatabaseBuilder(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+    final Backup backup = dbAdminClient\n+        .newBackupBuilder(BackupId.of(\n+            testHelper.getInstanceId(),\n+            backupId\n+        ))\n+        .setDatabase(DatabaseId.of(instanceId, sourceDatabaseId))\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .setExpireTime(com.google.cloud.Timestamp.ofTimeSecondsAndNanos(after7DaysInSeconds(), 0))\n+        .build();\n+    final Restore restore = dbAdminClient\n+        .newRestoreBuilder(\n+            BackupId.of(testHelper.getInstanceId(), backupId),\n+            DatabaseId.of(testHelper.getInstanceId(), destinationDatabaseId)\n+        )\n+        .setEncryptionConfigInfo(EncryptionConfigInfo.ofKey(key.getName()))\n+        .build();\n+\n+    final Database createdDatabase = createDatabase(sourceDatabase);\n+    final Backup createdBackup = createBackup(backup);\n+    final Database restoredDatabase = restoreDatabase(restore);\n+\n+    assertThat(createdDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(createdDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+    assertThat(createdBackup.getEncryptionInfo().getKmsKeyVersion()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo()).isNotNull();\n+    assertThat(restoredDatabase.getEncryptionConfigInfo().getKmsKeyName()).isEqualTo(key.getName());\n+  }\n+\n+  private String randomKeyId() {\n+    return KMS_KEY_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private String randomBackupId() {\n+    return BACKUP_ID_PREFIX + random.nextInt();\n+  }\n+\n+  private CryptoKey createKey(final String keyId) {\n+    final LocationName locationName = LocationName.of(\n+        testHelper.getOptions().getProjectId(),\n+        KMS_KEY_LOCATION\n+    );\n+    final KeyRing keyRing = createOrRetrieveKeyRing(locationName);\n+    final Timestamp.Builder rotationTime = Timestamp\n+        .newBuilder()\n+        .setSeconds(after7DaysInSeconds());\n+\n+    final CryptoKey cryptoKeyInput = CryptoKey.newBuilder()\n+        .setPurpose(CryptoKeyPurpose.ENCRYPT_DECRYPT)\n+        .setNextRotationTime(rotationTime)\n+        .build();\n+    final CryptoKey cryptoKey = kmsClient\n+        .createCryptoKey(KeyRingName.parse(keyRing.getName()), keyId, cryptoKeyInput);\n+\n+    final Policy policy = kmsClient.getIamPolicy(cryptoKey.getName());\n+    final Binding binding = Binding\n+        .newBuilder()\n+        .addMembers(SPANNER_PRODUCTION_ACCOUNT)\n+        .setRole(KMS_KEY_ENCRYPTER_DECRYPTER)\n+        .build();\n+    final Policy newPolicy = policy.toBuilder().addBindings(binding).build();\n+    kmsClient.setIamPolicy(cryptoKey.getName(), newPolicy);\n+\n+    keys.add(cryptoKey);\n+    return cryptoKey;\n+  }\n+\n+  private long after7DaysInSeconds() {\n+    return TimeUnit.SECONDS.convert(\n+        System.currentTimeMillis() + TimeUnit.MILLISECONDS.convert(7L, TimeUnit.DAYS),\n+        TimeUnit.MILLISECONDS\n+    );\n+  }\n+\n+  private KeyRing createOrRetrieveKeyRing(final LocationName locationName) {\n+    try {\n+      return kmsClient.getKeyRing(\n+          KeyRingName.of(locationName.getProject(), locationName.getLocation(), KMS_KEY_RING_ID)\n+      );\n+    } catch (NotFoundException e) {\n+      return kmsClient.createKeyRing(locationName, KMS_KEY_RING_ID, KeyRing.getDefaultInstance());\n+    }\n+  }\n+\n+  private Database createDatabase(final Database database)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, CreateDatabaseMetadata> op = dbAdminClient\n+        .createDatabase(database, Collections.<String>emptyList());\n+    final Database createdDatabase = op.get();\n+    dbs.add(createdDatabase.getId());\n+\n+    return createdDatabase;\n+  }\n+\n+  private Backup createBackup(final Backup backup) throws ExecutionException, InterruptedException {\n+    final OperationFuture<Backup, CreateBackupMetadata> op = dbAdminClient\n+        .createBackup(backup);\n+    final Backup createdBackup = op.get();\n+    dbs.add(createdBackup.getDatabase());\n+    backups.add(backup.getId());\n+\n+    return createdBackup;\n+  }\n+\n+  private Database restoreDatabase(final Restore restore)\n+      throws ExecutionException, InterruptedException {\n+    final OperationFuture<Database, RestoreDatabaseMetadata> op = dbAdminClient\n+        .restoreDatabase(restore);\n+    final Database database = op.get();", "originalCommit": "9369fe36505d386d5a04f35a08e08644eb3e6425", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c4ff25ad30b3c590865dac8546445067f941ef89", "url": "https://github.com/googleapis/java-spanner/commit/c4ff25ad30b3c590865dac8546445067f941ef89", "message": "fix: ignores failing cmek tests\n\nIgnores the failing CMEK tests until the backend support is enabled in\nproduction.", "committedDate": "2020-11-24T07:17:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIyOTMwNg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r530229306", "bodyText": "Shouldn't we be using the wrapper classes here instead of the generated classes?", "author": "olavloite", "createdAt": "2020-11-25T09:34:58Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/BackupInfo.java", "diffHunk": "@@ -18,6 +18,8 @@\n \n import com.google.api.client.util.Preconditions;\n import com.google.cloud.Timestamp;\n+import com.google.spanner.admin.database.v1.EncryptionConfig;", "originalCommit": "c4ff25ad30b3c590865dac8546445067f941ef89", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDcyMzEzNg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r530723136", "bodyText": "Oh thanks for pointing that out, I fixed it and created a wrapper class for the EncryptionInfo as well.", "author": "thiagotnunes", "createdAt": "2020-11-26T01:30:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDIyOTMwNg=="}], "type": "inlineReview"}, {"oid": "e5867c560730702604729f609254a22a5d5b47ab", "url": "https://github.com/googleapis/java-spanner/commit/e5867c560730702604729f609254a22a5d5b47ab", "message": "fix: uses wrapper encryption info for backups", "committedDate": "2021-01-21T02:36:52Z", "type": "forcePushed"}, {"oid": "7c979bd80b421c116b3b93f054d64e7fab30db07", "url": "https://github.com/googleapis/java-spanner/commit/7c979bd80b421c116b3b93f054d64e7fab30db07", "message": "fix: uses wrapper encryption info for backups", "committedDate": "2021-01-21T02:53:00Z", "type": "forcePushed"}, {"oid": "1e05535225ce053727f9d6e2a16181c5e182ccb0", "url": "https://github.com/googleapis/java-spanner/commit/1e05535225ce053727f9d6e2a16181c5e182ccb0", "message": "fix: fixes clirr issues", "committedDate": "2021-01-25T00:17:28Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MjU3OA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r569472578", "bodyText": "not the key itself but only the version of the key?", "author": "elharo", "createdAt": "2021-02-03T14:46:11Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/BackupInfo.java", "diffHunk": "@@ -28,8 +28,22 @@\n \n     abstract Builder setSize(long size);\n \n+    /**\n+     * Output only.\n+     *\n+     * <p>The customer-manager encryption key version used to encrypt the backup.", "originalCommit": "8762a96f87aa3ff76f9e59cf850022c0904f0e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTc0MzE2OA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r571743168", "bodyText": "Updated the comment to the proto comment.", "author": "thiagotnunes", "createdAt": "2021-02-08T02:06:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MjU3OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3Mjc0Ng==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r569472746", "bodyText": "What does this mean?", "author": "elharo", "createdAt": "2021-02-03T14:46:24Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/BackupInfo.java", "diffHunk": "@@ -28,8 +28,22 @@\n \n     abstract Builder setSize(long size);\n \n+    /**\n+     * Output only.", "originalCommit": "8762a96f87aa3ff76f9e59cf850022c0904f0e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTc0MzE2MA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r571743160", "bodyText": "Updated the comment to the proto comment.", "author": "thiagotnunes", "createdAt": "2021-02-08T02:06:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3Mjc0Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MzExNQ==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r569473115", "bodyText": "delete \"to be\"\nit's --> its", "author": "elharo", "createdAt": "2021-02-03T14:46:50Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/BackupInfo.java", "diffHunk": "@@ -152,6 +186,24 @@ public long getSize() {\n     return size;\n   }\n \n+  /**\n+   * Returns the {@link EncryptionConfigInfo} to be used to encrypt the backup during it's creation.", "originalCommit": "8762a96f87aa3ff76f9e59cf850022c0904f0e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTc0MzIwMA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r571743200", "bodyText": "Done.", "author": "thiagotnunes", "createdAt": "2021-02-08T02:06:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MzExNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MzY3Mw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r569473673", "bodyText": "delete", "author": "elharo", "createdAt": "2021-02-03T14:47:34Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/BackupInfo.java", "diffHunk": "@@ -152,6 +186,24 @@ public long getSize() {\n     return size;\n   }\n \n+  /**\n+   * Returns the {@link EncryptionConfigInfo} to be used to encrypt the backup during it's creation.\n+   * Returns <code>null</code> if no customer-managed encryption key should be used.\n+   */\n+  public EncryptionConfigInfo getEncryptionConfigInfo() {\n+    return encryptionConfigInfo;\n+  }\n+\n+  /**\n+   * Returns the {@link EncryptionInfo} of the backup if the backup is encrypted, or <code>null\n+   * </code> if this backup is not encrypted.\n+   *\n+   * @return", "originalCommit": "8762a96f87aa3ff76f9e59cf850022c0904f0e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTc0MzIyNw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r571743227", "bodyText": "Done.", "author": "thiagotnunes", "createdAt": "2021-02-08T02:06:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3MzY3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3NDQ0NA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r569474444", "bodyText": "Instead of returning null is there a config info that indicates no encryption?", "author": "elharo", "createdAt": "2021-02-03T14:48:27Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/BackupInfo.java", "diffHunk": "@@ -152,6 +186,24 @@ public long getSize() {\n     return size;\n   }\n \n+  /**\n+   * Returns the {@link EncryptionConfigInfo} to be used to encrypt the backup during it's creation.\n+   * Returns <code>null</code> if no customer-managed encryption key should be used.\n+   */\n+  public EncryptionConfigInfo getEncryptionConfigInfo() {", "originalCommit": "8762a96f87aa3ff76f9e59cf850022c0904f0e48", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTc0MzY3Mg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r571743672", "bodyText": "Not at the moment.", "author": "thiagotnunes", "createdAt": "2021-02-08T02:08:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2OTQ3NDQ0NA=="}], "type": "inlineReview"}, {"oid": "00dbe8990fcd2dd8e43b70ef106fb6ee0de534bc", "url": "https://github.com/googleapis/java-spanner/commit/00dbe8990fcd2dd8e43b70ef106fb6ee0de534bc", "message": "Merge branch 'master' of github.com:googleapis/java-spanner into cmek", "committedDate": "2021-02-22T05:43:57Z", "type": "forcePushed"}, {"oid": "afec193c74f2794e4291355a5cd81ef042e23f62", "url": "https://github.com/googleapis/java-spanner/commit/afec193c74f2794e4291355a5cd81ef042e23f62", "message": "feat: add support for encrypted databases", "committedDate": "2021-03-10T03:00:28Z", "type": "commit"}, {"oid": "98a1143dc15d4b60c33a5210de33caad01915419", "url": "https://github.com/googleapis/java-spanner/commit/98a1143dc15d4b60c33a5210de33caad01915419", "message": "fix: fix deps and clirr failures", "committedDate": "2021-03-10T03:01:00Z", "type": "commit"}, {"oid": "ad03175414e4c04f2940c253ffdb6072086b1ccb", "url": "https://github.com/googleapis/java-spanner/commit/ad03175414e4c04f2940c253ffdb6072086b1ccb", "message": "tests: add additional tests for keys", "committedDate": "2021-03-10T03:01:02Z", "type": "commit"}, {"oid": "eff38fffab2584e6b1647e6bb8b007d3458b30c5", "url": "https://github.com/googleapis/java-spanner/commit/eff38fffab2584e6b1647e6bb8b007d3458b30c5", "message": "tests: remove IT and add unit", "committedDate": "2021-03-10T03:01:02Z", "type": "commit"}, {"oid": "84da677fc72997aca38dec8b669aa69c23f2a449", "url": "https://github.com/googleapis/java-spanner/commit/84da677fc72997aca38dec8b669aa69c23f2a449", "message": "fix: set null instead of default instance", "committedDate": "2021-03-10T03:01:02Z", "type": "commit"}, {"oid": "981e1a6c85750342bcfdf6f7ee888037df864d1b", "url": "https://github.com/googleapis/java-spanner/commit/981e1a6c85750342bcfdf6f7ee888037df864d1b", "message": "fix: does not set encryption info if null\n\nDoes not set encryption info in the request if it is null", "committedDate": "2021-03-10T03:01:02Z", "type": "commit"}, {"oid": "7101d04a3e1deab381c07fa235eb492130f0b827", "url": "https://github.com/googleapis/java-spanner/commit/7101d04a3e1deab381c07fa235eb492130f0b827", "message": "fix: fixes dependencies", "committedDate": "2021-03-10T03:01:02Z", "type": "commit"}, {"oid": "7e98e1febd2701ae2e538d120f17cff13b786f6e", "url": "https://github.com/googleapis/java-spanner/commit/7e98e1febd2701ae2e538d120f17cff13b786f6e", "message": "feature: adds support for encrypted backup\n\nAdds the possibility to set encryption config info in the creation of a\nbackup.", "committedDate": "2021-03-10T03:11:35Z", "type": "commit"}, {"oid": "13fe320eb40c0f9bee37ade0059fc861cc9a9e0c", "url": "https://github.com/googleapis/java-spanner/commit/13fe320eb40c0f9bee37ade0059fc861cc9a9e0c", "message": "feature: adds support for restoring encrypted dbs", "committedDate": "2021-03-10T03:11:36Z", "type": "commit"}, {"oid": "fc64e382706e38ef516d52817ed6350530015871", "url": "https://github.com/googleapis/java-spanner/commit/fc64e382706e38ef516d52817ed6350530015871", "message": "Revert \"tests: remove IT and add unit\"\n\nThis reverts commit cc19cf2efd32007ecd351c3b0c1b5942256c31ce.", "committedDate": "2021-03-10T03:11:36Z", "type": "commit"}, {"oid": "62284078087da32105bc8ed43845965ef18901e2", "url": "https://github.com/googleapis/java-spanner/commit/62284078087da32105bc8ed43845965ef18901e2", "message": "fix: makes the setEncryptionConfigInfo public\n\nThis is so a backup can be encrypted", "committedDate": "2021-03-10T03:11:36Z", "type": "commit"}, {"oid": "ca62bc271c5cb812ce44c9d41f008abfe79e0bc4", "url": "https://github.com/googleapis/java-spanner/commit/ca62bc271c5cb812ce44c9d41f008abfe79e0bc4", "message": "feature: adds tests for cmek\n\nAdds tests for creating encrypted database, creating encrypted backups\nand restoring encrypted databases.", "committedDate": "2021-03-10T03:11:36Z", "type": "commit"}, {"oid": "a4906c652ff14df2e84368b11c5f55baef6be250", "url": "https://github.com/googleapis/java-spanner/commit/a4906c652ff14df2e84368b11c5f55baef6be250", "message": "fix: removes keys after test finishes\n\nDestroy keys used in CMEK tests", "committedDate": "2021-03-10T03:11:36Z", "type": "commit"}, {"oid": "ec294ed1cd04ba9239c3b573a79dff493b46239d", "url": "https://github.com/googleapis/java-spanner/commit/ec294ed1cd04ba9239c3b573a79dff493b46239d", "message": "fix: fixes clirr errors", "committedDate": "2021-03-10T03:11:36Z", "type": "commit"}, {"oid": "b7d79455adbc2dfb3a7f1e41a43fb078a5f3b04e", "url": "https://github.com/googleapis/java-spanner/commit/b7d79455adbc2dfb3a7f1e41a43fb078a5f3b04e", "message": "fix: ignores failing cmek tests\n\nIgnores the failing CMEK tests until the backend support is enabled in\nproduction.", "committedDate": "2021-03-10T03:11:36Z", "type": "commit"}, {"oid": "428950b98f5fa062a578466dd1b5bf7689a05503", "url": "https://github.com/googleapis/java-spanner/commit/428950b98f5fa062a578466dd1b5bf7689a05503", "message": "fix: uses wrapper encryption info for backups", "committedDate": "2021-03-10T03:12:07Z", "type": "commit"}, {"oid": "44cbb331490e077d52305f7b1be1d3d8842e85ee", "url": "https://github.com/googleapis/java-spanner/commit/44cbb331490e077d52305f7b1be1d3d8842e85ee", "message": "fix: fixes clirr issues", "committedDate": "2021-03-10T03:12:09Z", "type": "commit"}, {"oid": "489dfeaca1161e7face181b325d4f51d53ccc49d", "url": "https://github.com/googleapis/java-spanner/commit/489dfeaca1161e7face181b325d4f51d53ccc49d", "message": "fix: re-orders clirr issues", "committedDate": "2021-03-10T03:12:09Z", "type": "commit"}, {"oid": "8f4e7d5ad9a483065f02647d666112e4d51a8f6d", "url": "https://github.com/googleapis/java-spanner/commit/8f4e7d5ad9a483065f02647d666112e4d51a8f6d", "message": "fix: addresses PR comments", "committedDate": "2021-03-10T03:12:09Z", "type": "commit"}, {"oid": "060ee646f298040957ba25111b71a6ece8549ea4", "url": "https://github.com/googleapis/java-spanner/commit/060ee646f298040957ba25111b71a6ece8549ea4", "message": "test: fixes database admin client tests", "committedDate": "2021-03-10T03:18:38Z", "type": "commit"}, {"oid": "060ee646f298040957ba25111b71a6ece8549ea4", "url": "https://github.com/googleapis/java-spanner/commit/060ee646f298040957ba25111b71a6ece8549ea4", "message": "test: fixes database admin client tests", "committedDate": "2021-03-10T03:18:38Z", "type": "forcePushed"}, {"oid": "da2d9a0ce29d2c1e1dce10cc1ddf2cd712fd579a", "url": "https://github.com/googleapis/java-spanner/commit/da2d9a0ce29d2c1e1dce10cc1ddf2cd712fd579a", "message": "chore: re-formats the code", "committedDate": "2021-03-11T00:36:33Z", "type": "commit"}, {"oid": "e3c651bb39115a8c85a165cb390e6aeec5f99b72", "url": "https://github.com/googleapis/java-spanner/commit/e3c651bb39115a8c85a165cb390e6aeec5f99b72", "message": "chore: fixes clirr checks", "committedDate": "2021-03-11T00:39:19Z", "type": "commit"}, {"oid": "6787996d62fd22c858559eb44adce82fc29e8dea", "url": "https://github.com/googleapis/java-spanner/commit/6787996d62fd22c858559eb44adce82fc29e8dea", "message": "tests: adds unit tests for domain classes\n\nAdds unit tests for EncryptionConfigInfo, EncryptionConfig, Backup and\nRestore.", "committedDate": "2021-03-11T10:42:29Z", "type": "commit"}, {"oid": "c3ebd34262189dadfa23f8006d2a94265c1da42c", "url": "https://github.com/googleapis/java-spanner/commit/c3ebd34262189dadfa23f8006d2a94265c1da42c", "message": "chore: renames EncryptionConfigInfo\n\nRenames EncryptionConfigInfo to EncryptionConfig in order to mirror what\nis the protobuf definition.", "committedDate": "2021-03-12T01:46:37Z", "type": "commit"}, {"oid": "7d234d91ecb579f2ecefadf1a1e9a9c846a8fc6a", "url": "https://github.com/googleapis/java-spanner/commit/7d234d91ecb579f2ecefadf1a1e9a9c846a8fc6a", "message": "tests: do not create a key on CMEK test\n\nInstead use an existing key and fails if the key is not present.", "committedDate": "2021-03-12T03:33:14Z", "type": "commit"}, {"oid": "3027533d748dd22b71ea3c0f388db8553fa1484f", "url": "https://github.com/googleapis/java-spanner/commit/3027533d748dd22b71ea3c0f388db8553fa1484f", "message": "feat: allows multiple encryption configs\n\nAllows customer managed encryption for create databases (google default\nencryption is just nullifying the value here).\nAllows customer managed encryption, google default encryption and\ndatabase encryption for create backups.\nAllows customer managed encryption, google default encryption and backup\nencryption for restore databases.", "committedDate": "2021-03-15T00:55:59Z", "type": "commit"}, {"oid": "f7229feeaf6cb2639627690f4c2b8d8739761ec1", "url": "https://github.com/googleapis/java-spanner/commit/f7229feeaf6cb2639627690f4c2b8d8739761ec1", "message": "docs: adds java doc to Restore class", "committedDate": "2021-03-15T01:06:22Z", "type": "commit"}, {"oid": "d182b8316bf78322f22dcc7d48d6955cecd844f7", "url": "https://github.com/googleapis/java-spanner/commit/d182b8316bf78322f22dcc7d48d6955cecd844f7", "message": "chore: refactors pom.xml\n\nUses variables to define project id and instance id for running\nintegration tests.", "committedDate": "2021-03-15T01:40:25Z", "type": "commit"}, {"oid": "fbf91d0894af3a12dbcf4d6fb41bf3b9205ad3c7", "url": "https://github.com/googleapis/java-spanner/commit/fbf91d0894af3a12dbcf4d6fb41bf3b9205ad3c7", "message": "test: fixes cmek integration test", "committedDate": "2021-03-15T01:41:02Z", "type": "commit"}, {"oid": "f9ef38220e331d1ad9fa54423806e566a29d02aa", "url": "https://github.com/googleapis/java-spanner/commit/f9ef38220e331d1ad9fa54423806e566a29d02aa", "message": "chore: fixes linting", "committedDate": "2021-03-15T02:58:44Z", "type": "commit"}, {"oid": "c865a0ad0c4e3c6a5d7c9b18227d240ffba335e5", "url": "https://github.com/googleapis/java-spanner/commit/c865a0ad0c4e3c6a5d7c9b18227d240ffba335e5", "message": "Revert \"chore: refactors pom.xml\"\n\nThis reverts commit d182b8316bf78322f22dcc7d48d6955cecd844f7.", "committedDate": "2021-03-15T02:59:34Z", "type": "commit"}, {"oid": "811ad2c8f87dd2948525014bf06b69c3dcfc5768", "url": "https://github.com/googleapis/java-spanner/commit/811ad2c8f87dd2948525014bf06b69c3dcfc5768", "message": "test: unifies cmek backup and restore tests", "committedDate": "2021-03-15T04:06:04Z", "type": "commit"}, {"oid": "4f9db7397787e57e43f6d0d006a04eecb145c6d9", "url": "https://github.com/googleapis/java-spanner/commit/4f9db7397787e57e43f6d0d006a04eecb145c6d9", "message": "Merge branch 'master' of github.com:googleapis/java-spanner into cmek", "committedDate": "2021-03-16T00:00:07Z", "type": "commit"}, {"oid": "d78baf32c654d61d767d2ed168d42d591add4f47", "url": "https://github.com/googleapis/java-spanner/commit/d78baf32c654d61d767d2ed168d42d591add4f47", "message": "chore: adds toString to encryption classes", "committedDate": "2021-03-16T06:00:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc4NTk2Ng==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595785966", "bodyText": "nit: This formatting seems strange", "author": "olavloite", "createdAt": "2021-03-17T08:00:33Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/BackupInfo.java", "diffHunk": "@@ -174,6 +217,23 @@ public long getSize() {\n     return size;\n   }\n \n+  /**\n+   * Returns the {@link BackupEncryptionConfig} to encrypt the backup during its creation. Returns\n+   * <code>\n+   * null</code> if no customer-managed encryption key should be used.", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg4Mzc5Mw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595883793", "bodyText": "Fixed.", "author": "thiagotnunes", "createdAt": "2021-03-17T10:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc4NTk2Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc4ODQ1Ng==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595788456", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * google's default encryption, is a customer managed encryption with a provided key. If no\n          \n          \n            \n                 * Google's default encryption, is a customer managed encryption with a provided key. If no", "author": "olavloite", "createdAt": "2021-03-17T08:05:08Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/DatabaseInfo.java", "diffHunk": "@@ -34,6 +35,15 @@\n \n     abstract Builder setEarliestVersionTime(Timestamp earliestVersionTime);\n \n+    /**\n+     * Optional for creating a new backup.\n+     *\n+     * <p>The encryption configuration to be used for the database. The only encryption, other than\n+     * google's default encryption, is a customer managed encryption with a provided key. If no", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc4ODcyMw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595788723", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * encryption is provided, google's default encryption will be used.\n          \n          \n            \n                 * encryption is provided, Google's default encryption will be used.", "author": "olavloite", "createdAt": "2021-03-17T08:05:31Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/DatabaseInfo.java", "diffHunk": "@@ -34,6 +35,15 @@\n \n     abstract Builder setEarliestVersionTime(Timestamp earliestVersionTime);\n \n+    /**\n+     * Optional for creating a new backup.\n+     *\n+     * <p>The encryption configuration to be used for the database. The only encryption, other than\n+     * google's default encryption, is a customer managed encryption with a provided key. If no\n+     * encryption is provided, google's default encryption will be used.", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc4OTM4Nw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595789387", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright 2020 Google LLC\n          \n          \n            \n             * Copyright 2021 Google LLC", "author": "olavloite", "createdAt": "2021-03-17T08:06:37Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/Restore.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright 2020 Google LLC", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc5MzM0NQ==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595793345", "bodyText": "I don't think we need this interface. It seems that it is only referenced by the other interfaces that extend this, but this specific marker interface is never used.", "author": "olavloite", "createdAt": "2021-03-17T08:13:07Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/encryption/EncryptionConfig.java", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2021 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner.encryption;\n+\n+import com.google.api.core.InternalApi;\n+\n+/**\n+ * Marker interface for encryption configurations that can be applied on databases, backups and\n+ * restores.\n+ */\n+@InternalApi\n+public interface EncryptionConfig {}", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg4MzkxNQ==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595883915", "bodyText": "Removed.", "author": "thiagotnunes", "createdAt": "2021-03-17T10:17:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc5MzM0NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc5NzQ5Mg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595797492", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Copyright 2020 Google LLC\n          \n          \n            \n             * Copyright 2021 Google LLC", "author": "olavloite", "createdAt": "2021-03-17T08:19:45Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/encryption/EncryptionInfo.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 Google LLC", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwMDIyNg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595800226", "bodyText": "I don't think it is guaranteed that backupInfo.getExpireTime() will always be set, so this could cause a NullPointerException.", "author": "olavloite", "createdAt": "2021-03-17T08:24:06Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -1145,15 +1152,31 @@ public Database call() throws Exception {\n \n   @Override\n   public OperationFuture<Backup, CreateBackupMetadata> createBackup(\n-      final String instanceName, final String backupId, final Backup backup)\n-      throws SpannerException {\n-    CreateBackupRequest request =\n+      final com.google.cloud.spanner.Backup backupInfo) throws SpannerException {\n+    final String instanceName = backupInfo.getInstanceId().getName();\n+    final String databaseName = backupInfo.getDatabase().getName();\n+    final String backupId = backupInfo.getId().getBackup();\n+    final Backup.Builder backupBuilder =\n+        com.google.spanner.admin.database.v1.Backup.newBuilder()\n+            .setDatabase(databaseName)\n+            .setExpireTime(backupInfo.getExpireTime().toProto());", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg5MzQzMg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595893432", "bodyText": "We shouldn't be able to create a backup without an expire time:\n\n  \n    \n      java-spanner/google-cloud-spanner/src/main/java/com/google/cloud/spanner/Backup.java\n    \n    \n        Lines 64 to 65\n      in\n      32fdd60\n    \n    \n    \n    \n\n        \n          \n           Preconditions.checkState( \n        \n\n        \n          \n               getExpireTime() != null, \"Cannot create a backup without an expire time\"); \n        \n    \n  \n\n\nI moved these checks into the database client instead (with illegal argument exception, instead of illegal state exceptions), so that we prevent the creation of a Backup without the necessary parameters.", "author": "thiagotnunes", "createdAt": "2021-03-17T10:31:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwMDIyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwMjk2Nw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595802967", "bodyText": "I think we should check for these conditions in the builder for BackupInfo to ensure that they are actually filled. So that would mean that the build() method of the builder should fail if these fields have not been set.", "author": "olavloite", "createdAt": "2021-03-17T08:27:56Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/SpannerRpc.java", "diffHunk": "@@ -216,26 +220,22 @@ public String getNextPageToken() {\n       throws SpannerException;\n \n   /**\n-   * Creates a new backup from the source database specified in the {@link Backup} instance.\n+   * Creates a new backup from the source database specified in the {@link\n+   * com.google.cloud.spanner.Backup} instance.\n    *\n-   * @param instanceName the name of the instance where the backup should be created.\n-   * @param backupId the id of the backup to create.\n-   * @param backup the backup to create. The database and expireTime fields of the backup must be\n-   *     filled.\n+   * @param backupInfo the backup to create. The instance, database and expireTime fields of the", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkwMzMyNA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595903324", "bodyText": "We can not do this in the builder itself, because there are times where the backup can be built without some of the necessary information. For instance:\n\nbackup.reload()\nbackup.delete()\nbackup.updateExpireTime()\n\nFor this reason I moved the checks into the DatabaseAdminClientImpl.createBackup instead.", "author": "thiagotnunes", "createdAt": "2021-03-17T10:46:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwMjk2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwNDk3NQ==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595804975", "bodyText": "nit: This line can be removed", "author": "olavloite", "createdAt": "2021-03-17T08:30:49Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/encryption/EncryptionConfigProtoMapperTest.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2021 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner.encryption;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import com.google.spanner.admin.database.v1.CreateBackupEncryptionConfig;\n+import com.google.spanner.admin.database.v1.EncryptionConfig;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseEncryptionConfig;\n+import org.junit.Test;\n+\n+/** Unit tests for {@link com.google.cloud.spanner.encryption.EncryptionConfigProtoMapper} */\n+public class EncryptionConfigProtoMapperTest {\n+\n+  public static final String KMS_KEY_NAME = \"kms-key-name\";\n+\n+  @Test\n+  public void testEncryptionConfig() {\n+    final EncryptionConfig expected =\n+        EncryptionConfig.newBuilder().setKmsKeyName(KMS_KEY_NAME).build();\n+\n+    final EncryptionConfig actual =\n+        EncryptionConfigProtoMapper.encryptionConfig(new CustomerManagedEncryption(KMS_KEY_NAME));\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testCreateBackupConfigCustomerManagedEncryption() {\n+    final CreateBackupEncryptionConfig expected =\n+        CreateBackupEncryptionConfig.newBuilder()\n+            .setEncryptionType(\n+                CreateBackupEncryptionConfig.EncryptionType.CUSTOMER_MANAGED_ENCRYPTION)\n+            .setKmsKeyName(KMS_KEY_NAME)\n+            .build();\n+\n+    final CreateBackupEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.createBackupEncryptionConfig(\n+            new CustomerManagedEncryption(KMS_KEY_NAME));\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testCreateBackupConfigGoogleDefaultEncryption() {\n+    final CreateBackupEncryptionConfig expected =\n+        CreateBackupEncryptionConfig.newBuilder()\n+            .setEncryptionType(\n+                CreateBackupEncryptionConfig.EncryptionType.GOOGLE_DEFAULT_ENCRYPTION)\n+            .build();\n+\n+    final CreateBackupEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.createBackupEncryptionConfig(GoogleDefaultEncryption.INSTANCE);\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testCreateBackupConfigUseDatabaseEncryption() {\n+    final CreateBackupEncryptionConfig expected =\n+        CreateBackupEncryptionConfig.newBuilder()\n+            .setEncryptionType(CreateBackupEncryptionConfig.EncryptionType.USE_DATABASE_ENCRYPTION)\n+            .build();\n+\n+    final CreateBackupEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.createBackupEncryptionConfig(UseDatabaseEncryption.INSTANCE);\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testCreateBackupInvalidEncryption() {\n+    EncryptionConfigProtoMapper.createBackupEncryptionConfig(null);\n+    fail(\"Create backup encryption config with invalid encryption should fail\");\n+  }\n+\n+  @Test\n+  public void testRestoreDatabaseConfigCustomerManagedEncryption() {\n+    final RestoreDatabaseEncryptionConfig expected =\n+        RestoreDatabaseEncryptionConfig.newBuilder()\n+            .setEncryptionType(\n+                RestoreDatabaseEncryptionConfig.EncryptionType.CUSTOMER_MANAGED_ENCRYPTION)\n+            .setKmsKeyName(KMS_KEY_NAME)\n+            .build();\n+\n+    final RestoreDatabaseEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.restoreDatabaseEncryptionConfig(\n+            new CustomerManagedEncryption(KMS_KEY_NAME));\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testRestoreDatabaseConfigGoogleDefaultEncryption() {\n+    final RestoreDatabaseEncryptionConfig expected =\n+        RestoreDatabaseEncryptionConfig.newBuilder()\n+            .setEncryptionType(\n+                RestoreDatabaseEncryptionConfig.EncryptionType.GOOGLE_DEFAULT_ENCRYPTION)\n+            .build();\n+\n+    final RestoreDatabaseEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.restoreDatabaseEncryptionConfig(\n+            GoogleDefaultEncryption.INSTANCE);\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testRestoreDatabaseConfigUseBackupEncryption() {\n+    final RestoreDatabaseEncryptionConfig expected =\n+        RestoreDatabaseEncryptionConfig.newBuilder()\n+            .setEncryptionType(\n+                RestoreDatabaseEncryptionConfig.EncryptionType\n+                    .USE_CONFIG_DEFAULT_OR_BACKUP_ENCRYPTION)\n+            .build();\n+\n+    final RestoreDatabaseEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.restoreDatabaseEncryptionConfig(UseBackupEncryption.INSTANCE);\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testRestoreDatabaseConfigInvalidEncryption() {\n+    EncryptionConfigProtoMapper.restoreDatabaseEncryptionConfig(null);\n+    fail(\"Restore database encryption config with invalid encryption should fail\");", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg5NTcxMA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595895710", "bodyText": "Removed.", "author": "thiagotnunes", "createdAt": "2021-03-17T10:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwNDk3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwNTEwNg==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595805106", "bodyText": "nit: This line can be removed", "author": "olavloite", "createdAt": "2021-03-17T08:31:02Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/encryption/EncryptionConfigProtoMapperTest.java", "diffHunk": "@@ -0,0 +1,142 @@\n+/*\n+ * Copyright 2021 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner.encryption;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.fail;\n+\n+import com.google.spanner.admin.database.v1.CreateBackupEncryptionConfig;\n+import com.google.spanner.admin.database.v1.EncryptionConfig;\n+import com.google.spanner.admin.database.v1.RestoreDatabaseEncryptionConfig;\n+import org.junit.Test;\n+\n+/** Unit tests for {@link com.google.cloud.spanner.encryption.EncryptionConfigProtoMapper} */\n+public class EncryptionConfigProtoMapperTest {\n+\n+  public static final String KMS_KEY_NAME = \"kms-key-name\";\n+\n+  @Test\n+  public void testEncryptionConfig() {\n+    final EncryptionConfig expected =\n+        EncryptionConfig.newBuilder().setKmsKeyName(KMS_KEY_NAME).build();\n+\n+    final EncryptionConfig actual =\n+        EncryptionConfigProtoMapper.encryptionConfig(new CustomerManagedEncryption(KMS_KEY_NAME));\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testCreateBackupConfigCustomerManagedEncryption() {\n+    final CreateBackupEncryptionConfig expected =\n+        CreateBackupEncryptionConfig.newBuilder()\n+            .setEncryptionType(\n+                CreateBackupEncryptionConfig.EncryptionType.CUSTOMER_MANAGED_ENCRYPTION)\n+            .setKmsKeyName(KMS_KEY_NAME)\n+            .build();\n+\n+    final CreateBackupEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.createBackupEncryptionConfig(\n+            new CustomerManagedEncryption(KMS_KEY_NAME));\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testCreateBackupConfigGoogleDefaultEncryption() {\n+    final CreateBackupEncryptionConfig expected =\n+        CreateBackupEncryptionConfig.newBuilder()\n+            .setEncryptionType(\n+                CreateBackupEncryptionConfig.EncryptionType.GOOGLE_DEFAULT_ENCRYPTION)\n+            .build();\n+\n+    final CreateBackupEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.createBackupEncryptionConfig(GoogleDefaultEncryption.INSTANCE);\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test\n+  public void testCreateBackupConfigUseDatabaseEncryption() {\n+    final CreateBackupEncryptionConfig expected =\n+        CreateBackupEncryptionConfig.newBuilder()\n+            .setEncryptionType(CreateBackupEncryptionConfig.EncryptionType.USE_DATABASE_ENCRYPTION)\n+            .build();\n+\n+    final CreateBackupEncryptionConfig actual =\n+        EncryptionConfigProtoMapper.createBackupEncryptionConfig(UseDatabaseEncryption.INSTANCE);\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testCreateBackupInvalidEncryption() {\n+    EncryptionConfigProtoMapper.createBackupEncryptionConfig(null);\n+    fail(\"Create backup encryption config with invalid encryption should fail\");", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg5NTc4Mw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595895783", "bodyText": "Removed.", "author": "thiagotnunes", "createdAt": "2021-03-17T10:35:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwNTEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwNTM5Nw==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595805397", "bodyText": "nit: This line can be removed", "author": "olavloite", "createdAt": "2021-03-17T08:31:27Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/encryption/EncryptionConfigsTest.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2021 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.google.cloud.spanner.encryption;\n+\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertSame;\n+import static org.junit.Assert.fail;\n+\n+import org.junit.Test;\n+\n+/** Unit tests for {@link EncryptionConfigs} */\n+public class EncryptionConfigsTest {\n+\n+  @Test\n+  public void testCustomerManagedEncryption() {\n+    final CustomerManagedEncryption expected = new CustomerManagedEncryption(\"kms-key-name\");\n+\n+    final CustomerManagedEncryption actual =\n+        EncryptionConfigs.customerManagedEncryption(\"kms-key-name\");\n+\n+    assertEquals(expected, actual);\n+  }\n+\n+  @Test(expected = IllegalArgumentException.class)\n+  public void testCustomerManagedEncryptionNullKeyName() {\n+    EncryptionConfigs.customerManagedEncryption(null);\n+    fail(\"Customer managed encryption with null key should fail\");", "originalCommit": "d78baf32c654d61d767d2ed168d42d591add4f47", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg5NTg3MA==", "url": "https://github.com/googleapis/java-spanner/pull/666#discussion_r595895870", "bodyText": "Removed.", "author": "thiagotnunes", "createdAt": "2021-03-17T10:35:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwNTM5Nw=="}], "type": "inlineReview"}, {"oid": "2493bcf01c6088a0e78a70f5a2e51dca823ada1c", "url": "https://github.com/googleapis/java-spanner/commit/2493bcf01c6088a0e78a70f5a2e51dca823ada1c", "message": "docs: updates DatabaseInfo javadoc\n\nCo-authored-by: Knut Olav L\u00f8ite <koloite@gmail.com>", "committedDate": "2021-03-17T10:24:27Z", "type": "commit"}, {"oid": "d3fe9ab44e2fb54dfc4dff21c6e14845739849cc", "url": "https://github.com/googleapis/java-spanner/commit/d3fe9ab44e2fb54dfc4dff21c6e14845739849cc", "message": "docs: updates Restore javadocs\n\nCo-authored-by: Knut Olav L\u00f8ite <koloite@gmail.com>", "committedDate": "2021-03-17T10:24:56Z", "type": "commit"}, {"oid": "3ff8a8902541a1f512ea392680219afcb336fdf3", "url": "https://github.com/googleapis/java-spanner/commit/3ff8a8902541a1f512ea392680219afcb336fdf3", "message": "docs: updates DatabaseInfo javadocs\n\nCo-authored-by: Knut Olav L\u00f8ite <koloite@gmail.com>", "committedDate": "2021-03-17T10:25:11Z", "type": "commit"}, {"oid": "acecbfe3bd029e76128701c67107f289b21ace19", "url": "https://github.com/googleapis/java-spanner/commit/acecbfe3bd029e76128701c67107f289b21ace19", "message": "fix: addresses PR comments", "committedDate": "2021-03-17T10:46:54Z", "type": "commit"}, {"oid": "acecbfe3bd029e76128701c67107f289b21ace19", "url": "https://github.com/googleapis/java-spanner/commit/acecbfe3bd029e76128701c67107f289b21ace19", "message": "fix: addresses PR comments", "committedDate": "2021-03-17T10:46:54Z", "type": "forcePushed"}, {"oid": "09fb850709680bdc1f9d6e40077fe73e089649a3", "url": "https://github.com/googleapis/java-spanner/commit/09fb850709680bdc1f9d6e40077fe73e089649a3", "message": "tests: reformats", "committedDate": "2021-03-17T23:24:44Z", "type": "commit"}]}