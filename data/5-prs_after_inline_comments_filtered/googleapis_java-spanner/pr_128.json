{"pr_number": 128, "pr_title": "feat: add num_sessions_in_pool metric", "pr_createdAt": "2020-03-25T23:44:44Z", "pr_url": "https://github.com/googleapis/java-spanner/pull/128", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMDMyMw==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r398300323", "bodyText": "I'm worried for anyone relying on this metric already in their monitoring? What is the process for deprecating metrics in OpenCensus? Is there some monitoring to figure out if someone is exporting it?", "author": "skuruppu", "createdAt": "2020-03-26T03:39:48Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -46,20 +55,20 @@\n   // The Metric name and description\n   static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_sessions\";\n   static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n-  static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";", "originalCommit": "4afe128245100fa8c77a92772b242a2da5653175", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkxMTcyNw==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r430911727", "bodyText": "What is the process for deprecating metrics in OpenCensus?\n\nIn OC, (usually) we first mark the existing API as deprecated and keep it for 18 months before removing it. I think the feature is fairly new and looks safe to remove it with a note in the Changelog.\n\nIs there some monitoring to figure out if someone is exporting it?\n\nI think it is feasible to see the ingested metrics in stackdriver, but I haven't done it personally.\n\nI'm worried for anyone relying on this metric already in their monitoring?\n\nAnother option is keep existing(IN_USE_SESSIONS) metric along with new metric. In this case, in_use_sessions data will be accounted/exported twice.\nWDYT?", "author": "mayurkale22", "createdAt": "2020-05-27T07:29:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMDMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5NTQyOQ==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r432395429", "bodyText": "Ok, I think you're right that this is relatively new. We will mark this in the Changelog.", "author": "skuruppu", "createdAt": "2020-05-29T10:26:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMDMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjM5NjMzOA==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r432396338", "bodyText": "If you can include something about this in the PR description, that would be great. Then we can copy it in when doing the release.", "author": "skuruppu", "createdAt": "2020-05-29T10:28:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMDMyMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjYzNjU4Nw==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r432636587", "bodyText": "done", "author": "mayurkale22", "createdAt": "2020-05-29T17:35:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODMwMDMyMw=="}], "type": "inlineReview"}, {"oid": "9df0fea2ca5e844752a3b2059e1ab4e927349043", "url": "https://github.com/googleapis/java-spanner/commit/9df0fea2ca5e844752a3b2059e1ab4e927349043", "message": "feat: add num_sessions_in_pool metric", "committedDate": "2020-03-26T22:50:57Z", "type": "forcePushed"}, {"oid": "48e8ec96deccd5658b70f4a92b279f5b02e98e50", "url": "https://github.com/googleapis/java-spanner/commit/48e8ec96deccd5658b70f4a92b279f5b02e98e50", "message": "feat: add num_sessions_in_pool metric", "committedDate": "2020-03-26T23:02:20Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2MTQ0OA==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r398961448", "bodyText": "write session is num_write_prepared_session while read doesn't have 'prepared' word in it. Is that deliberate?\nis consistency in naming important? If so then num_sessions_being_prepared should be renamed to num_being_prepared_session", "author": "rghetia", "createdAt": "2020-03-26T23:59:37Z", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -30,12 +30,21 @@\n       LabelKey.create(\"instance_id\", \"Name of the instance\");\n   private static final LabelKey LIBRARY_VERSION =\n       LabelKey.create(\"library_version\", \"Library version\");\n+  private static final LabelKey SESSION_TYPE = LabelKey.create(\"Type\", \"Type of the Sessions\");\n \n   /** The label value is used to represent missing value. */\n   private static final LabelValue UNSET_LABEL = LabelValue.create(null);\n \n+  static final LabelValue NUM_IN_USE_SESSIONS = LabelValue.create(\"num_in_use_sessions\");\n+  static final LabelValue NUM_SESSIONS_BEING_PREPARED =\n+      LabelValue.create(\"num_sessions_being_prepared\");\n+  static final LabelValue NUM_READ_SESSIONS = LabelValue.create(\"num_read_sessions\");\n+  static final LabelValue NUM_WRITE_SESSIONS = LabelValue.create(\"num_write_prepared_sessions\");", "originalCommit": "48e8ec96deccd5658b70f4a92b279f5b02e98e50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2NzgzMQ==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r398967831", "bodyText": "@skuruppu what do you suggest?", "author": "mayurkale22", "createdAt": "2020-03-27T00:21:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2MTQ0OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDA3MDQ4MA==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r400070480", "bodyText": "Regarding num_write_prepared_session vs read sessions not having the word prepared: That is intentional. Sessions themselves are not read-only or read/write, but a portion of the sessions in the pool is prepared with a read/write transaction for direct use. So if a user application wants to execute a read/write transaction, the pool returns a session that already has a prepared read/write transaction associated with it.", "author": "olavloite", "createdAt": "2020-03-30T10:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2MTQ0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2MjM1Ng==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r398962356", "bodyText": "No test for new Gauges?", "author": "rghetia", "createdAt": "2020-03-27T00:02:32Z", "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java", "diffHunk": "@@ -1638,7 +1637,6 @@ public Void call() {\n         .containsEntry(MetricRegistryConstants.NUM_ACQUIRED_SESSIONS, 3L);\n     assertThat(record.getMetrics())\n         .containsEntry(MetricRegistryConstants.NUM_RELEASED_SESSIONS, 3L);\n-    assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 0L);", "originalCommit": "48e8ec96deccd5658b70f4a92b279f5b02e98e50", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkwMzg2OA==", "url": "https://github.com/googleapis/java-spanner/pull/128#discussion_r430903868", "bodyText": "Added test to validate newly added Metric. I had to modify MetricRegistryTestUtils to support and test multiple timeseries entries. PTAL when you get a chance.", "author": "mayurkale22", "createdAt": "2020-05-27T07:14:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk2MjM1Ng=="}], "type": "inlineReview"}, {"oid": "c72e4d80af2eabbeaad678d82c8c039c427821ad", "url": "https://github.com/googleapis/java-spanner/commit/c72e4d80af2eabbeaad678d82c8c039c427821ad", "message": "feat: add num_sessions_in_pool metric", "committedDate": "2020-05-26T19:42:09Z", "type": "forcePushed"}, {"oid": "cf3981bbdf04db756eb8aa4e47505d44a456be19", "url": "https://github.com/googleapis/java-spanner/commit/cf3981bbdf04db756eb8aa4e47505d44a456be19", "message": "feat: add num_sessions_in_pool metric", "committedDate": "2020-06-04T07:20:18Z", "type": "commit"}, {"oid": "b5ac645b9268a0d66fa4dc9188bea6ccee6cdf2c", "url": "https://github.com/googleapis/java-spanner/commit/b5ac645b9268a0d66fa4dc9188bea6ccee6cdf2c", "message": "add tests", "committedDate": "2020-06-04T07:20:18Z", "type": "commit"}, {"oid": "b5ac645b9268a0d66fa4dc9188bea6ccee6cdf2c", "url": "https://github.com/googleapis/java-spanner/commit/b5ac645b9268a0d66fa4dc9188bea6ccee6cdf2c", "message": "add tests", "committedDate": "2020-06-04T07:20:18Z", "type": "forcePushed"}]}