{"pr_number": 497, "pr_title": "FLEX-5358: Send for every relay switch a notification", "pr_createdAt": "2020-11-10T09:11:55Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/497", "timeline": [{"oid": "ef5413124ed19304e4337ea78a133951409c1086", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/ef5413124ed19304e4337ea78a133951409c1086", "message": "FLEX-5358: Send for every relay switch a notification", "committedDate": "2020-11-10T09:08:52Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDQ0MjU2OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497#discussion_r520442568", "bodyText": "Default timestamp =\"now\", but cannot be parsed by OSGP. What is the correct timestamp format? (new Date() doesn't work) The former cucumber scenario also didn't add the timestamp to the notification.", "author": "joostknapen", "createdAt": "2020-11-10T10:11:12Z", "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/java/org/opensmartgridplatform/cucumber/platform/publiclighting/mocks/oslpdevice/MockOslpChannelHandler.java", "diffHunk": "@@ -262,6 +220,51 @@ public void channelRead0(final ChannelHandlerContext ctx, final OslpEnvelope mes\n         }\n     }\n \n+\n+    private void sendNotifications(final InetSocketAddress inetAddress, final OslpEnvelope message,\n+            final String deviceUid, final DeviceState deviceState) throws DeviceSimulatorException, IOException {\n+\n+        final MessageType messageType = this.getMessageType(message.getPayloadMessage());\n+\n+        if (MessageType.SET_LIGHT == messageType) {\n+            final List<Oslp.LightValue> lightValueList = message.getPayloadMessage()\n+                    .getSetLightRequest()\n+                    .getValuesList();\n+            for (final Oslp.LightValue lightValue : lightValueList) {\n+                final Oslp.Event event = lightValue.getOn() ? Oslp.Event.LIGHT_EVENTS_LIGHT_ON\n+                        : Oslp.Event.LIGHT_EVENTS_LIGHT_OFF;\n+                final OslpEnvelope notification = buildNotification(message, deviceUid, deviceState, event,\n+                        lightValue.getIndex());\n+                this.send(inetAddress, notification, deviceUid);\n+            }\n+        }\n+    }\n+\n+\n+    private OslpEnvelope buildNotification(final OslpEnvelope message, final String deviceUid,\n+            final DeviceState deviceState, final Oslp.Event event, final ByteString index) {\n+        this.devicesContext.getDeviceState(deviceUid).incrementSequenceNumber();\n+\n+        final Oslp.EventNotification.Builder eventNotificationBuilder = Oslp.EventNotification.newBuilder()\n+                .setEvent(event)\n+                .setDescription(event.name())\n+                //.setTimestamp(PlatformDefaults.TIMESTAMP)", "originalCommit": "ef5413124ed19304e4337ea78a133951409c1086", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cc15dc16f6815e6cc9bd0e088cf06baf46e91ab4", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/cc15dc16f6815e6cc9bd0e088cf06baf46e91ab4", "message": "Merge branch 'development' of github.com:OSGP/open-smart-grid-platform into FLEX-5358_Improve_OSLP_mock_server_-_send_event_on_relay_status_change", "committedDate": "2020-11-10T19:53:51Z", "type": "commit"}, {"oid": "4d452d2c29230fcfe419065b1a06b3ff29d8ae09", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4d452d2c29230fcfe419065b1a06b3ff29d8ae09", "message": "FLEX-5358 ~ Adds timestamp to event", "committedDate": "2020-11-10T19:55:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5ODA3Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497#discussion_r520598073", "bodyText": "Why not call the SequenceNumberUtils class directly here and for convertByteArrayToInteger a few lines later?", "author": "rlemmers", "createdAt": "2020-11-10T14:21:04Z", "path": "integration-tests/cucumber-tests-platform-publiclighting/src/test/java/org/opensmartgridplatform/cucumber/platform/publiclighting/mocks/oslpdevice/MockOslpChannelHandler.java", "diffHunk": "@@ -142,6 +78,23 @@ public MockOslpChannelHandler(final String oslpSignature, final String oslpSigna\n         this.receivedResponses = receivedResponses;\n     }\n \n+    private static byte[] convertIntegerToByteArray(final Integer value) {\n+        // See: platform.service.SequenceNumberUtils", "originalCommit": "ef5413124ed19304e4337ea78a133951409c1086", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzk2OTc2NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/497#discussion_r523969764", "bodyText": "We'll leave it in, to limit the coupling.", "author": "rlemmers", "createdAt": "2020-11-16T08:33:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDU5ODA3Mw=="}], "type": "inlineReview"}, {"oid": "9a13575dd332b69511441907ba5c2356b6f62658", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/9a13575dd332b69511441907ba5c2356b6f62658", "message": "Merge branch 'development' of github.com:OSGP/open-smart-grid-platform into FLEX-5358_Improve_OSLP_mock_server_-_send_event_on_relay_status_change", "committedDate": "2020-11-11T13:02:56Z", "type": "commit"}, {"oid": "4b23b0520704acd90cc3924b0251b46186b122d1", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/4b23b0520704acd90cc3924b0251b46186b122d1", "message": "FLEX-5358 ~ Handles events", "committedDate": "2020-11-15T22:30:07Z", "type": "commit"}, {"oid": "23ebabca2594e9a94f0d0d6a1b018490d4372ec2", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/23ebabca2594e9a94f0d0d6a1b018490d4372ec2", "message": "FLEX-5358: removed printStackTrace from catch", "committedDate": "2020-11-16T12:37:11Z", "type": "commit"}]}