{"pr_number": 526, "pr_title": "FLEX-5474 Add reboot behavior to the OSLP web device simulator", "pr_createdAt": "2020-11-27T18:44:13Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/526", "timeline": [{"oid": "69ef4863caf4e8ca4f9c0fe7a60d42b5a16f59eb", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/69ef4863caf4e8ca4f9c0fe7a60d42b5a16f59eb", "message": "FLEX-5474 ~ Adds reboot behavior to the OSLP web device simulator\n\nWhen the OSLP web device simulator simulates a reboot a configurable\ndelay in seconds is applied before the device registration messages are\nsent. During this delay the Netty channel for new requests will be\ndisconnected by the OlspChannelHandler.\n\nThe delay has a default value from configuration (reboot.delay.seconds)\nand can be changed from the devices page in the web-device-simulator.\n\nFixes a number of warnings in the DeviceManagementController.\nThe general RequestMapping with a method is replaces by GetMapping or\nPostMapping.\nSome checks are done in the API methods that return a response for a\nbad request in case there is something wrong with the provided data.\nSome of the methods that were altering state have been renamed from get\nto set.\nThe random for generating bytes is placed in a field instead of creating\na new one on each call in the method where it is used.\nAn incorrect logger statement with an exception is fixed.\n\nThe labels in the device list page have been placed in actual label\nelements for the controls they belong with (making clicking the check\nbox inputs simpler as one side effect).\n\nA call to fireChannelRead is removed from the OslpChannelHandler as it\nis the last handler in the pipeline. Passing the message on beyond the\nlast handler triggers some debug level warning messages from Netty.", "committedDate": "2020-11-27T18:42:57Z", "type": "commit"}, {"oid": "7c5fffda6d0a3486207ab3564d16ed6e827ebbb3", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/7c5fffda6d0a3486207ab3564d16ed6e827ebbb3", "message": "FLEX-5474 ~ Adds Spring integration tests for simulator reboot delay", "committedDate": "2020-11-30T11:44:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk3ODkxNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/526#discussion_r533978915", "bodyText": "I see what you are doing here, but on the other hand, this would  be an oppurtunity to get rid of the hard coded 7 second delay for the FIRMWARE_EVENTS_ACTIVATING event. I agree with you, that it's out of scope for this story, but maybe getting the 7 from a property file is not much work. I leave it up to you what to do with it. For me it's fine to leave it as is right now.", "author": "joostknapen", "createdAt": "2020-12-02T08:29:04Z", "path": "osgp/protocol-adapter-oslp/web-device-simulator/src/main/java/org/opensmartgridplatform/webdevicesimulator/service/OslpChannelHandler.java", "diffHunk": "@@ -871,13 +919,25 @@ private void handleUpdateFirmwareRequest(final Device device, final UpdateFirmwa\n         LOGGER.debug(\"handle UpdateFirmwareRequest for device: {}, with serialized size of {}\",\n                 device.getDeviceIdentification(), request.getSerializedSize());\n \n-        this.sendDelayedDeviceRegistration(device);\n-\n-        // Send a firmware activation event after the device registration has\n-        // (likely) been finished\n-        final Oslp.Event event = Oslp.Event.FIRMWARE_EVENTS_ACTIVATING;\n-        final String description = \"A new firmware is activated\";\n-        this.sendEventWithCustomDelay(device, event, description, 7000);\n+        this.simulateReboot(device).thenAccept(deviceMessageStatus -> {\n+            if (DeviceMessageStatus.NOT_FOUND == deviceMessageStatus) {\n+                LOGGER.error(\"Device {} not found handling update firmware request\", device.getDeviceIdentification());\n+                return;\n+            }\n+            final Oslp.Event event;\n+            final String description;\n+            if (DeviceMessageStatus.OK == deviceMessageStatus) {\n+                event = Oslp.Event.FIRMWARE_EVENTS_ACTIVATING;\n+                description = \"A new firmware is activated\";\n+            } else {\n+                LOGGER.warn(\"Device {} has issues registering after reboot handling update firmware request\",\n+                        device.getDeviceIdentification());\n+                event = Oslp.Event.FIRMWARE_EVENTS_DOWNLOAD_FAILED;\n+                description = \"Failure rebooting and registrating device during firmware activation\";\n+            }\n+            this.sendEventWithCustomDelay(device, event, description,\n+                    Math.max(1, 7 - this.deviceManagementService.getRebootDelay()));", "originalCommit": "7c5fffda6d0a3486207ab3564d16ed6e827ebbb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDA0MDEwMQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/526#discussion_r534040101", "bodyText": "In case the 7 sec should be configurable, it should be another user story.", "author": "joostknapen", "createdAt": "2020-12-02T10:01:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk3ODkxNQ=="}], "type": "inlineReview"}]}