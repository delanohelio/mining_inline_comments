{"pr_number": 320, "pr_title": "FLEX-5302: Adds the possibility to update the simulators process image", "pr_createdAt": "2020-05-12T13:36:16Z", "pr_url": "https://github.com/OSGP/open-smart-grid-platform/pull/320", "timeline": [{"oid": "a455bc43351d9b6a3526f56483e62dff9c946d6c", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/a455bc43351d9b6a3526f56483e62dff9c946d6c", "message": "FLEX-5302: Adds the possibility to update the simulators process image;\nan event is sent if that happens.", "committedDate": "2020-05-12T13:27:20Z", "type": "commit"}, {"oid": "043af5771e2d68454fe00a025845a6d080af930c", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/043af5771e2d68454fe00a025845a6d080af930c", "message": "FLEX-5302: Removes unnecessary line.", "committedDate": "2020-05-12T13:35:09Z", "type": "commit"}, {"oid": "96c92be3587c66016dcbe57792e7ba82d64768d3", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/96c92be3587c66016dcbe57792e7ba82d64768d3", "message": "FLEX-5302: Fixes cucumber errors.", "committedDate": "2020-05-14T08:26:56Z", "type": "commit"}, {"oid": "3727d03ac840403d768c9f9f4fb84a104f0c15a1", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3727d03ac840403d768c9f9f4fb84a104f0c15a1", "message": "FLEX-5302: Adds a test for updating the process image.", "committedDate": "2020-05-14T11:55:14Z", "type": "commit"}, {"oid": "3fd994924fece9cca547bc5937de64de26d09228", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/3fd994924fece9cca547bc5937de64de26d09228", "message": "FLEX-5302: Adds cucumber test updating the process image of a light\nmeasuerment device.", "committedDate": "2020-05-14T13:42:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUyNjM2Nw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426526367", "bodyText": "The name of an exception should end with \"Exception\", rename the class to InformationObjectTypeNotSupportedException", "author": "rlemmers", "createdAt": "2020-05-18T10:28:19Z", "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/exceptions/InformationObjectTypeNotSupported.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.iec60870.exceptions;\n+\n+public class InformationObjectTypeNotSupported extends RuntimeException {", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyNTgxOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426625819", "bodyText": "ok", "author": "robindenadel", "createdAt": "2020-05-18T13:28:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUyNjM2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUyOTc4OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426529789", "bodyText": "Is this a better choice than using plain \"1\" as a value? We currently don't manage the serial version.", "author": "rlemmers", "createdAt": "2020-05-18T10:34:57Z", "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/exceptions/InformationObjectTypeNotSupported.java", "diffHunk": "@@ -0,0 +1,22 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.iec60870.exceptions;\n+\n+public class InformationObjectTypeNotSupported extends RuntimeException {\n+\n+    private static final long serialVersionUID = -8763916774984177378L;", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyNjg4OA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426626888", "bodyText": "An even better choice is to upgrade sonar so it no longer complains about missing serialVersionUID.\nSince it complained i generated one in Eclipse.", "author": "robindenadel", "createdAt": "2020-05-18T13:30:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUyOTc4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA3OTk5NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r427079994", "bodyText": "removed serialVersionUID", "author": "robindenadel", "createdAt": "2020-05-19T07:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUyOTc4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzMzI2Mg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426533262", "bodyText": "It seems a concrete class instead of an abstract class.", "author": "rlemmers", "createdAt": "2020-05-18T10:41:44Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-adapter-iec60870/src/main/java/org/opensmartgridplatform/adapter/protocol/iec60870/domain/services/asduhandlers/SinglePointInformationWithTimeTagAsduHandler.java", "diffHunk": "@@ -0,0 +1,36 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.asduhandlers;\n+\n+import org.openmuc.j60870.ASdu;\n+import org.openmuc.j60870.ASduType;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.services.AbstractClientAsduHandler;\n+import org.opensmartgridplatform.adapter.protocol.iec60870.domain.valueobjects.ResponseMetadata;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.stereotype.Component;\n+\n+/**\n+ * Abstract class providing an implementation for handling single point", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyNzAzOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426627039", "bodyText": "changed it", "author": "robindenadel", "createdAt": "2020-05-18T13:30:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzMzI2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0MTYyMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426541622", "bodyText": "Using streams makes this more compact and perhaps easier to read:\nreturn map.entrySet()\n.stream()\n.map(entry -> new InformationObject(entry.getKey(), entry.getValue()))\n.toArray(InformationObject[]::new);", "author": "rlemmers", "createdAt": "2020-05-18T10:57:26Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-simulator-iec60870/src/main/java/org/opensmartgridplatform/simulator/protocol/iec60870/domain/Iec60870AsduFactory.java", "diffHunk": "@@ -40,4 +47,15 @@ default ASdu createActivationTerminationResponseAsdu() {\n                 .build();\n     }\n \n+    default InformationObject[] processImageToArray(final Map<Integer, InformationElement[][]> map) {\n+        final Integer[] keys = map.keySet().toArray(new Integer[map.size()]);", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMDk2OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426620969", "bodyText": "very good!", "author": "robindenadel", "createdAt": "2020-05-18T13:21:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0MTYyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0NzQyOA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426547428", "bodyText": "Are the new int[0] and new float[0] statements used by the real code or only by test code? These arrays of length 1 look strange in combination with the initialize() method, which uses a loop. Can we remove the loop or can it get a longer array as input as well?", "author": "rlemmers", "createdAt": "2020-05-18T11:09:13Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-simulator-iec60870/src/main/java/org/opensmartgridplatform/simulator/protocol/iec60870/domain/profile/DefaultControlledStationAsduFactory.java", "diffHunk": "@@ -29,31 +36,37 @@\n public class DefaultControlledStationAsduFactory implements Iec60870AsduFactory {\n \n     @Value(\"${general_interrogation_object_addresses}\")\n-    private int[] ioa;\n+    private final int[] ioa = new int[0];", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYyMjc5OQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426622799", "bodyText": "If 'general_interrogation_object_addresses' is present in the property file, the array is filled with the values in that file. Normally that is the case so we need the loop. For cucumber tests that is not the case.", "author": "robindenadel", "createdAt": "2020-05-18T13:24:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0NzQyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NDM2NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426584364", "bodyText": "Shouldn't we check the content of the full process image instead of just this single IO (to verify the update didn't affect other IOs)?", "author": "rlemmers", "createdAt": "2020-05-18T12:21:33Z", "path": "osgp/protocol-adapter-iec60870/osgp-protocol-simulator-iec60870/src/test/java/org/opensmartgridplatform/simulator/protocol/iec60870/server/Iec60870UpdateInformationObjectTest.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.simulator.protocol.iec60870.server;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.mockito.ArgumentMatchers.argThat;\n+import static org.mockito.Mockito.verify;\n+\n+import java.io.IOException;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.extension.ExtendWith;\n+import org.mockito.Mock;\n+import org.mockito.junit.jupiter.MockitoExtension;\n+import org.openmuc.j60870.ASduType;\n+import org.openmuc.j60870.CauseOfTransmission;\n+import org.openmuc.j60870.Connection;\n+import org.openmuc.j60870.ie.IeSinglePointWithQuality;\n+import org.openmuc.j60870.ie.InformationElement;\n+import org.opensmartgridplatform.iec60870.Iec60870Server;\n+import org.opensmartgridplatform.iec60870.Iec60870ServerEventListener;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.boot.test.context.SpringBootTest;\n+import org.springframework.test.context.ActiveProfiles;\n+\n+@SpringBootTest\n+@ExtendWith(MockitoExtension.class)\n+@ActiveProfiles(\"light_measurement_device\")\n+class Iec60870UpdateInformationObjectTest {\n+\n+    @Autowired\n+    private Iec60870Server iec60870Server;\n+\n+    @Mock\n+    private Connection connection;\n+\n+    private static boolean ON = true;\n+    private static final IeSinglePointWithQuality EXPECTED = new IeSinglePointWithQuality(ON, false, false, false,\n+            false);\n+\n+    /**\n+     * informationObjectAddress 42 is in\n+     * application-light_measurement_device.properties with value false, we will\n+     * test updating that address\n+     */\n+    @Test\n+    void testUpdateExistingInformationObject() {\n+\n+        final int informationObjectAddress = 42;\n+\n+        this.iec60870Server.updateInformationObject(informationObjectAddress, \"IeSinglePointWithQuality\", ON);\n+\n+        final InformationElement[][] actual = this.iec60870Server.getProcessImage().get(informationObjectAddress);\n+        assertThat(actual[0][0]).usingRecursiveComparison().isEqualTo(EXPECTED);\n+    }\n+\n+    /**\n+     * informationObjectAddress 2 is not in\n+     * application-light_measurement_device.properties, we will test updating\n+     * that address\n+     */\n+    @Test\n+    void testAddInformationObject() {\n+\n+        final int informationObjectAddress = 2;\n+\n+        this.iec60870Server.updateInformationObject(informationObjectAddress, \"IeSinglePointWithQuality\", ON);\n+\n+        final InformationElement[][] actual = this.iec60870Server.getProcessImage().get(informationObjectAddress);", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwODQxMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r427108412", "bodyText": "done", "author": "robindenadel", "createdAt": "2020-05-19T08:07:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU4NDM2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NDcxNw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426594717", "bodyText": "Shouldn't we derive this from the informationObjectType?", "author": "rlemmers", "createdAt": "2020-05-18T12:39:53Z", "path": "integration-tests/cucumber-tests-platform-distributionautomation/src/test/java/org/opensmartgridplatform/cucumber/platform/distributionautomation/glue/steps/ProcessImageSteps.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.cucumber.platform.distributionautomation.glue.steps;\n+\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_ELEMENT_VALUE;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_OBJECT_ADDRESS;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_OBJECT_TYPE;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.PROFILE;\n+\n+import java.util.Map;\n+\n+import org.opensmartgridplatform.cucumber.core.ScenarioContext;\n+import org.opensmartgridplatform.cucumber.platform.distributionautomation.mocks.iec60870.Iec60870MockServer;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.java.en.When;\n+\n+public class ProcessImageSteps {\n+\n+    @Autowired\n+    private Iec60870MockServer mockServer;\n+\n+    @When(\"I update the information object\")\n+    public void iUpdateTheInformationObject(final Map<String, String> parameters) {\n+        final Integer informationObjectAddress = Integer.valueOf(parameters.get(INFORMATION_OBJECT_ADDRESS));\n+        final String informationObjectType = parameters.get(INFORMATION_OBJECT_TYPE);\n+        this.mockServer.getRtuSimulator()\n+                .updateInformationObject(informationObjectAddress, informationObjectType,\n+                        this.informationElementvalue(parameters.get(INFORMATION_ELEMENT_VALUE)));\n+    }\n+\n+    private Object informationElementvalue(final String value) {\n+        final String profile = (String) ScenarioContext.current().get(PROFILE);\n+        if (\"light_measurement_device\".equals(profile)) {\n+            return Boolean.valueOf(value);\n+        }\n+        return Float.valueOf(value);", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYzMzIxOQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426633219", "bodyText": "there is no informationObjectType in this step", "author": "robindenadel", "createdAt": "2020-05-18T13:39:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NDcxNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NTQ1Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426595453", "bodyText": "Change to \"^I update the information object$\".", "author": "rlemmers", "createdAt": "2020-05-18T12:41:02Z", "path": "integration-tests/cucumber-tests-platform-distributionautomation/src/test/java/org/opensmartgridplatform/cucumber/platform/distributionautomation/glue/steps/ProcessImageSteps.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.cucumber.platform.distributionautomation.glue.steps;\n+\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_ELEMENT_VALUE;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_OBJECT_ADDRESS;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_OBJECT_TYPE;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.PROFILE;\n+\n+import java.util.Map;\n+\n+import org.opensmartgridplatform.cucumber.core.ScenarioContext;\n+import org.opensmartgridplatform.cucumber.platform.distributionautomation.mocks.iec60870.Iec60870MockServer;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.java.en.When;\n+\n+public class ProcessImageSteps {\n+\n+    @Autowired\n+    private Iec60870MockServer mockServer;\n+\n+    @When(\"I update the information object\")", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYzMzc1Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426633756", "bodyText": "ok", "author": "robindenadel", "createdAt": "2020-05-18T13:40:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU5NTQ1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwMzUxNQ==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426603515", "bodyText": "Should we also send the event, when the new value is the same as the old value?", "author": "rlemmers", "createdAt": "2020-05-18T12:53:54Z", "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/Iec60870Server.java", "diffHunk": "@@ -53,4 +60,38 @@ public Iec60870ServerEventListener getIec60870ServerEventListener() {\n     public boolean isListening() {\n         return this.listening;\n     }\n+\n+    public Map<Integer, InformationElement[][]> getProcessImage() {\n+        return this.processImage;\n+    }\n+\n+    public void setProcessImage(final Map<Integer, InformationElement[][]> processImage) {\n+        this.processImage = processImage;\n+    }\n+\n+    /**\n+     * If the informationObjectAddress is already in the process image, the\n+     * value is updated. Otherwise a new item is added to the process image.\n+     * \n+     * An event ASDU is sent to the controlling station.", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYzNTA1Mw==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426635053", "bodyText": "good question", "author": "robindenadel", "createdAt": "2020-05-18T13:42:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwMzUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzEwODUzNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r427108534", "bodyText": "done so", "author": "robindenadel", "createdAt": "2020-05-19T08:07:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwMzUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwNTk0NA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426605944", "bodyText": "No further actions required, like closing the connection?", "author": "rlemmers", "createdAt": "2020-05-18T12:57:46Z", "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/Iec60870ServerEventListener.java", "diffHunk": "@@ -84,6 +85,24 @@ private void sendEndOfInitializationOnFirstConnection(final Connection connectio\n         }\n     }\n \n+    public void sendInformationUpdateEvent(final int informationObjectAddress,\n+            final InformationElement[][] informationElements) {\n+\n+        final ASdu event = new ASdu(ASduType.M_SP_TB_1, false, CauseOfTransmission.SPONTANEOUS, false, false, 0, 0,\n+                new InformationObject(informationObjectAddress, informationElements));\n+\n+        this.iec60870ConnectionRegistry.getAllConnections().forEach(connection -> this.sendEvent(connection, event));\n+    }\n+\n+    private void sendEvent(final Connection connection, final ASdu event) {\n+        try {\n+            LOGGER.info(\"Sending event {}\", event);\n+            connection.send(event);\n+        } catch (final IOException e) {\n+            LOGGER.error(\"Sending event {} failed\", event, e);", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYzNTcwNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426635704", "bodyText": "I would prefer the connection to stay open", "author": "robindenadel", "createdAt": "2020-05-18T13:43:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwNTk0NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwNzcwMg==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426607702", "bodyText": "We use the informationObjectType as a String in many places. Shouldn't we change this to an enum?", "author": "rlemmers", "createdAt": "2020-05-18T13:00:31Z", "path": "integration-tests/cucumber-tests-platform-distributionautomation/src/test/java/org/opensmartgridplatform/cucumber/platform/distributionautomation/glue/steps/ProcessImageSteps.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/**\n+ * Copyright 2020 Smart Society Services B.V.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\"); you may not use this file except in compliance with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ */\n+package org.opensmartgridplatform.cucumber.platform.distributionautomation.glue.steps;\n+\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_ELEMENT_VALUE;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_OBJECT_ADDRESS;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.INFORMATION_OBJECT_TYPE;\n+import static org.opensmartgridplatform.cucumber.platform.distributionautomation.PlatformDistributionAutomationKeys.PROFILE;\n+\n+import java.util.Map;\n+\n+import org.opensmartgridplatform.cucumber.core.ScenarioContext;\n+import org.opensmartgridplatform.cucumber.platform.distributionautomation.mocks.iec60870.Iec60870MockServer;\n+import org.springframework.beans.factory.annotation.Autowired;\n+\n+import io.cucumber.java.en.When;\n+\n+public class ProcessImageSteps {\n+\n+    @Autowired\n+    private Iec60870MockServer mockServer;\n+\n+    @When(\"I update the information object\")\n+    public void iUpdateTheInformationObject(final Map<String, String> parameters) {\n+        final Integer informationObjectAddress = Integer.valueOf(parameters.get(INFORMATION_OBJECT_ADDRESS));\n+        final String informationObjectType = parameters.get(INFORMATION_OBJECT_TYPE);", "originalCommit": "3fd994924fece9cca547bc5937de64de26d09228", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NTc0MA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r426665740", "bodyText": "ok", "author": "robindenadel", "createdAt": "2020-05-18T14:25:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjYwNzcwMg=="}], "type": "inlineReview"}, {"oid": "913454becef80e82b18d838c6e6a82dbec51cda9", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/913454becef80e82b18d838c6e6a82dbec51cda9", "message": "FLEX-5302: Addresses review comments.", "committedDate": "2020-05-19T08:15:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzM4MjEyNA==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r427382124", "bodyText": "On line 138 or right after, convert the String to an Iec60870InformationObjectType item. It makes the comparisons cleaner and when a typo is made in the expectedValue, the test will end right away with a RuntimeException.", "author": "rlemmers", "createdAt": "2020-05-19T15:12:52Z", "path": "integration-tests/cucumber-tests-platform-distributionautomation/src/test/java/org/opensmartgridplatform/cucumber/platform/distributionautomation/glue/steps/ReceiveMeasurementReportSteps.java", "diffHunk": "@@ -130,11 +143,11 @@ private void checkInformationElementValue(final Map<String, String> reportValues\n                 .getMeasurementElements()\n                 .getMeasurementElementList()\n                 .get(0);\n-        if (\"IeShortFloat\".equals(expectedType)) {\n+        if (Iec60870InformationObjectType.SHORT_FLOAT.getDescription().equals(expectedType)) {", "originalCommit": "913454becef80e82b18d838c6e6a82dbec51cda9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzgwODQ1Ng==", "url": "https://github.com/OSGP/open-smart-grid-platform/pull/320#discussion_r427808456", "bodyText": "Either:\na) remove the initial \"false\" assignment or\nb) initially assign \"true\" and remove the else branch.", "author": "rlemmers", "createdAt": "2020-05-20T07:50:10Z", "path": "osgp/protocol-adapter-iec60870/osgp-iec60870/src/main/java/org/opensmartgridplatform/iec60870/Iec60870Server.java", "diffHunk": "@@ -73,25 +73,52 @@ public void setProcessImage(final Map<Integer, InformationElement[][]> processIm\n      * If the informationObjectAddress is already in the process image, the\n      * value is updated. Otherwise a new item is added to the process image.\n      * \n-     * An event ASDU is sent to the controlling station.\n+     * An event ASDU is sent to the controlling station if the value has\n+     * changed.\n      * \n      * @param informationObjectAddress\n      *            the address of the item in the process image\n      * @param informationObjectType\n-     *            the type of information object; if not supported, a\n-     *            InformationObjectTypeNotSupported is thrown\n+     *            the type of information object\n      * @param value\n      *            the information element value\n      */\n-    public void updateInformationObject(final int informationObjectAddress, final String informationObjectType,\n-            final Object value) {\n+    public void updateInformationObject(final int informationObjectAddress,\n+            final Iec60870InformationObjectType informationObjectType, final Object value) {\n \n         final InformationElement[][] informationElements = this.informationElementFactory\n                 .createInformationElements(informationObjectType, value);\n \n+        boolean valueChanged = false;\n+        if (this.processImage.containsKey(informationObjectAddress)) {\n+            valueChanged = this.hasChanged(informationElements, this.processImage.get(informationObjectAddress));\n+        } else {\n+            valueChanged = true;\n+        }", "originalCommit": "913454becef80e82b18d838c6e6a82dbec51cda9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29417f4da47d42e54d9cc36b2765afc9d33c06a7", "url": "https://github.com/OSGP/open-smart-grid-platform/commit/29417f4da47d42e54d9cc36b2765afc9d33c06a7", "message": "FLEX-5302 ~ Processes review comments.", "committedDate": "2020-05-20T10:52:06Z", "type": "commit"}]}