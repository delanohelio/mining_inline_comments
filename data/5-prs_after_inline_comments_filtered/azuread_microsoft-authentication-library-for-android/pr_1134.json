{"pr_number": 1134, "pr_title": "Resurrect b2c ui tests", "pr_createdAt": "2020-08-20T19:51:38Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1134", "timeline": [{"oid": "359a5d7aca8610484a1eb1a0cd216308c4688877", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/359a5d7aca8610484a1eb1a0cd216308c4688877", "message": "Resurrect b2c ui tests", "committedDate": "2020-08-20T19:50:09Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0MTcwMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1134#discussion_r474241700", "bodyText": "\ud83d\ude1e", "author": "iambmelt", "createdAt": "2020-08-20T20:03:56Z", "path": "msalautomationapp/src/androidTest/java/com/microsoft/identity/client/msal/automationapp/AbstractMsalUiTest.java", "diffHunk": "@@ -85,35 +86,46 @@\n     public final TestRule resetAutomaticTimeRule = new ResetAutomaticTimeZoneTestRule();\n \n     @Rule(order = 3)\n-    public final TestRule loadLabUserRule = getLabUserQuery() != null\n-            ? new LoadLabUserTestRule(getLabUserQuery())\n-            : new LoadLabUserTestRule(getTempUserType());\n-\n-    @Rule(order = 4)\n     public final TestRule removeBrokersRule = new RemoveBrokersBeforeTestRule();\n \n-    @Rule(order = 5)\n+    @Rule(order = 4)\n     public ActivityTestRule<MainActivity> mActivityRule =\n             new ActivityTestRule(MainActivity.class);\n \n-    @Rule(order = 6)\n+    @Rule(order = 5)\n     public TestRule deviceEnrollmentFailureRecoveryRule = new DeviceEnrollmentFailureRecoveryRule();\n \n     @Before\n     public void setup() {\n+        loadLabUser();\n         mScopes = getScopes();\n         mBrowser = getBrowser();\n \n         // clear all cookies in the browser\n         mBrowser.clear();\n \n-        mLoginHint = ((LoadLabUserTestRule) loadLabUserRule).getLabUserUpn();\n-\n         mContext = ApplicationProvider.getApplicationContext();\n         mActivity = mActivityRule.getActivity();\n         setupPCA();\n     }\n \n+    private void loadLabUser() {\n+        if (getLabUserQuery() != null) {\n+            mLoginHint = LabUserHelper.loadUserForTest(getLabUserQuery());\n+        } else if (getTempUserType() != null) {\n+            mLoginHint = LabUserHelper.loadTempUser(getTempUserType());\n+            try {\n+                // temp user takes some time to actually being created even though it may be\n+                // returned by the LAB API. Adding a wait here before we proceed with the test.", "originalCommit": "359a5d7aca8610484a1eb1a0cd216308c4688877", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0MTk5OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1134#discussion_r474241999", "bodyText": "Should we bake this into loadTempUser?", "author": "AdamBJohnsonx", "createdAt": "2020-08-20T20:04:36Z", "path": "msalautomationapp/src/androidTest/java/com/microsoft/identity/client/msal/automationapp/AbstractMsalUiTest.java", "diffHunk": "@@ -85,35 +86,46 @@\n     public final TestRule resetAutomaticTimeRule = new ResetAutomaticTimeZoneTestRule();\n \n     @Rule(order = 3)\n-    public final TestRule loadLabUserRule = getLabUserQuery() != null\n-            ? new LoadLabUserTestRule(getLabUserQuery())\n-            : new LoadLabUserTestRule(getTempUserType());\n-\n-    @Rule(order = 4)\n     public final TestRule removeBrokersRule = new RemoveBrokersBeforeTestRule();\n \n-    @Rule(order = 5)\n+    @Rule(order = 4)\n     public ActivityTestRule<MainActivity> mActivityRule =\n             new ActivityTestRule(MainActivity.class);\n \n-    @Rule(order = 6)\n+    @Rule(order = 5)\n     public TestRule deviceEnrollmentFailureRecoveryRule = new DeviceEnrollmentFailureRecoveryRule();\n \n     @Before\n     public void setup() {\n+        loadLabUser();\n         mScopes = getScopes();\n         mBrowser = getBrowser();\n \n         // clear all cookies in the browser\n         mBrowser.clear();\n \n-        mLoginHint = ((LoadLabUserTestRule) loadLabUserRule).getLabUserUpn();\n-\n         mContext = ApplicationProvider.getApplicationContext();\n         mActivity = mActivityRule.getActivity();\n         setupPCA();\n     }\n \n+    private void loadLabUser() {\n+        if (getLabUserQuery() != null) {\n+            mLoginHint = LabUserHelper.loadUserForTest(getLabUserQuery());\n+        } else if (getTempUserType() != null) {\n+            mLoginHint = LabUserHelper.loadTempUser(getTempUserType());\n+            try {\n+                // temp user takes some time to actually being created even though it may be\n+                // returned by the LAB API. Adding a wait here before we proceed with the test.\n+                Thread.sleep(TEMP_USER_WAIT_TIME);", "originalCommit": "359a5d7aca8610484a1eb1a0cd216308c4688877", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjU3ODQ2Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1134#discussion_r482578467", "bodyText": "I'm inclined not to do that for now, and instead let the caller decide if they want to sleep or not. Because let's say if someone called it but wasn't going to use the temp account right away and instead used it some time later (depending on how they have their test), they may not want/need the sleep.", "author": "shahzaibj", "createdAt": "2020-09-02T22:59:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDI0MTk5OQ=="}], "type": "inlineReview"}, {"oid": "11896216a6a3644cd02534ccc11b99a97890c962", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/11896216a6a3644cd02534ccc11b99a97890c962", "message": "Merge branch 'dev' into shahzaibj/fix-b2c-ui-test", "committedDate": "2020-09-02T23:44:56Z", "type": "commit"}, {"oid": "8233772a9c0fb0b5a3b28983f8eb4930d34c5751", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/8233772a9c0fb0b5a3b28983f8eb4930d34c5751", "message": "Resolve merge conflict", "committedDate": "2020-09-02T23:46:53Z", "type": "commit"}, {"oid": "4d35cc7600d3a0eb37f4a78cad0ba682f7aaf505", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/4d35cc7600d3a0eb37f4a78cad0ba682f7aaf505", "message": "Update submodule", "committedDate": "2020-09-02T23:47:17Z", "type": "commit"}]}