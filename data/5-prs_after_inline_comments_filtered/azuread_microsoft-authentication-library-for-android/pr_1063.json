{"pr_number": 1063, "pr_title": "Add correlation id to Token Parameters and Authentication Result", "pr_createdAt": "2020-06-09T18:03:25Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063", "timeline": [{"oid": "1fd230893fcb2a5c5a4299c898ab1caee90852df", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/1fd230893fcb2a5c5a4299c898ab1caee90852df", "message": "Add correlation id to Authentication Result", "committedDate": "2020-06-09T18:00:19Z", "type": "commit"}, {"oid": "da367d6713071557559219b570dd96cfd0eb6d9e", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/da367d6713071557559219b570dd96cfd0eb6d9e", "message": "Update submodule", "committedDate": "2020-06-09T18:01:23Z", "type": "commit"}, {"oid": "23cdbc28feda6f781e8a46f55424a81578a837bb", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/23cdbc28feda6f781e8a46f55424a81578a837bb", "message": "Add new line at end of IAuthenticationResult.java", "committedDate": "2020-06-09T18:26:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc3OTYzNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r437779637", "bodyText": "Javadoc public methods.", "author": "AdamBJohnsonx", "createdAt": "2020-06-09T23:36:19Z", "path": "msal/src/main/java/com/microsoft/identity/client/TokenParameters.java", "diffHunk": "@@ -137,6 +140,10 @@ public AccountRecord getAccountRecord() {\n         return mAccountRecord;\n     }\n \n+    public String getCorrelationId() {", "originalCommit": "23cdbc28feda6f781e8a46f55424a81578a837bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1ODUzMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439158532", "bodyText": "Addressed here: 6a71d1d", "author": "shahzaibj", "createdAt": "2020-06-12T01:23:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc3OTYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc3OTkwOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r437779909", "bodyText": "Is it possible that these could be final?", "author": "AdamBJohnsonx", "createdAt": "2020-06-09T23:37:19Z", "path": "msal/src/main/java/com/microsoft/identity/client/TokenParameters.java", "diffHunk": "@@ -42,13 +43,15 @@\n     private ClaimsRequest mClaimsRequest;\n     private AccountRecord mAccountRecord;\n     private AuthenticationScheme mAuthenticationScheme;\n+    private String mCorrelationId;", "originalCommit": "23cdbc28feda6f781e8a46f55424a81578a837bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODk3MjQ2OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438972468", "bodyText": "Nope, these have setters and can get modified after initialization: https://github.com/AzureAD/microsoft-authentication-library-for-android/blob/dev/msal/src/main/java/com/microsoft/identity/client/TokenParameters.java#L80-L134", "author": "shahzaibj", "createdAt": "2020-06-11T17:58:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc3OTkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MDYwOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r437780608", "bodyText": "nit: missing id", "author": "shahzaibj", "createdAt": "2020-06-09T23:39:31Z", "path": "msal/src/main/java/com/microsoft/identity/client/AuthenticationResult.java", "diffHunk": "@@ -108,4 +117,26 @@ public IAccount getAccount() {\n     public String[] getScope() {\n         return mAccessToken.getTarget().split(\"\\\\s\");\n     }\n+\n+    @Nullable\n+    @Override\n+    public UUID getCorrelationId() {\n+        return mCorrelationId;\n+    }\n+\n+    private UUID sanitizeCorrelationId(@Nullable final String correlationId) {\n+        final String methodName = \"sanitizeCorrelationId\";\n+\n+        if (TextUtils.isEmpty(correlationId)) {\n+            Logger.warn(TAG + methodName, \"Correlation was empty, returning null.\");", "originalCommit": "23cdbc28feda6f781e8a46f55424a81578a837bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1ODYzMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439158633", "bodyText": "Addressed here: 6a71d1d", "author": "shahzaibj", "createdAt": "2020-06-12T01:23:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MDYwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MDY4Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r437780686", "bodyText": "Should we have one of these that just takes a UUID where we don't need to convert it?", "author": "AdamBJohnsonx", "createdAt": "2020-06-09T23:39:48Z", "path": "msal/src/main/java/com/microsoft/identity/client/AuthenticationResult.java", "diffHunk": "@@ -39,15 +43,20 @@\n  */\n public final class AuthenticationResult implements IAuthenticationResult {\n \n+    private static final String TAG = AuthenticationResult.class.getSimpleName();\n+\n     private final String mTenantId;\n     private final AccessTokenRecord mAccessToken;\n     private final IAccount mAccount;\n+    private final UUID mCorrelationId;\n \n-    AuthenticationResult(@NonNull final List<ICacheRecord> cacheRecords) {\n+    AuthenticationResult(@NonNull final List<ICacheRecord> cacheRecords,\n+                         @Nullable final String correlationId) {", "originalCommit": "23cdbc28feda6f781e8a46f55424a81578a837bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMxNDA5NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438314094", "bodyText": "We can expose a constructor overload that takes a UUID directly, but the conversion would have to happen somewhere as the correlation id that we pass around internally is a String.", "author": "shahzaibj", "createdAt": "2020-06-10T18:05:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MDY4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMzNzE4Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438337183", "bodyText": "Offline conversation, we emit this value on log lines, so an eager conversion is valid, and having this constructor is therefore appropriate.", "author": "AdamBJohnsonx", "createdAt": "2020-06-10T18:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MDY4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MTA1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r437781052", "bodyText": "Any need to eagerly convert it to a string here?  We could wait...", "author": "AdamBJohnsonx", "createdAt": "2020-06-09T23:41:05Z", "path": "msal/src/main/java/com/microsoft/identity/client/TokenParameters.java", "diffHunk": "@@ -201,6 +209,11 @@ public B withResource(final String resource) {\n             return self();\n         }\n \n+        public B withCorrelationId(final UUID correlationId) {\n+            mCorrelationId = correlationId.toString();", "originalCommit": "23cdbc28feda6f781e8a46f55424a81578a837bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMxODA0Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438318042", "bodyText": "If we do it later we would need to a check like this:\nif (tokenParameters.getCorrelationId() != null)\nbefore we try to convert it. I was just trying to avoid that, but we could certainly do what you are suggesting.", "author": "shahzaibj", "createdAt": "2020-06-10T18:12:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MTA1Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMzNTM0Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438335347", "bodyText": "OK, via offline conversation, the reason to eagerly convert is so that we don't need to do it on every log statement.", "author": "AdamBJohnsonx", "createdAt": "2020-06-10T18:43:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzc4MTA1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMwODMzMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438308332", "bodyText": "Should we test the behavior here with strings that are not valid UUIDs?", "author": "AdamBJohnsonx", "createdAt": "2020-06-10T17:55:26Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/AcquireTokenMockTest.java", "diffHunk": "@@ -335,6 +342,136 @@ public void testAcquireTokenSilentFailureNoCallback() {\n         flushScheduler();\n     }\n \n+    @Test\n+    public void testAcquireTokenInteractiveResultContainsSomeCorrelationId() {\n+        final String username = \"fake@test.com\";\n+\n+        final AcquireTokenParameters parameters = new AcquireTokenParameters.Builder()\n+                .startAuthorizationFromActivity(mActivity)\n+                .withLoginHint(username)\n+                .withScopes(Arrays.asList(mScopes))\n+                .fromAuthority(getAuthority())\n+                .withCallback(new AuthenticationCallback() {\n+                    @Override\n+                    public void onCancel() {\n+                        Assert.fail(\"Unexpected cancel\");\n+                    }\n+\n+                    @Override\n+                    public void onSuccess(IAuthenticationResult authenticationResult) {\n+                        Assert.assertFalse(StringUtil.isEmpty(authenticationResult.getAccessToken()));\n+                        Assert.assertNotNull(authenticationResult.getCorrelationId());\n+                        final String correlationId = authenticationResult.getCorrelationId().toString();\n+                        Assert.assertFalse(StringUtil.isEmpty(correlationId));\n+                    }\n+\n+                    @Override\n+                    public void onError(MsalException exception) {\n+                        Assert.fail(exception.getMessage());\n+                    }\n+                })\n+                .build();\n+\n+        mApplication.acquireToken(parameters);\n+        flushScheduler();\n+    }\n+\n+    @Test\n+    public void testAcquireTokenSilentResultContainsSomeCorrelationId() {\n+        final IAccount account = loadAccountForTest(mApplication);\n+\n+        final AcquireTokenSilentParameters silentParameters = new AcquireTokenSilentParameters.Builder()\n+                .withScopes(Arrays.asList(mScopes))\n+                .forceRefresh(true)\n+                .forAccount(account)\n+                .fromAuthority(getAuthority())\n+                .withCallback(new SilentAuthenticationCallback() {\n+                    @Override\n+                    public void onSuccess(IAuthenticationResult authenticationResult) {\n+                        Assert.assertFalse(StringUtil.isEmpty(authenticationResult.getAccessToken()));\n+                        Assert.assertNotNull(authenticationResult.getCorrelationId());\n+                        final String correlationId = authenticationResult.getCorrelationId().toString();\n+                        Assert.assertFalse(StringUtil.isEmpty(correlationId));\n+                    }\n+\n+                    @Override\n+                    public void onError(MsalException exception) {\n+                        Assert.fail(exception.getMessage());\n+                    }\n+                })\n+                .build();\n+\n+        mApplication.acquireTokenSilentAsync(silentParameters);\n+        flushScheduler();\n+    }\n+\n+    @Test\n+    public void testAcquireTokenInteractiveResultContainsProvidedCorrelationId() {\n+        final String username = \"fake@test.com\";\n+\n+        final UUID correlationId = UUID.randomUUID();\n+\n+        final AcquireTokenParameters parameters = new AcquireTokenParameters.Builder()\n+                .startAuthorizationFromActivity(mActivity)\n+                .withLoginHint(username)\n+                .withScopes(Arrays.asList(mScopes))\n+                .fromAuthority(getAuthority())\n+                .withCorrelationId(correlationId)\n+                .withCallback(new AuthenticationCallback() {\n+                    @Override\n+                    public void onCancel() {\n+                        Assert.fail(\"Unexpected cancel\");\n+                    }\n+\n+                    @Override\n+                    public void onSuccess(IAuthenticationResult authenticationResult) {\n+                        Assert.assertFalse(StringUtil.isEmpty(authenticationResult.getAccessToken()));\n+                        Assert.assertNotNull(authenticationResult.getCorrelationId());\n+                        Assert.assertEquals(correlationId, authenticationResult.getCorrelationId());\n+                    }\n+\n+                    @Override\n+                    public void onError(MsalException exception) {\n+                        Assert.fail(exception.getMessage());\n+                    }\n+                })\n+                .build();\n+\n+        mApplication.acquireToken(parameters);\n+        flushScheduler();\n+    }\n+\n+    @Test\n+    public void testAcquireTokenSilentResultContainsProvidedCorrelationId() {", "originalCommit": "23cdbc28feda6f781e8a46f55424a81578a837bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMxOTAzNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438319037", "bodyText": "I don't think we need to, the withCorrelationId method on TokenParametersBuilder only accepts a UUID. So if we actually pass a String, the compilation would break.", "author": "shahzaibj", "createdAt": "2020-06-10T18:13:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMwODMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMyNjkyOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438326929", "bodyText": "I didn't mean passing it in as invalid, I meant on the return in the LocalAuthenticationResult, so that we would exercise the code that sanitizes it.  We have it there, so we should be able to hit it in our tests.  Full discosure - I did not see whether this was possible using our testing strategy.", "author": "AdamBJohnsonx", "createdAt": "2020-06-10T18:28:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMwODMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMyODk1Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438328956", "bodyText": "I see - that shouldn't ever happen in MSAL, but you raise a good point, we can exercise it in UNIT test specifically for that scenario or we can change behavior using a Robolectric Shadow.", "author": "shahzaibj", "createdAt": "2020-06-10T18:31:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMwODMzMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1ODk1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439158952", "bodyText": "@AdamBJohnsonx Added unit tests for command parameters here: 4b194eb\nand added unit tests for Authentication Result here: 2d7e100", "author": "shahzaibj", "createdAt": "2020-06-12T01:24:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMwODMzMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMxNjQwOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r438316409", "bodyText": "Needs NonNull annotation", "author": "shahzaibj", "createdAt": "2020-06-10T18:09:23Z", "path": "msal/src/main/java/com/microsoft/identity/client/TokenParameters.java", "diffHunk": "@@ -201,6 +209,11 @@ public B withResource(final String resource) {\n             return self();\n         }\n \n+        public B withCorrelationId(final UUID correlationId) {", "originalCommit": "23cdbc28feda6f781e8a46f55424a81578a837bb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTE1ODY4MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439158681", "bodyText": "Addressed here: 6a71d1d", "author": "shahzaibj", "createdAt": "2020-06-12T01:23:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMxNjQwOQ=="}], "type": "inlineReview"}, {"oid": "6a71d1d9fc3d3329f4b608dd3702a39ff7099b62", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/6a71d1d9fc3d3329f4b608dd3702a39ff7099b62", "message": "Address comments", "committedDate": "2020-06-11T18:02:29Z", "type": "commit"}, {"oid": "4b194eb18c69e64ab39006ff57bcdfb2dfe3c222", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/4b194eb18c69e64ab39006ff57bcdfb2dfe3c222", "message": "Add unit tests for command parameters and correlation id", "committedDate": "2020-06-12T01:20:26Z", "type": "commit"}, {"oid": "2d7e10047d6279c506445c715fe13531b3b67a8d", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/2d7e10047d6279c506445c715fe13531b3b67a8d", "message": "Add unit tests for Authentication Result and correlation id", "committedDate": "2020-06-12T01:20:41Z", "type": "commit"}, {"oid": "c9a6fca96846ea1cb7a388be86669bec12900b95", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/c9a6fca96846ea1cb7a388be86669bec12900b95", "message": "Update submodule", "committedDate": "2020-06-12T01:21:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMDY2Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439510662", "bodyText": "Could declare return value @Nullable", "author": "iambmelt", "createdAt": "2020-06-12T16:09:48Z", "path": "msal/src/main/java/com/microsoft/identity/client/AuthenticationResult.java", "diffHunk": "@@ -108,4 +117,26 @@ public IAccount getAccount() {\n     public String[] getScope() {\n         return mAccessToken.getTarget().split(\"\\\\s\");\n     }\n+\n+    @Nullable\n+    @Override\n+    public UUID getCorrelationId() {\n+        return mCorrelationId;\n+    }\n+\n+    private UUID sanitizeCorrelationId(@Nullable final String correlationId) {", "originalCommit": "c9a6fca96846ea1cb7a388be86669bec12900b95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MTMxMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439551310", "bodyText": "Addressed here: 353f465", "author": "shahzaibj", "createdAt": "2020-06-12T17:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMDY2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMTI0MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439511240", "bodyText": "License info?", "author": "iambmelt", "createdAt": "2020-06-12T16:10:32Z", "path": "msal/src/test/java/com/microsoft/identity/client/AuthenticationResultTest.java", "diffHunk": "@@ -0,0 +1,93 @@\n+package com.microsoft.identity.client;", "originalCommit": "c9a6fca96846ea1cb7a388be86669bec12900b95", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTU1MTM4NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1063#discussion_r439551385", "bodyText": "Addressed here: 353f465", "author": "shahzaibj", "createdAt": "2020-06-12T17:27:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUxMTI0MA=="}], "type": "inlineReview"}, {"oid": "353f46523435797d9079cbf600a795d288eda4ed", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/353f46523435797d9079cbf600a795d288eda4ed", "message": "Address comments", "committedDate": "2020-06-12T17:27:11Z", "type": "commit"}, {"oid": "ed325e1df21079c653b4f406ba6ed2acf5672465", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/ed325e1df21079c653b4f406ba6ed2acf5672465", "message": "Update submodule", "committedDate": "2020-06-15T17:47:31Z", "type": "commit"}]}