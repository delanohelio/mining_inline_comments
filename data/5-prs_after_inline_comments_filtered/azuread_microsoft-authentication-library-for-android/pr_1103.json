{"pr_number": 1103, "pr_title": "DCF API-Side PR (MSAL)", "pr_createdAt": "2020-07-21T22:58:49Z", "pr_url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103", "timeline": [{"oid": "973892c50ee221fd2df1256bbbd70be62a4e56de", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/973892c50ee221fd2df1256bbbd70be62a4e56de", "message": "Preparing API side of DCF protocol", "committedDate": "2020-07-15T02:38:03Z", "type": "commit"}, {"oid": "dc2936e0a4b8f24e3b63ee571db64fc910f832bb", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/dc2936e0a4b8f24e3b63ee571db64fc910f832bb", "message": "DCF API-side testing", "committedDate": "2020-07-20T15:02:31Z", "type": "commit"}, {"oid": "2d588b52959359cf0a4e0593829b2adf492fcccf", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/2d588b52959359cf0a4e0593829b2adf492fcccf", "message": "Many fixes reflecting newer Design doc, removed static field in Command", "committedDate": "2020-07-21T22:53:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQzOTQzNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458439435", "bodyText": "typo: change deviceto to device to", "author": "shahzaibj", "createdAt": "2020-07-21T23:06:52Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -84,6 +85,19 @@ void acquireToken(@NonNull final Activity activity,\n     @WorkerThread\n     IAuthenticationResult acquireTokenSilent(@NonNull final AcquireTokenSilentParameters acquireTokenSilentParameters) throws InterruptedException, MsalException;\n \n+    /**\n+     * Perform the Device Code Flow (DCF) protocol to allow a deviceto authenticate and get a new access token without input capability.", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0MDAxNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458440015", "bodyText": "We may not need to document all this here, and rather it would be better to document these in the javadoc for DeviceCodeFlowCallback class and over here a simple one line definition of a callback should suffice", "author": "shahzaibj", "createdAt": "2020-07-21T23:08:42Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -84,6 +85,19 @@ void acquireToken(@NonNull final Activity activity,\n     @WorkerThread\n     IAuthenticationResult acquireTokenSilent(@NonNull final AcquireTokenSilentParameters acquireTokenSilentParameters) throws InterruptedException, MsalException;\n \n+    /**\n+     * Perform the Device Code Flow (DCF) protocol to allow a deviceto authenticate and get a new access token without input capability.\n+     * @param scopes\n+     * @param callback The {@link DeviceCodeFlowCallback} object to receive responses from the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#getUserCode(String, String, String)}.\n+     *                 2). Receiving a successful authnetication result containing a fresh access token\n+     *                 via {@link DeviceCodeFlowCallback#getToken(AuthenticationResult)}.\n+     *                 3). Receiving an exception detailing what went wrong in the protocol\n+     *                 via {@link DeviceCodeFlowCallback#onError(MsalException)}.\n+     */", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0MDU1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458440558", "bodyText": "nit: rename dcfCallback to dcfCommandCallback or deviceCodeFlowCommandCallback", "author": "shahzaibj", "createdAt": "2020-07-21T23:10:16Z", "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplication.java", "diffHunk": "@@ -1618,6 +1623,49 @@ public void onError(MsalException exception) {\n         }\n     }\n \n+    public void deviceCodeFlow(@Nullable String[] scopes, @NonNull final DeviceCodeFlowCallback callback) {\n+        // Create a DeviceCodeFlowCommandParameters object that takes in the desired scopes and the callback object\n+        // Use CommandParametersAdapter\n+        final DeviceCodeFlowCommandParameters commandParameters = CommandParametersAdapter\n+                    .createDeviceCodeFlowCommandParameters(\n+                            mPublicClientConfiguration,\n+                            mPublicClientConfiguration.getOAuth2TokenCache(),\n+                            scopes);\n+\n+        // Create a CommandCallback object from the DeviceCodeFlowCallback object\n+        final DeviceCodeFlowCommandCallback dcfCallback = getDeviceCodeFlowCommandCallback(callback);", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0MjczNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458442736", "bodyText": "Looking at your design doc, I see you called out that (at least for now), Device Code Flow is only supported for Local Msal and NOT supported via the Broker. Over here I see the DeviceCodeFlowCommand consuming the Default Controller by calling getDefaultController - that's contradicting what's in the design doc. getDefaultController returns the BrokerMsalController if a broker is installed on the device.\nWhat is our plan in this case? Do we let flow go over to the broker and then throw some exception indicating that the DCF is not supported? Or wouldn't it be better for the DeviceCodeFlowCommand to just consume the LocalMsalController (even if a broker is present on the device) to always use the local MSAL flow for the DeviceCodeFlowCommand ?", "author": "shahzaibj", "createdAt": "2020-07-21T23:17:07Z", "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplication.java", "diffHunk": "@@ -1618,6 +1623,49 @@ public void onError(MsalException exception) {\n         }\n     }\n \n+    public void deviceCodeFlow(@Nullable String[] scopes, @NonNull final DeviceCodeFlowCallback callback) {\n+        // Create a DeviceCodeFlowCommandParameters object that takes in the desired scopes and the callback object\n+        // Use CommandParametersAdapter\n+        final DeviceCodeFlowCommandParameters commandParameters = CommandParametersAdapter\n+                    .createDeviceCodeFlowCommandParameters(\n+                            mPublicClientConfiguration,\n+                            mPublicClientConfiguration.getOAuth2TokenCache(),\n+                            scopes);\n+\n+        // Create a CommandCallback object from the DeviceCodeFlowCallback object\n+        final DeviceCodeFlowCommandCallback dcfCallback = getDeviceCodeFlowCommandCallback(callback);\n+\n+        // Attempt protocol\n+        try {\n+            // Create a DeviceCodeFlowCommand object\n+            // Pass the command parameters, default controller, and command callback\n+            // Telemetry with DEVICE_CODE_FLOW_CALLBACK\n+            final DeviceCodeFlowCommand deviceCodeFlowCommand = new DeviceCodeFlowCommand(\n+                    commandParameters,\n+                    MSALControllerFactory.getDefaultController(", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODczMDQ2Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458730462", "bodyText": "Yes, Scope is limited to MSAL. At the start of the design process, I was going to look into how to limit the command to a single controller instead of using default controller, but I forgot to do so as I was creating the design document and focused on other things. But yes, ideally I would want the API to just use LocalMsalController even if Broker is installed on the device (at least until Broker support is implemented).", "author": "t-fadura", "createdAt": "2020-07-22T11:42:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0MjczNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Mzc3OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458443779", "bodyText": "What Authentication Schemes are actually supported over DCF?", "author": "shahzaibj", "createdAt": "2020-07-21T23:20:20Z", "path": "msal/src/main/java/com/microsoft/identity/client/internal/CommandParametersAdapter.java", "diffHunk": "@@ -193,6 +194,36 @@ public static SilentTokenCommandParameters createSilentTokenCommandParameters(\n         return commandParameters;\n     }\n \n+    public static DeviceCodeFlowCommandParameters createDeviceCodeFlowCommandParameters(\n+            @NonNull final PublicClientApplicationConfiguration configuration,\n+            @NonNull final OAuth2TokenCache tokenCache,\n+            @NonNull String[] scopes){\n+\n+        final AbstractAuthenticationScheme authenticationScheme = AuthenticationSchemeFactory.createScheme(\n+                configuration.getAppContext(),\n+                null", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDA2NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444064", "bodyText": "If it's just Bearer then we should hard code that here instead of null as the logic inside createScheme to handle null values may change and we don't want this to break when that happens", "author": "shahzaibj", "createdAt": "2020-07-21T23:21:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Mzc3OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0NTg5NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458745894", "bodyText": "I went ahead and hard coded a BearerAuthenticationSchemeInternal Object.", "author": "t-fadura", "createdAt": "2020-07-22T12:13:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Mzc3OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDI2OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444268", "bodyText": "Would be good to have an empty line above this", "author": "shahzaibj", "createdAt": "2020-07-21T23:21:58Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandSuccessful.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.common.internal.cache.CacheRecord;\n+import com.microsoft.identity.common.internal.cache.ICacheRecord;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommandCallback;\n+import com.microsoft.identity.common.internal.dto.AccountRecord;\n+import com.microsoft.identity.common.internal.request.SdkType;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+import com.microsoft.identity.common.internal.result.ILocalAuthenticationResult;\n+import com.microsoft.identity.common.internal.result.LocalAuthenticationResult;\n+\n+import org.robolectric.annotation.Implementation;\n+import org.robolectric.annotation.Implements;\n+import org.robolectric.annotation.RealObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow successfully returning an acquire token result object.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandSuccessful {\n+    @RealObject", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDQyNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444426", "bodyText": "nit: add final here and everywhere as applicable", "author": "shahzaibj", "createdAt": "2020-07-21T23:22:32Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandSuccessful.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.common.internal.cache.CacheRecord;\n+import com.microsoft.identity.common.internal.cache.ICacheRecord;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommandCallback;\n+import com.microsoft.identity.common.internal.dto.AccountRecord;\n+import com.microsoft.identity.common.internal.request.SdkType;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+import com.microsoft.identity.common.internal.result.ILocalAuthenticationResult;\n+import com.microsoft.identity.common.internal.result.LocalAuthenticationResult;\n+\n+import org.robolectric.annotation.Implementation;\n+import org.robolectric.annotation.Implements;\n+import org.robolectric.annotation.RealObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow successfully returning an acquire token result object.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandSuccessful {\n+    @RealObject\n+    private DeviceCodeFlowCommand mDeviceCodeFlowCommand;\n+\n+    @Implementation\n+    public AcquireTokenResult execute() {\n+        DeviceCodeFlowCommandCallback callback = (DeviceCodeFlowCommandCallback) mDeviceCodeFlowCommand.getCallback();", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDU0MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444541", "bodyText": "nit: rename to localAuthResult or localAuthenticationResult", "author": "shahzaibj", "createdAt": "2020-07-21T23:23:01Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandSuccessful.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.common.internal.cache.CacheRecord;\n+import com.microsoft.identity.common.internal.cache.ICacheRecord;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommandCallback;\n+import com.microsoft.identity.common.internal.dto.AccountRecord;\n+import com.microsoft.identity.common.internal.request.SdkType;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+import com.microsoft.identity.common.internal.result.ILocalAuthenticationResult;\n+import com.microsoft.identity.common.internal.result.LocalAuthenticationResult;\n+\n+import org.robolectric.annotation.Implementation;\n+import org.robolectric.annotation.Implements;\n+import org.robolectric.annotation.RealObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow successfully returning an acquire token result object.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandSuccessful {\n+    @RealObject\n+    private DeviceCodeFlowCommand mDeviceCodeFlowCommand;\n+\n+    @Implementation\n+    public AcquireTokenResult execute() {\n+        DeviceCodeFlowCommandCallback callback = (DeviceCodeFlowCommandCallback) mDeviceCodeFlowCommand.getCallback();\n+        callback.getUserCode(\n+                \"https://login.microsoftonline.com/common/oauth2/deviceauth\",\n+                \"ABCDEFGH\",\n+                \"Follow these instructions to authenticate.\");\n+\n+        // Create parameters for dummy authentication result\n+        CacheRecord cRecord = new CacheRecord();\n+        cRecord.setAccount(new AccountRecord());\n+        cRecord.getAccount().setHomeAccountId(\"abcd\");\n+        cRecord.getAccount().setLocalAccountId(\"abcd\");\n+        List<ICacheRecord> list = new ArrayList<>();\n+        list.add(cRecord);\n+\n+        // Create dummy authentication result\n+        ILocalAuthenticationResult localAuth = new LocalAuthenticationResult(", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDY1NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444654", "bodyText": "nit: rename to tokenResult or acquireTokenResult", "author": "shahzaibj", "createdAt": "2020-07-21T23:23:23Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandSuccessful.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.common.internal.cache.CacheRecord;\n+import com.microsoft.identity.common.internal.cache.ICacheRecord;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommandCallback;\n+import com.microsoft.identity.common.internal.dto.AccountRecord;\n+import com.microsoft.identity.common.internal.request.SdkType;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+import com.microsoft.identity.common.internal.result.ILocalAuthenticationResult;\n+import com.microsoft.identity.common.internal.result.LocalAuthenticationResult;\n+\n+import org.robolectric.annotation.Implementation;\n+import org.robolectric.annotation.Implements;\n+import org.robolectric.annotation.RealObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow successfully returning an acquire token result object.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandSuccessful {\n+    @RealObject\n+    private DeviceCodeFlowCommand mDeviceCodeFlowCommand;\n+\n+    @Implementation\n+    public AcquireTokenResult execute() {\n+        DeviceCodeFlowCommandCallback callback = (DeviceCodeFlowCommandCallback) mDeviceCodeFlowCommand.getCallback();\n+        callback.getUserCode(\n+                \"https://login.microsoftonline.com/common/oauth2/deviceauth\",\n+                \"ABCDEFGH\",\n+                \"Follow these instructions to authenticate.\");\n+\n+        // Create parameters for dummy authentication result\n+        CacheRecord cRecord = new CacheRecord();\n+        cRecord.setAccount(new AccountRecord());\n+        cRecord.getAccount().setHomeAccountId(\"abcd\");\n+        cRecord.getAccount().setLocalAccountId(\"abcd\");\n+        List<ICacheRecord> list = new ArrayList<>();\n+        list.add(cRecord);\n+\n+        // Create dummy authentication result\n+        ILocalAuthenticationResult localAuth = new LocalAuthenticationResult(\n+                cRecord,\n+                list,\n+                SdkType.MSAL,\n+                false\n+        );\n+\n+        // Create dummy token result\n+        AcquireTokenResult acqResult = new AcquireTokenResult();", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDczNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444736", "bodyText": "nit: rename to cacheRecord", "author": "shahzaibj", "createdAt": "2020-07-21T23:23:40Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandSuccessful.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.common.internal.cache.CacheRecord;\n+import com.microsoft.identity.common.internal.cache.ICacheRecord;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommandCallback;\n+import com.microsoft.identity.common.internal.dto.AccountRecord;\n+import com.microsoft.identity.common.internal.request.SdkType;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+import com.microsoft.identity.common.internal.result.ILocalAuthenticationResult;\n+import com.microsoft.identity.common.internal.result.LocalAuthenticationResult;\n+\n+import org.robolectric.annotation.Implementation;\n+import org.robolectric.annotation.Implements;\n+import org.robolectric.annotation.RealObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow successfully returning an acquire token result object.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandSuccessful {\n+    @RealObject\n+    private DeviceCodeFlowCommand mDeviceCodeFlowCommand;\n+\n+    @Implementation\n+    public AcquireTokenResult execute() {\n+        DeviceCodeFlowCommandCallback callback = (DeviceCodeFlowCommandCallback) mDeviceCodeFlowCommand.getCallback();\n+        callback.getUserCode(\n+                \"https://login.microsoftonline.com/common/oauth2/deviceauth\",\n+                \"ABCDEFGH\",\n+                \"Follow these instructions to authenticate.\");\n+\n+        // Create parameters for dummy authentication result\n+        CacheRecord cRecord = new CacheRecord();", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDgyMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444820", "bodyText": "nit: rename to cacheRecordList", "author": "shahzaibj", "createdAt": "2020-07-21T23:23:58Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandSuccessful.java", "diffHunk": "@@ -0,0 +1,80 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.common.internal.cache.CacheRecord;\n+import com.microsoft.identity.common.internal.cache.ICacheRecord;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommandCallback;\n+import com.microsoft.identity.common.internal.dto.AccountRecord;\n+import com.microsoft.identity.common.internal.request.SdkType;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+import com.microsoft.identity.common.internal.result.ILocalAuthenticationResult;\n+import com.microsoft.identity.common.internal.result.LocalAuthenticationResult;\n+\n+import org.robolectric.annotation.Implementation;\n+import org.robolectric.annotation.Implements;\n+import org.robolectric.annotation.RealObject;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow successfully returning an acquire token result object.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandSuccessful {\n+    @RealObject\n+    private DeviceCodeFlowCommand mDeviceCodeFlowCommand;\n+\n+    @Implementation\n+    public AcquireTokenResult execute() {\n+        DeviceCodeFlowCommandCallback callback = (DeviceCodeFlowCommandCallback) mDeviceCodeFlowCommand.getCallback();\n+        callback.getUserCode(\n+                \"https://login.microsoftonline.com/common/oauth2/deviceauth\",\n+                \"ABCDEFGH\",\n+                \"Follow these instructions to authenticate.\");\n+\n+        // Create parameters for dummy authentication result\n+        CacheRecord cRecord = new CacheRecord();\n+        cRecord.setAccount(new AccountRecord());\n+        cRecord.getAccount().setHomeAccountId(\"abcd\");\n+        cRecord.getAccount().setLocalAccountId(\"abcd\");\n+        List<ICacheRecord> list = new ArrayList<>();", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NDk0OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458444949", "bodyText": "nit: final here and everywhere as needed", "author": "shahzaibj", "createdAt": "2020-07-21T23:24:21Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandTokenError.java", "diffHunk": "@@ -0,0 +1,50 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.client.exception.MsalServiceException;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommandCallback;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+\n+import org.robolectric.annotation.Implements;\n+import org.robolectric.annotation.RealObject;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow failing due to an error in the token polling phase.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandTokenError {\n+    @RealObject\n+    private DeviceCodeFlowCommand mDeviceCodeFlowCommand;\n+\n+    public AcquireTokenResult execute() throws Exception {\n+        DeviceCodeFlowCommandCallback callback = (DeviceCodeFlowCommandCallback) mDeviceCodeFlowCommand.getCallback();", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NTI2NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458445264", "bodyText": "userCode?", "author": "shahzaibj", "createdAt": "2020-07-21T23:25:13Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/DeviceCodeFlowAPITest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.tests.mocked;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.client.AuthenticationResult;\n+import com.microsoft.identity.client.IPublicClientApplication;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandAuthError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandSuccessful;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandTokenError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowHttpRequestForMockedTest;\n+import com.microsoft.identity.client.e2e.shadows.ShadowMsalUtils;\n+import com.microsoft.identity.client.e2e.tests.PublicClientApplicationAbstractTest;\n+import com.microsoft.identity.client.e2e.utils.RoboTestUtils;\n+import com.microsoft.identity.client.exception.MsalException;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static com.microsoft.identity.internal.testutils.TestConstants.Configurations.SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+\n+/**\n+ * Testing class for the device code flow protocol. Currently only supporting testing for the API-side\n+ * of the protocol. Will be extended to test individual aspects of the flow.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+@Config(shadows = {ShadowMsalUtils.class, ShadowHttpRequestForMockedTest.class})\n+public class DeviceCodeFlowAPITest extends PublicClientApplicationAbstractTest {\n+\n+    private static Boolean uCode;", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NTQ0Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458445446", "bodyText": "nit: rename user_code to userCode", "author": "shahzaibj", "createdAt": "2020-07-21T23:25:45Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/DeviceCodeFlowAPITest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.tests.mocked;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.client.AuthenticationResult;\n+import com.microsoft.identity.client.IPublicClientApplication;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandAuthError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandSuccessful;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandTokenError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowHttpRequestForMockedTest;\n+import com.microsoft.identity.client.e2e.shadows.ShadowMsalUtils;\n+import com.microsoft.identity.client.e2e.tests.PublicClientApplicationAbstractTest;\n+import com.microsoft.identity.client.e2e.utils.RoboTestUtils;\n+import com.microsoft.identity.client.exception.MsalException;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static com.microsoft.identity.internal.testutils.TestConstants.Configurations.SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+\n+/**\n+ * Testing class for the device code flow protocol. Currently only supporting testing for the API-side\n+ * of the protocol. Will be extended to test individual aspects of the flow.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+@Config(shadows = {ShadowMsalUtils.class, ShadowHttpRequestForMockedTest.class})\n+public class DeviceCodeFlowAPITest extends PublicClientApplicationAbstractTest {\n+\n+    private static Boolean uCode;\n+\n+    @Before\n+    public void setup() {\n+        super.setup();\n+        uCode = false;\n+    }\n+\n+    @Override\n+    public String getConfigFilePath() {\n+        return SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+    }\n+\n+    @Test\n+    @Config(shadows = {ShadowDeviceCodeFlowCommandAuthError.class})\n+    public void testDeviceCodeFlowAuthFailure() {\n+        String[] scope = {\"user.read\"};\n+        mApplication.deviceCodeFlow(scope, new IPublicClientApplication.DeviceCodeFlowCallback() {\n+            @Override\n+            public void getUserCode(@NonNull String vUri, @NonNull String user_code, @NonNull String message) {", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NTYxNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458445615", "bodyText": "Does this have to be static?", "author": "shahzaibj", "createdAt": "2020-07-21T23:26:19Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/DeviceCodeFlowAPITest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.tests.mocked;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.client.AuthenticationResult;\n+import com.microsoft.identity.client.IPublicClientApplication;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandAuthError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandSuccessful;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandTokenError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowHttpRequestForMockedTest;\n+import com.microsoft.identity.client.e2e.shadows.ShadowMsalUtils;\n+import com.microsoft.identity.client.e2e.tests.PublicClientApplicationAbstractTest;\n+import com.microsoft.identity.client.e2e.utils.RoboTestUtils;\n+import com.microsoft.identity.client.exception.MsalException;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static com.microsoft.identity.internal.testutils.TestConstants.Configurations.SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+\n+/**\n+ * Testing class for the device code flow protocol. Currently only supporting testing for the API-side\n+ * of the protocol. Will be extended to test individual aspects of the flow.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+@Config(shadows = {ShadowMsalUtils.class, ShadowHttpRequestForMockedTest.class})\n+public class DeviceCodeFlowAPITest extends PublicClientApplicationAbstractTest {\n+\n+    private static Boolean uCode;", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NTczNA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458445734", "bodyText": "Can this be a primitive?", "author": "shahzaibj", "createdAt": "2020-07-21T23:26:40Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/DeviceCodeFlowAPITest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.tests.mocked;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.client.AuthenticationResult;\n+import com.microsoft.identity.client.IPublicClientApplication;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandAuthError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandSuccessful;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandTokenError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowHttpRequestForMockedTest;\n+import com.microsoft.identity.client.e2e.shadows.ShadowMsalUtils;\n+import com.microsoft.identity.client.e2e.tests.PublicClientApplicationAbstractTest;\n+import com.microsoft.identity.client.e2e.utils.RoboTestUtils;\n+import com.microsoft.identity.client.exception.MsalException;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static com.microsoft.identity.internal.testutils.TestConstants.Configurations.SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+\n+/**\n+ * Testing class for the device code flow protocol. Currently only supporting testing for the API-side\n+ * of the protocol. Will be extended to test individual aspects of the flow.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+@Config(shadows = {ShadowMsalUtils.class, ShadowHttpRequestForMockedTest.class})\n+public class DeviceCodeFlowAPITest extends PublicClientApplicationAbstractTest {\n+\n+    private static Boolean uCode;", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1MTUzOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458751538", "bodyText": "Yes, it can be primitive. No, t doesn't need to be static.", "author": "t-fadura", "createdAt": "2020-07-22T12:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NTczNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NTkwOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458445908", "bodyText": "Is this needed? (booleans are false by default)", "author": "shahzaibj", "createdAt": "2020-07-21T23:27:12Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/DeviceCodeFlowAPITest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.tests.mocked;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.client.AuthenticationResult;\n+import com.microsoft.identity.client.IPublicClientApplication;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandAuthError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandSuccessful;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandTokenError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowHttpRequestForMockedTest;\n+import com.microsoft.identity.client.e2e.shadows.ShadowMsalUtils;\n+import com.microsoft.identity.client.e2e.tests.PublicClientApplicationAbstractTest;\n+import com.microsoft.identity.client.e2e.utils.RoboTestUtils;\n+import com.microsoft.identity.client.exception.MsalException;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static com.microsoft.identity.internal.testutils.TestConstants.Configurations.SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+\n+/**\n+ * Testing class for the device code flow protocol. Currently only supporting testing for the API-side\n+ * of the protocol. Will be extended to test individual aspects of the flow.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+@Config(shadows = {ShadowMsalUtils.class, ShadowHttpRequestForMockedTest.class})\n+public class DeviceCodeFlowAPITest extends PublicClientApplicationAbstractTest {\n+\n+    private static Boolean uCode;\n+\n+    @Before\n+    public void setup() {\n+        super.setup();\n+        uCode = false;", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc1Mzk1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458753958", "bodyText": "This is not needed, you're right.", "author": "t-fadura", "createdAt": "2020-07-22T12:28:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NTkwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NjA4Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458446087", "bodyText": "nit: rename user_code to userCode", "author": "shahzaibj", "createdAt": "2020-07-21T23:27:43Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/DeviceCodeFlowAPITest.java", "diffHunk": "@@ -0,0 +1,154 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.tests.mocked;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.client.AuthenticationResult;\n+import com.microsoft.identity.client.IPublicClientApplication;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandAuthError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandSuccessful;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandTokenError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowHttpRequestForMockedTest;\n+import com.microsoft.identity.client.e2e.shadows.ShadowMsalUtils;\n+import com.microsoft.identity.client.e2e.tests.PublicClientApplicationAbstractTest;\n+import com.microsoft.identity.client.e2e.utils.RoboTestUtils;\n+import com.microsoft.identity.client.exception.MsalException;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static com.microsoft.identity.internal.testutils.TestConstants.Configurations.SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+\n+/**\n+ * Testing class for the device code flow protocol. Currently only supporting testing for the API-side\n+ * of the protocol. Will be extended to test individual aspects of the flow.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+@Config(shadows = {ShadowMsalUtils.class, ShadowHttpRequestForMockedTest.class})\n+public class DeviceCodeFlowAPITest extends PublicClientApplicationAbstractTest {\n+\n+    private static Boolean uCode;\n+\n+    @Before\n+    public void setup() {\n+        super.setup();\n+        uCode = false;\n+    }\n+\n+    @Override\n+    public String getConfigFilePath() {\n+        return SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+    }\n+\n+    @Test\n+    @Config(shadows = {ShadowDeviceCodeFlowCommandAuthError.class})\n+    public void testDeviceCodeFlowAuthFailure() {\n+        String[] scope = {\"user.read\"};\n+        mApplication.deviceCodeFlow(scope, new IPublicClientApplication.DeviceCodeFlowCallback() {\n+            @Override\n+            public void getUserCode(@NonNull String vUri, @NonNull String user_code, @NonNull String message) {\n+                // This shouldn't run if authorization step fails\n+                Assert.fail();\n+            }\n+            @Override\n+            public void getToken(AuthenticationResult authResult) {\n+                // This shouldn't run if authorization step fails\n+                Assert.fail();\n+            }\n+            @Override\n+            public void onError(MsalException error) {\n+                // Handle exception when authorization fails\n+                Assert.assertFalse(uCode);\n+                Assert.assertTrue(error.getErrorCode().equals(\"invalid_scope\"));\n+            }\n+        });\n+\n+        RoboTestUtils.flushScheduler();\n+    }\n+\n+    @Test\n+    @Config(shadows = {ShadowDeviceCodeFlowCommandTokenError.class})\n+    public void testDeviceCodeFlowTokenFailure() {\n+        String[] scope = {\"user.read\"};\n+        mApplication.deviceCodeFlow(scope, new IPublicClientApplication.DeviceCodeFlowCallback() {\n+            @Override\n+            public void getUserCode(@NonNull String vUri, @NonNull String user_code, @NonNull String message) {\n+                // Assert that the protocol returns the user_code and others after successful authorization\n+                Assert.assertNotNull(vUri);\n+                Assert.assertNotNull(user_code);\n+                Assert.assertNotNull(message);\n+\n+                Assert.assertFalse(uCode);\n+                uCode = true;\n+            }\n+            @Override\n+            public void getToken(AuthenticationResult authResult) {\n+                // This shouldn't run\n+                Assert.fail();\n+            }\n+            @Override\n+            public void onError(MsalException error) {\n+                // Handle Exception\n+                Assert.assertTrue(uCode);\n+                Assert.assertTrue(error.getErrorCode().equals(\"expired_token\"));\n+            }\n+        });\n+\n+        RoboTestUtils.flushScheduler();\n+    }\n+\n+    @Test\n+    @Config(shadows = {ShadowDeviceCodeFlowCommandSuccessful.class})\n+    public void testDeviceCodeFlowSuccess() {\n+        String[] scope = {\"user.read\"};\n+        mApplication.deviceCodeFlow(scope, new IPublicClientApplication.DeviceCodeFlowCallback() {\n+            @Override\n+            public void getUserCode(@NonNull String vUri, @NonNull String user_code, @NonNull String message) {", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Njg3NA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458446874", "bodyText": "Doesn't seem like it returns anything so I think a name that start with get is not suitable. How about onUserCodeReceived?", "author": "shahzaibj", "createdAt": "2020-07-21T23:30:08Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +176,29 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    interface DeviceCodeFlowCallback{\n+        /**\n+         * Called to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void getUserCode(@NonNull String vUri, @NonNull String userCode, @NonNull String message);", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODcyNTcxMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458725711", "bodyText": "This makes sense, I should've done this for DeviceCodeFlowCommandCallback in Common, too.", "author": "t-fadura", "createdAt": "2020-07-22T11:33:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Njg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkwOTY0OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458909648", "bodyText": "@t-fadura You can open another PR in common to do the same (or do it as part of your next PR in common)", "author": "shahzaibj", "createdAt": "2020-07-22T16:10:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Njg3NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDkyMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458914923", "bodyText": "I'd have to do a separate PR in common for it before this one is completed so I can change it in MSAL after it is changed in Common.", "author": "t-fadura", "createdAt": "2020-07-22T16:18:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Njg3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Njk3Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458446973", "bodyText": "Doesn't seem like it returns anything so I think a name that start with get is not suitable. How about onTokenReceived?", "author": "shahzaibj", "createdAt": "2020-07-21T23:30:23Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +176,29 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    interface DeviceCodeFlowCallback{\n+        /**\n+         * Called to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void getUserCode(@NonNull String vUri, @NonNull String userCode, @NonNull String message);\n+\n+        /**\n+         * Called once succeed and pass the result object.\n+         *\n+         * @param authResult the authentication result\n+         */\n+        void getToken(AuthenticationResult authResult);", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NzEzOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458447138", "bodyText": "The class itself should have some javadoc", "author": "shahzaibj", "createdAt": "2020-07-21T23:30:53Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +176,29 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    interface DeviceCodeFlowCallback{", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0NzMwMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458447300", "bodyText": "need space between DeviceCodeFlowCallback and {", "author": "shahzaibj", "createdAt": "2020-07-21T23:31:24Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +176,29 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    interface DeviceCodeFlowCallback{", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0Nzk3Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458447976", "bodyText": "nit: change Called to Invoked", "author": "shahzaibj", "createdAt": "2020-07-21T23:33:39Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +176,29 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    interface DeviceCodeFlowCallback{\n+        /**\n+         * Called to display verification uri, user code, and instruction message during device code flow.", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ0ODAzOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458448039", "bodyText": "nit: change Called to Invoked", "author": "shahzaibj", "createdAt": "2020-07-21T23:33:51Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +176,29 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    interface DeviceCodeFlowCallback{\n+        /**\n+         * Called to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void getUserCode(@NonNull String vUri, @NonNull String userCode, @NonNull String message);\n+\n+        /**\n+         * Called once succeed and pass the result object.", "originalCommit": "2d588b52959359cf0a4e0593829b2adf492fcccf", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7b2d25c84930e11abb603d5725e9960880c712b7", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/7b2d25c84930e11abb603d5725e9960880c712b7", "message": "Address suggestions from PR", "committedDate": "2020-07-22T12:37:49Z", "type": "commit"}, {"oid": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "message": "deviceCodeFlow() always uses LocalMsalController()", "committedDate": "2020-07-22T14:21:22Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMTIxMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458911213", "bodyText": "How about rephrase as follows:\n\nPerform the Device Code Flow (DCF) protocol to allow a device without input capability to authenticate and get a new access token.", "author": "shahzaibj", "createdAt": "2020-07-22T16:12:42Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -84,6 +86,13 @@ void acquireToken(@NonNull final Activity activity,\n     @WorkerThread\n     IAuthenticationResult acquireTokenSilent(@NonNull final AcquireTokenSilentParameters acquireTokenSilentParameters) throws InterruptedException, MsalException;\n \n+    /**\n+     * Perform the Device Code Flow (DCF) protocol to allow a device to authenticate and get a new access token without input capability.", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMTgwNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458911806", "bodyText": "Not quite sure why the last two String have underlines here", "author": "shahzaibj", "createdAt": "2020-07-22T16:13:33Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +171,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzMTMxMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458931313", "bodyText": "Hmm, not sure, seems to only show up in github", "author": "t-fadura", "createdAt": "2020-07-22T16:38:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMTgwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk0ODY2Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458948662", "bodyText": "I guess it is okay then", "author": "shahzaibj", "createdAt": "2020-07-22T17:07:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMTgwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxMzU4Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458913583", "bodyText": "How about rephrase as:\n\nInvoked once token is received and passes the {@link AuthenticationResult} object", "author": "shahzaibj", "createdAt": "2020-07-22T16:16:17Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +171,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.\n+     *                 2). Receiving a successful authnetication result containing a fresh access token\n+     *                 via {@link DeviceCodeFlowCallback#onTokenReceived(AuthenticationResult)}.\n+     *                 3). Receiving an exception detailing what went wrong in the protocol\n+     *                 via {@link DeviceCodeFlowCallback#onError(MsalServiceException)}.\n+     */\n+    interface DeviceCodeFlowCallback {\n+        /**\n+         * Invoked to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message);\n+\n+        /**\n+         * Invoked once succeed and pass the result object.", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDA0OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458914048", "bodyText": "How about rephrase as:\n\nInvoked if an error is encountered during the device code flow and passes the Exception object", "author": "shahzaibj", "createdAt": "2020-07-22T16:17:02Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +171,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.\n+     *                 2). Receiving a successful authnetication result containing a fresh access token\n+     *                 via {@link DeviceCodeFlowCallback#onTokenReceived(AuthenticationResult)}.\n+     *                 3). Receiving an exception detailing what went wrong in the protocol\n+     *                 via {@link DeviceCodeFlowCallback#onError(MsalServiceException)}.\n+     */\n+    interface DeviceCodeFlowCallback {\n+        /**\n+         * Invoked to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message);\n+\n+        /**\n+         * Invoked once succeed and pass the result object.\n+         *\n+         * @param authResult the authentication result\n+         */\n+        void onTokenReceived(AuthenticationResult authResult);\n+\n+        /**\n+         * Invoked once exception thrown.", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDUwNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458914507", "bodyText": "Can we get other types of Exceptions here? How about any MsalException?", "author": "shahzaibj", "createdAt": "2020-07-22T16:17:44Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +171,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.\n+     *                 2). Receiving a successful authnetication result containing a fresh access token\n+     *                 via {@link DeviceCodeFlowCallback#onTokenReceived(AuthenticationResult)}.\n+     *                 3). Receiving an exception detailing what went wrong in the protocol\n+     *                 via {@link DeviceCodeFlowCallback#onError(MsalServiceException)}.\n+     */\n+    interface DeviceCodeFlowCallback {\n+        /**\n+         * Invoked to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message);\n+\n+        /**\n+         * Invoked once succeed and pass the result object.\n+         *\n+         * @param authResult the authentication result\n+         */\n+        void onTokenReceived(AuthenticationResult authResult);\n+\n+        /**\n+         * Invoked once exception thrown.\n+         *\n+         * @param error error exception\n+         */\n+        void onError(MsalServiceException error);", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNTQ2NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458915465", "bodyText": "It originally was MsalException, but I think the command class will only be throwing MsalServiceException.", "author": "t-fadura", "createdAt": "2020-07-22T16:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDUwNw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNDIwMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458934200", "bodyText": "I think I will change it back to MsalException just to be safe.", "author": "t-fadura", "createdAt": "2020-07-22T16:42:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNDUwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNTQ0Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458915442", "bodyText": "Can you remind me why we need a new thread here? CommandDispatcher should be spinning up its own threads any way so I believe there shouldn't be any HTTP request that is made on the main thread.", "author": "shahzaibj", "createdAt": "2020-07-22T16:19:07Z", "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplication.java", "diffHunk": "@@ -1618,6 +1624,38 @@ public void onError(MsalException exception) {\n         }\n     }\n \n+    public void deviceCodeFlow(@Nullable String[] scopes, @NonNull final DeviceCodeFlowCallback callback) {\n+        // Create a DeviceCodeFlowCommandParameters object that takes in the desired scopes and the callback object\n+        // Use CommandParametersAdapter\n+        final DeviceCodeFlowCommandParameters commandParameters = CommandParametersAdapter\n+                    .createDeviceCodeFlowCommandParameters(\n+                            mPublicClientConfiguration,\n+                            mPublicClientConfiguration.getOAuth2TokenCache(),\n+                            scopes);\n+\n+        // Create a CommandCallback object from the DeviceCodeFlowCallback object\n+        final DeviceCodeFlowCommandCallback deviceCodeFlowCommandCallback = getDeviceCodeFlowCommandCallback(callback);\n+\n+        // Create a DeviceCodeFlowCommand object\n+        // Pass the command parameters, default controller, and command callback\n+        // Telemetry with DEVICE_CODE_FLOW_CALLBACK\n+        final DeviceCodeFlowCommand deviceCodeFlowCommand = new DeviceCodeFlowCommand(\n+                commandParameters,\n+                new LocalMSALController(),\n+                deviceCodeFlowCommandCallback,\n+                PublicApiId.DEVICE_CODE_FLOW_WITH_CALLBACK\n+        );\n+\n+        // Run the command we created above in a separate thread to allow running HTTP Requests\n+        Thread thread = new Thread(new Runnable(){\n+            @Override\n+            public void run(){\n+                CommandDispatcher.submitSilent(deviceCodeFlowCommand);\n+            }\n+        });\n+        thread.start();", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzMzU5MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458933591", "bodyText": "You may be right about this. This may just be a remnant from the Proof of Concept. I'll test this without the thread in a bit.", "author": "t-fadura", "createdAt": "2020-07-22T16:41:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNTQ0Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNjkyNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458936927", "bodyText": "CommandDispatcher.submitSilent() documentation states that it uses a silent thread pool, so I will remove the new thread in PCA.", "author": "t-fadura", "createdAt": "2020-07-22T16:47:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNTQ0Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNTg0Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458915842", "bodyText": "Why can't we get any generic MsalException?", "author": "shahzaibj", "createdAt": "2020-07-22T16:19:43Z", "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplication.java", "diffHunk": "@@ -1689,6 +1727,38 @@ public void onCancel() {\n         };\n     }\n \n+    protected DeviceCodeFlowCommandCallback getDeviceCodeFlowCommandCallback(@NonNull final DeviceCodeFlowCallback callback) {\n+        return new DeviceCodeFlowCommandCallback<LocalAuthenticationResult, MsalServiceException>() {\n+            @Override\n+            public void getUserCode(@NonNull String vUri, @NonNull String userCode, @NonNull String message){\n+                callback.onUserCodeReceived(vUri, userCode, message);\n+            }\n+\n+            @Override\n+            public void onTaskCompleted(LocalAuthenticationResult tokenResult) {\n+                // Convert tokenResult to an AuthenticationResult object\n+                IAuthenticationResult convertedResult = AuthenticationResultAdapter.adapt(\n+                        tokenResult);\n+\n+                // Type cast the interface object\n+                AuthenticationResult authResult = (AuthenticationResult) convertedResult;\n+\n+                callback.onTokenReceived(authResult);\n+            }\n+\n+            @Override\n+            public void onError(MsalServiceException msalError) {", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxNzkxNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458917915", "bodyText": "Would be good to have an extra line above this", "author": "shahzaibj", "createdAt": "2020-07-22T16:22:18Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/shadows/ShadowDeviceCodeFlowCommandAuthError.java", "diffHunk": "@@ -0,0 +1,39 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.shadows;\n+\n+import com.microsoft.identity.client.exception.MsalServiceException;\n+import com.microsoft.identity.common.internal.commands.DeviceCodeFlowCommand;\n+import com.microsoft.identity.common.internal.result.AcquireTokenResult;\n+\n+import org.robolectric.annotation.Implements;\n+\n+/**\n+ * Shadow class that simulates Device Code Flow failing due to an error in the authorization phase.\n+ */\n+@Implements(DeviceCodeFlowCommand.class)\n+public class ShadowDeviceCodeFlowCommandAuthError {\n+    public AcquireTokenResult execute() throws Exception {", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxOTYzNw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458919637", "bodyText": "I'm not clear on what this variable is/does....does it determine if user code has been received? If yes, then can we rename to mUserCodeReceived?", "author": "shahzaibj", "createdAt": "2020-07-22T16:23:59Z", "path": "msal/src/test/java/com/microsoft/identity/client/e2e/tests/mocked/DeviceCodeFlowAPITest.java", "diffHunk": "@@ -0,0 +1,153 @@\n+// Copyright (c) Microsoft Corporation.\n+// All rights reserved.\n+//\n+// This code is licensed under the MIT License.\n+//\n+// Permission is hereby granted, free of charge, to any person obtaining a copy\n+// of this software and associated documentation files(the \"Software\"), to deal\n+// in the Software without restriction, including without limitation the rights\n+// to use, copy, modify, merge, publish, distribute, sublicense, and / or sell\n+// copies of the Software, and to permit persons to whom the Software is\n+// furnished to do so, subject to the following conditions :\n+//\n+// The above copyright notice and this permission notice shall be included in\n+// all copies or substantial portions of the Software.\n+//\n+// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n+// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n+// THE SOFTWARE.\n+package com.microsoft.identity.client.e2e.tests.mocked;\n+\n+import androidx.annotation.NonNull;\n+\n+import com.microsoft.identity.client.AuthenticationResult;\n+import com.microsoft.identity.client.IPublicClientApplication;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandAuthError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandSuccessful;\n+import com.microsoft.identity.client.e2e.shadows.ShadowDeviceCodeFlowCommandTokenError;\n+import com.microsoft.identity.client.e2e.shadows.ShadowHttpRequestForMockedTest;\n+import com.microsoft.identity.client.e2e.shadows.ShadowMsalUtils;\n+import com.microsoft.identity.client.e2e.tests.PublicClientApplicationAbstractTest;\n+import com.microsoft.identity.client.e2e.utils.RoboTestUtils;\n+import com.microsoft.identity.client.exception.MsalServiceException;\n+\n+import org.junit.Assert;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.robolectric.RobolectricTestRunner;\n+import org.robolectric.annotation.Config;\n+\n+import static com.microsoft.identity.internal.testutils.TestConstants.Configurations.SINGLE_ACCOUNT_DCF_TEST_CONFIG_FILE_PATH;\n+\n+/**\n+ * Testing class for the device code flow protocol. Currently only supporting testing for the API-side\n+ * of the protocol. Will be extended to test individual aspects of the flow.\n+ */\n+@RunWith(RobolectricTestRunner.class)\n+@Config(shadows = {ShadowMsalUtils.class, ShadowHttpRequestForMockedTest.class})\n+public class DeviceCodeFlowAPITest extends PublicClientApplicationAbstractTest {\n+\n+    private boolean mUserCodeBoolean;", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkzNDU3MQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458934571", "bodyText": "Yes that's what I'm using it for. I will rename it", "author": "t-fadura", "createdAt": "2020-07-22T16:43:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkxOTYzNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMzYxOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458923619", "bodyText": "Do we actually know if PoP is supported over DCF? Or is there a plan to support in the future?", "author": "shahzaibj", "createdAt": "2020-07-22T16:28:24Z", "path": "msal/src/main/java/com/microsoft/identity/client/internal/CommandParametersAdapter.java", "diffHunk": "@@ -193,6 +195,33 @@ public static SilentTokenCommandParameters createSilentTokenCommandParameters(\n         return commandParameters;\n     }\n \n+    public static DeviceCodeFlowCommandParameters createDeviceCodeFlowCommandParameters(\n+            @NonNull final PublicClientApplicationConfiguration configuration,\n+            @NonNull final OAuth2TokenCache tokenCache,\n+            @NonNull String[] scopes){\n+\n+        final AbstractAuthenticationScheme authenticationScheme = new BearerAuthenticationSchemeInternal();", "originalCommit": "fb58f4a82aa5c3ee0c166152eac3293c7b93731d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk0NDIwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458944203", "bodyText": "@iambmelt , @rpdome Do you know if PoP is supported over DCF or is there a plan to support it?", "author": "shahzaibj", "createdAt": "2020-07-22T16:59:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk0ODE1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458948157", "bodyText": "I think it should be supported as AuthenticationScheme only has to do with /token endpoint (unless server has a logic to restrict PoP to specific grant types and dcf is explicitly blocked)", "author": "shahzaibj", "createdAt": "2020-07-22T17:06:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2OTIzMg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459069232", "bodyText": "I guess I don't have enough context to answer this question. I agree with what you describe (that it should work, but I think we won't know for sure until we test it e2e.\nWe could add a comment (i.e. TODO here) and have that as a separate PR/ work item.", "author": "rpdome", "createdAt": "2020-07-22T20:39:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4MzY5Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459783692", "bodyText": "This is not presently supported by ESTS. PoP support for DCF is a backlog item, that said, let's not make any implementation or design decisions that preclude us from adding this support in the future", "author": "iambmelt", "createdAt": "2020-07-23T23:31:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMzYxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc4MzczNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459783735", "bodyText": "@rpdome @shahzaibj ^^", "author": "iambmelt", "createdAt": "2020-07-23T23:32:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODkyMzYxOQ=="}], "type": "inlineReview"}, {"oid": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "message": "More fixes according to suggestions", "committedDate": "2020-07-22T17:04:03Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTY2NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458951665", "bodyText": "When will these be declared in BaseController? These would need the @override annotation when that happens. I suggest opening a PR for common now to take care of that and then add the annotation here so that we don't have to open a separate PR later to address the annotation.", "author": "shahzaibj", "createdAt": "2020-07-22T17:12:06Z", "path": "msal/src/main/java/com/microsoft/identity/client/internal/controllers/BrokerMsalController.java", "diffHunk": "@@ -555,6 +557,16 @@ public void putValueInSuccessEvent(ApiEndEvent event, Boolean result) {\n                 });\n     }\n \n+    // Placeholder methods to avoid inheritance error (these methods will be declared in BaseController)\n+    // Also why the @Override annotation is missing\n+    public AuthorizationResult deviceCodeFlowAuthRequest(DeviceCodeFlowCommandParameters parameters) throws ClientException {\n+        throw new ClientException(\"deviceCodeFlowAuthRequest() not supported in BrokerMsalController\");\n+    }\n+\n+    public AcquireTokenResult acquireDeviceCodeFlowToken(AuthorizationResult authorizationResult) throws ClientException {\n+        throw new ClientException(\"deviceCodeFlowAuthRequest() not supported in BrokerMsalController\");\n+    }", "originalCommit": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MjA1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458952057", "bodyText": "Also JFYI, you will probably need to open a PR for broker (ad-accounts) as well to do the same in BrokerLocalController", "author": "shahzaibj", "createdAt": "2020-07-22T17:12:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2NzU1Mg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458967552", "bodyText": "Yes The broker code is pushed to my branch, just need to make the PR", "author": "t-fadura", "createdAt": "2020-07-22T17:38:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2ODE1Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458968157", "bodyText": "My timeline for the PR's was complete this one, then send out a Broker PR for BrokerLocalController, and then a PR to common for adding the methods to BaseController", "author": "t-fadura", "createdAt": "2020-07-22T17:39:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2ODcxOA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458968718", "bodyText": "I don't need to wait for this PR to be complete to open the broker PR. But I will need this PR and the broker PR to be complete before I can complete the next Common PR.", "author": "t-fadura", "createdAt": "2020-07-22T17:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk2OTgwMw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458969803", "bodyText": "I'm confused why it is like that. It should be the other way around i.e. you need the Common PR to be complete before you can complete this PR and the Broker PR.", "author": "shahzaibj", "createdAt": "2020-07-22T17:41:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTY2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4MTc4MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459381780", "bodyText": "If I declare new abstract methods to BaseController in Common, I'll need to implement them in the controller classes that extend BaseController. Wouldn't this mean that until the PRs for MSAL and Broker that implement these methods are pushed, the controller classes will have compilation errors? I'm trying to avoid these errors by pushing the methods in LocalMsalController and other classes first, before declaring in BaseController.", "author": "t-fadura", "createdAt": "2020-07-23T11:27:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MTY2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MjM2NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r458952365", "bodyText": "Same feedback as given above for BrokerMsalController", "author": "shahzaibj", "createdAt": "2020-07-22T17:13:20Z", "path": "msal/src/main/java/com/microsoft/identity/client/internal/controllers/LocalMSALController.java", "diffHunk": "@@ -457,4 +458,15 @@ public boolean getDeviceMode(CommandParameters parameters) throws Exception {\n     public boolean removeCurrentAccount(RemoveAccountCommandParameters parameters) throws Exception {\n         return removeAccount(parameters);\n     }\n+\n+    // Placeholder methods to avoid inheritance error (these methods will be declared in BaseController)\n+    // Also why the @Override annotation is missing\n+    public AuthorizationResult deviceCodeFlowAuthRequest(DeviceCodeFlowCommandParameters parameters) throws Exception {\n+        // TODO: Placeholder to avoid inheritance error. Will be implemented after Command/Controller level PR in Common\n+        return null;\n+    }\n+    public AcquireTokenResult acquireDeviceCodeFlowToken(AuthorizationResult authorizationResult) throws Exception {\n+        // TODO: Placeholder to avoid inheritance error. Will be implemented after Command/Controller level PR in Common\n+        return null;\n+    }", "originalCommit": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA3MTk5Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459071997", "bodyText": "+1. Should be declared in BaseController", "author": "rpdome", "createdAt": "2020-07-22T20:44:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk1MjM2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MTc0Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459061746", "bodyText": "nit: NonNull final", "author": "rpdome", "createdAt": "2020-07-22T20:25:20Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +170,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.\n+     *                 2). Receiving a successful authentication result containing a fresh access token\n+     *                 via {@link DeviceCodeFlowCallback#onTokenReceived(AuthenticationResult)}.\n+     *                 3). Receiving an exception detailing what went wrong in the protocol\n+     *                 via {@link DeviceCodeFlowCallback#onError(MsalException)}.\n+     */\n+    interface DeviceCodeFlowCallback {\n+        /**\n+         * Invoked to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message);\n+\n+        /**\n+         * Invoked once token is received and passes the {@link AuthenticationResult} object.\n+         *\n+         * @param authResult the authentication result\n+         */\n+        void onTokenReceived(AuthenticationResult authResult);", "originalCommit": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MTkzMQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459061931", "bodyText": "nit: NonNull final", "author": "rpdome", "createdAt": "2020-07-22T20:25:41Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +170,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.\n+     *                 2). Receiving a successful authentication result containing a fresh access token\n+     *                 via {@link DeviceCodeFlowCallback#onTokenReceived(AuthenticationResult)}.\n+     *                 3). Receiving an exception detailing what went wrong in the protocol\n+     *                 via {@link DeviceCodeFlowCallback#onError(MsalException)}.\n+     */\n+    interface DeviceCodeFlowCallback {\n+        /**\n+         * Invoked to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message);\n+\n+        /**\n+         * Invoked once token is received and passes the {@link AuthenticationResult} object.\n+         *\n+         * @param authResult the authentication result\n+         */\n+        void onTokenReceived(AuthenticationResult authResult);\n+\n+        /**\n+         * Invoked if an error is encountered during the device code flow and passes the exception object.\n+         *\n+         * @param error error exception\n+         */\n+        void onError(MsalException error);", "originalCommit": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MzYzNg==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459063636", "bodyText": "nit: final", "author": "rpdome", "createdAt": "2020-07-22T20:29:01Z", "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplication.java", "diffHunk": "@@ -1689,6 +1720,38 @@ public void onCancel() {\n         };\n     }\n \n+    protected DeviceCodeFlowCommandCallback getDeviceCodeFlowCommandCallback(@NonNull final DeviceCodeFlowCallback callback) {\n+        return new DeviceCodeFlowCommandCallback<LocalAuthenticationResult, MsalException>() {\n+            @Override\n+            public void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message){\n+                callback.onUserCodeReceived(vUri, userCode, message);\n+            }\n+\n+            @Override\n+            public void onTaskCompleted(LocalAuthenticationResult tokenResult) {\n+                // Convert tokenResult to an AuthenticationResult object\n+                IAuthenticationResult convertedResult = AuthenticationResultAdapter.adapt(", "originalCommit": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2MzcwNQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459063705", "bodyText": "nit: final", "author": "rpdome", "createdAt": "2020-07-22T20:29:11Z", "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplication.java", "diffHunk": "@@ -1689,6 +1720,38 @@ public void onCancel() {\n         };\n     }\n \n+    protected DeviceCodeFlowCommandCallback getDeviceCodeFlowCommandCallback(@NonNull final DeviceCodeFlowCallback callback) {\n+        return new DeviceCodeFlowCommandCallback<LocalAuthenticationResult, MsalException>() {\n+            @Override\n+            public void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message){\n+                callback.onUserCodeReceived(vUri, userCode, message);\n+            }\n+\n+            @Override\n+            public void onTaskCompleted(LocalAuthenticationResult tokenResult) {\n+                // Convert tokenResult to an AuthenticationResult object\n+                IAuthenticationResult convertedResult = AuthenticationResultAdapter.adapt(\n+                        tokenResult);\n+\n+                // Type cast the interface object\n+                AuthenticationResult authResult = (AuthenticationResult) convertedResult;", "originalCommit": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA2NDEyMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459064120", "bodyText": "nit: Add a comment that this does not support brokered authentication.", "author": "rpdome", "createdAt": "2020-07-22T20:29:55Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -84,6 +85,13 @@ void acquireToken(@NonNull final Activity activity,\n     @WorkerThread\n     IAuthenticationResult acquireTokenSilent(@NonNull final AcquireTokenSilentParameters acquireTokenSilentParameters) throws InterruptedException, MsalException;\n \n+    /**", "originalCommit": "e03ef8aef229b6117ac2e211f1dbacbbf861aaa7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "a191ae5f9ef9825c64ba2fe1cb04bf57264eedb9", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/a191ae5f9ef9825c64ba2fe1cb04bf57264eedb9", "message": "Minor fixes", "committedDate": "2020-07-23T12:21:41Z", "type": "commit"}, {"oid": "a7d9a2cbe91c2b24b92d10f188071b16dd12c666", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/a7d9a2cbe91c2b24b92d10f188071b16dd12c666", "message": "updated internal common module", "committedDate": "2020-07-23T15:11:27Z", "type": "commit"}, {"oid": "0160efd7172b279d86d79e42e2b58254ed175884", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/0160efd7172b279d86d79e42e2b58254ed175884", "message": "Added @Override annotation, added helper methods in LocalMsalController", "committedDate": "2020-07-23T18:43:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2ODc2Ng==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459768766", "bodyText": "The formatting of this javadoc looks like it might be chewed up by the code formatter :/\nCan you do actrl + alt + l on this and confirm it won't get munged? If it doesn't all good, otherwise you might want to use some <p> or <li> tags to keep it formatted properly if/when formatter is run", "author": "iambmelt", "createdAt": "2020-07-23T22:44:47Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +171,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)", "originalCommit": "0160efd7172b279d86d79e42e2b58254ed175884", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc2ODk4OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459768988", "bodyText": "Excellent javadocs here \ud83d\udc4d", "author": "iambmelt", "createdAt": "2020-07-23T22:45:21Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +171,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     *                 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     *                 via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.\n+     *                 2). Receiving a successful authentication result containing a fresh access token\n+     *                 via {@link DeviceCodeFlowCallback#onTokenReceived(AuthenticationResult)}.\n+     *                 3). Receiving an exception detailing what went wrong in the protocol\n+     *                 via {@link DeviceCodeFlowCallback#onError(MsalException)}.\n+     */\n+    interface DeviceCodeFlowCallback {\n+        /**\n+         * Invoked to display verification uri, user code, and instruction message during device code flow.\n+         *\n+         * @param vUri verification uri\n+         * @param userCode user code\n+         * @param message instruction message\n+         */\n+        void onUserCodeReceived(@NonNull String vUri, @NonNull String userCode, @NonNull String message);", "originalCommit": "0160efd7172b279d86d79e42e2b58254ed175884", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NTc3NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459775775", "bodyText": "Should we call this something like acquireTokenWithDeviceCode()? This seems to be the naming that .NET used\n/cc @jennyf19", "author": "iambmelt", "createdAt": "2020-07-23T23:06:15Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -84,6 +85,14 @@ void acquireToken(@NonNull final Activity activity,\n     @WorkerThread\n     IAuthenticationResult acquireTokenSilent(@NonNull final AcquireTokenSilentParameters acquireTokenSilentParameters) throws InterruptedException, MsalException;\n \n+    /**\n+     * Perform the Device Code Flow (DCF) protocol to allow a device without input capability to authenticate and get a new access token.\n+     * Currently, flow is only supported in local MSAL. No Broker support.\n+     * @param scopes the desired access scopes\n+     * @param callback callback object used to communicate with the API throughout the protocol\n+     */\n+    void deviceCodeFlow(@Nullable String[] scopes, @NonNull final DeviceCodeFlowCallback callback);", "originalCommit": "0160efd7172b279d86d79e42e2b58254ed175884", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg2MjM5MA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r459862390", "bodyText": "are most of your methods acquiretokenWith*? Java looks to be slightly different too.", "author": "jennyf19", "createdAt": "2020-07-24T05:46:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NTc3NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDAwODY1OA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r460008658", "bodyText": "I think that's a better name for it", "author": "t-fadura", "createdAt": "2020-07-24T11:57:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc3NTc3NQ=="}], "type": "inlineReview"}, {"oid": "8b1b5640b97cd7a2465d842e04b56a6d55458da1", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/8b1b5640b97cd7a2465d842e04b56a6d55458da1", "message": "renamed api method", "committedDate": "2020-07-24T12:06:00Z", "type": "commit"}, {"oid": "b26dd13ea284e411e9cea42a96752b0c5ec95483", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/b26dd13ea284e411e9cea42a96752b0c5ec95483", "message": "updated internal common", "committedDate": "2020-07-25T16:14:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNzk5NQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r461037995", "bodyText": "should this return MsalServiceException instead? Also may be this should go in the ExceptionAdapter class?", "author": "shahzaibj", "createdAt": "2020-07-27T17:04:26Z", "path": "msal/src/main/java/com/microsoft/identity/client/internal/controllers/LocalMSALController.java", "diffHunk": "@@ -457,4 +461,35 @@ public boolean getDeviceMode(CommandParameters parameters) throws Exception {\n     public boolean removeCurrentAccount(RemoveAccountCommandParameters parameters) throws Exception {\n         return removeAccount(parameters);\n     }\n+\n+    @Override\n+    public AuthorizationResult deviceCodeFlowAuthRequest(final DeviceCodeFlowCommandParameters parameters) throws Exception {\n+        // TODO: Placeholder to avoid inheritance error. Will be implemented after Command/Controller level PR in Common\n+        return null;\n+    }\n+\n+    @Override\n+    public AcquireTokenResult acquireDeviceCodeFlowToken(final AuthorizationResult authorizationResult, DeviceCodeFlowCommandParameters commandParameters) throws Exception {\n+        // TODO: Placeholder to avoid inheritance error. Will be implemented after Command/Controller level PR in Common\n+        return null;\n+    }\n+\n+    /**\n+     * Helper method to check if a result object is valid (was a success). If not, an exception will be generated and thrown.\n+     * @param result result object to be checked\n+     * @throws MsalServiceException MsalServiceException object reflecting error code returned by the result\n+     */\n+    private void validateServiceResult(@NonNull IResult result) throws MsalServiceException {\n+        //TODO: Will be implemented after Command/Controller level PR in Common\n+    }\n+\n+    /**\n+     * Given an error response object, create a serviceException object using the predefined error codes.\n+     * @param response error response object to be checked\n+     * @return an exception object\n+     */\n+    private ServiceException createServiceExceptionFromErrorResponse(IErrorResponse response) {", "originalCommit": "b26dd13ea284e411e9cea42a96752b0c5ec95483", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4NDEyOQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r461084129", "bodyText": "The conversion to MsalServiceException happens inside LocalMsalController. I made it return ServiceException so that it can be used in Broker later. I made it a private, local function since It's only being used for DCF currently, so placing in ExceptionAdapter may be a bit misleading.", "author": "t-fadura", "createdAt": "2020-07-27T18:24:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNzk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEwMjg4Nw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r461102887", "bodyText": "I'd suggest renaming it to be DCF-specific. (You can even remove it for now, since this is not really required in this PR).", "author": "rpdome", "createdAt": "2020-07-27T18:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNzk5NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEyMzg1Mw==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r461123853", "bodyText": "I will remove it from this PR and include it in the next one.", "author": "t-fadura", "createdAt": "2020-07-27T19:39:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTAzNzk5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5ODU0OQ==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r461098549", "bodyText": "super minor nit: put a link to the device code flow protocol here.", "author": "rpdome", "createdAt": "2020-07-27T18:51:05Z", "path": "msal/src/main/java/com/microsoft/identity/client/IPublicClientApplication.java", "diffHunk": "@@ -162,4 +171,39 @@ void acquireToken(@NonNull final Activity activity,\n         void onError(final MsalException exception);\n     }\n \n+    /**\n+     * Callback object used in Device Code Flow.\n+     * This callback provides the following methods for communicating with the protocol.\n+     * 1). Receiving authentication information (user_code, verification_uri, and instruction message)\n+     * via {@link DeviceCodeFlowCallback#onUserCodeReceived(String, String, String)}.\n+     * 2). Receiving a successful authentication result containing a fresh access token\n+     * via {@link DeviceCodeFlowCallback#onTokenReceived(AuthenticationResult)}.\n+     * 3). Receiving an exception detailing what went wrong in the protocol\n+     * via {@link DeviceCodeFlowCallback#onError(MsalException)}.\n+     */\n+    interface DeviceCodeFlowCallback {", "originalCommit": "b26dd13ea284e411e9cea42a96752b0c5ec95483", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTEzMjAzMA==", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1103#discussion_r461132030", "bodyText": "Will include in next PR", "author": "t-fadura", "createdAt": "2020-07-27T19:54:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA5ODU0OQ=="}], "type": "inlineReview"}, {"oid": "bb20b265d66ff829a23d48e38599fa7edfff1f8a", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/bb20b265d66ff829a23d48e38599fa7edfff1f8a", "message": "Removed empty private methods in LocalMsalController", "committedDate": "2020-07-27T19:38:07Z", "type": "commit"}, {"oid": "5ac0fc099596d4e19732d99bca61a87eebf35ad3", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/5ac0fc099596d4e19732d99bca61a87eebf35ad3", "message": "updated internal", "committedDate": "2020-07-27T20:00:30Z", "type": "commit"}, {"oid": "2050b057a360984f6d6ab2018979f8cb0e88a5a2", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/2050b057a360984f6d6ab2018979f8cb0e88a5a2", "message": "Merge branch 'dev' into t-fadura/dcf-main", "committedDate": "2020-07-27T20:05:26Z", "type": "commit"}]}