{"pr_number": 462, "pr_title": "Added support for model specific custom requirements.txt in mar file ", "pr_createdAt": "2020-06-16T14:24:30Z", "pr_url": "https://github.com/pytorch/serve/pull/462", "timeline": [{"oid": "a1be1b06131ad83b29bc235eb461ffe206b2600d", "url": "https://github.com/pytorch/serve/commit/a1be1b06131ad83b29bc235eb461ffe206b2600d", "message": "added requirements-file flag in model-archiver", "committedDate": "2020-06-16T04:40:17Z", "type": "commit"}, {"oid": "98b5f7079d9573fb2afd689766fd6ffc8db7edaa", "url": "https://github.com/pytorch/serve/commit/98b5f7079d9573fb2afd689766fd6ffc8db7edaa", "message": "added new config param", "committedDate": "2020-06-16T04:42:28Z", "type": "commit"}, {"oid": "d052ab8f3c8512eb84caf9269bc2f726c15a73e1", "url": "https://github.com/pytorch/serve/commit/d052ab8f3c8512eb84caf9269bc2f726c15a73e1", "message": "added intial cut for custom python dependency installation", "committedDate": "2020-06-16T04:46:39Z", "type": "commit"}, {"oid": "b85b85844c5633be2c5b21225f0d5907062289ed", "url": "https://github.com/pytorch/serve/commit/b85b85844c5633be2c5b21225f0d5907062289ed", "message": "updated existing test cases", "committedDate": "2020-06-16T04:46:55Z", "type": "commit"}, {"oid": "ee5185bbb80e8d703d5dac529945a01d04001854", "url": "https://github.com/pytorch/serve/commit/ee5185bbb80e8d703d5dac529945a01d04001854", "message": "updated java formatting", "committedDate": "2020-06-16T06:01:56Z", "type": "commit"}, {"oid": "4aec9b1414e0b9a6d11eb53ffe5c327650479331", "url": "https://github.com/pytorch/serve/commit/4aec9b1414e0b9a6d11eb53ffe5c327650479331", "message": "updated naming convention", "committedDate": "2020-06-16T06:02:27Z", "type": "commit"}, {"oid": "8f568f5a5839f3d8215331cc00c3034c897ffb56", "url": "https://github.com/pytorch/serve/commit/8f568f5a5839f3d8215331cc00c3034c897ffb56", "message": "updated manifest", "committedDate": "2020-06-16T08:51:02Z", "type": "commit"}, {"oid": "46dc016d21734e31cdf373407597144e73e8a439", "url": "https://github.com/pytorch/serve/commit/46dc016d21734e31cdf373407597144e73e8a439", "message": "generalised environment string creation method", "committedDate": "2020-06-16T09:55:59Z", "type": "commit"}, {"oid": "e633e9aee0ae5f90251ff62b0ed420e3b6938fc6", "url": "https://github.com/pytorch/serve/commit/e633e9aee0ae5f90251ff62b0ed420e3b6938fc6", "message": "refactored python dependency installation logic to model manager", "committedDate": "2020-06-16T09:56:38Z", "type": "commit"}, {"oid": "5d4178810e9f1602243b4926f28a9aa4e66064b2", "url": "https://github.com/pytorch/serve/commit/5d4178810e9f1602243b4926f28a9aa4e66064b2", "message": "added UT", "committedDate": "2020-06-16T10:07:05Z", "type": "commit"}, {"oid": "900760aae30c18d3de397d6048d022f72f31a26e", "url": "https://github.com/pytorch/serve/commit/900760aae30c18d3de397d6048d022f72f31a26e", "message": "updated java formatting", "committedDate": "2020-06-16T10:11:12Z", "type": "commit"}, {"oid": "7eea9f30fe0596f3890a50ee7f93f26048caf927", "url": "https://github.com/pytorch/serve/commit/7eea9f30fe0596f3890a50ee7f93f26048caf927", "message": "PMD fixes", "committedDate": "2020-06-16T14:17:22Z", "type": "commit"}, {"oid": "24ef238e2e4323ffab7c90bd4d1e2bed275a991d", "url": "https://github.com/pytorch/serve/commit/24ef238e2e4323ffab7c90bd4d1e2bed275a991d", "message": "added missed test mar file", "committedDate": "2020-06-16T14:18:01Z", "type": "commit"}, {"oid": "74e85b446701c03a62f7c2d9dc444b334501b585", "url": "https://github.com/pytorch/serve/commit/74e85b446701c03a62f7c2d9dc444b334501b585", "message": "moved test case with other positive test cases", "committedDate": "2020-06-16T14:18:33Z", "type": "commit"}, {"oid": "b7ce13293a7772fc8d49a486a128e1fb5dfb58e4", "url": "https://github.com/pytorch/serve/commit/b7ce13293a7772fc8d49a486a128e1fb5dfb58e4", "message": "fixed model archiver UT and IT", "committedDate": "2020-06-16T14:33:53Z", "type": "commit"}, {"oid": "0aa3d4eaee318d0b92ddb5a88e78414bffc6c20c", "url": "https://github.com/pytorch/serve/commit/0aa3d4eaee318d0b92ddb5a88e78414bffc6c20c", "message": "fixed java formatting", "committedDate": "2020-06-16T15:38:44Z", "type": "commit"}, {"oid": "96245af8eb60a7415d85d594d0bc01e23b72ce33", "url": "https://github.com/pytorch/serve/commit/96245af8eb60a7415d85d594d0bc01e23b72ce33", "message": "updated configuration doc", "committedDate": "2020-06-17T06:16:34Z", "type": "commit"}, {"oid": "3b7e7713323628408a8e8fef4aa6c6d1ec99ca6d", "url": "https://github.com/pytorch/serve/commit/3b7e7713323628408a8e8fef4aa6c6d1ec99ca6d", "message": "updated model-archiver doc", "committedDate": "2020-06-17T06:16:55Z", "type": "commit"}, {"oid": "f6547d9a3e637bffba5e20ff226b0daefea26558", "url": "https://github.com/pytorch/serve/commit/f6547d9a3e637bffba5e20ff226b0daefea26558", "message": "renamed config param and minor refactoring in code", "committedDate": "2020-06-17T07:17:43Z", "type": "commit"}, {"oid": "11c72e477df351dc55164882ca5ef6b0b7733b7b", "url": "https://github.com/pytorch/serve/commit/11c72e477df351dc55164882ca5ef6b0b7733b7b", "message": "changed parameter in UT", "committedDate": "2020-06-17T07:58:34Z", "type": "commit"}, {"oid": "bf0928961abde008c09371c35d0b8c37ddc44c4b", "url": "https://github.com/pytorch/serve/commit/bf0928961abde008c09371c35d0b8c37ddc44c4b", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-06-19T06:31:46Z", "type": "commit"}, {"oid": "229ac89268b7dab50d9ed6949d48b6c14d458daf", "url": "https://github.com/pytorch/serve/commit/229ac89268b7dab50d9ed6949d48b6c14d458daf", "message": "removed unused imports", "committedDate": "2020-06-19T06:40:40Z", "type": "commit"}, {"oid": "14d2aba23d87b1bf87e5cfeba1c029ac21cb4775", "url": "https://github.com/pytorch/serve/commit/14d2aba23d87b1bf87e5cfeba1c029ac21cb4775", "message": "added -r option for requirements file", "committedDate": "2020-06-22T05:50:10Z", "type": "commit"}, {"oid": "ee7a5d2bdce228112ef203f16ace59edf509833a", "url": "https://github.com/pytorch/serve/commit/ee7a5d2bdce228112ef203f16ace59edf509833a", "message": "updated documentation", "committedDate": "2020-06-22T15:12:57Z", "type": "commit"}, {"oid": "12aa9badd5dfa1304bea8e3e8f57f61356083b6f", "url": "https://github.com/pytorch/serve/commit/12aa9badd5dfa1304bea8e3e8f57f61356083b6f", "message": "added reference in custom_service documentation", "committedDate": "2020-06-22T15:13:33Z", "type": "commit"}, {"oid": "a98dd1dc0eeaa94a831dc764320ee4a992d93b05", "url": "https://github.com/pytorch/serve/commit/a98dd1dc0eeaa94a831dc764320ee4a992d93b05", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-06-25T16:03:52Z", "type": "commit"}, {"oid": "bf0bbea16cb553a315bf081fb9b166452ffbc996", "url": "https://github.com/pytorch/serve/commit/bf0bbea16cb553a315bf081fb9b166452ffbc996", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-06-29T15:07:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5NzQ2OQ==", "url": "https://github.com/pytorch/serve/pull/462#discussion_r447097469", "bodyText": "How about supporting custom package given as tar/zip or some dist file?", "author": "dhaniram-kshirsagar", "createdAt": "2020-06-29T16:25:18Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -152,6 +158,27 @@ private ModelArchive createModelArchive(\n         return archive;\n     }\n \n+    private void setupModelDependencies(Model model) throws IOException, InterruptedException {", "originalCommit": "bf0bbea16cb553a315bf081fb9b166452ffbc996", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY2NDkzMQ==", "url": "https://github.com/pytorch/serve/pull/462#discussion_r450664931", "bodyText": "This is already supported. Updated the documentation accordingly.", "author": "harshbafna", "createdAt": "2020-07-07T07:31:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA5NzQ2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4NTUzMw==", "url": "https://github.com/pytorch/serve/pull/462#discussion_r449185533", "bodyText": "Does this work if a custom python interpretor has been specified in the config? Wondering if <python_executable> -p pip -U -t ... would be more appropriate", "author": "maaquib", "createdAt": "2020-07-02T18:02:41Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -152,6 +158,27 @@ private ModelArchive createModelArchive(\n         return archive;\n     }\n \n+    private void setupModelDependencies(Model model) throws IOException, InterruptedException {\n+        String requirementsFile =\n+                model.getModelArchive().getManifest().getModel().getRequirementsFile();\n+\n+        if (configManager.getInstallPyDepPerModel() && requirementsFile != null) {\n+            Path requirementsFilePath =\n+                    Paths.get(model.getModelDir().getAbsolutePath(), requirementsFile);\n+\n+            String packageInstallCommand =\n+                    \"pip install -U -t \"", "originalCommit": "bf0bbea16cb553a315bf081fb9b166452ffbc996", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQxMjI4Ng==", "url": "https://github.com/pytorch/serve/pull/462#discussion_r449412286", "bodyText": "Done.", "author": "harshbafna", "createdAt": "2020-07-03T07:05:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTE4NTUzMw=="}], "type": "inlineReview"}, {"oid": "2ae94b83f3602cb3bbc73a43519cc0dd6e8303d6", "url": "https://github.com/pytorch/serve/commit/2ae94b83f3602cb3bbc73a43519cc0dd6e8303d6", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-03T05:53:22Z", "type": "commit"}, {"oid": "edf58b3e30701ec429beb321b6971f5222434513", "url": "https://github.com/pytorch/serve/commit/edf58b3e30701ec429beb321b6971f5222434513", "message": "use python runtime while executing pip install command", "committedDate": "2020-07-03T07:04:34Z", "type": "commit"}, {"oid": "00dcafd1638a37e777e7ce5fd0604ee07abd351a", "url": "https://github.com/pytorch/serve/commit/00dcafd1638a37e777e7ce5fd0604ee07abd351a", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-07T03:17:33Z", "type": "commit"}, {"oid": "53a8f07cfbfe96d9b34c8664b98c733b2a04206c", "url": "https://github.com/pytorch/serve/commit/53a8f07cfbfe96d9b34c8664b98c733b2a04206c", "message": "added model dir as the working dir for custom python package installation", "committedDate": "2020-07-07T07:29:59Z", "type": "commit"}, {"oid": "b56f2b3d2a859bc8d04417caa88385f6a27e6d30", "url": "https://github.com/pytorch/serve/commit/b56f2b3d2a859bc8d04417caa88385f6a27e6d30", "message": "updated corresponding documentation", "committedDate": "2020-07-07T07:30:19Z", "type": "commit"}, {"oid": "1e09fffa0585f0e53041a2526426fd720e9851b0", "url": "https://github.com/pytorch/serve/commit/1e09fffa0585f0e53041a2526426fd720e9851b0", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-08T04:03:07Z", "type": "commit"}, {"oid": "21df657f5b205edd838b297984ced6c26941c953", "url": "https://github.com/pytorch/serve/commit/21df657f5b205edd838b297984ced6c26941c953", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-15T05:48:10Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMTMzNg==", "url": "https://github.com/pytorch/serve/pull/462#discussion_r455611336", "bodyText": "@harshbafna How are failure cases handled? eg wrong name of package in the requirements.txt or a package that takes very long to download from internet / fails to download. How are those errors handled? Further errors need to be handled gracefully and make sure that rest of TorchServe / workers do not crash.\nAnd for models with multiple worker threads, the download should happen only once", "author": "chauhang", "createdAt": "2020-07-16T08:22:48Z", "path": "frontend/server/src/main/java/org/pytorch/serve/wlm/ModelManager.java", "diffHunk": "@@ -152,6 +158,35 @@ private ModelArchive createModelArchive(\n         return archive;\n     }\n \n+    private void setupModelDependencies(Model model) throws IOException, InterruptedException {\n+        String requirementsFile =\n+                model.getModelArchive().getManifest().getModel().getRequirementsFile();\n+\n+        if (configManager.getInstallPyDepPerModel() && requirementsFile != null) {\n+            Path requirementsFilePath =\n+                    Paths.get(model.getModelDir().getAbsolutePath(), requirementsFile);\n+\n+            String pythonRuntime = EnvironmentUtils.getPythonRunTime(model);\n+\n+            String packageInstallCommand =\n+                    pythonRuntime\n+                            + \" -m pip install -U -t \"\n+                            + model.getModelDir().getAbsolutePath()\n+                            + \" -r \"\n+                            + requirementsFilePath; // NOPMD\n+\n+            String[] envp =\n+                    EnvironmentUtils.getEnvString(configManager.getModelServerHome(), null, null);\n+            Process process =\n+                    Runtime.getRuntime()", "originalCommit": "21df657f5b205edd838b297984ced6c26941c953", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTc4ODU2NA==", "url": "https://github.com/pytorch/serve/pull/462#discussion_r455788564", "bodyText": "@chauhang\n\nHow are failure cases handled? eg wrong name of package in the requirements.txt\n\nAdded error handling in case the pip install fails. Added corresponding UT as well.\n\na package that takes very long to download from internet / fails to download\n\nThe model registration request is synchronous and there is no defined timeout. In case the download fails, then the pip command will fail and TorchServe will return an error message to the client.\n\nAnd for models with multiple worker threads, the download should happen only once\n\nThe installation of the custom packages happens at the time of model registration in a temporary directory where the model archive is extracted. This path is then added to the PYTHONPATH and is passed on to the workers at the time of worker creation.", "author": "harshbafna", "createdAt": "2020-07-16T13:32:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTYxMTMzNg=="}], "type": "inlineReview"}, {"oid": "3842c49524a5926e29b6a8f83b8185976e6d3daf", "url": "https://github.com/pytorch/serve/commit/3842c49524a5926e29b6a8f83b8185976e6d3daf", "message": "added error response in case pip install command fails", "committedDate": "2020-07-16T12:50:36Z", "type": "commit"}, {"oid": "c4edf50baf3875a46df222188f48ba4e72b336ef", "url": "https://github.com/pytorch/serve/commit/c4edf50baf3875a46df222188f48ba4e72b336ef", "message": "added negative test case for invalid requirements.txt", "committedDate": "2020-07-16T12:51:11Z", "type": "commit"}, {"oid": "d0dcfd3aaf6ff776809008bd2f088bc4fad70790", "url": "https://github.com/pytorch/serve/commit/d0dcfd3aaf6ff776809008bd2f088bc4fad70790", "message": "updated UT dependency order", "committedDate": "2020-07-16T13:31:59Z", "type": "commit"}, {"oid": "7ac8bd38592f97615670ccd7a52e19abd2947ff6", "url": "https://github.com/pytorch/serve/commit/7ac8bd38592f97615670ccd7a52e19abd2947ff6", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-18T01:56:04Z", "type": "commit"}, {"oid": "8a8bf17ccff7cb0009630b3649b386b25b4f8675", "url": "https://github.com/pytorch/serve/commit/8a8bf17ccff7cb0009630b3649b386b25b4f8675", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-22T12:53:11Z", "type": "commit"}, {"oid": "f7358aaf057eaf1d9c34fba627c2b5b878c10751", "url": "https://github.com/pytorch/serve/commit/f7358aaf057eaf1d9c34fba627c2b5b878c10751", "message": "removed unused code", "committedDate": "2020-07-22T13:00:42Z", "type": "commit"}, {"oid": "020496c6b03ea159e908968d11ef52609e15c997", "url": "https://github.com/pytorch/serve/commit/020496c6b03ea159e908968d11ef52609e15c997", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-22T15:06:57Z", "type": "commit"}, {"oid": "0688e205a4ec732d7a004075312b0a7de119ff47", "url": "https://github.com/pytorch/serve/commit/0688e205a4ec732d7a004075312b0a7de119ff47", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-22T23:09:10Z", "type": "commit"}, {"oid": "69ee5d23dca98063e01a22dd4a93cabf9723543d", "url": "https://github.com/pytorch/serve/commit/69ee5d23dca98063e01a22dd4a93cabf9723543d", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-23T03:08:41Z", "type": "commit"}, {"oid": "7cfc4e8cb8dcb8d9fc9afcb8dd541a49be57ca36", "url": "https://github.com/pytorch/serve/commit/7cfc4e8cb8dcb8d9fc9afcb8dd541a49be57ca36", "message": "Merge branch 'master' into issue_370", "committedDate": "2020-07-23T15:52:50Z", "type": "commit"}]}