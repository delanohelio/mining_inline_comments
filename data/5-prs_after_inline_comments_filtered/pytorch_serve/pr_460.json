{"pr_number": 460, "pr_title": "Adding Prometheus metrics framework", "pr_createdAt": "2020-06-15T19:57:03Z", "pr_url": "https://github.com/pytorch/serve/pull/460", "timeline": [{"oid": "5458303a7fa81a2a9f05c92b10f71e5d6e4624ef", "url": "https://github.com/pytorch/serve/commit/5458303a7fa81a2a9f05c92b10f71e5d6e4624ef", "message": "Test Prometheus client with sample metrics", "committedDate": "2020-06-17T02:34:37Z", "type": "forcePushed"}, {"oid": "b06ec7d144c37fa7c240cfe4e8eb200671b0689e", "url": "https://github.com/pytorch/serve/commit/b06ec7d144c37fa7c240cfe4e8eb200671b0689e", "message": "Test Prometheus client with sample metrics", "committedDate": "2020-06-17T02:44:17Z", "type": "forcePushed"}, {"oid": "a7e94b7a842627b9234795451b1b0cf30c210d70", "url": "https://github.com/pytorch/serve/commit/a7e94b7a842627b9234795451b1b0cf30c210d70", "message": "Test Prometheus client with sample metrics", "committedDate": "2020-06-17T03:07:49Z", "type": "commit"}, {"oid": "a7e94b7a842627b9234795451b1b0cf30c210d70", "url": "https://github.com/pytorch/serve/commit/a7e94b7a842627b9234795451b1b0cf30c210d70", "message": "Test Prometheus client with sample metrics", "committedDate": "2020-06-17T03:07:49Z", "type": "forcePushed"}, {"oid": "395114153374042ec94c0295df23b60772d8c90d", "url": "https://github.com/pytorch/serve/commit/395114153374042ec94c0295df23b60772d8c90d", "message": "Merge branch 'master' into prometheus", "committedDate": "2020-06-29T18:37:18Z", "type": "commit"}, {"oid": "ce86d9bc23a562ceb4480ac2aad1355ece9e4e1d", "url": "https://github.com/pytorch/serve/commit/ce86d9bc23a562ceb4480ac2aad1355ece9e4e1d", "message": "Merge branch 'master' into prometheus", "committedDate": "2020-07-02T19:35:17Z", "type": "commit"}, {"oid": "f4df217373272834e34d57b47f410acc13bd7e8d", "url": "https://github.com/pytorch/serve/commit/f4df217373272834e34d57b47f410acc13bd7e8d", "message": "Merge branch 'master' into prometheus", "committedDate": "2020-07-06T22:29:15Z", "type": "commit"}, {"oid": "adcd8ec4937c7210b433c30c7ce499d7b60149b7", "url": "https://github.com/pytorch/serve/commit/adcd8ec4937c7210b433c30c7ce499d7b60149b7", "message": "Merge branch 'master' into prometheus", "committedDate": "2020-07-08T17:42:40Z", "type": "commit"}, {"oid": "9e23a01b4bdee46305a7256c92efbc47335f0011", "url": "https://github.com/pytorch/serve/commit/9e23a01b4bdee46305a7256c92efbc47335f0011", "message": "Updated documentation and additional labels for model metrics", "committedDate": "2020-07-09T01:06:56Z", "type": "commit"}, {"oid": "a0537a93b4b56b5d1d99e62491f57485b1f9d17c", "url": "https://github.com/pytorch/serve/commit/a0537a93b4b56b5d1d99e62491f57485b1f9d17c", "message": "Updated inference unit tests to check for metrics; Added openapi docs", "committedDate": "2020-07-09T21:48:12Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwOTgxNg==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r452609816", "bodyText": "should be EndpointTypes.METRICS", "author": "harshbafna", "createdAt": "2020-07-10T03:59:17Z", "path": "frontend/server/src/main/java/org/pytorch/serve/servingsdk/impl/PluginsManager.java", "diffHunk": "@@ -68,11 +70,20 @@ private boolean validateEndpointPlugin(Annotation a, EndpointTypes type) {\n         return getEndpoints(EndpointTypes.MANAGEMENT);\n     }\n \n+    private HashMap<String, ModelServerEndpoint> initMetricsEndpoints() {\n+        // TODO: Change to METRICS after fixing serving-sdk dependency\n+        return getEndpoints(EndpointTypes.MANAGEMENT);", "originalCommit": "a0537a93b4b56b5d1d99e62491f57485b1f9d17c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA2OTk4Mw==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453069983", "bodyText": "Yes. I have tested that with localMaven repo and EndpointTypes.METRICS. But the serving-sdk dependency in torchserve is pulled from JCenter. We need to publish a new version with the sdk changes. I'll separate this PR out into two separate ones", "author": "maaquib", "createdAt": "2020-07-10T20:47:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwOTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQxOTQyNg==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453419426", "bodyText": "Please add a ticket to update and re-publish the sdk.", "author": "harshbafna", "createdAt": "2020-07-13T03:45:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwOTgxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2NTYxMw==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453865613", "bodyText": "Create PR #530", "author": "maaquib", "createdAt": "2020-07-13T19:00:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYwOTgxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMDYyNw==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r452610627", "bodyText": "ssl port for metric endpoint?", "author": "harshbafna", "createdAt": "2020-07-10T04:03:16Z", "path": "frontend/server/src/main/java/org/pytorch/serve/util/Connector.java", "diffHunk": "@@ -97,18 +97,23 @@ public static Connector parse(String binding, boolean management) {\n         boolean ssl = \"https\".equalsIgnoreCase(protocol);\n         int port;\n         if (listeningPort == null) {\n-            if (management) {\n-                port = ssl ? 8444 : 8081;\n-            } else {\n-                port = ssl ? 443 : 80;\n+            switch (connectorType) {\n+                case MANAGEMENT_CONNECTOR:\n+                    port = ssl ? 8444 : 8081;\n+                    break;\n+                case METRICS_CONNECTOR:\n+                    port = 8082;", "originalCommit": "a0537a93b4b56b5d1d99e62491f57485b1f9d17c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1MjI3NA==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453052274", "bodyText": "Done", "author": "maaquib", "createdAt": "2020-07-10T20:01:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMDYyNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMTExMw==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r452611113", "bodyText": "can we change this to ALL and use the same during server initialization?", "author": "harshbafna", "createdAt": "2020-07-10T04:05:54Z", "path": "frontend/server/src/main/java/org/pytorch/serve/util/ConnectorType.java", "diffHunk": "@@ -3,5 +3,6 @@\n public enum ConnectorType {\n     INFERENCE_CONNECTOR,\n     MANAGEMENT_CONNECTOR,\n+    METRICS_CONNECTOR,\n     BOTH", "originalCommit": "a0537a93b4b56b5d1d99e62491f57485b1f9d17c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzAxOTI4NA==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453019284", "bodyText": "This is used in UTs and a few other classes for getting the different channels for the connectors", "author": "maaquib", "createdAt": "2020-07-10T18:51:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMTExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQyMDAxOA==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453420018", "bodyText": "Can't we use ALL instead of BOTH and initialize all three channels using this keyword? BOTH now looks a bit odd here.", "author": "harshbafna", "createdAt": "2020-07-13T03:47:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMTExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzc3ODYxOA==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453778618", "bodyText": "Ah, I see what you meant. Will do", "author": "maaquib", "createdAt": "2020-07-13T16:33:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMTExMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg2NTczOA==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453865738", "bodyText": "Done", "author": "maaquib", "createdAt": "2020-07-13T19:00:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxMTExMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxNDkwNA==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r452614904", "bodyText": "Add UTs for all types of parameters supported by the metrics API.", "author": "harshbafna", "createdAt": "2020-07-10T04:24:11Z", "path": "frontend/server/src/test/java/org/pytorch/serve/ModelServerTest.java", "diffHunk": "@@ -1541,6 +1564,16 @@ private void testPredictions(String modelName, String expectedOutput, String ver\n \n         TestUtils.getLatch().await();\n         Assert.assertEquals(TestUtils.getResult(), expectedOutput);\n+\n+        Channel metricsChannel = TestUtils.getMetricsChannel(configManager);\n+        TestUtils.setResult(null);\n+        TestUtils.setLatch(new CountDownLatch(1));\n+        DefaultFullHttpRequest metricsReq =\n+                new DefaultFullHttpRequest(HttpVersion.HTTP_1_1, HttpMethod.GET, \"/metrics\");\n+        metricsChannel.writeAndFlush(metricsReq);\n+        TestUtils.getLatch().await();\n+        Pattern inferLatencyMatcher = TestUtils.getTSInferLatencyMatcher(modelName, version);\n+        Assert.assertTrue(inferLatencyMatcher.matcher(TestUtils.getResult()).find());", "originalCommit": "a0537a93b4b56b5d1d99e62491f57485b1f9d17c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzA1MjU2MQ==", "url": "https://github.com/pytorch/serve/pull/460#discussion_r453052561", "bodyText": "Done", "author": "maaquib", "createdAt": "2020-07-10T20:02:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxNDkwNA=="}], "type": "inlineReview"}, {"oid": "ae6653ff97162d5f9c0b1f5fdc4a9add24c575a7", "url": "https://github.com/pytorch/serve/commit/ae6653ff97162d5f9c0b1f5fdc4a9add24c575a7", "message": "Addressed review comments", "committedDate": "2020-07-10T19:53:30Z", "type": "commit"}, {"oid": "1adf55bda46bd47b8184dde6686515ab80f41c25", "url": "https://github.com/pytorch/serve/commit/1adf55bda46bd47b8184dde6686515ab80f41c25", "message": "Added POSTMAN regression tests for metrics", "committedDate": "2020-07-10T23:20:31Z", "type": "commit"}, {"oid": "6b5429ab1803bd5f468b466518bb4a69ec3dbb9b", "url": "https://github.com/pytorch/serve/commit/6b5429ab1803bd5f468b466518bb4a69ec3dbb9b", "message": "Update connecter types", "committedDate": "2020-07-13T18:51:24Z", "type": "commit"}, {"oid": "7be322f5ed63eb82a77621a2f919603f5bdc2244", "url": "https://github.com/pytorch/serve/commit/7be322f5ed63eb82a77621a2f919603f5bdc2244", "message": "Bumping serving-sdk dependency", "committedDate": "2020-07-13T19:05:16Z", "type": "commit"}, {"oid": "02b15d21de8603db4e84613afa03bbbc9b259c44", "url": "https://github.com/pytorch/serve/commit/02b15d21de8603db4e84613afa03bbbc9b259c44", "message": "Dropping metrics plugins support for now", "committedDate": "2020-07-15T00:30:36Z", "type": "commit"}, {"oid": "02b15d21de8603db4e84613afa03bbbc9b259c44", "url": "https://github.com/pytorch/serve/commit/02b15d21de8603db4e84613afa03bbbc9b259c44", "message": "Dropping metrics plugins support for now", "committedDate": "2020-07-15T00:30:36Z", "type": "forcePushed"}, {"oid": "2d61b01fa8902fc878c297ea47c71a1268be6405", "url": "https://github.com/pytorch/serve/commit/2d61b01fa8902fc878c297ea47c71a1268be6405", "message": "Merge branch 'master' into prometheus", "committedDate": "2020-08-05T14:30:29Z", "type": "commit"}, {"oid": "e1a98460d62b6280c9a43e0ae3b2b1d7afec5276", "url": "https://github.com/pytorch/serve/commit/e1a98460d62b6280c9a43e0ae3b2b1d7afec5276", "message": "Fixed erroneous test cases", "committedDate": "2020-08-05T15:05:06Z", "type": "commit"}, {"oid": "05ed90f27f1a38dbd3853ea1fbdfadd970b84b17", "url": "https://github.com/pytorch/serve/commit/05ed90f27f1a38dbd3853ea1fbdfadd970b84b17", "message": "added flag to enable or disable prometheous metric api", "committedDate": "2020-08-06T07:04:41Z", "type": "commit"}, {"oid": "fac2495793acc3aaadaf97524d4a08110299781a", "url": "https://github.com/pytorch/serve/commit/fac2495793acc3aaadaf97524d4a08110299781a", "message": "Adding missing file", "committedDate": "2020-08-06T07:48:41Z", "type": "commit"}, {"oid": "109a77f9fb4116cb1b5f97c5acfe09291fa0e1fa", "url": "https://github.com/pytorch/serve/commit/109a77f9fb4116cb1b5f97c5acfe09291fa0e1fa", "message": "doc changes and fixed typo", "committedDate": "2020-08-07T19:20:14Z", "type": "commit"}, {"oid": "15255ed4ff40bb4d81f8df9f22a614e88056487f", "url": "https://github.com/pytorch/serve/commit/15255ed4ff40bb4d81f8df9f22a614e88056487f", "message": "Update configuration.md\n\nmade section for new params related to metric", "committedDate": "2020-08-07T19:23:42Z", "type": "commit"}, {"oid": "a09e1c39b1843e1d3c6087e76383e46e177248fa", "url": "https://github.com/pytorch/serve/commit/a09e1c39b1843e1d3c6087e76383e46e177248fa", "message": "Update metrics_api.md", "committedDate": "2020-08-07T19:25:15Z", "type": "commit"}, {"oid": "994ad38a53e0d4330b02215d750f15ec1bf414f5", "url": "https://github.com/pytorch/serve/commit/994ad38a53e0d4330b02215d750f15ec1bf414f5", "message": "Update MetricAggregator.java\n\nFixed constant name", "committedDate": "2020-08-07T19:27:40Z", "type": "commit"}, {"oid": "331689b076fa84ff313abcf7fd1d0c6c17fb4a9d", "url": "https://github.com/pytorch/serve/commit/331689b076fa84ff313abcf7fd1d0c6c17fb4a9d", "message": "Merge pull request #3 from maaquib/prometheous_optional\n\nadded flag to enable or disable prometheous metric api", "committedDate": "2020-08-07T23:47:15Z", "type": "commit"}, {"oid": "767fb2a4fa8b0335d5f0494db2630207c102e5c8", "url": "https://github.com/pytorch/serve/commit/767fb2a4fa8b0335d5f0494db2630207c102e5c8", "message": "Merge branch 'master' into prometheus", "committedDate": "2020-08-07T23:49:21Z", "type": "commit"}]}