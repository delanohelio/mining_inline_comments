{"pr_number": 2365, "pr_title": "Fail fast on non serialized access to Sink", "pr_createdAt": "2020-09-08T11:46:02Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2365", "timeline": [{"oid": "eef71122415eec8227ce4957426cbd3231553970", "url": "https://github.com/reactor/reactor-core/commit/eef71122415eec8227ce4957426cbd3231553970", "message": "WIP: do not queue non-serialized emissions in `SerializedManySink`", "committedDate": "2020-09-01T09:05:52Z", "type": "commit"}, {"oid": "6eaefb1061daf43b739fa353d242c1808895441d", "url": "https://github.com/reactor/reactor-core/commit/6eaefb1061daf43b739fa353d242c1808895441d", "message": "improve the stress test", "committedDate": "2020-09-01T12:01:43Z", "type": "commit"}, {"oid": "0ffc09742637435f7f54339598b18e7daf654480", "url": "https://github.com/reactor/reactor-core/commit/0ffc09742637435f7f54339598b18e7daf654480", "message": "Merge branch 'master' into fail_fast_on_non_serialized_access", "committedDate": "2020-09-03T14:54:29Z", "type": "commit"}, {"oid": "7c9291c11efbdc8aeb523c038b772d384268acee", "url": "https://github.com/reactor/reactor-core/commit/7c9291c11efbdc8aeb523c038b772d384268acee", "message": "remove wip, add the Thread check", "committedDate": "2020-09-07T15:48:01Z", "type": "commit"}, {"oid": "10bf0606426000f39b04b36069082455da41bd24", "url": "https://github.com/reactor/reactor-core/commit/10bf0606426000f39b04b36069082455da41bd24", "message": "use `onBackpressureBuffer()` in `Flux{Retry,Repeat}When`", "committedDate": "2020-09-08T11:06:58Z", "type": "commit"}, {"oid": "a2084f4abc8fad5dcb0b68815ac7d247a16d916f", "url": "https://github.com/reactor/reactor-core/commit/a2084f4abc8fad5dcb0b68815ac7d247a16d916f", "message": "fix `UnicastProcessorTest`", "committedDate": "2020-09-08T11:07:10Z", "type": "commit"}, {"oid": "a748445e17cfd82f7d2a8df07c16223648dc9c88", "url": "https://github.com/reactor/reactor-core/commit/a748445e17cfd82f7d2a8df07c16223648dc9c88", "message": "fix the error", "committedDate": "2020-09-08T11:43:42Z", "type": "commit"}, {"oid": "06ea9e282b60305435bb38e6ef44c186ac253e8b", "url": "https://github.com/reactor/reactor-core/commit/06ea9e282b60305435bb38e6ef44c186ac253e8b", "message": "Add missing license header", "committedDate": "2020-09-08T11:45:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3NTM3OA==", "url": "https://github.com/reactor/reactor-core/pull/2365#discussion_r484875378", "bodyText": "onBackpressureError() was wrongly used and fails the same way in master if the queue is removed (e.g. by using many().unsafe()", "author": "bsideup", "createdAt": "2020-09-08T12:25:55Z", "path": "reactor-core/src/main/java/reactor/core/publisher/FluxRepeatWhen.java", "diffHunk": "@@ -211,7 +211,7 @@ public Object scanUnsafe(Attr key) {\n \n \t\tRepeatWhenMainSubscriber<?> main;\n \n-\t\tfinal Sinks.Many<Long> completionSignal = Sinks.many().multicast().onBackpressureError();\n+\t\tfinal Sinks.Many<Long> completionSignal = Sinks.many().multicast().onBackpressureBuffer();", "originalCommit": "06ea9e282b60305435bb38e6ef44c186ac253e8b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwNDczOQ==", "url": "https://github.com/reactor/reactor-core/pull/2365#discussion_r486304739", "bodyText": "could we maybe loop (maybe with a parkNanos(10) or something) in order to at least ensure that emitXxx methods don't require external synchronization?", "author": "simonbasle", "createdAt": "2020-09-10T12:43:19Z", "path": "reactor-core/src/main/java/reactor/core/publisher/SinksSpecs.java", "diffHunk": "@@ -125,12 +128,26 @@ public void emitNext(T value) {\n \t\t\t\temitError(ex);\n \t\t\t\tOperators.onDiscard(value, currentContext());\n \t\t\t\tbreak;\n+\t\t\t}\n \t\t\tcase FAIL_CANCELLED:\n \t\t\t\tOperators.onDiscard(value, currentContext());\n \t\t\t\tbreak;\n \t\t\tcase FAIL_TERMINATED:\n \t\t\t\tOperators.onNextDropped(value, currentContext());\n \t\t\t\tbreak;\n+\t\t\tcase FAIL_NON_SERIALIZED: {", "originalCommit": "06ea9e282b60305435bb38e6ef44c186ac253e8b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwNjA5MA==", "url": "https://github.com/reactor/reactor-core/pull/2365#discussion_r486306090", "bodyText": "Unfortunately we can't, otherwise we may introduce an infinite loop. We could retry it once, but IMO if retries are desired, tryEmitXxx should be used instead.", "author": "bsideup", "createdAt": "2020-09-10T12:45:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwNDczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMwNTQyNg==", "url": "https://github.com/reactor/reactor-core/pull/2365#discussion_r486305426", "bodyText": "we'll need to document that fail fast behavior everywhere we pretend that Sinks are by default safe to use from multiple threads (mainly in various places of Sinks.java javadocs)", "author": "simonbasle", "createdAt": "2020-09-10T12:44:31Z", "path": "reactor-core/src/main/java/reactor/core/publisher/SinksSpecs.java", "diffHunk": "@@ -81,16 +77,23 @@ public final Emission tryEmitComplete() {\n \t\tif (done) {\n \t\t\treturn Sinks.Emission.FAIL_TERMINATED;\n \t\t}\n+\t\tThread lockedAt = this.lockedAt;\n+\t\tif (!(lockedAt == null || lockedAt == Thread.currentThread())) {\n+\t\t\treturn Emission.FAIL_NON_SERIALIZED;", "originalCommit": "06ea9e282b60305435bb38e6ef44c186ac253e8b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}