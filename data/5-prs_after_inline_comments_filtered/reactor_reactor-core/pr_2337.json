{"pr_number": 2337, "pr_title": "fix #2312 add user provided state to Retry", "pr_createdAt": "2020-08-20T08:59:24Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2337", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyNzkxMQ==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r473927911", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tpublic ContextView retryContext() {return retryContext;}\n          \n          \n            \n            \tpublic ContextView retryContext() {\n          \n          \n            \n            \t\treturn retryContext;\n          \n          \n            \n            \t}", "author": "bsideup", "createdAt": "2020-08-20T12:21:06Z", "path": "reactor-core/src/main/java/reactor/util/retry/Retry.java", "diffHunk": "@@ -60,6 +68,10 @@\n \t */\n \tpublic abstract Publisher<?> generateCompanion(Flux<RetrySignal> retrySignals);\n \n+\n+\tpublic ContextView retryContext() {return retryContext;}", "originalCommit": "ea4e330bcb7e47a61a9e90ca5436c8bed9d38d65", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyODUxMg==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r473928512", "bodyText": "Could you also please clarify retryContextView() vs retryContext()?", "author": "bsideup", "createdAt": "2020-08-20T12:22:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyNzkxMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODQ2MTMwMg==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r478461302", "bodyText": "I added a comment on Retry.retryContext().\nWe could also decide to rename RetrySignal.retryContextView() -> RetrySignal.retryContext(), let me know what you think.", "author": "ericbottard", "createdAt": "2020-08-27T14:27:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzkyNzkxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNzM4MA==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r481017380", "bodyText": "the same test should probably be added with a Retry.backoff (ie. using a RetryBackoffSpec instead of a RetrySpec) for good measure.", "author": "simonbasle", "createdAt": "2020-09-01T09:58:13Z", "path": "reactor-core/src/test/java/reactor/core/publisher/FluxRetryWhenTest.java", "diffHunk": "@@ -577,13 +577,43 @@ public void inners() {\n \t\tSinks.Many<Retry.RetrySignal> signaller = Sinks.many().multicast().onBackpressureError();\n \t\tFlux<Integer> when = Flux.empty();\n \t\tFluxRetryWhen.RetryWhenMainSubscriber<Integer> main = new FluxRetryWhen\n-\t\t\t\t.RetryWhenMainSubscriber<>(actual, signaller, when);\n+\t\t\t\t.RetryWhenMainSubscriber<>(actual, signaller, when, Context.empty());\n \n \t\tList<Scannable> inners = main.inners().collect(Collectors.toList());\n \n \t\tassertThat(inners).containsExactly((Scannable) signaller, main.otherArbiter);\n \t}\n \n+\t@Test\n+\tpublic void retryContextExposedOnRetrySignal() {", "originalCommit": "1c95e2f52f1dafa85bce9327a1e70c6213fe2ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA4NDA4Mg==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482084082", "bodyText": "One could argue that's not the spirit of the test: given the discussion above below\u2b07\ufe0f about the fact that the context is borne by Retry, this works by design.\nAdding a test about backoff would only test that the context is correctly copied over when builder methods are used (but then this is a different kind of test, with many combinations that we don't have for other fields either).\nWDYT?", "author": "ericbottard", "createdAt": "2020-09-02T13:50:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNzM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyODE0Mg==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482828142", "bodyText": "ok, maybe not duplicating the full test. I would maybe just test both constructors to ensure the retry context is passed to super ctor in both flavors of specs, wdyt?", "author": "simonbasle", "createdAt": "2020-09-03T09:10:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNzM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkwNTI0NQ==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482905245", "bodyText": "Have a look at ff3aed1 and let me know what you think", "author": "ericbottard", "createdAt": "2020-09-03T11:25:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNzM4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjkyOTI1MA==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482929250", "bodyText": "\ud83d\udc4d", "author": "simonbasle", "createdAt": "2020-09-03T12:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxNzM4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxOTg1NA==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r481019854", "bodyText": "I was wondering if we should add retryContext directly to Retry like that. Alternatively we could isolate the feature to RetrySpec and RetryBackoffSpec, injecting the ContextView into the ImmutableRetrySignal they expose to the companion publisher they create (since it is already a .copy())...\nThat said, the idea of the feature leaks into RetrySignal interface anyway, so it could be argued that it must be enforced at Retry level.\nAt a minimum, Retry no-arg constructor should be maintained though. This adding of a protected ctor introduces a breaking change that we can avoid.", "author": "simonbasle", "createdAt": "2020-09-01T10:02:47Z", "path": "reactor-core/src/main/java/reactor/util/retry/Retry.java", "diffHunk": "@@ -47,6 +49,12 @@\n  */\n public abstract class Retry {\n \n+\tprivate final ContextView retryContext;", "originalCommit": "1c95e2f52f1dafa85bce9327a1e70c6213fe2ac9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2MjM5OA==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482062398", "bodyText": "I was wondering if we should add retryContext directly to Retry like that. Alternatively we could isolate the feature to RetrySpec and RetryBackoffSpec, injecting the ContextView into the ImmutableRetrySignal they expose to the companion publisher they create (since it is already a .copy())...\n\nWe had that questioning with @aneveu but the issue is this: Retry exists so that users can bring their own, and the framework only knows about Retry when it creates RetrySignals, so the context has to belong to Retry (and RetrySignal).\n\nAt a minimum, Retry no-arg constructor should be maintained though. This adding of a protected ctor introduces a breaking change that we can avoid.\n\nwill do", "author": "ericbottard", "createdAt": "2020-09-02T13:20:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA2Mzg0OQ==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482063849", "bodyText": "This adding of a protected ctor introduces a breaking change that we can avoid.\n\nBTW, wondering why japicmp did not detect that...", "author": "ericbottard", "createdAt": "2020-09-02T13:22:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjA3ODMxNA==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482078314", "bodyText": "Oh, but we have Retry on branch 3.3.x but not in 3.3.0.RELEASE, that is why...", "author": "ericbottard", "createdAt": "2020-09-02T13:42:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxOTg1NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyMDM1Ng==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482820356", "bodyText": "Oh, but we have Retry on branch 3.3.x but not in 3.3.0.RELEASE, that is why...\n\nAh damn!\n\nThe framework only knows about Retry when it creates RetrySignals, so the context has to belong to Retry (and RetrySignal).\n\nYeah I saw that... RetryContext is a bit different from all the other spec parameters, in the sense that it affects the RetrySignal, so yeah it must mean it has to live in Retry directly.", "author": "simonbasle", "createdAt": "2020-09-03T08:59:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTAxOTg1NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MDgyNA==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r481040824", "bodyText": "format: missing newline", "author": "simonbasle", "createdAt": "2020-09-01T10:34:35Z", "path": "reactor-core/src/main/java/reactor/util/retry/ImmutableRetrySignal.java", "diffHunk": "@@ -27,12 +30,18 @@\n \tfinal long      failureTotalIndex;\n \tfinal long      failureSubsequentIndex;\n \tfinal Throwable failure;\n+\tfinal ContextView retryContext;\n \n \tImmutableRetrySignal(long failureTotalIndex, long failureSubsequentIndex,\n \t\t\tThrowable failure) {\n+\t\tthis(failureTotalIndex, failureSubsequentIndex, failure, Context.empty());\n+\t}", "originalCommit": "1c95e2f52f1dafa85bce9327a1e70c6213fe2ac9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTA0MDk1NA==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r481040954", "bodyText": "nitpick format: unnecessary newline", "author": "simonbasle", "createdAt": "2020-09-01T10:34:53Z", "path": "reactor-core/src/main/java/reactor/core/publisher/FluxRetryWhen.java", "diffHunk": "@@ -113,12 +114,15 @@ public Object scanUnsafe(Attr key) {\n \t\t\n \t\tRetryWhenMainSubscriber(CoreSubscriber<? super T> actual,\n \t\t\t\tSinks.Many<Retry.RetrySignal> signaller,\n-\t\t\t\tCorePublisher<? extends T> source) {\n+\t\t\t\tCorePublisher<? extends T> source,\n+\t\t\t\tContextView retryContext) {\n \t\t\tsuper(actual);\n \t\t\tthis.signaller = signaller;\n \t\t\tthis.source = source;\n \t\t\tthis.otherArbiter = new Operators.DeferredSubscription();\n \t\t\tthis.context = actual.currentContext();\n+", "originalCommit": "1c95e2f52f1dafa85bce9327a1e70c6213fe2ac9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4821114aa1c19cef4a054a44b15bfce9098ec54c", "url": "https://github.com/reactor/reactor-core/commit/4821114aa1c19cef4a054a44b15bfce9098ec54c", "message": "Review: fix formatting issues", "committedDate": "2020-09-02T13:51:49Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNTAzMw==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482825033", "bodyText": "I'm still unsure about that one. should it be retryContextView()? or even simpler, context()? (as Retry implementors are less likely to implement stuff that is unrelated to retries, unlike eg. RetrySignal). In the end, I think I like the simplicity of retryContext() though...", "author": "simonbasle", "createdAt": "2020-09-03T09:06:53Z", "path": "reactor-core/src/main/java/reactor/util/retry/Retry.java", "diffHunk": "@@ -60,6 +72,16 @@\n \t */\n \tpublic abstract Publisher<?> generateCompanion(Flux<RetrySignal> retrySignals);\n \n+\t/**\n+\t * Return the user provided context that was set at construction time.\n+\t *\n+\t * @return the user provided context that will be accessible via {@link RetrySignal#retryContextView()}.\n+\t */\n+\tpublic ContextView retryContext() {", "originalCommit": "4821114aa1c19cef4a054a44b15bfce9098ec54c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNTcyMQ==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482825721", "bodyText": "I would say \"reset/rollbacked or otherwise mutated before or after a retry\"", "author": "simonbasle", "createdAt": "2020-09-03T09:07:55Z", "path": "reactor-core/src/main/java/reactor/util/retry/Retry.java", "diffHunk": "@@ -92,6 +114,16 @@\n \t\t */\n \t\tThrowable failure();\n \n+\t\t/**\n+\t\t * Return a read-only view of the user provided context, which may be used to store\n+\t\t * objects to be reset/rollbacked before a retry.", "originalCommit": "4821114aa1c19cef4a054a44b15bfce9098ec54c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjgyNjQ5Mw==", "url": "https://github.com/reactor/reactor-core/pull/2337#discussion_r482826493", "bodyText": "I agree on using ContextView suffix, as this is the part of the API that will be most visible to users and thus further clarifies that this is read only.", "author": "simonbasle", "createdAt": "2020-09-03T09:09:14Z", "path": "reactor-core/src/main/java/reactor/util/retry/Retry.java", "diffHunk": "@@ -92,6 +114,16 @@\n \t\t */\n \t\tThrowable failure();\n \n+\t\t/**\n+\t\t * Return a read-only view of the user provided context, which may be used to store\n+\t\t * objects to be reset/rollbacked before a retry.\n+\t\t *\n+\t\t * @return a read-only view of a user provided context.\n+\t\t */\n+\t\tdefault ContextView retryContextView() {", "originalCommit": "4821114aa1c19cef4a054a44b15bfce9098ec54c", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd8db8ab07f263cf2c61abd9b7102df7ac383f11", "url": "https://github.com/reactor/reactor-core/commit/bd8db8ab07f263cf2c61abd9b7102df7ac383f11", "message": "fix #2312 add user provided state to Retry\n\nCo-authored-by: Audrey Neveu <aneveu@pivotal.io>", "committedDate": "2020-09-07T09:45:15Z", "type": "commit"}, {"oid": "bd8db8ab07f263cf2c61abd9b7102df7ac383f11", "url": "https://github.com/reactor/reactor-core/commit/bd8db8ab07f263cf2c61abd9b7102df7ac383f11", "message": "fix #2312 add user provided state to Retry\n\nCo-authored-by: Audrey Neveu <aneveu@pivotal.io>", "committedDate": "2020-09-07T09:45:15Z", "type": "forcePushed"}]}