{"pr_number": 2383, "pr_title": "fix #2372 Add hasSubscriber() state getter to Sinks.Many|One|Empty", "pr_createdAt": "2020-09-16T09:34:49Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2383", "timeline": [{"oid": "2273cb5bc868d73dfb58baa343a9ddcd0e7873fa", "url": "https://github.com/reactor/reactor-core/commit/2273cb5bc868d73dfb58baa343a9ddcd0e7873fa", "message": "Convert tests to use hasSubscriber() + fix some inconsistencies\n\nsome tests would use the wrong source for assertions, some would use the\nwrong variable name in assertion message. overall simplified tests and\nreplaced Assert with assertJ `assertThat` on tested sinks.", "committedDate": "2020-09-16T09:39:03Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNjA5MA==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489306090", "bodyText": "WDYT about using isSubscribed(), to avoid singular vs plural confusion?", "author": "bsideup", "createdAt": "2020-09-16T09:42:36Z", "path": "reactor-core/src/main/java/reactor/core/publisher/Sinks.java", "diffHunk": "@@ -600,6 +600,17 @@ public Emission getReason() {\n \t\t@Deprecated\n \t\tvoid emitError(Throwable error);\n \n+\t\t/**\n+\t\t * Determines if the sink currently has at least one subscriber.\n+\t\t * <p>\n+\t\t * This is a best effort peek at the sink state, and a subsequent attempt at emitting\n+\t\t * to the sink might still return {@link Emission#FAIL_ZERO_SUBSCRIBER} where relevant\n+\t\t * (generally in {@link #tryEmitNext(Object)}).\n+\t\t *\n+\t\t * @return {@code true} if the sink has at least one subscriber at the time of invocation, {@code false} otherwise\n+\t\t */\n+\t\tboolean hasSubscriber();", "originalCommit": "2273cb5bc868d73dfb58baa343a9ddcd0e7873fa", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxMTUzNg==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489311536", "bodyText": "I think it could introduce even more cognitive dissonance since it can either be read as \"the sink is subscribed to something\" or \"the sink is subscribed to by something\" \ud83e\udd14", "author": "simonbasle", "createdAt": "2020-09-16T09:51:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNjA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxNTA1Mw==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489315053", "bodyText": "On a side note I elected to use singular rather than plural form because I find plural form to be more easily interpreted as \"strictly greater than one\" semantic, while singular can be better accepted as meaning \"at least one\". Plus plural form would feel weird on unicast variants.", "author": "simonbasle", "createdAt": "2020-09-16T09:57:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNjA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxODQyNw==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489318427", "bodyText": "if we follow this path, the same applies to \"the sink has a subscriber that it created\" vs \"there is a subscriber and this sink has it\" :D in fact, the latter is even more confusing IMO :)", "author": "bsideup", "createdAt": "2020-09-16T10:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNjA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUwNTQ0MA==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489505440", "bodyText": "Some further thoughts. The method could return the number of current subscribers, if that extra information has potential to be useful? Also it would be nice for the the name to include something like \"current\" or \"active\" to indicate the transient nature.", "author": "rstoyanchev", "createdAt": "2020-09-16T14:58:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNjA5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc2OTE1NA==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r490769154", "bodyText": "done, with activeSubscriberCount()", "author": "simonbasle", "createdAt": "2020-09-18T07:56:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNjA5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwNzAyMw==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489307023", "bodyText": "note for reviewers: DirectProcessorTest should ideally be re-formatted to use tabs consistently. in order not to pollute this PR's commit, I've only let the IDE reintroduce tabs on modified lines.", "author": "simonbasle", "createdAt": "2020-09-16T09:44:08Z", "path": "reactor-core/src/test/java/reactor/core/publisher/DirectProcessorTest.java", "diffHunk": "@@ -133,10 +133,10 @@ public void error() {\n \n         tp.subscribe(ts);\n \n-        Assert.assertTrue(\"No subscribers?\", Scannable.from(tp).inners().count() != 0);\n-        Assert.assertFalse(\"Completed?\", tp.hasCompleted());\n-        Assert.assertNull(\"Has error?\", tp.getError());\n-        Assert.assertFalse(\"Has error?\", tp.hasError());\n+\t    assertThat(tp.hasSubscriber()).as(\"hasSubscriber\").isTrue();", "originalCommit": "2273cb5bc868d73dfb58baa343a9ddcd0e7873fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwODI1Mg==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489308252", "bodyText": "there was a bug in the tests messages here", "author": "simonbasle", "createdAt": "2020-09-16T09:46:02Z", "path": "reactor-core/src/test/java/reactor/core/publisher/FluxSampleFirstTest.java", "diffHunk": "@@ -72,9 +74,9 @@ public void normal() {\n \t\t  .assertNoError()\n \t\t  .assertComplete();\n \n-\t\tAssert.assertFalse(\"sp1 has subscribers?\", Scannable.from(sp1).inners().findAny().isPresent());\n-\t\tAssert.assertFalse(\"sp1 has subscribers?\", Scannable.from(sp2).inners().findAny().isPresent());", "originalCommit": "2273cb5bc868d73dfb58baa343a9ddcd0e7873fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwODgyMA==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r489308820", "bodyText": "there was a bug in the assertion here, asserting the wrong value!", "author": "simonbasle", "createdAt": "2020-09-16T09:47:04Z", "path": "reactor-core/src/test/java/reactor/core/publisher/FluxWindowBoundaryTest.java", "diffHunk": "@@ -82,8 +82,8 @@ public void normal() {\n \t\tts.assertNoError()\n \t\t  .assertComplete();\n \n-\t\tAssert.assertFalse(\"sp1 has subscribers\", Scannable.from(sp1).inners().findAny().isPresent());\n-\t\tAssert.assertFalse(\"sp2 has subscribers\", Scannable.from(sp1).inners().findAny().isPresent());", "originalCommit": "2273cb5bc868d73dfb58baa343a9ddcd0e7873fa", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMDk0Nw==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r490800947", "bodyText": "should we maybe define \"active\" here? Otherwise, someone may think that \"active\" == \"ready to consume / requested\", which isn't the case", "author": "bsideup", "createdAt": "2020-09-18T08:53:28Z", "path": "reactor-core/src/main/java/reactor/core/publisher/Sinks.java", "diffHunk": "@@ -600,6 +600,17 @@ public Emission getReason() {\n \t\t@Deprecated\n \t\tvoid emitError(Throwable error);\n \n+\t\t/**\n+\t\t * Determines how many active {@link Subscriber Subscribers} the sink currently has.", "originalCommit": "3f75d31451167e898f1d4b84f738b56749d8074c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg0MzA3Mg==", "url": "https://github.com/reactor/reactor-core/pull/2383#discussion_r490843072", "bodyText": "current sounds less ambiguous, I'll change to that and explain a bit more in the javadoc", "author": "simonbasle", "createdAt": "2020-09-18T10:07:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMDk0Nw=="}], "type": "inlineReview"}, {"oid": "f01df1b991f16c7445ac72d09b91f32111bb2a5d", "url": "https://github.com/reactor/reactor-core/commit/f01df1b991f16c7445ac72d09b91f32111bb2a5d", "message": "[polish] Polish NextProcessor, allow subscribe() on it\n\nThis commit polishes the NextProcessor:\n - annotate error, value and source fields + getError() as Nullable\n - by checking if there's a source to the NextProcessor in `subscribe()`\n we can allow using it as a Sinks.One with empty LambdaSubscriber\n - no-op Operators.onOperatorError for cancelled inner, no need to\n do anything with error if inner is cancelled", "committedDate": "2020-09-18T17:29:04Z", "type": "commit"}, {"oid": "ecee8c0194e8d0809403c983e01264c762f56a14", "url": "https://github.com/reactor/reactor-core/commit/ecee8c0194e8d0809403c983e01264c762f56a14", "message": "fix #2372 Add currentSubscriberCount() to Sinks.Many|One|Empty\n\nAlso convert tests to use the state getter and fix some inconsistencies\nin tests:\n - some tests would use the wrong source for assertions\n - some tests would use the wrong variable name in assertion message\n- overall simplified tests and replaced Assert with assertJ `assertThat`\non tested sinks", "committedDate": "2020-09-18T17:29:05Z", "type": "commit"}, {"oid": "ecee8c0194e8d0809403c983e01264c762f56a14", "url": "https://github.com/reactor/reactor-core/commit/ecee8c0194e8d0809403c983e01264c762f56a14", "message": "fix #2372 Add currentSubscriberCount() to Sinks.Many|One|Empty\n\nAlso convert tests to use the state getter and fix some inconsistencies\nin tests:\n - some tests would use the wrong source for assertions\n - some tests would use the wrong variable name in assertion message\n- overall simplified tests and replaced Assert with assertJ `assertThat`\non tested sinks", "committedDate": "2020-09-18T17:29:05Z", "type": "forcePushed"}]}