{"pr_number": 2283, "pr_title": "fix #2279 Introduce ContextView (read only API for Context)", "pr_createdAt": "2020-07-22T13:28:06Z", "pr_url": "https://github.com/reactor/reactor-core/pull/2283", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc5OTU2NQ==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r458799565", "bodyText": "Perhaps we should not add such method. One can still do the empty().putAll() trick, but adding the method would help with the following wrong pattern that we should discourage:\nMono.deferWithContext(ctx -> {\n    Context.fromReadOnly(ctx).put(\"I have\", \"no idea what I am doing\");\n    return Mono.just(\"foo\");\n});", "author": "bsideup", "createdAt": "2020-07-22T13:40:38Z", "path": "reactor-core/src/main/java/reactor/util/context/Context.java", "diffHunk": "@@ -191,32 +190,21 @@ static Context of(Map<?, ?> map) {\n \t}\n \n \t/**\n-\t * Resolve a value given a key that exists within the {@link Context}, or throw\n-\t * a {@link NoSuchElementException} if the key is not present.\n+\t * Create a {@link Context} out of a {@link ContextView}, enabling write API on top of\n+\t * the read-only view. If the {@link ContextView} is already a {@link Context}, return\n+\t * the same instance.\n \t *\n-\t * @param key a lookup key to resolve the value within the context\n-\t * @param <T> an unchecked casted generic for fluent typing convenience\n-\t *\n-\t * @return the value resolved for this key (throws if key not found)\n-\t * @throws NoSuchElementException when the given key is not present\n-\t * @see #getOrDefault(Object, Object)\n-\t * @see #getOrEmpty(Object)\n-\t * @see #hasKey(Object)\n+\t * @param contextView the {@link ContextView} to convert (or cast) to {@link Context}\n+\t * @return the converted {@link Context} for further modifications\n \t */\n-\t<T> T get(Object key);\n+\tstatic Context fromReadOnly(ContextView contextView) {", "originalCommit": "4b56c2ef9bc5a4c6b28ed8c27df99958e8b86b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwNjUzNA==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r458806534", "bodyText": "having the casting trick helps avoiding a bit of junk. I don't think fromReadOnly is misleading compared to plain exposition of full Context API (which guides you towards shooting yourself in the foot).\nmaybe I should rename it to fromView(ContextView) ? or even copyView? (even though for a ContextView that is also a Context, this is not strictly true).", "author": "simonbasle", "createdAt": "2020-07-22T13:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc5OTU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMTQ1NA==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r458831454", "bodyText": "WDYT about... Context.of(ContextView)? We have these factory methods already, and it would hint that a new context is created", "author": "bsideup", "createdAt": "2020-07-22T14:23:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc5OTU2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg4MDc1OQ==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r458880759", "bodyText": "yeah I was using of in my initial local work but somehow felt less explicit. that said, indeed all of methods are obviously about creating new contexts so that could work.", "author": "simonbasle", "createdAt": "2020-07-22T15:29:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc5OTU2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwMDM4Nw==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r458800387", "bodyText": "I believe this belongs to ContextView", "author": "bsideup", "createdAt": "2020-07-22T13:41:45Z", "path": "reactor-core/src/main/java/reactor/util/context/Context.java", "diffHunk": "@@ -243,36 +223,26 @@ static Context of(Map<?, ?> map) {\n \t\treturn get(key);\n \t}\n \n-\t/**\n-\t * Resolve a value given a key within the {@link Context}.\n-\t *\n-\t * @param key a lookup key to resolve the value within the context\n-\t *\n-\t * @return an {@link Optional} of the value for that key.\n-\t */\n+\t@Override\n \tdefault <T> Optional<T> getOrEmpty(Object key){\n \t\tif(hasKey(key)) {\n \t\t\treturn Optional.of(get(key));\n \t\t}\n \t\treturn Optional.empty();\n \t}\n \n-\t/**\n-\t * Return true if a particular key resolves to a value within the {@link Context}.\n-\t *\n-\t * @param key a lookup key to test for\n-\t *\n-\t * @return true if this context contains the given key\n-\t */\n-\tboolean hasKey(Object key);\n+\t@Override\n+\tdefault boolean isEmpty() {", "originalCommit": "4b56c2ef9bc5a4c6b28ed8c27df99958e8b86b10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwMDU2NQ==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r458800565", "bodyText": "What's the reason to keep this method here and not move it to ContextView?", "author": "bsideup", "createdAt": "2020-07-22T13:42:02Z", "path": "reactor-core/src/main/java/reactor/util/context/Context.java", "diffHunk": "@@ -243,36 +223,26 @@ static Context of(Map<?, ?> map) {\n \t\treturn get(key);\n \t}\n \n-\t/**\n-\t * Resolve a value given a key within the {@link Context}.\n-\t *\n-\t * @param key a lookup key to resolve the value within the context\n-\t *\n-\t * @return an {@link Optional} of the value for that key.\n-\t */\n+\t@Override\n \tdefault <T> Optional<T> getOrEmpty(Object key){", "originalCommit": "4b56c2ef9bc5a4c6b28ed8c27df99958e8b86b10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ea5f97a1ca214f90464fad9fe0f3d686d84aff2c", "url": "https://github.com/reactor/reactor-core/commit/ea5f97a1ca214f90464fad9fe0f3d686d84aff2c", "message": "fix #2279 Introduce ContextView (read only API for Context)", "committedDate": "2020-07-22T16:24:49Z", "type": "commit"}, {"oid": "14e1d8f3c07dc0d66d966f8c6a96ebc933815c8a", "url": "https://github.com/reactor/reactor-core/commit/14e1d8f3c07dc0d66d966f8c6a96ebc933815c8a", "message": "move default read methods to ContextView", "committedDate": "2020-07-22T16:24:49Z", "type": "commit"}, {"oid": "36ea049c5b96e057bd48a523042d71314be001b8", "url": "https://github.com/reactor/reactor-core/commit/36ea049c5b96e057bd48a523042d71314be001b8", "message": "Add ContextView class documentation", "committedDate": "2020-07-22T16:24:49Z", "type": "commit"}, {"oid": "c07db52fb20472c604d074431c67b146788fa79d", "url": "https://github.com/reactor/reactor-core/commit/c07db52fb20472c604d074431c67b146788fa79d", "message": "Amend the reference documentation", "committedDate": "2020-07-22T16:24:49Z", "type": "commit"}, {"oid": "697cd5e14ea9b9283f08eca328e825ad3c837f6b", "url": "https://github.com/reactor/reactor-core/commit/697cd5e14ea9b9283f08eca328e825ad3c837f6b", "message": "Rename fromReadonly to of, add null check and split ContextView tests", "committedDate": "2020-07-22T16:24:50Z", "type": "commit"}, {"oid": "94c0b644629dc23bafb0ec6a64222774f08ac094", "url": "https://github.com/reactor/reactor-core/commit/94c0b644629dc23bafb0ec6a64222774f08ac094", "message": "Add japicmp exclusions", "committedDate": "2020-07-22T16:27:56Z", "type": "commit"}, {"oid": "94c0b644629dc23bafb0ec6a64222774f08ac094", "url": "https://github.com/reactor/reactor-core/commit/94c0b644629dc23bafb0ec6a64222774f08ac094", "message": "Add japicmp exclusions", "committedDate": "2020-07-22T16:27:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxNjg3NA==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r459316874", "bodyText": "nit: could use some auto-formatting of methods' implementations", "author": "bsideup", "createdAt": "2020-07-23T09:15:03Z", "path": "reactor-core/src/main/java/reactor/util/context/ContextView.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright (c) 2011-Present VMware Inc. or its affiliates, All Rights Reserved.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *        https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package reactor.util.context;\n+\n+import java.util.Map;\n+import java.util.NoSuchElementException;\n+import java.util.Optional;\n+import java.util.stream.Stream;\n+\n+import reactor.util.annotation.Nullable;\n+\n+/**\n+ * A read-only view of a collection of key/value pairs that is propagated between components\n+ * such as operators via the context protocol. Contexts are ideal to transport orthogonal\n+ * information such as tracing or security tokens.\n+ * <p>\n+ * {@link Context} is an immutable variant of the same key/value pairs structure which exposes\n+ * a write API that returns new instances on each write.\n+ *\n+ * @author Simon Basl\u00e9\n+ */\n+public interface ContextView {", "originalCommit": "94c0b644629dc23bafb0ec6a64222774f08ac094", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM2NDUyNg==", "url": "https://github.com/reactor/reactor-core/pull/2283#discussion_r459364526", "bodyText": "done", "author": "simonbasle", "createdAt": "2020-07-23T10:49:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxNjg3NA=="}], "type": "inlineReview"}, {"oid": "244f07ab18fa13b6d27370bf1698d44210389d14", "url": "https://github.com/reactor/reactor-core/commit/244f07ab18fa13b6d27370bf1698d44210389d14", "message": "Improve defer->map pattern, do smaller copiable indentation", "committedDate": "2020-07-23T10:46:03Z", "type": "commit"}, {"oid": "ab0b3f05ee66e566c58eb91b28c5b139e8314843", "url": "https://github.com/reactor/reactor-core/commit/ab0b3f05ee66e566c58eb91b28c5b139e8314843", "message": "mention doing more work in Mono.deferWithContext", "committedDate": "2020-07-23T10:46:32Z", "type": "commit"}, {"oid": "aae6abca7711d151e8bebe8dc3a7fed1948fe77a", "url": "https://github.com/reactor/reactor-core/commit/aae6abca7711d151e8bebe8dc3a7fed1948fe77a", "message": "Apply reactor format to ContextView file", "committedDate": "2020-07-23T10:47:48Z", "type": "commit"}]}