{"pr_number": 1851, "pr_title": "[HUDI-1113] Add user define metrics reporter", "pr_createdAt": "2020-07-20T09:24:39Z", "pr_url": "https://github.com/apache/hudi/pull/1851", "timeline": [{"oid": "2128eb636d9262ed5cc0353a976ff0e9ab1e1718", "url": "https://github.com/apache/hudi/commit/2128eb636d9262ed5cc0353a976ff0e9ab1e1718", "message": "Add user define metrics reporter", "committedDate": "2020-07-20T09:23:47Z", "type": "commit"}, {"oid": "f08f8ce59851dbaa09bd43d18aece7566e949f65", "url": "https://github.com/apache/hudi/commit/f08f8ce59851dbaa09bd43d18aece7566e949f65", "message": "Reformat code", "committedDate": "2020-07-20T09:30:26Z", "type": "commit"}, {"oid": "fe80ed72bc5f1dd29da3a61f88b5816aecab8355", "url": "https://github.com/apache/hudi/commit/fe80ed72bc5f1dd29da3a61f88b5816aecab8355", "message": "Pass metricRegistry to user defined metric reporter", "committedDate": "2020-07-21T01:16:53Z", "type": "commit"}, {"oid": "0a0bb4cd9cd2bd1f2e382f6e7a9768c5f7ef10bb", "url": "https://github.com/apache/hudi/commit/0a0bb4cd9cd2bd1f2e382f6e7a9768c5f7ef10bb", "message": "Add license", "committedDate": "2020-07-21T01:23:05Z", "type": "commit"}, {"oid": "b8d6b93de3f3c4071dc81610f9d65f8668c6a270", "url": "https://github.com/apache/hudi/commit/b8d6b93de3f3c4071dc81610f9d65f8668c6a270", "message": "Update default value logic of user defined reporter config", "committedDate": "2020-07-21T03:45:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NzM4NA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458477384", "bodyText": "we would remove this, please refer to https://github.com/apache/hudi/blob/master/hudi-client/src/main/java/org/apache/hudi/index/HoodieIndex.java#L56", "author": "leesf", "createdAt": "2020-07-22T01:17:00Z", "path": "hudi-client/src/main/java/org/apache/hudi/metrics/MetricsReporterFactory.java", "diffHunk": "@@ -48,6 +51,10 @@ public static MetricsReporter createReporter(HoodieWriteConfig config, MetricReg\n       case DATADOG:\n         reporter = new DatadogMetricsReporter(config, registry);\n         break;\n+      case USER_DEFINED:", "originalCommit": "b8d6b93de3f3c4071dc81610f9d65f8668c6a270", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4MDkzOQ==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458580939", "bodyText": "Ok, look good", "author": "zherenyu831", "createdAt": "2020-07-22T07:10:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NzM4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NzQ2NQ==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458477465", "bodyText": "would remove USER_DEFINED.", "author": "leesf", "createdAt": "2020-07-22T01:17:18Z", "path": "hudi-client/src/main/java/org/apache/hudi/metrics/MetricsReporterType.java", "diffHunk": "@@ -22,5 +22,5 @@\n  * Types of the reporter. Right now we only support Graphite. We can include JMX and CSV in the future.\n  */\n public enum MetricsReporterType {\n-  GRAPHITE, INMEMORY, JMX, DATADOG\n+  GRAPHITE, INMEMORY, JMX, DATADOG, USER_DEFINED", "originalCommit": "b8d6b93de3f3c4071dc81610f9d65f8668c6a270", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4MDgzOA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458580838", "bodyText": "Yes, no need any more", "author": "zherenyu831", "createdAt": "2020-07-22T07:10:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NzQ2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NzgyNg==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458477826", "bodyText": "if just used for testing, we would move it into test class.", "author": "leesf", "createdAt": "2020-07-22T01:18:49Z", "path": "hudi-client/src/main/java/org/apache/hudi/metrics/userdefined/DefaultUserDefinedMetricsReporter.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.metrics.userdefined;\n+\n+import com.codahale.metrics.MetricRegistry;\n+\n+import java.io.Closeable;\n+import java.util.Properties;\n+\n+/**\n+ * Used for testing.", "originalCommit": "b8d6b93de3f3c4071dc81610f9d65f8668c6a270", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4MDU4Ng==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458580586", "bodyText": "Moved to test classes", "author": "zherenyu831", "createdAt": "2020-07-22T07:09:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3NzgyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3ODQwMA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458478400", "bodyText": "DEFUALT would be empty string. also please refer to \n  \n    \n      hudi/hudi-client/src/main/java/org/apache/hudi/config/HoodieIndexConfig.java\n    \n    \n         Line 42\n      in\n      5e7ab11\n    \n    \n    \n    \n\n        \n          \n           public static final String DEFAULT_INDEX_CLASS = \"\";", "author": "leesf", "createdAt": "2020-07-22T01:20:43Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieMetricsConfig.java", "diffHunk": "@@ -58,6 +59,12 @@\n \n   public static final String GRAPHITE_METRIC_PREFIX = GRAPHITE_PREFIX + \".metric.prefix\";\n \n+  // User defined\n+  public static final String USER_DEFINED_REPORTER_PREFIX = METRIC_PREFIX + \".user.defined\";\n+  public static final String USER_DEFINED_REPORTER_CLASS = USER_DEFINED_REPORTER_PREFIX + \".class\";\n+\n+  public static final String DEFAULT_USER_DEFINED_REPORTER_CLASS = DefaultUserDefinedMetricsReporter.class.getName();", "originalCommit": "b8d6b93de3f3c4071dc81610f9d65f8668c6a270", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4MDQ2NA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458580464", "bodyText": "Good idea, got it", "author": "zherenyu831", "createdAt": "2020-07-22T07:09:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3ODQwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3ODgyOQ==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458478829", "bodyText": "would rename to METRICS_REPORTER_CLASS = \"metrics.reporter.class\" ?", "author": "leesf", "createdAt": "2020-07-22T01:22:21Z", "path": "hudi-client/src/main/java/org/apache/hudi/config/HoodieMetricsConfig.java", "diffHunk": "@@ -58,6 +59,12 @@\n \n   public static final String GRAPHITE_METRIC_PREFIX = GRAPHITE_PREFIX + \".metric.prefix\";\n \n+  // User defined\n+  public static final String USER_DEFINED_REPORTER_PREFIX = METRIC_PREFIX + \".user.defined\";\n+  public static final String USER_DEFINED_REPORTER_CLASS = USER_DEFINED_REPORTER_PREFIX + \".class\";", "originalCommit": "b8d6b93de3f3c4071dc81610f9d65f8668c6a270", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODU4MDE4NA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458580184", "bodyText": "the full key name will be like \"hoodie.metrics.reporter.class\" ?", "author": "zherenyu831", "createdAt": "2020-07-22T07:08:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODQ3ODgyOQ=="}], "type": "inlineReview"}, {"oid": "51f9bd076fb0ddb119d4ef7dbe004a50ab4c7e0f", "url": "https://github.com/apache/hudi/commit/51f9bd076fb0ddb119d4ef7dbe004a50ab4c7e0f", "message": "Update for comments", "committedDate": "2020-07-22T06:58:38Z", "type": "commit"}, {"oid": "572cf6e5f9d15cff0a2bf0baee058d80261f4289", "url": "https://github.com/apache/hudi/commit/572cf6e5f9d15cff0a2bf0baee058d80261f4289", "message": "Fix comment", "committedDate": "2020-07-22T07:07:51Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY3MTc3NA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458671774", "bodyText": "This class along with TestMetricReporter would both move to TestMetricsReporterFactory.java ?", "author": "leesf", "createdAt": "2020-07-22T09:47:35Z", "path": "hudi-client/src/test/java/org/apache/hudi/metrics/TestIllegalMetricReporter.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *   http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.hudi.metrics;\n+\n+import com.codahale.metrics.MetricRegistry;\n+\n+import java.util.Properties;\n+\n+/**\n+ * Test class for user defined metric reporter.\n+ */\n+public class TestIllegalMetricReporter {", "originalCommit": "572cf6e5f9d15cff0a2bf0baee058d80261f4289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5MTY5NQ==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458691695", "bodyText": "Ok, let me try, actually I tried before, and static public class seem could not be about to create instance ....", "author": "zherenyu831", "createdAt": "2020-07-22T10:23:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY3MTc3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY3MjUyNA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458672524", "bodyText": "Let's use HoodieException instead of creating a new Exception class?", "author": "leesf", "createdAt": "2020-07-22T09:48:55Z", "path": "hudi-client/src/main/java/org/apache/hudi/exception/HoodieMetricsException.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hudi.exception;\n+\n+/**\n+ * <p>\n+ * Exception thrown when error happens on metrics process.\n+ * </p>\n+ */\n+public class HoodieMetricsException extends HoodieException {", "originalCommit": "572cf6e5f9d15cff0a2bf0baee058d80261f4289", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY5MTc3Ng==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r458691776", "bodyText": "OK, got it", "author": "zherenyu831", "createdAt": "2020-07-22T10:23:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY3MjUyNA=="}], "type": "inlineReview"}, {"oid": "b1a1af526d37c23bcf9be98d36cebbd03c52e47a", "url": "https://github.com/apache/hudi/commit/b1a1af526d37c23bcf9be98d36cebbd03c52e47a", "message": "Merge test classes and use HoodieException instead of new one", "committedDate": "2020-07-22T10:33:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwMDUxOQ==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r459200519", "bodyText": "would rename to DummyMetricsReporter", "author": "leesf", "createdAt": "2020-07-23T03:48:57Z", "path": "hudi-client/src/test/java/org/apache/hudi/metrics/TestMetricsReporterFactory.java", "diffHunk": "@@ -45,4 +52,53 @@ public void metricsReporterFactoryShouldReturnReporter() {\n     MetricsReporter reporter = MetricsReporterFactory.createReporter(config, registry);\n     assertTrue(reporter instanceof InMemoryMetricsReporter);\n   }\n+\n+  @Test\n+  public void metricsReporterFactoryShouldReturnUserDefinedReporter() {\n+    when(config.getMetricReporterClassName()).thenReturn(TestMetricReporter.class.getName());\n+\n+    Properties props = new Properties();\n+    props.setProperty(\"testKey\", \"testValue\");\n+\n+    when(config.getProps()).thenReturn(props);\n+    MetricsReporter reporter = MetricsReporterFactory.createReporter(config, registry);\n+    assertTrue(reporter instanceof AbstractUserDefinedMetricsReporter);\n+    assertEquals(props, ((TestMetricReporter) reporter).getProps());\n+    assertEquals(registry, ((TestMetricReporter) reporter).getRegistry());\n+  }\n+\n+  @Test\n+  public void metricsReporterFactoryShouldThrowExceptionWhenMetricsReporterClassIsIllegal() {\n+    when(config.getMetricReporterClassName()).thenReturn(TestIllegalMetricReporter.class.getName());\n+    when(config.getProps()).thenReturn(new Properties());\n+    assertThrows(HoodieException.class, () -> MetricsReporterFactory.createReporter(config, registry));\n+  }\n+\n+  public static class TestMetricReporter extends AbstractUserDefinedMetricsReporter {", "originalCommit": "b1a1af526d37c23bcf9be98d36cebbd03c52e47a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIxNDY3NA==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r459214674", "bodyText": "That's easy", "author": "zherenyu831", "createdAt": "2020-07-23T04:58:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwMDUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTIwMDY3MQ==", "url": "https://github.com/apache/hudi/pull/1851#discussion_r459200671", "bodyText": "would rename to IllegalTestMetricsReporter", "author": "leesf", "createdAt": "2020-07-23T03:49:35Z", "path": "hudi-client/src/test/java/org/apache/hudi/metrics/TestMetricsReporterFactory.java", "diffHunk": "@@ -45,4 +52,53 @@ public void metricsReporterFactoryShouldReturnReporter() {\n     MetricsReporter reporter = MetricsReporterFactory.createReporter(config, registry);\n     assertTrue(reporter instanceof InMemoryMetricsReporter);\n   }\n+\n+  @Test\n+  public void metricsReporterFactoryShouldReturnUserDefinedReporter() {\n+    when(config.getMetricReporterClassName()).thenReturn(TestMetricReporter.class.getName());\n+\n+    Properties props = new Properties();\n+    props.setProperty(\"testKey\", \"testValue\");\n+\n+    when(config.getProps()).thenReturn(props);\n+    MetricsReporter reporter = MetricsReporterFactory.createReporter(config, registry);\n+    assertTrue(reporter instanceof AbstractUserDefinedMetricsReporter);\n+    assertEquals(props, ((TestMetricReporter) reporter).getProps());\n+    assertEquals(registry, ((TestMetricReporter) reporter).getRegistry());\n+  }\n+\n+  @Test\n+  public void metricsReporterFactoryShouldThrowExceptionWhenMetricsReporterClassIsIllegal() {\n+    when(config.getMetricReporterClassName()).thenReturn(TestIllegalMetricReporter.class.getName());\n+    when(config.getProps()).thenReturn(new Properties());\n+    assertThrows(HoodieException.class, () -> MetricsReporterFactory.createReporter(config, registry));\n+  }\n+\n+  public static class TestMetricReporter extends AbstractUserDefinedMetricsReporter {\n+\n+    public TestMetricReporter(Properties props, MetricRegistry registry) {\n+      super(props, registry);\n+    }\n+\n+    @Override\n+    public void start() {}\n+\n+    @Override\n+    public void report() {}\n+\n+    @Override\n+    public Closeable getReporter() {\n+      return null;\n+    }\n+\n+    @Override\n+    public void stop() {}\n+  }\n+\n+  public static class TestIllegalMetricReporter {", "originalCommit": "b1a1af526d37c23bcf9be98d36cebbd03c52e47a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "78853cc358ca7f061bc2f7ba66dd20cb90f4e6e2", "url": "https://github.com/apache/hudi/commit/78853cc358ca7f061bc2f7ba66dd20cb90f4e6e2", "message": "Rename test classes names", "committedDate": "2020-07-23T04:59:15Z", "type": "commit"}]}