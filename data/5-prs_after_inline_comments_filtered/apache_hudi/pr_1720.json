{"pr_number": 1720, "pr_title": "[HUDI-1003] Handle partitions correctly for syncing hudi non-parititioned table to hive", "pr_createdAt": "2020-06-09T06:13:18Z", "pr_url": "https://github.com/apache/hudi/pull/1720", "timeline": [{"oid": "b7c77223ab4b2aef5660b7ed5117e67974a3961b", "url": "https://github.com/apache/hudi/commit/b7c77223ab4b2aef5660b7ed5117e67974a3961b", "message": "[HUDI-934] Add processing logic with the decimal logical type", "committedDate": "2020-05-28T09:31:12Z", "type": "commit"}, {"oid": "9294c6b3f0407eabdf50d535a0a963f7ad326ffa", "url": "https://github.com/apache/hudi/commit/9294c6b3f0407eabdf50d535a0a963f7ad326ffa", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-05-28T11:01:58Z", "type": "commit"}, {"oid": "d47f9021a6d40a393409a81b600572d0be0f12d4", "url": "https://github.com/apache/hudi/commit/d47f9021a6d40a393409a81b600572d0be0f12d4", "message": "[HUDI-934] Add processing logic for the decimal LogicalType", "committedDate": "2020-05-28T12:41:32Z", "type": "commit"}, {"oid": "a0963b4b1e17067229e00d2f9c9e486f6a10384c", "url": "https://github.com/apache/hudi/commit/a0963b4b1e17067229e00d2f9c9e486f6a10384c", "message": "trigger rebuild", "committedDate": "2020-05-29T02:49:29Z", "type": "commit"}, {"oid": "05ac11589aa892804b054ba6ea4e0618e2aa3d1f", "url": "https://github.com/apache/hudi/commit/05ac11589aa892804b054ba6ea4e0618e2aa3d1f", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-05-30T01:11:47Z", "type": "commit"}, {"oid": "cfd9835af1d0da85a64012609856fda5afeaf2fc", "url": "https://github.com/apache/hudi/commit/cfd9835af1d0da85a64012609856fda5afeaf2fc", "message": "Merge remote-tracking branch 'upstream/master'", "committedDate": "2020-06-09T05:30:26Z", "type": "commit"}, {"oid": "9db35a1647b057c7dfb3516221e88e23afb6e635", "url": "https://github.com/apache/hudi/commit/9db35a1647b057c7dfb3516221e88e23afb6e635", "message": "[HUDI-1003] Handle partitions correctly for syncing hudi non-parititioned table to hive", "committedDate": "2020-06-09T05:46:58Z", "type": "commit"}, {"oid": "d92ce1682c4c11361728b5ada086f4a1cb2c2b53", "url": "https://github.com/apache/hudi/commit/d92ce1682c4c11361728b5ada086f4a1cb2c2b53", "message": "trigger rebuild", "committedDate": "2020-06-09T08:33:36Z", "type": "commit"}, {"oid": "c07cb64250e7adc949fa78daa2d95e2dcee053f6", "url": "https://github.com/apache/hudi/commit/c07cb64250e7adc949fa78daa2d95e2dcee053f6", "message": "[WIP] Add test case for syncing non-parititioned table to hive", "committedDate": "2020-06-12T06:43:41Z", "type": "commit"}, {"oid": "4afe22dcdbeba4b6e06a27c551ee58a0f3c3119a", "url": "https://github.com/apache/hudi/commit/4afe22dcdbeba4b6e06a27c551ee58a0f3c3119a", "message": "Modify the comments and warning log", "committedDate": "2020-06-12T08:28:22Z", "type": "commit"}, {"oid": "08bde34c9765ea37f940498bee07384806adce65", "url": "https://github.com/apache/hudi/commit/08bde34c9765ea37f940498bee07384806adce65", "message": "trigger rebuild", "committedDate": "2020-06-12T11:41:56Z", "type": "commit"}, {"oid": "af82cda0a912df2eb0aa76c56cac4f2683eb8a3e", "url": "https://github.com/apache/hudi/commit/af82cda0a912df2eb0aa76c56cac4f2683eb8a3e", "message": "trigger rebuild", "committedDate": "2020-06-12T12:41:40Z", "type": "commit"}, {"oid": "019e8c4a0a94b3349303e9feb1c388e90542d321", "url": "https://github.com/apache/hudi/commit/019e8c4a0a94b3349303e9feb1c388e90542d321", "message": "Modify the logic", "committedDate": "2020-06-13T12:42:32Z", "type": "commit"}, {"oid": "81498b56998d24f667844b64f4f5c9670bec7f2a", "url": "https://github.com/apache/hudi/commit/81498b56998d24f667844b64f4f5c9670bec7f2a", "message": "trigger rebuild", "committedDate": "2020-06-13T14:10:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc0MzA1Ng==", "url": "https://github.com/apache/hudi/pull/1720#discussion_r439743056", "bodyText": "remove this one?", "author": "leesf", "createdAt": "2020-06-13T14:27:34Z", "path": "hudi-hive-sync/src/main/java/org/apache/hudi/hive/HiveSyncTool.java", "diffHunk": "@@ -18,6 +18,7 @@\n \n package org.apache.hudi.hive;\n \n+import static jdk.nashorn.internal.runtime.regexp.joni.Config.log;", "originalCommit": "81498b56998d24f667844b64f4f5c9670bec7f2a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgwMTI2Mw==", "url": "https://github.com/apache/hudi/pull/1720#discussion_r439801263", "bodyText": "Done", "author": "cloud-luoyajun", "createdAt": "2020-06-14T07:37:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTc0MzA1Ng=="}], "type": "inlineReview"}, {"oid": "575fb2454e7de39fec1f415c85d09aea49ea5c9c", "url": "https://github.com/apache/hudi/commit/575fb2454e7de39fec1f415c85d09aea49ea5c9c", "message": "Modify the logic", "committedDate": "2020-06-14T07:33:09Z", "type": "commit"}, {"oid": "66d67705f75d660b4ec5327af5ed9acbf28b5f3e", "url": "https://github.com/apache/hudi/commit/66d67705f75d660b4ec5327af5ed9acbf28b5f3e", "message": "remove the dependency", "committedDate": "2020-06-14T07:45:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxOTE4MQ==", "url": "https://github.com/apache/hudi/pull/1720#discussion_r439819181", "bodyText": "I think we would remove this assert.", "author": "leesf", "createdAt": "2020-06-14T11:22:42Z", "path": "hudi-hive-sync/src/test/java/org/apache/hudi/hive/TestHiveSyncTool.java", "diffHunk": "@@ -457,6 +457,37 @@ public void testMultiPartitionKeySync(boolean useJdbc) throws Exception {\n         \"The last commit that was sycned should be updated in the TBLPROPERTIES\");\n   }\n \n+  @ParameterizedTest\n+  @MethodSource(\"useJdbc\")\n+  public void testNonPartitionedSync(boolean useJdbc) throws Exception {\n+    HiveTestUtil.hiveSyncConfig.useJdbc = useJdbc;\n+    String instantTime = \"100\";\n+    HiveTestUtil.createCOWTable(instantTime, 5, true);\n+\n+    HiveSyncConfig hiveSyncConfig = HiveSyncConfig.copy(HiveTestUtil.hiveSyncConfig);\n+    // Set partition value extractor to NonPartitionedExtractor\n+    hiveSyncConfig.partitionValueExtractorClass = NonPartitionedExtractor.class.getCanonicalName();\n+    hiveSyncConfig.tableName = \"non_partitioned\";\n+    hiveSyncConfig.partitionFields = Arrays.asList(\"year\", \"month\", \"day\");\n+    HiveTestUtil.getCreatedTablesSet().add(hiveSyncConfig.databaseName + \".\" + hiveSyncConfig.tableName);\n+\n+    HoodieHiveClient hiveClient = new HoodieHiveClient(hiveSyncConfig, HiveTestUtil.getHiveConf(), HiveTestUtil.fileSystem);\n+    assertFalse(hiveClient.doesTableExist(hiveSyncConfig.tableName),\n+            \"Table \" + hiveSyncConfig.tableName + \" should not exist initially\");\n+    // Lets do the sync\n+    HiveSyncTool tool = new HiveSyncTool(hiveSyncConfig, HiveTestUtil.getHiveConf(), HiveTestUtil.fileSystem);\n+    tool.syncHoodieTable();\n+    assertTrue(hiveClient.doesTableExist(hiveSyncConfig.tableName),\n+            \"Table \" + hiveSyncConfig.tableName + \" should exist after sync completes\");\n+    assertEquals(hiveClient.getTableSchema(hiveSyncConfig.tableName).size(),\n+            hiveClient.getDataSchema().getColumns().size(),\n+            \"Hive Schema should match the table schema\uff0cignoring the partition fields\");\n+    assertEquals(0, hiveClient.scanTablePartitions(hiveSyncConfig.tableName).size(),\n+            \"Table should not have partitions because of the NonPartitionedExtractor\");\n+    assertEquals(0, hiveClient.getTablePartitionKeys(hiveSyncConfig.tableName).size(),\n+            \"Table should not have partition keys because of the NonPartitionedExtractor\");", "originalCommit": "66d67705f75d660b4ec5327af5ed9acbf28b5f3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgzMjUwMQ==", "url": "https://github.com/apache/hudi/pull/1720#discussion_r439832501", "bodyText": "Yes we do not need it indeed. Done. Thanks for your review.", "author": "cloud-luoyajun", "createdAt": "2020-06-14T13:55:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTgxOTE4MQ=="}], "type": "inlineReview"}, {"oid": "ca0ebc68fd5fc1795381fad171253b618af72125", "url": "https://github.com/apache/hudi/commit/ca0ebc68fd5fc1795381fad171253b618af72125", "message": "Remove some logic", "committedDate": "2020-06-14T13:53:32Z", "type": "commit"}, {"oid": "513d74394d8f59e0e63d55b9c66efa781b2ce34a", "url": "https://github.com/apache/hudi/commit/513d74394d8f59e0e63d55b9c66efa781b2ce34a", "message": "Scalastyle repair", "committedDate": "2020-06-14T23:52:10Z", "type": "commit"}, {"oid": "095416f4b3f4ffa327800c751e291bad151a85fd", "url": "https://github.com/apache/hudi/commit/095416f4b3f4ffa327800c751e291bad151a85fd", "message": "trigger rebuild", "committedDate": "2020-06-15T01:05:37Z", "type": "commit"}]}