{"pr_number": 2094, "pr_title": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable", "pr_createdAt": "2020-09-17T20:22:05Z", "pr_url": "https://github.com/apache/hudi/pull/2094", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MDQzOQ==", "url": "https://github.com/apache/hudi/pull/2094#discussion_r490540439", "bodyText": "just reordering the APIs. API order is sth like inflight commit, commit, basefile, logfile,", "author": "xushiyan", "createdAt": "2020-09-17T20:24:45Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestTable.java", "diffHunk": "@@ -268,16 +292,16 @@ public boolean baseFileExists(String partition, String instantTime, String fileI\n     }\n   }\n \n-  public Path getPartitionPath(String partition) {\n-    return new Path(Paths.get(basePath, partition).toUri());\n-  }\n-\n-  public String getBaseFileNameById(String fileId) {\n-    return baseFileName(currentInstantTime, fileId);\n+  public boolean logFilesExist(String partition, String instantTime, String fileId, int... versions) {\n+    return Arrays.stream(versions).allMatch(v -> logFileExists(partition, instantTime, fileId, v));\n   }\n \n-  public Path getBaseFilePath(String partition, String fileId) {\n-    return new Path(Paths.get(basePath, partition, getBaseFileNameById(fileId)).toUri());\n+  public boolean logFileExists(String partition, String instantTime, String fileId, int version) {\n+    try {\n+      return fs.exists(new Path(Paths.get(basePath, partition, logFileName(instantTime, fileId, version)).toString()));\n+    } catch (IOException e) {\n+      throw new HoodieTestTableException(e);\n+    }", "originalCommit": "1b7c08c85a98f04ed782e0d27e1248bd733d7f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MDUxMA==", "url": "https://github.com/apache/hudi/pull/2094#discussion_r490540510", "bodyText": "ditto", "author": "xushiyan", "createdAt": "2020-09-17T20:24:52Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/HoodieTestTable.java", "diffHunk": "@@ -292,16 +316,16 @@ public Path getRequestedCompactionFilePath(String instantTime) {\n     return new Path(Paths.get(basePath, HoodieTableMetaClient.AUXILIARYFOLDER_NAME, instantTime + HoodieTimeline.REQUESTED_COMPACTION_EXTENSION).toUri());\n   }\n \n-  public boolean logFilesExist(String partition, String instantTime, String fileId, int... versions) {\n-    return Arrays.stream(versions).allMatch(v -> logFileExists(partition, instantTime, fileId, v));\n+  public Path getPartitionPath(String partition) {\n+    return new Path(Paths.get(basePath, partition).toUri());\n   }\n \n-  public boolean logFileExists(String partition, String instantTime, String fileId, int version) {\n-    try {\n-      return fs.exists(new Path(Paths.get(basePath, partition, logFileName(instantTime, fileId, version)).toString()));\n-    } catch (IOException e) {\n-      throw new HoodieTestTableException(e);\n-    }\n+  public Path getBaseFilePath(String partition, String fileId) {\n+    return new Path(Paths.get(basePath, partition, getBaseFileNameById(fileId)).toUri());\n+  }\n+\n+  public String getBaseFileNameById(String fileId) {\n+    return baseFileName(currentInstantTime, fileId);", "originalCommit": "1b7c08c85a98f04ed782e0d27e1248bd733d7f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MDk0MQ==", "url": "https://github.com/apache/hudi/pull/2094#discussion_r490540941", "bodyText": "Class that is not an actual test should not start with Test", "author": "xushiyan", "createdAt": "2020-09-17T20:25:38Z", "path": "hudi-common/src/test/java/org/apache/hudi/common/testutils/CompactionTestUtils.java", "diffHunk": "@@ -195,11 +195,11 @@ public static HoodieCompactionPlan createCompactionPlan(HoodieTableMetaClient me\n   /**\n    * The hoodie data file for testing.\n    */\n-  public static class TestHoodieBaseFile extends HoodieBaseFile {\n+  public static class DummyHoodieBaseFile extends HoodieBaseFile {", "originalCommit": "1b7c08c85a98f04ed782e0d27e1248bd733d7f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDU0MTUwMw==", "url": "https://github.com/apache/hudi/pull/2094#discussion_r490541503", "bodyText": "change to swtich for case completeness", "author": "xushiyan", "createdAt": "2020-09-17T20:26:40Z", "path": "hudi-client/src/test/java/org/apache/hudi/table/action/rollback/TestCopyOnWriteRollbackActionExecutor.java", "diffHunk": "@@ -94,34 +89,40 @@ public void testCopyOnWriteRollbackActionExecutorForFileListingAsGenerateFile()\n \n     // assert hoodieRollbackStats\n     assertEquals(hoodieRollbackStats.size(), 3);\n-    hoodieRollbackStats.forEach(stat -> {\n-      if (stat.getPartitionPath().equals(\"2015/03/16\")) {\n-        assertEquals(1, stat.getSuccessDeleteFiles().size());\n-        assertEquals(0, stat.getFailedDeleteFiles().size());\n-        assertEquals(Collections.EMPTY_MAP, stat.getCommandBlocksCount());\n-        assertEquals(\"file:\" + HoodieTestUtils.getDataFilePath(basePath, \"2015/03/16\", commitTime2, file21),\n-            stat.getSuccessDeleteFiles().get(0));\n-      } else if (stat.getPartitionPath().equals(\"2015/03/17\")) {\n-        assertEquals(1, stat.getSuccessDeleteFiles().size());\n-        assertEquals(0, stat.getFailedDeleteFiles().size());\n-        assertEquals(Collections.EMPTY_MAP, stat.getCommandBlocksCount());\n-        assertEquals(\"file:\" + HoodieTestUtils.getDataFilePath(basePath, \"2015/03/17\", commitTime2, file22),\n-            stat.getSuccessDeleteFiles().get(0));\n-      } else if (stat.getPartitionPath().equals(\"2016/03/15\")) {\n-        assertEquals(0, stat.getSuccessDeleteFiles().size());\n-        assertEquals(0, stat.getFailedDeleteFiles().size());\n-        assertEquals(Collections.EMPTY_MAP, stat.getCommandBlocksCount());\n+    for (HoodieRollbackStat stat : hoodieRollbackStats) {\n+      switch (stat.getPartitionPath()) {\n+        case p1:\n+          assertEquals(1, stat.getSuccessDeleteFiles().size());\n+          assertEquals(0, stat.getFailedDeleteFiles().size());\n+          assertEquals(Collections.EMPTY_MAP, stat.getCommandBlocksCount());\n+          assertEquals(testTable.forCommit(\"002\").getBaseFilePath(p1, \"id21\").toString(),\n+              stat.getSuccessDeleteFiles().get(0));\n+          break;\n+        case p2:\n+          assertEquals(1, stat.getSuccessDeleteFiles().size());\n+          assertEquals(0, stat.getFailedDeleteFiles().size());\n+          assertEquals(Collections.EMPTY_MAP, stat.getCommandBlocksCount());\n+          assertEquals(testTable.forCommit(\"002\").getBaseFilePath(p2, \"id22\").toString(),\n+              stat.getSuccessDeleteFiles().get(0));\n+          break;\n+        case p3:\n+          assertEquals(0, stat.getSuccessDeleteFiles().size());\n+          assertEquals(0, stat.getFailedDeleteFiles().size());\n+          assertEquals(Collections.EMPTY_MAP, stat.getCommandBlocksCount());\n+          break;\n+        default:\n+          fail(\"Unexpected partition: \" + stat.getPartitionPath());", "originalCommit": "1b7c08c85a98f04ed782e0d27e1248bd733d7f9a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "22c867db1a3eb59738b05904468487b4f3ae34a1", "url": "https://github.com/apache/hudi/commit/22c867db1a3eb59738b05904468487b4f3ae34a1", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nMigrate deprecated APIs in HoodieTestUtils to HoodieTestTable for test classes\n- TestClientRollback\n- TestCopyOnWriteRollbackActionExecutor\n\nUse FileCreateUtils APIs in CompactionTestUtils.\n\nThen remove unused deprecated APIs after migration.", "committedDate": "2020-09-18T18:53:48Z", "type": "commit"}, {"oid": "22c867db1a3eb59738b05904468487b4f3ae34a1", "url": "https://github.com/apache/hudi/commit/22c867db1a3eb59738b05904468487b4f3ae34a1", "message": "[HUDI-995] Migrate HoodieTestUtils APIs to HoodieTestTable\n\nMigrate deprecated APIs in HoodieTestUtils to HoodieTestTable for test classes\n- TestClientRollback\n- TestCopyOnWriteRollbackActionExecutor\n\nUse FileCreateUtils APIs in CompactionTestUtils.\n\nThen remove unused deprecated APIs after migration.", "committedDate": "2020-09-18T18:53:48Z", "type": "forcePushed"}]}