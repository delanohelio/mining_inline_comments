{"pr_number": 2231, "pr_title": "[HUDI-1373] Add Support for OpenJ9 JVM", "pr_createdAt": "2020-11-05T13:39:28Z", "pr_url": "https://github.com/apache/hudi/pull/2231", "timeline": [{"oid": "47521df673a6ba7697560860606e87eaaa72aeff", "url": "https://github.com/apache/hudi/commit/47521df673a6ba7697560860606e87eaaa72aeff", "message": "add supoort for OpenJ9 VM", "committedDate": "2020-11-01T08:54:47Z", "type": "commit"}, {"oid": "b3e05f195a51e81d33efb3920aa2bfbee2be01f7", "url": "https://github.com/apache/hudi/commit/b3e05f195a51e81d33efb3920aa2bfbee2be01f7", "message": "Merge branch 'master' into addOpenJ9Support", "committedDate": "2020-11-01T08:55:34Z", "type": "commit"}, {"oid": "47ea7c8a95e3080c8c3b25d7e0509a1091525164", "url": "https://github.com/apache/hudi/commit/47ea7c8a95e3080c8c3b25d7e0509a1091525164", "message": "minor fix", "committedDate": "2020-11-01T08:58:04Z", "type": "commit"}, {"oid": "d7642d44d4f0ea705c6039bd8589406c2dd0b864", "url": "https://github.com/apache/hudi/commit/d7642d44d4f0ea705c6039bd8589406c2dd0b864", "message": "add 32bit openJ9", "committedDate": "2020-11-02T06:54:50Z", "type": "commit"}, {"oid": "9be93b4596ba9c28d774f8cf8025fa46f62d6c40", "url": "https://github.com/apache/hudi/commit/9be93b4596ba9c28d774f8cf8025fa46f62d6c40", "message": "Merge branch 'master' into addOpenJ9Support", "committedDate": "2020-11-05T12:35:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzODExOQ==", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528438119", "bodyText": "Not directly related to this PR. But given we are now actually evolving this code. Does it make sense to declare all the MemoryLayoutSpecification objects as descriptively named classes? That way this method is very readable.  Food for thought.", "author": "vinothchandar", "createdAt": "2020-11-23T01:34:36Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/ObjectSizeCalculator.java", "diffHunk": "@@ -328,54 +328,53 @@ private static long getPrimitiveFieldSize(Class<?> type) {\n   static MemoryLayoutSpecification getEffectiveMemoryLayoutSpecification() {\n     final String vmName = System.getProperty(\"java.vm.name\");\n     if (vmName == null || !(vmName.startsWith(\"Java HotSpot(TM) \") || vmName.startsWith(\"OpenJDK\")\n-        || vmName.startsWith(\"TwitterJDK\"))) {\n-      throw new UnsupportedOperationException(\"ObjectSizeCalculator only supported on HotSpot VM\");\n+        || vmName.startsWith(\"TwitterJDK\") || vmName.startsWith(\"Eclipse OpenJ9\"))) {\n+      throw new UnsupportedOperationException(\"ObjectSizeCalculator only supported on HotSpot or Eclipse OpenJ9 VMs\");\n     }\n \n-    final String dataModel = System.getProperty(\"sun.arch.data.model\");\n-    if (\"32\".equals(dataModel)) {\n-      // Running with 32-bit data model\n-      return new MemoryLayoutSpecification() {\n-        @Override\n-        public int getArrayHeaderSize() {\n-          return 12;\n-        }\n+    final String strVmVersion = System.getProperty(\"java.vm.version\");\n+    // Support for OpenJ9 JVM\n+    if (strVmVersion.startsWith(\"openj9\")) {\n+      final String dataModel = System.getProperty(\"sun.arch.data.model\");\n+      if (\"32\".equals(dataModel)) {\n+        // Running with 32-bit data model\n+        return new MemoryLayoutSpecification() {", "originalCommit": "9be93b4596ba9c28d774f8cf8025fa46f62d6c40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc5ODUxNg==", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528798516", "bodyText": "agree, wasn't sure if it was a good idea to change this as part of this PR but I am happy to make the change.\nI was thinking of having HotSpotMemoryLayoutSpecification and OpenJ9MemoryLayoutSpecification classes, both will implement the MemoryLayoutSpecification interface and will get as a parameter the dataModel that will help it to determine whether it's 32 or 64 bit.\nis this what you had in mind?\nthe downside of this is that each function will in the interface will have multiple if's inside it. for example:\n@Override\n          public int getArrayHeaderSize() {\n            if (\"32\".equals(dataModel)) {\n              return 16;\n            } // assuming here 64 bit \n            else {\n              if (maxMemory < 30L * 1024 * 1024 * 1024) {\n                return 16;\n              } else {\n                return 14;\n              }\n            }\n          }\nanother option is to have class per each combination (hotspot 32 bit, hotspot 64 bit compressed, hotspot 64 bit non compressed, openj9 32 bit, openj9 64 bit compressed, and openj9 64 bit non compressed)", "author": "guykhazma", "createdAt": "2020-11-23T15:44:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzODExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODg3NzcwOA==", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528877708", "bodyText": "@guykhazma\n\nanother option is to have class per each combination (hotspot 32 bit, hotspot 64 bit compressed, hotspot 64 bit non compressed, openj9 32 bit, openj9 64 bit compressed, and openj9 64 bit non compressed)\n\nI was mulling something like this. not even parameterizing by dataModel. Just pulling all anonymous classes that exist now into named classes. So its easier to maintain. So far, we left this code as-is, given we borrowed it :)", "author": "vinothchandar", "createdAt": "2020-11-23T17:31:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzODExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0NjM0OA==", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528946348", "bodyText": "@vinothchandar I have moved all of the memory layout implementations to be under a package called jvm along with the interface.\nwhat do you think?", "author": "guykhazma", "createdAt": "2020-11-23T19:31:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzODExOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzE5MDUxOA==", "url": "https://github.com/apache/hudi/pull/2231#discussion_r533190518", "bodyText": "Hi @vinothchandar any comments?\nthanks", "author": "guykhazma", "createdAt": "2020-12-01T09:09:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQzODExOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MTE3MA==", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528441170", "bodyText": "Guess this was the original code. that only handled hotspot vm", "author": "vinothchandar", "createdAt": "2020-11-23T01:55:30Z", "path": "hudi-common/src/main/java/org/apache/hudi/common/util/ObjectSizeCalculator.java", "diffHunk": "@@ -384,9 +383,69 @@ public int getArrayHeaderSize() {\n \n           @Override\n           public int getObjectHeaderSize() {\n+            return 4;\n+          }\n+\n+          @Override\n+          public int getObjectPadding() {\n+            return 4;\n+          }\n+\n+          @Override\n+          public int getReferenceSize() {\n+            return 4;\n+          }\n+\n+          @Override\n+          public int getSuperclassFieldPadding() {\n+            return 4;\n+          }\n+        };\n+      } else {\n+        // it's a 64-bit uncompressed references object model\n+        return new MemoryLayoutSpecification() {\n+          @Override\n+          public int getArrayHeaderSize() {\n+            return 16;\n+          }\n+\n+          @Override\n+          public int getObjectHeaderSize() {\n+            return 16;\n+          }\n+\n+          @Override\n+          public int getObjectPadding() {\n+            return 8;\n+          }\n+\n+          @Override\n+          public int getReferenceSize() {\n+            return 8;\n+          }\n+\n+          @Override\n+          public int getSuperclassFieldPadding() {\n+            return 8;\n+          }\n+        };\n+      }\n+    } else {", "originalCommit": "9be93b4596ba9c28d774f8cf8025fa46f62d6c40", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODc5ODk1NA==", "url": "https://github.com/apache/hudi/pull/2231#discussion_r528798954", "bodyText": "right, the code for hotspot vm remained the same", "author": "guykhazma", "createdAt": "2020-11-23T15:44:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MTE3MA=="}], "type": "inlineReview"}, {"oid": "4a0107c3f71079ec6b776ba034728e8deb29067a", "url": "https://github.com/apache/hudi/commit/4a0107c3f71079ec6b776ba034728e8deb29067a", "message": "Merge branch 'master' into addOpenJ9Support", "committedDate": "2020-11-23T15:21:48Z", "type": "commit"}, {"oid": "f184406e6e0b7b091a3367cdc798f2699e8e99f2", "url": "https://github.com/apache/hudi/commit/f184406e6e0b7b091a3367cdc798f2699e8e99f2", "message": "refactor", "committedDate": "2020-11-23T19:25:43Z", "type": "commit"}, {"oid": "54a69be551d078a9d386db544ebd7c02dab273e6", "url": "https://github.com/apache/hudi/commit/54a69be551d078a9d386db544ebd7c02dab273e6", "message": "refactor", "committedDate": "2020-11-23T19:26:11Z", "type": "commit"}, {"oid": "11e5ce31f5ffb1cd1044942ecdff019b2c9918a9", "url": "https://github.com/apache/hudi/commit/11e5ce31f5ffb1cd1044942ecdff019b2c9918a9", "message": "add license", "committedDate": "2020-11-23T19:28:24Z", "type": "commit"}, {"oid": "4ce17628a17a8a378b0ae7ffa1aa5d3826a66933", "url": "https://github.com/apache/hudi/commit/4ce17628a17a8a378b0ae7ffa1aa5d3826a66933", "message": "Merge branch 'master' into addOpenJ9Support", "committedDate": "2020-12-01T09:11:18Z", "type": "commit"}]}