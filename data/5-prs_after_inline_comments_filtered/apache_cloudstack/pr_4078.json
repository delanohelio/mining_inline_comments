{"pr_number": 4078, "pr_title": "Cleanup download urls when SSVM destroyed", "pr_createdAt": "2020-05-11T12:20:35Z", "pr_url": "https://github.com/apache/cloudstack/pull/4078", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTY5Mg==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r425099692", "bodyText": "@ravening DatacenterId should be ok here, to cleanup urls as per the method implementation. But, in case of multiple SSVMs in the zone, this would delete all the download urls in that zone. May be better to cleanup by SSVM's public ip in that zone.", "author": "sureshanaparti", "createdAt": "2020-05-14T12:32:43Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3237,13 +3245,29 @@ protected void runInContext() {\n         }\n     }\n \n+    private void cleanupDownloadUrls(VMInstanceVO systemVm) {", "originalCommit": "2b475c25302a53bcd5acc392c698240fbe390e6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwMTk2OQ==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r426501969", "bodyText": "Yes but I didnt pass it purposefully because in case in future we need to do further processing with the systemvm, we will have entire data. If I just pass data center id, we dont have reference to systemvm", "author": "ravening", "createdAt": "2020-05-18T09:46:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDAwNDYzOA==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r524004638", "bodyText": "@ravening in case, any data is required for further processing in future in this method, the method definition/implementation can be updated based on the requirement in future. As the datacenter is only being used to cleanup the urls, so better use the datacenter id for the cleanup purpose here, and update the method name accordingly (suggestion below).\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void cleanupDownloadUrls(VMInstanceVO systemVm) {\n          \n          \n            \n                private void cleanupDownloadUrlsInZone(long zoneId) {", "author": "sureshanaparti", "createdAt": "2020-11-16T09:13:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEyNjEzMA==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r524126130", "bodyText": "ping @ravening. Can you answer @sureshanaparti here?", "author": "DaanHoogland", "createdAt": "2020-11-16T11:02:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEyNjE4OA==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r524126188", "bodyText": "ping @ravening , please update on this. thanks.", "author": "sureshanaparti", "createdAt": "2020-11-16T11:02:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDEzNjI2Ng==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r524136266", "bodyText": "ping @ravening , please update on this. thanks.\n\n@sureshanaparti i would rather prefer to keep the method definition as is rather than changing it again future which I double work", "author": "ravening", "createdAt": "2020-11-16T11:11:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE0NTIzNQ==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r524145235", "bodyText": "@ravening the download urls are related to zone, so I recommend to go with zone id, which is relavent. Passing systemVm (VMInstanceVO of SSVM) is irrelevant here. Not sure what will be the future double work you are pointing to.", "author": "sureshanaparti", "createdAt": "2020-11-16T11:20:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTA5OTY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTU5ODk4MQ==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r461598981", "bodyText": "can you extract these two blocks in methods with good descriptive names please?", "author": "DaanHoogland", "createdAt": "2020-07-28T13:55:30Z", "path": "server/src/main/java/com/cloud/storage/VolumeApiServiceImpl.java", "diffHunk": "@@ -2698,9 +2701,40 @@ public String extractVolume(ExtractVolumeCmd cmd) {\n         }\n \n         // Check if the url already exists\n-        VolumeDataStoreVO volumeStoreRef = _volumeStoreDao.findByVolume(volumeId);\n+        SearchCriteria<VolumeDataStoreVO> sc = _volumeStoreDao.createSearchCriteria();\n+        sc.addAnd(\"state\", SearchCriteria.Op.EQ, ObjectInDataStoreStateMachine.State.Ready.toString());\n+        sc.addAnd(\"volumeId\", SearchCriteria.Op.EQ, volumeId);\n+        sc.addAnd(\"destroyed\", SearchCriteria.Op.EQ, false);\n+        // the volume should not change (attached/detached, vm not updated) after created\n+        if (volume.getVolumeType() == Volume.Type.ROOT) { // for ROOT disk\n+            VMInstanceVO vm = _vmInstanceDao.findById(volume.getInstanceId());\n+            sc.addAnd(\"updated\", SearchCriteria.Op.GTEQ, vm.getUpdateTime());\n+        } else if (volume.getVolumeType() == Volume.Type.DATADISK && volume.getInstanceId() == null) { // for not attached DATADISK\n+            sc.addAnd(\"updated\", SearchCriteria.Op.GTEQ, volume.getUpdated());\n+        } else { // for attached DATA DISK\n+            VMInstanceVO vm = _vmInstanceDao.findById(volume.getInstanceId());\n+            sc.addAnd(\"updated\", SearchCriteria.Op.GTEQ, vm.getUpdateTime());\n+            sc.addAnd(\"updated\", SearchCriteria.Op.GTEQ, volume.getUpdated());\n+        }\n+        Filter filter = new Filter(VolumeDataStoreVO.class, \"created\", false, 0L, 1L);\n+        List<VolumeDataStoreVO> volumeStoreRefs = _volumeStoreDao.search(sc, filter);\n+        VolumeDataStoreVO volumeStoreRef = null;\n+        if (volumeStoreRefs != null && !volumeStoreRefs.isEmpty()) {\n+            volumeStoreRef = volumeStoreRefs.get(0);\n+        }\n         if (volumeStoreRef != null && volumeStoreRef.getExtractUrl() != null) {\n             return volumeStoreRef.getExtractUrl();\n+        } else if (volumeStoreRef != null) {\n+            s_logger.debug(\"volume \" + volumeId + \" is already installed on secondary storage, install path is \" +\n+                                    volumeStoreRef.getInstallPath());\n+            ImageStoreEntity secStore = (ImageStoreEntity) dataStoreMgr.getDataStore(volumeStoreRef.getDataStoreId(), DataStoreRole.Image);\n+            String extractUrl = secStore.createEntityExtractUrl(volumeStoreRef.getInstallPath(), volume.getFormat(), null);\n+            volumeStoreRef = _volumeStoreDao.findByVolume(volumeId);\n+            volumeStoreRef.setExtractUrl(extractUrl);\n+            volumeStoreRef.setExtractUrlCreated(DateUtil.now());\n+            _volumeStoreDao.update(volumeStoreRef.getId(), volumeStoreRef);\n+            return extractUrl;", "originalCommit": "2b475c25302a53bcd5acc392c698240fbe390e6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYwMDYwNQ==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r461600605", "bodyText": "hm, that would be an easy check, wonder if that is all.", "author": "DaanHoogland", "createdAt": "2020-07-28T13:57:37Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/template/UploadManagerImpl.java", "diffHunk": "@@ -307,12 +307,15 @@ public Answer handleDeleteEntityDownloadURLCommand(DeleteEntityDownloadURLComman\n \n         //We just need to remove the UUID.vhd\n         String extractUrl = cmd.getExtractUrl();\n-        command.add(\"unlink /var/www/html/userdata/\" + extractUrl.substring(extractUrl.lastIndexOf(File.separator) + 1));\n-        String result = command.execute();\n-        if (result != null) {\n-            // FIXME - Ideally should bail out if you cant delete symlink. Not doing it right now.\n-            // This is because the ssvm might already be destroyed and the symlinks do not exist.\n-            s_logger.warn(\"Error in deleting symlink :\" + result);\n+        String result;\n+        if (extractUrl != null) {\n+            command.add(\"unlink /var/www/html/userdata/\" + extractUrl.substring(extractUrl.lastIndexOf(File.separator) + 1));\n+            result = command.execute();\n+            if (result != null) {\n+                // FIXME - Ideally should bail out if you cant delete symlink. Not doing it right now.\n+                // This is because the ssvm might already be destroyed and the symlinks do not exist.\n+                s_logger.warn(\"Error in deleting symlink :\" + result);", "originalCommit": "2b475c25302a53bcd5acc392c698240fbe390e6a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwNTQxMA==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r493205410", "bodyText": "@ravening would that cause a regression, to not expunge uploaded volumes?", "author": "rhtyd", "createdAt": "2020-09-23T05:26:29Z", "path": "services/secondary-storage/controller/src/main/java/org/apache/cloudstack/secondarystorage/SecondaryStorageManagerImpl.java", "diffHunk": "@@ -744,9 +743,6 @@ private void allocCapacity(long dataCenterId, SecondaryStorageVm.Role role) {\n                 if (_allocLock.lock(ACQUIRE_GLOBAL_LOCK_TIMEOUT_FOR_SYNC)) {\n                     try {\n                         secStorageVm = startNew(dataCenterId, role);\n-                        for (UploadVO upload : _uploadDao.listAll()) {", "originalCommit": "2b475c25302a53bcd5acc392c698240fbe390e6a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA4ODM0NQ==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r514088345", "bodyText": "@ravening can you answer this question, please?", "author": "DaanHoogland", "createdAt": "2020-10-29T08:41:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwNTQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk4ODgwNA==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r525988804", "bodyText": "@rhtyd @DaanHoogland I tested by uploading volumes from local as well as from url but upload tables were still empty. So looks like uploaded volume/template entries are not stored in this table.", "author": "ravening", "createdAt": "2020-11-18T10:47:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzIwNTQxMA=="}], "type": "inlineReview"}, {"oid": "28efc8354e244b914d2b62bcaa7ba743f059c557", "url": "https://github.com/apache/cloudstack/commit/28efc8354e244b914d2b62bcaa7ba743f059c557", "message": "CLSTACK-7189 - Cleanup download urls when SSVM destroyed\n\n1. When SSVM is destroyed the downloaded urls of\n   template and volumes are not cleaned and because\n   of that we cant download the templates/volumes\n   using the download_url link\n\n2. cleanup volumes in secondary storage when ssvm is destroyed\n\n3. It should clean up the download urls for the templates belonging to the zone where ssvm is running\n\nSteps to test\n\nBefore the fix\n\n(1) download template (check download_url in template_store_ref table).\n(2) destroy ssvm\n(3) download template again\n(4) It will fail to download\n\nAfter the fix\n\n1. Download template\n2. Destroy ssvm\n3. This will cleanup the download_url in template_store_ref table\n4. Try to download template again\n5. Download will be successful\n\nTest case 2\n\nBefore the fix\n\n1. create a vm\n2. stop a vm\n3. download volume\n   Volume stored in\n   https://10.1.1.2/userdata/2dc15926-eaa4-49f8-9d3c-e71bdbe9d39f.qcow2\n4. start/stop ssvm\n5. start/stop vm\n6. download volume\n   Volume stored in\n   https://10.1.1.2/userdata/2dc15926-eaa4-49f8-9d3c-e71bdbe9d39f.qcow2\n\nExpected result\nvolumes in step3 and step 5 are different\n\nActual result\nvolumes in step 3 and 5 are same.\n\nAfter the fix\n\nvolumes in step 3 and 5 are different\n\nstep 3: http://10.11.1.2/userdata/7237c056-2a45-426b-b12e-13da9adab644.qcow2\n\nStep 5: http://10.11.1.2/userdata/9da05f2a-2abc-42b8-9adc-c0e41f36f0c4.qcow2", "committedDate": "2020-10-28T12:34:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1NzY3MA==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r524157670", "bodyText": "@ravening What if when one of the SSVM is destroyed (multiple SSVMs are created for a zone), which is created to meet the storage command sessions.", "author": "sureshanaparti", "createdAt": "2020-11-16T11:31:13Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -3286,13 +3294,29 @@ protected void runInContext() {\n         }\n     }\n \n+    private void cleanupDownloadUrls(VMInstanceVO systemVm) {\n+        // clean download URLs when destroying ssvm\n+        // clean only the volumes and templates of the zone\n+        // to which ssvm belongs to\n+        for (VolumeDataStoreVO volume :_volumeStoreDao.listVolumeDownloadUrlsByZoneId(systemVm.getDataCenterId())) {", "originalCommit": "28efc8354e244b914d2b62bcaa7ba743f059c557", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5MDUzNQ==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r525990535", "bodyText": "then the entries will be cleared.", "author": "ravening", "createdAt": "2020-11-18T10:50:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1NzY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAyNzUwMg==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r526027502", "bodyText": "then the entries will be cleared.\n\nok @ravening, so all the zone url entries are deleted irrespective of the SSVM ip in the url, and a new url is generated whenever user/operator requests download. am i correct?", "author": "sureshanaparti", "createdAt": "2020-11-18T11:51:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1NzY3MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA0NjY3NQ==", "url": "https://github.com/apache/cloudstack/pull/4078#discussion_r526046675", "bodyText": "@sureshanaparti yes", "author": "ravening", "createdAt": "2020-11-18T12:25:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDE1NzY3MA=="}], "type": "inlineReview"}, {"oid": "5f12081181ae5b18b1193f8c4f00e49e42517861", "url": "https://github.com/apache/cloudstack/commit/5f12081181ae5b18b1193f8c4f00e49e42517861", "message": "CLSTACK-7189 - Cleanup download urls when SSVM destroyed\n\n1. When SSVM is destroyed the downloaded urls of\n   template and volumes are not cleaned and because\n   of that we cant download the templates/volumes\n   using the download_url link\n\n2. cleanup volumes in secondary storage when ssvm is destroyed\n\n3. It should clean up the download urls for the templates belonging to the zone where ssvm is running\n\nSteps to test\n\nBefore the fix\n\n(1) download template (check download_url in template_store_ref table).\n(2) destroy ssvm\n(3) download template again\n(4) It will fail to download\n\nAfter the fix\n\n1. Download template\n2. Destroy ssvm\n3. This will cleanup the download_url in template_store_ref table\n4. Try to download template again\n5. Download will be successful\n\nTest case 2\n\nBefore the fix\n\n1. create a vm\n2. stop a vm\n3. download volume\n   Volume stored in\n   https://10.1.1.2/userdata/2dc15926-eaa4-49f8-9d3c-e71bdbe9d39f.qcow2\n4. start/stop ssvm\n5. start/stop vm\n6. download volume\n   Volume stored in\n   https://10.1.1.2/userdata/2dc15926-eaa4-49f8-9d3c-e71bdbe9d39f.qcow2\n\nExpected result\nvolumes in step3 and step 5 are different\n\nActual result\nvolumes in step 3 and 5 are same.\n\nAfter the fix\n\nvolumes in step 3 and 5 are different\n\nstep 3: http://10.11.1.2/userdata/7237c056-2a45-426b-b12e-13da9adab644.qcow2\n\nStep 5: http://10.11.1.2/userdata/9da05f2a-2abc-42b8-9adc-c0e41f36f0c4.qcow2", "committedDate": "2020-11-18T09:57:22Z", "type": "commit"}, {"oid": "6bc8281d218b4a04dbab1b6ec596d53ec64485db", "url": "https://github.com/apache/cloudstack/commit/6bc8281d218b4a04dbab1b6ec596d53ec64485db", "message": "code refactor", "committedDate": "2020-11-18T10:50:59Z", "type": "commit"}, {"oid": "6bc8281d218b4a04dbab1b6ec596d53ec64485db", "url": "https://github.com/apache/cloudstack/commit/6bc8281d218b4a04dbab1b6ec596d53ec64485db", "message": "code refactor", "committedDate": "2020-11-18T10:50:59Z", "type": "forcePushed"}]}