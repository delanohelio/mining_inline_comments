{"pr_number": 4032, "pr_title": "Suspending the VM prior to deleting snapshots to avoid corruption, th\u2026", "pr_createdAt": "2020-04-15T19:12:18Z", "pr_url": "https://github.com/apache/cloudstack/pull/4032", "timeline": [{"oid": "eaab9ae16030d9af66c10e9df04192ff06aad3f5", "url": "https://github.com/apache/cloudstack/commit/eaab9ae16030d9af66c10e9df04192ff06aad3f5", "message": "Suspending the VM prior to deleting snapshots to avoid corruption, then resuming", "committedDate": "2020-04-15T19:04:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDY4Nw==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r409490687", "bodyText": "Should we check if VM is running? (i.e. not in any other states)", "author": "rhtyd", "createdAt": "2020-04-16T11:43:09Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -51,14 +52,28 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n         final KVMStoragePoolManager storagePoolMgr = libvirtComputingResource.getStoragePoolMgr();\n         Domain dm = null;\n         DomainSnapshot snapshot = null;\n+        DomainInfo.DomainState state = null;\n+        boolean didDelete = false;\n+        Connect conn = null;\n         try {\n             final LibvirtUtilitiesHelper libvirtUtilitiesHelper = libvirtComputingResource.getLibvirtUtilitiesHelper();\n-            Connect conn = libvirtUtilitiesHelper.getConnection();\n+            conn = libvirtUtilitiesHelper.getConnection();\n             dm = libvirtComputingResource.getDomain(conn, vmName);\n \n             snapshot = dm.snapshotLookupByName(cmd.getTarget().getSnapshotName());\n \n+            // Suspend the VM prior to deleting the snapshot to guard against corruption\n+            dm.suspend();", "originalCommit": "eaab9ae16030d9af66c10e9df04192ff06aad3f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDgzNA==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r409490834", "bodyText": "May wrap in a try-with?", "author": "rhtyd", "createdAt": "2020-04-16T11:43:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDY4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MjUzMA==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r409492530", "bodyText": "does this mean you agree with my statement above, @rhtyd ?\nthe try catch won't work, it will succeed leaving a corrupt disk image (according to @andrijapanicsb 's tests)", "author": "DaanHoogland", "createdAt": "2020-04-16T11:46:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MDY4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MjA4OA==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r409492088", "bodyText": "dm is already not null, why overwrite it again?", "author": "rhtyd", "createdAt": "2020-04-16T11:45:49Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -93,12 +108,26 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             } else if (snapshot == null) {\n                 s_logger.debug(\"Can not find vm snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \", return true\");\n                 return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n+            } else if (didDelete) {\n+                s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n             }\n \n             s_logger.warn(msg, e);\n             return new DeleteVMSnapshotAnswer(cmd, false, msg);\n         } finally {\n             if (dm != null) {\n+                // Make sure if the VM is paused, then resume it, in case we got an exception during our delete() and didn't have the chance before\n+                try {\n+                    dm = libvirtComputingResource.getDomain(conn, vmName);", "originalCommit": "eaab9ae16030d9af66c10e9df04192ff06aad3f5", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MTQ3Mg==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r409551472", "bodyText": "I was under the impression that dm needed to be refreshed after a state change, as I saw this same thing being done in KVMStorageProcessor -> backupSnapshot(). Rather than validate that it was necessary or not, I decided that safer is always better, as refreshing the domain variable won't cause harm.", "author": "ggoodrich-ipp", "createdAt": "2020-04-16T13:22:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQ5MjA4OA=="}], "type": "inlineReview"}, {"oid": "30bd160c90e514342f31154f0aed7640ed4a6233", "url": "https://github.com/apache/cloudstack/commit/30bd160c90e514342f31154f0aed7640ed4a6233", "message": "Merge branch 'master' into gjg-snapshot-pause-vm", "committedDate": "2020-06-11T13:55:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4MDY3OA==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461380678", "bodyText": "can you extract this in a separate method please?", "author": "DaanHoogland", "createdAt": "2020-07-28T07:40:01Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -97,12 +108,26 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             } else if (snapshot == null) {\n                 s_logger.debug(\"Can not find vm snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \", return true\");\n                 return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n+            } else if (didDelete) {\n+                s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n             }\n \n             s_logger.warn(msg, e);\n             return new DeleteVMSnapshotAnswer(cmd, false, msg);\n         } finally {\n             if (dm != null) {\n+                // Make sure if the VM is paused, then resume it, in case we got an exception during our delete() and didn't have the chance before\n+                try {\n+                    dm = libvirtComputingResource.getDomain(conn, vmName);\n+                    state = dm.getInfo().state;\n+                    if (state == DomainInfo.DomainState.VIR_DOMAIN_PAUSED) {\n+                        dm.resume();\n+                    }\n+                } catch (LibvirtException e) {\n+                    s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                }\n+", "originalCommit": "30bd160c90e514342f31154f0aed7640ed4a6233", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4Mjk4Mg==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461382982", "bodyText": "resume action leads to an implicit assumption which must be guarded during maintenance by future generations: failing resume is concluded by examining a var named didDelete. dangerous assumption even with the current logic computing. see below.", "author": "DaanHoogland", "createdAt": "2020-07-28T07:44:11Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -63,6 +66,14 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             dm.suspend(); // suspend the vm to avoid image corruption\n \n             snapshot.delete(0); // only remove this snapshot, not children\n+            didDelete = true;\n+\n+            // Resume the VM\n+            dm = libvirtComputingResource.getDomain(conn, vmName);\n+            state = dm.getInfo().state;\n+            if (state == DomainInfo.DomainState.VIR_DOMAIN_PAUSED) {\n+                dm.resume();\n+            }", "originalCommit": "30bd160c90e514342f31154f0aed7640ed4a6233", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NDIzOQ==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461384239", "bodyText": "here a var didDelete leads us to conclude that the current exception thrown is caused by dm.resume(). this boolean should be named some thing like tryingResume instead. better would be to investigate the nature of the exception.", "author": "DaanHoogland", "createdAt": "2020-07-28T07:46:19Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -97,12 +108,26 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n             } else if (snapshot == null) {\n                 s_logger.debug(\"Can not find vm snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \", return true\");\n                 return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());\n+            } else if (didDelete) {\n+                s_logger.error(\"Failed to resume vm after delete snapshot \" + cmd.getTarget().getSnapshotName() + \" on vm: \" + vmName + \" return true : \" + e);\n+                return new DeleteVMSnapshotAnswer(cmd, cmd.getVolumeTOs());", "originalCommit": "30bd160c90e514342f31154f0aed7640ed4a6233", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NTA2Mw==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r461385063", "bodyText": "\ud83d\udc4d", "author": "DaanHoogland", "createdAt": "2020-07-28T07:47:52Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/storage/KVMStorageProcessor.java", "diffHunk": "@@ -1029,7 +1029,7 @@ public Answer backupSnapshot(final CopyCommand cmd) {\n                         }\n                     }\n                 } catch (final Exception ex) {\n-                    s_logger.debug(\"Failed to delete snapshots on primary\", ex);\n+                    s_logger.error(\"Failed to delete snapshots on primary\", ex);", "originalCommit": "30bd160c90e514342f31154f0aed7640ed4a6233", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "43f1c87b9a898288322aa75ecfab435635b36043", "url": "https://github.com/apache/cloudstack/commit/43f1c87b9a898288322aa75ecfab435635b36043", "message": "Making some adjustments based upon review", "committedDate": "2021-01-07T22:17:39Z", "type": "commit"}, {"oid": "214baede2d85b773c2207df6db2a821cdd86dac2", "url": "https://github.com/apache/cloudstack/commit/214baede2d85b773c2207df6db2a821cdd86dac2", "message": "Merge branch 'master' into gjg-snapshot-pause-vm", "committedDate": "2021-01-07T22:20:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NzEwNDg2OA==", "url": "https://github.com/apache/cloudstack/pull/4032#discussion_r567104868", "bodyText": "@ggoodrich-ipp\nshould it be \"DomainState\" instead of \"DomainInfo.DomainState\" ?", "author": "weizhouapache", "createdAt": "2021-01-29T21:31:03Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtDeleteVMSnapshotCommandWrapper.java", "diffHunk": "@@ -52,18 +52,33 @@ public Answer execute(final DeleteVMSnapshotCommand cmd, final LibvirtComputingR\n         final KVMStoragePoolManager storagePoolMgr = libvirtComputingResource.getStoragePoolMgr();\n         Domain dm = null;\n         DomainSnapshot snapshot = null;\n+        DomainInfo.DomainState oldState = null;", "originalCommit": "214baede2d85b773c2207df6db2a821cdd86dac2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "633438fdba7c80517e150596b683347f97986dec", "url": "https://github.com/apache/cloudstack/commit/633438fdba7c80517e150596b683347f97986dec", "message": "Fixing import", "committedDate": "2021-02-01T15:14:09Z", "type": "commit"}]}