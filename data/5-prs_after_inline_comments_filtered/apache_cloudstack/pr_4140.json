{"pr_number": 4140, "pr_title": "Adding showunique parameter to list templates and isos", "pr_createdAt": "2020-06-10T11:59:05Z", "pr_url": "https://github.com/apache/cloudstack/pull/4140", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkwNzg0Mw==", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r439907843", "bodyText": "@davidjumani add version 4.15", "author": "rhtyd", "createdAt": "2020-06-15T03:00:09Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/user/template/ListTemplatesCmd.java", "diffHunk": "@@ -78,6 +78,9 @@\n     @Parameter(name = ApiConstants.PARENT_TEMPLATE_ID, type = CommandType.UUID, entityType = TemplateResponse.class, description = \"list datadisk templates by parent template id\", since = \"4.4\")\n     private Long parentTemplateId;\n \n+    @Parameter(name = ApiConstants.SHOW_UNIQUE, type = CommandType.BOOLEAN, description = \"If set to true, list only unique templates across zones\")", "originalCommit": "c702dcd98b033572a24d284d3d25af34a047e179", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDUyMTk0Mg==", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r440521942", "bodyText": "@rhtyd this PR is aiming 4.13 branch. Considering the version 4.15, shouldn`t it aim master?", "author": "GabrielBrascher", "createdAt": "2020-06-16T00:40:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkwNzg0Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkwODAyNw==", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r439908027", "bodyText": "Can be simplified as return showUnique != null && showUnique;", "author": "rhtyd", "createdAt": "2020-06-15T03:00:53Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/user/iso/ListIsosCmd.java", "diffHunk": "@@ -118,6 +121,10 @@ public Boolean getShowRemoved() {\n         return (showRemoved != null ? showRemoved : false);\n     }\n \n+    public Boolean getShowUnique() {\n+        return (showUnique != null ? showUnique : false);", "originalCommit": "c702dcd98b033572a24d284d3d25af34a047e179", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkwODE0OQ==", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r439908149", "bodyText": "Please explore if you can simplify the code", "author": "rhtyd", "createdAt": "2020-06-15T03:01:29Z", "path": "server/src/main/java/com/cloud/api/query/QueryManagerImpl.java", "diffHunk": "@@ -3423,12 +3432,32 @@ else if (!template.isPublicTemplate() && caller.getType() != Account.ACCOUNT_TYP\n             return uniqueTmplPair;\n         }\n         List<TemplateJoinVO> uniqueTmpls = uniqueTmplPair.first();\n-        String[] tzIds = new String[uniqueTmpls.size()];\n         int i = 0;\n-        for (TemplateJoinVO v : uniqueTmpls) {\n-            tzIds[i++] = v.getTempZonePair();\n+        List<TemplateJoinVO> vrs = null;\n+        if (showUnique) {\n+            Long[] tzIds = new Long[uniqueTmpls.size()];\n+            for (TemplateJoinVO v : uniqueTmpls) {\n+                tzIds[i++] = v.getId();\n+            }\n+            vrs = _templateJoinDao.findByIds(tzIds);\n+\n+            // Get only unique id rows\n+            Long lastId = null;\n+            for(i = vrs.size() - 1; i >= 0; i--) {\n+                if (new Long(vrs.get(i).getId()).equals(lastId)) {\n+                    vrs.remove(i);", "originalCommit": "c702dcd98b033572a24d284d3d25af34a047e179", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDgzNTA1OQ==", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r440835059", "bodyText": "Unit testing for such a huge/complex method is not easy. However, it would be great to address small pieces.\nWith that said, lines 3436 - 3448 could be extracted into a method that would allow testing this specific piece of code.", "author": "GabrielBrascher", "createdAt": "2020-06-16T13:08:20Z", "path": "server/src/main/java/com/cloud/api/query/QueryManagerImpl.java", "diffHunk": "@@ -3423,12 +3432,22 @@ else if (!template.isPublicTemplate() && caller.getType() != Account.ACCOUNT_TYP\n             return uniqueTmplPair;\n         }\n         List<TemplateJoinVO> uniqueTmpls = uniqueTmplPair.first();\n-        String[] tzIds = new String[uniqueTmpls.size()];\n         int i = 0;\n-        for (TemplateJoinVO v : uniqueTmpls) {\n-            tzIds[i++] = v.getTempZonePair();\n+        List<TemplateJoinVO> vrs = null;\n+        if (showUnique) {\n+            Long[] tzIds = new Long[uniqueTmpls.size()];\n+            for (TemplateJoinVO v : uniqueTmpls) {\n+                tzIds[i++] = v.getId();\n+            }\n+            vrs = _templateJoinDao.findByDistinctIds(tzIds);\n+        } else {\n+            String[] tzIds = new String[uniqueTmpls.size()];\n+            for (TemplateJoinVO v : uniqueTmpls) {\n+                tzIds[i++] = v.getTempZonePair();\n+            }\n+            vrs = _templateJoinDao.searchByTemplateZonePair(showRemovedTmpl, tzIds);", "originalCommit": "c580555c27e87f59a12e52ac868df8df19fd48ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzNDg1NA==", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r441234854", "bodyText": "@davidjumani make it defensive, for example do a null check on ids", "author": "rhtyd", "createdAt": "2020-06-17T01:49:57Z", "path": "server/src/main/java/com/cloud/api/query/dao/TemplateJoinDaoImpl.java", "diffHunk": "@@ -481,4 +488,14 @@ public TemplateResponse newIsoResponse(TemplateJoinVO iso) {\n         return new Pair<List<TemplateJoinVO>, Integer>(objects, count);\n     }\n \n+    @Override\n+    public List<TemplateJoinVO> findByDistinctIds(Long... ids) {\n+        if (ids.length == 0) {", "originalCommit": "c580555c27e87f59a12e52ac868df8df19fd48ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTIzOTI4Ng==", "url": "https://github.com/apache/cloudstack/pull/4140#discussion_r441239286", "bodyText": "@davidjumani nit - let's refactor and use a more modern form of writing code, the current code looks less like Java, more like C/C++; can be written as:\nLong[] templateIds = uniqueTmpls.stream().map(template -> template.getId()).toArray(Long[]::new);", "author": "rhtyd", "createdAt": "2020-06-17T02:06:54Z", "path": "server/src/main/java/com/cloud/api/query/QueryManagerImpl.java", "diffHunk": "@@ -3423,12 +3432,22 @@ else if (!template.isPublicTemplate() && caller.getType() != Account.ACCOUNT_TYP\n             return uniqueTmplPair;\n         }\n         List<TemplateJoinVO> uniqueTmpls = uniqueTmplPair.first();\n-        String[] tzIds = new String[uniqueTmpls.size()];\n         int i = 0;\n-        for (TemplateJoinVO v : uniqueTmpls) {\n-            tzIds[i++] = v.getTempZonePair();\n+        List<TemplateJoinVO> vrs = null;\n+        if (showUnique) {\n+            Long[] tzIds = new Long[uniqueTmpls.size()];", "originalCommit": "c580555c27e87f59a12e52ac868df8df19fd48ff", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b271cb3e6d0c72b35b5789bb4fd1608a2a10a907", "url": "https://github.com/apache/cloudstack/commit/b271cb3e6d0c72b35b5789bb4fd1608a2a10a907", "message": "Refactoring for showUnique templates", "committedDate": "2020-06-17T04:42:34Z", "type": "forcePushed"}, {"oid": "35b5bfa2bd95b08a9a5cb61b50716504f7b00ef3", "url": "https://github.com/apache/cloudstack/commit/35b5bfa2bd95b08a9a5cb61b50716504f7b00ef3", "message": "Refactoring for showUnique templates", "committedDate": "2020-06-17T05:07:00Z", "type": "forcePushed"}, {"oid": "b2501452faeb473b355abc8ba9cc318b493285a9", "url": "https://github.com/apache/cloudstack/commit/b2501452faeb473b355abc8ba9cc318b493285a9", "message": "Adding showunique parameter to list templates and isos", "committedDate": "2020-06-17T05:17:36Z", "type": "commit"}, {"oid": "775e4872b104fd9238555025960de8108d3320a0", "url": "https://github.com/apache/cloudstack/commit/775e4872b104fd9238555025960de8108d3320a0", "message": "Update ListIsosCmd.java", "committedDate": "2020-06-17T05:17:46Z", "type": "commit"}, {"oid": "77ba5a873a97046cfa1ab4ad32a438d2894d1cd3", "url": "https://github.com/apache/cloudstack/commit/77ba5a873a97046cfa1ab4ad32a438d2894d1cd3", "message": "Update ListTemplatesCmd.java", "committedDate": "2020-06-17T05:17:52Z", "type": "commit"}, {"oid": "e9f48ff2d20d2b5dfb35a80341ef4cf9c4ac5cf6", "url": "https://github.com/apache/cloudstack/commit/e9f48ff2d20d2b5dfb35a80341ef4cf9c4ac5cf6", "message": "Update ListIsosCmd.java", "committedDate": "2020-06-17T05:17:55Z", "type": "commit"}, {"oid": "1997abf22c2d694e11ed6bd50e7a5ffabeb277ee", "url": "https://github.com/apache/cloudstack/commit/1997abf22c2d694e11ed6bd50e7a5ffabeb277ee", "message": "Fixing count bug", "committedDate": "2020-06-17T05:18:02Z", "type": "commit"}, {"oid": "8ccdfd190ff50d5c98fdec3ec9e3e59e5668aa36", "url": "https://github.com/apache/cloudstack/commit/8ccdfd190ff50d5c98fdec3ec9e3e59e5668aa36", "message": "Simplifying", "committedDate": "2020-06-17T05:18:07Z", "type": "commit"}, {"oid": "94963dffc16583a4dc8805c70fa11cf41c7f56b5", "url": "https://github.com/apache/cloudstack/commit/94963dffc16583a4dc8805c70fa11cf41c7f56b5", "message": "Update ListTemplatesCmd.java", "committedDate": "2020-06-17T05:18:20Z", "type": "commit"}, {"oid": "b83a4c47046d782114d74f32056150a89bd0190c", "url": "https://github.com/apache/cloudstack/commit/b83a4c47046d782114d74f32056150a89bd0190c", "message": "Update ListIsosCmd.java", "committedDate": "2020-06-17T05:18:24Z", "type": "commit"}, {"oid": "83bd4177373f131c64107983b90a806aacb46c5f", "url": "https://github.com/apache/cloudstack/commit/83bd4177373f131c64107983b90a806aacb46c5f", "message": "fix trailing white space - remind me to not use Github editor\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-06-17T05:18:28Z", "type": "commit"}, {"oid": "28137f6283093793c66497e97c3e101b12062429", "url": "https://github.com/apache/cloudstack/commit/28137f6283093793c66497e97c3e101b12062429", "message": "Refactoring for showUnique templates", "committedDate": "2020-06-17T05:18:32Z", "type": "commit"}, {"oid": "28137f6283093793c66497e97c3e101b12062429", "url": "https://github.com/apache/cloudstack/commit/28137f6283093793c66497e97c3e101b12062429", "message": "Refactoring for showUnique templates", "committedDate": "2020-06-17T05:18:32Z", "type": "forcePushed"}]}