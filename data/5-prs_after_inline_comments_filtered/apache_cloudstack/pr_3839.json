{"pr_number": 3839, "pr_title": "FEATURE-3823: kvm agent hooks", "pr_createdAt": "2020-01-27T03:55:30Z", "pr_url": "https://github.com/apache/cloudstack/pull/3839", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjcwMw==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r371242703", "bodyText": "I previously saw code like this in https://github.com/apache/cloudstack/pull/3759/files. Does this belong into this PR?", "author": "DennisKonrad", "createdAt": "2020-01-27T13:36:58Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1015,11 +1015,12 @@ public UserVm upgradeVirtualMachine(UpgradeVMCmd cmd) throws ResourceAllocationE\n         int currentCpu = currentServiceOffering.getCpu();\n         int currentMemory = currentServiceOffering.getRamSize();\n \n+        Account owner = _accountMgr.getActiveAccountById(vmInstance.getAccountId());\n         if (newCpu > currentCpu) {\n-            _resourceLimitMgr.checkResourceLimit(caller, ResourceType.cpu, newCpu - currentCpu);\n+            _resourceLimitMgr.checkResourceLimit(owner, ResourceType.cpu, newCpu - currentCpu);\n         }\n         if (newMemory > currentMemory) {\n-            _resourceLimitMgr.checkResourceLimit(caller, ResourceType.memory, newMemory - currentMemory);\n+            _resourceLimitMgr.checkResourceLimit(owner, ResourceType.memory, newMemory - currentMemory);\n         }\n \n         // Check that the specified service offering ID is valid", "originalCommit": "4a923209e535a10c52b2eb3910c7b9929027709f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTMxMjk2MQ==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r371312961", "bodyText": "@DennisKonrad I do not think so.\n@bwsw could you use \"git rebase\" with latest master, instead of \"git merge\" ?", "author": "weizhouapache", "createdAt": "2020-01-27T15:38:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjcwMw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYzMDI3OA==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r371630278", "bodyText": "@weizhouapache @DennisKonrad resolved.", "author": "bwsw", "createdAt": "2020-01-28T06:41:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MjcwMw=="}], "type": "inlineReview"}, {"oid": "5cb058858008d7f62f101471e9ef6dfb31ddf669", "url": "https://github.com/apache/cloudstack/commit/5cb058858008d7f62f101471e9ef6dfb31ddf669", "message": "Implemented KVM hooks.", "committedDate": "2020-01-28T06:36:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg0MzgzNg==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r383843836", "bodyText": "can you add a call configureAgentHooks()?", "author": "DaanHoogland", "createdAt": "2020-02-25T12:18:35Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -1065,6 +1089,48 @@ public boolean configure(final String name, final Map<String, Object> params) th\n         value = (String) params.get(\"vm.migrate.pauseafter\");\n         _migratePauseAfter = NumbersUtil.parseInt(value, -1);\n \n+        value = (String) params.get(\"agent.hooks.basedir\");\n+        if (null != value) {\n+            _agentHooksBasedir = value;\n+        }\n+        s_logger.debug(\"agent.hooks.basedir is \" + _agentHooksBasedir);\n+\n+        value = (String) params.get(\"agent.hooks.libvirt_vm_xml_transformer.script\");\n+        if (null != value) {\n+            _agentHooksLibvirtXmlScript = value;\n+        }\n+        s_logger.debug(\"agent.hooks.libvirt_vm_xml_transformer.script is \" + _agentHooksLibvirtXmlScript);\n+\n+        value = (String) params.get(\"agent.hooks.libvirt_vm_xml_transformer.method\");\n+        if (null != value) {\n+            _agentHooksLibvirtXmlMethod = value;\n+        }\n+        s_logger.debug(\"agent.hooks.libvirt_vm_xml_transformer.method is \" + _agentHooksLibvirtXmlMethod);\n+\n+        value = (String) params.get(\"agent.hooks.libvirt_vm_on_start.script\");\n+        if (null != value) {\n+            _agentHooksVmOnStartScript = value;\n+        }\n+        s_logger.debug(\"agent.hooks.libvirt_vm_on_start.script is \" + _agentHooksVmOnStartScript);\n+\n+        value = (String) params.get(\"agent.hooks.libvirt_vm_on_start.method\");\n+        if (null != value) {\n+            _agentHooksVmOnStartMethod = value;\n+        }\n+        s_logger.debug(\"agent.hooks.libvirt_vm_on_start.method is \" + _agentHooksVmOnStartMethod);\n+\n+        value = (String) params.get(\"agent.hooks.libvirt_vm_on_stop.script\");\n+        if (null != value) {\n+            _agentHooksVmOnStopScript = value;\n+        }\n+        s_logger.debug(\"agent.hooks.libvirt_vm_on_stop.script is \" + _agentHooksVmOnStopScript);\n+\n+        value = (String) params.get(\"agent.hooks.libvirt_vm_on_stop.method\");\n+        if (null != value) {\n+            _agentHooksVmOnStopMethod = value;\n+        }\n+        s_logger.debug(\"agent.hooks.libvirt_vm_on_stop.method is \" + _agentHooksVmOnStopMethod);", "originalCommit": "934552b79101ca02622fc4a799d02b188532d1bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg0NDI5Mg==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r383844292", "bodyText": "can you add a call performAgentTransformHook(..) here?", "author": "DaanHoogland", "createdAt": "2020-02-25T12:19:36Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtStartCommandWrapper.java", "diffHunk": "@@ -79,7 +79,28 @@ public Answer execute(final StartCommand command, final LibvirtComputingResource\n             libvirtComputingResource.createVifs(vmSpec, vm);\n \n             s_logger.debug(\"starting \" + vmName + \": \" + vm.toString());\n-            libvirtComputingResource.startVM(conn, vmName, vm.toString());\n+            String vmInitialSpecification = vm.toString();\n+            String vmFinalSpecification;\n+            try {\n+                // if transformer fails, everything must go as it's just skipped.\n+                LibvirtKvmAgentHook t = libvirtComputingResource.getTransformer();\n+                vmFinalSpecification = (String) t.handle(vmInitialSpecification);\n+                if (null == vmFinalSpecification) {\n+                    s_logger.warn(\"Libvirt XML transformer returned NULL, will use XML specification unchanged.\");\n+                    vmFinalSpecification = vmInitialSpecification;\n+                }\n+            } catch(Exception e) {\n+                s_logger.warn(\"Exception occured when handling LibVirt XML transformer hook: {}\", e);\n+                vmFinalSpecification = vmInitialSpecification;\n+            }", "originalCommit": "934552b79101ca02622fc4a799d02b188532d1bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg0NDQzNA==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r383844434", "bodyText": "and performAgentStartHook(..) here?", "author": "DaanHoogland", "createdAt": "2020-02-25T12:19:58Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtStartCommandWrapper.java", "diffHunk": "@@ -79,7 +79,28 @@ public Answer execute(final StartCommand command, final LibvirtComputingResource\n             libvirtComputingResource.createVifs(vmSpec, vm);\n \n             s_logger.debug(\"starting \" + vmName + \": \" + vm.toString());\n-            libvirtComputingResource.startVM(conn, vmName, vm.toString());\n+            String vmInitialSpecification = vm.toString();\n+            String vmFinalSpecification;\n+            try {\n+                // if transformer fails, everything must go as it's just skipped.\n+                LibvirtKvmAgentHook t = libvirtComputingResource.getTransformer();\n+                vmFinalSpecification = (String) t.handle(vmInitialSpecification);\n+                if (null == vmFinalSpecification) {\n+                    s_logger.warn(\"Libvirt XML transformer returned NULL, will use XML specification unchanged.\");\n+                    vmFinalSpecification = vmInitialSpecification;\n+                }\n+            } catch(Exception e) {\n+                s_logger.warn(\"Exception occured when handling LibVirt XML transformer hook: {}\", e);\n+                vmFinalSpecification = vmInitialSpecification;\n+            }\n+            libvirtComputingResource.startVM(conn, vmName, vmFinalSpecification);\n+\n+            try {\n+                LibvirtKvmAgentHook onStartHook = libvirtComputingResource.getStartHook();\n+                onStartHook.handle(vmName);\n+            } catch (Exception e) {\n+                s_logger.warn(\"Exception occured when handling LibVirt VM onStart hook: {}\", e);\n+            }", "originalCommit": "934552b79101ca02622fc4a799d02b188532d1bc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg0NDkyMg==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r383844922", "bodyText": "can you put this in a separate method?", "author": "DaanHoogland", "createdAt": "2020-02-25T12:21:00Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtStopCommandWrapper.java", "diffHunk": "@@ -92,6 +93,13 @@ public Answer execute(final StopCommand command, final LibvirtComputingResource\n             libvirtComputingResource.destroyNetworkRulesForVM(conn, vmName);\n             final String result = libvirtComputingResource.stopVM(conn, vmName, command.isForceStop());\n \n+            try {\n+                LibvirtKvmAgentHook onStopHook = libvirtComputingResource.getStopHook();\n+                onStopHook.handle(vmName);\n+            } catch (Exception e) {\n+                s_logger.warn(\"Exception occured when handling LibVirt VM onStop hook: {}\", e);\n+            }", "originalCommit": "934552b79101ca02622fc4a799d02b188532d1bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDMwNDAzMQ==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r384304031", "bodyText": "@DaanHoogland I'll handle all your comments tomorrow.", "author": "bwsw", "createdAt": "2020-02-26T06:59:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg0NDkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjA0OTIxMg==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r386049212", "bodyText": "ping, did you manage?", "author": "DaanHoogland", "createdAt": "2020-02-29T19:16:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg0NDkyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyOTExMw==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r392129113", "bodyText": "@DaanHoogland fixed every your notes.", "author": "bwsw", "createdAt": "2020-03-13T09:55:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mzg0NDkyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NzQwOQ==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r385577409", "bodyText": "@bwsw I did not review the whole PR, is it related or similar to http://docs.cloudstack.apache.org/en/latest/adminguide/hosts.html#kvm-libvirt-hook-script-include ?", "author": "rhtyd", "createdAt": "2020-02-28T09:01:14Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -284,6 +284,18 @@\n     protected String _rngPath = \"/dev/random\";\n     protected int _rngRatePeriod = 1000;\n     protected int _rngRateBytes = 2048;\n+    protected String _agentHooksBasedir = \"/etc/cloudstack/agent/hooks\";", "originalCommit": "934552b79101ca02622fc4a799d02b188532d1bc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NzcxNQ==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r386197715", "bodyText": "@rhtyd no it's not exactly what does qemu-hooks:\n\nthere is no qemu hook to override/mangle XML\nqemu hooks deadlocks in certain cases (for onStart/onStop):\n\nA hook script must not call back into libvirt, as the libvirt daemon is already waiting for the script to exit.\n\nA deadlock is likely to occur.\n\nFrom: https://www.libvirt.org/hooks.html\nSo, libvirt qemu hooks are pretty tough stuff:", "author": "bwsw", "createdAt": "2020-03-02T04:57:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NzQwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5ODMxOA==", "url": "https://github.com/apache/cloudstack/pull/3839#discussion_r386198318", "bodyText": "Initially I tried to use qemu-hooks for my task, but lately moved my code to security groups python code, because, otherwise, it works unstable because of the reasons listed above.", "author": "bwsw", "createdAt": "2020-03-02T05:01:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTU3NzQwOQ=="}], "type": "inlineReview"}, {"oid": "24a1298e5979455f90e322d534364ba9ef571d49", "url": "https://github.com/apache/cloudstack/commit/24a1298e5979455f90e322d534364ba9ef571d49", "message": "Implemented KVM hooks.", "committedDate": "2020-03-12T10:05:00Z", "type": "commit"}, {"oid": "24a1298e5979455f90e322d534364ba9ef571d49", "url": "https://github.com/apache/cloudstack/commit/24a1298e5979455f90e322d534364ba9ef571d49", "message": "Implemented KVM hooks.", "committedDate": "2020-03-12T10:05:00Z", "type": "forcePushed"}, {"oid": "9068dba1cda8034ce2256de2172169637dc94222", "url": "https://github.com/apache/cloudstack/commit/9068dba1cda8034ce2256de2172169637dc94222", "message": "Merge branch 'master' of https://github.com/apache/cloudstack into feature/3823-kvm-agent-hooks\n\n\u0001 Conflicts:\n\u0001\tplugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtStartCommandWrapper.java", "committedDate": "2020-03-12T10:14:32Z", "type": "commit"}, {"oid": "5a6c54a1ac4a0cb328369b1c2439e7f1662e1361", "url": "https://github.com/apache/cloudstack/commit/5a6c54a1ac4a0cb328369b1c2439e7f1662e1361", "message": "Fix", "committedDate": "2020-03-13T09:29:26Z", "type": "commit"}, {"oid": "4f72e2a1b48c15b1014b79376366b01719df3dbd", "url": "https://github.com/apache/cloudstack/commit/4f72e2a1b48c15b1014b79376366b01719df3dbd", "message": "Merge branch 'master' into feature/3823-kvm-agent-hooks", "committedDate": "2020-03-13T22:14:46Z", "type": "commit"}]}