{"pr_number": 4561, "pr_title": "Support for persistence mode in L2 networks", "pr_createdAt": "2020-12-30T11:05:33Z", "pr_url": "https://github.com/apache/cloudstack/pull/4561", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2MjIwNA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550162204", "bodyText": "@Pearl1594 can you start a discussion thread on dev@/users@ we want to see if it causes any backward compatibility issues for users", "author": "rhtyd", "createdAt": "2020-12-30T11:30:03Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/user/network/CreateNetworkCmd.java", "diffHunk": "@@ -48,7 +49,7 @@\n \n @APICommand(name = \"createNetwork\", description = \"Creates a network\", responseObject = NetworkResponse.class, responseView = ResponseView.Restricted, entityType = {Network.class},\n         requestHasSensitiveInfo = false, responseHasSensitiveInfo = false)\n-public class CreateNetworkCmd extends BaseCmd implements UserCmd {\n+public class CreateNetworkCmd extends BaseAsyncCmd implements UserCmd {", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2NzY0Mg==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550167642", "bodyText": "+1", "author": "nvazquez", "createdAt": "2020-12-30T11:50:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2MjIwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2ODc2NQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550168765", "bodyText": "Can you maybe rename this method and/or add javadoc to explain what does the pair returned mean?", "author": "nvazquez", "createdAt": "2020-12-30T11:54:41Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1827,6 +1844,26 @@ private void orchestrateStop(final String vmUuid, final boolean cleanUpEvenIfUna\n         advanceStop(vm, cleanUpEvenIfUnableToStop);\n     }\n \n+    private Map<String, Boolean> getVlanToPersistenceMapForVM(long vmId) {\n+        List<UserVmJoinVO> userVmJoinVOS = userVmJoinDao.searchByIds(vmId);\n+        Map<String, Boolean> vlanToPersistenceMap = new HashMap<>();\n+        for (UserVmJoinVO userVmJoinVO : userVmJoinVOS) {\n+            NetworkVO networkVO = _networkDao.findById(userVmJoinVO.getNetworkId());\n+            NetworkOfferingVO offeringVO = networkOfferingDao.findById(networkVO.getNetworkOfferingId());\n+            Pair<String, Boolean> data = getVMNetworkDetails(networkVO, offeringVO.isPersistent());\n+            vlanToPersistenceMap.put(data.first(), data.second());\n+        }\n+        return vlanToPersistenceMap;\n+    }\n+\n+    private Pair<String, Boolean> getVMNetworkDetails(NetworkVO networkVO, boolean isPersistent) {", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE2OTY1OQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550169659", "bodyText": "I think this condition could be refactored / split into multiple lines to increase readability", "author": "nvazquez", "createdAt": "2020-12-30T11:58:11Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1827,6 +1844,26 @@ private void orchestrateStop(final String vmUuid, final boolean cleanUpEvenIfUna\n         advanceStop(vm, cleanUpEvenIfUnableToStop);\n     }\n \n+    private Map<String, Boolean> getVlanToPersistenceMapForVM(long vmId) {\n+        List<UserVmJoinVO> userVmJoinVOS = userVmJoinDao.searchByIds(vmId);\n+        Map<String, Boolean> vlanToPersistenceMap = new HashMap<>();\n+        for (UserVmJoinVO userVmJoinVO : userVmJoinVOS) {\n+            NetworkVO networkVO = _networkDao.findById(userVmJoinVO.getNetworkId());\n+            NetworkOfferingVO offeringVO = networkOfferingDao.findById(networkVO.getNetworkOfferingId());\n+            Pair<String, Boolean> data = getVMNetworkDetails(networkVO, offeringVO.isPersistent());\n+            vlanToPersistenceMap.put(data.first(), data.second());\n+        }\n+        return vlanToPersistenceMap;\n+    }\n+\n+    private Pair<String, Boolean> getVMNetworkDetails(NetworkVO networkVO, boolean isPersistent) {\n+        URI broadcastUri = networkVO.getBroadcastUri();\n+        String scheme = broadcastUri.getScheme();\n+        String vlanId = Networks.BroadcastDomainType.getValue(broadcastUri);\n+        Boolean shouldDelete = !((networkVO.getGuestType() == Network.GuestType.L2 || networkVO.getGuestType() == Network.GuestType.Isolated) && scheme.equalsIgnoreCase(\"vlan\") && isPersistent);", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MDM0OA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550170348", "bodyText": "Please remove", "author": "nvazquez", "createdAt": "2020-12-30T12:00:38Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1187,6 +1200,68 @@ boolean isNetworkImplemented(final NetworkVO network) {\n         return implemented;\n     }\n \n+    private NicTO getNicTO(NetworkVO networkVO, NetworkOfferingVO networkOfferingVO) {\n+        NicTO to = new NicTO();\n+        to.setBroadcastType(networkVO.getBroadcastDomainType());\n+        to.setType(networkVO.getTrafficType());\n+        to.setBroadcastUri(networkVO.getBroadcastUri());\n+        to.setIsolationuri(networkVO.getBroadcastUri());\n+        to.setNetworkRateMbps(_configMgr.getNetworkOfferingNetworkRate(networkOfferingVO.getId(), networkVO.getDataCenterId()));\n+        to.setSecurityGroupEnabled(_networkModel.isSecurityGroupSupportedInNetwork(networkVO));\n+        return to;\n+    }\n+\n+    private boolean isNtwConfiguredInCluster(HostVO hostVO, Map<Long, List<Long>> clusterToHostsMap) {\n+        Long clusterId = hostVO.getClusterId();\n+        List<Long> hosts = clusterToHostsMap.get(clusterId);\n+        if (hosts == null) {\n+            hosts = new ArrayList<>();\n+        }\n+        if (hostVO.getHypervisorType() == HypervisorType.KVM) {\n+            hosts.add(hostVO.getId());\n+            clusterToHostsMap.put(clusterId, hosts);\n+            return false;\n+        }\n+        if (hosts != null && !hosts.isEmpty()) {\n+            return true;\n+        }\n+        hosts.add(hostVO.getId());\n+        clusterToHostsMap.put(clusterId, hosts);\n+        return false;\n+    }\n+\n+    private void setupPersistentNetwork(NetworkVO network, NetworkOfferingVO offering, Long dcId) throws AgentUnavailableException, OperationTimedoutException {\n+        NicTO to = getNicTO(network, offering);\n+        List<ClusterVO> clusterVOS = clusterDao.listClustersByDcId(dcId);\n+        List<HostVO> hosts = resourceManager.listAllUpAndEnabledHostsInOneZoneByType(Host.Type.Routing, dcId);\n+        Collections.reverse(hosts);\n+        Map<Long, List<Long>> clusterToHostsMap = new HashMap<>();\n+        SetupPersistentNetworkCommand cmd = new SetupPersistentNetworkCommand(to);\n+        for (HostVO host : hosts) {\n+            if (isNtwConfiguredInCluster(host, clusterToHostsMap)) {\n+                continue;\n+            }\n+            final SetupPersistentNetworkAnswer answer = (SetupPersistentNetworkAnswer)_agentMgr.send(host.getId(), cmd);\n+\n+            if (answer == null) {\n+                s_logger.warn(\"Unable to get an answer to the SetupPersistentNetworkCommand from agent:\" + host.getId());\n+                clusterToHostsMap.get(host.getClusterId()).remove(host.getId());\n+                continue;\n+                // throw new CloudRuntimeException(\"Unable to get an answer to the SetupPersistentNetworkCommand from agent: \" + host.getId());", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MDM4NQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550170385", "bodyText": "Same here", "author": "nvazquez", "createdAt": "2020-12-30T12:00:50Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1187,6 +1200,68 @@ boolean isNetworkImplemented(final NetworkVO network) {\n         return implemented;\n     }\n \n+    private NicTO getNicTO(NetworkVO networkVO, NetworkOfferingVO networkOfferingVO) {\n+        NicTO to = new NicTO();\n+        to.setBroadcastType(networkVO.getBroadcastDomainType());\n+        to.setType(networkVO.getTrafficType());\n+        to.setBroadcastUri(networkVO.getBroadcastUri());\n+        to.setIsolationuri(networkVO.getBroadcastUri());\n+        to.setNetworkRateMbps(_configMgr.getNetworkOfferingNetworkRate(networkOfferingVO.getId(), networkVO.getDataCenterId()));\n+        to.setSecurityGroupEnabled(_networkModel.isSecurityGroupSupportedInNetwork(networkVO));\n+        return to;\n+    }\n+\n+    private boolean isNtwConfiguredInCluster(HostVO hostVO, Map<Long, List<Long>> clusterToHostsMap) {\n+        Long clusterId = hostVO.getClusterId();\n+        List<Long> hosts = clusterToHostsMap.get(clusterId);\n+        if (hosts == null) {\n+            hosts = new ArrayList<>();\n+        }\n+        if (hostVO.getHypervisorType() == HypervisorType.KVM) {\n+            hosts.add(hostVO.getId());\n+            clusterToHostsMap.put(clusterId, hosts);\n+            return false;\n+        }\n+        if (hosts != null && !hosts.isEmpty()) {\n+            return true;\n+        }\n+        hosts.add(hostVO.getId());\n+        clusterToHostsMap.put(clusterId, hosts);\n+        return false;\n+    }\n+\n+    private void setupPersistentNetwork(NetworkVO network, NetworkOfferingVO offering, Long dcId) throws AgentUnavailableException, OperationTimedoutException {\n+        NicTO to = getNicTO(network, offering);\n+        List<ClusterVO> clusterVOS = clusterDao.listClustersByDcId(dcId);\n+        List<HostVO> hosts = resourceManager.listAllUpAndEnabledHostsInOneZoneByType(Host.Type.Routing, dcId);\n+        Collections.reverse(hosts);\n+        Map<Long, List<Long>> clusterToHostsMap = new HashMap<>();\n+        SetupPersistentNetworkCommand cmd = new SetupPersistentNetworkCommand(to);\n+        for (HostVO host : hosts) {\n+            if (isNtwConfiguredInCluster(host, clusterToHostsMap)) {\n+                continue;\n+            }\n+            final SetupPersistentNetworkAnswer answer = (SetupPersistentNetworkAnswer)_agentMgr.send(host.getId(), cmd);\n+\n+            if (answer == null) {\n+                s_logger.warn(\"Unable to get an answer to the SetupPersistentNetworkCommand from agent:\" + host.getId());\n+                clusterToHostsMap.get(host.getClusterId()).remove(host.getId());\n+                continue;\n+                // throw new CloudRuntimeException(\"Unable to get an answer to the SetupPersistentNetworkCommand from agent: \" + host.getId());\n+            }\n+\n+            if (!answer.getResult()) {\n+                s_logger.warn(\"Unable to setup agent \" + host.getId() + \" due to \" + answer.getDetails() );\n+//                final String msg = \"Incorrect Network setup on agent, Reinitialize agent after network names are setup, details : \" + answer.getDetails();", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MDYyMw==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550170623", "bodyText": "I think this method needs an explanatory javadoc as well", "author": "nvazquez", "createdAt": "2020-12-30T12:01:44Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1187,6 +1200,68 @@ boolean isNetworkImplemented(final NetworkVO network) {\n         return implemented;\n     }\n \n+    private NicTO getNicTO(NetworkVO networkVO, NetworkOfferingVO networkOfferingVO) {\n+        NicTO to = new NicTO();\n+        to.setBroadcastType(networkVO.getBroadcastDomainType());\n+        to.setType(networkVO.getTrafficType());\n+        to.setBroadcastUri(networkVO.getBroadcastUri());\n+        to.setIsolationuri(networkVO.getBroadcastUri());\n+        to.setNetworkRateMbps(_configMgr.getNetworkOfferingNetworkRate(networkOfferingVO.getId(), networkVO.getDataCenterId()));\n+        to.setSecurityGroupEnabled(_networkModel.isSecurityGroupSupportedInNetwork(networkVO));\n+        return to;\n+    }\n+\n+    private boolean isNtwConfiguredInCluster(HostVO hostVO, Map<Long, List<Long>> clusterToHostsMap) {", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MDg4Ng==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550170886", "bodyText": "Maybe renamed to createNicTOFromNetworkAndOffering() or similar?", "author": "nvazquez", "createdAt": "2020-12-30T12:02:46Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1187,6 +1200,68 @@ boolean isNetworkImplemented(final NetworkVO network) {\n         return implemented;\n     }\n \n+    private NicTO getNicTO(NetworkVO networkVO, NetworkOfferingVO networkOfferingVO) {", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MTI5Ng==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550171296", "bodyText": "Why is the list reversed at this point?", "author": "nvazquez", "createdAt": "2020-12-30T12:04:08Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1187,6 +1200,68 @@ boolean isNetworkImplemented(final NetworkVO network) {\n         return implemented;\n     }\n \n+    private NicTO getNicTO(NetworkVO networkVO, NetworkOfferingVO networkOfferingVO) {\n+        NicTO to = new NicTO();\n+        to.setBroadcastType(networkVO.getBroadcastDomainType());\n+        to.setType(networkVO.getTrafficType());\n+        to.setBroadcastUri(networkVO.getBroadcastUri());\n+        to.setIsolationuri(networkVO.getBroadcastUri());\n+        to.setNetworkRateMbps(_configMgr.getNetworkOfferingNetworkRate(networkOfferingVO.getId(), networkVO.getDataCenterId()));\n+        to.setSecurityGroupEnabled(_networkModel.isSecurityGroupSupportedInNetwork(networkVO));\n+        return to;\n+    }\n+\n+    private boolean isNtwConfiguredInCluster(HostVO hostVO, Map<Long, List<Long>> clusterToHostsMap) {\n+        Long clusterId = hostVO.getClusterId();\n+        List<Long> hosts = clusterToHostsMap.get(clusterId);\n+        if (hosts == null) {\n+            hosts = new ArrayList<>();\n+        }\n+        if (hostVO.getHypervisorType() == HypervisorType.KVM) {\n+            hosts.add(hostVO.getId());\n+            clusterToHostsMap.put(clusterId, hosts);\n+            return false;\n+        }\n+        if (hosts != null && !hosts.isEmpty()) {\n+            return true;\n+        }\n+        hosts.add(hostVO.getId());\n+        clusterToHostsMap.put(clusterId, hosts);\n+        return false;\n+    }\n+\n+    private void setupPersistentNetwork(NetworkVO network, NetworkOfferingVO offering, Long dcId) throws AgentUnavailableException, OperationTimedoutException {\n+        NicTO to = getNicTO(network, offering);\n+        List<ClusterVO> clusterVOS = clusterDao.listClustersByDcId(dcId);\n+        List<HostVO> hosts = resourceManager.listAllUpAndEnabledHostsInOneZoneByType(Host.Type.Routing, dcId);\n+        Collections.reverse(hosts);", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MTYxMg==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550171612", "bodyText": "Small typo", "author": "nvazquez", "createdAt": "2020-12-30T12:05:20Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -3512,7 +3590,7 @@ private boolean cleanupNetworkResources(final long networkId, final Account call\n             }\n         } catch (final ResourceUnavailableException ex) {\n             success = false;\n-            s_logger.warn(\"Failed to cleanup Network ACLs as a part of network id=\" + networkId + \" cleanup due to resourceUnavailable \", ex);\n+            s_logger.warn(\"Failed to c*.javaleanup Network ACLs as a part of network id=\" + networkId + \" cleanup due to resourceUnavailable \", ex);", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MjI3MQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550172271", "bodyText": "Maybe renamed to shouldDeleteBridge() or similar?", "author": "nvazquez", "createdAt": "2020-12-30T12:07:45Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -276,18 +277,33 @@ Use VIR_DOMAIN_XML_SECURE (value = 1) prior to v1.0.0.\n         } else {\n             libvirtComputingResource.destroyNetworkRulesForVM(conn, vmName);\n             for (final InterfaceDef iface : ifaces) {\n+                String vlanId = getVlanIdFromBridgeName(iface.getBrName());\n                 // We don't know which \"traffic type\" is associated with\n                 // each interface at this point, so inform all vif drivers\n                 final List<VifDriver> allVifDrivers = libvirtComputingResource.getAllVifDrivers();\n                 for (final VifDriver vifDriver : allVifDrivers) {\n-                    vifDriver.unplug(iface);\n+                    vifDriver.unplug(iface, deleteBridge(vlanToPersistenceMap, vlanId));\n                 }\n             }\n         }\n \n         return new MigrateAnswer(command, result == null, result, null);\n     }\n \n+    private String getVlanIdFromBridgeName(String brName) {\n+        if (brName != null) {\n+            return brName.split(\"-\")[1];\n+        }\n+        return null;\n+    }\n+\n+    private boolean deleteBridge(Map<String, Boolean> vlanToPersistenceMap, String vlanId) {", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3MjU4MA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550172580", "bodyText": "What about StringUtils.isNotBlank() to also prevent empty strings?", "author": "nvazquez", "createdAt": "2020-12-30T12:08:45Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtMigrateCommandWrapper.java", "diffHunk": "@@ -276,18 +277,33 @@ Use VIR_DOMAIN_XML_SECURE (value = 1) prior to v1.0.0.\n         } else {\n             libvirtComputingResource.destroyNetworkRulesForVM(conn, vmName);\n             for (final InterfaceDef iface : ifaces) {\n+                String vlanId = getVlanIdFromBridgeName(iface.getBrName());\n                 // We don't know which \"traffic type\" is associated with\n                 // each interface at this point, so inform all vif drivers\n                 final List<VifDriver> allVifDrivers = libvirtComputingResource.getAllVifDrivers();\n                 for (final VifDriver vifDriver : allVifDrivers) {\n-                    vifDriver.unplug(iface);\n+                    vifDriver.unplug(iface, deleteBridge(vlanToPersistenceMap, vlanId));\n                 }\n             }\n         }\n \n         return new MigrateAnswer(command, result == null, result, null);\n     }\n \n+    private String getVlanIdFromBridgeName(String brName) {\n+        if (brName != null) {", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE3Mjg5Mg==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r550172892", "bodyText": "Please remove", "author": "nvazquez", "createdAt": "2020-12-30T12:09:56Z", "path": "server/src/main/java/com/cloud/network/NetworkServiceImpl.java", "diffHunk": "@@ -1374,10 +1374,10 @@ public Network createGuestNetwork(CreateNetworkCmd cmd) throws InsufficientCapac\n         // if the network offering has persistent set to true, implement the network\n         if (ntwkOff.isPersistent()) {\n             try {\n-                if (network.getState() == Network.State.Setup) {\n-                    s_logger.debug(\"Network id=\" + network.getId() + \" is already provisioned\");\n-                    return network;\n-                }\n+//                if (network.getState() == Network.State.Setup) {", "originalCommit": "65e49382dc942e15178f67abd955c2e7e158924f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "cf5cb957a202dd5babe50dd7726c2c4c0fd98a61", "url": "https://github.com/apache/cloudstack/commit/cf5cb957a202dd5babe50dd7726c2c4c0fd98a61", "message": "address comments", "committedDate": "2021-01-05T06:47:02Z", "type": "forcePushed"}, {"oid": "c92652b3b394fc2442ebee22c30c1f81fd740153", "url": "https://github.com/apache/cloudstack/commit/c92652b3b394fc2442ebee22c30c1f81fd740153", "message": "Marvin tests", "committedDate": "2021-01-13T05:38:25Z", "type": "forcePushed"}, {"oid": "b898d6f616723278b65fbe8b3ad5cd51ec9b2ebe", "url": "https://github.com/apache/cloudstack/commit/b898d6f616723278b65fbe8b3ad5cd51ec9b2ebe", "message": "Added additional marvin tests + defensive checks", "committedDate": "2021-01-21T08:04:17Z", "type": "forcePushed"}, {"oid": "f0538034f8eda454d14ce2f87b4633395ca0e6f2", "url": "https://github.com/apache/cloudstack/commit/f0538034f8eda454d14ce2f87b4633395ca0e6f2", "message": "Added additional marvin tests + defensive checks", "committedDate": "2021-01-21T09:19:38Z", "type": "forcePushed"}, {"oid": "aeb5fcf2596c78aa89532e97fb88154685515fea", "url": "https://github.com/apache/cloudstack/commit/aeb5fcf2596c78aa89532e97fb88154685515fea", "message": "UI changes", "committedDate": "2021-01-22T10:04:45Z", "type": "forcePushed"}, {"oid": "15d1504eed1aa50740a82db3067d4414563c657e", "url": "https://github.com/apache/cloudstack/commit/15d1504eed1aa50740a82db3067d4414563c657e", "message": "Revert changes - async cmd", "committedDate": "2021-01-27T05:47:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwNzc3OQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565907779", "bodyText": "Import reshuffle does not look sortable. You can fix your intellij settings or get preset settings (mine are here https://github.com/rhtyd/dotfiles/blob/master/intellij/settings.jar)", "author": "rhtyd", "createdAt": "2021-01-28T08:38:01Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/user/network/CreateNetworkCmd.java", "diffHunk": "@@ -16,13 +16,13 @@\n // under the License.\n package org.apache.cloudstack.api.command.user.network;\n \n+import org.apache.cloudstack.api.BaseCmd;\n import org.apache.log4j.Logger;\n \n import org.apache.cloudstack.acl.RoleType;\n import org.apache.cloudstack.api.APICommand;\n import org.apache.cloudstack.api.ApiConstants;\n import org.apache.cloudstack.api.ApiErrorCode;\n-import org.apache.cloudstack.api.BaseCmd;", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwODAxNQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565908015", "bodyText": "minor nit - space after Command {", "author": "rhtyd", "createdAt": "2021-01-28T08:38:23Z", "path": "core/src/main/java/com/cloud/agent/api/CleanupPersistentNetworkResourceCommand.java", "diffHunk": "@@ -0,0 +1,43 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package com.cloud.agent.api;\n+\n+import com.cloud.agent.api.to.NicTO;\n+\n+public class CleanupPersistentNetworkResourceCommand extends Command{", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwODQzOA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565908438", "bodyText": "Just a note - if field is not initialised, the consumer of getter must do a NPE check.", "author": "rhtyd", "createdAt": "2021-01-28T08:39:01Z", "path": "core/src/main/java/com/cloud/agent/api/MigrateCommand.java", "diffHunk": "@@ -40,6 +40,7 @@\n     private boolean executeInSequence = false;\n     private List<MigrateDiskInfo> migrateDiskInfoList = new ArrayList<>();\n     private Map<String, DpdkTO> dpdkInterfaceMapping = new HashMap<>();\n+    Map<String, Boolean> vlanToPersistenceMap;", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwODU3MA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565908570", "bodyText": "minor nit - same Command {", "author": "rhtyd", "createdAt": "2021-01-28T08:39:14Z", "path": "core/src/main/java/com/cloud/agent/api/SetupPersistentNetworkCommand.java", "diffHunk": "@@ -0,0 +1,41 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package com.cloud.agent.api;\n+\n+import com.cloud.agent.api.to.NicTO;\n+\n+public class SetupPersistentNetworkCommand extends Command{", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwODY3MQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565908671", "bodyText": "same as before, NPE check for consumer", "author": "rhtyd", "createdAt": "2021-01-28T08:39:26Z", "path": "core/src/main/java/com/cloud/agent/api/StopCommand.java", "diffHunk": "@@ -36,6 +36,7 @@\n     String controlIp = null;\n     boolean forceStop = false;\n     private Map<String, DpdkTO> dpdkInterfaceMapping;\n+    Map<String, Boolean> vlanToPersistenceMap;", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTk1NTAyMQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565955021", "bodyText": "There's an explicit check done at the consuming end to ensure this isn't null", "author": "Pearl1594", "createdAt": "2021-01-28T09:49:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwODY3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwOTM1MQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565909351", "bodyText": "minor nit - could be simply made to set the getVlanToPersistenceMapForVM output", "author": "rhtyd", "createdAt": "2021-01-28T08:40:28Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1640,7 +1657,11 @@ private void unmanageVMNics(VirtualMachineProfile profile, VMInstanceVO vm) {\n \n     protected boolean sendStop(final VirtualMachineGuru guru, final VirtualMachineProfile profile, final boolean force, final boolean checkBeforeCleanup) {\n         final VirtualMachine vm = profile.getVirtualMachine();\n+        Map<String, Boolean> vlanToPersistenceMap = getVlanToPersistenceMapForVM(vm.getId());\n         StopCommand stpCmd = new StopCommand(vm, getExecuteInSequence(vm.getHypervisorType()), checkBeforeCleanup);\n+        if (MapUtils.isNotEmpty(vlanToPersistenceMap)) {\n+            stpCmd.setVlanToPersistenceMap(vlanToPersistenceMap);", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwOTg0OQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565909849", "bodyText": "What about vxlan, @Pearl1594 are persistent networks support for VXLAN isolation?", "author": "rhtyd", "createdAt": "2021-01-28T08:41:20Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1827,6 +1848,63 @@ private void orchestrateStop(final String vmUuid, final boolean cleanUpEvenIfUna\n         advanceStop(vm, cleanUpEvenIfUnableToStop);\n     }\n \n+    private void getPersistenceMap(Map<String, Boolean> vlanToPersistenceMap, NetworkVO networkVO) {\n+        NetworkOfferingVO offeringVO = networkOfferingDao.findById(networkVO.getNetworkOfferingId());\n+        if (offeringVO != null) {\n+            Pair<String, Boolean> data = getVMNetworkDetails(networkVO, offeringVO.isPersistent());\n+            Boolean shouldDeleteNwResource = (MapUtils.isNotEmpty(vlanToPersistenceMap) && data != null) ? vlanToPersistenceMap.get(data.first()) : null;\n+            if (data != null && (shouldDeleteNwResource == null || shouldDeleteNwResource)) {\n+                vlanToPersistenceMap.put(data.first(), data.second());\n+            }\n+        }\n+    }\n+\n+    private Map<String, Boolean> getVlanToPersistenceMapForVM(long vmId) {\n+        List<UserVmJoinVO> userVmJoinVOS = userVmJoinDao.searchByIds(vmId);\n+        Map<String, Boolean> vlanToPersistenceMap = new HashMap<>();\n+        for (UserVmJoinVO userVmJoinVO : userVmJoinVOS) {\n+            NetworkVO networkVO = _networkDao.findById(userVmJoinVO.getNetworkId());\n+            getPersistenceMap(vlanToPersistenceMap, networkVO);\n+        }\n+        if (userVmJoinVOS.isEmpty()) {\n+            VMInstanceVO vmInstanceVO = _vmDao.findById(vmId);\n+            if (vmInstanceVO != null && vmInstanceVO.getType() == VirtualMachine.Type.DomainRouter) {\n+                DomainRouterJoinVO routerVO = domainRouterJoinDao.findById(vmId);\n+                NetworkVO networkVO = _networkDao.findById(routerVO.getNetworkId());\n+                getPersistenceMap(vlanToPersistenceMap, networkVO);\n+            }\n+        }\n+        return vlanToPersistenceMap;\n+    }\n+\n+    /**\n+     *\n+     * @param networkVO - the network object used to determine the vlanId from the broadcast URI\n+     * @param isPersistent - indicates if the corresponding network's network offering is Persistent\n+     *\n+     * @return <VlanId, ShouldKVMBridgeBeDeleted> - basically returns the vlan ID which is used to determine the\n+     * bridge name for KVM hypervisor and based on the network and isolation type and persistent setting of the offering\n+     * we decide whether the bridge is to be deleted (KVM) if the last VM in that host is destroyed / migrated\n+     */\n+    private Pair<String, Boolean> getVMNetworkDetails(NetworkVO networkVO, boolean isPersistent) {\n+        URI broadcastUri = networkVO.getBroadcastUri();\n+        if (broadcastUri != null) {\n+            String scheme = broadcastUri.getScheme();\n+            String vlanId = Networks.BroadcastDomainType.getValue(broadcastUri);\n+            boolean shouldDelete = !((networkVO.getGuestType() == Network.GuestType.L2 || networkVO.getGuestType() == Network.GuestType.Isolated) &&", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTk1NTY1OQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565955659", "bodyText": "L2 persistence mode isn't supported for VxLAN isolation type", "author": "Pearl1594", "createdAt": "2021-01-28T09:50:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkwOTg0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkxMDYwMQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565910601", "bodyText": "Can we log on which host it was failed, or one of the warning/log above?", "author": "rhtyd", "createdAt": "2021-01-28T08:42:35Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -2864,6 +2962,33 @@ public boolean shutdownNetworkElementsAndResources(final ReservationContext cont\n         return success;\n     }\n \n+    private void cleanupPersistentnNetworkResources(NetworkVO network) {\n+        long networkOfferingId = network.getNetworkOfferingId();\n+        NetworkOfferingVO offering = _networkOfferingDao.findById(networkOfferingId);\n+        if (offering != null) {\n+            if (networkMeetsPersistenceCriteria(network, offering, true) &&\n+                    _networksDao.getOtherPersistentNetworksCount(network.getId(), network.getBroadcastUri().toString(), offering.isPersistent()) == 0) {\n+                List<HostVO> hosts = resourceManager.listAllUpAndEnabledHostsInOneZoneByType(Host.Type.Routing, network.getDataCenterId());\n+                for (HostVO host : hosts) {\n+                    try {\n+                        NicTO to = createNicTOFromNetworkAndOffering(network, offering, host);\n+                        CleanupPersistentNetworkResourceCommand cmd = new CleanupPersistentNetworkResourceCommand(to);\n+                        CleanupPersistentNetworkResourceAnswer answer = (CleanupPersistentNetworkResourceAnswer) _agentMgr.send(host.getId(), cmd);\n+                        if (answer == null) {\n+                            s_logger.warn(\"Unable to get an answer to the CleanupPersistentNetworkResourceCommand from agent:\" + host.getId());\n+                        }\n+\n+                        if (!answer.getResult()) {\n+                            s_logger.warn(\"Unable to setup agent \" + host.getId() + \" due to \" + answer.getDetails());\n+                        }\n+                    } catch (Exception e) {\n+                        s_logger.warn(\"Failed to cleanup network resources\");", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkxMDg4Mw==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565910883", "bodyText": "minor minor nit - The other PR/fix has come here.", "author": "rhtyd", "createdAt": "2021-01-28T08:43:02Z", "path": "plugins/api/discovery/src/main/java/org/apache/cloudstack/discovery/ApiDiscoveryServiceImpl.java", "diffHunk": "@@ -67,7 +68,7 @@ public boolean start() {\n         if (s_apiNameDiscoveryResponseMap == null) {\n             long startTime = System.nanoTime();\n             s_apiNameDiscoveryResponseMap = new HashMap<String, ApiDiscoveryResponse>();\n-            Set<Class<?>> cmdClasses = new HashSet<Class<?>>();\n+            Set<Class<?>> cmdClasses = new LinkedHashSet<Class<?>>();", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkxMTMwMA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565911300", "bodyText": "should deleteBr be used to add the -d command?", "author": "rhtyd", "createdAt": "2021-01-28T08:43:42Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/BridgeVifDriver.java", "diffHunk": "@@ -376,6 +376,7 @@ private void deleteVnetBr(String brName) {\n             command.add(\"-v\", vNetId);\n             command.add(\"-p\", pName);\n             command.add(\"-b\", brName);\n+            command.add(\"-d\", String.valueOf(deleteBr));", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTk1NjAwNA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565956004", "bodyText": "yes @rhtyd", "author": "Pearl1594", "createdAt": "2021-01-28T09:50:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkxMTMwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkxMTQ5NA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565911494", "bodyText": "should null check be done here again?", "author": "rhtyd", "createdAt": "2021-01-28T08:44:03Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/BridgeVifDriver.java", "diffHunk": "@@ -436,4 +437,20 @@ public boolean isExistingBridge(String bridgeName) {\n             return false;\n         }\n     }\n+\n+    @Override\n+    public void deleteBr(NicTO nic) {\n+        String vlanId = Networks.BroadcastDomainType.getValue(nic.getBroadcastUri());\n+        String trafficLabel = nic.getName();\n+        String pifName = _pifs.get(trafficLabel);\n+        if (pifName == null) {\n+            // if not found in bridge map, maybe traffic label refers to pif already?\n+            File pif = new File(\"/sys/class/net/\" + trafficLabel);\n+            if (pif.isDirectory()) {\n+                pifName = trafficLabel;\n+            }\n+        }\n+        String brName = generateVnetBrName(pifName, vlanId);", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkxMTk4NQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565911985", "bodyText": "Is persistent network/L2 not supported for OVS bridge?", "author": "rhtyd", "createdAt": "2021-01-28T08:44:49Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtCleanupPersistentNetworkResourceCommandWrapper.java", "diffHunk": "@@ -0,0 +1,44 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package com.cloud.hypervisor.kvm.resource.wrapper;\n+\n+import org.apache.log4j.Logger;\n+\n+import com.cloud.agent.api.Answer;\n+import com.cloud.agent.api.CleanupPersistentNetworkResourceAnswer;\n+import com.cloud.agent.api.CleanupPersistentNetworkResourceCommand;\n+import com.cloud.agent.api.to.NicTO;\n+import com.cloud.hypervisor.kvm.resource.BridgeVifDriver;\n+import com.cloud.hypervisor.kvm.resource.LibvirtComputingResource;\n+import com.cloud.hypervisor.kvm.resource.VifDriver;\n+import com.cloud.resource.CommandWrapper;\n+import com.cloud.resource.ResourceWrapper;\n+\n+@ResourceWrapper(handles = CleanupPersistentNetworkResourceCommand.class)\n+public class LibvirtCleanupPersistentNetworkResourceCommandWrapper extends CommandWrapper<CleanupPersistentNetworkResourceCommand, Answer, LibvirtComputingResource> {\n+    private static final Logger s_logger = Logger.getLogger(LibvirtCleanupPersistentNetworkResourceCommandWrapper.class);\n+    @Override\n+    public Answer execute(CleanupPersistentNetworkResourceCommand command, LibvirtComputingResource serverResource) {\n+        NicTO nic = command.getNicTO();\n+        VifDriver driver = serverResource.getVifDriver(nic.getType());\n+        if (driver instanceof BridgeVifDriver) {", "originalCommit": "c6d9b75a53447bd241203369aa82f58ec13a5dd9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTk1NjY1MA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r565956650", "bodyText": "L2 persistence mode hasn't been extended to support it on ovs for KVM", "author": "Pearl1594", "createdAt": "2021-01-28T09:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NTkxMTk4NQ=="}], "type": "inlineReview"}, {"oid": "24f9dcfb6798e1c7eedc40355dea5a40963f1eb2", "url": "https://github.com/apache/cloudstack/commit/24f9dcfb6798e1c7eedc40355dea5a40963f1eb2", "message": "Support for persistence mode in L2 networks", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "04bb7a8b6aea250a027539acb1db6c16b0cc9e4a", "url": "https://github.com/apache/cloudstack/commit/04bb7a8b6aea250a027539acb1db6c16b0cc9e4a", "message": "address comments", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "e57b34521789f7a940a96e16f13ab1efd2d3cb18", "url": "https://github.com/apache/cloudstack/commit/e57b34521789f7a940a96e16f13ab1efd2d3cb18", "message": "Add network tag to nic info - required for xen", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "af12e27561adc727e398f3c342510a8093f6974c", "url": "https://github.com/apache/cloudstack/commit/af12e27561adc727e398f3c342510a8093f6974c", "message": "Marvin tests", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "762df8c170efe945da293cfce4de93f0028a7453", "url": "https://github.com/apache/cloudstack/commit/762df8c170efe945da293cfce4de93f0028a7453", "message": "Include cleanup of n/w resources on n/w deletion + prevent n/w resource deletion on detroy/stop/unplug of VM from persistent n/w", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "be0723201a8bd7284aa173fb3227fa8ce9abd729", "url": "https://github.com/apache/cloudstack/commit/be0723201a8bd7284aa173fb3227fa8ce9abd729", "message": "Add check to prevent deletion of n/w resources when last VM/non-persistent network is deleted but there exists another n/w with overlapping vlan which is persistent", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "4faa06538424880aae55700878e5993b447697af", "url": "https://github.com/apache/cloudstack/commit/4faa06538424880aae55700878e5993b447697af", "message": "Added additional marvin tests + defensive checks", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "b5e8cd16e27e994f7aac93f03ca781566bae9665", "url": "https://github.com/apache/cloudstack/commit/b5e8cd16e27e994f7aac93f03ca781566bae9665", "message": "API discovery: Prevent overwrite of API parameters in case the API names are the same", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "d4c74df80b0dea2b9172de45295c230be3863b56", "url": "https://github.com/apache/cloudstack/commit/d4c74df80b0dea2b9172de45295c230be3863b56", "message": "Revert changes - async cmd", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "56716a3f1f0fadf7dab3f101d3c59d29cd1de199", "url": "https://github.com/apache/cloudstack/commit/56716a3f1f0fadf7dab3f101d3c59d29cd1de199", "message": "changed log message", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "url": "https://github.com/apache/cloudstack/commit/792dda1cc4ddb03b870f2acf51b238618c53c44d", "message": "Address review comments", "committedDate": "2021-01-28T11:31:07Z", "type": "commit"}, {"oid": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "url": "https://github.com/apache/cloudstack/commit/792dda1cc4ddb03b870f2acf51b238618c53c44d", "message": "Address review comments", "committedDate": "2021-01-28T11:31:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MzE0MQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566683141", "bodyText": "getPersistenceMap here doesn't return anything, updatePersistenceMap might be best fit here", "author": "sureshanaparti", "createdAt": "2021-01-29T09:20:42Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1827,6 +1848,63 @@ private void orchestrateStop(final String vmUuid, final boolean cleanUpEvenIfUna\n         advanceStop(vm, cleanUpEvenIfUnableToStop);\n     }\n \n+    private void getPersistenceMap(Map<String, Boolean> vlanToPersistenceMap, NetworkVO networkVO) {", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4MzU5Nw==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566683597", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<UserVmJoinVO> userVmJoinVOS = userVmJoinDao.searchByIds(vmId);\n          \n          \n            \n                    List<UserVmJoinVO> userVmJoinVOs = userVmJoinDao.searchByIds(vmId);", "author": "sureshanaparti", "createdAt": "2021-01-29T09:21:25Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1827,6 +1848,63 @@ private void orchestrateStop(final String vmUuid, final boolean cleanUpEvenIfUna\n         advanceStop(vm, cleanUpEvenIfUnableToStop);\n     }\n \n+    private void getPersistenceMap(Map<String, Boolean> vlanToPersistenceMap, NetworkVO networkVO) {\n+        NetworkOfferingVO offeringVO = networkOfferingDao.findById(networkVO.getNetworkOfferingId());\n+        if (offeringVO != null) {\n+            Pair<String, Boolean> data = getVMNetworkDetails(networkVO, offeringVO.isPersistent());\n+            Boolean shouldDeleteNwResource = (MapUtils.isNotEmpty(vlanToPersistenceMap) && data != null) ? vlanToPersistenceMap.get(data.first()) : null;\n+            if (data != null && (shouldDeleteNwResource == null || shouldDeleteNwResource)) {\n+                vlanToPersistenceMap.put(data.first(), data.second());\n+            }\n+        }\n+    }\n+\n+    private Map<String, Boolean> getVlanToPersistenceMapForVM(long vmId) {\n+        List<UserVmJoinVO> userVmJoinVOS = userVmJoinDao.searchByIds(vmId);", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY4NzM0Mg==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566687342", "bodyText": "to be clear, move this 'for' block to else case of \"userVmJoinVOS.isEmpty()\" or vice versa", "author": "sureshanaparti", "createdAt": "2021-01-29T09:27:42Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -1827,6 +1848,63 @@ private void orchestrateStop(final String vmUuid, final boolean cleanUpEvenIfUna\n         advanceStop(vm, cleanUpEvenIfUnableToStop);\n     }\n \n+    private void getPersistenceMap(Map<String, Boolean> vlanToPersistenceMap, NetworkVO networkVO) {\n+        NetworkOfferingVO offeringVO = networkOfferingDao.findById(networkVO.getNetworkOfferingId());\n+        if (offeringVO != null) {\n+            Pair<String, Boolean> data = getVMNetworkDetails(networkVO, offeringVO.isPersistent());\n+            Boolean shouldDeleteNwResource = (MapUtils.isNotEmpty(vlanToPersistenceMap) && data != null) ? vlanToPersistenceMap.get(data.first()) : null;\n+            if (data != null && (shouldDeleteNwResource == null || shouldDeleteNwResource)) {\n+                vlanToPersistenceMap.put(data.first(), data.second());\n+            }\n+        }\n+    }\n+\n+    private Map<String, Boolean> getVlanToPersistenceMapForVM(long vmId) {\n+        List<UserVmJoinVO> userVmJoinVOS = userVmJoinDao.searchByIds(vmId);\n+        Map<String, Boolean> vlanToPersistenceMap = new HashMap<>();\n+        for (UserVmJoinVO userVmJoinVO : userVmJoinVOS) {", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NjY5MjYxNw==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566692617", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<ClusterVO> clusterVOS = clusterDao.listClustersByDcId(dcId);\n          \n          \n            \n                    List<ClusterVO> clusterVOs = clusterDao.listClustersByDcId(dcId);", "author": "sureshanaparti", "createdAt": "2021-01-29T09:36:36Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1187,6 +1202,86 @@ boolean isNetworkImplemented(final NetworkVO network) {\n         return implemented;\n     }\n \n+    /**\n+     *\n+     * Creates a dummy NicTO object which is used by the respective hypervisors to setup network elements / resources\n+     * - bridges(KVM), VLANs(Xen) and portgroups(VMWare) for L2 network\n+     */\n+    private NicTO createNicTOFromNetworkAndOffering(NetworkVO networkVO, NetworkOfferingVO networkOfferingVO, HostVO hostVO) {\n+        NicTO to = new NicTO();\n+        to.setName(_networkModel.getNetworkTag(hostVO.getHypervisorType(), networkVO));\n+        to.setBroadcastType(networkVO.getBroadcastDomainType());\n+        to.setType(networkVO.getTrafficType());\n+        to.setBroadcastUri(networkVO.getBroadcastUri());\n+        to.setIsolationuri(networkVO.getBroadcastUri());\n+        to.setNetworkRateMbps(_configMgr.getNetworkOfferingNetworkRate(networkOfferingVO.getId(), networkVO.getDataCenterId()));\n+        to.setSecurityGroupEnabled(_networkModel.isSecurityGroupSupportedInNetwork(networkVO));\n+        return to;\n+    }\n+\n+    private Pair<Boolean, NicTO> isNtwConfiguredInCluster(HostVO hostVO, Map<Long, List<Long>> clusterToHostsMap, NetworkVO networkVO, NetworkOfferingVO networkOfferingVO) {\n+        Long clusterId = hostVO.getClusterId();\n+        List<Long> hosts = clusterToHostsMap.get(clusterId);\n+        if (hosts == null) {\n+            hosts = new ArrayList<>();\n+        }\n+        if (hostVO.getHypervisorType() == HypervisorType.KVM || hostVO.getHypervisorType() == HypervisorType.XenServer ) {\n+            hosts.add(hostVO.getId());\n+            clusterToHostsMap.put(clusterId, hosts);\n+            return new Pair<>(false, createNicTOFromNetworkAndOffering(networkVO, networkOfferingVO, hostVO));\n+        }\n+        if (hosts != null && !hosts.isEmpty()) {\n+            return new Pair<>(true, createNicTOFromNetworkAndOffering(networkVO, networkOfferingVO, hostVO));\n+        }\n+        hosts.add(hostVO.getId());\n+        clusterToHostsMap.put(clusterId, hosts);\n+        return new Pair<>(false, createNicTOFromNetworkAndOffering(networkVO, networkOfferingVO, hostVO));\n+    }\n+\n+    private void setupPersistentNetwork(NetworkVO network, NetworkOfferingVO offering, Long dcId) throws AgentUnavailableException, OperationTimedoutException {\n+        List<ClusterVO> clusterVOS = clusterDao.listClustersByDcId(dcId);", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg0Mjg0MQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566842841", "bodyText": "potential NPE issue below. continue missing here ? please check.", "author": "sureshanaparti", "createdAt": "2021-01-29T14:03:58Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -2864,6 +2962,33 @@ public boolean shutdownNetworkElementsAndResources(final ReservationContext cont\n         return success;\n     }\n \n+    private void cleanupPersistentnNetworkResources(NetworkVO network) {\n+        long networkOfferingId = network.getNetworkOfferingId();\n+        NetworkOfferingVO offering = _networkOfferingDao.findById(networkOfferingId);\n+        if (offering != null) {\n+            if (networkMeetsPersistenceCriteria(network, offering, true) &&\n+                    _networksDao.getOtherPersistentNetworksCount(network.getId(), network.getBroadcastUri().toString(), offering.isPersistent()) == 0) {\n+                List<HostVO> hosts = resourceManager.listAllUpAndEnabledHostsInOneZoneByType(Host.Type.Routing, network.getDataCenterId());\n+                for (HostVO host : hosts) {\n+                    try {\n+                        NicTO to = createNicTOFromNetworkAndOffering(network, offering, host);\n+                        CleanupPersistentNetworkResourceCommand cmd = new CleanupPersistentNetworkResourceCommand(to);\n+                        CleanupPersistentNetworkResourceAnswer answer = (CleanupPersistentNetworkResourceAnswer) _agentMgr.send(host.getId(), cmd);\n+                        if (answer == null) {\n+                            s_logger.warn(\"Unable to get an answer to the CleanupPersistentNetworkResourceCommand from agent:\" + host.getId());", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg0NDc5OQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566844799", "bodyText": "continue may not be required here", "author": "sureshanaparti", "createdAt": "2021-01-29T14:07:14Z", "path": "engine/orchestration/src/main/java/org/apache/cloudstack/engine/orchestration/NetworkOrchestrator.java", "diffHunk": "@@ -1187,6 +1202,86 @@ boolean isNetworkImplemented(final NetworkVO network) {\n         return implemented;\n     }\n \n+    /**\n+     *\n+     * Creates a dummy NicTO object which is used by the respective hypervisors to setup network elements / resources\n+     * - bridges(KVM), VLANs(Xen) and portgroups(VMWare) for L2 network\n+     */\n+    private NicTO createNicTOFromNetworkAndOffering(NetworkVO networkVO, NetworkOfferingVO networkOfferingVO, HostVO hostVO) {\n+        NicTO to = new NicTO();\n+        to.setName(_networkModel.getNetworkTag(hostVO.getHypervisorType(), networkVO));\n+        to.setBroadcastType(networkVO.getBroadcastDomainType());\n+        to.setType(networkVO.getTrafficType());\n+        to.setBroadcastUri(networkVO.getBroadcastUri());\n+        to.setIsolationuri(networkVO.getBroadcastUri());\n+        to.setNetworkRateMbps(_configMgr.getNetworkOfferingNetworkRate(networkOfferingVO.getId(), networkVO.getDataCenterId()));\n+        to.setSecurityGroupEnabled(_networkModel.isSecurityGroupSupportedInNetwork(networkVO));\n+        return to;\n+    }\n+\n+    private Pair<Boolean, NicTO> isNtwConfiguredInCluster(HostVO hostVO, Map<Long, List<Long>> clusterToHostsMap, NetworkVO networkVO, NetworkOfferingVO networkOfferingVO) {\n+        Long clusterId = hostVO.getClusterId();\n+        List<Long> hosts = clusterToHostsMap.get(clusterId);\n+        if (hosts == null) {\n+            hosts = new ArrayList<>();\n+        }\n+        if (hostVO.getHypervisorType() == HypervisorType.KVM || hostVO.getHypervisorType() == HypervisorType.XenServer ) {\n+            hosts.add(hostVO.getId());\n+            clusterToHostsMap.put(clusterId, hosts);\n+            return new Pair<>(false, createNicTOFromNetworkAndOffering(networkVO, networkOfferingVO, hostVO));\n+        }\n+        if (hosts != null && !hosts.isEmpty()) {\n+            return new Pair<>(true, createNicTOFromNetworkAndOffering(networkVO, networkOfferingVO, hostVO));\n+        }\n+        hosts.add(hostVO.getId());\n+        clusterToHostsMap.put(clusterId, hosts);\n+        return new Pair<>(false, createNicTOFromNetworkAndOffering(networkVO, networkOfferingVO, hostVO));\n+    }\n+\n+    private void setupPersistentNetwork(NetworkVO network, NetworkOfferingVO offering, Long dcId) throws AgentUnavailableException, OperationTimedoutException {\n+        List<ClusterVO> clusterVOS = clusterDao.listClustersByDcId(dcId);\n+        List<HostVO> hosts = resourceManager.listAllUpAndEnabledHostsInOneZoneByType(Host.Type.Routing, dcId);\n+        Map<Long, List<Long>> clusterToHostsMap = new HashMap<>();\n+\n+        for (HostVO host : hosts) {\n+            try {\n+                Pair<Boolean, NicTO> networkCfgStateAndDetails = isNtwConfiguredInCluster(host, clusterToHostsMap, network, offering);\n+                if (networkCfgStateAndDetails.first()) {\n+                    continue;\n+                }\n+                NicTO to = networkCfgStateAndDetails.second();\n+                SetupPersistentNetworkCommand cmd = new SetupPersistentNetworkCommand(to);\n+                final SetupPersistentNetworkAnswer answer = (SetupPersistentNetworkAnswer) _agentMgr.send(host.getId(), cmd);\n+\n+                if (answer == null) {\n+                    s_logger.warn(\"Unable to get an answer to the SetupPersistentNetworkCommand from agent:\" + host.getId());\n+                    clusterToHostsMap.get(host.getClusterId()).remove(host.getId());\n+                    continue;\n+                }\n+\n+                if (!answer.getResult()) {\n+                    s_logger.warn(\"Unable to setup agent \" + host.getId() + \" due to \" + answer.getDetails());\n+                    clusterToHostsMap.get(host.getClusterId()).remove(host.getId());\n+                    continue;", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg0NTQ1Nw==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566845457", "bodyText": "white spaces here", "author": "sureshanaparti", "createdAt": "2021-01-29T14:08:11Z", "path": "engine/schema/src/main/java/com/cloud/network/dao/NetworkDaoImpl.java", "diffHunk": "@@ -265,6 +276,8 @@ protected void init() {\n         join10.and(\"vpc\", join10.entity().getVpcId(), Op.EQ);\n         PrivateNetworkSearch.join(\"vpcgateways\", join10, PrivateNetworkSearch.entity().getId(), join10.entity().getNetworkId(), JoinBuilder.JoinType.INNER);\n         PrivateNetworkSearch.done();\n+\n+", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg0OTgwOA==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566849808", "bodyText": "could see same methods getVlanIdFromBridgeName() and shouldDeleteBridge() defined/implemented in the classes - LibvirtMigrateCommandWrapper, LibvirtStopCommandWrapper, LibvirtUnPlugNicCommandWrapper.\ncan you defined these in a common class (may be some util class) and use them across.", "author": "sureshanaparti", "createdAt": "2021-01-29T14:15:17Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/wrapper/LibvirtUnPlugNicCommandWrapper.java", "diffHunk": "@@ -82,4 +87,22 @@ public Answer execute(final UnPlugNicCommand command, final LibvirtComputingReso\n             }\n         }\n     }\n+", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2Njg1MDU0MQ==", "url": "https://github.com/apache/cloudstack/pull/4561#discussion_r566850541", "bodyText": "add the reason for exception in the message here", "author": "sureshanaparti", "createdAt": "2021-01-29T14:16:23Z", "path": "plugins/hypervisors/vmware/src/main/java/com/cloud/hypervisor/vmware/resource/VmwareResource.java", "diffHunk": "@@ -617,6 +621,21 @@ public Answer executeRequest(Command cmd) {\n         return answer;\n     }\n \n+    private Answer execute(SetupPersistentNetworkCommand cmd) {\n+        VmwareHypervisorHost host = getHyperHost(getServiceContext());\n+        String hostname = null;\n+        VmwareContext context = getServiceContext();\n+        HostMO hostMO = new HostMO(context, host.getMor());\n+\n+        try {\n+            prepareNetworkFromNicInfo(hostMO, cmd.getNic(), false, null);\n+            hostname =  host.getHyperHostName();\n+        } catch (Exception e) {\n+            return new SetupPersistentNetworkAnswer(cmd, false, \"failed to get response\");", "originalCommit": "792dda1cc4ddb03b870f2acf51b238618c53c44d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4500a2dc02ac73e4828d42adbf9724d128dbcf61", "url": "https://github.com/apache/cloudstack/commit/4500a2dc02ac73e4828d42adbf9724d128dbcf61", "message": "Address review comments", "committedDate": "2021-02-01T11:36:27Z", "type": "commit"}, {"oid": "4500a2dc02ac73e4828d42adbf9724d128dbcf61", "url": "https://github.com/apache/cloudstack/commit/4500a2dc02ac73e4828d42adbf9724d128dbcf61", "message": "Address review comments", "committedDate": "2021-02-01T11:36:27Z", "type": "forcePushed"}, {"oid": "551d74bb72903ddfba2085ee3efe169b1ce22fb9", "url": "https://github.com/apache/cloudstack/commit/551d74bb72903ddfba2085ee3efe169b1ce22fb9", "message": "Merge branch 'master' of https://github.com/apache/cloudstack into persistent-nw-enhance", "committedDate": "2021-02-09T13:18:13Z", "type": "commit"}, {"oid": "54da999182db4f6a4e655541ee32acb77f5aea0e", "url": "https://github.com/apache/cloudstack/commit/54da999182db4f6a4e655541ee32acb77f5aea0e", "message": "API discovery: Prevent overwrite of API parameters in case the API names are the same", "committedDate": "2021-02-09T13:18:38Z", "type": "commit"}, {"oid": "d659db8e7c3e3776390b0d54afe36e993a795013", "url": "https://github.com/apache/cloudstack/commit/d659db8e7c3e3776390b0d54afe36e993a795013", "message": "Merge branch 'master' of https://github.com/apache/cloudstack into persistent-nw-enhance", "committedDate": "2021-02-12T10:52:12Z", "type": "commit"}]}