{"pr_number": 4212, "pr_title": "Migrate/Stop VMs with local storage when preparing host for maintenance", "pr_createdAt": "2020-07-16T03:14:37Z", "pr_url": "https://github.com/apache/cloudstack/pull/4212", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r455888563", "bodyText": "Is this debug line still valid?", "author": "wido", "createdAt": "2020-07-16T15:48:31Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5619,7 +5619,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Unsupported Hypervisor Type for User VM migration, we support XenServer/VMware/KVM/Ovm/Hyperv/Ovm3 only\");\n         }\n \n-        if (isVMUsingLocalStorage(vm)) {\n+        if (isVMUsingLocalStorage(vm.getId())) {\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(vm + \" is using Local Storage, cannot migrate this VM.\");", "originalCommit": "bdc9bd266f874e879eb61aa1b94be7b240b9b123", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTkyODA3Mg==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r455928072", "bodyText": "That is a good point. It depends on the strategy configured at the ResourceManager, I will take a look at the best approaches to adapt it.", "author": "GabrielBrascher", "createdAt": "2020-07-16T16:48:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxMTgzNQ==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r456011835", "bodyText": "@wido I did check it again and noticed that the log message as it is makes sense.\nThe migrateVirtualMachine method does not work with volume migration. When a VM with volumes, e.g. when migrating VMs with local storage, is migrated it is used migrateWithStorage method. Therefore, we need to keep it that way.", "author": "GabrielBrascher", "createdAt": "2020-07-16T19:10:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjAxNTkyNw==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r456015927", "bodyText": "@wido I think that I answered the wrong question on previous comments ... Did you mention the isDebugEnabled(), or the debug message content?\nRegarding the isDebugEnabled(), personally, I would remove it. The idea behind it would be to avoid costly String operations and therefore optimize CloudStack processing. However, I think that there is a little optimization, and most of the cases CloudStack already runs in Debug mode.\nI think that I saw @DaanHoogland and @rafaelweingartner discussing it in the past.", "author": "GabrielBrascher", "createdAt": "2020-07-16T19:18:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjE3NDE2Mw==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r462174163", "bodyText": "As for the message, looks like an extra check for the strategy is in order, but the flow might already guarantee it's validity.\nAs for the second interpretation of the question, as a matter of principle it is always good to check the logging level as parameters are always evaluated before passing and you never know how often the code is being executed.\nAs for the level, this is an obvious mis-use of debug. An error or at least warning or info situation is occurring here; the user might expect a migration but there is something impairing it. This is not a message for a developer, hence not a debug level message.\n\nmy \u20ac0,03 ;)", "author": "DaanHoogland", "createdAt": "2020-07-29T09:44:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mjk1NDUwOQ==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r462954509", "bodyText": "@DaanHoogland your \u20ac0,03 is very appreciated ;)\nI will change the log level from debug to error (maybe warn, but it looks more like an error).", "author": "GabrielBrascher", "createdAt": "2020-07-30T12:17:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTk1NDMyMg==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r465954322", "bodyText": "@DaanHoogland I changed the log level from debug to error on those cases.", "author": "GabrielBrascher", "createdAt": "2020-08-05T19:30:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTg4ODU2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIxMzQwMw==", "url": "https://github.com/apache/cloudstack/pull/4212#discussion_r521213403", "bodyText": "nit picking: the target host can be specified and small spello\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());\n          \n          \n            \n                        s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM from hypervisor type \" + vm.getHypervisorType() + \" to hypervisor type \" + destinationHost.getHypervisorType());", "author": "DaanHoogland", "createdAt": "2020-11-11T09:05:45Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5609,9 +5609,7 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n         }\n \n         if (!isOnSupportedHypevisorForMigration(vm)) {\n-            if (s_logger.isDebugEnabled()) {\n-                s_logger.debug(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());\n-            }\n+            s_logger.error(vm + \" is not XenServer/VMware/KVM/Ovm/Hyperv, cannot migrate this VM form hypervisor type \" + vm.getHypervisorType());", "originalCommit": "3324fac104dbb01926579a12f3e5efe0c95d844e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d016a017eda9e9bedc1e97bb1e504f0098564a08", "url": "https://github.com/apache/cloudstack/commit/d016a017eda9e9bedc1e97bb1e504f0098564a08", "message": "Code enhancements", "committedDate": "2021-01-18T18:19:07Z", "type": "forcePushed"}, {"oid": "072efd85ab5a379692a608b359797ec9139409b7", "url": "https://github.com/apache/cloudstack/commit/072efd85ab5a379692a608b359797ec9139409b7", "message": "Add strategy for stopping or migrating VMs with local storage when putting a host in maintenance", "committedDate": "2021-02-22T12:53:45Z", "type": "commit"}, {"oid": "f6cafb44286a844f1a7861a9f2022806787a12cf", "url": "https://github.com/apache/cloudstack/commit/f6cafb44286a844f1a7861a9f2022806787a12cf", "message": "Change log level from debug to error", "committedDate": "2021-02-22T12:53:45Z", "type": "commit"}, {"oid": "f98ec6df4ec74062e015bff117fe77e6b920c39e", "url": "https://github.com/apache/cloudstack/commit/f98ec6df4ec74062e015bff117fe77e6b920c39e", "message": "Code enhancements", "committedDate": "2021-02-22T12:53:45Z", "type": "commit"}, {"oid": "d91473fc251764cfe0d7092d8e97648fa019931a", "url": "https://github.com/apache/cloudstack/commit/d91473fc251764cfe0d7092d8e97648fa019931a", "message": "Merge master branch and fix conflicts", "committedDate": "2021-02-22T15:32:29Z", "type": "commit"}, {"oid": "d91473fc251764cfe0d7092d8e97648fa019931a", "url": "https://github.com/apache/cloudstack/commit/d91473fc251764cfe0d7092d8e97648fa019931a", "message": "Merge master branch and fix conflicts", "committedDate": "2021-02-22T15:32:29Z", "type": "forcePushed"}, {"oid": "d12df67aaf7521d05dc8fa5e22366fbd0299fb01", "url": "https://github.com/apache/cloudstack/commit/d12df67aaf7521d05dc8fa5e22366fbd0299fb01", "message": "Change from ForceStop to Stop", "committedDate": "2021-02-22T15:37:09Z", "type": "commit"}, {"oid": "7a5d894489c71dca6da3fab08806c92c90783156", "url": "https://github.com/apache/cloudstack/commit/7a5d894489c71dca6da3fab08806c92c90783156", "message": "Add stop vs force-sto options for host.maintenance.local.storage.strategy", "committedDate": "2021-03-01T21:20:32Z", "type": "commit"}, {"oid": "7d4c802bef677d99860093bd04252f8d27a7b985", "url": "https://github.com/apache/cloudstack/commit/7d4c802bef677d99860093bd04252f8d27a7b985", "message": "Stop VM on Host must be of WokType ForceStop, due to host already on PrepareForMaintenance", "committedDate": "2021-03-03T13:05:44Z", "type": "commit"}, {"oid": "d644d0f91be4175dcc4b20bca9b64db932062499", "url": "https://github.com/apache/cloudstack/commit/d644d0f91be4175dcc4b20bca9b64db932062499", "message": "Enhance log in case of User chooses a non-existing strategy.", "committedDate": "2021-03-03T14:47:35Z", "type": "commit"}, {"oid": "45c6d4237ce72c037ebb5f04d10f470e4bbb446c", "url": "https://github.com/apache/cloudstack/commit/45c6d4237ce72c037ebb5f04d10f470e4bbb446c", "message": "Set log level to warn if strategy does not exist", "committedDate": "2021-03-03T17:41:37Z", "type": "commit"}, {"oid": "f909a54872751f572b47d86ec489a3d3b4fdc337", "url": "https://github.com/apache/cloudstack/commit/f909a54872751f572b47d86ec489a3d3b4fdc337", "message": "Set log level to warn if strategy does not exist", "committedDate": "2021-03-04T17:42:31Z", "type": "commit"}, {"oid": "c4cd6441be9aa9ac2fccc4e03f44496a4861672b", "url": "https://github.com/apache/cloudstack/commit/c4cd6441be9aa9ac2fccc4e03f44496a4861672b", "message": "Set log level to error and throw exception if strategy does not exist", "committedDate": "2021-03-04T17:44:36Z", "type": "commit"}]}