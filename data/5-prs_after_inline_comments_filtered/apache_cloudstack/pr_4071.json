{"pr_number": 4071, "pr_title": "Dynamic roles improvements", "pr_createdAt": "2020-05-11T10:50:25Z", "pr_url": "https://github.com/apache/cloudstack/pull/4071", "timeline": [{"oid": "f6c039147273a307175aec30583ec22fc6acc940", "url": "https://github.com/apache/cloudstack/commit/f6c039147273a307175aec30583ec22fc6acc940", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-05-13T15:48:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNTMxNA==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r426535314", "bodyText": "nit - Make description more verbose, something like 'Imports a role based on provided map of rule permissions...'", "author": "rhtyd", "createdAt": "2020-05-18T10:45:38Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/acl/ImportRoleCmd.java", "diffHunk": "@@ -0,0 +1,139 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.api.command.admin.acl;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.cloudstack.acl.Role;\n+import org.apache.cloudstack.acl.RoleType;\n+import org.apache.cloudstack.acl.Rule;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiArgValidator;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.RoleResponse;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.commons.collections.MapUtils;\n+\n+import com.cloud.user.Account;\n+import com.google.common.base.Strings;\n+\n+@APICommand(name = ImportRoleCmd.APINAME, description = \"Imports a role\", responseObject = RoleResponse.class,", "originalCommit": "f6c039147273a307175aec30583ec22fc6acc940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNTI3NQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r433405275", "bodyText": "nit - Make description more verbose, something like 'Imports a role based on provided map of rule permissions...'\n\nUpdated", "author": "sureshanaparti", "createdAt": "2020-06-01T18:16:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNTMxNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNjEzNQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r426536135", "bodyText": "nit - fix description to say what happens in case of a role name matches (i.e. explain for the users that it will override/replace the previosly created role with the provided parameters).", "author": "rhtyd", "createdAt": "2020-05-18T10:47:09Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/acl/ImportRoleCmd.java", "diffHunk": "@@ -0,0 +1,139 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.api.command.admin.acl;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.cloudstack.acl.Role;\n+import org.apache.cloudstack.acl.RoleType;\n+import org.apache.cloudstack.acl.Rule;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiArgValidator;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.RoleResponse;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.commons.collections.MapUtils;\n+\n+import com.cloud.user.Account;\n+import com.google.common.base.Strings;\n+\n+@APICommand(name = ImportRoleCmd.APINAME, description = \"Imports a role\", responseObject = RoleResponse.class,\n+        requestHasSensitiveInfo = false, responseHasSensitiveInfo = false,\n+        since = \"4.15.0\",\n+        authorized = {RoleType.Admin})\n+public class ImportRoleCmd extends RoleCmd {\n+    public static final String APINAME = \"importRole\";\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name = ApiConstants.NAME, type = CommandType.STRING, required = true,\n+            description = \"Creates a role with this unique name\", validations = {ApiArgValidator.NotNullOrEmpty})\n+    private String roleName;\n+\n+    @Parameter(name = ApiConstants.RULES, type = CommandType.MAP, required = true,\n+            description = \"Rules param list, rule and permission is must. Example: rules[0].rule=create*&rules[0].permission=allow&rules[0].description=create%20rule&rules[1].rule=list*&rules[1].permission=allow&rules[1].description=listing\")\n+    private Map rules;\n+\n+    @Parameter(name = ApiConstants.FORCED, type = CommandType.BOOLEAN,\n+            description = \"Force create a role\")", "originalCommit": "f6c039147273a307175aec30583ec22fc6acc940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNTQwNA==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r433405404", "bodyText": "nit - fix description to say what happens in case of a role name matches (i.e. explain for the users that it will override/replace the previosly created role with the provided parameters).\n\nUpdated", "author": "sureshanaparti", "createdAt": "2020-06-01T18:16:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNjEzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNzE1Nw==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r426537157", "bodyText": "I get the reuse with the createRole API, but do we want these parameters for the updateRole API?", "author": "rhtyd", "createdAt": "2020-05-18T10:49:01Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/acl/RoleCmd.java", "diffHunk": "@@ -18,11 +18,41 @@\n package org.apache.cloudstack.api.command.admin.acl;\n \n import org.apache.cloudstack.acl.Role;\n+import org.apache.cloudstack.acl.RoleType;\n+import org.apache.cloudstack.api.ApiConstants;\n import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n import org.apache.cloudstack.api.response.RoleResponse;\n \n+import com.google.common.base.Strings;\n+\n public abstract class RoleCmd extends BaseCmd {\n \n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name = ApiConstants.TYPE, type = CommandType.STRING, description = \"The type of the role, valid options are: Admin, ResourceAdmin, DomainAdmin, User\")\n+    private String roleType;", "originalCommit": "f6c039147273a307175aec30583ec22fc6acc940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5ODM0OA==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r433398348", "bodyText": "I get the reuse with the createRole API, but do we want these parameters for the updateRole API?\n\nyep, UpdateRoleCmd also inherits the same RoleCmd.", "author": "sureshanaparti", "createdAt": "2020-06-01T18:02:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNzE1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNzQ5MQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r426537491", "bodyText": "nit - can you also explain what it means for a role to be default (default could be misleading, perhaps what you mean is if the role is built-in).", "author": "rhtyd", "createdAt": "2020-05-18T10:49:43Z", "path": "api/src/main/java/org/apache/cloudstack/api/response/RoleResponse.java", "diffHunk": "@@ -43,6 +43,10 @@\n     @Param(description = \"the description of the role\")\n     private String roleDescription;\n \n+    @SerializedName(ApiConstants.IS_DEFAULT)\n+    @Param(description = \"true if role is default, false otherwise\")", "originalCommit": "f6c039147273a307175aec30583ec22fc6acc940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwMDUzNQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r433400535", "bodyText": "default meaning this role(s) comes by default with cloudstack installation / upgrade. \"default\" used, in sync with similar usage at the offerings, accounts in CS.", "author": "sureshanaparti", "createdAt": "2020-06-01T18:07:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUzNzQ5MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0MDQ4NQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r426540485", "bodyText": "nit - Can you improve the exception message?", "author": "rhtyd", "createdAt": "2020-05-18T10:55:18Z", "path": "server/src/main/java/org/apache/cloudstack/acl/RoleManagerImpl.java", "diffHunk": "@@ -146,10 +150,89 @@ public RoleVO doInTransaction(TransactionStatus status) {\n         });\n     }\n \n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_ROLE_CREATE, eventDescription = \"creating Role\")\n+    public Role createRole(String name, Role role, String description) {\n+        checkCallerAccess();\n+        return Transaction.execute(new TransactionCallback<RoleVO>() {\n+            @Override\n+            public RoleVO doInTransaction(TransactionStatus status) {\n+                RoleVO newRoleVO = roleDao.persist(new RoleVO(name, role.getRoleType(), description));\n+                if (newRoleVO == null) {\n+                    throw new CloudRuntimeException(\"Unable to add role into DB, is DB full?\");", "originalCommit": "f6c039147273a307175aec30583ec22fc6acc940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMjUzMQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r433412531", "bodyText": "nit - Can you improve the exception message?\n\nUpdated", "author": "sureshanaparti", "createdAt": "2020-06-01T18:30:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0MDQ4NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0MTQ2NQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r426541465", "bodyText": "Here was a check which determined that the role was built-in, i.e. the first 4 roles treated as built-in and no changes to these 4 roles were allowed by using enum idx without requiring a db column for that.", "author": "rhtyd", "createdAt": "2020-05-18T10:57:09Z", "path": "server/src/main/java/org/apache/cloudstack/acl/RoleManagerImpl.java", "diffHunk": "@@ -159,9 +242,6 @@ public Role updateRole(final Role role, final String name, final RoleType roleTy\n             roleVO.setName(name);\n         }\n         if (roleType != null) {\n-            if (role.getId() <= RoleType.User.getId()) {", "originalCommit": "f6c039147273a307175aec30583ec22fc6acc940", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQwNDc4Nw==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r433404787", "bodyText": "@rhtyd agree that the role ids are compared against the role type enum earlier. now these roles, with ids (1,2,3,4) are marked as default roles, which is considered while updating or deleting the role. The role is already populated with db details.", "author": "sureshanaparti", "createdAt": "2020-06-01T18:15:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjU0MTQ2NQ=="}], "type": "inlineReview"}, {"oid": "7bb7f956fa4af56777fef3889cabd2d5cbd75f2e", "url": "https://github.com/apache/cloudstack/commit/7bb7f956fa4af56777fef3889cabd2d5cbd75f2e", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-06-01T17:59:17Z", "type": "forcePushed"}, {"oid": "80aaeaca55ae1638dbc7b39c255f5c26753248e4", "url": "https://github.com/apache/cloudstack/commit/80aaeaca55ae1638dbc7b39c255f5c26753248e4", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-06-01T18:31:17Z", "type": "forcePushed"}, {"oid": "51b45949a42e12f8e420ca1d96c8249e536b2c23", "url": "https://github.com/apache/cloudstack/commit/51b45949a42e12f8e420ca1d96c8249e536b2c23", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-06-09T07:01:00Z", "type": "forcePushed"}, {"oid": "794c215503d1b55b97119c91d072c2d3b1760c17", "url": "https://github.com/apache/cloudstack/commit/794c215503d1b55b97119c91d072c2d3b1760c17", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-06-11T07:03:57Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4NTIwNQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439285205", "bodyText": "Minor nit - can we call the role 'SupportAdmin' and 'SupportUser'?", "author": "rhtyd", "createdAt": "2020-06-12T08:35:54Z", "path": "engine/schema/src/main/java/com/cloud/upgrade/dao/Upgrade41400to41500.java", "diffHunk": "@@ -235,6 +238,267 @@ private void updateSystemVmTemplates(final Connection conn) {\n         LOG.debug(\"Updating System Vm Template IDs Complete\");\n     }\n \n+    private void addRolePermissionsForNewReadOnlyAndSupportRoles(final Connection conn) {\n+        addRolePermissionsForReadOnlyAdmin(conn);\n+        addRolePermissionsForReadOnlyUser(conn);\n+        addRolePermissionsForAdminSupport(conn);\n+        addRolePermissionsForUserSupport(conn);", "originalCommit": "794c215503d1b55b97119c91d072c2d3b1760c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkyNjY3NA==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439926674", "bodyText": "Minor nit - can we call the role 'SupportAdmin' and 'SupportUser'?\n\nUpdated", "author": "sureshanaparti", "createdAt": "2020-06-15T04:38:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4NTIwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4NTcwMA==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439285700", "bodyText": "nit - Could be made less verbose by doing a loop on the API strings and add the string to the collection/list. Same for other parts of code.", "author": "rhtyd", "createdAt": "2020-06-12T08:36:55Z", "path": "engine/schema/src/main/java/com/cloud/upgrade/dao/Upgrade41400to41500.java", "diffHunk": "@@ -235,6 +238,267 @@ private void updateSystemVmTemplates(final Connection conn) {\n         LOG.debug(\"Updating System Vm Template IDs Complete\");\n     }\n \n+    private void addRolePermissionsForNewReadOnlyAndSupportRoles(final Connection conn) {\n+        addRolePermissionsForReadOnlyAdmin(conn);\n+        addRolePermissionsForReadOnlyUser(conn);\n+        addRolePermissionsForAdminSupport(conn);\n+        addRolePermissionsForUserSupport(conn);\n+    }\n+\n+    private void addRolePermissionsForReadOnlyAdmin(final Connection conn) {\n+        LOG.debug(\"Adding role permissions for new read-only admin role\");\n+        try {\n+            PreparedStatement pstmt = conn.prepareStatement(\"SELECT id FROM `cloud`.`roles` WHERE name = 'Read-Only Admin (Default)' AND is_default = 1\");\n+            ResultSet rs = pstmt.executeQuery();\n+            if (rs.next()) {\n+                long readOnlyAdminRoleId = rs.getLong(1);\n+                int readOnlyAdminSortOrder = 0;\n+                List<String> insertSqlForReadOnlyAdminRolePermissions = new ArrayList<String>();\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'list*', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'getUploadParamsFor*', 'DENY', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'get*', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'cloudianIsEnabled', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'quotaIsEnabled', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'quotaTariffList', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'quotaSummary', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyAdminRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, '*', 'DENY', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+\n+                for(String insertSqlForReadOnlyAdmin : insertSqlForReadOnlyAdminRolePermissions) {\n+                    pstmt = conn.prepareStatement(insertSqlForReadOnlyAdmin);\n+                    pstmt.setLong(1, readOnlyAdminRoleId);\n+                    pstmt.setLong(2, readOnlyAdminSortOrder++);\n+                    pstmt.executeUpdate();\n+                }\n+            }\n+\n+            if (rs != null && !rs.isClosed())  {\n+                rs.close();\n+            }\n+            if (pstmt != null && !pstmt.isClosed())  {\n+                pstmt.close();\n+            }\n+            LOG.debug(\"Successfully added role permissions for new read-only admin role\");\n+        } catch (final SQLException e) {\n+            LOG.error(\"Exception while adding role permissions for read-only admin role: \" + e.getMessage());\n+            throw new CloudRuntimeException(\"Exception while adding role permissions for read-only admin role: \" + e.getMessage(), e);\n+        }\n+    }\n+\n+    private void addRolePermissionsForReadOnlyUser(final Connection conn) {\n+        LOG.debug(\"Adding role permissions for new read-only user role\");\n+        try {\n+            PreparedStatement pstmt = conn.prepareStatement(\"SELECT id FROM `cloud`.`roles` WHERE name = 'Read-Only User (Default)' AND is_default = 1\");\n+            ResultSet rs = pstmt.executeQuery();\n+            if (rs.next()) {\n+                long readOnlyUserRoleId = rs.getLong(1);\n+                int readOnlyUserSortOrder = 0;\n+\n+                pstmt = conn.prepareStatement(\"SELECT rule FROM `cloud`.`role_permissions` WHERE role_id = 4 AND permission = 'ALLOW' AND rule LIKE 'list%' ORDER BY sort_order\");\n+                ResultSet rsRolePermissions = pstmt.executeQuery();\n+\n+                while (rsRolePermissions.next()) {\n+                    String rule = rsRolePermissions.getString(1);\n+                    pstmt = conn.prepareStatement(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, ?, 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                    pstmt.setLong(1, readOnlyUserRoleId);\n+                    pstmt.setString(2, rule);\n+                    pstmt.setLong(3, readOnlyUserSortOrder++);\n+                    pstmt.executeUpdate();\n+                }\n+\n+                pstmt = conn.prepareStatement(\"SELECT rule FROM `cloud`.`role_permissions` WHERE role_id = 4 AND permission = 'ALLOW' AND rule LIKE 'get%' AND rule NOT LIKE 'getUploadParamsFor%' ORDER BY sort_order\");\n+                rsRolePermissions = pstmt.executeQuery();\n+\n+                while (rsRolePermissions.next()) {\n+                    String rule = rsRolePermissions.getString(1);\n+                    pstmt = conn.prepareStatement(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, ?, 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                    pstmt.setLong(1, readOnlyUserRoleId);\n+                    pstmt.setString(2, rule);\n+                    pstmt.setLong(3, readOnlyUserSortOrder++);\n+                    pstmt.executeUpdate();\n+                }\n+\n+                List<String> insertSqlForReadOnlyUserRolePermissions = new ArrayList<String>();\n+                insertSqlForReadOnlyUserRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'cloudianIsEnabled', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyUserRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'quotaIsEnabled', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyUserRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'quotaTariffList', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyUserRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'quotaSummary', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                insertSqlForReadOnlyUserRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, '*', 'DENY', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+\n+                for(String insertSqlForReadOnlyUser : insertSqlForReadOnlyUserRolePermissions) {\n+                    pstmt = conn.prepareStatement(insertSqlForReadOnlyUser);\n+                    pstmt.setLong(1, readOnlyUserRoleId);\n+                    pstmt.setLong(2, readOnlyUserSortOrder++);\n+                    pstmt.executeUpdate();\n+                }\n+\n+                if (rsRolePermissions != null && !rsRolePermissions.isClosed())  {\n+                    rsRolePermissions.close();\n+                }\n+            }\n+\n+            if (rs != null && !rs.isClosed())  {\n+                rs.close();\n+            }\n+            if (pstmt != null && !pstmt.isClosed())  {\n+                pstmt.close();\n+            }\n+            LOG.debug(\"Successfully added role permissions for new read-only user role\");\n+        } catch (final SQLException e) {\n+            LOG.error(\"Exception while adding role permissions for read-only user role: \" + e.getMessage());\n+            throw new CloudRuntimeException(\"Exception while adding role permissions for read-only user role: \" + e.getMessage(), e);\n+        }\n+    }\n+\n+    private void addRolePermissionsForAdminSupport(final Connection conn) {\n+        LOG.debug(\"Adding role permissions for new admin support role\");\n+        try {\n+            PreparedStatement pstmt = conn.prepareStatement(\"SELECT id FROM `cloud`.`roles` WHERE name = 'Admin-Support (Default)' AND is_default = 1\");\n+            ResultSet rs = pstmt.executeQuery();\n+            if (rs.next()) {\n+                long adminSupportRoleId = rs.getLong(1);\n+                int adminSupportSortOrder = 0;\n+\n+                pstmt = conn.prepareStatement(\"SELECT id FROM `cloud`.`roles` WHERE name = 'Read-Only Admin (Default)' AND is_default = 1\");\n+                ResultSet rsReadOnlyAdmin = pstmt.executeQuery();\n+                if (rsReadOnlyAdmin.next()) {\n+                    long readOnlyAdminRoleId = rsReadOnlyAdmin.getLong(1);\n+                    pstmt = conn.prepareStatement(\"SELECT rule FROM `cloud`.`role_permissions` WHERE role_id = ? AND permission = 'ALLOW' ORDER BY sort_order\");\n+                    pstmt.setLong(1, readOnlyAdminRoleId);\n+                    ResultSet rsRolePermissions = pstmt.executeQuery();\n+\n+                    while (rsRolePermissions.next()) {\n+                        String rule = rsRolePermissions.getString(1);\n+                        pstmt = conn.prepareStatement(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, ?, 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");\n+                        pstmt.setLong(1, adminSupportRoleId);\n+                        pstmt.setString(2, rule);\n+                        pstmt.setLong(3, adminSupportSortOrder++);\n+                        pstmt.executeUpdate();\n+                    }\n+\n+                    List<String> insertSqlForAdminSupportRolePermissions = new ArrayList<String>();\n+                    insertSqlForAdminSupportRolePermissions.add(\"INSERT INTO `cloud`.`role_permissions` (`uuid`, `role_id`, `rule`, `permission`, `sort_order`) VALUES (UUID(), ?, 'prepareHostForMaintenance', 'ALLOW', ?) ON DUPLICATE KEY UPDATE rule=rule\");", "originalCommit": "794c215503d1b55b97119c91d072c2d3b1760c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkyNjc4NQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439926785", "bodyText": "nit - Could be made less verbose by doing a loop on the API strings and add the string to the collection/list. Same for other parts of code.\n\nUpdated with API rules", "author": "sureshanaparti", "createdAt": "2020-06-15T04:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4NTcwMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4NjM2MQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439286361", "bodyText": "Should the description say we're creating a role by cloning another role ?", "author": "rhtyd", "createdAt": "2020-06-12T08:38:04Z", "path": "server/src/main/java/org/apache/cloudstack/acl/RoleManagerImpl.java", "diffHunk": "@@ -146,10 +150,89 @@ public RoleVO doInTransaction(TransactionStatus status) {\n         });\n     }\n \n+    @Override\n+    @ActionEvent(eventType = EventTypes.EVENT_ROLE_CREATE, eventDescription = \"creating Role\")", "originalCommit": "794c215503d1b55b97119c91d072c2d3b1760c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkyNjg1Mg==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439926852", "bodyText": "Should the description say we're creating a role by cloning another role ?\n\nUpdated event description", "author": "sureshanaparti", "createdAt": "2020-06-15T04:40:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4NjM2MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4ODY0OA==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439288648", "bodyText": "@sureshanaparti why not process rules and convert into a list of TOs/VOs, or something simpler that service layer can easily consume? Can you make the iteration logic simpler? Thanks.", "author": "rhtyd", "createdAt": "2020-06-12T08:42:42Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/acl/ImportRoleCmd.java", "diffHunk": "@@ -0,0 +1,139 @@\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+\n+package org.apache.cloudstack.api.command.admin.acl;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.apache.cloudstack.acl.Role;\n+import org.apache.cloudstack.acl.RoleType;\n+import org.apache.cloudstack.acl.Rule;\n+import org.apache.cloudstack.api.APICommand;\n+import org.apache.cloudstack.api.ApiArgValidator;\n+import org.apache.cloudstack.api.ApiConstants;\n+import org.apache.cloudstack.api.ApiErrorCode;\n+import org.apache.cloudstack.api.BaseCmd;\n+import org.apache.cloudstack.api.Parameter;\n+import org.apache.cloudstack.api.ServerApiException;\n+import org.apache.cloudstack.api.response.RoleResponse;\n+import org.apache.cloudstack.context.CallContext;\n+import org.apache.commons.collections.MapUtils;\n+\n+import com.cloud.user.Account;\n+import com.google.common.base.Strings;\n+\n+@APICommand(name = ImportRoleCmd.APINAME, description = \"Imports a role based on provided map of rule permissions\", responseObject = RoleResponse.class,\n+        requestHasSensitiveInfo = false, responseHasSensitiveInfo = false,\n+        since = \"4.15.0\",\n+        authorized = {RoleType.Admin})\n+public class ImportRoleCmd extends RoleCmd {\n+    public static final String APINAME = \"importRole\";\n+\n+    /////////////////////////////////////////////////////\n+    //////////////// API parameters /////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    @Parameter(name = ApiConstants.NAME, type = CommandType.STRING, required = true,\n+            description = \"Creates a role with this unique name\", validations = {ApiArgValidator.NotNullOrEmpty})\n+    private String roleName;\n+\n+    @Parameter(name = ApiConstants.RULES, type = CommandType.MAP, required = true,\n+            description = \"Rules param list, rule and permission is must. Example: rules[0].rule=create*&rules[0].permission=allow&rules[0].description=create%20rule&rules[1].rule=list*&rules[1].permission=allow&rules[1].description=listing\")\n+    private Map rules;\n+\n+    @Parameter(name = ApiConstants.FORCED, type = CommandType.BOOLEAN,\n+            description = \"Force create a role with the same name. This overrides the role type, description and rule permissions for the existing role. Default is false.\")\n+    private Boolean forced;\n+\n+    /////////////////////////////////////////////////////\n+    /////////////////// Accessors ///////////////////////\n+    /////////////////////////////////////////////////////\n+\n+    public String getRoleName() {\n+        return roleName;\n+    }\n+\n+    public List<Map<String, Object>> getRules() {\n+        if (MapUtils.isEmpty(rules)) {\n+            return null;\n+        }\n+", "originalCommit": "794c215503d1b55b97119c91d072c2d3b1760c17", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTkyNzc5MQ==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r439927791", "bodyText": "@sureshanaparti why not process rules and convert into a list of TOs/VOs, or something simpler that service layer can easily consume? Can you make the iteration logic simpler? Thanks.\n\nThe Map here corresponds to a rule, with the permission details maintained in the keys: rule, permission & description, after validating them. The cmd object hold list of such maps, which are the role permissions for the role being imported.", "author": "sureshanaparti", "createdAt": "2020-06-15T04:45:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTI4ODY0OA=="}], "type": "inlineReview"}, {"oid": "ab3274680e864c71d48f2f3bac0142b1a1661660", "url": "https://github.com/apache/cloudstack/commit/ab3274680e864c71d48f2f3bac0142b1a1661660", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-06-15T04:37:01Z", "type": "forcePushed"}, {"oid": "547d48ec8a1ebe415a65d15b66d96e19bf25a4ec", "url": "https://github.com/apache/cloudstack/commit/547d48ec8a1ebe415a65d15b66d96e19bf25a4ec", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-06-30T10:54:45Z", "type": "forcePushed"}, {"oid": "2749808bd2c54e1cdb90cd8774d1888e0ec7e716", "url": "https://github.com/apache/cloudstack/commit/2749808bd2c54e1cdb90cd8774d1888e0ec7e716", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-06-30T23:38:11Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMjM3Mg==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r448112372", "bodyText": "Since roleType and roleDescription have been moved to RoleCmd class, can we not remove getRoleDescription() from this class?", "author": "Pearl1594", "createdAt": "2020-07-01T04:45:18Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/acl/UpdateRoleCmd.java", "diffHunk": "@@ -67,13 +63,6 @@ public String getRoleName() {\n         return roleName;\n     }\n \n-    public RoleType getRoleType() {\n-        if (!Strings.isNullOrEmpty(roleType)) {\n-            return RoleType.fromString(roleType);\n-        }\n-        return null;\n-    }\n-\n     public String getRoleDescription() {", "originalCommit": "2749808bd2c54e1cdb90cd8774d1888e0ec7e716", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg0NTYwMw==", "url": "https://github.com/apache/cloudstack/pull/4071#discussion_r448845603", "bodyText": "Since roleType and roleDescription have been moved to RoleCmd class, can we not remove getRoleDescription() from this class?\n\nthanks @Pearl1594, missed this one. updated.", "author": "sureshanaparti", "createdAt": "2020-07-02T08:44:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODExMjM3Mg=="}], "type": "inlineReview"}, {"oid": "d719c81efb732296eab4c641c2c33866efd47bb7", "url": "https://github.com/apache/cloudstack/commit/d719c81efb732296eab4c641c2c33866efd47bb7", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-07-02T08:39:32Z", "type": "commit"}, {"oid": "d719c81efb732296eab4c641c2c33866efd47bb7", "url": "https://github.com/apache/cloudstack/commit/d719c81efb732296eab4c641c2c33866efd47bb7", "message": "Dynamic roles improvements. Add-on functionality below.\n\n- Create a role from any of the existing role, using new parameter roleid in createRole API\n- Import a role with its rules, using a new importRole API\n- New default roles for Read-Only and Support Admin & User\n- No modifications allowed for Default roles\n\n- Cleaned up old NetApp APIs from role_permissions table.", "committedDate": "2020-07-02T08:39:32Z", "type": "forcePushed"}]}