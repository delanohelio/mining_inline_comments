{"pr_number": 4555, "pr_title": "VMware: Fix template upload from local", "pr_createdAt": "2020-12-21T19:33:50Z", "pr_url": "https://github.com/apache/cloudstack/pull/4555", "timeline": [{"oid": "9a0ad02e6acdf62c64f6fb1cccaa559d23b50c43", "url": "https://github.com/apache/cloudstack/commit/9a0ad02e6acdf62c64f6fb1cccaa559d23b50c43", "message": "Fix template upload from local", "committedDate": "2020-12-21T14:37:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4OTA4Mw==", "url": "https://github.com/apache/cloudstack/pull/4555#discussion_r547089083", "bodyText": "Should we simply ignore for VMware, even if ostypeid is provided?", "author": "rhtyd", "createdAt": "2020-12-22T06:15:17Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/user/template/GetUploadParamsForTemplateCmd.java", "diffHunk": "@@ -168,6 +170,12 @@ private void validateRequest() {\n         if (getZoneId() <= 0) {\n             throw new ServerApiException(ApiErrorCode.PARAM_ERROR, \"invalid zoneid\");\n         }\n+        if (!hypervisor.equalsIgnoreCase(Hypervisor.HypervisorType.VMware.toString()) && osTypeId == null) {\n+            throw new ServerApiException(ApiErrorCode.PARAM_ERROR, \"Missing parameter ostypeid\");\n+        }\n+        if (hypervisor.equalsIgnoreCase(Hypervisor.HypervisorType.VMware.toString()) && osTypeId != null) {", "originalCommit": "9a0ad02e6acdf62c64f6fb1cccaa559d23b50c43", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4OTUwMQ==", "url": "https://github.com/apache/cloudstack/pull/4555#discussion_r547089501", "bodyText": "... read the code down below, looks like we want the ostypeid to be null so we can get  it from getDefaultDeployAsIsGuestOsId", "author": "rhtyd", "createdAt": "2020-12-22T06:16:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4OTA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxNjEwNA==", "url": "https://github.com/apache/cloudstack/pull/4555#discussion_r547216104", "bodyText": "should we really refuse the parameter as opposed to just ignore it? being this strict may crash operator scripts unnecessarily.", "author": "DaanHoogland", "createdAt": "2020-12-22T11:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4OTA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzIxNjgzOQ==", "url": "https://github.com/apache/cloudstack/pull/4555#discussion_r547216839", "bodyText": "guess I'm late too the party. see ^^", "author": "DaanHoogland", "createdAt": "2020-12-22T11:10:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4OTA4Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzI0OTE4MA==", "url": "https://github.com/apache/cloudstack/pull/4555#discussion_r547249180", "bodyText": "This change is in line with the changes we have done with the registerTemplate API. We are informing the user in case they provide the 'ostypeid' parameter that it is not used anymore and failing", "author": "nvazquez", "createdAt": "2020-12-22T12:26:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzA4OTA4Mw=="}], "type": "inlineReview"}, {"oid": "c747c9b985010b45543ba6c1f05727eb4c9f0e73", "url": "https://github.com/apache/cloudstack/commit/c747c9b985010b45543ba6c1f05727eb4c9f0e73", "message": "Update the guest OS from the OVF file after upload is completed", "committedDate": "2020-12-22T15:52:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzM1ODg4Mw==", "url": "https://github.com/apache/cloudstack/pull/4555#discussion_r547358883", "bodyText": "very significant review comment:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Roll back actions in case of unexpected erros\n          \n          \n            \n                 * Roll back actions in case of unexpected errors", "author": "DaanHoogland", "createdAt": "2020-12-22T15:59:22Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/image/deployasis/DeployAsIsHelperImpl.java", "diffHunk": "@@ -175,14 +168,27 @@ private void handleGuestOsFromOVFDescriptor(long templateId, String guestOsType,\n \n         if (CollectionUtils.isNotEmpty(guestOsMappings)) {\n             GuestOSHypervisorVO mapping = guestOsMappings.get(0);\n-            long guestOsId = mapping.getGuestOsId();\n-            LOGGER.info(\"Updating deploy-as-is template guest OS to \" + guestOsType);\n-            updateTemplateGuestOsId(template, guestOsId);\n+            return mapping.getGuestOsId();\n         } else {\n             throw new CloudRuntimeException(\"Did not find a guest OS with type \" + guestOsType);\n         }\n     }\n \n+    /**\n+     * Handle the guest OS read from the OVF and try to match it to an existing guest OS in DB.\n+     * If the guest OS cannot be mapped to an existing guest OS in DB, then create it and create support for hypervisor versions.\n+     * Roll back actions in case of unexpected erros", "originalCommit": "c747c9b985010b45543ba6c1f05727eb4c9f0e73", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13677e404467e6861834d53bc36471cc0f0b351c", "url": "https://github.com/apache/cloudstack/commit/13677e404467e6861834d53bc36471cc0f0b351c", "message": "Update engine/storage/src/main/java/org/apache/cloudstack/storage/image/deployasis/DeployAsIsHelperImpl.java\n\nCo-authored-by: dahn <daan.hoogland@gmail.com>", "committedDate": "2020-12-22T16:50:38Z", "type": "commit"}]}