{"pr_number": 4375, "pr_title": "Fixing count for findHostsForMigration", "pr_createdAt": "2020-10-05T15:57:02Z", "pr_url": "https://github.com/apache/cloudstack/pull/4375", "timeline": [{"oid": "4e45fde67872104724e815c1c471ae6a3cfb6677", "url": "https://github.com/apache/cloudstack/commit/4e45fde67872104724e815c1c471ae6a3cfb6677", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-05T16:12:39Z", "type": "forcePushed"}, {"oid": "a32685e9c6a73403762217b1636eb7586cacf3ba", "url": "https://github.com/apache/cloudstack/commit/a32685e9c6a73403762217b1636eb7586cacf3ba", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-05T16:16:39Z", "type": "forcePushed"}, {"oid": "182af0d515d6325a54c8affd0b06fc9967430053", "url": "https://github.com/apache/cloudstack/commit/182af0d515d6325a54c8affd0b06fc9967430053", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-05T16:18:40Z", "type": "forcePushed"}, {"oid": "3b9d373de05eb4df2b3b486c3564b9b6082a0ca3", "url": "https://github.com/apache/cloudstack/commit/3b9d373de05eb4df2b3b486c3564b9b6082a0ca3", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-05T18:56:55Z", "type": "forcePushed"}, {"oid": "fd4cc97ae77545f18929d5f1a8fb1709b6e12066", "url": "https://github.com/apache/cloudstack/commit/fd4cc97ae77545f18929d5f1a8fb1709b6e12066", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-05T18:59:47Z", "type": "forcePushed"}, {"oid": "9668193a016dc9a97714102c2be4d10832595d7d", "url": "https://github.com/apache/cloudstack/commit/9668193a016dc9a97714102c2be4d10832595d7d", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-05T19:36:32Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500011471", "bodyText": "@davidjumani any reason, why unsuitable hosts are not removed from the hosts list ?", "author": "sureshanaparti", "createdAt": "2020-10-06T05:20:20Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1278,33 +1277,24 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Map<Host, Boolean> requiresStorageMotion = new HashMap<Host, Boolean>();\n         DataCenterDeployment plan = null;\n         if (canMigrateWithStorage) {\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword, null, null, srcHost.getHypervisorType(),\n-                    srcHost.getHypervisorVersion());\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword,\n+                null, null, srcHost.getHypervisorType(), srcHost.getHypervisorVersion(), srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);\n \n             for (final VolumeVO volume : volumes) {\n                 StoragePool storagePool = _poolDao.findById(volume.getPoolId());\n                 Long volClusterId = storagePool.getClusterId();\n \n-                for (Iterator<HostVO> iterator = allHosts.iterator(); iterator.hasNext();) {\n-                    final Host host = iterator.next();\n-\n+                for (HostVO host : allHosts) {\n                     if (volClusterId != null) {\n                         if (storagePool.isLocal() || !host.getClusterId().equals(volClusterId) || usesLocal) {\n-                            if (storagePool.isManaged()) {\n-                                // At the time being, we do not support storage migration of a volume from managed storage unless the managed storage\n-                                // is at the zone level and the source and target storage pool is the same.\n-                                // If the source and target storage pool is the same and it is managed, then we still have to perform a storage migration\n-                                // because we need to create a new target volume and copy the contents of the source volume into it before deleting the\n-                                // source volume.\n-                                iterator.remove();", "originalCommit": "9668193a016dc9a97714102c2be4d10832595d7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMzIxMA==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500013210", "bodyText": "This is so that the total count and hosts returned remain the same. Rather than removing them, they're marked as not suitable\nhttps://github.com/apache/cloudstack/blob/master/api/src/main/java/org/apache/cloudstack/api/command/admin/host/FindHostsForMigrationCmd.java#L94", "author": "davidjumani", "createdAt": "2020-10-06T05:27:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxNTk3Mw==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500015973", "bodyText": "in actual production, there can be lot of unsuitable hosts. say 60 out of 100 are unsuitable, in this case, list all these and marking unsuitable doesn't sound good. thoughts?", "author": "sureshanaparti", "createdAt": "2020-10-06T05:36:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAyMDQxOQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500020419", "bodyText": "@davidjumani better to update the count result from searchForServers(), when unsuitable hosts are removed, instead changing the existing code for suitable hosts, can cause regression.", "author": "sureshanaparti", "createdAt": "2020-10-06T05:51:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAyMDc1MQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500020751", "bodyText": "Agreed, but since we're paginating the result, we can not remove the hosts in page 2 when we've only fetched the ones in page 1. So marking it as not compatible so that the total count is not broken", "author": "davidjumani", "createdAt": "2020-10-06T05:52:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAzMjE4MA==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500032180", "bodyText": "Pagination is the UI thing, may be some other alternative that can be worked upon. If someone uses the API, doesn't look good to return all hosts, marking suitable & unsuitable.", "author": "sureshanaparti", "createdAt": "2020-10-06T06:26:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAzNjczOQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r500036739", "bodyText": "Again I agree, but that's the way it's already being done, so just fixing the count\nhttps://github.com/apache/cloudstack/blob/master/api/src/main/java/org/apache/cloudstack/api/command/admin/host/FindHostsForMigrationCmd.java#L92", "author": "davidjumani", "createdAt": "2020-10-06T06:37:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzkxNjIwMw==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r503916203", "bodyText": "ok @davidjumani if possible, display the suitable hosts first in the UI.", "author": "sureshanaparti", "createdAt": "2020-10-13T12:39:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYyMjUzOA==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r504622538", "bodyText": "@sureshanaparti Sorted in the UI via apache/cloudstack-primate@a4732a3", "author": "davidjumani", "createdAt": "2020-10-14T12:06:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAxMTQ3MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MzcxNA==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r504563714", "bodyText": "My only concern here is that now that we're not removing hosts, what is those hosts which are not removed now as shown as suitable, would that cause any regression?", "author": "rhtyd", "createdAt": "2020-10-14T10:16:24Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1278,33 +1277,24 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Map<Host, Boolean> requiresStorageMotion = new HashMap<Host, Boolean>();\n         DataCenterDeployment plan = null;\n         if (canMigrateWithStorage) {\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword, null, null, srcHost.getHypervisorType(),\n-                    srcHost.getHypervisorVersion());\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, srcHost.getDataCenterId(), null, null, null, keyword,\n+                null, null, srcHost.getHypervisorType(), srcHost.getHypervisorVersion(), srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);\n \n             for (final VolumeVO volume : volumes) {\n                 StoragePool storagePool = _poolDao.findById(volume.getPoolId());\n                 Long volClusterId = storagePool.getClusterId();\n \n-                for (Iterator<HostVO> iterator = allHosts.iterator(); iterator.hasNext();) {\n-                    final Host host = iterator.next();\n-\n+                for (HostVO host : allHosts) {\n                     if (volClusterId != null) {\n                         if (storagePool.isLocal() || !host.getClusterId().equals(volClusterId) || usesLocal) {\n-                            if (storagePool.isManaged()) {\n-                                // At the time being, we do not support storage migration of a volume from managed storage unless the managed storage\n-                                // is at the zone level and the source and target storage pool is the same.\n-                                // If the source and target storage pool is the same and it is managed, then we still have to perform a storage migration\n-                                // because we need to create a new target volume and copy the contents of the source volume into it before deleting the\n-                                // source volume.\n-                                iterator.remove();\n-                            } else {\n-                                if (hasSuitablePoolsForVolume(volume, host, vmProfile)) {\n-                                    requiresStorageMotion.put(host, true);\n-                                } else {\n-                                    iterator.remove();\n-                                }\n+                            // At the time being, we do not support storage migration of a volume from managed storage unless the managed storage", "originalCommit": "9668193a016dc9a97714102c2be4d10832595d7d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDYwNTExMg==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r504605112", "bodyText": "Changed to use a cloned list hostsWithStorageMigration instead, but reutrning the original allHosts list to not mess up the pagination", "author": "davidjumani", "createdAt": "2020-10-14T11:34:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2MzcxNA=="}], "type": "inlineReview"}, {"oid": "db90a848485e91a4295daddce96d996fc74dbb76", "url": "https://github.com/apache/cloudstack/commit/db90a848485e91a4295daddce96d996fc74dbb76", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-14T11:54:51Z", "type": "commit"}, {"oid": "db90a848485e91a4295daddce96d996fc74dbb76", "url": "https://github.com/apache/cloudstack/commit/db90a848485e91a4295daddce96d996fc74dbb76", "message": "Fixing count for findHostsForMigration", "committedDate": "2020-10-14T11:54:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyMDkwMQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505220901", "bodyText": "@davidjumani do you mean hosts for migration with storage? why another list is required here?", "author": "sureshanaparti", "createdAt": "2020-10-15T06:51:20Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1275,19 +1275,20 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n         final Type hostType = srcHost.getType();\n         Pair<List<HostVO>, Integer> allHostsPair = null;\n         List<HostVO> allHosts = null;\n+        List<HostVO> hostsWithStorageMigration = null;", "originalCommit": "db90a848485e91a4295daddce96d996fc74dbb76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIzMTYwNg==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505231606", "bodyText": "Previously the allHosts list was altered (if storage migration was required) and then used to find the suitable hosts. Instead, now it's being cloned into hostsWithStorageMigration and using the cloned list to find the suitable hosts so that the original list is not altered.", "author": "davidjumani", "createdAt": "2020-10-15T06:59:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyMDkwMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzMzg0OQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505333849", "bodyText": "Ok @davidjumani\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<HostVO> hostsWithStorageMigration = null;\n          \n          \n            \n                    List<HostVO> hostsForMigrationWithStorage = null;", "author": "sureshanaparti", "createdAt": "2020-10-15T08:27:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyMDkwMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyODE1Mg==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505228152", "bodyText": "@davidjumani didn't see any change with respect to hosts count, does these changes fix the count issue?", "author": "sureshanaparti", "createdAt": "2020-10-15T06:57:04Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1326,10 +1327,9 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Searching for all hosts in cluster \" + cluster + \" for migrating VM \" + vm);\n             }\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null, null);\n-            // Filter out the current host.\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null,\n+                null, srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);", "originalCommit": "db90a848485e91a4295daddce96d996fc74dbb76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIzNDI2MQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505234261", "bodyText": "It does since I've added an excludes param in the searchForServers method and passing the source host ID to it. This excludes the source host in the query, as well as ensures that the allHosts list is never altered. So the count remains consistant but unsuitable hosts are marked accordingly", "author": "davidjumani", "createdAt": "2020-10-15T07:01:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTIyODE1Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzOTA4OQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r505339089", "bodyText": "@davidjumani can you check if otherHosts here is not required as there is no change in the allHosts & its count, which you can return as it is (as a List), instead of Pair (with count). You can use use the allHosts count wherever applicable.", "author": "sureshanaparti", "createdAt": "2020-10-15T08:32:13Z", "path": "server/src/main/java/com/cloud/server/ManagementServerImpl.java", "diffHunk": "@@ -1326,10 +1327,9 @@ private HypervisorType getHypervisorType(VMInstanceVO vm, StoragePool srcVolumeP\n             if (s_logger.isDebugEnabled()) {\n                 s_logger.debug(\"Searching for all hosts in cluster \" + cluster + \" for migrating VM \" + vm);\n             }\n-            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null, null);\n-            // Filter out the current host.\n+            allHostsPair = searchForServers(startIndex, pageSize, null, hostType, null, null, null, cluster, null, keyword, null, null, null,\n+                null, srcHost.getId());\n             allHosts = allHostsPair.first();\n-            allHosts.remove(srcHost);\n             plan = new DataCenterDeployment(srcHost.getDataCenterId(), srcHost.getPodId(), srcHost.getClusterId(), null, null, null);\n         }\n ", "originalCommit": "db90a848485e91a4295daddce96d996fc74dbb76", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4NzkwMQ==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r506587901", "bodyText": "It's needed here since the data type is different Pair<List<HostVO>, Integer> vs Pair<List<? extends Host>, Integer>. Also the allHostsPair contains the total count of servers whereas the allHosts lists contains only those in the specified page / pagesize", "author": "davidjumani", "createdAt": "2020-10-16T16:29:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzOTA4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYwNDc4NA==", "url": "https://github.com/apache/cloudstack/pull/4375#discussion_r506604784", "bodyText": "thanks for confirming that @davidjumani", "author": "sureshanaparti", "createdAt": "2020-10-16T17:00:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTMzOTA4OQ=="}], "type": "inlineReview"}, {"oid": "f5fe0b30f38a6534bd901bb1d55b5ea193d55fe1", "url": "https://github.com/apache/cloudstack/commit/f5fe0b30f38a6534bd901bb1d55b5ea193d55fe1", "message": "Changing list name", "committedDate": "2020-10-16T16:24:51Z", "type": "commit"}]}