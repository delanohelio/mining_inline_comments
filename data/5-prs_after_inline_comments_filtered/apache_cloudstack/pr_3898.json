{"pr_number": 3898, "pr_title": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier", "pr_createdAt": "2020-02-20T09:23:58Z", "pr_url": "https://github.com/apache/cloudstack/pull/3898", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MDE5OQ==", "url": "https://github.com/apache/cloudstack/pull/3898#discussion_r381890199", "bodyText": "should there be a value/size check > 0?", "author": "rhtyd", "createdAt": "2020-02-20T09:49:28Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -423,6 +427,12 @@ public void allocate(final String vmInstanceName, final VirtualMachineTemplate t\n \n         final VirtualMachineProfileImpl vmProfile = new VirtualMachineProfileImpl(vmFinal, template, serviceOffering, null, null);\n \n+        Long rootDiskSize = rootDiskOfferingInfo.getSize();\n+        if (vm.getType().isUsedBySystem() && SystemVmRootDiskSize.value() != null) {", "originalCommit": "3d04b4bce595b4b6760796ea4bc3b3a74c693470", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MDcxNQ==", "url": "https://github.com/apache/cloudstack/pull/3898#discussion_r381890715", "bodyText": "Perhaps the check should be of global setting > rootDiskSize?", "author": "rhtyd", "createdAt": "2020-02-20T09:50:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MDE5OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg5MDQ5NA==", "url": "https://github.com/apache/cloudstack/pull/3898#discussion_r381890494", "bodyText": "Maybe set the default to 0, update description to say greater than 0 has an effect.", "author": "rhtyd", "createdAt": "2020-02-20T09:49:59Z", "path": "engine/orchestration/src/main/java/com/cloud/vm/VirtualMachineManagerImpl.java", "diffHunk": "@@ -377,6 +377,10 @@\n     static final ConfigKey<Boolean> HaVmRestartHostUp = new ConfigKey<Boolean>(\"Advanced\", Boolean.class, \"ha.vm.restart.hostup\", \"true\",\n             \"If an out-of-band stop of a VM is detected and its host is up, then power on the VM\", true);\n \n+    static final ConfigKey<Long> SystemVmRootDiskSize = new ConfigKey<Long>(\"Advanced\",\n+            Long.class, \"systemvm.root.disk.size\", \"-1\",", "originalCommit": "3d04b4bce595b4b6760796ea4bc3b3a74c693470", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ba5e03410018d8f848b81de184805b1380704d72", "url": "https://github.com/apache/cloudstack/commit/ba5e03410018d8f848b81de184805b1380704d72", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs.", "committedDate": "2020-02-20T09:53:32Z", "type": "forcePushed"}, {"oid": "225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "url": "https://github.com/apache/cloudstack/commit/225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs.", "committedDate": "2020-02-20T09:55:11Z", "type": "commit"}, {"oid": "225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "url": "https://github.com/apache/cloudstack/commit/225eb0ee4fdd866ef6e38ed135237c5c9f9db09e", "message": "vrouter: reload keepalived instead of restart and fix password server issues when add/remove vpc tier\n\nThis fixes few issues below\n(1) when add/remove a vpc tier, the keepalived is restarted on both master and backup VRs, which causes some seconds donwtime of vpc.\n(2) when remove a vpc tier, the password server is not stopped.\n(3) vpc tier is shutdown because no vm is running for 20 minutes, if we start a vm in the vpc tier, it will be implemented. however the guest ip in VPC VRs will be changed , and password server is still running with old guest ip in VRs.", "committedDate": "2020-02-20T09:55:11Z", "type": "forcePushed"}]}