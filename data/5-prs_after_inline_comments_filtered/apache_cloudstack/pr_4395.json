{"pr_number": 4395, "pr_title": "support for data migration of incremental snaps on xen", "pr_createdAt": "2020-10-12T04:15:22Z", "pr_url": "https://github.com/apache/cloudstack/pull/4395", "timeline": [{"oid": "89cc55af35c9199a983ba32bf3688ee6f5ca5ed9", "url": "https://github.com/apache/cloudstack/commit/89cc55af35c9199a983ba32bf3688ee6f5ca5ed9", "message": "support for handling incremental snaps (on DB entries) on xen", "committedDate": "2020-10-12T16:06:10Z", "type": "commit"}, {"oid": "89cc55af35c9199a983ba32bf3688ee6f5ca5ed9", "url": "https://github.com/apache/cloudstack/commit/89cc55af35c9199a983ba32bf3688ee6f5ca5ed9", "message": "support for handling incremental snaps (on DB entries) on xen", "committedDate": "2020-10-12T16:06:10Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM1MjA1MA==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r505352050", "bodyText": "@Pearl1594 better use if-else / switch-case. The control will come here even when destData is of type SnapshotInfo. If this method is being called for any other destData instance, better add a debug log for unsupported instance.", "author": "sureshanaparti", "createdAt": "2020-10-15T08:43:24Z", "path": "engine/storage/image/src/main/java/org/apache/cloudstack/storage/image/SecondaryStorageServiceImpl.java", "diffHunk": "@@ -198,6 +204,39 @@ protected Void migrateDataCallBack(AsyncCallbackDispatcher<SecondaryStorageServi\n         return null;\n     }\n \n+    private void updateDataObject(DataObject srcData, DataObject destData) {\n+        if (destData instanceof SnapshotInfo) {\n+            SnapshotDataStoreVO snapshotStore = snapshotStoreDao.findBySourceSnapshot(srcData.getId(), DataStoreRole.Image);\n+            SnapshotDataStoreVO destSnapshotStore = snapshotStoreDao.findBySnapshot(srcData.getId(), DataStoreRole.Image);\n+            if (snapshotStore != null && destSnapshotStore != null) {\n+                destSnapshotStore.setPhysicalSize(snapshotStore.getPhysicalSize());\n+                destSnapshotStore.setCreated(snapshotStore.getCreated());\n+                if (snapshotStore.getParentSnapshotId() != destSnapshotStore.getParentSnapshotId()) {\n+                    destSnapshotStore.setParentSnapshotId(snapshotStore.getParentSnapshotId());\n+                }\n+                snapshotStoreDao.update(destSnapshotStore.getId(), destSnapshotStore);\n+            }\n+        }\n+\n+        if (destData instanceof VolumeInfo) {\n+            VolumeDataStoreVO srcVolume = volumeDataStoreDao.findByStoreVolume(srcData.getDataStore().getId(), srcData.getId());\n+            VolumeDataStoreVO destVolume = volumeDataStoreDao.findByStoreVolume(destData.getDataStore().getId(), destData.getId());\n+            if (srcVolume != null && destVolume != null) {\n+                destVolume.setPhysicalSize(srcVolume.getPhysicalSize());\n+                destVolume.setCreated(srcVolume.getCreated());\n+                volumeDataStoreDao.update(destVolume.getId(), destVolume);\n+            }\n+        }\n+\n+        if (destData instanceof TemplateInfo) {", "originalCommit": "89cc55af35c9199a983ba32bf3688ee6f5ca5ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4ODQ5Nw==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r505488497", "bodyText": "agree, it might also be usefull to extract the processing bits in a (template) method to reduce complexity. (no blocker)", "author": "DaanHoogland", "createdAt": "2020-10-15T12:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM1MjA1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM2NzMwNQ==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r505367305", "bodyText": "@Pearl1594 seems epId is no longer required for the check here. Can check with empty epIds ?  for end point, can use the first item from this list?", "author": "sureshanaparti", "createdAt": "2020-10-15T08:54:32Z", "path": "engine/storage/src/main/java/org/apache/cloudstack/storage/image/BaseImageStoreDriverImpl.java", "diffHunk": "@@ -391,12 +391,16 @@ public void copyAsync(DataObject srcdata, DataObject destData, AsyncCompletionCa\n     private Answer sendToLeastBusyEndpoint(List<EndPoint> eps, CopyCommand cmd) {\n         Answer answer = null;\n         EndPoint endPoint = null;\n-        Long epId = ssvmWithLeastMigrateJobs();\n+        List<Long> epIds = ssvmWithLeastMigrateJobs();\n+        Long epId = null;\n+        if (!epIds.isEmpty()) {\n+            epId = epIds.get(0);\n+        }\n         if (epId == null) {", "originalCommit": "89cc55af35c9199a983ba32bf3688ee6f5ca5ed9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ4OTg3Nw==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r505489877", "bodyText": "@sureshanaparti is this a remark to style? if epIds is empty epId is null so the check is needed in some way.", "author": "DaanHoogland", "createdAt": "2020-10-15T12:10:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM2NzMwNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQ5NTk3Mg==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r505495972", "bodyText": "@DaanHoogland the last method ssvmWithLeastMigrateJobs() returns null if it fails to pick ssvm and the null check seems to be valid. The same updated method now returns an empty list if fails. So list with empty check is fine, 'epId' may not be required.", "author": "sureshanaparti", "createdAt": "2020-10-15T12:21:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTM2NzMwNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwODk2MA==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r505508960", "bodyText": "maybe rephrase to \"no src file given/to work with\" or something?", "author": "DaanHoogland", "createdAt": "2020-10-15T12:42:14Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java", "diffHunk": "@@ -1300,16 +1300,16 @@ protected Answer copyFromNfsToNfs(CopyCommand cmd) {\n         try {\n             File srcFile = new File(getDir(srcStore.getUrl(), _nfsVersion), srcData.getPath());\n             File destFile = new File(getDir(destStore.getUrl(), _nfsVersion), destData.getPath());\n-            ImageFormat format = getTemplateFormat(srcFile.getName());\n \n             if (srcFile == null) {\n-                return new CopyCmdAnswer(\"Can't find src file:\" + srcFile);\n+                return new CopyCmdAnswer(\"Can't find src file\");", "originalCommit": "dd4dce59ca87234ad98ffc893d3e5c2a2a0361a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUwOTYzOQ==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r505509639", "bodyText": "is this supposed to be **!**isDir()? or isDir() plain?", "author": "DaanHoogland", "createdAt": "2020-10-15T12:43:16Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java", "diffHunk": "@@ -1300,16 +1300,16 @@ protected Answer copyFromNfsToNfs(CopyCommand cmd) {\n         try {\n             File srcFile = new File(getDir(srcStore.getUrl(), _nfsVersion), srcData.getPath());\n             File destFile = new File(getDir(destStore.getUrl(), _nfsVersion), destData.getPath());\n-            ImageFormat format = getTemplateFormat(srcFile.getName());\n \n             if (srcFile == null) {\n-                return new CopyCmdAnswer(\"Can't find src file:\" + srcFile);\n+                return new CopyCmdAnswer(\"Can't find src file\");\n             }\n+            ImageFormat format = getTemplateFormat(srcFile.getName());\n             if (srcData instanceof TemplateObjectTO || srcData instanceof VolumeObjectTO) {\n                 File srcDir = null;\n                 if (srcFile.isFile() || srcFile.getName().contains(\".\")) {\n                     srcDir = new File(srcFile.getParent());\n-                } else if (!srcFile.isFile() && !srcFile.isDirectory()) {\n+                } else if (!srcFile.isDirectory()) {", "originalCommit": "dd4dce59ca87234ad98ffc893d3e5c2a2a0361a2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b2eb29f86cf5ff8563bd8475b412c89cbc0ce20e", "url": "https://github.com/apache/cloudstack/commit/b2eb29f86cf5ff8563bd8475b412c89cbc0ce20e", "message": "Addressed comments", "committedDate": "2020-10-16T03:39:29Z", "type": "forcePushed"}, {"oid": "196e205eb06d0b3ebb3dad36c48cc506b5659abc", "url": "https://github.com/apache/cloudstack/commit/196e205eb06d0b3ebb3dad36c48cc506b5659abc", "message": "Addressed comments", "committedDate": "2020-10-16T03:52:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0NDUwNA==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r506044504", "bodyText": "adding path and datastore id to the log might help in debugging", "author": "sureshanaparti", "createdAt": "2020-10-16T04:27:30Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java", "diffHunk": "@@ -1300,15 +1300,17 @@ protected Answer copyFromNfsToNfs(CopyCommand cmd) {\n         try {\n             File srcFile = new File(getDir(srcStore.getUrl(), _nfsVersion), srcData.getPath());\n             File destFile = new File(getDir(destStore.getUrl(), _nfsVersion), destData.getPath());\n-            ImageFormat format = getTemplateFormat(srcFile.getName());\n \n             if (srcFile == null) {\n-                return new CopyCmdAnswer(\"Can't find src file:\" + srcFile);\n+                return new CopyCmdAnswer(\"Can't find source file to initiate file transfer\");", "originalCommit": "196e205eb06d0b3ebb3dad36c48cc506b5659abc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0NjI5MA==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r506046290", "bodyText": "done", "author": "Pearl1594", "createdAt": "2020-10-16T04:35:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0NDUwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0NTA5MQ==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r506045091", "bodyText": "check if this causes any regression", "author": "sureshanaparti", "createdAt": "2020-10-16T04:30:11Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java", "diffHunk": "@@ -1351,7 +1353,7 @@ protected Answer copyFromNfsToNfs(CopyCommand cmd) {\n                 if (srcFile.isFile()) {\n                     newVol.setPath(destData.getPath() + File.separator + srcFile.getName());\n                 } else {\n-                    newVol.setPath(destData.getPath());\n+                    newVol.setPath(srcData.getPath());", "originalCommit": "196e205eb06d0b3ebb3dad36c48cc506b5659abc", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0NjI0Mw==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r506046243", "bodyText": "Have verified this", "author": "Pearl1594", "createdAt": "2020-10-16T04:34:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA0NTA5MQ=="}], "type": "inlineReview"}, {"oid": "64bca0ec2249faad7ac58f4eb881e68d55aa99fe", "url": "https://github.com/apache/cloudstack/commit/64bca0ec2249faad7ac58f4eb881e68d55aa99fe", "message": "Addressed comments", "committedDate": "2020-10-16T04:34:19Z", "type": "commit"}, {"oid": "64bca0ec2249faad7ac58f4eb881e68d55aa99fe", "url": "https://github.com/apache/cloudstack/commit/64bca0ec2249faad7ac58f4eb881e68d55aa99fe", "message": "Addressed comments", "committedDate": "2020-10-16T04:34:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjA1NjE1Ng==", "url": "https://github.com/apache/cloudstack/pull/4395#discussion_r506056156", "bodyText": "make sure spaces are properly aligned on the log code, rest changes LGTM", "author": "sureshanaparti", "createdAt": "2020-10-16T05:14:26Z", "path": "services/secondary-storage/server/src/main/java/org/apache/cloudstack/storage/resource/NfsSecondaryStorageResource.java", "diffHunk": "@@ -1300,15 +1300,17 @@ protected Answer copyFromNfsToNfs(CopyCommand cmd) {\n         try {\n             File srcFile = new File(getDir(srcStore.getUrl(), _nfsVersion), srcData.getPath());\n             File destFile = new File(getDir(destStore.getUrl(), _nfsVersion), destData.getPath());\n-            ImageFormat format = getTemplateFormat(srcFile.getName());\n \n             if (srcFile == null) {\n-                return new CopyCmdAnswer(\"Can't find src file:\" + srcFile);\n+                return new CopyCmdAnswer(\"Can't find source file at path: \"+ srcData.getPath() +\"on datastore: \"+ srcDataStore.getUuid() +\" to initiate file transfer\");", "originalCommit": "64bca0ec2249faad7ac58f4eb881e68d55aa99fe", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "7332ce564d49b73928bf1ce2c817099ea246af64", "url": "https://github.com/apache/cloudstack/commit/7332ce564d49b73928bf1ce2c817099ea246af64", "message": "Update NfsSecondaryStorageResource.java\n\nadjusted space in comment/ log", "committedDate": "2020-10-16T05:20:47Z", "type": "commit"}]}