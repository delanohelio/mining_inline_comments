{"pr_number": 3919, "pr_title": "Handle EOFException during VR Health Check", "pr_createdAt": "2020-02-28T12:16:03Z", "pr_url": "https://github.com/apache/cloudstack/pull/3919", "timeline": [{"oid": "6f9728cd7ec05843303311adf8c6c7dc58415593", "url": "https://github.com/apache/cloudstack/commit/6f9728cd7ec05843303311adf8c6c7dc58415593", "message": "Handle EOFException during VR Health Check", "committedDate": "2020-02-28T12:13:22Z", "type": "commit"}, {"oid": "e6af6c9f360a16920a2edb6ce9bb68a8c5345513", "url": "https://github.com/apache/cloudstack/commit/e6af6c9f360a16920a2edb6ce9bb68a8c5345513", "message": "Handled EOF exception with VR health check", "committedDate": "2020-03-01T18:00:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI0NDM5MQ==", "url": "https://github.com/apache/cloudstack/pull/3919#discussion_r386244391", "bodyText": "@Pearl1594 what's this magic number?", "author": "rhtyd", "createdAt": "2020-03-02T08:11:56Z", "path": "utils/src/main/java/com/cloud/utils/ssh/SshHelper.java", "diffHunk": "@@ -184,12 +185,11 @@ public static void scpTo(String host, int port, String user, File pemKeyFile, St\n \n             sess.execCommand(command);\n \n-            InputStream stdout = sess.getStdout();\n-            InputStream stderr = sess.getStderr();\n-\n-            byte[] buffer = new byte[8192];\n-            StringBuffer sbResult = new StringBuffer();\n+            StreamGobbler stdout = new StreamGobbler(sess.getStdout());\n+            StreamGobbler stderr = new StreamGobbler(sess.getStderr());\n \n+            byte[] buffer = new byte[16384];\n+            StringBuffer sbResult = new StringBuffer(214748364);", "originalCommit": "e6af6c9f360a16920a2edb6ce9bb68a8c5345513", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI0NjM0Ng==", "url": "https://github.com/apache/cloudstack/pull/3919#discussion_r386246346", "bodyText": "@rhtyd the number represents the number of characters that corresponds to 200MB", "author": "Pearl1594", "createdAt": "2020-03-02T08:17:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI0NDM5MQ=="}], "type": "inlineReview"}, {"oid": "5e769bcff8a13c0588bdfdca1fa1ce4e86a6cee2", "url": "https://github.com/apache/cloudstack/commit/5e769bcff8a13c0588bdfdca1fa1ce4e86a6cee2", "message": "Handle EOF Exception", "committedDate": "2020-03-03T11:21:38Z", "type": "forcePushed"}, {"oid": "d94aa9ecc30bea11bd2ff1aa7e9d9a9349551d0c", "url": "https://github.com/apache/cloudstack/commit/d94aa9ecc30bea11bd2ff1aa7e9d9a9349551d0c", "message": "Handle EOF Exception", "committedDate": "2020-03-03T11:24:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2MDU2OA==", "url": "https://github.com/apache/cloudstack/pull/3919#discussion_r386960568", "bodyText": "@Pearl1594 instead of > 0 we probably want to check for readbytes != -1. For example: (comments only for your understanding)\ncurrentReadBytes = stdout.read(buffer);\nwhile (currentReadBytes >= 0) { // or check for != -1\n  sbResult.append(new String(buffer, 0, currentReadBytes));\n  currentReadBytes = stdout.read(buffer); // read() will return -1 on eof/complete\n}\n\nThe other option is to use a more modern java-way to use BufferedReader for example like:\n BufferedReader bufferedStdOut = new BufferedReader(stdout);\n.... use", "author": "rhtyd", "createdAt": "2020-03-03T11:32:31Z", "path": "utils/src/main/java/com/cloud/utils/ssh/SshHelper.java", "diffHunk": "@@ -207,22 +206,18 @@ public static void scpTo(String host, int port, String user, File pemKeyFile, St\n                     if (canEndTheSshConnection(waitResultTimeoutInMs, sess, conditions)) {\n                         break;\n                     }\n-\n                 }\n \n-                while (stdout.available() > 0) {\n-                    currentReadBytes = stdout.read(buffer);\n-                    sbResult.append(new String(buffer, 0, currentReadBytes));\n+               while((currentReadBytes = stdout.read(buffer)) > 0) {", "originalCommit": "d94aa9ecc30bea11bd2ff1aa7e9d9a9349551d0c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2NDgzMA==", "url": "https://github.com/apache/cloudstack/pull/3919#discussion_r386964830", "bodyText": "@rhtyd I did consider using that, however decided against it so at to avoid wrapping the Input Stream. Also used the readAllBytes() but that would increase the memory footprint as indicated earlier. So, went ahead with this approach.", "author": "Pearl1594", "createdAt": "2020-03-03T11:41:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2MDU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4MTg4OQ==", "url": "https://github.com/apache/cloudstack/pull/3919#discussion_r386981889", "bodyText": "@Pearl1594 long shot but you are using a test for '> 0'. What if the stream is blocking due to timing issues but not ended yet? Wouldn't we still end reading before end of stream?", "author": "DaanHoogland", "createdAt": "2020-03-03T12:18:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2MDU2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk4MjQ0Mw==", "url": "https://github.com/apache/cloudstack/pull/3919#discussion_r386982443", "bodyText": "never mind, guess you already changed that.", "author": "DaanHoogland", "createdAt": "2020-03-03T12:19:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njk2MDU2OA=="}], "type": "inlineReview"}, {"oid": "4d4031722d6cfeb9d9899cfb8445c094f150bda8", "url": "https://github.com/apache/cloudstack/commit/4d4031722d6cfeb9d9899cfb8445c094f150bda8", "message": "Handle EOF Exception", "committedDate": "2020-03-03T12:00:25Z", "type": "commit"}, {"oid": "4d4031722d6cfeb9d9899cfb8445c094f150bda8", "url": "https://github.com/apache/cloudstack/commit/4d4031722d6cfeb9d9899cfb8445c094f150bda8", "message": "Handle EOF Exception", "committedDate": "2020-03-03T12:00:25Z", "type": "forcePushed"}]}