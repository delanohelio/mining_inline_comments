{"pr_number": 4388, "pr_title": "fix NPE in volumes statistics", "pr_createdAt": "2020-10-07T05:36:31Z", "pr_url": "https://github.com/apache/cloudstack/pull/4388", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MDUwNg==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501680506", "bodyText": "@slavkap what is the impact on volume stats for managed / local storage pool ? can this cause regression?", "author": "sureshanaparti", "createdAt": "2020-10-08T12:28:53Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1930,18 +1931,13 @@ private boolean upgradeRunningVirtualMachine(Long vmId, Long newServiceOfferingI\n     public HashMap<String, VolumeStatsEntry> getVolumeStatistics(long clusterId, String poolUuid, StoragePoolType poolType, List<String> volumeLocators, int timeout) {\n         List<HostVO> neighbors = _resourceMgr.listHostsInClusterByStatus(clusterId, Status.Up);\n         StoragePoolVO storagePool = _storagePoolDao.findPoolByUUID(poolUuid);\n-        for (HostVO neighbor : neighbors) {\n-            // apply filters:\n-            // - managed storage\n-            // - local storage\n-            if (storagePool.isManaged() || storagePool.isLocal()) {", "originalCommit": "55f084dee293d0899ee0f145d3ccf57acc05e69e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwNTE1OQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502205159", "bodyText": "The logic was correct for managed/local storages, but for unmanaged I've descried in the description what is happening. I have tested with NFS unmanaged storage and StorPool as well, and it should get the volumes only on the current host", "author": "slavkap", "createdAt": "2020-10-09T06:00:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MDUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2Nzg3Mw==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502267873", "bodyText": "@slavkap For non-managed & shared pools, the volumeLocators passed to the method is directly used earlier, instead from the host(s). Now, volumeLocators in the method arg, is not used anymore. You can remove the arg if not required. Please check and update accordingly.", "author": "sureshanaparti", "createdAt": "2020-10-09T08:23:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MDUwNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg1MDIzNQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r503850235", "bodyText": "removed volumeLocators", "author": "slavkap", "createdAt": "2020-10-13T10:44:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MDUwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY4MTI3MQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501681271", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if (vr.getFormat() == ImageFormat.VHD || vr.getFormat() == ImageFormat.QCOW2){\n          \n          \n            \n                        if (vr.getFormat() == ImageFormat.VHD || vr.getFormat() == ImageFormat.QCOW2) {", "author": "sureshanaparti", "createdAt": "2020-10-08T12:29:58Z", "path": "server/src/main/java/com/cloud/api/query/ViewResponseHelper.java", "diffHunk": "@@ -287,10 +287,7 @@\n             vrDataList.put(vr.getId(), vrData);\n \n             VolumeStats vs = null;\n-            if (vr.getFormat() == ImageFormat.QCOW2) {\n-                vs = ApiDBUtils.getVolumeStatistics(vrData.getId());\n-            }\n-            else if (vr.getFormat() == ImageFormat.VHD){\n+            if (vr.getFormat() == ImageFormat.VHD || vr.getFormat() == ImageFormat.QCOW2){", "originalCommit": "55f084dee293d0899ee0f145d3ccf57acc05e69e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NDMzOQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501694339", "bodyText": "@slavkap check if this can cause regression, for listing hypervisors for zone.", "author": "sureshanaparti", "createdAt": "2020-10-08T12:51:02Z", "path": "engine/schema/src/main/java/com/cloud/dc/dao/ClusterDaoImpl.java", "diffHunk": "@@ -81,7 +81,6 @@ public ClusterDaoImpl() {\n \n         ZoneSearch = createSearchBuilder();\n         ZoneSearch.and(\"dataCenterId\", ZoneSearch.entity().getDataCenterId(), SearchCriteria.Op.EQ);\n-        ZoneSearch.groupBy(ZoneSearch.entity().getHypervisorType());", "originalCommit": "55f084dee293d0899ee0f145d3ccf57acc05e69e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwOTAxNQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502209015", "bodyText": "@sureshanaparti I have tested it. My setup is 2 KVM cluster with 2 hosts on each. Before the change when listing hypervisors:\n\nlist hypervisors zoneid=307c2b69-86eb-451e-8517-6113c59648c4\n{ \"count\": 1,  \"hypervisor\": [ { \"name\": \"KVM\" } ] }\n\nwith the change when listing hypervisors:\n\nlist hypervisors zoneid=307c2b69-86eb-451e-8517-6113c59648c4\n{ \"count\": 2,  \"hypervisor\": [  { \"name\": \"KVM\"  },   {  \"name\": \"KVM\"  } ] }", "author": "slavkap", "createdAt": "2020-10-09T06:12:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1ODQxOQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502258419", "bodyText": "@slavkap list hypervisors should return only 1 KVM, that is the reason for group by.", "author": "sureshanaparti", "createdAt": "2020-10-09T08:07:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NDMzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NjI0Mg==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502266242", "bodyText": "ok than, I wasn't sure that it should return only 1 KVM if we have for example 3 clusters of them. I will implement another method, which gets all clusters in the zone. It's needed for StatsCollector to list all clusters in the zone, otherwise we get only one cluster of a hypervisor type.", "author": "slavkap", "createdAt": "2020-10-09T08:20:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTY5NDMzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMTc4Ng==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r501701786", "bodyText": "@slavkap volume path is not the locator for OVA format, update with chain info ?", "author": "sureshanaparti", "createdAt": "2020-10-08T13:02:32Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1956,16 +1952,16 @@ private boolean upgradeRunningVirtualMachine(Long vmId, Long newServiceOfferingI\n \n             if (answer instanceof GetVolumeStatsAnswer){\n                 GetVolumeStatsAnswer volstats = (GetVolumeStatsAnswer)answer;\n-                return volstats.getVolumeStats();\n+                volumeStatsByUuid.putAll(volstats.getVolumeStats());\n             }\n         }\n-        return null;\n+        return volumeStatsByUuid.size() > 0 ? volumeStatsByUuid : null;\n     }\n \n     private List<String> getVolumesByHost(HostVO host, StoragePool pool){\n-        List<UserVmVO> vmsPerHost = _vmDao.listByHostId(host.getId());\n+        List<VMInstanceVO> vmsPerHost = _vmInstanceDao.listByHostId(host.getId());\n         return vmsPerHost.stream()\n-                .flatMap(vm -> _volsDao.findByInstanceIdAndPoolId(vm.getId(),pool.getId()).stream().map(vol -> vol.getPath()))\n+                .flatMap(vm -> _volsDao.findByInstanceIdAndPoolId(vm.getId(),pool.getId()).stream().map(vol -> vol.getState() == Volume.State.Ready ? vol.getPath() : null).filter(Objects::nonNull))", "originalCommit": "55f084dee293d0899ee0f145d3ccf57acc05e69e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjIwMzg3Ng==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502203876", "bodyText": "@sureshanaparti I was just follow the original logic and just added to get only the volumes with status \"Ready\". I will check for the rest of the formats, but I will be not able to do tests for them", "author": "slavkap", "createdAt": "2020-10-09T05:55:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMTc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2MDg3Nw==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502260877", "bodyText": "ok @slavkap  you have corrected the volume locator for QCOW2 in the response helper, this would be similar change for OVA here.", "author": "sureshanaparti", "createdAt": "2020-10-09T08:11:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMTc4Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NjkyNQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r502266925", "bodyText": "yes, I will add to check if it's OVA", "author": "slavkap", "createdAt": "2020-10-09T08:21:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMTc4Ng=="}], "type": "inlineReview"}, {"oid": "e4cb5d697e6c2e800f498a0e56815c8a56f5ae25", "url": "https://github.com/apache/cloudstack/commit/e4cb5d697e6c2e800f498a0e56815c8a56f5ae25", "message": "Formating the brackets", "committedDate": "2020-10-13T10:40:51Z", "type": "forcePushed"}, {"oid": "4fa9f6374cab948217392eec9bbfaecde05ff573", "url": "https://github.com/apache/cloudstack/commit/4fa9f6374cab948217392eec9bbfaecde05ff573", "message": "Formating the brackets", "committedDate": "2020-10-28T12:05:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514068122", "bodyText": "@slavkap move this condition check (ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType() before getting volume locators.\nand use CollectionUtils for volumeLocators\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        if ((ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType()) || (volumeLocators == null || volumeLocators.size() == 0)) {\n          \n          \n            \n                        if (CollectionUtils.isEmpty(volumeLocators)) {", "author": "sureshanaparti", "createdAt": "2020-10-29T08:04:44Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -1954,21 +1955,16 @@ private boolean upgradeRunningVirtualMachine(Long vmId, Long newServiceOfferingI\n     }\n \n     @Override\n-    public HashMap<String, VolumeStatsEntry> getVolumeStatistics(long clusterId, String poolUuid, StoragePoolType poolType, List<String> volumeLocators, int timeout) {\n+    public HashMap<String, VolumeStatsEntry> getVolumeStatistics(long clusterId, String poolUuid, StoragePoolType poolType,  int timeout) {\n         List<HostVO> neighbors = _resourceMgr.listHostsInClusterByStatus(clusterId, Status.Up);\n         StoragePoolVO storagePool = _storagePoolDao.findPoolByUUID(poolUuid);\n-        for (HostVO neighbor : neighbors) {\n-            // apply filters:\n-            // - managed storage\n-            // - local storage\n-            if (storagePool.isManaged() || storagePool.isLocal()) {\n+        HashMap<String, VolumeStatsEntry> volumeStatsByUuid = new HashMap<>();\n \n-                volumeLocators = getVolumesByHost(neighbor, storagePool);\n-\n-            }\n+        for (HostVO neighbor : neighbors) {\n+            List<String> volumeLocators = getVolumesByHost(neighbor, storagePool);\n \n             // - zone wide storage for specific hypervisortypes\n-            if (ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType()) {\n+            if ((ScopeType.ZONE.equals(storagePool.getScope()) && storagePool.getHypervisor() != neighbor.getHypervisorType()) || (volumeLocators == null || volumeLocators.size() == 0)) {", "originalCommit": "4fa9f6374cab948217392eec9bbfaecde05ff573", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMDc1MA==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514100750", "bodyText": "Thanks @sureshanaparti ! I'll do the change suggestion, but may I ask is it appropriate if I push this PR in earlier version of CS for example 4.13.2.0?", "author": "slavkap", "createdAt": "2020-10-29T09:02:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwMjU3OA==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514102578", "bodyText": "@slavkap yes, we will then merge forward, no problem (except maybe a conflict to resolve)", "author": "DaanHoogland", "createdAt": "2020-10-29T09:05:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDEwNTQ2Nw==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514105467", "bodyText": "Thanks @DaanHoogland! I'll fix the conflicts and will push it against 4.13.2.0", "author": "slavkap", "createdAt": "2020-10-29T09:10:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE2ODA5MQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514168091", "bodyText": "may I ask for advice, because I'm not sure how to proceed? I've never changed the branch of a PR, so what is the right action - to edit this PR branch or to checkout to a branch which is on top of 4.13, to cherry-pick the changes (resolve conflicts) and to create new pull request?", "author": "slavkap", "createdAt": "2020-10-29T10:52:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5NzIxOQ==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514197219", "bodyText": "you can try and rebase the range of your commit on top of 4.13, or you can cherrypinck. when done you should force push and you can then change the base branch.", "author": "DaanHoogland", "createdAt": "2020-10-29T11:47:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDIwMTgyNw==", "url": "https://github.com/apache/cloudstack/pull/4388#discussion_r514201827", "bodyText": "thanks again @DaanHoogland !", "author": "slavkap", "createdAt": "2020-10-29T11:55:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA2ODEyMg=="}], "type": "inlineReview"}, {"oid": "a77d518b9ec37d46d295506f87aaad073b984dad", "url": "https://github.com/apache/cloudstack/commit/a77d518b9ec37d46d295506f87aaad073b984dad", "message": "Won't get volumes if the hypervisor type is not the same of the store", "committedDate": "2020-10-29T10:26:34Z", "type": "forcePushed"}, {"oid": "cff272af56d1f1eeeea7023b41f545ddb8e8c497", "url": "https://github.com/apache/cloudstack/commit/cff272af56d1f1eeeea7023b41f545ddb8e8c497", "message": "fix NPE in volumes statistics\n\nIf volume is migrated between storage pools and \"volume.stats.interval\"\nis set to more frequent interval for exmaple 30 sec.\nNullPointerException is thrown, because the hypervisor is looking for\nvolume on storage pool from which the volume was migrated.\nThe statistics did not work right - before this fix only one cluster is\nlists if we have more clusters from the same type (eg. KVM), and only\none host will return volume stats. Also all volumes are sent to that\nhost, but they could be on another host. And the logic does not work\ncorrectly.\nAlso the response was not working correctly for QCOW2 images, because\nit's looking for volume's uuid, but in the statistics CS keeps the path\n(because of the migrated volumes which UUIDs are changed)", "committedDate": "2020-10-29T12:39:25Z", "type": "commit"}, {"oid": "2f445dfc0db1dd634f8f9aab7caa6fc0f6f106d4", "url": "https://github.com/apache/cloudstack/commit/2f445dfc0db1dd634f8f9aab7caa6fc0f6f106d4", "message": "list all virtual machines by host id", "committedDate": "2020-10-29T12:39:29Z", "type": "commit"}, {"oid": "03a783734be2f36c24dbb717debfa0fb1a49e772", "url": "https://github.com/apache/cloudstack/commit/03a783734be2f36c24dbb717debfa0fb1a49e772", "message": "Return groupBy hypervisor type when listing clusters by zone id", "committedDate": "2020-10-29T12:39:29Z", "type": "commit"}, {"oid": "a82f4e3705d16fe47c63f2294101d3a007bf360c", "url": "https://github.com/apache/cloudstack/commit/a82f4e3705d16fe47c63f2294101d3a007bf360c", "message": "Replace listByZoneId in VolumeStatsTask with listClustersByDcId", "committedDate": "2020-10-29T12:39:29Z", "type": "commit"}, {"oid": "5c5f5f4dbe3320ab0d5fc72f89b80563e8ac2462", "url": "https://github.com/apache/cloudstack/commit/5c5f5f4dbe3320ab0d5fc72f89b80563e8ac2462", "message": "Removed unused arg and condition if format is OVA when listing volumes", "committedDate": "2020-10-29T12:39:29Z", "type": "commit"}, {"oid": "fcb9979f06f412d75f258d6d9d76b1ec8cf711e5", "url": "https://github.com/apache/cloudstack/commit/fcb9979f06f412d75f258d6d9d76b1ec8cf711e5", "message": "Formating the brackets", "committedDate": "2020-10-29T12:39:29Z", "type": "commit"}, {"oid": "5008846187b7ab0bc81b228ee99e1344afa4b7fe", "url": "https://github.com/apache/cloudstack/commit/5008846187b7ab0bc81b228ee99e1344afa4b7fe", "message": "Won't get volumes if the hypervisor type is not the same of the store", "committedDate": "2020-10-29T12:39:29Z", "type": "commit"}, {"oid": "5008846187b7ab0bc81b228ee99e1344afa4b7fe", "url": "https://github.com/apache/cloudstack/commit/5008846187b7ab0bc81b228ee99e1344afa4b7fe", "message": "Won't get volumes if the hypervisor type is not the same of the store", "committedDate": "2020-10-29T12:39:29Z", "type": "forcePushed"}, {"oid": "93214ffe2b83f97601c910c54821d7fda1c985a8", "url": "https://github.com/apache/cloudstack/commit/93214ffe2b83f97601c910c54821d7fda1c985a8", "message": "Add import for CollectionUtils", "committedDate": "2020-10-29T19:32:26Z", "type": "commit"}]}