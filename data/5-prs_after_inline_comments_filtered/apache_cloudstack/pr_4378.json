{"pr_number": 4378, "pr_title": "server: Optional destination host when migrate a vm", "pr_createdAt": "2020-10-06T07:26:38Z", "pr_url": "https://github.com/apache/cloudstack/pull/4378", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDQxMg==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r502264412", "bodyText": "@ustcweizhou finding a suitable host anywhere within the zone might result in returning a host in a different pod or cluster. This might also need storage migration. Will that be an issue? Especially when VM is having data disks attached. Also, cross-cluster at present fails on VMware when storage pools are cluster scoped. #4385", "author": "shwstppr", "createdAt": "2020-10-09T08:17:12Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5627,6 +5629,50 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n \n         // check if migrating to same host\n         long srcHostId = vm.getHostId();\n+\n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Do not check last host\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), null, null, null, null, null);", "originalCommit": "37e570f9f10fd5e62569c69250fa18230d89c051", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjYyODk5Nw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r502628997", "bodyText": "@shwstppr you are right.\nI will refactor it.", "author": "weizhouapache", "createdAt": "2020-10-09T19:22:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDQxMg=="}], "type": "inlineReview"}, {"oid": "de06a9a71e148b7345933bc24075aa38a1dea579", "url": "https://github.com/apache/cloudstack/commit/de06a9a71e148b7345933bc24075aa38a1dea579", "message": " #4378: look for host in same cluster in vm migration", "committedDate": "2020-10-10T13:21:37Z", "type": "forcePushed"}, {"oid": "3bc3773ef5307251d07edab20b682faafe660a9a", "url": "https://github.com/apache/cloudstack/commit/3bc3773ef5307251d07edab20b682faafe660a9a", "message": " #4378: look for host in same cluster in vm migration", "committedDate": "2020-10-10T14:15:56Z", "type": "forcePushed"}, {"oid": "4e22e640837f0fb284eb22a90f1d3cb07ee3d4bd", "url": "https://github.com/apache/cloudstack/commit/4e22e640837f0fb284eb22a90f1d3cb07ee3d4bd", "message": " #4378: Remove last host from excludes list", "committedDate": "2020-10-30T08:54:19Z", "type": "forcePushed"}, {"oid": "f7078b5bdd4f1dfd6f9653e2d45c095e29e53514", "url": "https://github.com/apache/cloudstack/commit/f7078b5bdd4f1dfd6f9653e2d45c095e29e53514", "message": " #4378: fix NPE while migrate vm with custom offering", "committedDate": "2021-01-26T13:33:45Z", "type": "forcePushed"}, {"oid": "b69e728fcd4695cab95f38a2617959b5610889d7", "url": "https://github.com/apache/cloudstack/commit/b69e728fcd4695cab95f38a2617959b5610889d7", "message": "server: Optional destination host when migrate a vm", "committedDate": "2021-02-18T22:10:07Z", "type": "forcePushed"}, {"oid": "51ea345a076a72cfeefecbf12ef7bc7b84569a0f", "url": "https://github.com/apache/cloudstack/commit/51ea345a076a72cfeefecbf12ef7bc7b84569a0f", "message": "server: Optional destination host when migrate a vm", "committedDate": "2021-03-15T13:37:40Z", "type": "commit"}, {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a", "url": "https://github.com/apache/cloudstack/commit/9bdc324d860acfc074fa94707467f9131bdbc88a", "message": " #4378: migrate systemvms/routers with optional host", "committedDate": "2021-03-15T13:44:25Z", "type": "commit"}, {"oid": "9bdc324d860acfc074fa94707467f9131bdbc88a", "url": "https://github.com/apache/cloudstack/commit/9bdc324d860acfc074fa94707467f9131bdbc88a", "message": " #4378: migrate systemvms/routers with optional host", "committedDate": "2021-03-15T13:44:25Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTEzMTE4Mw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595131183", "bodyText": "@weizhouapache do you need to remove this condition else either hostid or storageid must be provided", "author": "shwstppr", "createdAt": "2021-03-16T12:41:23Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -126,30 +126,30 @@ public void execute() {\n             throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");", "originalCommit": "9bdc324d860acfc074fa94707467f9131bdbc88a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6", "url": "https://github.com/apache/cloudstack/commit/f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6", "message": " #4378: fix mistake", "committedDate": "2021-03-16T14:04:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595754539", "bodyText": "@ustcweizhou whenever host / storage pool is not specified in the cmd, instead of directly picking a suitable dest host to migrate to, I think it is better to confirm it (from the user) through a API cmd param (something like chooseHost  / selectHost). If user is not OK to auto select host, then throw appropriate message.", "author": "sureshanaparti", "createdAt": "2021-03-17T06:56:47Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -169,9 +165,9 @@ public void execute() {\n \n         try {\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n+            if (getStoragePoolId() == null) {", "originalCommit": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgyNjMzMA==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595826330", "bodyText": "@sureshanaparti ok.\nwhat do you think if we regard hostid=-1 as autoselect ?", "author": "weizhouapache", "createdAt": "2021-03-17T09:01:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjY0NTY1NQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r596645655", "bodyText": "@weizhouapache host id in the cmd is UUID, so i think it is better to take input from another param when host id is null. If host id is not null, ignore auto selection.", "author": "sureshanaparti", "createdAt": "2021-03-18T08:33:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjY1ODczMA==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r596658730", "bodyText": "@sureshanaparti yes, I am currently working on the coding, same as you said.\nps: cloudstack supports projectid=-1, so it is feasible to support hostid=-1 but it might have big impact on other apis.", "author": "weizhouapache", "createdAt": "2021-03-18T08:52:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc1NDUzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595769435", "bodyText": "@weizhouapache change added in UserVmManagerImpl to find suitable host is only for migrateVirtualMachine method while we call migrateVirtualMachineWithVolume\nCurrently we will get NPE on \n  \n    \n      cloudstack/server/src/main/java/com/cloud/vm/UserVmManagerImpl.java\n    \n    \n         Line 6289\n      in\n      f5aed32\n    \n    \n    \n    \n\n        \n          \n           if (destinationHost.getId() == srcHostId) {", "author": "shwstppr", "createdAt": "2021-03-17T07:29:52Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -122,34 +122,34 @@ public String getEventDescription() {\n \n     @Override\n     public void execute() {\n-        if (getHostId() == null && getStorageId() == null) {\n-            throw new InvalidParameterValueException(\"Either hostId or storageId must be specified\");\n-        }\n-\n         if (getHostId() != null && getStorageId() != null) {\n             throw new InvalidParameterValueException(\"Only one of hostId and storageId can be specified\");\n         }\n+\n         try {\n             //FIXME : Should not be calling UserVmService to migrate all types of VMs - need a generic VM layer\n             VirtualMachine migratedVm = null;\n-            if (getHostId() != null) {\n-                Host destinationHost = _resourceService.getHost(getHostId());\n-                if (destinationHost == null) {\n-                    throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n-                }\n-                if (destinationHost.getType() != Host.Type.Routing) {\n-                    throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n-                }\n-                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n-                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());\n-            } else if (getStorageId() != null) {\n+            if (getStorageId() != null) {\n                 // OfflineMigration performed when this parameter is specified\n                 StoragePool destStoragePool = _storageService.getStoragePool(getStorageId());\n                 if (destStoragePool == null) {\n                     throw new InvalidParameterValueException(\"Unable to find the storage pool to migrate the VM\");\n                 }\n                 CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to storage pool Id: \" + getStorageId());\n                 migratedVm = _userVmService.vmStorageMigration(getVirtualMachineId(), destStoragePool);\n+            } else {\n+                Host destinationHost = null;\n+                if (getHostId() != null) {\n+                    destinationHost =_resourceService.getHost(getHostId());\n+                    if (destinationHost == null) {\n+                        throw new InvalidParameterValueException(\"Unable to find the host to migrate the VM, host id=\" + getHostId());\n+                    }\n+                    if (destinationHost.getType() != Host.Type.Routing) {\n+                        throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n+                    }\n+                }\n+                CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+                migratedVm = _userVmService.migrateVirtualMachineWithVolume(getVirtualMachineId(), destinationHost, new HashMap<String, String>());", "originalCommit": "f5aed32ebddef19b9b2f1bed724bf0b16c69f0b6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwODQ4Mw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595808483", "bodyText": "@shwstppr I will test it.", "author": "weizhouapache", "createdAt": "2021-03-17T08:36:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgwOTE1NA==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595809154", "bodyText": "@shwstppr I tested with 4.15. did not notice that we have some changes in master.\nhttps://github.com/apache/cloudstack/blob/4.15/api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java#L120", "author": "weizhouapache", "createdAt": "2021-03-17T08:37:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTgzMDkwOA==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595830908", "bodyText": "@shwstppr I have a question to you, since you are the author of #4385.\nwhy we use different method in vm migration and systemvm migration ?\nMigrateSystemVMCmd.java: migrateVirtualMachineWithVolume and vmStorageMigration\nMigrateVMCmd.java: migrateVirtualMachine and vmStorageMigration\ncan they use same methods ?", "author": "weizhouapache", "createdAt": "2021-03-17T09:07:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTg0MzAzMQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595843031", "bodyText": "@weizhouapache For user VMs we have two different APIs, migrateVirtualMachine and migrateVirtualMachineWithVolume. Depending on the need for storage migration requirement appropriate API can be used.\nWhile working on #4385 choice was to add a new API migrateSystemVmWithVolume or using migrateVirtualMachineWithVolume method while code making the decision if volume needs to be migrated.\nMigrateVMCmd can use the migrateVirtualMachineWithVolume method but it might need some additional checks and testing.", "author": "shwstppr", "createdAt": "2021-03-17T09:24:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkwNTY3NQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595905675", "bodyText": "@shwstppr we pass a empty hashmap in migrateVirtualMachineWithVolume , see below\nhttps://github.com/apache/cloudstack/blob/master/api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java#L144\nso systemvm migration actually works without volume ?\nI changed it back to 4.15, systemvm migration works\nhttps://github.com/apache/cloudstack/blob/4.15/api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java#L120", "author": "weizhouapache", "createdAt": "2021-03-17T10:49:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTkxMjI1Nw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595912257", "bodyText": "@weizhouapache yes, we do pass empty volume-pool mapping to the method but later in the code, we  generate volume-pool mapping when needed (such as inter-cluster migration with cluster-scoped pools)\nMoving back to 4.15 code will definitely allow systemvm migration with changes from this PR but inter-cluster migration of systemvms would not work.", "author": "shwstppr", "createdAt": "2021-03-17T10:59:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTk5MzQ0MQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r595993441", "bodyText": "@shwstppr I was a bit confused.\nI will change to the following behavior: if hostid is not specified, then use migratevirtualmachine instead of migratevirtualmachinewithvolume. sounds ok ?", "author": "weizhouapache", "createdAt": "2021-03-17T13:02:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NjYzMzAxOQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r596633019", "bodyText": "@weizhouapache Yes, works fine in that case. Tested,\n(localcloud) SBCM5> > migrate systemvm virtualmachineid=c3737243-93b2-4369-bf60-08ac217e3465\n{\n  \"systemvm\": {\n    \"agentstate\": \"Up\",\n    \"created\": \"2021-03-16T11:22:18+0000\",\n    \"dns1\": \"10.0.32.1\",\n    \"dns2\": \"8.8.8.8\",\n    \"gateway\": \"10.0.48.1\",\n    \"hostid\": \"2e5b053f-539e-45c7-80f3-0fe3f0291c05\",\n    \"hostname\": \"10.0.33.141\",\n    \"hypervisor\": \"VMware\",\n    \"id\": \"c3737243-93b2-4369-bf60-08ac217e3465\",\n    \"linklocalmacaddress\": \"02:00:5e:cd:00:01\",\n    \"name\": \"s-1-VM\",\n    \"podid\": \"57382744-92f2-4610-a873-733de71eb142\",\n    \"podname\": \"Pod1\",\n    \"privateip\": \"10.0.36.123\",\n    \"privatemacaddress\": \"1e:00:47:00:00:17\",\n    \"privatenetmask\": \"255.255.240.0\",\n    \"publicip\": \"10.0.52.121\",\n    \"publicmacaddress\": \"1e:00:70:00:00:01\",\n    \"publicnetmask\": \"255.255.240.0\",\n    \"state\": \"Running\",\n    \"systemvmtype\": \"secondarystoragevm\",\n    \"templateid\": \"ff29ad45-6b1d-4c8e-aa6e-74f41b483134\",\n    \"templatename\": \"SystemVM Template (vSphere)\",\n    \"version\": \"4.16.0.0-SNAPSHOT\",\n    \"zoneid\": \"8f79f870-abc3-4d46-bb0e-cdb695ca45cd\",\n    \"zonename\": \"pr4378-t146-vmware-67u3\"\n  }\n}", "author": "shwstppr", "createdAt": "2021-03-18T08:12:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NTc2OTQzNQ=="}], "type": "inlineReview"}, {"oid": "92b8f7370c599a2260a2055ca8fb13166bea6b52", "url": "https://github.com/apache/cloudstack/commit/92b8f7370c599a2260a2055ca8fb13166bea6b52", "message": " #4378: fix issue when migrate systemvm", "committedDate": "2021-03-17T13:43:36Z", "type": "commit"}, {"oid": "c1a1e2a08c9405e64f30a333f83e39795f4a7f21", "url": "https://github.com/apache/cloudstack/commit/c1a1e2a08c9405e64f30a333f83e39795f4a7f21", "message": " #4378 add autoselect to migrate api commands", "committedDate": "2021-03-22T15:17:42Z", "type": "commit"}, {"oid": "62a4886ea622773c8d7ef7d68b1cd6ab53152121", "url": "https://github.com/apache/cloudstack/commit/62a4886ea622773c8d7ef7d68b1cd6ab53152121", "message": "  #4378: more ui change", "committedDate": "2021-06-21T11:01:00Z", "type": "commit"}, {"oid": "a258544ca957d77077e0d3eb5caf54bb34d713d7", "url": "https://github.com/apache/cloudstack/commit/a258544ca957d77077e0d3eb5caf54bb34d713d7", "message": " #4378: add label label.migrate.auto.select", "committedDate": "2021-06-21T12:06:28Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODU0NzMwNA==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658547304", "bodyText": "@weizhouapache just to check, auto select here picks the suitable host for VM migration. In the similar way, any possibility to pick suitable storage ? If so, can this API have both parameters: autoselecthost & autoselectstorage (only one of them should be true).", "author": "sureshanaparti", "createdAt": "2021-06-25T07:49:30Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -155,6 +161,8 @@ public void execute() {\n                 throw new InvalidParameterValueException(\"The specified host(\" + destinationHost.getName() + \") is not suitable to migrate the VM, please specify another one\");\n             }\n             CallContext.current().setEventDetails(\"VM Id: \" + getVirtualMachineId() + \" to host Id: \" + getHostId());\n+        } else if (! isAutoSelect()) {\n+            throw new InvalidParameterValueException(\"Please specify a host or storage as destination, or pass 'autoselect=true' to automatically select a destination host which do not require storage migration\");", "originalCommit": "a258544ca957d77077e0d3eb5caf54bb34d713d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODYxOTE4NQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658619185", "bodyText": "@sureshanaparti\nthis pr works only if storage migraiotn is not required.\nit can be improved in a new pr.", "author": "weizhouapache", "createdAt": "2021-06-25T09:15:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODU0NzMwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzM4Mw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658697383", "bodyText": "can you factor this out to a separate method, please", "author": "DaanHoogland", "createdAt": "2021-06-25T11:36:04Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }", "originalCommit": "a258544ca957d77077e0d3eb5caf54bb34d713d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODc1NjY2OQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658756669", "bodyText": "@DaanHoogland done.", "author": "weizhouapache", "createdAt": "2021-06-25T13:18:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzM4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658697689", "bodyText": "and this, please?", "author": "DaanHoogland", "createdAt": "2021-06-25T11:36:38Z", "path": "server/src/main/java/com/cloud/vm/UserVmManagerImpl.java", "diffHunk": "@@ -5895,8 +5897,46 @@ public VirtualMachine migrateVirtualMachine(Long vmId, Host destinationHost) thr\n             throw new InvalidParameterValueException(\"Cannot migrate VM, host with id: \" + srcHostId + \" for VM not found\");\n         }\n \n+        DeployDestination dest = null;\n+        if (destinationHost == null) {\n+            vm.setLastHostId(null); // Last host does not have higher priority in vm migration\n+            final ServiceOfferingVO offering = _offeringDao.findById(vm.getId(), vm.getServiceOfferingId());\n+            final VirtualMachineProfile profile = new VirtualMachineProfileImpl(vm, null, offering, null, null);\n+            final Host host = _hostDao.findById(srcHostId);\n+            final DataCenterDeployment plan = new DataCenterDeployment(host.getDataCenterId(), host.getPodId(), host.getClusterId(), null, null, null);\n+            ExcludeList excludes = new ExcludeList();\n+            excludes.addHost(srcHostId);\n+            try {\n+                dest = _planningMgr.planDeployment(profile, plan, excludes, null);\n+            } catch (final AffinityConflictException e2) {\n+                s_logger.warn(\"Unable to create deployment, affinity rules associted to the VM conflict\", e2);\n+                throw new CloudRuntimeException(\"Unable to create deployment, affinity rules associted to the VM conflict\");\n+            } catch (final InsufficientServerCapacityException e3) {\n+                throw new CloudRuntimeException(\"Unable to find a server to migrate the vm to\");\n+            }\n+        } else {\n+            dest = checkVmMigrationDestination(vm, srcHost, destinationHost);\n+        }\n \n-        if (destinationHost.getId() == srcHostId) {\n+        // If no suitable destination found then throw exception\n+        if (dest == null) {\n+            throw new CloudRuntimeException(\"Unable to find suitable destination to migrate VM \" + vm.getInstanceName());\n+        }\n+\n+        UserVmVO uservm = _vmDao.findById(vmId);\n+        if (uservm != null) {\n+            collectVmDiskStatistics(uservm);\n+            collectVmNetworkStatistics(uservm);\n+        }\n+        _itMgr.migrate(vm.getUuid(), srcHostId, dest);", "originalCommit": "a258544ca957d77077e0d3eb5caf54bb34d713d7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODc1NjkxMw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r658756913", "bodyText": "@DaanHoogland\nwhich lines do you mean ?", "author": "weizhouapache", "createdAt": "2021-06-25T13:18:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg2OTkwMw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r662869903", "bodyText": "sorry, this wasn't clear and also is far less interesting but you could\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                    _itMgr.migrate(vm.getUuid(), srcHostId, dest);\n          \n          \n            \n                private void collectStatisticsBeforeMigration(Long vmId)\n          \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                }\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                    _itMgr.migrate(vm.getUuid(), srcHostId, dest);\n          \n          \n            \n                private void collectStatisticsAndMigrate(Long vmId)\n          \n          \n            \n                {\n          \n          \n            \n                    UserVmVO uservm = _vmDao.findById(vmId);\n          \n          \n            \n                    if (uservm != null) {\n          \n          \n            \n                        collectVmDiskStatistics(uservm);\n          \n          \n            \n                        collectVmNetworkStatistics(uservm);\n          \n          \n            \n                    }\n          \n          \n            \n                    _itMgr.migrate(vm.getUuid(), srcHostId, dest);\n          \n          \n            \n                }", "author": "DaanHoogland", "createdAt": "2021-07-02T09:19:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2Mjg4OTA2Ng==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r662889066", "bodyText": "@DaanHoogland clear to me now.\nI will add a new method to collect vm network/disk statistics which will be used before stopping/migrating vm.", "author": "weizhouapache", "createdAt": "2021-07-02T09:49:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY2MjkyNDE1NQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r662924155", "bodyText": "Done. thanks for review and suggestions @DaanHoogland", "author": "weizhouapache", "createdAt": "2021-07-02T10:51:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY1ODY5NzY4OQ=="}], "type": "inlineReview"}, {"oid": "90b1ff5e01275bd8976f179075516aa6483c465e", "url": "https://github.com/apache/cloudstack/commit/90b1ff5e01275bd8976f179075516aa6483c465e", "message": " #4378: add method chooseVmMigrationDestination", "committedDate": "2021-06-25T13:16:29Z", "type": "commit"}, {"oid": "e7216e18a89dc0d81c8a0feedd503bc707c9b31e", "url": "https://github.com/apache/cloudstack/commit/e7216e18a89dc0d81c8a0feedd503bc707c9b31e", "message": " #4378: fix vm migration wih storageid on vmware", "committedDate": "2021-06-29T15:15:17Z", "type": "commit"}, {"oid": "6e54dc33d10595e083f0ae6fa7588e05281ddd5c", "url": "https://github.com/apache/cloudstack/commit/6e54dc33d10595e083f0ae6fa7588e05281ddd5c", "message": " #4378: add method to collect vm disk/network statistics", "committedDate": "2021-07-02T10:46:52Z", "type": "commit"}, {"oid": "06e3a8a56aeda6d8296db19bb205e815f5781f68", "url": "https://github.com/apache/cloudstack/commit/06e3a8a56aeda6d8296db19bb205e815f5781f68", "message": "Merge remote-tracking branch 'apache/main' into 4.15-migration-vm-optional-host", "committedDate": "2021-07-21T06:52:39Z", "type": "commit"}, {"oid": "0d8175c7ea3f8a661482dee48829f7469d771b6a", "url": "https://github.com/apache/cloudstack/commit/0d8175c7ea3f8a661482dee48829f7469d771b6a", "message": " #4378: set autoSelect to default 'true'", "committedDate": "2021-07-23T07:17:05Z", "type": "commit"}, {"oid": "107fd3ad85c30802d919eb6fdea6248387693353", "url": "https://github.com/apache/cloudstack/commit/107fd3ad85c30802d919eb6fdea6248387693353", "message": "Merge remote-tracking branch 'apache/main' into 4.15-migration-vm-optional-host", "committedDate": "2021-07-26T13:58:47Z", "type": "commit"}, {"oid": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251", "url": "https://github.com/apache/cloudstack/commit/73e1c2bdad9b6cfd233e6f202ba31755f14c1251", "message": "Merge remote-tracking branch 'apache/main' into 4.15-migration-vm-optional-host", "committedDate": "2021-07-27T06:35:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDA2Mg==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r677864062", "bodyText": "Minor suggestion: to use BooleanUtils.toBoolean(autoSelect) here", "author": "nvazquez", "createdAt": "2021-07-27T23:19:00Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/systemvm/MigrateSystemVMCmd.java", "diffHunk": "@@ -91,6 +97,10 @@ public Long getStorageId() {\n         return storageId;\n     }\n \n+    public Boolean isAutoSelect() {\n+        return autoSelect != null ? autoSelect : true;", "originalCommit": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3ODE4MjU0MQ==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r678182541", "bodyText": "@nvazquez done. thanks for suggestion.\nuse BooleanUtils.isNotFalse\nhttps://commons.apache.org/proper/commons-lang/javadocs/api-release/org/apache/commons/lang3/BooleanUtils.html#isNotFalse-java.lang.Boolean-", "author": "weizhouapache", "createdAt": "2021-07-28T10:38:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDA2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDY3Nzg2NDU4Mw==", "url": "https://github.com/apache/cloudstack/pull/4378#discussion_r677864583", "bodyText": "Same here", "author": "nvazquez", "createdAt": "2021-07-27T23:20:25Z", "path": "api/src/main/java/org/apache/cloudstack/api/command/admin/vm/MigrateVMCmd.java", "diffHunk": "@@ -93,6 +99,10 @@ public Long getStoragePoolId() {\n         return storageId;\n     }\n \n+    public Boolean isAutoSelect() {\n+        return autoSelect != null ? autoSelect : true;", "originalCommit": "73e1c2bdad9b6cfd233e6f202ba31755f14c1251", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "6530abeafdc9b0dc18268a488f24591d539f3c62", "url": "https://github.com/apache/cloudstack/commit/6530abeafdc9b0dc18268a488f24591d539f3c62", "message": " #4378: use BooleanUtils.isNotFalse", "committedDate": "2021-07-28T10:36:24Z", "type": "commit"}]}