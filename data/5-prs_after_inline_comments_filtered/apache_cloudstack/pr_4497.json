{"pr_number": 4497, "pr_title": "kvm: FIX cpucorespersocket is not working on KVM", "pr_createdAt": "2020-11-23T15:11:50Z", "pr_url": "https://github.com/apache/cloudstack/pull/4497", "timeline": [{"oid": "1c6c474608384333da41f03e0fb127f5cb0d83b5", "url": "https://github.com/apache/cloudstack/commit/1c6c474608384333da41f03e0fb127f5cb0d83b5", "message": "kvm: FIX cpucorespersocket is not working on KVM", "committedDate": "2020-11-23T15:10:45Z", "type": "commit"}, {"oid": "f2009802b1c58b979f0374479cde9806aa6f4db9", "url": "https://github.com/apache/cloudstack/commit/f2009802b1c58b979f0374479cde9806aa6f4db9", "message": "Add method setCpuTopology", "committedDate": "2020-11-23T15:25:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531009458", "bodyText": "when vcpus are 8, it is considered as 4 cores per socket here, instead 8 cores.", "author": "sureshanaparti", "createdAt": "2020-11-26T12:53:46Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {\n+        // multi cores per socket, for larger core configs\n+        int numCoresPerSocket = -1;\n+        if (details != null) {\n+            final String coresPerSocket = details.get(VmDetailConstants.CPU_CORE_PER_SOCKET);\n+            final int intCoresPerSocket = NumbersUtil.parseInt(coresPerSocket, numCoresPerSocket);\n+            if (intCoresPerSocket > 0 && vcpus % intCoresPerSocket == 0) {\n+                numCoresPerSocket = intCoresPerSocket;\n+            }\n+        }\n+        if (numCoresPerSocket <= 0) {\n+            if (vcpus % 6 == 0) {\n+                numCoresPerSocket = 6;\n+            } else if (vcpus % 4 == 0) {", "originalCommit": "f2009802b1c58b979f0374479cde9806aa6f4db9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAzNDIyMA==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531034220", "bodyText": "@sureshanaparti this is the current behavior.", "author": "weizhouapache", "createdAt": "2020-11-26T13:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTM4NzQ5Mw==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531387493", "bodyText": "@sureshanaparti this is the current behavior.\n\nagree, any plan to address here?", "author": "sureshanaparti", "createdAt": "2020-11-27T05:19:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTQzMTU0MQ==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r531431541", "bodyText": "@sureshanaparti you mean change the current behavior ? No. I am not going to change it\nIt worked since cloudstack 4.13 in commit 2f53295\nhttps://issues.apache.org/jira/browse/CLOUDSTACK-5521", "author": "weizhouapache", "createdAt": "2020-11-27T07:51:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA4OTYzMA==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r533089630", "bodyText": "@sureshanaparti you mean change the current behavior ? No. I am not going to change it\nIt worked since cloudstack 4.13 in commit 2f53295\nhttps://issues.apache.org/jira/browse/CLOUDSTACK-5521\n\nok @weizhouapache so no change in the behavior. thanks.", "author": "sureshanaparti", "createdAt": "2020-12-01T05:55:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTAwOTQ1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539064235", "bodyText": "@ustcweizhou possible to pass coresPerSocket here, instead complete VM details here ?", "author": "sureshanaparti", "createdAt": "2020-12-09T07:18:56Z", "path": "plugins/hypervisors/kvm/src/main/java/com/cloud/hypervisor/kvm/resource/LibvirtComputingResource.java", "diffHunk": "@@ -4230,4 +4223,26 @@ public boolean isSecureMode(String bootMode) {\n \n         return false;\n     }\n+\n+    private void setCpuTopology(CpuModeDef cmd, int vcpus, Map<String, String> details) {", "originalCommit": "f2009802b1c58b979f0374479cde9806aa6f4db9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3MzQ0OA==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539073448", "bodyText": "@sureshanaparti\nI was thinking about it. at the end I decided to pass vm details based on two reasons\n(1) setCpuTopology is a complete function now. if pass coresPerSocket , we need to get coresPerSocket out of the method.\n(2) it is better if add more cpu settings , for example the pr #4178", "author": "weizhouapache", "createdAt": "2020-12-09T07:38:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA3ODEzNg==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539078136", "bodyText": "@sureshanaparti\nI was thinking about it. at the end I decided to pass vm details based on two reasons\n(1) setCpuTopology is a complete function now. if pass coresPerSocket , we need to get coresPerSocket out of the method.\n(2) it is better if add more cpu settings , for example the pr #4178\n\nOk @weizhouapache so going forward, cpu hyperthreading detail mentioned in PR #4178 will be added to this method, right?", "author": "sureshanaparti", "createdAt": "2020-12-09T07:46:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIwMDQxNw==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539200417", "bodyText": "@sureshanaparti yes. but I need to discuss with @div8cn about some details. it will be an improvement in 4.16", "author": "weizhouapache", "createdAt": "2020-12-09T10:46:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIyNzIzNg==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539227236", "bodyText": "@sureshanaparti yes. but I need to discuss with @div8cn about some details. it will be an improvement in 4.16\n\nOK, Pls update details here. As this PR is targeted for 4.14.1.0, the proposed changes with cpu hyperthreading detail will be targeted for 4.16, Right?", "author": "sureshanaparti", "createdAt": "2020-12-09T11:27:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTIzNTg5Nw==", "url": "https://github.com/apache/cloudstack/pull/4497#discussion_r539235897", "bodyText": "@sureshanaparti yes, this is a bug which should be fixed in 4.14 and 4.15.\nthe other pr is an improvement. it will not impact this pr.", "author": "weizhouapache", "createdAt": "2020-12-09T11:40:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTA2NDIzNQ=="}], "type": "inlineReview"}]}