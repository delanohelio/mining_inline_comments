{"pr_number": 4144, "pr_title": "Fix Usage failed to get pid", "pr_createdAt": "2020-06-11T17:38:18Z", "pr_url": "https://github.com/apache/cloudstack/pull/4144", "timeline": [{"oid": "c3573cbc615ab445d60fb06a0f2d02569f97eafb", "url": "https://github.com/apache/cloudstack/commit/c3573cbc615ab445d60fb06a0f2d02569f97eafb", "message": "Update UsageManagerImpl.java\n\nWhen System.getProperty Failure to get the PID will cause the service to stay in the config phase. The startup cannot continue and there will be no log output\r\nUse managementfactory to get the PID and throw an exception when the PID cannot be obtained.", "committedDate": "2020-06-11T17:27:58Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0NTM4Ng==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r447245386", "bodyText": "Should we add a more meaningful message here so its more clear?", "author": "ravening", "createdAt": "2020-06-29T20:49:45Z", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,14 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        try {\n+            String processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            s_logger.error(\"Unable to get process pid \", e);\n+            throw new ConfigurationException(\"Unable to get process pid \" + e.toString());", "originalCommit": "c3573cbc615ab445d60fb06a0f2d02569f97eafb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI1OTgyNg==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r465259826", "bodyText": "I'm all for clarity @ravening . what do you suggest?", "author": "DaanHoogland", "createdAt": "2020-08-04T18:52:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzI0NTM4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTYzNjExMA==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r461636110", "bodyText": "twice the same message should be in a string constand\nrethrown should not abandon the stack trace for the original problem\n\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try {\n          \n          \n            \n                        String processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        s_logger.error(\"Unable to get process pid \", e);\n          \n          \n            \n                        throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n          \n          \n            \n                    }\n          \n          \n            \n                    String processName;\n          \n          \n            \n                    try {\n          \n          \n            \n                        processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        String msg = String.format(\"Unable to get process Id for %s!\", processName);\n          \n          \n            \n                        s_logger.error(msg);\n          \n          \n            \n                        throw new ConfigurationException(msg, e);\n          \n          \n            \n                    }\n          \n      \n    \n    \n  \n\nor\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    try {\n          \n          \n            \n                        String processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        s_logger.error(\"Unable to get process pid \", e);\n          \n          \n            \n                        throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n          \n          \n            \n                    }\n          \n          \n            \n                    String processName;\n          \n          \n            \n                    try {\n          \n          \n            \n                        processName = ManagementFactory.getRuntimeMXBean().getName();\n          \n          \n            \n                        _pid = Integer.parseInt(processName.split(\"@\")[0]);\n          \n          \n            \n                    } catch (Exception e) {\n          \n          \n            \n                        String msg = String.format(\"Unable to get process Id for %s!\", processName);\n          \n          \n            \n                        s_logger.debug(msg , e);\n          \n          \n            \n                        throw new ConfigurationException(msg, e);\n          \n          \n            \n                    }", "author": "DaanHoogland", "createdAt": "2020-07-28T14:41:23Z", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,14 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        try {\n+            String processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            s_logger.error(\"Unable to get process pid \", e);\n+            throw new ConfigurationException(\"Unable to get process pid \" + e.toString());\n+        }", "originalCommit": "c3573cbc615ab445d60fb06a0f2d02569f97eafb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eba35575a0ad2f1b8bbeea062e9dd058282741c5", "url": "https://github.com/apache/cloudstack/commit/eba35575a0ad2f1b8bbeea062e9dd058282741c5", "message": "Update usage/src/main/java/com/cloud/usage/UsageManagerImpl.java\n\nCo-authored-by: dahn <daan.hoogland@gmail.com>", "committedDate": "2020-07-28T14:43:41Z", "type": "commit"}, {"oid": "1383d18bc90d7941bc3a534021620764e6082675", "url": "https://github.com/apache/cloudstack/commit/1383d18bc90d7941bc3a534021620764e6082675", "message": "Update UsageManagerImpl.java", "committedDate": "2020-08-04T11:42:53Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ0MTAwNg==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r465441006", "bodyText": "@DaanHoogland @div8cn What do you think of using e.printStackTrace() to add the stack on the log/ConfigurationException?\nWith toString (or simply s_logger.debug(msg , e)) it logs only the exception name and the error message (if there is any message). On the other hand, printStackTrace() presents the whole stack trace of an exception, which is very helpful for debugging.", "author": "GabrielBrascher", "createdAt": "2020-08-05T02:50:53Z", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,16 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;\n+        try {\n+            processName = ManagementFactory.getRuntimeMXBean().getName();\n+            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+        } catch (Exception e) {\n+            String msg = String.format(\"Unable to get process Id for %s!\", processName);\n+            s_logger.debug(msg , e);\n+            throw new ConfigurationException(msg + \" \" + e.toString());", "originalCommit": "1383d18bc90d7941bc3a534021620764e6082675", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUyNDM1NQ==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r465524355", "bodyText": "logger.debug(msg, e) should log the entire stacktrace @GabrielBrascher . and it gives the user to filter or direct the output to a certain stream/file. e.printStacktrace() only logs to stdout (or stderr, i forgot). in short i think not too much of it. I agree toString does not seem the best, but we have alreadyt output the stacktrace by then. A change from toString() to getLocalizedMessage() maybe, @div8cn? Of course we can add the entire exception again i.e. throw new ConfigurationException(msg, e), that's fine as well.", "author": "DaanHoogland", "createdAt": "2020-08-05T07:20:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ0MTAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk1ODM4MQ==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r480958381", "bodyText": "@div8cn master is on java 11 now, can you use ProcessHandle.current().pid()? I did a quick test:\n> jshell \n|  Welcome to JShell -- Version 11.0.7\n|  For an introduction type: /help intro\n\njshell> ProcessHandle.current().pid()\n$1 ==> 20380", "author": "rhtyd", "createdAt": "2020-09-01T08:19:39Z", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +277,16 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;\n+        try {\n+            processName = ManagementFactory.getRuntimeMXBean().getName();", "originalCommit": "1383d18bc90d7941bc3a534021620764e6082675", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "469652aaccc55cc165bb50a5eaffef446183be70", "url": "https://github.com/apache/cloudstack/commit/469652aaccc55cc165bb50a5eaffef446183be70", "message": "Update UsageManagerImpl.java", "committedDate": "2020-09-02T00:33:06Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkwNDMyNg==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r481904326", "bodyText": "processName is always null .", "author": "weizhouapache", "createdAt": "2020-09-02T08:51:35Z", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -280,8 +278,7 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n \n         String processName = null;\n         try {\n-            processName = ManagementFactory.getRuntimeMXBean().getName();\n-            _pid = Integer.parseInt(processName.split(\"@\")[0]);\n+            _pid = (int) ProcessHandle.current().pid();\n         } catch (Exception e) {\n             String msg = String.format(\"Unable to get process Id for %s!\", processName);", "originalCommit": "469652aaccc55cc165bb50a5eaffef446183be70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkzNzQ5OA==", "url": "https://github.com/apache/cloudstack/pull/4144#discussion_r481937498", "bodyText": "processName is not used and can be removed @div8cn", "author": "rhtyd", "createdAt": "2020-09-02T09:36:50Z", "path": "usage/src/main/java/com/cloud/usage/UsageManagerImpl.java", "diffHunk": "@@ -275,7 +275,15 @@ public boolean configure(String name, Map<String, Object> params) throws Configu\n             s_logger.error(\"Unhandled exception configuring UsageManger\", e);\n             throw new ConfigurationException(\"Unhandled exception configuring UsageManager \" + e.toString());\n         }\n-        _pid = Integer.parseInt(System.getProperty(\"pid\"));\n+\n+        String processName = null;", "originalCommit": "469652aaccc55cc165bb50a5eaffef446183be70", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2b63caa5c7c75a1391281e08fa63e939657cfe4d", "url": "https://github.com/apache/cloudstack/commit/2b63caa5c7c75a1391281e08fa63e939657cfe4d", "message": "Update UsageManagerImpl.java", "committedDate": "2020-09-02T10:28:17Z", "type": "commit"}]}