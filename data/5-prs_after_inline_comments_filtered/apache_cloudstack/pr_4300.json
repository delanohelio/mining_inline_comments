{"pr_number": 4300, "pr_title": "engine: add support for VMware 7.0 dependency and hypervisor capability", "pr_createdAt": "2020-09-01T09:12:57Z", "pr_url": "https://github.com/apache/cloudstack/pull/4300", "timeline": [{"oid": "803f925da65f8dbc7b2823a60d37ba42fa173410", "url": "https://github.com/apache/cloudstack/commit/803f925da65f8dbc7b2823a60d37ba42fa173410", "message": "engine: add support for VMware 7.0 dependency and hypervisor capability\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-11-20T05:55:18Z", "type": "forcePushed"}, {"oid": "879763f61f345dfb709e3291f943646aff7433a7", "url": "https://github.com/apache/cloudstack/commit/879763f61f345dfb709e3291f943646aff7433a7", "message": "engine: add support for VMware 7.0 dependency and hypervisor capability\n\nSigned-off-by: Rohit Yadav <rohit.yadav@shapeblue.com>", "committedDate": "2020-12-28T14:52:41Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTk4NTI5NA==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r559985294", "bodyText": "remove the comment if not required here", "author": "sureshanaparti", "createdAt": "2021-01-19T08:16:22Z", "path": "services/console-proxy/server/src/main/java/com/cloud/consoleproxy/ConsoleProxy.java", "diffHunk": "@@ -537,10 +545,14 @@ public static ConsoleProxyNoVncClient getNoVncViewer(ConsoleProxyClientParam par\n             Session session) throws AuthenticationException {\n         boolean reportLoadChange = false;\n         String clientKey = param.getClientMapKey();\n+        String ticketAcquired = param.getTicketAcquired();\n+        if (StringUtils.isNotBlank(ticketAcquired)) {\n+            s_logger.info(\">>>>> NO VNC Viewer received ticket acquired: \" + param.getTicketAcquired());\n+        }\n         synchronized (connectionMap) {\n             ConsoleProxyClient viewer = connectionMap.get(clientKey);\n             if (viewer == null || viewer.getClass() != ConsoleProxyNoVncClient.class) {\n-                authenticationExternally(param);\n+                //authenticationExternally(param);", "originalCommit": "9c58e9d00e4d6494ad08dbda67fe1771f8277861", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTk4NzQ5NQ==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r559987495", "bodyText": "@nvazquez is this port customizable at vCenter / host (or) fixed ?", "author": "sureshanaparti", "createdAt": "2021-01-19T08:20:17Z", "path": "services/console-proxy/server/src/main/java/com/cloud/consoleproxy/ConsoleProxy.java", "diffHunk": "@@ -170,6 +171,13 @@ public static ConsoleProxyAuthenticationResult authenticateConsoleAccess(Console\n         authResult.setReauthentication(reauthentication);\n         authResult.setHost(param.getClientHostAddress());\n         authResult.setPort(param.getClientHostPort());\n+        if (StringUtils.isNotBlank(param.getTicketAcquired())) {\n+            s_logger.info(\"Host = \" + param.getClientHostAddress() + \", hypervhost = \" + param.getHypervHost() +\n+                    \" pass = \" + param.getPassword() + \" hostpass = \" + param.getClientHostPassword() +\n+                    \" asd = \" + param.getClientHostPort());\n+            s_logger.info(\"Connecting using ticket \" + param.getTicketAcquired() + \" port 443\");\n+            authResult.setPort(443);", "originalCommit": "9c58e9d00e4d6494ad08dbda67fe1771f8277861", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3878fbddbf4778dc7382b78ccd3178463f9cb4a1", "url": "https://github.com/apache/cloudstack/commit/3878fbddbf4778dc7382b78ccd3178463f9cb4a1", "message": "Send VMware 7 ticket acquired and connect noVNC server to websocket exposed", "committedDate": "2021-01-21T05:51:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2MTY3NTkyMA==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r561675920", "bodyText": "@nvazquez declare a constant for port 443 in some common class (may be ConsoleProxyManager), and use it across.", "author": "sureshanaparti", "createdAt": "2021-01-21T08:14:36Z", "path": "server/src/main/java/com/cloud/servlet/ConsoleProxyServlet.java", "diffHunk": "@@ -500,6 +526,20 @@ private String composeConsoleAccessUrl(String rootUrl, VirtualMachine vm, HostVO\n         return sb.toString();\n     }\n \n+    /**\n+     * Generates an extra parameter to be passed to noVNC server to connect to WebSocket exposed on Vmware hosts.\n+     * This method has been introduced as Vmware 7 has deprecated the previous VNC approach to connect to VMs console.\n+     * Please check: https://docs.vmware.com/en/VMware-vSphere/7.0/rn/vsphere-esxi-vcenter-server-70-release-notes.html\n+     */\n+    private String generateExtraNoVNCParameter(ConsoleProxyClientParam param) {\n+        String extraParam = null;\n+        if (StringUtils.isNotBlank(param.getTicketAcquired())) {\n+            extraParam = \"wss://\" + param.getClientHostAddress() + \":443/ticket/\" + param.getTicketAcquired();", "originalCommit": "3878fbddbf4778dc7382b78ccd3178463f9cb4a1", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "92ac8a3cf777d8d7d89dfb3a9fac2f82c0800340", "url": "https://github.com/apache/cloudstack/commit/92ac8a3cf777d8d7d89dfb3a9fac2f82c0800340", "message": "Send VMware 7 ticket acquired and connect noVNC server to websocket exposed", "committedDate": "2021-02-09T14:50:13Z", "type": "forcePushed"}, {"oid": "47662d0018b0cd2c72979fbc3ee8a8afacedf888", "url": "https://github.com/apache/cloudstack/commit/47662d0018b0cd2c72979fbc3ee8a8afacedf888", "message": "Fix CPVM issue on Vmware 7", "committedDate": "2021-02-11T07:39:01Z", "type": "forcePushed"}, {"oid": "7452f09080fb404efeb46de34a7c909f39311c35", "url": "https://github.com/apache/cloudstack/commit/7452f09080fb404efeb46de34a7c909f39311c35", "message": "Fix CPVM issue on Vmware 7", "committedDate": "2021-02-11T07:42:04Z", "type": "forcePushed"}, {"oid": "ed9ebe4188f4ff41eb4d23b01dde0fdad2ad9f98", "url": "https://github.com/apache/cloudstack/commit/ed9ebe4188f4ff41eb4d23b01dde0fdad2ad9f98", "message": "Fix CPVM issue on Vmware 7", "committedDate": "2021-02-11T07:45:48Z", "type": "forcePushed"}, {"oid": "a1d4de2c4c7d9b64ce1b8d4f87e63f1f9bf6e605", "url": "https://github.com/apache/cloudstack/commit/a1d4de2c4c7d9b64ce1b8d4f87e63f1f9bf6e605", "message": "Fix CPVM issue on Vmware 7", "committedDate": "2021-02-11T13:03:29Z", "type": "forcePushed"}, {"oid": "da97cc193aeffc921aa2453f42f5b3a6e84bd70d", "url": "https://github.com/apache/cloudstack/commit/da97cc193aeffc921aa2453f42f5b3a6e84bd70d", "message": "Fix CPVM issue on Vmware 7", "committedDate": "2021-02-13T05:17:47Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDIwOTMyOA==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r580209328", "bodyText": "Non websocket connections, will cause NPE for the below methods. Either add a comment here to use these methods for isVncOverWebSocketConnection() true, or explicitly add a check.", "author": "sureshanaparti", "createdAt": "2021-02-22T12:24:17Z", "path": "services/console-proxy/server/src/main/java/com/cloud/consoleproxy/vnc/NoVncClient.java", "diffHunk": "@@ -62,6 +69,27 @@ public void connectTo(String host, int port) throws UnknownHostException, IOExce\n         setStreams();\n     }\n \n+    public void connectToWebSocket(String websocketUrl, Session session) throws URISyntaxException {\n+        webSocketReverseProxy = new WebSocketReverseProxy(new URI(websocketUrl), session);\n+        webSocketReverseProxy.connect();\n+    }\n+\n+    public boolean isVncOverWebSocketConnection() {\n+        return webSocketReverseProxy != null;\n+    }\n+", "originalCommit": "431ba0327eb064c10ad7f8a0514b740cdd841f7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDIxMzc1Ng==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r580213756", "bodyText": "acquireVncTicketForVmwareVm() returns null, in case of any errors/exceptions, check for the same ?", "author": "sureshanaparti", "createdAt": "2021-02-22T12:31:38Z", "path": "server/src/main/java/com/cloud/servlet/ConsoleProxyServlet.java", "diffHunk": "@@ -417,6 +425,40 @@ private String composeThumbnailUrl(String rootUrl, VirtualMachine vm, HostVO hos\n         return sb.toString();\n     }\n \n+    /**\n+     * Sets the URL to establish a VNC over websocket connection\n+     */\n+    private void setWebsocketUrl(VirtualMachine vm, ConsoleProxyClientParam param) {\n+        String ticket = acquireVncTicketForVmwareVm(vm);", "originalCommit": "431ba0327eb064c10ad7f8a0514b740cdd841f7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDIxNTYwNQ==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r580215605", "bodyText": "cmd result (success / failed - with the reason) in the answer?", "author": "sureshanaparti", "createdAt": "2021-02-22T12:35:02Z", "path": "core/src/main/java/com/cloud/agent/api/GetVmVncTicketAnswer.java", "diffHunk": "@@ -0,0 +1,32 @@\n+//\n+// Licensed to the Apache Software Foundation (ASF) under one\n+// or more contributor license agreements.  See the NOTICE file\n+// distributed with this work for additional information\n+// regarding copyright ownership.  The ASF licenses this file\n+// to you under the Apache License, Version 2.0 (the\n+// \"License\"); you may not use this file except in compliance\n+// with the License.  You may obtain a copy of the License at\n+//\n+//   http://www.apache.org/licenses/LICENSE-2.0\n+//\n+// Unless required by applicable law or agreed to in writing,\n+// software distributed under the License is distributed on an\n+// \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+// KIND, either express or implied.  See the License for the\n+// specific language governing permissions and limitations\n+// under the License.\n+//\n+package com.cloud.agent.api;\n+\n+public class GetVmVncTicketAnswer extends Answer {\n+", "originalCommit": "431ba0327eb064c10ad7f8a0514b740cdd841f7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDIxNzI2NA==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r580217264", "bodyText": "better check for the answer result before continuing with the ticket, as the ticket can be null in case of error scenarios", "author": "sureshanaparti", "createdAt": "2021-02-22T12:37:32Z", "path": "server/src/main/java/com/cloud/servlet/ConsoleProxyServlet.java", "diffHunk": "@@ -417,6 +425,40 @@ private String composeThumbnailUrl(String rootUrl, VirtualMachine vm, HostVO hos\n         return sb.toString();\n     }\n \n+    /**\n+     * Sets the URL to establish a VNC over websocket connection\n+     */\n+    private void setWebsocketUrl(VirtualMachine vm, ConsoleProxyClientParam param) {\n+        String ticket = acquireVncTicketForVmwareVm(vm);\n+        String wsUrl = composeWebsocketUrlForVmwareVm(ticket, param);\n+        param.setWebsocketUrl(wsUrl);\n+    }\n+\n+    /**\n+     * Format expected: wss://<ESXi_HOST_IP>:443/ticket/<TICKET_ID>\n+     */\n+    private String composeWebsocketUrlForVmwareVm(String ticket, ConsoleProxyClientParam param) {\n+        param.setClientHostPort(443);\n+        return String.format(\"wss://%s:%s/ticket/%s\", param.getClientHostAddress(), param.getClientHostPort(), ticket);\n+    }\n+\n+    /**\n+     * Acquires a ticket to be used for console proxy as described in 'Removal of VNC Server from ESXi' on:\n+     * https://docs.vmware.com/en/VMware-vSphere/7.0/rn/vsphere-esxi-vcenter-server-70-release-notes.html\n+     */\n+    private String acquireVncTicketForVmwareVm(VirtualMachine vm) {\n+        try {\n+            s_logger.info(\"Acquiring VNC ticket for VM = \" + vm.getHostName());\n+            GetVmVncTicketCommand cmd = new GetVmVncTicketCommand(vm.getInstanceName());\n+            Answer answer = agentManager.send(vm.getHostId(), cmd);\n+            GetVmVncTicketAnswer ans = (GetVmVncTicketAnswer) answer;", "originalCommit": "431ba0327eb064c10ad7f8a0514b740cdd841f7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4MDIxOTI4NQ==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r580219285", "bodyText": "in case of failure, better send the error msg with result as fail in the answer, and process accordingly on the receiving side.", "author": "sureshanaparti", "createdAt": "2021-02-22T12:40:50Z", "path": "server/src/main/java/com/cloud/servlet/ConsoleProxyServlet.java", "diffHunk": "@@ -417,6 +425,40 @@ private String composeThumbnailUrl(String rootUrl, VirtualMachine vm, HostVO hos\n         return sb.toString();\n     }\n \n+    /**\n+     * Sets the URL to establish a VNC over websocket connection\n+     */\n+    private void setWebsocketUrl(VirtualMachine vm, ConsoleProxyClientParam param) {\n+        String ticket = acquireVncTicketForVmwareVm(vm);\n+        String wsUrl = composeWebsocketUrlForVmwareVm(ticket, param);\n+        param.setWebsocketUrl(wsUrl);\n+    }\n+\n+    /**\n+     * Format expected: wss://<ESXi_HOST_IP>:443/ticket/<TICKET_ID>\n+     */\n+    private String composeWebsocketUrlForVmwareVm(String ticket, ConsoleProxyClientParam param) {\n+        param.setClientHostPort(443);\n+        return String.format(\"wss://%s:%s/ticket/%s\", param.getClientHostAddress(), param.getClientHostPort(), ticket);\n+    }\n+\n+    /**\n+     * Acquires a ticket to be used for console proxy as described in 'Removal of VNC Server from ESXi' on:\n+     * https://docs.vmware.com/en/VMware-vSphere/7.0/rn/vsphere-esxi-vcenter-server-70-release-notes.html\n+     */\n+    private String acquireVncTicketForVmwareVm(VirtualMachine vm) {\n+        try {\n+            s_logger.info(\"Acquiring VNC ticket for VM = \" + vm.getHostName());\n+            GetVmVncTicketCommand cmd = new GetVmVncTicketCommand(vm.getInstanceName());\n+            Answer answer = agentManager.send(vm.getHostId(), cmd);\n+            GetVmVncTicketAnswer ans = (GetVmVncTicketAnswer) answer;\n+            return ans.getTicket();\n+        } catch (AgentUnavailableException | OperationTimedoutException e) {\n+            s_logger.error(\"Error acquiring ticket\", e);\n+            return null;", "originalCommit": "431ba0327eb064c10ad7f8a0514b740cdd841f7b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "633c42bafa325ce74a5f688503e312e58c2e6c25", "url": "https://github.com/apache/cloudstack/commit/633c42bafa325ce74a5f688503e312e58c2e6c25", "message": "Refactor", "committedDate": "2021-02-25T06:02:16Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTU1MDY3Nw==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r585550677", "bodyText": "could you disect initlient() into multiple methods, it is sneakily growing too complex.", "author": "DaanHoogland", "createdAt": "2021-03-02T13:10:14Z", "path": "services/console-proxy/server/src/main/java/com/cloud/consoleproxy/ConsoleProxyNoVncClient.java", "diffHunk": "@@ -121,22 +126,33 @@ public void run() {\n                         s_logger.error(\"Unexpected exception\", e);\n                     }\n \n-                    String ver = client.handshake();\n-                    session.getRemote().sendBytes(ByteBuffer.wrap(ver.getBytes(), 0, ver.length()));\n+                    String ver;\n+                    byte[] b;\n+                    if (!client.isVncOverWebSocketConnection()) {\n+                        ver = client.handshake();\n+                        session.getRemote().sendBytes(ByteBuffer.wrap(ver.getBytes(), 0, ver.length()));\n \n-                    byte[] b = client.authenticate(getClientHostPassword());\n-                    session.getRemote().sendBytes(ByteBuffer.wrap(b, 0, 4));\n+                        b = client.authenticate(getClientHostPassword());\n+                        session.getRemote().sendBytes(ByteBuffer.wrap(b, 0, 4));\n+                    }\n \n                     int readBytes;\n                     while (connectionAlive) {\n-                        b = new byte[100];\n-                        readBytes = client.read(b);\n-                        if (readBytes == -1) {\n-                            break;\n-                        }\n-                        if (readBytes > 0) {\n-                            session.getRemote().sendBytes(ByteBuffer.wrap(b, 0, readBytes));\n-                            updateFrontEndActivityTime();\n+                        if (client.isVncOverWebSocketConnection()) {\n+                            if (client.isVncOverWebSocketConnectionOpen()) {\n+                                updateFrontEndActivityTime();\n+                            }\n+                            connectionAlive = client.isVncOverWebSocketConnectionAlive();\n+                        } else {\n+                            b = new byte[100];\n+                            readBytes = client.read(b);\n+                            if (readBytes == -1) {\n+                                break;\n+                            }\n+                            if (readBytes > 0) {\n+                                session.getRemote().sendBytes(ByteBuffer.wrap(b, 0, readBytes));\n+                                updateFrontEndActivityTime();\n+                            }", "originalCommit": "633c42bafa325ce74a5f688503e312e58c2e6c25", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDg3NTIzMQ==", "url": "https://github.com/apache/cloudstack/pull/4300#discussion_r594875231", "bodyText": "Done, thanks", "author": "nvazquez", "createdAt": "2021-03-16T05:39:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU4NTU1MDY3Nw=="}], "type": "inlineReview"}, {"oid": "311f1dd89d9438fba926ec23eaea00abcff9f2cd", "url": "https://github.com/apache/cloudstack/commit/311f1dd89d9438fba926ec23eaea00abcff9f2cd", "message": "Refactor", "committedDate": "2021-03-10T17:28:32Z", "type": "forcePushed"}, {"oid": "63e71e3654d19ab47858a221d79fbaa71a9b344e", "url": "https://github.com/apache/cloudstack/commit/63e71e3654d19ab47858a221d79fbaa71a9b344e", "message": "Refactor", "committedDate": "2021-03-10T17:41:39Z", "type": "forcePushed"}, {"oid": "c8fa81ee2acd4aa8d33c584f030f45e6ab95e24a", "url": "https://github.com/apache/cloudstack/commit/c8fa81ee2acd4aa8d33c584f030f45e6ab95e24a", "message": "Refactor initClient on noVNC client", "committedDate": "2021-04-07T13:44:17Z", "type": "forcePushed"}, {"oid": "7d5c4f5585af585c3d7efa42b274f7b02384b094", "url": "https://github.com/apache/cloudstack/commit/7d5c4f5585af585c3d7efa42b274f7b02384b094", "message": "VMware 7 support", "committedDate": "2021-04-09T15:01:15Z", "type": "forcePushed"}, {"oid": "f89e60d4d9d1cac186d612189087732501d24768", "url": "https://github.com/apache/cloudstack/commit/f89e60d4d9d1cac186d612189087732501d24768", "message": "VMware 7 support", "committedDate": "2021-04-14T12:50:32Z", "type": "commit"}, {"oid": "f89e60d4d9d1cac186d612189087732501d24768", "url": "https://github.com/apache/cloudstack/commit/f89e60d4d9d1cac186d612189087732501d24768", "message": "VMware 7 support", "committedDate": "2021-04-14T12:50:32Z", "type": "forcePushed"}]}