{"pr_number": 9100, "pr_title": "Add AlterISR RPC and use it for ISR modifications", "pr_createdAt": "2020-07-29T21:05:27Z", "pr_url": "https://github.com/apache/kafka/pull/9100", "timeline": [{"oid": "37f7c63a47da0e5524b43e521ff4d37864073ad2", "url": "https://github.com/apache/kafka/commit/37f7c63a47da0e5524b43e521ff4d37864073ad2", "message": "Checking in RPCs and stubbing out basic functionality", "committedDate": "2020-07-29T21:04:11Z", "type": "commit"}, {"oid": "19dd93af3b7b08c5b9e5a32231c462738ef42e54", "url": "https://github.com/apache/kafka/commit/19dd93af3b7b08c5b9e5a32231c462738ef42e54", "message": "Update the ISR from the controller", "committedDate": "2020-07-30T00:44:57Z", "type": "commit"}, {"oid": "5482529f542554e7468965d6a6147b6cfc0cde2a", "url": "https://github.com/apache/kafka/commit/5482529f542554e7468965d6a6147b6cfc0cde2a", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-07-30T13:47:27Z", "type": "commit"}, {"oid": "6fb2551366c4c3baf89956357a838cea5bb43e4a", "url": "https://github.com/apache/kafka/commit/6fb2551366c4c3baf89956357a838cea5bb43e4a", "message": "Start working on broker-side of AlterIsr", "committedDate": "2020-07-31T18:23:49Z", "type": "commit"}, {"oid": "5955b1d7bab29729b3daed23dfbc7c132c4baba3", "url": "https://github.com/apache/kafka/commit/5955b1d7bab29729b3daed23dfbc7c132c4baba3", "message": "Add throttle time to AlterIsr, fix error counts", "committedDate": "2020-08-05T13:45:59Z", "type": "commit"}, {"oid": "afeb18ede91081e9ea72a3f34a4e56e21f81e1cf", "url": "https://github.com/apache/kafka/commit/afeb18ede91081e9ea72a3f34a4e56e21f81e1cf", "message": "Broker to controller AlterIsr fixes\n\n* Make AlterIsr block until Controller process it fully\n* Batch AlterIsr requests for a short while on broker side\n* Don't attempt to restrict to a single in-flight request", "committedDate": "2020-08-05T13:47:14Z", "type": "commit"}, {"oid": "627b26aef3c623c13066a5f7e617318a49cc0a5b", "url": "https://github.com/apache/kafka/commit/627b26aef3c623c13066a5f7e617318a49cc0a5b", "message": "Add \"effective\" ISR to Partition", "committedDate": "2020-08-05T13:52:04Z", "type": "commit"}, {"oid": "fe99911f5d06d76b18a9446bf94b4e0ca7ce6b1b", "url": "https://github.com/apache/kafka/commit/fe99911f5d06d76b18a9446bf94b4e0ca7ce6b1b", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-08-07T20:31:40Z", "type": "commit"}, {"oid": "07716ceb16a4d15e66bda92dac378fd8f8fae0c9", "url": "https://github.com/apache/kafka/commit/07716ceb16a4d15e66bda92dac378fd8f8fae0c9", "message": "PartitionTest and ReplicaManagerTest passing", "committedDate": "2020-08-12T15:34:39Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM3MjM0NA==", "url": "https://github.com/apache/kafka/pull/9100#discussion_r469372344", "bodyText": "With KIP-500, I imagine we could end up with other cases where we end up using optimistic concurrency control. Does it make sense to make this error a little more generic? Maybe INVALID_UPDATE_VERSION or something like that..", "author": "hachikuji", "createdAt": "2020-08-12T16:03:52Z", "path": "clients/src/main/java/org/apache/kafka/common/errors/InvalidIsrVersionException.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.common.errors;\n+\n+public class InvalidIsrVersionException extends ApiException {", "originalCommit": "fe99911f5d06d76b18a9446bf94b4e0ca7ce6b1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTM3MzMzOQ==", "url": "https://github.com/apache/kafka/pull/9100#discussion_r469373339", "bodyText": "nit: maybe drop the parameters if they do not need to be documented", "author": "hachikuji", "createdAt": "2020-08-12T16:05:24Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/AlterIsrRequest.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.kafka.common.requests;\n+\n+import org.apache.kafka.common.message.AlterIsrRequestData;\n+import org.apache.kafka.common.message.AlterIsrResponseData;\n+import org.apache.kafka.common.protocol.ApiKeys;\n+import org.apache.kafka.common.protocol.Errors;\n+import org.apache.kafka.common.protocol.types.Struct;\n+\n+public class AlterIsrRequest extends AbstractRequest {\n+\n+    private final AlterIsrRequestData data;\n+\n+    public AlterIsrRequest(AlterIsrRequestData data, short apiVersion) {\n+        super(ApiKeys.ALTER_ISR, apiVersion);\n+        this.data = data;\n+    }\n+\n+    public AlterIsrRequestData data() {\n+        return data;\n+    }\n+\n+    @Override\n+    protected Struct toStruct() {\n+        return data.toStruct(version());\n+    }\n+\n+    /**\n+     * Get an error response for a request with specified throttle time in the response if applicable\n+     *\n+     * @param throttleTimeMs", "originalCommit": "fe99911f5d06d76b18a9446bf94b4e0ca7ce6b1b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "10b7d638e868bf44317ffeb05dcf4496859efb8a", "url": "https://github.com/apache/kafka/commit/10b7d638e868bf44317ffeb05dcf4496859efb8a", "message": "PR feedback and progress on unit tests", "committedDate": "2020-08-13T21:04:30Z", "type": "commit"}, {"oid": "da33368773462fb0a53c448bfd45e449832a0ef1", "url": "https://github.com/apache/kafka/commit/da33368773462fb0a53c448bfd45e449832a0ef1", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-08-14T14:55:38Z", "type": "commit"}, {"oid": "1d98ada3e2e6623bfc49d304113550ec7df22222", "url": "https://github.com/apache/kafka/commit/1d98ada3e2e6623bfc49d304113550ec7df22222", "message": "PR feedback, minor nits mostly", "committedDate": "2020-08-17T17:04:35Z", "type": "commit"}, {"oid": "b7577f1795b0f737eacce874159c6178e544000b", "url": "https://github.com/apache/kafka/commit/b7577f1795b0f737eacce874159c6178e544000b", "message": "Gate AlterIsr on IBP", "committedDate": "2020-08-17T19:31:48Z", "type": "commit"}, {"oid": "9c7afa1d2e3d5940c1a37d09329dbe8241acc225", "url": "https://github.com/apache/kafka/commit/9c7afa1d2e3d5940c1a37d09329dbe8241acc225", "message": "Add back ReplicaManager's ISR propagation thread", "committedDate": "2020-08-18T14:00:32Z", "type": "commit"}, {"oid": "4cc58a30599e54003c571b6a689faa055009ee6c", "url": "https://github.com/apache/kafka/commit/4cc58a30599e54003c571b6a689faa055009ee6c", "message": "WIP tests", "committedDate": "2020-08-18T18:02:01Z", "type": "commit"}, {"oid": "f557a86acdb5e854a1298464ffd293ad851246c7", "url": "https://github.com/apache/kafka/commit/f557a86acdb5e854a1298464ffd293ad851246c7", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-08-18T18:02:37Z", "type": "commit"}, {"oid": "8c9183b9425f72c7834015cf91e9a887358d2210", "url": "https://github.com/apache/kafka/commit/8c9183b9425f72c7834015cf91e9a887358d2210", "message": "Back something out", "committedDate": "2020-08-18T18:22:39Z", "type": "commit"}, {"oid": "1e20e9ccc2fb094f307002e46c69e610809d6607", "url": "https://github.com/apache/kafka/commit/1e20e9ccc2fb094f307002e46c69e610809d6607", "message": "Tests WIP", "committedDate": "2020-08-18T19:49:10Z", "type": "commit"}, {"oid": "93ac6301e8443ffd057adde2d56337b33ce7bd3d", "url": "https://github.com/apache/kafka/commit/93ac6301e8443ffd057adde2d56337b33ce7bd3d", "message": "Add some debug logging for test", "committedDate": "2020-08-19T15:52:29Z", "type": "commit"}, {"oid": "ccda5352339208b01efa00eda63069c3b8b2d38d", "url": "https://github.com/apache/kafka/commit/ccda5352339208b01efa00eda63069c3b8b2d38d", "message": "Make sure to always send LeaderAndIsr after AlterIsr", "committedDate": "2020-08-19T17:00:22Z", "type": "commit"}, {"oid": "19d8e362edce6159faa273823840c1cb4cb56164", "url": "https://github.com/apache/kafka/commit/19d8e362edce6159faa273823840c1cb4cb56164", "message": "More logging for tests", "committedDate": "2020-08-20T13:01:50Z", "type": "commit"}, {"oid": "2bcf8b4b68cf3e59d86743e8927b867bd11970a7", "url": "https://github.com/apache/kafka/commit/2bcf8b4b68cf3e59d86743e8927b867bd11970a7", "message": "Clear the pending ISR state for certain errors", "committedDate": "2020-08-20T15:06:56Z", "type": "commit"}, {"oid": "5be92d0f38be1a6a969e6e483bf8614d3488955a", "url": "https://github.com/apache/kafka/commit/5be92d0f38be1a6a969e6e483bf8614d3488955a", "message": "Let Partition handle LeaderAndIsr even if epoch is unchanged", "committedDate": "2020-08-20T18:10:08Z", "type": "commit"}, {"oid": "868a779bc31edebac5803ba48ed4cebde9f5403f", "url": "https://github.com/apache/kafka/commit/868a779bc31edebac5803ba48ed4cebde9f5403f", "message": "Better logging for ISR updates, allow leader to retry in some cases", "committedDate": "2020-08-21T15:43:48Z", "type": "commit"}, {"oid": "69441c0ff1484c24b1135a51e8236cbeee05c78b", "url": "https://github.com/apache/kafka/commit/69441c0ff1484c24b1135a51e8236cbeee05c78b", "message": "Clear pending ISR state after unknown controller error", "committedDate": "2020-08-21T18:31:03Z", "type": "commit"}, {"oid": "d6ba8c25dc68d4f4888a74aab3ffb92683b89203", "url": "https://github.com/apache/kafka/commit/d6ba8c25dc68d4f4888a74aab3ffb92683b89203", "message": "Feedback from PR", "committedDate": "2020-08-21T20:53:40Z", "type": "commit"}, {"oid": "c886e8c5137b6a90099625e75268b8e4bcf30ee4", "url": "https://github.com/apache/kafka/commit/c886e8c5137b6a90099625e75268b8e4bcf30ee4", "message": "Cover more error cases, some cleanup", "committedDate": "2020-08-21T20:58:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYyNTExMQ==", "url": "https://github.com/apache/kafka/pull/9100#discussion_r475625111", "bodyText": "This error message should be less specific", "author": "mumrah", "createdAt": "2020-08-24T13:53:27Z", "path": "clients/src/main/java/org/apache/kafka/common/protocol/Errors.java", "diffHunk": "@@ -325,7 +326,8 @@\n     UNSTABLE_OFFSET_COMMIT(88, \"There are unstable offsets that need to be cleared.\", UnstableOffsetCommitException::new),\n     THROTTLING_QUOTA_EXCEEDED(89, \"The throttling quota has been exceeded.\", ThrottlingQuotaExceededException::new),\n     PRODUCER_FENCED(90, \"There is a newer producer with the same transactionalId \" +\n-            \"which fences the current one.\", ProducerFencedException::new);\n+            \"which fences the current one.\", ProducerFencedException::new),\n+    INVALID_UPDATE_VERSION(91, \"The given ISR version was out-of-date.\", InvalidUpdateVersionException::new);", "originalCommit": "c886e8c5137b6a90099625e75268b8e4bcf30ee4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1691951e335ff8e1ab6558b50c6607218cfe08a7", "url": "https://github.com/apache/kafka/commit/1691951e335ff8e1ab6558b50c6607218cfe08a7", "message": "Revert \"Back something out\"\n\nThis reverts commit 8c9183b9425f72c7834015cf91e9a887358d2210.", "committedDate": "2020-08-24T14:01:35Z", "type": "commit"}, {"oid": "6b264a48779750c9ae05bb15b517260245e4b44b", "url": "https://github.com/apache/kafka/commit/6b264a48779750c9ae05bb15b517260245e4b44b", "message": "Cleanup", "committedDate": "2020-08-24T14:16:33Z", "type": "commit"}, {"oid": "f791645f8d5655c6b7775d79296d3c6bbea5e17a", "url": "https://github.com/apache/kafka/commit/f791645f8d5655c6b7775d79296d3c6bbea5e17a", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-09-09T15:56:01Z", "type": "commit"}, {"oid": "a3ab36cdab2db97cc14934bb6f32029e4296c43e", "url": "https://github.com/apache/kafka/commit/a3ab36cdab2db97cc14934bb6f32029e4296c43e", "message": "Lots of updates from Jason's review\n\n* Get broker epoch from KafkaController instead of ZK\n* Add additional fields to AlterIsr response\n* Update ISR in Partition from AlterIsr response\n* Controller no longer sends LeaderAndIsr, now sends UpdateMetadata", "committedDate": "2020-09-10T15:06:03Z", "type": "commit"}, {"oid": "aa15fd0269b25c0cb44f3c4ab008d0dcd5a6e194", "url": "https://github.com/apache/kafka/commit/aa15fd0269b25c0cb44f3c4ab008d0dcd5a6e194", "message": "Fix some Scala 2.12 problems", "committedDate": "2020-09-10T17:16:06Z", "type": "commit"}, {"oid": "7ef9a0de7b806852f560e1a43cf1ddc05ef2e3d6", "url": "https://github.com/apache/kafka/commit/7ef9a0de7b806852f560e1a43cf1ddc05ef2e3d6", "message": "More PR feedback, mostly style stuff", "committedDate": "2020-09-10T18:35:37Z", "type": "commit"}, {"oid": "4e5685ce50174e1d06c166465ff24b8084ee8388", "url": "https://github.com/apache/kafka/commit/4e5685ce50174e1d06c166465ff24b8084ee8388", "message": "Make sure we set throttle time on the response\n\nAlso fix some short circuit bugs in controller", "committedDate": "2020-09-11T15:46:57Z", "type": "commit"}, {"oid": "02e7378e240fa5727c92a35cac2b1153a3d03c27", "url": "https://github.com/apache/kafka/commit/02e7378e240fa5727c92a35cac2b1153a3d03c27", "message": "Use a queue instead of map inside AlterIsrManager", "committedDate": "2020-09-12T00:16:24Z", "type": "commit"}, {"oid": "31f91260c6fd052c8e26ddb2af1358f362a76646", "url": "https://github.com/apache/kafka/commit/31f91260c6fd052c8e26ddb2af1358f362a76646", "message": "Trying something different in AlterIsrManager", "committedDate": "2020-09-15T01:07:02Z", "type": "commit"}, {"oid": "d00c0666b7b08365afd088a5e3f2b4a0ff5fc8e2", "url": "https://github.com/apache/kafka/commit/d00c0666b7b08365afd088a5e3f2b4a0ff5fc8e2", "message": "Cleanup and adding more unit tests", "committedDate": "2020-09-15T14:55:33Z", "type": "commit"}, {"oid": "ff4f5b2efb92ebceaeeb53f8541cfe3cc01bce48", "url": "https://github.com/apache/kafka/commit/ff4f5b2efb92ebceaeeb53f8541cfe3cc01bce48", "message": "Fix unit tests", "committedDate": "2020-09-15T17:22:59Z", "type": "commit"}, {"oid": "392472e076454d3e250781fb528b31f6b1641ce6", "url": "https://github.com/apache/kafka/commit/392472e076454d3e250781fb528b31f6b1641ce6", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-09-15T17:24:24Z", "type": "commit"}, {"oid": "41053499d2cbcdcae21ff4bc70b1d46705394a32", "url": "https://github.com/apache/kafka/commit/41053499d2cbcdcae21ff4bc70b1d46705394a32", "message": "fixup after merge", "committedDate": "2020-09-15T17:29:36Z", "type": "commit"}, {"oid": "834718ecf326c367cb97d4f1299901c3d9813c7e", "url": "https://github.com/apache/kafka/commit/834718ecf326c367cb97d4f1299901c3d9813c7e", "message": "Partially revert startup ordering", "committedDate": "2020-09-16T19:21:54Z", "type": "commit"}, {"oid": "47878b092cd425376c6cbe7b9036667e0b91f45d", "url": "https://github.com/apache/kafka/commit/47878b092cd425376c6cbe7b9036667e0b91f45d", "message": "More PR feedback\n\n* Lots of cleanup, logging improvements\n* Changes to AlterIsr RPC field names\n* Consolidate on maximal ISR name\n* Introduce sealed trait for different ISR states\n* Tweaks to some error handling", "committedDate": "2020-09-17T13:07:57Z", "type": "commit"}, {"oid": "7a93d06f42f0ccbfbeb22c2db965cda59762789b", "url": "https://github.com/apache/kafka/commit/7a93d06f42f0ccbfbeb22c2db965cda59762789b", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-09-17T13:18:30Z", "type": "commit"}, {"oid": "1dde0e47d59d27e25a50bfd21264c0ec07d9115e", "url": "https://github.com/apache/kafka/commit/1dde0e47d59d27e25a50bfd21264c0ec07d9115e", "message": "More PR feedback\n\n* Cleaned up expand/shrink ISR methods\n* Style stuff\n* Logging stuff", "committedDate": "2020-09-17T23:04:11Z", "type": "commit"}, {"oid": "8c694d185df0f4e4d4e2eb7cddec4033f6428561", "url": "https://github.com/apache/kafka/commit/8c694d185df0f4e4d4e2eb7cddec4033f6428561", "message": "Two small test things", "committedDate": "2020-09-17T23:10:55Z", "type": "commit"}, {"oid": "1647c7115b83674ab1a20d21bacda43068f135ed", "url": "https://github.com/apache/kafka/commit/1647c7115b83674ab1a20d21bacda43068f135ed", "message": "Merge remote-tracking branch 'apache-github/trunk' into KAFKA-8836-alter-isr", "committedDate": "2020-09-23T16:54:08Z", "type": "commit"}, {"oid": "ac3eec11505bace6c3302ad982d6418d30f26313", "url": "https://github.com/apache/kafka/commit/ac3eec11505bace6c3302ad982d6418d30f26313", "message": "Next round of PR feedback\n\n* Make AlterIsr idempotent in the controller\n* Tweak some error handling\n* Add a few tests\n* Style feedback", "committedDate": "2020-09-24T19:13:34Z", "type": "commit"}]}