{"pr_number": 9668, "pr_title": "MINOR: add test for repartition/source-topic/changelog optimization", "pr_createdAt": "2020-12-01T19:38:51Z", "pr_url": "https://github.com/apache/kafka/pull/9668", "timeline": [{"oid": "b86e907630ce332e5577f20545cc06de8f4f43bf", "url": "https://github.com/apache/kafka/commit/b86e907630ce332e5577f20545cc06de8f4f43bf", "message": "MINOR: add test for repartition/source-topic/changelog optimization\n\nIf topology optimization is enabled, KafkaStreams does not create store\nchangelog topics but re-uses source input topics if possible. However,\nthis optimization should not be applied to internal repartition topics,\nbecause those are actively purged.", "committedDate": "2020-12-01T19:35:50Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNDY1Ng==", "url": "https://github.com/apache/kafka/pull/9668#discussion_r535724656", "bodyText": "This should still be called shouldNotReuseSourceTopicAsChangelogsByDefault,  right?", "author": "ableegoldman", "createdAt": "2020-12-03T23:34:43Z", "path": "streams/src/test/java/org/apache/kafka/streams/StreamsBuilderTest.java", "diffHunk": "@@ -463,7 +463,36 @@ public void shouldReuseSourceTopicAsChangelogsWithOptimization20() {\n     }\n \n     @Test\n-    public void shouldNotReuseSourceTopicAsChangelogsByDefault() {\n+    public void shouldNotReuseRepartitionTopicAsChangelogs() {\n+        final String topic = \"topic\";\n+        builder.<Long, String>stream(topic).repartition().toTable(Materialized.as(\"store\"));\n+        final Properties props = StreamsTestUtils.getStreamsConfig(\"appId\");\n+        props.put(StreamsConfig.TOPOLOGY_OPTIMIZATION_CONFIG, StreamsConfig.OPTIMIZE);\n+        final Topology topology = builder.build(props);\n+\n+        final InternalTopologyBuilder internalTopologyBuilder = TopologyWrapper.getInternalTopologyBuilder(topology);\n+        internalTopologyBuilder.rewriteTopology(new StreamsConfig(props));\n+\n+        assertThat(\n+            internalTopologyBuilder.buildTopology().storeToChangelogTopic(),\n+            equalTo(Collections.singletonMap(\"store\", \"appId-store-changelog\"))\n+        );\n+        assertThat(\n+            internalTopologyBuilder.stateStores().keySet(),\n+            equalTo(Collections.singleton(\"store\"))\n+        );\n+        assertThat(\n+            internalTopologyBuilder.stateStores().get(\"store\").loggingEnabled(),\n+            equalTo(true)\n+        );\n+        assertThat(\n+            internalTopologyBuilder.topicGroups().get(1).stateChangelogTopics.keySet(),\n+            equalTo(Collections.singleton(\"appId-store-changelog\"))\n+        );\n+    }\n+\n+    @Test\n+    public void shouldNotReuseRepartitionTopicAsChangelogsByDefault() {", "originalCommit": "b86e907630ce332e5577f20545cc06de8f4f43bf", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjI1NjQ5NA==", "url": "https://github.com/apache/kafka/pull/9668#discussion_r536256494", "bodyText": "Ah. Yes, the test name should not change.", "author": "mjsax", "createdAt": "2020-12-04T17:24:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNDY1Ng=="}], "type": "inlineReview"}, {"oid": "f296213879b0f532b8a405fc1877032df9c98cf7", "url": "https://github.com/apache/kafka/commit/f296213879b0f532b8a405fc1877032df9c98cf7", "message": "Github comments: update test name", "committedDate": "2020-12-04T17:23:49Z", "type": "commit"}]}