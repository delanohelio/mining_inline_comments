{"pr_number": 9255, "pr_title": "KAFKA-6585: Consolidate duplicated logic on reset tools", "pr_createdAt": "2020-09-05T19:48:24Z", "pr_url": "https://github.com/apache/kafka/pull/9255", "timeline": [{"oid": "69035ee66ab49ddb7fb10a77d9f41d47141e308e", "url": "https://github.com/apache/kafka/commit/69035ee66ab49ddb7fb10a77d9f41d47141e308e", "message": "Consolidate duplicated logic on reset tools", "committedDate": "2020-09-02T09:26:09Z", "type": "commit"}, {"oid": "4e9331c2681156ce81b982a60ed4f9b99b39965b", "url": "https://github.com/apache/kafka/commit/4e9331c2681156ce81b982a60ed4f9b99b39965b", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KAFKA-6585", "committedDate": "2020-09-05T19:38:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODc5Nw==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484028797", "bodyText": "Few nitpicks here:\nConvert an ISO8601 based timestamp to an epoch value\n....\n@return epoch value of a given timestamp\n@throws ParseException for timestamp that doesn't follow ISO8601 format", "author": "brary", "createdAt": "2020-09-06T06:31:56Z", "path": "clients/src/main/java/org/apache/kafka/common/utils/Utils.java", "diffHunk": "@@ -1271,4 +1274,35 @@ private static byte checkRange(final byte i) {\n         }\n         return map;\n     }\n+\n+\n+    /**\n+     * Convert a ISO8601 based TimeStamp to Epoch Value", "originalCommit": "4e9331c2681156ce81b982a60ed4f9b99b39965b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAzNDQwMw==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484034403", "bodyText": "This was not addressed, you disagree with the changes suggested?", "author": "brary", "createdAt": "2020-09-06T07:31:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODc5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODg5Nw==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484028897", "bodyText": "nit: Please remove this line new line.", "author": "brary", "createdAt": "2020-09-06T06:33:06Z", "path": "streams/src/test/java/org/apache/kafka/streams/tools/StreamsResetterTest.java", "diffHunk": "@@ -30,11 +30,10 @@\n import org.junit.Before;\n import org.junit.Test;\n \n-import java.text.ParseException;\n-import java.text.SimpleDateFormat;\n+", "originalCommit": "4e9331c2681156ce81b982a60ed4f9b99b39965b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODkwMA==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484028900", "bodyText": "nit: Please remove this line new line.", "author": "brary", "createdAt": "2020-09-06T06:33:11Z", "path": "streams/src/test/java/org/apache/kafka/streams/tools/StreamsResetterTest.java", "diffHunk": "@@ -30,11 +30,10 @@\n import org.junit.Before;\n import org.junit.Test;\n \n-import java.text.ParseException;\n-import java.text.SimpleDateFormat;\n+\n import java.time.Duration;\n import java.util.Collections;\n-import java.util.Date;\n+", "originalCommit": "4e9331c2681156ce81b982a60ed4f9b99b39965b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODkwMg==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484028902", "bodyText": "nit: Please remove this line new line.", "author": "brary", "createdAt": "2020-09-06T06:33:17Z", "path": "streams/src/test/java/org/apache/kafka/streams/tools/StreamsResetterTest.java", "diffHunk": "@@ -43,7 +42,7 @@\n \n import static org.junit.Assert.assertEquals;\n import static org.junit.Assert.assertTrue;\n-import static org.junit.Assert.fail;\n+", "originalCommit": "4e9331c2681156ce81b982a60ed4f9b99b39965b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODkzMA==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484028930", "bodyText": "nit: Please remove this line new line.", "author": "brary", "createdAt": "2020-09-06T06:33:39Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -42,13 +42,13 @@\n \n import java.io.IOException;\n import java.text.ParseException;\n-import java.text.SimpleDateFormat;\n+\n import java.time.Duration;\n import java.time.Instant;\n import java.util.ArrayList;\n import java.util.Collection;\n import java.util.Collections;\n-import java.util.Date;\n+", "originalCommit": "4e9331c2681156ce81b982a60ed4f9b99b39965b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAyODkzMg==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484028932", "bodyText": "nit: Please remove this line new line.", "author": "brary", "createdAt": "2020-09-06T06:33:42Z", "path": "core/src/main/scala/kafka/tools/StreamsResetter.java", "diffHunk": "@@ -42,13 +42,13 @@\n \n import java.io.IOException;\n import java.text.ParseException;\n-import java.text.SimpleDateFormat;\n+", "originalCommit": "4e9331c2681156ce81b982a60ed4f9b99b39965b", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3892174c250ac4b4727335706223efefc2c0a208", "url": "https://github.com/apache/kafka/commit/3892174c250ac4b4727335706223efefc2c0a208", "message": "KAFKA-6585 Minor Identation Fix", "committedDate": "2020-09-06T07:00:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDAzNDMyOQ==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r484034329", "bodyText": "There is an extra line here.", "author": "brary", "createdAt": "2020-09-06T07:30:55Z", "path": "clients/src/main/java/org/apache/kafka/common/utils/Utils.java", "diffHunk": "@@ -1271,4 +1274,35 @@ private static byte checkRange(final byte i) {\n         }\n         return map;\n     }\n+\n+", "originalCommit": "3892174c250ac4b4727335706223efefc2c0a208", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1f5aa568a1d3c1fbd2160b82524bbdf4bf7c3fa1", "url": "https://github.com/apache/kafka/commit/1f5aa568a1d3c1fbd2160b82524bbdf4bf7c3fa1", "message": "KAFKA-6585 Minor Changes in JavaDocs", "committedDate": "2020-09-06T08:29:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxOTkzOQ==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r487319939", "bodyText": "nit: I don't know from the top of my head what the standard dictates. Might be worth adding to the comment?", "author": "mjsax", "createdAt": "2020-09-11T22:37:14Z", "path": "clients/src/main/java/org/apache/kafka/common/utils/Utils.java", "diffHunk": "@@ -1271,4 +1274,34 @@ private static byte checkRange(final byte i) {\n         }\n         return map;\n     }\n+\n+    /**\n+     * Convert an ISO8601 based timestamp to an epoch value", "originalCommit": "1f5aa568a1d3c1fbd2160b82524bbdf4bf7c3fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxODE4MQ==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r489518181", "bodyText": "Hi @mjsax thanks for reviewing my PR.\nI removed \"ISO8601\" that from the comment as i checked every formatter library follow same ISO8601 standard. please let me know ur thoughts on that.", "author": "manijndl7", "createdAt": "2020-09-16T15:15:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMxOTkzOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTEzNQ==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r487321135", "bodyText": "We should update this test and use assertThrows instead of try-fail-catch.", "author": "mjsax", "createdAt": "2020-09-11T22:41:54Z", "path": "clients/src/test/java/org/apache/kafka/common/utils/UtilsTest.java", "diffHunk": "@@ -784,4 +787,39 @@ public void testCloseAllQuietly() {\n         assertEquals(msg, exception.get().getMessage());\n         assertEquals(1, count.get());\n     }\n+\n+    @Test\n+    public void shouldAcceptValidDateFormats() throws ParseException {\n+        //check valid formats\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSZ\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSX\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSXX\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSXXX\"));\n+    }\n+\n+    @Test\n+    public void shouldThrowOnInvalidDateFormat() {\n+        //check some invalid formats\n+        try {\n+            invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss\"));", "originalCommit": "1f5aa568a1d3c1fbd2160b82524bbdf4bf7c3fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNTc4NQ==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r489515785", "bodyText": "agreed , i have made code changes for that please have a look if its correct", "author": "manijndl7", "createdAt": "2020-09-16T15:11:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTEzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTI0OQ==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r487321249", "bodyText": "We should not print the stacktrace imho, but verify the exception message using assertThat.", "author": "mjsax", "createdAt": "2020-09-11T22:42:22Z", "path": "clients/src/test/java/org/apache/kafka/common/utils/UtilsTest.java", "diffHunk": "@@ -784,4 +787,39 @@ public void testCloseAllQuietly() {\n         assertEquals(msg, exception.get().getMessage());\n         assertEquals(1, count.get());\n     }\n+\n+    @Test\n+    public void shouldAcceptValidDateFormats() throws ParseException {\n+        //check valid formats\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSZ\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSX\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSXX\"));\n+        invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSSXXX\"));\n+    }\n+\n+    @Test\n+    public void shouldThrowOnInvalidDateFormat() {\n+        //check some invalid formats\n+        try {\n+            invokeGetDateTimeMethod(new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss\"));\n+            fail(\"Call to getDateTime should fail\");\n+        } catch (final Exception e) {\n+            e.printStackTrace();", "originalCommit": "1f5aa568a1d3c1fbd2160b82524bbdf4bf7c3fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUxNTgzMw==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r489515833", "bodyText": "i have made code changes for that", "author": "manijndl7", "createdAt": "2020-09-16T15:11:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTI0OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTcyNg==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r487321726", "bodyText": "I know that this is exiting logic that was just moved, but I am not sure if I understand how it works?", "author": "mjsax", "createdAt": "2020-09-11T22:44:18Z", "path": "clients/src/main/java/org/apache/kafka/common/utils/Utils.java", "diffHunk": "@@ -1271,4 +1274,34 @@ private static byte checkRange(final byte i) {\n         }\n         return map;\n     }\n+\n+    /**\n+     * Convert an ISO8601 based timestamp to an epoch value\n+     * @param timestamp to be converted\n+     * @return epoch value of a given timestamp\n+     * @throws ParseException for timestamp that doesn't follow ISO8601 format\n+     */\n+    public static long getDateTime(String timestamp) throws ParseException {\n+        final String[] timestampParts = timestamp.split(\"T\");\n+        if (timestampParts.length < 2) {\n+            throw new ParseException(\"Error parsing timestamp. It does not contain a 'T' according to ISO8601 format\", timestamp.length());\n+        }\n+\n+        final String secondPart = timestampParts[1];\n+        if (secondPart == null || secondPart.isEmpty()) {\n+            throw new ParseException(\"Error parsing timestamp. Time part after 'T' is null or empty\", timestamp.length());\n+        }\n+\n+        if (!(secondPart.contains(\"+\") || secondPart.contains(\"-\") || secondPart.contains(\"Z\"))) {", "originalCommit": "1f5aa568a1d3c1fbd2160b82524bbdf4bf7c3fa1", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzMTc0MQ==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r489531741", "bodyText": "@mjsax please let me know if ur asking anything specific i will try to explore that bt following is my understanding about this fxn : -\n-call from (streamResetter/ commandgroup) to reset the offset based on epooch value given timestamp.\n\ncheck the format is correct if correct else throw exception.\nappend \"Z\" for UTC timezone if not there.\nparse and get the time.\n\nBut i tested by running all the unit cases.", "author": "manijndl7", "createdAt": "2020-09-16T15:32:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTUzNDYyMg==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r489534622", "bodyText": "@mjsax request you to please review this again.\nThanks !!", "author": "manijndl7", "createdAt": "2020-09-16T15:36:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTc4NjQ5Mw==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r495786493", "bodyText": "Hi @mjax request you to please review once.", "author": "manijndl7", "createdAt": "2020-09-28T08:54:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTcyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzY2OTgwNw==", "url": "https://github.com/apache/kafka/pull/9255#discussion_r497669807", "bodyText": "I was looking up the format in more detail and understand now what going on. The code does not seem to be ideal IMHO, but no need to change it in this PR.", "author": "mjsax", "createdAt": "2020-09-30T17:09:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzMyMTcyNg=="}], "type": "inlineReview"}, {"oid": "08b49370ebf9c970f8e595acc2b72d40dbbeeb4a", "url": "https://github.com/apache/kafka/commit/08b49370ebf9c970f8e595acc2b72d40dbbeeb4a", "message": "KAFKA-6585 Minor Refactoring", "committedDate": "2020-09-16T11:02:23Z", "type": "commit"}]}