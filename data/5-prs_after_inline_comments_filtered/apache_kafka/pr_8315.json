{"pr_number": 8315, "pr_title": "KAFKA-9433: Use automated protocol for AlterConfigs request and response", "pr_createdAt": "2020-03-19T14:33:35Z", "pr_url": "https://github.com/apache/kafka/pull/8315", "timeline": [{"oid": "bcf1121d48c5c0797332961e11c81714f2a91898", "url": "https://github.com/apache/kafka/commit/bcf1121d48c5c0797332961e11c81714f2a91898", "message": "KAFKA-9433: Use automated protocol for AlterConfigs request and response", "committedDate": "2020-03-20T16:01:19Z", "type": "commit"}, {"oid": "bcf1121d48c5c0797332961e11c81714f2a91898", "url": "https://github.com/apache/kafka/commit/bcf1121d48c5c0797332961e11c81714f2a91898", "message": "KAFKA-9433: Use automated protocol for AlterConfigs request and response", "committedDate": "2020-03-20T16:01:19Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNzk5Ng==", "url": "https://github.com/apache/kafka/pull/8315#discussion_r396207996", "bodyText": "This data construction seems better to be put in the AlterConfigsResponse constructor.", "author": "abbccdda", "createdAt": "2020-03-23T04:28:59Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/AlterConfigsRequest.java", "diffHunk": "@@ -104,98 +64,76 @@ public String value() {\n \n     public static class Builder extends AbstractRequest.Builder<AlterConfigsRequest> {\n \n-        private final Map<ConfigResource, Config> configs;\n-        private final boolean validateOnly;\n+        private final AlterConfigsRequestData data = new AlterConfigsRequestData();\n \n         public Builder(Map<ConfigResource, Config> configs, boolean validateOnly) {\n             super(ApiKeys.ALTER_CONFIGS);\n-            this.configs = Objects.requireNonNull(configs, \"configs\");\n-            this.validateOnly = validateOnly;\n+            Objects.requireNonNull(configs, \"configs\");\n+            for (Map.Entry<ConfigResource, Config> entry : configs.entrySet()) {\n+                AlterConfigsRequestData.AlterConfigsResource resource = new AlterConfigsRequestData.AlterConfigsResource()\n+                        .setResourceName(entry.getKey().name())\n+                        .setResourceType(entry.getKey().type().id());\n+                for (ConfigEntry x : entry.getValue().entries) {\n+                    resource.configs().add(new AlterConfigsRequestData.AlterableConfig()\n+                            .setName(x.name())\n+                            .setValue(x.value()));\n+                }\n+                this.data.resources().add(resource);\n+            }\n+            this.data.setValidateOnly(validateOnly);\n         }\n \n         @Override\n         public AlterConfigsRequest build(short version) {\n-            return new AlterConfigsRequest(version, configs, validateOnly);\n+            return new AlterConfigsRequest(data, version);\n         }\n     }\n \n-    private final Map<ConfigResource, Config> configs;\n-    private final boolean validateOnly;\n+    private final AlterConfigsRequestData data;\n \n-    public AlterConfigsRequest(short version, Map<ConfigResource, Config> configs, boolean validateOnly) {\n+    public AlterConfigsRequest(AlterConfigsRequestData data, short version) {\n         super(ApiKeys.ALTER_CONFIGS, version);\n-        this.configs = Objects.requireNonNull(configs, \"configs\");\n-        this.validateOnly = validateOnly;\n+        this.data = data;\n     }\n \n     public AlterConfigsRequest(Struct struct, short version) {\n         super(ApiKeys.ALTER_CONFIGS, version);\n-        validateOnly = struct.getBoolean(VALIDATE_ONLY_KEY_NAME);\n-        Object[] resourcesArray = struct.getArray(RESOURCES_KEY_NAME);\n-        configs = new HashMap<>(resourcesArray.length);\n-        for (Object resourcesObj : resourcesArray) {\n-            Struct resourcesStruct = (Struct) resourcesObj;\n-\n-            ConfigResource.Type resourceType = ConfigResource.Type.forId(resourcesStruct.getByte(RESOURCE_TYPE_KEY_NAME));\n-            String resourceName = resourcesStruct.getString(RESOURCE_NAME_KEY_NAME);\n-            ConfigResource resource = new ConfigResource(resourceType, resourceName);\n-\n-            Object[] configEntriesArray = resourcesStruct.getArray(CONFIG_ENTRIES_KEY_NAME);\n-            List<ConfigEntry> configEntries = new ArrayList<>(configEntriesArray.length);\n-            for (Object configEntriesObj: configEntriesArray) {\n-                Struct configEntriesStruct = (Struct) configEntriesObj;\n-                String configName = configEntriesStruct.getString(CONFIG_NAME);\n-                String configValue = configEntriesStruct.getString(CONFIG_VALUE);\n-                configEntries.add(new ConfigEntry(configName, configValue));\n-            }\n-            Config config = new Config(configEntries);\n-            configs.put(resource, config);\n-        }\n+        this.data = new AlterConfigsRequestData(struct, version);\n     }\n \n     public Map<ConfigResource, Config> configs() {\n-        return configs;\n+        return data.resources().stream().collect(Collectors.toMap(\n+            resource -> new ConfigResource(\n+                    ConfigResource.Type.forId(resource.resourceType()),\n+                    resource.resourceName()),\n+            resource -> new Config(resource.configs().stream()\n+                    .map(entry -> new ConfigEntry(entry.name(), entry.value()))\n+                    .collect(Collectors.toList()))));\n     }\n \n     public boolean validateOnly() {\n-        return validateOnly;\n+        return data.validateOnly();\n     }\n \n     @Override\n     protected Struct toStruct() {\n-        Struct struct = new Struct(ApiKeys.ALTER_CONFIGS.requestSchema(version()));\n-        struct.set(VALIDATE_ONLY_KEY_NAME, validateOnly);\n-        List<Struct> resourceStructs = new ArrayList<>(configs.size());\n-        for (Map.Entry<ConfigResource, Config> entry : configs.entrySet()) {\n-            Struct resourceStruct = struct.instance(RESOURCES_KEY_NAME);\n-\n-            ConfigResource resource = entry.getKey();\n-            resourceStruct.set(RESOURCE_TYPE_KEY_NAME, resource.type().id());\n-            resourceStruct.set(RESOURCE_NAME_KEY_NAME, resource.name());\n-\n-            Config config = entry.getValue();\n-            List<Struct> configEntryStructs = new ArrayList<>(config.entries.size());\n-            for (ConfigEntry configEntry : config.entries) {\n-                Struct configEntriesStruct = resourceStruct.instance(CONFIG_ENTRIES_KEY_NAME);\n-                configEntriesStruct.set(CONFIG_NAME, configEntry.name);\n-                configEntriesStruct.set(CONFIG_VALUE, configEntry.value);\n-                configEntryStructs.add(configEntriesStruct);\n-            }\n-            resourceStruct.set(CONFIG_ENTRIES_KEY_NAME, configEntryStructs.toArray(new Struct[0]));\n-\n-            resourceStructs.add(resourceStruct);\n-        }\n-        struct.set(RESOURCES_KEY_NAME, resourceStructs.toArray(new Struct[0]));\n-        return struct;\n+        return data.toStruct(version());\n     }\n \n     @Override\n     public AbstractResponse getErrorResponse(int throttleTimeMs, Throwable e) {\n         ApiError error = ApiError.fromThrowable(e);\n-        Map<ConfigResource, ApiError> errors = new HashMap<>(configs.size());\n-        for (ConfigResource resource : configs.keySet())\n-            errors.put(resource, error);\n-        return new AlterConfigsResponse(throttleTimeMs, errors);\n+        AlterConfigsResponseData data = new AlterConfigsResponseData()\n+                .setThrottleTimeMs(throttleTimeMs);\n+        for (AlterConfigsRequestData.AlterConfigsResource resource : this.data.resources()) {\n+            data.responses().add(new AlterConfigsResponseData.AlterConfigsResourceResponse()\n+                    .setResourceType(resource.resourceType())\n+                    .setResourceName(resource.resourceName())\n+                    .setErrorMessage(error.message())\n+                    .setErrorCode(error.error().code()));\n+        }\n+        return new AlterConfigsResponse(data);", "originalCommit": "bcf1121d48c5c0797332961e11c81714f2a91898", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjMzNzgxMA==", "url": "https://github.com/apache/kafka/pull/8315#discussion_r396337810", "bodyText": "Thanks, @abbccdda. There was such a constructor in the AlterConfigsResponse originally, but it used a Map parameter (and it seemed a bit pointless to me to create a map here just to iterate over it in the constructor). Are you suggesting to revert to that constructor, or have a signiture like (List<AlterConfigsRequestData.AlterConfigsResource> resources, ApiError error)?", "author": "tombentley", "createdAt": "2020-03-23T10:10:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNzk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjU3MDcyNA==", "url": "https://github.com/apache/kafka/pull/8315#discussion_r396570724", "bodyText": "Yea, my suggestion would be to reuse the existing constructor as the construction of the AlterConfigsResponseData seems non trivial for a caller to do, compared with passing a map of errors.", "author": "abbccdda", "createdAt": "2020-03-23T16:10:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNzk5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjYxOTM2OA==", "url": "https://github.com/apache/kafka/pull/8315#discussion_r396619368", "bodyText": "But it only has this one call site, so the benefit is not clear to me.", "author": "tombentley", "createdAt": "2020-03-23T17:17:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjIwNzk5Ng=="}], "type": "inlineReview"}]}