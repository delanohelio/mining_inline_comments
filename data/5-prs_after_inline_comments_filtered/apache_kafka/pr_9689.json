{"pr_number": 9689, "pr_title": "KAFKA-10740; Replace OffsetsForLeaderEpochRequest.PartitionData with automated protocol", "pr_createdAt": "2020-12-04T09:33:33Z", "pr_url": "https://github.com/apache/kafka/pull/9689", "timeline": [{"oid": "3db69e9e7a4d55887a44c8a407c950e9c17efeff", "url": "https://github.com/apache/kafka/commit/3db69e9e7a4d55887a44c8a407c950e9c17efeff", "message": "KAFKA-10740; Replace OffsetsForLeaderEpochRequest.PartitionData with automated protocol", "committedDate": "2020-12-08T09:25:18Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwMDkyNg==", "url": "https://github.com/apache/kafka/pull/9689#discussion_r539700926", "bodyText": "Could we use RequestUtils.getLeaderEpoch?", "author": "hachikuji", "createdAt": "2020-12-09T22:37:35Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/OffsetsForLeaderEpochRequest.java", "diffHunk": "@@ -143,30 +127,24 @@ public AbstractResponse getErrorResponse(int throttleTimeMs, Throwable e) {\n         return new OffsetsForLeaderEpochResponse(responseData);\n     }\n \n-    public static class PartitionData {\n-        public final Optional<Integer> currentLeaderEpoch;\n-        public final int leaderEpoch;\n-\n-        public PartitionData(Optional<Integer> currentLeaderEpoch, int leaderEpoch) {\n-            this.currentLeaderEpoch = currentLeaderEpoch;\n-            this.leaderEpoch = leaderEpoch;\n-        }\n-\n-        @Override\n-        public String toString() {\n-            StringBuilder bld = new StringBuilder();\n-            bld.append(\"(currentLeaderEpoch=\").append(currentLeaderEpoch).\n-                append(\", leaderEpoch=\").append(leaderEpoch).\n-                append(\")\");\n-            return bld.toString();\n-        }\n-    }\n-\n     /**\n      * Check whether a broker allows Topic-level permissions in order to use the\n      * OffsetForLeaderEpoch API. Old versions require Cluster permission.\n      */\n     public static boolean supportsTopicPermission(short latestUsableVersion) {\n         return latestUsableVersion >= 3;\n     }\n+\n+    /**\n+     * Exposed `OffsetForLeaderPartition.currentLeaderEpoch` as an `java.util.Optional`.\n+     *\n+     * Classes auto-generated based on the protocol do not support `java.util.Optional` yet. This\n+     * is a temporary workaround until that work is completed.\n+     */\n+    public static Optional<Integer> currentLeaderEpochOpt(OffsetForLeaderPartition offsetForLeaderPartition) {", "originalCommit": "3db69e9e7a4d55887a44c8a407c950e9c17efeff", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAxNjgwNA==", "url": "https://github.com/apache/kafka/pull/9689#discussion_r540016804", "bodyText": "Yes, let me change this.", "author": "dajac", "createdAt": "2020-12-10T09:38:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTcwMDkyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM4NjA1Ng==", "url": "https://github.com/apache/kafka/pull/9689#discussion_r542386056", "bodyText": "There are some duplicate code. Maybe we can unify them in this PR (or we can address it in follow-up) ?\n\nhttps://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java#L1399\nhttps://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/clients/consumer/internals/Fetcher.java#L1553\nhttps://github.com/apache/kafka/blob/trunk/clients/src/main/java/org/apache/kafka/common/record/FileRecords.java#L358\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/coordinator/group/GroupMetadataManager.scala#L1124\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/KafkaApis.scala#L534\nhttps://github.com/apache/kafka/blob/trunk/core/src/main/scala/kafka/server/ReplicaManager.scala#L1890", "author": "chia7712", "createdAt": "2020-12-14T13:33:39Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/RequestUtils.java", "diffHunk": "@@ -34,7 +34,7 @@\n \n     private RequestUtils() {}\n \n-    static Optional<Integer> getLeaderEpoch(int leaderEpoch) {\n+    public static Optional<Integer> getLeaderEpoch(int leaderEpoch) {", "originalCommit": "26056e004d293bed8c6f123b259c0867ed54cb1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk5MzY5NQ==", "url": "https://github.com/apache/kafka/pull/9689#discussion_r544993695", "bodyText": "@chia7712 Thanks for pointing this out. I think that we should tackle this in follow-up PRs as this is not strictly related to this change. Ok for you?", "author": "dajac", "createdAt": "2020-12-17T10:51:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM4NjA1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDk5NDI3Mw==", "url": "https://github.com/apache/kafka/pull/9689#discussion_r544994273", "bodyText": "It is ok to me :)", "author": "chia7712", "createdAt": "2020-12-17T10:51:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjM4NjA1Ng=="}], "type": "inlineReview"}, {"oid": "52278ac4f4a0c3c3160b3fa313381bcba242a60e", "url": "https://github.com/apache/kafka/commit/52278ac4f4a0c3c3160b3fa313381bcba242a60e", "message": "KAFKA-10740; Replace OffsetsForLeaderEpochRequest.PartitionData with automated protocol", "committedDate": "2020-12-17T13:17:21Z", "type": "commit"}, {"oid": "101bbf912bd4b1aee541f08c07a83259b7bf9a1b", "url": "https://github.com/apache/kafka/commit/101bbf912bd4b1aee541f08c07a83259b7bf9a1b", "message": "Address review", "committedDate": "2020-12-17T13:17:22Z", "type": "commit"}, {"oid": "d998c32b864c4c7bc199cb1746f60ff77633cf6e", "url": "https://github.com/apache/kafka/commit/d998c32b864c4c7bc199cb1746f60ff77633cf6e", "message": "remove unused imports", "committedDate": "2020-12-17T13:17:22Z", "type": "commit"}, {"oid": "5f22942a41ee5ed60766908115509aaa0047c9ec", "url": "https://github.com/apache/kafka/commit/5f22942a41ee5ed60766908115509aaa0047c9ec", "message": "address review", "committedDate": "2020-12-17T13:17:22Z", "type": "commit"}, {"oid": "5f22942a41ee5ed60766908115509aaa0047c9ec", "url": "https://github.com/apache/kafka/commit/5f22942a41ee5ed60766908115509aaa0047c9ec", "message": "address review", "committedDate": "2020-12-17T13:17:22Z", "type": "forcePushed"}]}