{"pr_number": 9630, "pr_title": "KAFKA-10739; Replace EpochEndOffset with automated protocol", "pr_createdAt": "2020-11-20T15:38:38Z", "pr_url": "https://github.com/apache/kafka/pull/9630", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0MTczOQ==", "url": "https://github.com/apache/kafka/pull/9630#discussion_r533541739", "bodyText": "Maybe just me, but OffsetForLeaderPartitionResult seems more cumbersome and less descriptive than EpochEndOffset. Would it be worth changing the name in the generated schema?", "author": "hachikuji", "createdAt": "2020-12-01T16:18:59Z", "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java", "diffHunk": "@@ -3727,15 +3733,24 @@ public void testOffsetValidationRequestGrouping() {\n             assertTrue(expectedPartitions.size() > 0);\n             allRequestedPartitions.addAll(expectedPartitions);\n \n-            Map<TopicPartition, EpochEndOffset> endOffsets = expectedPartitions.stream().collect(Collectors.toMap(\n-                Function.identity(),\n-                tp -> new EpochEndOffset(Errors.NONE, 4, 0)\n-            ));\n+            OffsetForLeaderEpochResponseData data = new OffsetForLeaderEpochResponseData();\n+            expectedPartitions.forEach(tp -> {\n+                OffsetForLeaderTopicResult topic = data.topics().find(tp.topic());\n+                if (topic == null) {\n+                    topic = new OffsetForLeaderTopicResult().setTopic(tp.topic());\n+                    data.topics().add(topic);\n+                }\n+                topic.partitions().add(new OffsetForLeaderPartitionResult()", "originalCommit": "7237f6ce11e4a7d75d929842a478a77695a6fe0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk4MDk0Mg==", "url": "https://github.com/apache/kafka/pull/9630#discussion_r533980942", "bodyText": "I do agree with you. Using EpochEndOffset sounds much better.", "author": "dajac", "createdAt": "2020-12-02T08:32:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0MTczOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0ODE5Ng==", "url": "https://github.com/apache/kafka/pull/9630#discussion_r533548196", "bodyText": "Not for this patch, but all of this boilerplate we need to build the topic groupings gets annoying. It is such a common case that it might be worth writing a special type that lets the parser construct Map<TopicPartition, Data> directly since that is really what the code wants. Alternatively, maybe we could flatten the schemas and introduce compression.", "author": "hachikuji", "createdAt": "2020-12-01T16:27:22Z", "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/FetcherTest.java", "diffHunk": "@@ -3727,15 +3733,24 @@ public void testOffsetValidationRequestGrouping() {\n             assertTrue(expectedPartitions.size() > 0);\n             allRequestedPartitions.addAll(expectedPartitions);\n \n-            Map<TopicPartition, EpochEndOffset> endOffsets = expectedPartitions.stream().collect(Collectors.toMap(\n-                Function.identity(),\n-                tp -> new EpochEndOffset(Errors.NONE, 4, 0)\n-            ));\n+            OffsetForLeaderEpochResponseData data = new OffsetForLeaderEpochResponseData();\n+            expectedPartitions.forEach(tp -> {\n+                OffsetForLeaderTopicResult topic = data.topics().find(tp.topic());\n+                if (topic == null) {", "originalCommit": "7237f6ce11e4a7d75d929842a478a77695a6fe0b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5OTcxNQ==", "url": "https://github.com/apache/kafka/pull/9630#discussion_r533999715", "bodyText": "That would be nice, indeed! I have been thinking about this as well but did not have the time to tackle this yet. I have opened a JIRA to track this: https://issues.apache.org/jira/browse/KAFKA-10795.", "author": "dajac", "createdAt": "2020-12-02T09:03:21Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzU0ODE5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3OTM0OQ==", "url": "https://github.com/apache/kafka/pull/9630#discussion_r534379349", "bodyText": "In the case of the error code, I think it might be better to be explicit.", "author": "hachikuji", "createdAt": "2020-12-02T18:13:18Z", "path": "clients/src/test/java/org/apache/kafka/common/requests/RequestResponseTest.java", "diffHunk": "@@ -1839,20 +1839,17 @@ private OffsetsForLeaderEpochResponse createLeaderEpochResponse() {\n             .setPartitions(Arrays.asList(\n                 new OffsetForLeaderPartitionResult()\n                     .setPartition(0)\n-                    .setErrorCode(Errors.NONE.code())\n                     .setLeaderEpoch(1)\n                     .setEndOffset(0),\n                 new OffsetForLeaderPartitionResult()\n                     .setPartition(1)\n-                    .setErrorCode(Errors.NONE.code())", "originalCommit": "d192b83e0993500cd0345d3aea48a21cdc9ab190", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDkwMDg3Mg==", "url": "https://github.com/apache/kafka/pull/9630#discussion_r534900872", "bodyText": "I don't feel strong either ways so I will follow your suggestion.", "author": "dajac", "createdAt": "2020-12-03T08:23:10Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDM3OTM0OQ=="}], "type": "inlineReview"}, {"oid": "32329a384fc6f7679184e1337dd8bad803b53d71", "url": "https://github.com/apache/kafka/commit/32329a384fc6f7679184e1337dd8bad803b53d71", "message": "Migrate KafkaApis and ReplicaManager", "committedDate": "2020-12-03T10:14:40Z", "type": "commit"}, {"oid": "f7c0b25fa3ed1d3449aea60e13bb564a634430e3", "url": "https://github.com/apache/kafka/commit/f7c0b25fa3ed1d3449aea60e13bb564a634430e3", "message": "use OffsetForLeaderEpochResponseData.OffsetForLeaderPartitionResult in Partition and change all the related usages", "committedDate": "2020-12-03T10:39:33Z", "type": "commit"}, {"oid": "d7839109a8b9e6343403007bfc1bd139e0432ab7", "url": "https://github.com/apache/kafka/commit/d7839109a8b9e6343403007bfc1bd139e0432ab7", "message": "Remove OffsetsForLeaderEpochRequest#epochsByTopicPartition", "committedDate": "2020-12-03T10:39:33Z", "type": "commit"}, {"oid": "c70dd2a74e6c8fb5e5d8fc632fe2b8801cf71061", "url": "https://github.com/apache/kafka/commit/c70dd2a74e6c8fb5e5d8fc632fe2b8801cf71061", "message": "remove OffsetsForLeaderEpochResponse#responses", "committedDate": "2020-12-03T10:39:34Z", "type": "commit"}, {"oid": "d23fb390c7fd0beaabbd770ec32932b11b0f2e24", "url": "https://github.com/apache/kafka/commit/d23fb390c7fd0beaabbd770ec32932b11b0f2e24", "message": "remove old constructors in OffsetsForLeaderEpochResponse", "committedDate": "2020-12-03T10:39:34Z", "type": "commit"}, {"oid": "4a89452470216b6dc0574fe94442b577c1148e1e", "url": "https://github.com/apache/kafka/commit/4a89452470216b6dc0574fe94442b577c1148e1e", "message": "Migrate ReplicaFetcherMockBlockingSend", "committedDate": "2020-12-03T10:48:52Z", "type": "commit"}, {"oid": "549e6fc77532da5e9a0baaa749f646990f2eb120", "url": "https://github.com/apache/kafka/commit/549e6fc77532da5e9a0baaa749f646990f2eb120", "message": "fix ReplicaFetcherThreadBenchmark", "committedDate": "2020-12-03T10:48:52Z", "type": "commit"}, {"oid": "ae4479172a2897e716c3d6b78249f802e967e4d6", "url": "https://github.com/apache/kafka/commit/ae4479172a2897e716c3d6b78249f802e967e4d6", "message": "Move constants from EpochEndOffset to OffsetsForLeaderEpochResponse", "committedDate": "2020-12-03T10:56:34Z", "type": "commit"}, {"oid": "d39f87eaf56a922994d047e6ae0cc668e08a3008", "url": "https://github.com/apache/kafka/commit/d39f87eaf56a922994d047e6ae0cc668e08a3008", "message": "bye bye EpochEndOffset", "committedDate": "2020-12-03T10:56:34Z", "type": "commit"}, {"oid": "655885b14f4931a2c8660f30005d2e038da5b0d7", "url": "https://github.com/apache/kafka/commit/655885b14f4931a2c8660f30005d2e038da5b0d7", "message": "clean up the code", "committedDate": "2020-12-03T10:59:59Z", "type": "commit"}, {"oid": "71f139c7c01d032363a114c1def753a7e580252d", "url": "https://github.com/apache/kafka/commit/71f139c7c01d032363a114c1def753a7e580252d", "message": "address review", "committedDate": "2020-12-03T11:00:00Z", "type": "commit"}, {"oid": "4008993b492405e41378db53e8135a649f030307", "url": "https://github.com/apache/kafka/commit/4008993b492405e41378db53e8135a649f030307", "message": "Relies on default values in the schema whereever possible", "committedDate": "2020-12-03T11:03:27Z", "type": "commit"}, {"oid": "864644ab8dd06e0174010cf134437e5cc5224b50", "url": "https://github.com/apache/kafka/commit/864644ab8dd06e0174010cf134437e5cc5224b50", "message": "Rename OffsetForLeaderPartitionResult to EpochEndOffset", "committedDate": "2020-12-03T11:51:33Z", "type": "commit"}, {"oid": "2a9f87a118c051bfc6e6a944ef21db79db9b5068", "url": "https://github.com/apache/kafka/commit/2a9f87a118c051bfc6e6a944ef21db79db9b5068", "message": "address review", "committedDate": "2020-12-03T11:57:38Z", "type": "commit"}, {"oid": "2a9f87a118c051bfc6e6a944ef21db79db9b5068", "url": "https://github.com/apache/kafka/commit/2a9f87a118c051bfc6e6a944ef21db79db9b5068", "message": "address review", "committedDate": "2020-12-03T11:57:38Z", "type": "forcePushed"}]}