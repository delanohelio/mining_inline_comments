{"pr_number": 9708, "pr_title": "KAFKA-9126: KIP-689: StreamJoined changelog configuration", "pr_createdAt": "2020-12-07T18:03:11Z", "pr_url": "https://github.com/apache/kafka/pull/9708", "timeline": [{"oid": "ea6d6b0abcc40e105f751328881c2128d8d17ac1", "url": "https://github.com/apache/kafka/commit/ea6d6b0abcc40e105f751328881c2128d8d17ac1", "message": "initial kip implementation", "committedDate": "2020-12-01T16:56:07Z", "type": "commit"}, {"oid": "e0c77fe92e5fd730ded310e730f116bb396a9a25", "url": "https://github.com/apache/kafka/commit/e0c77fe92e5fd730ded310e730f116bb396a9a25", "message": "remove caching option and add testing", "committedDate": "2020-12-04T16:53:42Z", "type": "commit"}, {"oid": "52a815bb29d52cc52fd6e908e0d35912c35ab3b7", "url": "https://github.com/apache/kafka/commit/52a815bb29d52cc52fd6e908e0d35912c35ab3b7", "message": "cleanup", "committedDate": "2020-12-07T17:57:24Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM3NTMyMQ==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r540375321", "bodyText": "I think you meant this here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        null\n          \n          \n            \n                        new HashMap<>()", "author": "vvcephei", "createdAt": "2020-12-10T17:50:54Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/StreamJoined.java", "diffHunk": "@@ -267,7 +296,49 @@ private StreamJoined(final Serde<K> keySerde,\n             thisStoreSupplier,\n             otherStoreSupplier,\n             name,\n-            storeName\n+            storeName,\n+            loggingEnabled,\n+            topicConfig\n+        );\n+    }\n+\n+    /**\n+     * Configures logging for both state stores. The changelog will be created with the provided configs.\n+     * <p>\n+     * Note: Any unrecognized configs will be ignored\n+     * @param config  configs applied to the changelog topic\n+     * @return            a new {@link StreamJoined} configured with logging enabled\n+     */\n+    public StreamJoined<K, V1, V2> withLoggingEnabled(final Map<String, String> config) {\n+\n+        return new StreamJoined<>(\n+            keySerde,\n+            valueSerde,\n+            otherValueSerde,\n+            thisStoreSupplier,\n+            otherStoreSupplier,\n+            name,\n+            storeName,\n+            true,\n+            config\n+        );\n+    }\n+\n+    /**\n+     * Disable change logging for both state stores.\n+     * @return            a new {@link StreamJoined} configured with logging disabled\n+     */\n+    public StreamJoined<K, V1, V2> withLoggingDisabled() {\n+        return new StreamJoined<>(\n+            keySerde,\n+            valueSerde,\n+            otherValueSerde,\n+            thisStoreSupplier,\n+            otherStoreSupplier,\n+            name,\n+            storeName,\n+            false,\n+            null", "originalCommit": "52a815bb29d52cc52fd6e908e0d35912c35ab3b7", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM3NzA0NA==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r540377044", "bodyText": "It seems like these would pass by default. Maybe we should check set some log configs and then check that they got propagated ?", "author": "vvcephei", "createdAt": "2020-12-10T17:53:29Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamKStreamJoinTest.java", "diffHunk": "@@ -152,6 +155,52 @@ private void shouldLogAndMeterOnSkippedRecordsWithNullValue(final String builtIn\n         }\n     }\n \n+    @Test\n+    public void shouldDisableLoggingOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingDisabled();\n+\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final KStream<String, Integer> left = builder.stream(\"left\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+        final KStream<String, Integer> right = builder.stream(\"right\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+\n+        left.join(\n+            right,\n+            (value1, value2) -> value1 + value2,\n+            joinWindows,\n+            streamJoined);\n+\n+        final Topology topology = builder.build();\n+        final InternalTopologyBuilder internalTopologyBuilder = TopologyWrapper.getInternalTopologyBuilder(topology);\n+\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-this-join-store\").loggingEnabled(), equalTo(false));\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-other-join-store\").loggingEnabled(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void shouldEnableLoggingWithCustomConfigOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingEnabled(Collections.emptyMap());\n+\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final KStream<String, Integer> left = builder.stream(\"left\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+        final KStream<String, Integer> right = builder.stream(\"right\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+\n+        left.join(\n+            right,\n+            (value1, value2) -> value1 + value2,\n+            joinWindows,\n+            streamJoined);\n+\n+        final Topology topology = builder.build();\n+        final InternalTopologyBuilder internalTopologyBuilder = TopologyWrapper.getInternalTopologyBuilder(topology);\n+\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-this-join-store\").loggingEnabled(), equalTo(true));\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-other-join-store\").loggingEnabled(), equalTo(true));", "originalCommit": "52a815bb29d52cc52fd6e908e0d35912c35ab3b7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDQzMTM2OA==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r540431368", "bodyText": "Yeah it does pass by default. I experimented with passing the logs in but I wasn't able to find a good way to confirm that the logs I was passing were getting set somewhere. Do you know where they're exposed for me to check? Materialized doesn't seem to check this either", "author": "lct45", "createdAt": "2020-12-10T19:17:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM3NzA0NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3MTM0NA==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r543271344", "bodyText": "Maybe there is an easier way, but I found the following:\nSet the config to:\n        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined\n            .with(Serdes.String(), Serdes.Integer(), Serdes.Integer())\n            .withStoreName(\"store\")\n            .withLoggingEnabled(Collections.singletonMap(\"test\", \"property\"));\n\nand then check it:\n        internalTopologyBuilder.buildSubtopology(0);\n\n        assertThat(internalTopologyBuilder.stateStores().get(\"store-this-join-store\").loggingEnabled(), equalTo(true));\n        assertThat(internalTopologyBuilder.stateStores().get(\"store-other-join-store\").loggingEnabled(), equalTo(true));\n        assertThat(internalTopologyBuilder.topicGroups().get(0).stateChangelogTopics.size(), equalTo(2));\n        for (final InternalTopicConfig config : internalTopologyBuilder.topicGroups().get(0).stateChangelogTopics.values()) {\n            assertThat(\n                config.getProperties(Collections.emptyMap(), 0).get(\"test\"),\n                equalTo(\"property\")\n            );\n        }\n\nWithout\nassertThat(internalTopologyBuilder.topicGroups().get(0).stateChangelogTopics.size(), equalTo(2));\n\nthe test would pass without checking the config if buildSubtopology() is not called because no changelog topics would be registered in the topology. So it basically checks that buildSubtopology() is called.", "author": "cadonna", "createdAt": "2020-12-15T11:40:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDM3NzA0NA=="}], "type": "inlineReview"}, {"oid": "67ebdd51af2a2400d5b088fc5b14da25a7c7dba3", "url": "https://github.com/apache/kafka/commit/67ebdd51af2a2400d5b088fc5b14da25a7c7dba3", "message": "Johns edits", "committedDate": "2020-12-10T19:19:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyMjYxMQ==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r543222611", "bodyText": "I guess both can be declared as final, right?", "author": "cadonna", "createdAt": "2020-12-15T10:25:03Z", "path": "streams/src/main/java/org/apache/kafka/streams/kstream/StreamJoined.java", "diffHunk": "@@ -36,6 +39,8 @@\n     protected final WindowBytesStoreSupplier otherStoreSupplier;\n     protected final String name;\n     protected final String storeName;\n+    protected boolean loggingEnabled;\n+    protected Map<String, String> topicConfig;", "originalCommit": "67ebdd51af2a2400d5b088fc5b14da25a7c7dba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyNjY0Mw==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r543226643", "bodyText": "Suggestion:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingDisabled();\n          \n          \n            \n                    final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined\n          \n          \n            \n                        .with(Serdes.String(), Serdes.Integer(), Serdes.Integer())\n          \n          \n            \n                        .withStoreName(\"store\")\n          \n          \n            \n                        .withLoggingDisabled();", "author": "cadonna", "createdAt": "2020-12-15T10:30:43Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamKStreamJoinTest.java", "diffHunk": "@@ -152,6 +155,52 @@ private void shouldLogAndMeterOnSkippedRecordsWithNullValue(final String builtIn\n         }\n     }\n \n+    @Test\n+    public void shouldDisableLoggingOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingDisabled();", "originalCommit": "67ebdd51af2a2400d5b088fc5b14da25a7c7dba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyNzI4NQ==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r543227285", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    left.join(\n          \n          \n            \n                        right,\n          \n          \n            \n                        (value1, value2) -> value1 + value2,\n          \n          \n            \n                        joinWindows,\n          \n          \n            \n                        streamJoined);\n          \n          \n            \n                    left.join(\n          \n          \n            \n                        right,\n          \n          \n            \n                        (value1, value2) -> value1 + value2,\n          \n          \n            \n                        joinWindows,\n          \n          \n            \n                        streamJoined\n          \n          \n            \n                    );", "author": "cadonna", "createdAt": "2020-12-15T10:31:37Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamKStreamJoinTest.java", "diffHunk": "@@ -152,6 +155,52 @@ private void shouldLogAndMeterOnSkippedRecordsWithNullValue(final String builtIn\n         }\n     }\n \n+    @Test\n+    public void shouldDisableLoggingOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingDisabled();\n+\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final KStream<String, Integer> left = builder.stream(\"left\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+        final KStream<String, Integer> right = builder.stream(\"right\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+\n+        left.join(\n+            right,\n+            (value1, value2) -> value1 + value2,\n+            joinWindows,\n+            streamJoined);", "originalCommit": "67ebdd51af2a2400d5b088fc5b14da25a7c7dba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyODU5Ng==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r543228596", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingEnabled(Collections.emptyMap());\n          \n          \n            \n                    final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined\n          \n          \n            \n                        .with(Serdes.String(), Serdes.Integer(), Serdes.Integer())\n          \n          \n            \n                        .withStoreName(\"store\")\n          \n          \n            \n                        .withLoggingEnabled(Collections.emptyMap());", "author": "cadonna", "createdAt": "2020-12-15T10:33:33Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamKStreamJoinTest.java", "diffHunk": "@@ -152,6 +155,52 @@ private void shouldLogAndMeterOnSkippedRecordsWithNullValue(final String builtIn\n         }\n     }\n \n+    @Test\n+    public void shouldDisableLoggingOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingDisabled();\n+\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final KStream<String, Integer> left = builder.stream(\"left\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+        final KStream<String, Integer> right = builder.stream(\"right\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+\n+        left.join(\n+            right,\n+            (value1, value2) -> value1 + value2,\n+            joinWindows,\n+            streamJoined);\n+\n+        final Topology topology = builder.build();\n+        final InternalTopologyBuilder internalTopologyBuilder = TopologyWrapper.getInternalTopologyBuilder(topology);\n+\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-this-join-store\").loggingEnabled(), equalTo(false));\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-other-join-store\").loggingEnabled(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void shouldEnableLoggingWithCustomConfigOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingEnabled(Collections.emptyMap());", "originalCommit": "67ebdd51af2a2400d5b088fc5b14da25a7c7dba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIyODc0Nw==", "url": "https://github.com/apache/kafka/pull/9708#discussion_r543228747", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    left.join(\n          \n          \n            \n                        right,\n          \n          \n            \n                        (value1, value2) -> value1 + value2,\n          \n          \n            \n                        joinWindows,\n          \n          \n            \n                        streamJoined);\n          \n          \n            \n                    left.join(\n          \n          \n            \n                        right,\n          \n          \n            \n                        (value1, value2) -> value1 + value2,\n          \n          \n            \n                        joinWindows,\n          \n          \n            \n                        streamJoined\n          \n          \n            \n                    );", "author": "cadonna", "createdAt": "2020-12-15T10:33:46Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamKStreamJoinTest.java", "diffHunk": "@@ -152,6 +155,52 @@ private void shouldLogAndMeterOnSkippedRecordsWithNullValue(final String builtIn\n         }\n     }\n \n+    @Test\n+    public void shouldDisableLoggingOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingDisabled();\n+\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final KStream<String, Integer> left = builder.stream(\"left\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+        final KStream<String, Integer> right = builder.stream(\"right\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+\n+        left.join(\n+            right,\n+            (value1, value2) -> value1 + value2,\n+            joinWindows,\n+            streamJoined);\n+\n+        final Topology topology = builder.build();\n+        final InternalTopologyBuilder internalTopologyBuilder = TopologyWrapper.getInternalTopologyBuilder(topology);\n+\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-this-join-store\").loggingEnabled(), equalTo(false));\n+        assertThat(internalTopologyBuilder.stateStores().get(\"store-other-join-store\").loggingEnabled(), equalTo(false));\n+    }\n+\n+    @Test\n+    public void shouldEnableLoggingWithCustomConfigOnStreamJoined() {\n+\n+        final JoinWindows joinWindows = JoinWindows.of(ofMillis(100)).grace(Duration.ofMillis(50));\n+        final StreamJoined<String, Integer, Integer> streamJoined = StreamJoined.with(Serdes.String(), Serdes.Integer(), Serdes.Integer()).withStoreName(\"store\").withLoggingEnabled(Collections.emptyMap());\n+\n+        final StreamsBuilder builder = new StreamsBuilder();\n+        final KStream<String, Integer> left = builder.stream(\"left\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+        final KStream<String, Integer> right = builder.stream(\"right\", Consumed.with(Serdes.String(), Serdes.Integer()));\n+\n+        left.join(\n+            right,\n+            (value1, value2) -> value1 + value2,\n+            joinWindows,\n+            streamJoined);", "originalCommit": "67ebdd51af2a2400d5b088fc5b14da25a7c7dba3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b43a480aacc197a275e9c8d1a6451cff3c449050", "url": "https://github.com/apache/kafka/commit/b43a480aacc197a275e9c8d1a6451cff3c449050", "message": "Bruno's comments", "committedDate": "2020-12-15T15:42:38Z", "type": "commit"}]}