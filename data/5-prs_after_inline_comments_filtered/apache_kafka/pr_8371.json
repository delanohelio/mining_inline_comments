{"pr_number": 8371, "pr_title": "KAFKA-9753: A few more metrics to add", "pr_createdAt": "2020-03-27T00:38:33Z", "pr_url": "https://github.com/apache/kafka/pull/8371", "timeline": [{"oid": "70ca574fd8e3f3bc2ca42b3bb56de8f936e77f07", "url": "https://github.com/apache/kafka/commit/70ca574fd8e3f3bc2ca42b3bb56de8f936e77f07", "message": "first pass", "committedDate": "2020-03-25T00:43:35Z", "type": "commit"}, {"oid": "8b33c3e798f4f63964df1f961210d0ab0975dc52", "url": "https://github.com/apache/kafka/commit/8b33c3e798f4f63964df1f961210d0ab0975dc52", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9756-loop-tasks-order", "committedDate": "2020-03-25T05:02:12Z", "type": "commit"}, {"oid": "77e475e5ca63a0d57070b49b8366d60857b7b7d2", "url": "https://github.com/apache/kafka/commit/77e475e5ca63a0d57070b49b8366d60857b7b7d2", "message": "fix unit tests", "committedDate": "2020-03-25T23:15:08Z", "type": "commit"}, {"oid": "d5c743baa264f5cc9ea6c9f48aed24cb8ab72365", "url": "https://github.com/apache/kafka/commit/d5c743baa264f5cc9ea6c9f48aed24cb8ab72365", "message": "add unit tests", "committedDate": "2020-03-26T00:14:28Z", "type": "commit"}, {"oid": "e81f042e5b0da16c0f27a5c64a0bf6c64259613e", "url": "https://github.com/apache/kafka/commit/e81f042e5b0da16c0f27a5c64a0bf6c64259613e", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9753-active-process-ratio", "committedDate": "2020-03-26T03:51:22Z", "type": "commit"}, {"oid": "8eb82b253e3e2c46d55c705dfaf790e133a18dce", "url": "https://github.com/apache/kafka/commit/8eb82b253e3e2c46d55c705dfaf790e133a18dce", "message": "first pass", "committedDate": "2020-03-26T17:27:15Z", "type": "commit"}, {"oid": "b2982363abcca81fbd64a0b9835ec28b619da1a9", "url": "https://github.com/apache/kafka/commit/b2982363abcca81fbd64a0b9835ec28b619da1a9", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9756-loop-tasks-order", "committedDate": "2020-03-26T17:28:50Z", "type": "commit"}, {"oid": "153b7417674c9bdc6d4b0aaf9f5684c1a646ff11", "url": "https://github.com/apache/kafka/commit/153b7417674c9bdc6d4b0aaf9f5684c1a646ff11", "message": "should be INFO", "committedDate": "2020-03-26T19:07:16Z", "type": "commit"}, {"oid": "a7d945ccf2b511398edd744221d84eb5f318d69c", "url": "https://github.com/apache/kafka/commit/a7d945ccf2b511398edd744221d84eb5f318d69c", "message": "fix unit tests", "committedDate": "2020-03-26T23:12:48Z", "type": "commit"}, {"oid": "7431c1ab6aa5182e734d70f51b38b53b469e3081", "url": "https://github.com/apache/kafka/commit/7431c1ab6aa5182e734d70f51b38b53b469e3081", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9756-loop-tasks-order", "committedDate": "2020-03-26T23:12:59Z", "type": "commit"}, {"oid": "0286037701fdc8a2993a9953549974baa8f22b85", "url": "https://github.com/apache/kafka/commit/0286037701fdc8a2993a9953549974baa8f22b85", "message": "github comments", "committedDate": "2020-03-26T23:39:50Z", "type": "commit"}, {"oid": "bc5010ef3fc6e61c375689b8c6ef16f8f81013ca", "url": "https://github.com/apache/kafka/commit/bc5010ef3fc6e61c375689b8c6ef16f8f81013ca", "message": "rebase", "committedDate": "2020-03-26T23:46:45Z", "type": "commit"}, {"oid": "decaa94dbbf1cc5b4370c196e8dc284fe9618381", "url": "https://github.com/apache/kafka/commit/decaa94dbbf1cc5b4370c196e8dc284fe9618381", "message": "unit tests", "committedDate": "2020-03-27T00:06:54Z", "type": "commit"}, {"oid": "2228c8673a7355371fae563f6355b4bf0a99f9a3", "url": "https://github.com/apache/kafka/commit/2228c8673a7355371fae563f6355b4bf0a99f9a3", "message": "add a few more metrics", "committedDate": "2020-03-27T00:28:09Z", "type": "commit"}, {"oid": "5bbf703b430f96f15dd3e014ac9053d39d4369ae", "url": "https://github.com/apache/kafka/commit/5bbf703b430f96f15dd3e014ac9053d39d4369ae", "message": "rebase from trunk", "committedDate": "2020-03-27T05:59:35Z", "type": "commit"}, {"oid": "fd15eab0dbdade59d5d29dacfc40bfbc221a9454", "url": "https://github.com/apache/kafka/commit/fd15eab0dbdade59d5d29dacfc40bfbc221a9454", "message": "Merge branch 'K9753-active-process-ratio' of https://github.com/guozhangwang/kafka into K9753-more-metrics", "committedDate": "2020-03-27T06:02:06Z", "type": "commit"}, {"oid": "6309a5a9602f4656048d3193c793db495c0fa2a7", "url": "https://github.com/apache/kafka/commit/6309a5a9602f4656048d3193c793db495c0fa2a7", "message": "rebase from trunk", "committedDate": "2020-03-31T23:49:50Z", "type": "commit"}, {"oid": "f7e7467887fecbb5eeba4a396e21a3bd46ba206c", "url": "https://github.com/apache/kafka/commit/f7e7467887fecbb5eeba4a396e21a3bd46ba206c", "message": "rebase from trunk", "committedDate": "2020-03-31T23:57:38Z", "type": "commit"}, {"oid": "22bb1f9fcf68ddce3ed65c957d3ce0b95cf9ae18", "url": "https://github.com/apache/kafka/commit/22bb1f9fcf68ddce3ed65c957d3ce0b95cf9ae18", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9753-more-metrics", "committedDate": "2020-04-01T02:51:44Z", "type": "commit"}, {"oid": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "url": "https://github.com/apache/kafka/commit/e6641dfaed2f8b1cb5a04424f8e2161364cac333", "message": "add num.threads metric", "committedDate": "2020-04-01T03:25:17Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMTE5OQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r401931199", "bodyText": "Bummer that Stream.count forces us to round-trip through a long, but whatever.", "author": "vvcephei", "createdAt": "2020-04-01T21:50:39Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -762,6 +762,9 @@ private KafkaStreams(final InternalTopologyBuilder internalTopologyBuilder,\n             storeProviders.add(new StreamThreadStateStoreProvider(threads[i], internalTopologyBuilder));\n         }\n \n+        ClientMetrics.addNumAliveStreamThreadMetric(streamsMetrics, (metricsConfig, now) ->\n+            Math.toIntExact(Arrays.stream(threads).filter(thread -> thread.state().isAlive()).count()));", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMjQ4Ng==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r401932486", "bodyText": "Since StreamThreads have a number of states that people are familiar with watching, it might be worth being specific about what \"alive\" means. In particular, it seems like many will wonder if this just means \"running\", which it does not.", "author": "vvcephei", "createdAt": "2020-04-01T21:53:25Z", "path": "streams/src/main/java/org/apache/kafka/streams/internals/metrics/ClientMetrics.java", "diffHunk": "@@ -58,6 +60,8 @@ private ClientMetrics() {}\n     private static final String TOPOLOGY_DESCRIPTION_DESCRIPTION =\n         \"The description of the topology executed in the Kafka Streams client\";\n     private static final String STATE_DESCRIPTION = \"The state of the Kafka Streams client\";\n+    private static final String ALIVE_STREAM_THREADS_DESCRIPTION = \"The number of alive stream threads\";", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzMzk0Mg==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r401933942", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String PROCESS_MAX_RECORDS_DESCRIPTION = \"The maximum number of records polled  within an iteration\";\n          \n          \n            \n                private static final String PROCESS_MAX_RECORDS_DESCRIPTION = \"The maximum number of records processed within an iteration\";", "author": "vvcephei", "createdAt": "2020-04-01T21:56:41Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/ThreadMetrics.java", "diffHunk": "@@ -64,11 +65,15 @@ private ThreadMetrics() {}\n     private static final String POLL_RATE_DESCRIPTION = RATE_DESCRIPTION + POLL_DESCRIPTION;\n     private static final String POLL_AVG_LATENCY_DESCRIPTION = \"The average poll latency\";\n     private static final String POLL_MAX_LATENCY_DESCRIPTION = \"The maximum poll latency\";\n+    private static final String POLL_AVG_RECORDS_DESCRIPTION = \"The average number of records polled within an iteration\";\n+    private static final String POLL_MAX_RECORDS_DESCRIPTION = \"The maximum number of records polled within an iteration\";\n     private static final String PROCESS_DESCRIPTION = \"calls to process\";\n     private static final String PROCESS_TOTAL_DESCRIPTION = TOTAL_DESCRIPTION + PROCESS_DESCRIPTION;\n     private static final String PROCESS_RATE_DESCRIPTION = RATE_DESCRIPTION + PROCESS_DESCRIPTION;\n     private static final String PROCESS_AVG_LATENCY_DESCRIPTION = \"The average process latency\";\n     private static final String PROCESS_MAX_LATENCY_DESCRIPTION = \"The maximum process latency\";\n+    private static final String PROCESS_AVG_RECORDS_DESCRIPTION = \"The average number of records processed  within an iteration\";\n+    private static final String PROCESS_MAX_RECORDS_DESCRIPTION = \"The maximum number of records polled  within an iteration\";", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTkzNDAzMw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r401934033", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String PROCESS_AVG_RECORDS_DESCRIPTION = \"The average number of records processed  within an iteration\";\n          \n          \n            \n                private static final String PROCESS_AVG_RECORDS_DESCRIPTION = \"The average number of records processed within an iteration\";", "author": "vvcephei", "createdAt": "2020-04-01T21:56:53Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/ThreadMetrics.java", "diffHunk": "@@ -64,11 +65,15 @@ private ThreadMetrics() {}\n     private static final String POLL_RATE_DESCRIPTION = RATE_DESCRIPTION + POLL_DESCRIPTION;\n     private static final String POLL_AVG_LATENCY_DESCRIPTION = \"The average poll latency\";\n     private static final String POLL_MAX_LATENCY_DESCRIPTION = \"The maximum poll latency\";\n+    private static final String POLL_AVG_RECORDS_DESCRIPTION = \"The average number of records polled within an iteration\";\n+    private static final String POLL_MAX_RECORDS_DESCRIPTION = \"The maximum number of records polled within an iteration\";\n     private static final String PROCESS_DESCRIPTION = \"calls to process\";\n     private static final String PROCESS_TOTAL_DESCRIPTION = TOTAL_DESCRIPTION + PROCESS_DESCRIPTION;\n     private static final String PROCESS_RATE_DESCRIPTION = RATE_DESCRIPTION + PROCESS_DESCRIPTION;\n     private static final String PROCESS_AVG_LATENCY_DESCRIPTION = \"The average process latency\";\n     private static final String PROCESS_MAX_LATENCY_DESCRIPTION = \"The maximum process latency\";\n+    private static final String PROCESS_AVG_RECORDS_DESCRIPTION = \"The average number of records processed  within an iteration\";", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NTk0MQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402155941", "bodyText": "req: Please add unit tests to ClientMetricsTest for this methods.", "author": "cadonna", "createdAt": "2020-04-02T08:56:26Z", "path": "streams/src/main/java/org/apache/kafka/streams/internals/metrics/ClientMetrics.java", "diffHunk": "@@ -113,4 +117,25 @@ public static void addStateMetric(final StreamsMetricsImpl streamsMetrics,\n             stateProvider\n         );\n     }\n+\n+    public static void addNumAliveStreamThreadMetric(final StreamsMetricsImpl streamsMetrics,\n+                                                     final Gauge<Integer> stateProvider) {\n+        streamsMetrics.addClientLevelMutableMetric(\n+            ALIVE_STREAM_THREADS,\n+            ALIVE_STREAM_THREADS_DESCRIPTION,\n+            RecordingLevel.INFO,\n+            stateProvider\n+        );\n+    }\n+\n+    public static void addNumAliveCleanupThreadMetric(final StreamsMetricsImpl streamsMetrics,\n+                                                      final Gauge<Integer> stateProvider) {\n+        streamsMetrics.addClientLevelMutableMetric(\n+            ALIVE_CLEANUP_THREADS,\n+            ALIVE_CLEANUP_THREADS_DESCRIPTION,\n+            RecordingLevel.INFO,\n+            stateProvider\n+        );\n+    }", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjY2ODc0Ng==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402668746", "bodyText": "Ack.", "author": "guozhangwang", "createdAt": "2020-04-03T00:20:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE1NTk0MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2MDU0NA==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402160544", "bodyText": "req: Please add unit tests to TaskMetricsTest for this methods.", "author": "cadonna", "createdAt": "2020-04-02T09:03:37Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/TaskMetrics.java", "diffHunk": "@@ -117,6 +120,21 @@ public static Sensor activeProcessRatioSensor(final String threadId,\n         return sensor;\n     }\n \n+    public static Sensor activeBufferedRecordsSensor(final String threadId,\n+                                                     final String taskId,\n+                                                     final StreamsMetricsImpl streamsMetrics) {\n+        final String name = ACTIVE_TASK_PREFIX + BUFFERED + StreamsMetricsImpl.RECORDS_SUFFIX;\n+        final Sensor sensor = streamsMetrics.taskLevelSensor(threadId, taskId, name, Sensor.RecordingLevel.DEBUG);\n+        addValueMetricToSensor(\n+            sensor,\n+            TASK_LEVEL_GROUP,\n+            streamsMetrics.taskLevelTagMap(threadId, taskId),\n+            name,\n+            NUM_BUFFERED_RECORDS_DESCRIPTION\n+        );\n+        return sensor;\n+    }\n+", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2MzQ4Ng==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402163486", "bodyText": "prop: For the suppression buffer, we used -count as a suffix instead of -records to measure the number of records.", "author": "cadonna", "createdAt": "2020-04-02T09:08:21Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/TaskMetrics.java", "diffHunk": "@@ -117,6 +120,21 @@ public static Sensor activeProcessRatioSensor(final String threadId,\n         return sensor;\n     }\n \n+    public static Sensor activeBufferedRecordsSensor(final String threadId,\n+                                                     final String taskId,\n+                                                     final StreamsMetricsImpl streamsMetrics) {\n+        final String name = ACTIVE_TASK_PREFIX + BUFFERED + StreamsMetricsImpl.RECORDS_SUFFIX;", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjU5MjkyOQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402592929", "bodyText": "Ack, that makes sense!", "author": "guozhangwang", "createdAt": "2020-04-02T20:42:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjE2MzQ4Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI3MzkxOQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402273919", "bodyText": "prop: Could you please rename this method to reflect the new recording inside?", "author": "cadonna", "createdAt": "2020-04-02T12:28:10Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -628,6 +630,7 @@ public void recordProcessBatchTime(final long processBatchTime) {\n \n     @Override\n     public void recordProcessTimeRatio(final long allTaskProcessMs) {", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI3NTUxNQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402275515", "bodyText": "req: When reading this description, it is not immediately clear where those records are buffered. Could you please add some reference to the input or similar?", "author": "cadonna", "createdAt": "2020-04-02T12:30:52Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/TaskMetrics.java", "diffHunk": "@@ -82,8 +82,11 @@ private TaskMetrics() {}\n     private static final String PROCESS_AVG_LATENCY_DESCRIPTION = AVG_LATENCY_DESCRIPTION + PROCESS_DESCRIPTION;\n     private static final String PROCESS_MAX_LATENCY_DESCRIPTION = MAX_LATENCY_DESCRIPTION + PROCESS_DESCRIPTION;\n \n+    private static final String BUFFERED = \"buffered\";\n+\n     private static final String PROCESS_RATIO_DESCRIPTION = \"The fraction of time the thread spent \" +\n         \"on processing this task among all assigned active tasks\";\n+    private static final String NUM_BUFFERED_RECORDS_DESCRIPTION = \"Number of buffered records for this active task\";", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI3NjE4Mg==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402276182", "bodyText": "req: Please add unit tests in ThreadMetricsTest.", "author": "cadonna", "createdAt": "2020-04-02T12:32:06Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/metrics/ThreadMetrics.java", "diffHunk": "@@ -175,6 +180,40 @@ public static Sensor processLatencySensor(final String threadId,\n         return sensor;\n     }\n \n+    public static Sensor pollRecordsSensor(final String threadId,\n+                                           final StreamsMetricsImpl streamsMetrics) {\n+        final Sensor sensor =\n+            streamsMetrics.threadLevelSensor(threadId, POLL + RECORDS_SUFFIX, RecordingLevel.INFO);\n+        final Map<String, String> tagMap = streamsMetrics.threadLevelTagMap(threadId);\n+        final String threadLevelGroup = threadLevelGroup(streamsMetrics);\n+        addAvgAndMaxToSensor(\n+            sensor,\n+            threadLevelGroup,\n+            tagMap,\n+            POLL + RECORDS_SUFFIX,\n+            POLL_AVG_RECORDS_DESCRIPTION,\n+            POLL_MAX_RECORDS_DESCRIPTION\n+        );\n+        return sensor;\n+    }\n+\n+    public static Sensor processRecordsSensor(final String threadId,\n+                                              final StreamsMetricsImpl streamsMetrics) {\n+        final Sensor sensor =\n+            streamsMetrics.threadLevelSensor(threadId, PROCESS + RECORDS_SUFFIX, RecordingLevel.INFO);\n+        final Map<String, String> tagMap = streamsMetrics.threadLevelTagMap(threadId);\n+        final String threadLevelGroup = threadLevelGroup(streamsMetrics);\n+        addAvgAndMaxToSensor(\n+            sensor,\n+            threadLevelGroup,\n+            tagMap,\n+            PROCESS + RECORDS_SUFFIX,\n+            PROCESS_AVG_RECORDS_DESCRIPTION,\n+            PROCESS_MAX_RECORDS_DESCRIPTION\n+        );\n+        return sensor;\n+    }\n+", "originalCommit": "e6641dfaed2f8b1cb5a04424f8e2161364cac333", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "2a88a3c9e0d5bc6c4c8ab946d67035c8b6554057", "url": "https://github.com/apache/kafka/commit/2a88a3c9e0d5bc6c4c8ab946d67035c8b6554057", "message": "github comments", "committedDate": "2020-04-03T02:18:29Z", "type": "commit"}, {"oid": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "url": "https://github.com/apache/kafka/commit/cbd79095f112883eba0ad90aa2bf94144bbd0b10", "message": "rebase from trunk", "committedDate": "2020-04-03T02:20:26Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg3NDA3NQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402874075", "bodyText": "prop: Could you please add a private method like setUpAndVerifyMetric() for mutable metrics to avoid code duplications? Best would be to rename setUpAndVerifyMetric() to setUpAndVerifyImmutableMetric() and to call the new method setUpAndVerifyMutableMetric().", "author": "cadonna", "createdAt": "2020-04-03T09:22:44Z", "path": "streams/src/test/java/org/apache/kafka/streams/internals/metrics/ClientMetricsTest.java", "diffHunk": "@@ -91,6 +91,42 @@ public void shouldAddStateMetric() {\n         verify(streamsMetrics);\n     }\n \n+    @Test\n+    public void shouldAddAliveStreamThreadsMetric() {\n+        final String name = \"alive-stream-threads\";\n+        final String description = \"The current number of alive stream threads that are running or participating in rebalance\";\n+        final Gauge<Integer> stateProvider = (config, now) -> 1;\n+        streamsMetrics.addClientLevelMutableMetric(\n+            eq(name),\n+            eq(description),\n+            eq(RecordingLevel.INFO),\n+            eq(stateProvider)\n+        );\n+        replay(streamsMetrics);\n+\n+        ClientMetrics.addNumAliveStreamThreadMetric(streamsMetrics, stateProvider);\n+\n+        verify(streamsMetrics);\n+    }\n+\n+    @Test\n+    public void shouldAddAliveCleanupThreadsMetric() {\n+        final String name = \"alive-cleanup-threads\";\n+        final String description = \"The current number of alive local store directory cleanup threads\";\n+        final Gauge<Integer> stateProvider = (config, now) -> 1;\n+        streamsMetrics.addClientLevelMutableMetric(\n+            eq(name),\n+            eq(description),\n+            eq(RecordingLevel.INFO),\n+            eq(stateProvider)\n+        );\n+        replay(streamsMetrics);\n+\n+        ClientMetrics.addNumAliveCleanupThreadMetric(streamsMetrics, stateProvider);\n+\n+        verify(streamsMetrics);\n+    }\n+", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3NzQyNg==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403377426", "bodyText": "Good call! Will do.", "author": "guozhangwang", "createdAt": "2020-04-03T23:07:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg3NDA3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4NTcyMA==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402885720", "bodyText": "req: We expect the addition of the metric exactly once. Could you please remove line 196?", "author": "cadonna", "createdAt": "2020-04-03T09:43:04Z", "path": "streams/src/test/java/org/apache/kafka/streams/KafkaStreamsTest.java", "diffHunk": "@@ -192,6 +192,10 @@ private void prepareStreams() throws Exception {\n         ClientMetrics.addApplicationIdMetric(anyObject(StreamsMetricsImpl.class), EasyMock.eq(APPLICATION_ID));\n         ClientMetrics.addTopologyDescriptionMetric(anyObject(StreamsMetricsImpl.class), anyString());\n         ClientMetrics.addStateMetric(anyObject(StreamsMetricsImpl.class), anyObject());\n+        ClientMetrics.addNumAliveStreamThreadMetric(anyObject(StreamsMetricsImpl.class), anyObject());\n+        EasyMock.expectLastCall().anyTimes();", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM3NzAyMw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403377023", "bodyText": "Actually this is added intentionally since there are three tests in which we only created the instance without calling its start() function -- thinking about it, I will move the registration logic back to constructor and then we can remove it.", "author": "guozhangwang", "createdAt": "2020-04-03T23:06:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4NTcyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4NTgyMA==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402885820", "bodyText": "req: same as above", "author": "cadonna", "createdAt": "2020-04-03T09:43:15Z", "path": "streams/src/test/java/org/apache/kafka/streams/KafkaStreamsTest.java", "diffHunk": "@@ -192,6 +192,10 @@ private void prepareStreams() throws Exception {\n         ClientMetrics.addApplicationIdMetric(anyObject(StreamsMetricsImpl.class), EasyMock.eq(APPLICATION_ID));\n         ClientMetrics.addTopologyDescriptionMetric(anyObject(StreamsMetricsImpl.class), anyString());\n         ClientMetrics.addStateMetric(anyObject(StreamsMetricsImpl.class), anyObject());\n+        ClientMetrics.addNumAliveStreamThreadMetric(anyObject(StreamsMetricsImpl.class), anyObject());\n+        EasyMock.expectLastCall().anyTimes();\n+        ClientMetrics.addNumAliveCleanupThreadMetric(anyObject(StreamsMetricsImpl.class), anyObject());\n+        EasyMock.expectLastCall().anyTimes();", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5MzMxMA==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402893310", "bodyText": "req: Could you please add verifications of the creation of those metrics in StreamThreadTest#shouldCreateMetricsAtStartup()?", "author": "cadonna", "createdAt": "2020-04-03T09:56:27Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -445,12 +447,14 @@ public StreamThread(final Time time,\n         this.streamsMetrics = streamsMetrics;\n         this.commitSensor = ThreadMetrics.commitSensor(threadId, streamsMetrics);\n         this.pollSensor = ThreadMetrics.pollSensor(threadId, streamsMetrics);\n+        this.pollRecordsSensor = ThreadMetrics.pollRecordsSensor(threadId, streamsMetrics);", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MTcxNw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403381717", "bodyText": "Ack.", "author": "guozhangwang", "createdAt": "2020-04-03T23:24:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5MzMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5MzQyMw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402893423", "bodyText": "req: Could you please add verifications of the creation of those metrics in StreamThreadTest#shouldCreateMetricsAtStartup()?", "author": "cadonna", "createdAt": "2020-04-03T09:56:37Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -445,12 +447,14 @@ public StreamThread(final Time time,\n         this.streamsMetrics = streamsMetrics;\n         this.commitSensor = ThreadMetrics.commitSensor(threadId, streamsMetrics);\n         this.pollSensor = ThreadMetrics.pollSensor(threadId, streamsMetrics);\n+        this.pollRecordsSensor = ThreadMetrics.pollRecordsSensor(threadId, streamsMetrics);\n+        this.pollRatioSensor = ThreadMetrics.pollRatioSensor(threadId, streamsMetrics);\n         this.processLatencySensor = ThreadMetrics.processLatencySensor(threadId, streamsMetrics);\n+        this.processRecordsSensor = ThreadMetrics.processRecordsSensor(threadId, streamsMetrics);", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MTc2Ng==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403381766", "bodyText": "Ack.", "author": "guozhangwang", "createdAt": "2020-04-03T23:24:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5MzQyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5Nzg1Nw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402897857", "bodyText": "req: Please verify the creation of those metrics in StreamTaskTest#shouldConstructMetricsWithBuiltInMetricsVersionLatest().", "author": "cadonna", "createdAt": "2020-04-03T10:04:26Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -137,6 +138,7 @@ public StreamTask(final TaskId id,\n         processRatioSensor = TaskMetrics.activeProcessRatioSensor(threadId, taskId, streamsMetrics);\n         processLatencySensor = TaskMetrics.processLatencySensor(threadId, taskId, streamsMetrics);\n         punctuateLatencySensor = TaskMetrics.punctuateSensor(threadId, taskId, streamsMetrics);\n+        bufferedRecordsSensor = TaskMetrics.activeBufferedRecordsSensor(threadId, taskId, streamsMetrics);", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4Mjg2OA==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403382868", "bodyText": "Ack.", "author": "guozhangwang", "createdAt": "2020-04-03T23:29:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5Nzg1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5OTE2Mw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402899163", "bodyText": "req: Please rename this unit test to reflect the new verifications.", "author": "cadonna", "createdAt": "2020-04-03T10:06:58Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -381,7 +381,7 @@ public void shouldRecordProcessRatio() {\n ", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4MzA1NQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403383055", "bodyText": "I will add a new function to verify the buffer size.", "author": "guozhangwang", "createdAt": "2020-04-03T23:30:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg5OTE2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwMDQ1MQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402900451", "bodyText": "prop: I find assertThat() better readable than assertEquals().", "author": "cadonna", "createdAt": "2020-04-03T10:09:12Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -381,7 +381,7 @@ public void shouldRecordProcessRatio() {\n \n         task.recordProcessBatchTime(10L);\n         task.recordProcessBatchTime(15L);\n-        task.recordProcessTimeRatio(100L);\n+        task.recordProcessTimeRatioAndBufferSize(100L);\n \n         assertEquals(0.25d, (double) metric.metricValue(), 0.0001d);", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM4NDI1Ng==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403384256", "bodyText": "Fair enough :)", "author": "guozhangwang", "createdAt": "2020-04-03T23:35:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwMDQ1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwMzAxNQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402903015", "bodyText": "req: Please add verifications or unit tests to verify the values measured by this metric in KafkaStreamsTest.", "author": "cadonna", "createdAt": "2020-04-03T10:14:17Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -762,6 +762,9 @@ private KafkaStreams(final InternalTopologyBuilder internalTopologyBuilder,\n             storeProviders.add(new StreamThreadStateStoreProvider(threads[i], internalTopologyBuilder));\n         }\n \n+        ClientMetrics.addNumAliveStreamThreadMetric(streamsMetrics, (metricsConfig, now) ->\n+            Math.toIntExact(Arrays.stream(threads).filter(thread -> thread.state().isAlive()).count()));", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwMzEwMA==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r402903100", "bodyText": "req: Please add verifications or unit tests to verify the values measured by this metric in KafkaStreamsTest.", "author": "cadonna", "createdAt": "2020-04-03T10:14:27Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -773,14 +776,21 @@ private KafkaStreams(final InternalTopologyBuilder internalTopologyBuilder,\n         final GlobalStateStoreProvider globalStateStoreProvider = new GlobalStateStoreProvider(internalTopologyBuilder.globalStateStores());\n         queryableStoreProvider = new QueryableStoreProvider(storeProviders, globalStateStoreProvider);\n \n-        stateDirCleaner = Executors.newSingleThreadScheduledExecutor(r -> {\n+        stateDirCleaner = setupStateDirCleaner();\n+\n+        maybeWarnAboutCodeInRocksDBConfigSetter(log, config);\n+        rocksDBMetricsRecordingService = maybeCreateRocksDBMetricsRecordingService(clientId, config);\n+    }\n+\n+    private ScheduledExecutorService setupStateDirCleaner() {\n+        return Executors.newSingleThreadScheduledExecutor(r -> {\n             final Thread thread = new Thread(r, clientId + \"-CleanupThread\");\n             thread.setDaemon(true);\n+\n+            ClientMetrics.addNumAliveCleanupThreadMetric(streamsMetrics, (metricsConfig, now) -> thread.isAlive() ? 1 : 0);", "originalCommit": "cbd79095f112883eba0ad90aa2bf94144bbd0b10", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzM5NzQ4OQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r403397489", "bodyText": "The KafkaStreamsTest has mocks on all of its modules including metrics, I'll do this verification in MetricsIntegrationTest.", "author": "guozhangwang", "createdAt": "2020-04-04T00:41:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjkwMzEwMA=="}], "type": "inlineReview"}, {"oid": "67b8ed1af5700736f7413185c1fa2574be5e4c83", "url": "https://github.com/apache/kafka/commit/67b8ed1af5700736f7413185c1fa2574be5e4c83", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9753-more-metrics", "committedDate": "2020-04-03T22:54:17Z", "type": "commit"}, {"oid": "13ecb453df2d28489a90f19941b8671136421193", "url": "https://github.com/apache/kafka/commit/13ecb453df2d28489a90f19941b8671136421193", "message": "bruno's comments", "committedDate": "2020-04-04T00:48:40Z", "type": "commit"}, {"oid": "1d9c879e1d26efdfc13d4de309d4fa1a8d162a2f", "url": "https://github.com/apache/kafka/commit/1d9c879e1d26efdfc13d4de309d4fa1a8d162a2f", "message": "remove unused imports", "committedDate": "2020-04-04T01:15:13Z", "type": "commit"}, {"oid": "e0bc93d270620f61b4ec821c2f7955ba490d43ad", "url": "https://github.com/apache/kafka/commit/e0bc93d270620f61b4ec821c2f7955ba490d43ad", "message": "resolve conflicts from trunk", "committedDate": "2020-04-04T17:19:53Z", "type": "commit"}, {"oid": "025a26d6391a51be71487d75b93f8b892f7124e2", "url": "https://github.com/apache/kafka/commit/025a26d6391a51be71487d75b93f8b892f7124e2", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9753-more-metricst", "committedDate": "2020-04-05T21:19:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDA5ODU3Nw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r404098577", "bodyText": "Thank you for this! I forgot to remove them.", "author": "cadonna", "createdAt": "2020-04-06T13:40:46Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/MetricsIntegrationTest.java", "diffHunk": "@@ -193,30 +204,6 @@\n     private static final String EXPIRED_WINDOW_RECORD_DROP_RATE = \"expired-window-record-drop-rate\";\n     private static final String EXPIRED_WINDOW_RECORD_DROP_TOTAL = \"expired-window-record-drop-total\";\n \n-    // RocksDB metrics\n-    private static final String BYTES_WRITTEN_RATE = \"bytes-written-rate\";\n-    private static final String BYTES_WRITTEN_TOTAL = \"bytes-written-total\";\n-    private static final String BYTES_READ_RATE = \"bytes-read-rate\";\n-    private static final String BYTES_READ_TOTAL = \"bytes-read-total\";\n-    private static final String MEMTABLE_BYTES_FLUSHED_RATE = \"memtable-bytes-flushed-rate\";\n-    private static final String MEMTABLE_BYTES_FLUSHED_TOTAL = \"memtable-bytes-flushed-total\";\n-    private static final String MEMTABLE_HIT_RATIO = \"memtable-hit-ratio\";\n-    private static final String MEMTABLE_FLUSH_TIME_AVG = \"memtable-flush-time-avg\";\n-    private static final String MEMTABLE_FLUSH_TIME_MIN = \"memtable-flush-time-min\";\n-    private static final String MEMTABLE_FLUSH_TIME_MAX = \"memtable-flush-time-max\";\n-    private static final String WRITE_STALL_DURATION_AVG = \"write-stall-duration-avg\";\n-    private static final String WRITE_STALL_DURATION_TOTAL = \"write-stall-duration-total\";\n-    private static final String BLOCK_CACHE_DATA_HIT_RATIO = \"block-cache-data-hit-ratio\";\n-    private static final String BLOCK_CACHE_INDEX_HIT_RATIO = \"block-cache-index-hit-ratio\";\n-    private static final String BLOCK_CACHE_FILTER_HIT_RATIO = \"block-cache-filter-hit-ratio\";\n-    private static final String BYTES_READ_DURING_COMPACTION_RATE = \"bytes-read-compaction-rate\";\n-    private static final String BYTES_WRITTEN_DURING_COMPACTION_RATE = \"bytes-written-compaction-rate\";\n-    private static final String COMPACTION_TIME_AVG = \"compaction-time-avg\";\n-    private static final String COMPACTION_TIME_MIN = \"compaction-time-min\";\n-    private static final String COMPACTION_TIME_MAX = \"compaction-time-max\";\n-    private static final String NUMBER_OF_OPEN_FILES = \"number-open-files\";\n-    private static final String NUMBER_OF_FILE_ERRORS = \"number-file-errors-total\";\n-", "originalCommit": "025a26d6391a51be71487d75b93f8b892f7124e2", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwNDk5Nw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r404104997", "bodyText": "req: You verify this metric twice, once here in once in testMetricsForBuiltInMetricsVersionLatest(). Since it is a newly added metric und you account for the changes in the tags in getMetric() I guess you just need to keep the one here.", "author": "cadonna", "createdAt": "2020-04-06T13:49:29Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -434,6 +456,20 @@ private void testMetrics(final String builtInMetricsVersion) {\n             builtInMetricsVersion\n         ));\n \n+        assertNotNull(getMetric(\n+            \"active-process\",\n+            \"%s-ratio\",\n+            task.id().toString(),\n+            builtInMetricsVersion\n+        ));\n+", "originalCommit": "025a26d6391a51be71487d75b93f8b892f7124e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI3MTA5Mw==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r404271093", "bodyText": "Sounds good!", "author": "guozhangwang", "createdAt": "2020-04-06T17:38:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwNDk5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwOTg2Mg==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r404109862", "bodyText": "req: The names of this method and the previous method should be switched.", "author": "cadonna", "createdAt": "2020-04-06T13:55:40Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StreamTaskTest.java", "diffHunk": "@@ -375,24 +375,46 @@ public void shouldProcessInOrder() {\n     public void shouldRecordProcessRatio() {\n         task = createStatelessTask(createConfig(false, \"0\"), StreamsConfig.METRICS_LATEST);\n \n+        final KafkaMetric metric = getMetric(\"active-buffer\", \"%s-count\", task.id().toString(), StreamsConfig.METRICS_LATEST);\n+\n+        assertThat(metric.metricValue(), equalTo(0.0d));\n+\n+        task.addRecords(partition1, asList(\n+            getConsumerRecord(partition1, 10),\n+            getConsumerRecord(partition1, 20)\n+        ));\n+        task.recordProcessTimeRatioAndBufferSize(100L);\n+\n+        assertThat(metric.metricValue(), equalTo(2.0d));\n+\n+        task.process(0L);\n+        task.recordProcessTimeRatioAndBufferSize(100L);\n+\n+        assertThat(metric.metricValue(), equalTo(1.0d));\n+    }\n+\n+    @Test\n+    public void shouldRecordBufferedRecords() {", "originalCommit": "025a26d6391a51be71487d75b93f8b892f7124e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI3MTYwMQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r404271601", "bodyText": "Ack.", "author": "guozhangwang", "createdAt": "2020-04-06T17:39:38Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDEwOTg2Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDExNDY5MQ==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r404114691", "bodyText": "req: Please use a constant for the number of stream threads here and on line 260.", "author": "cadonna", "createdAt": "2020-04-06T14:01:48Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/MetricsIntegrationTest.java", "diffHunk": "@@ -246,6 +233,7 @@ public void before() throws InterruptedException {\n         streamsConfiguration.put(StreamsConfig.DEFAULT_VALUE_SERDE_CLASS_CONFIG, Serdes.String().getClass());\n         streamsConfiguration.put(StreamsConfig.METRICS_RECORDING_LEVEL_CONFIG, Sensor.RecordingLevel.DEBUG.name);\n         streamsConfiguration.put(StreamsConfig.CACHE_MAX_BYTES_BUFFERING_CONFIG, 10 * 1024 * 1024L);\n+        streamsConfiguration.put(StreamsConfig.NUM_STREAM_THREADS_CONFIG, 2);", "originalCommit": "025a26d6391a51be71487d75b93f8b892f7124e2", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDI3MzQzOA==", "url": "https://github.com/apache/kafka/pull/8371#discussion_r404273438", "bodyText": "Ack.", "author": "guozhangwang", "createdAt": "2020-04-06T17:42:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDExNDY5MQ=="}], "type": "inlineReview"}, {"oid": "3dd5774b835e17eac4f53d1bd4f7d696e27ad8cc", "url": "https://github.com/apache/kafka/commit/3dd5774b835e17eac4f53d1bd4f7d696e27ad8cc", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9753-more-metrics", "committedDate": "2020-04-06T17:35:42Z", "type": "commit"}, {"oid": "325f0a4e5b38f0cdd495629577cba64c9857b98c", "url": "https://github.com/apache/kafka/commit/325f0a4e5b38f0cdd495629577cba64c9857b98c", "message": "address more comments", "committedDate": "2020-04-06T17:42:57Z", "type": "commit"}]}