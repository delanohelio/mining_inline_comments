{"pr_number": 9344, "pr_title": "MINOR; Preserve ThrottlingQuotaExceededException when request timeouts after being retried due to a quota violation (KIP-599)", "pr_createdAt": "2020-09-28T11:27:24Z", "pr_url": "https://github.com/apache/kafka/pull/9344", "timeline": [{"oid": "0f8717f674680b0749ec36c84093aff247ffae74", "url": "https://github.com/apache/kafka/commit/0f8717f674680b0749ec36c84093aff247ffae74", "message": "When a create topics, create partitions or delete topics request is retried, ThrottlingQuotaExceededException is returned to the called if the request timeouts.", "committedDate": "2020-09-28T11:18:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3MzY1OQ==", "url": "https://github.com/apache/kafka/pull/9344#discussion_r496173659", "bodyText": "Do we want to return quota exceeded in all cases? Apart from timeouts, it seems like we should propagate failures rather an earlier quota exceeded exception?  That is, if we were throttled for 5 millis and then see a failure, the failure is more useful than the fact that we were throttled for 5 millis?", "author": "rajinisivaram", "createdAt": "2020-09-28T19:11:26Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -1554,6 +1575,11 @@ private ConfigEntry configEntry(CreatableTopicConfigs config) {\n \n             @Override\n             void handleFailure(Throwable throwable) {\n+                // If there were any topics retries due to a quota exceeded exception, we propagate\n+                // the initial error back to the caller.\n+                completeQuotaExceededException(futures, quotaExceededExceptions,", "originalCommit": "0f8717f674680b0749ec36c84093aff247ffae74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ2NzA1Ng==", "url": "https://github.com/apache/kafka/pull/9344#discussion_r496467056", "bodyText": "Definitely. I meant to do it for TimeoutException only but I have forgotten it while implementing it :(. Let me correct this.", "author": "dajac", "createdAt": "2020-09-29T07:12:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3MzY1OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3NjQ3Mg==", "url": "https://github.com/apache/kafka/pull/9344#discussion_r496176472", "bodyText": "I can see why we return the delta, but this looks odd when it says throttled with a time of zero.", "author": "rajinisivaram", "createdAt": "2020-09-28T19:16:59Z", "path": "clients/src/test/java/org/apache/kafka/clients/admin/KafkaAdminClientTest.java", "diffHunk": "@@ -733,7 +733,9 @@ public void testCreateTopicsRetryThrottlingExceptionWhenEnabledUntilRequestTimeO\n             time.sleep(defaultApiTimeout + 1);\n \n             assertNull(result.values().get(\"topic1\").get());\n-            TestUtils.assertFutureThrows(result.values().get(\"topic2\"), TimeoutException.class);\n+            ThrottlingQuotaExceededException e = TestUtils.assertFutureThrows(result.values().get(\"topic2\"),\n+                ThrottlingQuotaExceededException.class);\n+            assertEquals(0, e.throttleTimeMs());", "originalCommit": "0f8717f674680b0749ec36c84093aff247ffae74", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ3MzI3MA==", "url": "https://github.com/apache/kafka/pull/9344#discussion_r496473270", "bodyText": "Yeah, I do agree but this could happen even if this should be rare. This test case is a bit stretched to verify that throttle time does not go below zero.\nThe reasoning of doing this is that a client could be throttled for longer than default.api.timeout.ms. When this happens, I believe that we should return an adjusted throttle time such that the client does not have to re-wait for the time that it has already waited for.", "author": "dajac", "createdAt": "2020-09-29T07:23:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjE3NjQ3Mg=="}], "type": "inlineReview"}, {"oid": "af778cebd3094bd154e466ba9c2a5e05ec4297fb", "url": "https://github.com/apache/kafka/commit/af778cebd3094bd154e466ba9c2a5e05ec4297fb", "message": "only propagate back the error if the request timed out", "committedDate": "2020-09-29T08:49:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU3OTAwMw==", "url": "https://github.com/apache/kafka/pull/9344#discussion_r496579003", "bodyText": "Perhaps we could make this maybeCompleteQuotaExceededException and pass in the throwable, so that we can do the check for TimeoutException in that helper method rather than in every handleFailure?", "author": "rajinisivaram", "createdAt": "2020-09-29T09:36:32Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -1554,6 +1575,13 @@ private ConfigEntry configEntry(CreatableTopicConfigs config) {\n \n             @Override\n             void handleFailure(Throwable throwable) {\n+                // If there were any topics retries due to a quota exceeded exception, we propagate\n+                // the initial error back to the caller if the request timed out.\n+                if (options.shouldRetryOnQuotaViolation() && throwable instanceof TimeoutException) {\n+                    completeQuotaExceededException(futures, quotaExceededExceptions,", "originalCommit": "af778cebd3094bd154e466ba9c2a5e05ec4297fb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjY0NTU5OA==", "url": "https://github.com/apache/kafka/pull/9344#discussion_r496645598", "bodyText": "That's a very good suggestion, thanks.", "author": "dajac", "createdAt": "2020-09-29T11:35:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU3OTAwMw=="}], "type": "inlineReview"}, {"oid": "503e39180f57eb0d2fc71266ee54c3e97ac4b3a9", "url": "https://github.com/apache/kafka/commit/503e39180f57eb0d2fc71266ee54c3e97ac4b3a9", "message": "Address comment", "committedDate": "2020-09-29T11:34:38Z", "type": "commit"}]}