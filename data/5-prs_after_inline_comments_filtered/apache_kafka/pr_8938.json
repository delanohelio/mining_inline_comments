{"pr_number": 8938, "pr_title": "KAFKA-10173: Use SmokeTest for upgrade system tests", "pr_createdAt": "2020-06-27T18:08:15Z", "pr_url": "https://github.com/apache/kafka/pull/8938", "timeline": [{"oid": "e2d0b95650f597bf52d49a05f7d3fed8cc03080a", "url": "https://github.com/apache/kafka/commit/e2d0b95650f597bf52d49a05f7d3fed8cc03080a", "message": "KAFKA-10173: Use SmokeTest for upgrade system tests\n\nReplaces the previous upgrade test's trivial Streams app\nwith the commonly used SmokeTest, exercising many more\nfeatures. Also adjust the test matrix to test upgrading\nfrom each released version since 2.2 to the current branch.", "committedDate": "2020-07-01T14:33:29Z", "type": "commit"}, {"oid": "be475ec5ed5aa7b439713717d502f71ee643fc5e", "url": "https://github.com/apache/kafka/commit/be475ec5ed5aa7b439713717d502f71ee643fc5e", "message": "move new test to new file", "committedDate": "2020-07-01T15:01:05Z", "type": "commit"}, {"oid": "b6b296163adcd47a79ead6af55b7b7e1972c06fc", "url": "https://github.com/apache/kafka/commit/b6b296163adcd47a79ead6af55b7b7e1972c06fc", "message": "revamp upgrade test", "committedDate": "2020-07-01T16:07:12Z", "type": "commit"}, {"oid": "131f98db8faddf7342eda3e07fa612daba534fe3", "url": "https://github.com/apache/kafka/commit/131f98db8faddf7342eda3e07fa612daba534fe3", "message": "disable rolling upgrade test until compatible release 2.5.1 is done", "committedDate": "2020-07-01T16:08:56Z", "type": "commit"}, {"oid": "b1a54f0701be5304fc31ddffa6b1404f1aff9beb", "url": "https://github.com/apache/kafka/commit/b1a54f0701be5304fc31ddffa6b1404f1aff9beb", "message": "fix log copy; shouldn't clean state during upgrade", "committedDate": "2020-07-01T17:33:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU3MDc2MQ==", "url": "https://github.com/apache/kafka/pull/8938#discussion_r448570761", "bodyText": "Do we still need a shutdown hook to delete with file.deleteOnExit();? I think the latter can still be triggered even with abnormal exits.", "author": "guozhangwang", "createdAt": "2020-07-01T19:25:31Z", "path": "streams/src/test/java/org/apache/kafka/streams/tests/SmokeTestClient.java", "diffHunk": "@@ -38,107 +37,128 @@\n import org.apache.kafka.streams.kstream.Windowed;\n import org.apache.kafka.streams.state.Stores;\n import org.apache.kafka.streams.state.WindowStore;\n-import org.apache.kafka.test.TestUtils;\n \n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n import java.time.Duration;\n import java.time.Instant;\n import java.util.Properties;\n+import java.util.concurrent.CountDownLatch;\n+import java.util.concurrent.TimeUnit;\n \n import static org.apache.kafka.streams.kstream.Suppressed.untilWindowCloses;\n \n public class SmokeTestClient extends SmokeTestUtil {\n \n     private final String name;\n \n-    private Thread thread;\n     private KafkaStreams streams;\n     private boolean uncaughtException = false;\n-    private boolean started;\n-    private boolean closed;\n+    private volatile boolean closed;\n \n-    public SmokeTestClient(final String name) {\n-        super();\n-        this.name = name;\n+    private static void addShutdownHook(final String name, final Runnable runnable) {\n+        if (name != null) {\n+            Runtime.getRuntime().addShutdownHook(KafkaThread.nonDaemon(name, runnable));\n+        } else {\n+            Runtime.getRuntime().addShutdownHook(new Thread(runnable));\n+        }\n     }\n \n-    public boolean started() {\n-        return started;\n+    private static File tempDirectory() {\n+        final String prefix = \"kafka-\";\n+        final File file;\n+        try {\n+            file = Files.createTempDirectory(prefix).toFile();\n+        } catch (final IOException ex) {\n+            throw new RuntimeException(\"Failed to create a temp dir\", ex);\n+        }\n+        file.deleteOnExit();", "originalCommit": "b1a54f0701be5304fc31ddffa6b1404f1aff9beb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "0163c8023d3b9fc61df35c0428269ca2752e9e6f", "url": "https://github.com/apache/kafka/commit/0163c8023d3b9fc61df35c0428269ca2752e9e6f", "message": "Update streams/src/test/java/org/apache/kafka/streams/tests/SmokeTestClient.java", "committedDate": "2020-07-01T19:49:47Z", "type": "commit"}]}