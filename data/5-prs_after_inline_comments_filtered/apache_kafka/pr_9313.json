{"pr_number": 9313, "pr_title": "[mm2] Fix consumer/producer properties override", "pr_createdAt": "2020-09-21T14:59:34Z", "pr_url": "https://github.com/apache/kafka/pull/9313", "timeline": [{"oid": "c3de335f5a528302a1156f79202945dd9134fa3d", "url": "https://github.com/apache/kafka/commit/c3de335f5a528302a1156f79202945dd9134fa3d", "message": "[mm2] Fix consumer/producer/admin properties override", "committedDate": "2020-09-21T14:45:26Z", "type": "commit"}, {"oid": "d34777b2329aab08d393d8e3e07d64f007208538", "url": "https://github.com/apache/kafka/commit/d34777b2329aab08d393d8e3e07d64f007208538", "message": "Add tests for consumer/producer props override for MirrorConnectorConfig", "committedDate": "2020-09-25T15:06:07Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r495817180", "bodyText": "These changes are going to break existing users. For example, I have connectors with a few settings prefixed with consumer.. I wonder if we could keep the old behaviour (even if partially broken) while adding the proper prefixes", "author": "mimaison", "createdAt": "2020-09-28T09:46:23Z", "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorConnectorConfig.java", "diffHunk": "@@ -199,8 +199,8 @@\n \n     protected static final String SOURCE_CLUSTER_PREFIX = MirrorMakerConfig.SOURCE_CLUSTER_PREFIX;\n     protected static final String TARGET_CLUSTER_PREFIX = MirrorMakerConfig.TARGET_CLUSTER_PREFIX;\n-    protected static final String PRODUCER_CLIENT_PREFIX = \"producer.\";\n-    protected static final String CONSUMER_CLIENT_PREFIX = \"consumer.\";\n+    protected static final String PRODUCER_CLIENT_PREFIX = SOURCE_CLUSTER_PREFIX + \"producer.\";\n+    protected static final String CONSUMER_CLIENT_PREFIX = SOURCE_CLUSTER_PREFIX + \"consumer.\";", "originalCommit": "d34777b2329aab08d393d8e3e07d64f007208538", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3MTAxNw==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r495871017", "bodyText": "I'm not sure if I follow it. This prefix \"source_cluster\" is not user specified. It is prefixed somewhere else by mm2 (I can get the lines if you want later on). The config specified here will actually be honored. It does not imply changes on the MirrorMaker config side at least. Are you talking about the case of running MirrorMaker in a connect cluster rather than as a dedicated cluster? I didn't check that one TBH. Maybe @ryannedolan has more insight on this one?", "author": "scanterog", "createdAt": "2020-09-28T11:30:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk3NTcyMQ==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r495975721", "bodyText": "Yes I'm running MM2 in a Connect cluster.", "author": "mimaison", "createdAt": "2020-09-28T14:19:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk5NTIyNA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r495995224", "bodyText": "Gotcha. I just peek'd at it again and you're right. It seems the proper fix would be to fix the way mm2 populates the MirrorConnectorConfig to avoid this change. WDYT @ryannedolan ? Not sure how involved this change would be.", "author": "scanterog", "createdAt": "2020-09-28T14:45:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzA3OTMyMA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r497079320", "bodyText": "I have put a new fix that should handle both cases. Details on why I think this is a reasonable fix:\n\nThere's no change on what is defined here. The properties that starts with producer. or consumer. are still ignored in mm2 dedicated mode.\nMM2 needs to differentiate the properties for the source cluster and we can't just remove the source.cluster prefix.\nFor running the mirror connectors on a Connect cluster, the only \"drawback\" is that now you can provide an override with source.cluster.consumer or source.cluster.producer.", "author": "scanterog", "createdAt": "2020-09-29T21:45:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5MDEyMg==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r498290122", "bodyText": "It's unfortunate for admin we use source.admin as the prefix ...\nSo we'd be left with a configuration like:\n\"source.cluster.bootstrap.servers\": \"localhost:9092\",\n\"source.cluster.security.protocol\": \"SASL_SSL\",\n\"source.cluster.producer.some-producer-setting\": 123,\n\"source.cluster.consumer.some-consumer-setting\": 123,\n\"source.admin.some-admin-setting\": 123", "author": "mimaison", "createdAt": "2020-10-01T14:30:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5ODk4Nw==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r498298987", "bodyText": "Maybe not including cluster for all the client specific settings would be slightly better, WDYT?\n\"source.cluster.bootstrap.servers\": \"localhost:9092\",\n\"source.cluster.security.protocol\": \"SASL_SSL\",\n\"source.producer.some-producer-setting\": 123,\n\"source.consumer.some-consumer-setting\": 123,\n\"source.admin.some-admin-setting\": 123", "author": "mimaison", "createdAt": "2020-10-01T14:42:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5OTQ5Mw==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r498299493", "bodyText": "For connect, you can still use (or the one you've shared).\n\"source.cluster.bootstrap.servers\": \"localhost:9092\",\n\"source.cluster.security.protocol\": \"SASL_SSL\",\n\"producer.some-producer-setting\": 123\n\"consumer.some-consumer-setting\": 123\n\"source.admin.some-admin-setting\": 123\n\nYes, we could normalize that but I'm not touching admin config in this PR.", "author": "scanterog", "createdAt": "2020-10-01T14:42:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODk3MTA2OQ==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r498971069", "bodyText": "Maybe not including cluster for all the client specific settings would be slightly better, WDYT?\n\nSomehow I missed this. I do not have a strong opinion on that but I do like the idea on normalizing it. But changing that will still break existing users though. How do you want to proceed?", "author": "scanterog", "createdAt": "2020-10-02T18:03:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NDgwNA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r500464804", "bodyText": "@mimaison just a friendly ping.", "author": "scanterog", "createdAt": "2020-10-06T17:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2MjY4NA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r500562684", "bodyText": "I don't think the format mentioned in #9313 (comment) would break compatibility.", "author": "mimaison", "createdAt": "2020-10-06T20:03:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2NjgzOQ==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r500566839", "bodyText": "For users running on a Connect cluster, that format is not supported right now:\nsource.producer.some-producer-setting: 123\n\nThe only supported is (unless I'm missing something):\n\"producer.some-producer-setting\": 123", "author": "scanterog", "createdAt": "2020-10-06T20:11:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2ODM1Nw==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r500568357", "bodyText": "I meant add support for that format. We obviously want to keep supporting the existing formats", "author": "mimaison", "createdAt": "2020-10-06T20:13:52Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU2OTU2Nw==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r500569567", "bodyText": "\ud83e\udd26 got it. I misunderstood it. Let me give it a try.", "author": "scanterog", "createdAt": "2020-10-06T20:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTMyNjY4MA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r501326680", "bodyText": "I think the new code does what we want. Also tested a bin from this on my infra and it is working fine. Let me know if this works for you.", "author": "scanterog", "createdAt": "2020-10-07T21:42:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzE4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTgxNzg2Mw==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r495817863", "bodyText": "While we're at it, could we also add tests for targetAdminConfig() and sourceAdminConfig()?", "author": "mimaison", "createdAt": "2020-09-28T09:47:33Z", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorConfigTest.java", "diffHunk": "@@ -119,4 +120,41 @@ public void testNonMutationOfConfigDef() {\n             connectorConfigDef.names().contains(taskSpecificProperty)\n         ));\n     }\n+\n+    @Test\n+    public void testSourceConsumerConfig() {\n+        Map<String, String> connectorProps = makeProps(\n+                MirrorConnectorConfig.CONSUMER_CLIENT_PREFIX + \"max.poll.interval.ms\", \"120000\"\n+        );\n+        MirrorConnectorConfig config = new MirrorConnectorConfig(connectorProps);\n+        Map<String, Object> connectorConsumerProps = config.sourceConsumerConfig();\n+        Map<String, Object> expectedConsumerProps = new HashMap<>();\n+        expectedConsumerProps.put(\"enable.auto.commit\", \"false\");\n+        expectedConsumerProps.put(\"auto.offset.reset\", \"earliest\");\n+        expectedConsumerProps.put(\"max.poll.interval.ms\", \"120000\");\n+        assertEquals(expectedConsumerProps, connectorConsumerProps);\n+\n+        // checking auto.offset.reset override works\n+        connectorProps = makeProps(\n+                MirrorConnectorConfig.CONSUMER_CLIENT_PREFIX + \"auto.offset.reset\", \"latest\"\n+        );\n+        config = new MirrorConnectorConfig(connectorProps);\n+        connectorConsumerProps = config.sourceConsumerConfig();\n+        expectedConsumerProps.put(\"auto.offset.reset\", \"latest\");\n+        expectedConsumerProps.remove(\"max.poll.interval.ms\");\n+        assertEquals(expectedConsumerProps, connectorConsumerProps);\n+    }\n+\n+    @Test\n+    public void testSourceProducerConfig() {\n+        Map<String, String> connectorProps = makeProps(\n+                MirrorConnectorConfig.PRODUCER_CLIENT_PREFIX + \"acks\", \"1\"\n+        );\n+        MirrorConnectorConfig config = new MirrorConnectorConfig(connectorProps);\n+        Map<String, Object> connectorProducerProps = config.sourceProducerConfig();\n+        Map<String, Object> expectedProducerProps = new HashMap<>();\n+        expectedProducerProps.put(\"acks\", \"1\");\n+        assertEquals(expectedProducerProps, connectorProducerProps);\n+    }\n+", "originalCommit": "d34777b2329aab08d393d8e3e07d64f007208538", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a4e3bffa9722d88d1e9ba68dd77c28a553d8dae", "url": "https://github.com/apache/kafka/commit/1a4e3bffa9722d88d1e9ba68dd77c28a553d8dae", "message": "Handle MirrorConnectConfig override for Connect and mm2 dedicated mode", "committedDate": "2020-09-29T21:44:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI5MTkxNg==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r498291916", "bodyText": "We should test settings with the source.cluster. prefix too. Same in the test below", "author": "mimaison", "createdAt": "2020-10-01T14:32:55Z", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorConnectorConfigTest.java", "diffHunk": "@@ -119,4 +120,41 @@ public void testNonMutationOfConfigDef() {\n             connectorConfigDef.names().contains(taskSpecificProperty)\n         ));\n     }\n+\n+    @Test\n+    public void testSourceConsumerConfig() {", "originalCommit": "1a4e3bffa9722d88d1e9ba68dd77c28a553d8dae", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "4628c909b3d0d576c988f45c66ec800dd0cd291c", "url": "https://github.com/apache/kafka/commit/4628c909b3d0d576c988f45c66ec800dd0cd291c", "message": "[mm2] Normalize producer/consumer props plus tests", "committedDate": "2020-10-07T18:59:09Z", "type": "commit"}, {"oid": "d6e4d060bc0cb446ef1f493fae3d0a9426227e02", "url": "https://github.com/apache/kafka/commit/d6e4d060bc0cb446ef1f493fae3d0a9426227e02", "message": "[mm2] Add tests for {source,target}AdminConfig", "committedDate": "2020-10-07T21:39:00Z", "type": "commit"}, {"oid": "41fecbefd91ea01066d8d808c47431cc24dabbc9", "url": "https://github.com/apache/kafka/commit/41fecbefd91ea01066d8d808c47431cc24dabbc9", "message": "[mm2] Fix tests for testClusterConfigProperties", "committedDate": "2020-10-08T14:30:54Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDMyMQ==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r502264321", "bodyText": "I was not expecting to see changes in existing tests if we are not breaking compatibility, source.cluster.bootstrap.servers should continue working and still be tested", "author": "mimaison", "createdAt": "2020-10-09T08:17:02Z", "path": "connect/mirror/src/test/java/org/apache/kafka/connect/mirror/MirrorMakerConfigTest.java", "diffHunk": "@@ -52,10 +52,10 @@ public void testClusterConfigProperties() {\n             \"replication.factor\", \"4\"));\n         Map<String, String> connectorProps = mirrorConfig.connectorBaseConfig(new SourceAndTarget(\"a\", \"b\"),\n             MirrorSourceConnector.class);\n-        assertEquals(\"source.cluster.bootstrap.servers is set\",\n-            \"servers-one\", connectorProps.get(\"source.cluster.bootstrap.servers\"));\n-        assertEquals(\"target.cluster.bootstrap.servers is set\",\n-            \"servers-two\", connectorProps.get(\"target.cluster.bootstrap.servers\"));\n+        assertEquals(\"source.bootstrap.servers is set\",", "originalCommit": "41fecbefd91ea01066d8d808c47431cc24dabbc9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjM1MTkzMA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r502351930", "bodyText": "That will require more changes. This does not break for the mirrorMaker driver main config. I guess it does for on Connect though", "author": "scanterog", "createdAt": "2020-10-09T11:02:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDMyMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzQ4OTI4MA==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r503489280", "bodyText": "I think I have achieved what we want. Explicitly setting \"source.\" prefix for props starting with consumer|producer|admin and setting \"source.cluster.\" otherwise. All tests passed. The code runs fine on my infra.\n@mimaison please take a look whenever you get some time :)", "author": "scanterog", "createdAt": "2020-10-12T19:25:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI2NDMyMQ=="}], "type": "inlineReview"}, {"oid": "dfc668222239a7be286ed843880093725e587402", "url": "https://github.com/apache/kafka/commit/dfc668222239a7be286ed843880093725e587402", "message": "[mm2] Diff prefix for producer|consumer|admin props", "committedDate": "2020-10-12T17:52:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyMzk4MQ==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r505423981", "bodyText": "Can we find a better name for these 2 new methods? Something like clusterConfigsWithPrefix() and clientConfigsWithPrefix()?", "author": "mimaison", "createdAt": "2020-10-15T10:10:12Z", "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorMakerConfig.java", "diffHunk": "@@ -245,10 +254,17 @@ public MirrorClientConfig clientConfig(String cluster) {\n         Map<String, String> strings = originalsStrings();\n         strings.keySet().removeIf(x -> !x.startsWith(prefix));\n         return strings;\n-    } \n+    }\n+\n+    static Map<String, String> prefixForGeneralAttrs(String prefix, Map<String, String> props) {", "originalCommit": "dfc668222239a7be286ed843880093725e587402", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTUxMjk0Mg==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r505512942", "bodyText": "Indeed. Thanks!", "author": "scanterog", "createdAt": "2020-10-15T12:48:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyMzk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTQyNjAyMg==", "url": "https://github.com/apache/kafka/pull/9313#discussion_r505426022", "bodyText": "We could get rid of SOURCE_ADMIN_CLIENT_PREFIX and TARGET_ADMIN_CLIENT_PREFIX and instead use SOURCE_PREFIX + ADMIN_CLIENT_PREFIX or TARGET_PREFIX + ADMIN_CLIENT_PREFIX in the method getting Admin Client configs so they are the similar to the Producer and Consumer methods", "author": "mimaison", "createdAt": "2020-10-15T10:13:53Z", "path": "connect/mirror/src/main/java/org/apache/kafka/connect/mirror/MirrorConnectorConfig.java", "diffHunk": "@@ -199,6 +199,8 @@\n \n     protected static final String SOURCE_CLUSTER_PREFIX = MirrorMakerConfig.SOURCE_CLUSTER_PREFIX;\n     protected static final String TARGET_CLUSTER_PREFIX = MirrorMakerConfig.TARGET_CLUSTER_PREFIX;\n+    protected static final String SOURCE_PREFIX = MirrorMakerConfig.SOURCE_PREFIX;\n+    protected static final String TARGET_PREFIX = MirrorMakerConfig.TARGET_PREFIX;\n     protected static final String PRODUCER_CLIENT_PREFIX = \"producer.\";\n     protected static final String CONSUMER_CLIENT_PREFIX = \"consumer.\";\n     protected static final String ADMIN_CLIENT_PREFIX = \"admin.\";", "originalCommit": "dfc668222239a7be286ed843880093725e587402", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "b5e55af9354cc9fddeb83be5701875948eb0c971", "url": "https://github.com/apache/kafka/commit/b5e55af9354cc9fddeb83be5701875948eb0c971", "message": "[mm2] Better methods names and normalize client prefixes", "committedDate": "2020-10-15T12:42:29Z", "type": "commit"}]}