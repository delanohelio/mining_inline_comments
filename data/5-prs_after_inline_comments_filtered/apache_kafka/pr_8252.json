{"pr_number": 8252, "pr_title": "KAFKA-6145: Pt 2.5 Compute overall task lag per client", "pr_createdAt": "2020-03-07T21:08:09Z", "pr_url": "https://github.com/apache/kafka/pull/8252", "timeline": [{"oid": "d83f64be9f93ce9d0f79a23d089042dd3de1f269", "url": "https://github.com/apache/kafka/commit/d83f64be9f93ce9d0f79a23d089042dd3de1f269", "message": "get admin from assignor config and add offset sums to ClientState\nfetch end offsets\nadd lag to each clienttate\nbuild ranks\nadd ClientState tests\nadd tests for building client rankings\nfall back to prev assignment if fetching offsets fails", "committedDate": "2020-03-19T18:32:43Z", "type": "forcePushed"}, {"oid": "c937bfb6e4ff1a3f1ebb558ba7a9aad2baf9fdd4", "url": "https://github.com/apache/kafka/commit/c937bfb6e4ff1a3f1ebb558ba7a9aad2baf9fdd4", "message": "get admin from assignor config and add offset sums to ClientState\nfetch end offsets\nadd lag to each clienttate\nbuild ranks\nadd ClientState tests\nadd tests for building client rankings\nfall back to prev assignment if fetching offsets fails", "committedDate": "2020-03-20T19:24:42Z", "type": "commit"}, {"oid": "a86546e386fa885fba55c68bb6ee9d529c0e8329", "url": "https://github.com/apache/kafka/commit/a86546e386fa885fba55c68bb6ee9d529c0e8329", "message": "rank UNKNOWN_OFFSET_SUM behind caught-up clients, but above others", "committedDate": "2020-03-20T19:26:07Z", "type": "commit"}, {"oid": "e67aaef709572c7320869e38e23fac0fef87e354", "url": "https://github.com/apache/kafka/commit/e67aaef709572c7320869e38e23fac0fef87e354", "message": "can't resist further assignor test cleanup", "committedDate": "2020-03-20T19:26:07Z", "type": "commit"}, {"oid": "5a5f53faff235167d05c18b7ceb06cbf12b44af5", "url": "https://github.com/apache/kafka/commit/5a5f53faff235167d05c18b7ceb06cbf12b44af5", "message": "don't violate active task stickiness if offset fetch fails and add tests", "committedDate": "2020-03-20T19:26:07Z", "type": "commit"}, {"oid": "3cf72e06965a476424cd40f213958c67306f66ea", "url": "https://github.com/apache/kafka/commit/3cf72e06965a476424cd40f213958c67306f66ea", "message": "timeout admin client request", "committedDate": "2020-03-20T19:26:07Z", "type": "commit"}, {"oid": "3cf72e06965a476424cd40f213958c67306f66ea", "url": "https://github.com/apache/kafka/commit/3cf72e06965a476424cd40f213958c67306f66ea", "message": "timeout admin client request", "committedDate": "2020-03-20T19:26:07Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3OTYyNg==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395879626", "bodyText": "The fact that this is static and has nothing in particular to do with the KafkaStreams class indicates that it probably belongs in a util class for use by KafkaStreams and StreamsPartitionAssignor.", "author": "vvcephei", "createdAt": "2020-03-20T20:40:50Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -1244,4 +1238,28 @@ public void cleanUp() {\n \n         return Collections.unmodifiableMap(localStorePartitionLags);\n     }\n+\n+    static Map<TopicPartition, ListOffsetsResultInfo> fetchEndOffsetsWithoutTimeout(final Collection<TopicPartition> partitions,\n+                                                                                    final Admin adminClient) {\n+        return fetchEndOffsets(partitions, adminClient, null);\n+    }\n+\n+    public static Map<TopicPartition, ListOffsetsResultInfo> fetchEndOffsets(final Collection<TopicPartition> partitions,\n+                                                                             final Admin adminClient,\n+                                                                             final Duration timeout) {\n+        final Map<TopicPartition, ListOffsetsResultInfo> endOffsets;\n+        try {\n+            final KafkaFuture<Map<TopicPartition, ListOffsetsResultInfo>> future =  adminClient.listOffsets(\n+                partitions.stream().collect(Collectors.toMap(Function.identity(), tp -> OffsetSpec.latest())))\n+                                                                                        .all();\n+            if (timeout == null) {\n+                endOffsets = future.get();\n+            } else {\n+                endOffsets = future.get(timeout.toMillis(), TimeUnit.MILLISECONDS);\n+            }\n+        } catch (final TimeoutException | RuntimeException | InterruptedException | ExecutionException e) {\n+            throw new StreamsException(\"Unable to obtain end offsets from kafka\", e);\n+        }\n+        return endOffsets;\n+    }", "originalCommit": "3cf72e06965a476424cd40f213958c67306f66ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxNTY3Nw==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395915677", "bodyText": "Ack", "author": "ableegoldman", "createdAt": "2020-03-20T22:25:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3OTYyNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjEzODU4OA==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r396138588", "bodyText": "See #8328", "author": "ableegoldman", "createdAt": "2020-03-22T20:42:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg3OTYyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg4Njg3Ng==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395886876", "bodyText": "I couldn't find the reason these needed to change. What did I miss? Is it just that they are nullable if the config is unspecified?", "author": "vvcephei", "createdAt": "2020-03-20T20:58:41Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/AssignorConfiguration.java", "diffHunk": "@@ -263,11 +276,11 @@ public AssignmentConfigs getAssignmentConfigs() {\n     }\n \n     public static class AssignmentConfigs {\n-        public final long acceptableRecoveryLag;\n-        public final int balanceFactor;\n-        public final int maxWarmupReplicas;\n-        public final int numStandbyReplicas;\n-        public final long probingRebalanceIntervalMs;\n+        public final Long acceptableRecoveryLag;\n+        public final Integer balanceFactor;\n+        public final Integer maxWarmupReplicas;\n+        public final Integer numStandbyReplicas;\n+        public final Long probingRebalanceIntervalMs;", "originalCommit": "3cf72e06965a476424cd40f213958c67306f66ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwODg2OQ==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395908869", "bodyText": "Uhh...hm. I remember doing it for a reason, but not what that reason was (probably something-something-testing?).\nWhatever it was it doesn't seem to be relevant anymore, I'll revert this", "author": "ableegoldman", "createdAt": "2020-03-20T22:01:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTg4Njg3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzI2NA==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395903264", "bodyText": "Does this test pass on the current code base, or is it a consequence of this PR?", "author": "vvcephei", "createdAt": "2020-03-20T21:44:04Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/StickyTaskAssignorTest.java", "diffHunk": "@@ -674,6 +674,19 @@ public void shouldAssignTasksToNewClientWithoutFlippingAssignmentBetweenExisting\n         assertThat(newClient.activeTaskCount(), equalTo(2));\n     }\n \n+    @Test\n+    public void shouldViolateBalanceToPreserveActiveTaskStickiness() {", "originalCommit": "3cf72e06965a476424cd40f213958c67306f66ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkxMjk4MQ==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395912981", "bodyText": "It's testing the newly added #preservePreviousTaskAssignment: this is sort of a temporary hack to force the StickyTaskAssignor to return a \"completely sticky\" active task assignment, in the case the admin listOffsets request fails or times out.\nThe default StickyTaskAssignor behavior is unchanged in this PR, to leave the code in a stable state and avoid adding a huge refactoring of StickyTaskAssignorTest to an already large PR.", "author": "ableegoldman", "createdAt": "2020-03-20T22:15:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzI2NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkzMzI5Nw==", "url": "https://github.com/apache/kafka/pull/8252#discussion_r395933297", "bodyText": "Ok, thanks. The subtlety was a bit lost on me.", "author": "vvcephei", "createdAt": "2020-03-20T23:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTkwMzI2NA=="}], "type": "inlineReview"}, {"oid": "bb5ea3000bb0e02413da92f2a7cf162809e4d31b", "url": "https://github.com/apache/kafka/commit/bb5ea3000bb0e02413da92f2a7cf162809e4d31b", "message": "remove extra space", "committedDate": "2020-03-20T22:46:07Z", "type": "commit"}, {"oid": "e3dc2a52378efe7bb111982c725760bb4e7a1e9d", "url": "https://github.com/apache/kafka/commit/e3dc2a52378efe7bb111982c725760bb4e7a1e9d", "message": "unbox assignment configs", "committedDate": "2020-03-20T23:32:04Z", "type": "commit"}]}