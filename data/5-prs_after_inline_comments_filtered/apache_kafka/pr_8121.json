{"pr_number": 8121, "pr_title": "KAFKA-6145: Pt 1. Bump protocol version and encode task lag map", "pr_createdAt": "2020-02-15T01:58:49Z", "pr_url": "https://github.com/apache/kafka/pull/8121", "timeline": [{"oid": "5a67b592c6947c20f07f116037cc1ed159a06d50", "url": "https://github.com/apache/kafka/commit/5a67b592c6947c20f07f116037cc1ed159a06d50", "message": "use taskLags to infer prev/standby tasks if necessary", "committedDate": "2020-03-04T20:25:22Z", "type": "commit"}, {"oid": "8b45f78aee5bcb3fa49830e1256ed2121fdd28be", "url": "https://github.com/apache/kafka/commit/8b45f78aee5bcb3fa49830e1256ed2121fdd28be", "message": "fixing up tests", "committedDate": "2020-03-04T20:25:22Z", "type": "commit"}, {"oid": "b4d91a85a7eabbfdf2e0ebfa59d3e411302e7a88", "url": "https://github.com/apache/kafka/commit/b4d91a85a7eabbfdf2e0ebfa59d3e411302e7a88", "message": "cleaned up task manager and subscription code, compiles", "committedDate": "2020-03-04T20:25:22Z", "type": "commit"}, {"oid": "2aabf29def59f348ce2abdb60771d8d60878e220", "url": "https://github.com/apache/kafka/commit/2aabf29def59f348ce2abdb60771d8d60878e220", "message": "bump assignment version handling", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "f510057179581229975f58666352c20077571f68", "url": "https://github.com/apache/kafka/commit/f510057179581229975f58666352c20077571f68", "message": "add subscription info tests", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "c063dc42a6412815367fbb0dd6557c2e20cae05b", "url": "https://github.com/apache/kafka/commit/c063dc42a6412815367fbb0dd6557c2e20cae05b", "message": "fix assignmentinfo test", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "424af9ae596cd2bb74869a577168a55f0254db72", "url": "https://github.com/apache/kafka/commit/424af9ae596cd2bb74869a577168a55f0254db72", "message": "fixing up tests", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "cac1f396386ecdba75930bff372ce18c8c05abda", "url": "https://github.com/apache/kafka/commit/cac1f396386ecdba75930bff372ce18c8c05abda", "message": "null check task", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "72ecf580c005deb312828bde7567f96b170663f2", "url": "https://github.com/apache/kafka/commit/72ecf580c005deb312828bde7567f96b170663f2", "message": "github reivew: main code", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "c2da9f7cd5088a3c7f78f6ab77c522a0fc4163d1", "url": "https://github.com/apache/kafka/commit/c2da9f7cd5088a3c7f78f6ab77c522a0fc4163d1", "message": "remove 'paior' from name", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "a37a8eb48cf12223d052c23319965ca96d6dba9a", "url": "https://github.com/apache/kafka/commit/a37a8eb48cf12223d052c23319965ca96d6dba9a", "message": "Github suggestions\n\nCo-Authored-By: Bruno Cadonna <bruno@confluent.io>", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "40e20e352f46b7be84058c9859004a0106592eef", "url": "https://github.com/apache/kafka/commit/40e20e352f46b7be84058c9859004a0106592eef", "message": "use offset sum instead of lag", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "7d8bdc21fa4f36c01f54884f8bd2fada0b135da2", "url": "https://github.com/apache/kafka/commit/7d8bdc21fa4f36c01f54884f8bd2fada0b135da2", "message": "fix names", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "e4e941f8dacb35590b9ff247a0eed9bf8a54a28d", "url": "https://github.com/apache/kafka/commit/e4e941f8dacb35590b9ff247a0eed9bf8a54a28d", "message": "github review", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "0fe088a5e16694ba008c4f16f4face445bda28b6", "url": "https://github.com/apache/kafka/commit/0fe088a5e16694ba008c4f16f4face445bda28b6", "message": "bump version in VP system test", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "361e4496245017a7301d481934d6a8aafc8f0d80", "url": "https://github.com/apache/kafka/commit/361e4496245017a7301d481934d6a8aafc8f0d80", "message": "review", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "951c245be7fbbe3a43c96b7f4f21956593ef0613", "url": "https://github.com/apache/kafka/commit/951c245be7fbbe3a43c96b7f4f21956593ef0613", "message": "checkstyle", "committedDate": "2020-03-04T20:25:23Z", "type": "commit"}, {"oid": "951c245be7fbbe3a43c96b7f4f21956593ef0613", "url": "https://github.com/apache/kafka/commit/951c245be7fbbe3a43c96b7f4f21956593ef0613", "message": "checkstyle", "committedDate": "2020-03-04T20:25:23Z", "type": "forcePushed"}, {"oid": "41d70a24b09f6c500ab0db780ec723a5b5003c1f", "url": "https://github.com/apache/kafka/commit/41d70a24b09f6c500ab0db780ec723a5b5003c1f", "message": "only encode RUNNING active tasks as -1", "committedDate": "2020-03-04T20:35:34Z", "type": "commit"}, {"oid": "aeebfa8b60f7d99c36cd0b3854ae3700bd25f5d3", "url": "https://github.com/apache/kafka/commit/aeebfa8b60f7d99c36cd0b3854ae3700bd25f5d3", "message": "fix javadocs", "committedDate": "2020-03-04T20:39:00Z", "type": "commit"}, {"oid": "16be04627aec19705a439a75b20a2a68ea08ded6", "url": "https://github.com/apache/kafka/commit/16be04627aec19705a439a75b20a2a68ea08ded6", "message": "reuse existing Task.LATEST_OFFSET for active running task sentinel offset", "committedDate": "2020-03-04T21:49:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NzQ1Nw==", "url": "https://github.com/apache/kafka/pull/8121#discussion_r388557457", "bodyText": "looks like maybe we have duelling code formatters. Not sure which choice makes more sense.", "author": "vvcephei", "createdAt": "2020-03-05T20:50:15Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/SubscriptionInfoTest.java", "diffHunk": "@@ -274,14 +279,31 @@ public void shouldEncodeAndDecodeSmallerLatestSupportedVersion() {\n         final int usedVersion = LATEST_SUPPORTED_VERSION - 1;\n         final int latestSupportedVersion = LATEST_SUPPORTED_VERSION - 1;\n \n-        final SubscriptionInfo info = new SubscriptionInfo(usedVersion, latestSupportedVersion, processId, activeTasks, standbyTasks, \"localhost:80\");\n-        final SubscriptionInfo expectedInfo = new SubscriptionInfo(usedVersion, latestSupportedVersion, processId, activeTasks, standbyTasks, \"localhost:80\");\n+        final SubscriptionInfo info =\n+            new SubscriptionInfo(usedVersion, latestSupportedVersion, processId, \"localhost:80\", TASK_OFFSET_SUMS);\n+        final SubscriptionInfo expectedInfo =\n+            new SubscriptionInfo(usedVersion, latestSupportedVersion, processId, \"localhost:80\", TASK_OFFSET_SUMS);\n         assertEquals(expectedInfo, SubscriptionInfo.decode(info.encode()));\n     }\n \n+    @Test\n+    public void shouldEncodeAndDecodeVersion7() {\n+        final SubscriptionInfo info =\n+            new SubscriptionInfo(7, LATEST_SUPPORTED_VERSION, processId, \"localhost:80\", TASK_OFFSET_SUMS);\n+        assertThat(info, is(SubscriptionInfo.decode(info.encode())));\n+    }\n+\n+    @Test\n+    public void shouldConvertTaskOffsetSumMapToTaskSetsForOlderVersion() {\n+        final SubscriptionInfo info =\n+            new SubscriptionInfo(7, LATEST_SUPPORTED_VERSION, processId, \"localhost:80\", TASK_OFFSET_SUMS);\n+        assertThat(info.prevTasks(), is(ACTIVE_TASKS));\n+        assertThat(info.standbyTasks(), is(STANDBY_TASKS));\n+    }\n+\n     private static ByteBuffer encodeFutureVersion() {\n         final ByteBuffer buf = ByteBuffer.allocate(4 /* used version */\n-                                                       + 4 /* supported version */);", "originalCommit": "16be04627aec19705a439a75b20a2a68ea08ded6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5MTcwOQ==", "url": "https://github.com/apache/kafka/pull/8121#discussion_r388591709", "bodyText": "Sounds like you think the other choice makes more sense \ud83d\ude1c Honestly neither of them looks that good to me but I'll revert the reformatting", "author": "ableegoldman", "createdAt": "2020-03-05T21:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1NzQ1Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1OTU2Mg==", "url": "https://github.com/apache/kafka/pull/8121#discussion_r388559562", "bodyText": "I'm just a tiny bit uncomfortable with re-using that sentinel, because the correctness of our logic depends on the active sentinel being less than the standby sentinel, so it must be less than zero. Do we have a reason to believe that Task.LATEST_OFFSET would never change to a number that would spoil us here, such as zero?", "author": "vvcephei", "createdAt": "2020-03-05T20:54:11Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -354,11 +355,27 @@ void handleLostAll() {\n         }\n     }\n \n+    /**\n+     * @return Map from task id to its total offset summed across all state stores\n+     */\n+    public Map<TaskId, Long> getTaskOffsetSums() {\n+        final Map<TaskId, Long> taskOffsetSums = new HashMap<>();\n+\n+        for (final TaskId id : tasksOnLocalStorage()) {\n+            if (isRunning(id)) {\n+                taskOffsetSums.put(id, Task.LATEST_OFFSET);", "originalCommit": "16be04627aec19705a439a75b20a2a68ea08ded6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU5NTgyNg==", "url": "https://github.com/apache/kafka/pull/8121#discussion_r388595826", "bodyText": "I actually changed this based on working on the next PR, as Task#changelogOffsets uses this sentinel for exactly the same thing, ie an indicator that the task is running (and active). This is only used in computing the lag info for KIP-535, which has a similar desire to differentiate between a running task that is completely caught up and any other. So, I can't imagine this being changed -- but I can add a comment to the constant explaining it should always be negative (not sure why it's \"-2\" specifically, as opposed to \"-1\", do you?)", "author": "ableegoldman", "createdAt": "2020-03-05T22:08:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODU1OTU2Mg=="}], "type": "inlineReview"}, {"oid": "cce68476ac15ff67bc5db4a49945170f73da076f", "url": "https://github.com/apache/kafka/commit/cce68476ac15ff67bc5db4a49945170f73da076f", "message": "github review", "committedDate": "2020-03-05T22:24:49Z", "type": "commit"}, {"oid": "36b94cc2d87783c943f3189965ad25fb88ae7748", "url": "https://github.com/apache/kafka/commit/36b94cc2d87783c943f3189965ad25fb88ae7748", "message": "encode task id offset mapcompactly", "committedDate": "2020-03-05T23:03:25Z", "type": "commit"}, {"oid": "f0f20224659759d920218cf9be2ac91a6dc3d6ae", "url": "https://github.com/apache/kafka/commit/f0f20224659759d920218cf9be2ac91a6dc3d6ae", "message": "fx NPE", "committedDate": "2020-03-05T23:09:54Z", "type": "commit"}, {"oid": "9c1849c0c1506c3db22a16d0954faf76135b89e2", "url": "https://github.com/apache/kafka/commit/9c1849c0c1506c3db22a16d0954faf76135b89e2", "message": "fix VP upgrade test", "committedDate": "2020-03-05T23:38:21Z", "type": "commit"}]}