{"pr_number": 8887, "pr_title": "KAFKA-10135: Extract Task#executeAndMaybeSwallow to be a general utility function into TaskManager\u2026", "pr_createdAt": "2020-06-17T10:52:00Z", "pr_url": "https://github.com/apache/kafka/pull/8887", "timeline": [{"oid": "f0e267ac0be0fef1af2dacbae6a9af5350ba3a6b", "url": "https://github.com/apache/kafka/commit/f0e267ac0be0fef1af2dacbae6a9af5350ba3a6b", "message": "Extract Task#executeAndMaybeSwallow to be a general utility function into TaskManager", "committedDate": "2020-06-17T10:38:21Z", "type": "commit"}, {"oid": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446", "url": "https://github.com/apache/kafka/commit/4f8360aff1b0fb964515ad87ef37d7f2d1e4e446", "message": "Merge branch 'trunk' into KAFKA-10135", "committedDate": "2020-06-17T11:05:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r441468868", "bodyText": "At first thought, the not clean case normally just do some logs. with only the log string different,  I would like to still use the executeAndMaybeSwallow  in Task.scala, but since callers may need different log levels or they may want do more than just a log, so just pass a more generic argument actionIfNotClean.\nAnd yeah, java.util.function.Consumer looks ugly but I am not aware of some elegant way for import alias...", "author": "feyman2016", "createdAt": "2020-06-17T11:14:39Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -1048,4 +1042,28 @@ public String toString(final String indent) {\n     Set<TaskId> lockedTaskDirectories() {\n         return Collections.unmodifiableSet(lockedTaskDirectories);\n     }\n+\n+    public static void executeAndMaybeSwallow(final boolean clean,\n+                                              final Runnable runnable,\n+                                              final java.util.function.Consumer<RuntimeException> actionIfClean,\n+                                              final java.util.function.Consumer<RuntimeException> actionIfNotClean) {", "originalCommit": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NDI0NQ==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r441954245", "bodyText": "It seems not possible in Java", "author": "abbccdda", "createdAt": "2020-06-18T03:56:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU3NDU3NA==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r442574574", "bodyText": "I am wondering if adding this method to TaskManager is the best choice (cf https://issues.apache.org/jira/browse/KAFKA-10055). Thoughts?", "author": "mjsax", "createdAt": "2020-06-19T00:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzA5NjQwMg==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r443096402", "bodyText": "@abbccdda :(\n@mjsax\nI have similar thoughts when doing this, but I don't know enough context to decide whether this method is general enough to be extracted out to a utility class. If there are more similar static methods in other places, then I think we should put it in the utility class.", "author": "feyman2016", "createdAt": "2020-06-20T03:17:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mzc2ODU3MQ==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r443768571", "bodyText": "I am also fine to just merge this as-is, and refactor via KAFKA-10055.\n\\cc @abbccdda WDYT?", "author": "mjsax", "createdAt": "2020-06-22T19:08:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzgzNzgzNw==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r443837837", "bodyText": "I'm fine as well, will make a reference to 10055 of this PR", "author": "abbccdda", "createdAt": "2020-06-22T21:31:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ2ODg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NDgyOQ==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r441954829", "bodyText": "could be replaced by lambda.", "author": "abbccdda", "createdAt": "2020-06-18T03:58:43Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -741,29 +741,23 @@ void shutdown(final boolean clean) {\n \n         for (final Task task : tasks.values()) {\n             if (task.isActive()) {\n-                try {\n-                    activeTaskCreator.closeAndRemoveTaskProducerIfNeeded(task.id());\n-                } catch (final RuntimeException e) {\n-                    if (clean) {\n-                        firstException.compareAndSet(null, e);\n-                    } else {\n-                        log.warn(\"Ignoring an exception while closing task \" + task.id() + \" producer.\", e);\n-                    }\n-                }\n+                executeAndMaybeSwallow(\n+                    clean,\n+                    () -> activeTaskCreator.closeAndRemoveTaskProducerIfNeeded(task.id()),\n+                    e -> firstException.compareAndSet(null, e),\n+                    e -> log.warn(\"Ignoring an exception while closing task \" + task.id() + \" producer.\", e)\n+                );\n             }\n         }\n \n         tasks.clear();\n \n-        try {\n-            activeTaskCreator.closeThreadProducerIfNeeded();\n-        } catch (final RuntimeException e) {\n-            if (clean) {\n-                firstException.compareAndSet(null, e);\n-            } else {\n-                log.warn(\"Ignoring an exception while closing thread producer.\", e);\n-            }\n-        }\n+        executeAndMaybeSwallow(\n+            clean,\n+            () -> activeTaskCreator.closeThreadProducerIfNeeded(),", "originalCommit": "4f8360aff1b0fb964515ad87ef37d7f2d1e4e446", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU3NDExMw==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r442574113", "bodyText": "This is a lambda. Do you mean method reference?", "author": "mjsax", "createdAt": "2020-06-19T00:47:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NDgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEwNTgyMg==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r443105822", "bodyText": "Updated with method reference, thanks!", "author": "feyman2016", "createdAt": "2020-06-20T06:16:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NDgyOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzE1OTk2Nw==", "url": "https://github.com/apache/kafka/pull/8887#discussion_r443159967", "bodyText": "Oh yea! @mjsax", "author": "abbccdda", "createdAt": "2020-06-20T21:05:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTk1NDgyOQ=="}], "type": "inlineReview"}, {"oid": "9298c28815fa9a6c5ef20bdf9c74dde67b68af1a", "url": "https://github.com/apache/kafka/commit/9298c28815fa9a6c5ef20bdf9c74dde67b68af1a", "message": "fix based on comments", "committedDate": "2020-06-20T06:08:28Z", "type": "commit"}]}