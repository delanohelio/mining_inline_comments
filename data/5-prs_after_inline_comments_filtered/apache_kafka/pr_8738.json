{"pr_number": 8738, "pr_title": "MINOR: remove unnecessary timeout for admin request", "pr_createdAt": "2020-05-28T04:12:14Z", "pr_url": "https://github.com/apache/kafka/pull/8738", "timeline": [{"oid": "7c1ef4d13089187c9d99d30e073fe848b1ec7352", "url": "https://github.com/apache/kafka/commit/7c1ef4d13089187c9d99d30e073fe848b1ec7352", "message": "fix timeout config", "committedDate": "2020-05-28T04:09:40Z", "type": "commit"}, {"oid": "7676de2577fb60ca5c3dc3765a5475725f6c0e3a", "url": "https://github.com/apache/kafka/commit/7676de2577fb60ca5c3dc3765a5475725f6c0e3a", "message": "reset nextProbingRebalanceMs", "committedDate": "2020-05-28T04:09:40Z", "type": "commit"}, {"oid": "702187a4518c2dc29a6123a89be14475c3617ecb", "url": "https://github.com/apache/kafka/commit/702187a4518c2dc29a6123a89be14475c3617ecb", "message": "extract internal admin configs", "committedDate": "2020-05-28T04:09:41Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MTI1MA==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431571250", "bodyText": "Moved to ClientUtil", "author": "ableegoldman", "createdAt": "2020-05-28T04:13:04Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopicManager.java", "diffHunk": "@@ -44,12 +45,6 @@\n     private final static String INTERRUPTED_ERROR_MESSAGE = \"Thread got interrupted. This indicates a bug. \" +\n         \"Please report at https://issues.apache.org/jira/projects/KAFKA or dev-mailing list (https://kafka.apache.org/contact).\";\n \n-    private static final class InternalAdminClientConfig extends AdminClientConfig {", "originalCommit": "702187a4518c2dc29a6123a89be14475c3617ecb", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MTk0Nw==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431571947", "bodyText": "This is neither relevant to this PR nor required for correctness, but I noticed the log message above tends to spam the logs in some tests. Since this gets set/reset at the end of every rebalance, we may as well reset it here to avoid an avalanche of Triggering the followup rebalance...", "author": "ableegoldman", "createdAt": "2020-05-28T04:16:08Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -551,6 +551,7 @@ void runLoop() {\n                 if (nextProbingRebalanceMs.get() < time.milliseconds()) {\n                     log.info(\"Triggering the followup rebalance scheduled for {} ms.\", nextProbingRebalanceMs.get());\n                     mainConsumer.enforceRebalance();\n+                    nextProbingRebalanceMs.set(Long.MAX_VALUE);", "originalCommit": "702187a4518c2dc29a6123a89be14475c3617ecb", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwOTM3MQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432009371", "bodyText": "enforceRebalance is guaranteed not to actually run the assignment logic, right? That will only run during a call to poll, I'm hoping. Otherwise, this line should go before the call.", "author": "vvcephei", "createdAt": "2020-05-28T17:37:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MTk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAxMzMxOQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432013319", "bodyText": "Yep. It just provides a notice to the consumer to enforce that a rebalance will occur on the next poll", "author": "ableegoldman", "createdAt": "2020-05-28T17:44:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTU3MTk0Nw=="}], "type": "inlineReview"}, {"oid": "702187a4518c2dc29a6123a89be14475c3617ecb", "url": "https://github.com/apache/kafka/commit/702187a4518c2dc29a6123a89be14475c3617ecb", "message": "extract internal admin configs", "committedDate": "2020-05-28T04:09:41Z", "type": "forcePushed"}, {"oid": "ef807c2da090c350108f66202c1b5db800852eda", "url": "https://github.com/apache/kafka/commit/ef807c2da090c350108f66202c1b5db800852eda", "message": "default.api.timeout must be larger than request.timeout", "committedDate": "2020-05-28T05:31:45Z", "type": "commit"}, {"oid": "8b5766a45520aff27623d6df4ad33048444784e7", "url": "https://github.com/apache/kafka/commit/8b5766a45520aff27623d6df4ad33048444784e7", "message": "fix javadocs missing end delimiter", "committedDate": "2020-05-28T05:42:32Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMTc2NQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431721765", "bodyText": "It seems to me Duration is more readable than long. Is there a reason to make this change?", "author": "chia7712", "createdAt": "2020-05-28T10:01:08Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ClientUtils.java", "diffHunk": "@@ -90,24 +96,21 @@ public static String getTaskProducerClientId(final String threadClientId, final\n         return result;\n     }\n \n-    public static Map<TopicPartition, ListOffsetsResultInfo> fetchEndOffsetsWithoutTimeout(final Collection<TopicPartition> partitions,\n-                                                                                           final Admin adminClient) {\n-        return fetchEndOffsets(partitions, adminClient, null);\n+    public static int getAdminDefaultApiTimeoutMs(final StreamsConfig streamsConfig) {\n+        final InternalAdminClientConfig dummyAdmin = new InternalAdminClientConfig(streamsConfig.getAdminConfigs(\"dummy\"));\n+        return dummyAdmin.getInt(AdminClientConfig.DEFAULT_API_TIMEOUT_MS_CONFIG);\n     }\n \n     public static Map<TopicPartition, ListOffsetsResultInfo> fetchEndOffsets(final Collection<TopicPartition> partitions,\n                                                                              final Admin adminClient,\n-                                                                             final Duration timeout) {\n+                                                                             final long timeoutMs) {", "originalCommit": "8b5766a45520aff27623d6df4ad33048444784e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk2ODU1OQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431968559", "bodyText": "I think it's because we're now also calling it right after calling getAdminDefaultApiTimeoutMs, so it seems a bummer to create a Duration from millis and then immediately convert it back to millis.", "author": "vvcephei", "createdAt": "2020-05-28T16:29:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMTc2NQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3NjAzMw==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431976033", "bodyText": "Yep", "author": "ableegoldman", "createdAt": "2020-05-28T16:41:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyMTc2NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyNDQ5Nw==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431724497", "bodyText": "The admin configs is built in KafkaStreams construction. Could we reuse it?\n        adminClient = clientSupplier.getAdmin(config.getAdminConfigs(ClientUtils.getSharedAdminClientId(clientId)));", "author": "chia7712", "createdAt": "2020-05-28T10:06:04Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -1246,7 +1247,12 @@ public void cleanUp() {\n         }\n \n         log.debug(\"Current changelog positions: {}\", allChangelogPositions);\n-        final Map<TopicPartition, ListOffsetsResultInfo> allEndOffsets = fetchEndOffsetsWithoutTimeout(allPartitions, adminClient);\n+        final Map<TopicPartition, ListOffsetsResultInfo> allEndOffsets =\n+            fetchEndOffsets(\n+                allPartitions,\n+                adminClient,\n+                getAdminDefaultApiTimeoutMs(config)", "originalCommit": "8b5766a45520aff27623d6df4ad33048444784e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NDgxNw==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431984817", "bodyText": "I did it this way since we need to get the admin's default.api.timeout in other places where we only have the streamsConfig, so we may as well just pass that as the argument to getAdminDefaultApiTimeoutMs", "author": "ableegoldman", "createdAt": "2020-05-28T16:56:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyNDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMzM2MQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432123361", "bodyText": "We should update the JavaDocs that this method may throw a TimeoutException now. What make we wondering if this is a public API change? Was there any discussion on the original KIP about the behavior of allLocalStorePartitionLags ?", "author": "mjsax", "createdAt": "2020-05-28T21:06:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyNDQ5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMzY5Nw==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432123697", "bodyText": "This change might require a KIP... \\cc @vvcephei @guozhangwang WDYT?", "author": "mjsax", "createdAt": "2020-05-28T21:06:51Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyNDQ5Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyNTM1MQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431725351", "bodyText": "Could you add comment for the \"dummy\"?", "author": "chia7712", "createdAt": "2020-05-28T10:07:41Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ClientUtils.java", "diffHunk": "@@ -90,24 +96,21 @@ public static String getTaskProducerClientId(final String threadClientId, final\n         return result;\n     }\n \n-    public static Map<TopicPartition, ListOffsetsResultInfo> fetchEndOffsetsWithoutTimeout(final Collection<TopicPartition> partitions,\n-                                                                                           final Admin adminClient) {\n-        return fetchEndOffsets(partitions, adminClient, null);\n+    public static int getAdminDefaultApiTimeoutMs(final StreamsConfig streamsConfig) {\n+        final InternalAdminClientConfig dummyAdmin = new InternalAdminClientConfig(streamsConfig.getAdminConfigs(\"dummy\"));", "originalCommit": "8b5766a45520aff27623d6df4ad33048444784e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk4NDkzNw==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431984937", "bodyText": "Ack", "author": "ableegoldman", "createdAt": "2020-05-28T16:56:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTcyNTM1MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk2NjM1MA==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431966350", "bodyText": "How about QuietAdminClientConfig, like QuietStreamsConfig?", "author": "vvcephei", "createdAt": "2020-05-28T16:25:50Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ClientUtils.java", "diffHunk": "@@ -40,9 +41,14 @@\n import org.slf4j.LoggerFactory;\n \n public class ClientUtils {\n-\n     private static final Logger LOG = LoggerFactory.getLogger(ClientUtils.class);\n \n+    static final class InternalAdminClientConfig extends AdminClientConfig {", "originalCommit": "8b5766a45520aff27623d6df4ad33048444784e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3NDg2Mg==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431974862", "bodyText": "Good call", "author": "ableegoldman", "createdAt": "2020-05-28T16:39:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk2NjM1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3MDY2OQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431970669", "bodyText": "Just curious, why the change from 9 to 90,000?", "author": "vvcephei", "createdAt": "2020-05-28T16:32:42Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/TaskAssignorIntegrationTest.java", "diffHunk": "@@ -89,7 +89,7 @@ public void shouldProperlyConfigureTheAssignor() throws NoSuchFieldException, Il\n                 mkEntry(StreamsConfig.MAX_WARMUP_REPLICAS_CONFIG, \"7\"),\n                 mkEntry(StreamsConfig.PROBING_REBALANCE_INTERVAL_MS_CONFIG, \"480000\"),\n                 mkEntry(StreamsConfig.InternalConfig.ASSIGNMENT_LISTENER, configuredAssignmentListener),\n-                mkEntry(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG, 9)\n+                mkEntry(AdminClientConfig.DEFAULT_API_TIMEOUT_MS_CONFIG, 90_000)", "originalCommit": "8b5766a45520aff27623d6df4ad33048444784e7", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3NDY3OQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431974679", "bodyText": "For fun", "author": "ableegoldman", "createdAt": "2020-05-28T16:39:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3MDY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3NDcxNQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r431974715", "bodyText": "I mean, because the value has to be larger than the request.timeout.ms which defaults to 30,000", "author": "ableegoldman", "createdAt": "2020-05-28T16:39:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3MDY2OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjAwNjMwNg==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432006306", "bodyText": "Ah, thanks.", "author": "vvcephei", "createdAt": "2020-05-28T17:31:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTk3MDY2OQ=="}], "type": "inlineReview"}, {"oid": "1e03bd32fb7b2fa7a66295be569741ca0dca322a", "url": "https://github.com/apache/kafka/commit/1e03bd32fb7b2fa7a66295be569741ca0dca322a", "message": "github review suggestions", "committedDate": "2020-05-28T17:02:58Z", "type": "commit"}, {"oid": "c55e557223324208e782a23a196aa95c98fd8402", "url": "https://github.com/apache/kafka/commit/c55e557223324208e782a23a196aa95c98fd8402", "message": "Merge branch 'trunk' into MINOR-remove-extra-admin-timeout-config", "committedDate": "2020-05-28T19:56:00Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMTI1OA==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432121258", "bodyText": "Should we pass in MAX_VALUE to avoid introducing test flakyness?", "author": "mjsax", "createdAt": "2020-05-28T21:01:51Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/ClientUtilsTest.java", "diffHunk": "@@ -45,42 +50,42 @@ public void fetchEndOffsetsShouldRethrowRuntimeExceptionAsStreamsException() {\n         final Admin adminClient = EasyMock.createMock(AdminClient.class);\n         EasyMock.expect(adminClient.listOffsets(EasyMock.anyObject())).andThrow(new RuntimeException());\n         replay(adminClient);\n-        assertThrows(StreamsException.class, () ->  fetchEndOffsetsWithoutTimeout(emptyList(), adminClient));\n+        assertThrows(StreamsException.class, () ->  fetchEndOffsets(emptyList(), adminClient, 60_000L));", "originalCommit": "c55e557223324208e782a23a196aa95c98fd8402", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjEyMTY1NQ==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432121655", "bodyText": "As above (also below)\nAlso nit: 60_000L (if just 60 and TimeUnit.SECONDS?)", "author": "mjsax", "createdAt": "2020-05-28T21:02:43Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/ClientUtilsTest.java", "diffHunk": "@@ -45,42 +50,42 @@ public void fetchEndOffsetsShouldRethrowRuntimeExceptionAsStreamsException() {\n         final Admin adminClient = EasyMock.createMock(AdminClient.class);\n         EasyMock.expect(adminClient.listOffsets(EasyMock.anyObject())).andThrow(new RuntimeException());\n         replay(adminClient);\n-        assertThrows(StreamsException.class, () ->  fetchEndOffsetsWithoutTimeout(emptyList(), adminClient));\n+        assertThrows(StreamsException.class, () ->  fetchEndOffsets(emptyList(), adminClient, 60_000L));\n         verify(adminClient);\n     }\n \n     @Test\n-    public void fetchEndOffsetsShouldRethrowInterruptedExceptionAsStreamsException() throws InterruptedException, ExecutionException {\n+    public void fetchEndOffsetsShouldRethrowInterruptedExceptionAsStreamsException() throws Exception {\n         final Admin adminClient = EasyMock.createMock(AdminClient.class);\n         final ListOffsetsResult result = EasyMock.createNiceMock(ListOffsetsResult.class);\n         final KafkaFuture<Map<TopicPartition, ListOffsetsResultInfo>> allFuture = EasyMock.createMock(KafkaFuture.class);\n \n         EasyMock.expect(adminClient.listOffsets(EasyMock.anyObject())).andStubReturn(result);\n         EasyMock.expect(result.all()).andStubReturn(allFuture);\n-        EasyMock.expect(allFuture.get()).andThrow(new InterruptedException());\n+        EasyMock.expect(allFuture.get(60000L, TimeUnit.MILLISECONDS)).andThrow(new InterruptedException());", "originalCommit": "c55e557223324208e782a23a196aa95c98fd8402", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "c290156c2a9297c644b9c6b9f77da9583398f47b", "url": "https://github.com/apache/kafka/commit/c290156c2a9297c644b9c6b9f77da9583398f47b", "message": "remove timeout instead", "committedDate": "2020-05-28T21:49:20Z", "type": "commit"}, {"oid": "54ea20bea7070784a490eaeff64feffda5d79ba3", "url": "https://github.com/apache/kafka/commit/54ea20bea7070784a490eaeff64feffda5d79ba3", "message": "Merge branch 'MINOR-remove-extra-admin-timeout-config' of https://github.com/ableegoldman/kafka into MINOR-remove-extra-admin-timeout-config", "committedDate": "2020-05-28T21:51:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MzYyMw==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432153623", "bodyText": "Can we please update the JavaDocs of allLocalStorePartitionLags to state that a StreamsException could be thrown?", "author": "mjsax", "createdAt": "2020-05-28T22:13:33Z", "path": "streams/src/main/java/org/apache/kafka/streams/KafkaStreams.java", "diffHunk": "@@ -1246,7 +1246,7 @@ public void cleanUp() {\n         }\n \n         log.debug(\"Current changelog positions: {}\", allChangelogPositions);\n-        final Map<TopicPartition, ListOffsetsResultInfo> allEndOffsets = fetchEndOffsetsWithoutTimeout(allPartitions, adminClient);\n+        final Map<TopicPartition, ListOffsetsResultInfo> allEndOffsets = fetchEndOffsets(allPartitions, adminClient);", "originalCommit": "54ea20bea7070784a490eaeff64feffda5d79ba3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1ODc2Ng==", "url": "https://github.com/apache/kafka/pull/8738#discussion_r432158766", "bodyText": "ack, done", "author": "ableegoldman", "createdAt": "2020-05-28T22:27:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjE1MzYyMw=="}], "type": "inlineReview"}, {"oid": "0edafb6b85ccbd42912033c0c5b622623d11b740", "url": "https://github.com/apache/kafka/commit/0edafb6b85ccbd42912033c0c5b622623d11b740", "message": "checkstyle", "committedDate": "2020-05-28T22:24:05Z", "type": "commit"}, {"oid": "f7aad3ae9d2dbce77fe3e2ec2957298d466fb003", "url": "https://github.com/apache/kafka/commit/f7aad3ae9d2dbce77fe3e2ec2957298d466fb003", "message": "add StreamsException to javadocs", "committedDate": "2020-05-28T22:27:37Z", "type": "commit"}]}