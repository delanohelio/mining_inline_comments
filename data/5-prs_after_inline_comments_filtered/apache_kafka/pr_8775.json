{"pr_number": 8775, "pr_title": "KAFKA-10079: improve thread-level stickiness", "pr_createdAt": "2020-06-02T05:23:55Z", "pr_url": "https://github.com/apache/kafka/pull/8775", "timeline": [{"oid": "91400976890ee84bde9c28cc864a2de98c18a31a", "url": "https://github.com/apache/kafka/commit/91400976890ee84bde9c28cc864a2de98c18a31a", "message": "WIP", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "508388975488180e8240cc9edf2955ca5fbeabc4", "url": "https://github.com/apache/kafka/commit/508388975488180e8240cc9edf2955ca5fbeabc4", "message": "implemented stickiness", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "be118634a1a51f6144adf9dc9055c4626bd7d88b", "url": "https://github.com/apache/kafka/commit/be118634a1a51f6144adf9dc9055c4626bd7d88b", "message": "compiling tests", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "dc296fc0380105691bc768b0f4b128fee987b89a", "url": "https://github.com/apache/kafka/commit/dc296fc0380105691bc768b0f4b128fee987b89a", "message": "improve stickiness to the max", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "4b8e96cb899d3b6ee6c91766ae2722e7c30ee5e4", "url": "https://github.com/apache/kafka/commit/4b8e96cb899d3b6ee6c91766ae2722e7c30ee5e4", "message": "debugging last test", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "8300d491ae64f4f8ab4fba5b2e9baa1ffadd9a7c", "url": "https://github.com/apache/kafka/commit/8300d491ae64f4f8ab4fba5b2e9baa1ffadd9a7c", "message": "use sorted set for test", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "d40dd5ae74c3a0b3fc22b60fd0380c44a44d3f7b", "url": "https://github.com/apache/kafka/commit/d40dd5ae74c3a0b3fc22b60fd0380c44a44d3f7b", "message": "checkstyle", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "5cb6f40bd138fbfa57ac60fccafeb18a4e12c45e", "url": "https://github.com/apache/kafka/commit/5cb6f40bd138fbfa57ac60fccafeb18a4e12c45e", "message": "add unit tests", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "72e64ef6089a6ebd7c197e4a0f383c252c9e09f8", "url": "https://github.com/apache/kafka/commit/72e64ef6089a6ebd7c197e4a0f383c252c9e09f8", "message": "filter for statefulness in SPA", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "acb7a4c0993b7fd7c455b734aa895583341c965d", "url": "https://github.com/apache/kafka/commit/acb7a4c0993b7fd7c455b734aa895583341c965d", "message": "fixing up tests", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "f580e63fb889115ef66987656459baefcce3473c", "url": "https://github.com/apache/kafka/commit/f580e63fb889115ef66987656459baefcce3473c", "message": "bump log to INFO", "committedDate": "2020-06-03T19:12:55Z", "type": "commit"}, {"oid": "f580e63fb889115ef66987656459baefcce3473c", "url": "https://github.com/apache/kafka/commit/f580e63fb889115ef66987656459baefcce3473c", "message": "bump log to INFO", "committedDate": "2020-06-03T19:12:55Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg5Mjg1Nw==", "url": "https://github.com/apache/kafka/pull/8775#discussion_r434892857", "bodyText": "I missed the extra sort on my last review. It really seems like too much fanciness for the ClientState to sort the tasks in lag order. Would it be too messy to move the sort aspect out to the balancing code that needs it?", "author": "vvcephei", "createdAt": "2020-06-03T22:29:06Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/assignment/ClientStateTest.java", "diffHunk": "@@ -300,20 +302,71 @@ public void shouldNotHaveUnfulfilledQuotaWhenActiveTaskSizeGreaterEqualThanCapac\n     @Test\n     public void shouldAddTasksWithLatestOffsetToPrevActiveTasks() {\n         final Map<TaskId, Long> taskOffsetSums = Collections.singletonMap(TASK_0_1, Task.LATEST_OFFSET);\n-        client.addPreviousTasksAndOffsetSums(taskOffsetSums);\n+        client.addPreviousTasksAndOffsetSums(\"c1\", taskOffsetSums);\n         client.initializePrevTasks(Collections.emptyMap());\n         assertThat(client.prevActiveTasks(), equalTo(Collections.singleton(TASK_0_1)));\n         assertThat(client.previousAssignedTasks(), equalTo(Collections.singleton(TASK_0_1)));\n         assertTrue(client.prevStandbyTasks().isEmpty());\n     }\n \n+    @Test\n+    public void shouldReturnPreviousStatefulTasksForConsumer() {\n+        client.addPreviousTasksAndOffsetSums(\"c1\", Collections.singletonMap(TASK_0_1, Task.LATEST_OFFSET));\n+        client.addPreviousTasksAndOffsetSums(\"c2\", Collections.singletonMap(TASK_0_2, 0L));\n+        client.addPreviousTasksAndOffsetSums(\"c3\", Collections.emptyMap());\n+\n+        client.initializePrevTasks(Collections.emptyMap());\n+        client.computeTaskLags(\n+            UUID_1,\n+            mkMap(\n+                mkEntry(TASK_0_1, 1_000L),\n+                mkEntry(TASK_0_2, 1_000L)\n+            )\n+        );\n+\n+        assertThat(client.previousTasksForConsumer(\"c1\"), equalTo(mkSortedSet(TASK_0_1)));\n+        assertThat(client.previousTasksForConsumer(\"c2\"), equalTo(mkSortedSet(TASK_0_2)));\n+        assertTrue(client.previousTasksForConsumer(\"c3\").isEmpty());\n+    }\n+\n+    @Test\n+    public void shouldReturnPreviousStatefulTasksForConsumerWhenLagIsNotComputed() {\n+        client.addPreviousTasksAndOffsetSums(\"c1\", Collections.singletonMap(TASK_0_1, 1000L));\n+        client.initializePrevTasks(Collections.emptyMap());\n+\n+        assertThat(client.previousTasksForConsumer(\"c1\"), equalTo(mkSortedSet(TASK_0_1)));\n+    }\n+\n+    @Test\n+    public void shouldReturnPreviousStatefulTasksForConsumerInIncreasingLagOrder() {", "originalCommit": "f580e63fb889115ef66987656459baefcce3473c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTM3NDEyNQ==", "url": "https://github.com/apache/kafka/pull/8775#discussion_r435374125", "bodyText": "You didn't miss it, I just snuck it in there after your review :P\nSorry, should have called out that I made some more changes. I think that was the only significant logical change though. I'll try pulling the sort out into the assignment code", "author": "ableegoldman", "createdAt": "2020-06-04T16:03:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDg5Mjg1Nw=="}], "type": "inlineReview"}, {"oid": "7c18e59541ed5a5a482766f7bf30d4ba253ac2f8", "url": "https://github.com/apache/kafka/commit/7c18e59541ed5a5a482766f7bf30d4ba253ac2f8", "message": "pull sorting into SPA", "committedDate": "2020-06-04T16:54:04Z", "type": "commit"}, {"oid": "96a6c23d23b4c8b4018f4bb1bf044ce924f73f90", "url": "https://github.com/apache/kafka/commit/96a6c23d23b4c8b4018f4bb1bf044ce924f73f90", "message": "checkstyle", "committedDate": "2020-06-04T16:54:35Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMzMzNw==", "url": "https://github.com/apache/kafka/pull/8775#discussion_r435433337", "bodyText": "Is this the right constant to represent \"we don't know the lag\"? Or did I mistake how this is going to be used?", "author": "vvcephei", "createdAt": "2020-06-04T17:39:18Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/assignment/ClientState.java", "diffHunk": "@@ -302,14 +300,19 @@ public void computeTaskLags(final UUID uuid, final Map<TaskId, Long> allTaskEndO\n      * @return end offset sum - offset sum\n      *          Task.LATEST_OFFSET if this was previously an active running task on this client\n      */\n-    long lagFor(final TaskId task) {\n-        final Long totalLag = taskLagTotals.get(task);\n+    public long lagFor(final TaskId task) {\n+        final Long totalLag;\n+        if (taskLagTotals.isEmpty()) {\n+            // If we couldn't compute the task lags due to failure to fetch offsets, just return a flat constant\n+            totalLag = 0L;", "originalCommit": "96a6c23d23b4c8b4018f4bb1bf044ce924f73f90", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU4NTYwOQ==", "url": "https://github.com/apache/kafka/pull/8775#discussion_r435585609", "bodyText": "The value itself doesn't matter, just that it's constant across all tasks.\nBut I'm guessing you meant, why not use the existing UNKNOWN_OFFSET_SUM sentinel, in which case the answer is probably just that I forgot about it. Anyway I did a slight additional refactoring beyond this, just fyi: instead of skipping the lag computation when we fail to fetch offsets, we now always initialize the lags and just pass in the UNKNOWN_OFFSET_SUM for all stateful tasks when the offset fetch fails.", "author": "ableegoldman", "createdAt": "2020-06-04T22:24:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTQzMzMzNw=="}], "type": "inlineReview"}, {"oid": "d26d46290fdd806ef85abd989507495598b2854e", "url": "https://github.com/apache/kafka/commit/d26d46290fdd806ef85abd989507495598b2854e", "message": "use UNKNOWN_OFFSET_SUM, always initialize lag", "committedDate": "2020-06-04T18:39:38Z", "type": "commit"}, {"oid": "6df10ca2f7c1447a246a18a4cc6fdd2906af7cf5", "url": "https://github.com/apache/kafka/commit/6df10ca2f7c1447a246a18a4cc6fdd2906af7cf5", "message": "remove no longer relevant  new test", "committedDate": "2020-06-04T18:40:40Z", "type": "commit"}, {"oid": "fc98357ad9d2e7ee1e37e2098548c52320a379ad", "url": "https://github.com/apache/kafka/commit/fc98357ad9d2e7ee1e37e2098548c52320a379ad", "message": "fix/rename counter", "committedDate": "2020-06-04T18:46:22Z", "type": "commit"}, {"oid": "b5cfd406a33deb19d18f85f76860055d78b38351", "url": "https://github.com/apache/kafka/commit/b5cfd406a33deb19d18f85f76860055d78b38351", "message": "some cleanup", "committedDate": "2020-06-04T18:59:58Z", "type": "commit"}, {"oid": "f83baf95aa467a0b1236e7c10ef0ff9a8fced345", "url": "https://github.com/apache/kafka/commit/f83baf95aa467a0b1236e7c10ef0ff9a8fced345", "message": "fixindentation", "committedDate": "2020-06-04T19:01:28Z", "type": "commit"}, {"oid": "f0c5a1954114381f09fb65caff9b5c9a6c60791c", "url": "https://github.com/apache/kafka/commit/f0c5a1954114381f09fb65caff9b5c9a6c60791c", "message": "simplify", "committedDate": "2020-06-04T20:30:55Z", "type": "commit"}, {"oid": "ee384a9a9e5697e479010989a90f76a0140f6d66", "url": "https://github.com/apache/kafka/commit/ee384a9a9e5697e479010989a90f76a0140f6d66", "message": "fix bug caught in test", "committedDate": "2020-06-04T21:01:14Z", "type": "commit"}, {"oid": "168051c69252a4a5e6e64e5162fa8c4ae59ec3ce", "url": "https://github.com/apache/kafka/commit/168051c69252a4a5e6e64e5162fa8c4ae59ec3ce", "message": "Adding unit tests", "committedDate": "2020-06-08T17:02:18Z", "type": "commit"}, {"oid": "6b0f6fbe8ea8fd23bcbecbd6f56036bb1e3fb4b6", "url": "https://github.com/apache/kafka/commit/6b0f6fbe8ea8fd23bcbecbd6f56036bb1e3fb4b6", "message": "checkstyle", "committedDate": "2020-06-08T17:07:31Z", "type": "commit"}, {"oid": "e921175af03a61f20c24398540c1bdcf5a94fbb1", "url": "https://github.com/apache/kafka/commit/e921175af03a61f20c24398540c1bdcf5a94fbb1", "message": "remove unused topic partitions", "committedDate": "2020-06-08T17:29:41Z", "type": "commit"}]}