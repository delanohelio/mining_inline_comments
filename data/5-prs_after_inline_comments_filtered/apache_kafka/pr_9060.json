{"pr_number": 9060, "pr_title": "KAFKA-9274: Remove `retries` from InternalTopicManager", "pr_createdAt": "2020-07-23T04:06:04Z", "pr_url": "https://github.com/apache/kafka/pull/9060", "timeline": [{"oid": "ddbfe318a54c068dfc4a9d821f144b935339346c", "url": "https://github.com/apache/kafka/commit/ddbfe318a54c068dfc4a9d821f144b935339346c", "message": "KAFKA-9274: Remove retries from InternalTopicManager\n - part of KIP-572\n - replace `retries` in InternalTopicManager with infinite retires plus\n   a new timeout, based on consumer config MAX_POLL_INTERVAL_MS", "committedDate": "2020-08-05T21:16:59Z", "type": "commit"}, {"oid": "a214111de6c26d59fb40ddefd26b6620c3efca9b", "url": "https://github.com/apache/kafka/commit/a214111de6c26d59fb40ddefd26b6620c3efca9b", "message": "fix tests", "committedDate": "2020-08-05T21:16:59Z", "type": "commit"}, {"oid": "0af6273741d1a9249dc82b99e14f438f69f07f90", "url": "https://github.com/apache/kafka/commit/0af6273741d1a9249dc82b99e14f438f69f07f90", "message": "Github comments", "committedDate": "2020-08-05T21:17:23Z", "type": "commit"}, {"oid": "8d2348406e53099ec79d75c8f0adbbc95aaf7d76", "url": "https://github.com/apache/kafka/commit/8d2348406e53099ec79d75c8f0adbbc95aaf7d76", "message": "Github comments", "committedDate": "2020-08-05T21:17:24Z", "type": "commit"}, {"oid": "05b0faa5a146de6ec33784db87cf24c8ea1b6232", "url": "https://github.com/apache/kafka/commit/05b0faa5a146de6ec33784db87cf24c8ea1b6232", "message": "Rebased", "committedDate": "2020-08-05T21:29:37Z", "type": "commit"}, {"oid": "05b0faa5a146de6ec33784db87cf24c8ea1b6232", "url": "https://github.com/apache/kafka/commit/05b0faa5a146de6ec33784db87cf24c8ea1b6232", "message": "Rebased", "committedDate": "2020-08-05T21:29:37Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDEwOQ==", "url": "https://github.com/apache/kafka/pull/9060#discussion_r489580109", "bodyText": "Hey @mjsax , am I reading this PR correctly? Do we now only allow a single member to retry topic creation/validation for up to half of the poll interval, after which we shut down the entire application? That sounds like the opposite of resiliency...what if the brokers are temporarily unavailable? Before this we would just let the single thread die, and the internal topic creation/validation would be retried on the subsequent rebalance. That wasn't ideal, but given the upcoming work to allow reviving/recreating a death thread, that seems to be preferable to permanently ending the application?\nSorry if I'm misreading this, was just going over all the PRs in the last month or so to produce a diff+summary of the important ones, and want to make sure I actually understand all the changes we've made", "author": "ableegoldman", "createdAt": "2020-09-16T16:47:24Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/InternalTopicManager.java", "diffHunk": "@@ -45,33 +49,38 @@\n         \"Please report at https://issues.apache.org/jira/projects/KAFKA or dev-mailing list (https://kafka.apache.org/contact).\";\n \n     private final Logger log;\n-    private final long windowChangeLogAdditionalRetention;\n-    private final Map<String, String> defaultTopicConfigs = new HashMap<>();\n \n-    private final short replicationFactor;\n+    private final Time time;\n     private final Admin adminClient;\n \n-    private final int retries;\n+    private final short replicationFactor;\n+    private final long windowChangeLogAdditionalRetention;\n     private final long retryBackOffMs;\n+    private final long retryTimeoutMs;\n+\n+    private final Map<String, String> defaultTopicConfigs = new HashMap<>();\n \n-    @SuppressWarnings(\"deprecation\") // TODO: remove in follow up PR when `RETRIES` is removed\n-    public InternalTopicManager(final Admin adminClient, final StreamsConfig streamsConfig) {\n+    public InternalTopicManager(final Time time,\n+                                final Admin adminClient,\n+                                final StreamsConfig streamsConfig) {\n+        this.time = time;\n         this.adminClient = adminClient;\n \n         final LogContext logContext = new LogContext(String.format(\"stream-thread [%s] \", Thread.currentThread().getName()));\n         log = logContext.logger(getClass());\n \n         replicationFactor = streamsConfig.getInt(StreamsConfig.REPLICATION_FACTOR_CONFIG).shortValue();\n         windowChangeLogAdditionalRetention = streamsConfig.getLong(StreamsConfig.WINDOW_STORE_CHANGE_LOG_ADDITIONAL_RETENTION_MS_CONFIG);\n-        final AdminClientConfig adminConfigs = new ClientUtils.QuietAdminClientConfig(streamsConfig);\n-        retries = adminConfigs.getInt(AdminClientConfig.RETRIES_CONFIG);\n-        retryBackOffMs = adminConfigs.getLong(AdminClientConfig.RETRY_BACKOFF_MS_CONFIG);\n+        retryBackOffMs = streamsConfig.getLong(StreamsConfig.RETRY_BACKOFF_MS_CONFIG);\n+        final Map<String, Object> consumerConfig = streamsConfig.getMainConsumerConfigs(\"dummy\", \"dummy\", -1);\n+        // need to add mandatory configs; otherwise `QuietConsumerConfig` throws\n+        consumerConfig.put(ConsumerConfig.KEY_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class);\n+        consumerConfig.put(ConsumerConfig.VALUE_DESERIALIZER_CLASS_CONFIG, ByteArrayDeserializer.class);\n+        retryTimeoutMs = new QuietConsumerConfig(consumerConfig).getInt(ConsumerConfig.MAX_POLL_INTERVAL_MS_CONFIG) / 2L;", "originalCommit": "05b0faa5a146de6ec33784db87cf24c8ea1b6232", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDU3Mg==", "url": "https://github.com/apache/kafka/pull/9060#discussion_r489580572", "bodyText": "Apologies if this was touched on in the KIP, it's been a while and the discussion thread was quite long so I may have missed something there", "author": "ableegoldman", "createdAt": "2020-09-16T16:48:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTY0NjA1OQ==", "url": "https://github.com/apache/kafka/pull/9060#discussion_r489646059", "bodyText": "Note that the previous default was \"zero retries\" and thus the new default is more resilient with a 5 minute default max.poll.interval. -- But yes, we shutdown the whole app for this case now as proposed by @guozhangwang (IIRC).", "author": "mjsax", "createdAt": "2020-09-16T18:34:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY0NTc4MA==", "url": "https://github.com/apache/kafka/pull/9060#discussion_r491645780", "bodyText": "Today since we do not have ways to partially create tasks we'd have to create all topics to make sure all tasks are \"complete\" within each rebalance, if we cannot successfully create the topics within the poll.interval (i.e. we'd need to complete that rebalance with the poll.interval, and I guess halving it is to be more conservative), then killing that thread is not very useful anyways since we cannot proceed with the initializable tasks anyways.\nThat being said, with the upcoming work I'd agree that just shutdown the thread and allow users to optionally retry rebalance with new threads would be preferrable.", "author": "guozhangwang", "createdAt": "2020-09-20T03:08:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTY0NTgwMA==", "url": "https://github.com/apache/kafka/pull/9060#discussion_r491645800", "bodyText": "cc @cadonna @wcarlson5 to bring to your attention.", "author": "guozhangwang", "createdAt": "2020-09-20T03:08:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNDE4Mw==", "url": "https://github.com/apache/kafka/pull/9060#discussion_r497714183", "bodyText": "Yeah I think we should remove the shutdown error code in case of TimeoutException during internal topic validation before 2.7. I'll create a ticket so we don't lose track -- I think even just letting it kill the one thread is better than killing all of them", "author": "ableegoldman", "createdAt": "2020-09-30T18:25:03Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDEwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzcxNzIxOA==", "url": "https://github.com/apache/kafka/pull/9060#discussion_r497717218", "bodyText": "SGTM.", "author": "mjsax", "createdAt": "2020-09-30T18:30:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU4MDEwOQ=="}], "type": "inlineReview"}]}