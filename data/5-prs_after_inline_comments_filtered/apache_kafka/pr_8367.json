{"pr_number": 8367, "pr_title": "KAFKA-9719: Streams with EOS-beta should fail fast for older brokers", "pr_createdAt": "2020-03-26T20:05:39Z", "pr_url": "https://github.com/apache/kafka/pull/8367", "timeline": [{"oid": "a6d50466e5b0ff924f7c60218ef924139e6d4865", "url": "https://github.com/apache/kafka/commit/a6d50466e5b0ff924f7c60218ef924139e6d4865", "message": "KAFKA-9719: Streams with EOS-beta should fail fast for older brokers", "committedDate": "2020-03-27T19:13:24Z", "type": "commit"}, {"oid": "66a2ca7a22a458aa603cafbe2de930589c97db25", "url": "https://github.com/apache/kafka/commit/66a2ca7a22a458aa603cafbe2de930589c97db25", "message": "Github comments", "committedDate": "2020-03-27T19:13:24Z", "type": "commit"}, {"oid": "ef41d1a1c748b3930b4bf6175a015896eaefe962", "url": "https://github.com/apache/kafka/commit/ef41d1a1c748b3930b4bf6175a015896eaefe962", "message": "Ignore failing sytem test\nFix failing unit tests\nMinor improvement to system test", "committedDate": "2020-03-27T19:13:56Z", "type": "commit"}, {"oid": "ef41d1a1c748b3930b4bf6175a015896eaefe962", "url": "https://github.com/apache/kafka/commit/ef41d1a1c748b3930b4bf6175a015896eaefe962", "message": "Ignore failing sytem test\nFix failing unit tests\nMinor improvement to system test", "committedDate": "2020-03-27T19:13:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5Mzc3OQ==", "url": "https://github.com/apache/kafka/pull/8367#discussion_r399493779", "bodyText": "@guozhangwang New special log message for old brokers.", "author": "mjsax", "createdAt": "2020-03-27T19:28:48Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamThread.java", "diffHunk": "@@ -511,6 +512,21 @@ public void run() {\n         } catch (final Exception e) {\n             // we have caught all Kafka related exceptions, and other runtime exceptions\n             // should be due to user application errors\n+\n+            if (e instanceof UnsupportedVersionException) {", "originalCommit": "ef41d1a1c748b3930b4bf6175a015896eaefe962", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTQ5NDExNg==", "url": "https://github.com/apache/kafka/pull/8367#discussion_r399494116", "bodyText": "Smaller improvement: write input data with transactions, too.", "author": "mjsax", "createdAt": "2020-03-27T19:29:27Z", "path": "streams/src/test/java/org/apache/kafka/streams/tests/BrokerCompatibilityTest.java", "diffHunk": "@@ -86,43 +83,46 @@ public static void main(final String[] args) throws IOException {\n         builder.<String, String>stream(SOURCE_TOPIC).groupByKey(Grouped.with(stringSerde, stringSerde))\n             .count()\n             .toStream()\n-            .mapValues(new ValueMapper<Long, String>() {\n-                @Override\n-                public String apply(final Long value) {\n-                    return value.toString();\n-                }\n-            })\n+            .mapValues(Object::toString)\n             .to(SINK_TOPIC);\n \n         final KafkaStreams streams = new KafkaStreams(builder.build(), streamsProperties);\n-        streams.setUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {\n-            @Override\n-            public void uncaughtException(final Thread t, final Throwable e) {\n-                Throwable cause = e;\n-                if (cause instanceof StreamsException) {\n-                    while (cause.getCause() != null) {\n-                        cause = cause.getCause();\n-                    }\n+        streams.setUncaughtExceptionHandler((t, e) -> {\n+            Throwable cause = e;\n+            if (cause instanceof StreamsException) {\n+                while (cause.getCause() != null) {\n+                    cause = cause.getCause();\n                 }\n-                System.err.println(\"FATAL: An unexpected exception \" + cause);\n-                e.printStackTrace(System.err);\n-                System.err.flush();\n-                streams.close(Duration.ofSeconds(30));\n             }\n+            System.err.println(\"FATAL: An unexpected exception \" + cause);\n+            e.printStackTrace(System.err);\n+            System.err.flush();\n+            streams.close(Duration.ofSeconds(30));\n         });\n         System.out.println(\"start Kafka Streams\");\n         streams.start();\n \n+        final boolean eosEnabled = processingMode.startsWith(StreamsConfig.EXACTLY_ONCE);\n \n         System.out.println(\"send data\");\n         final Properties producerProperties = new Properties();\n         producerProperties.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, kafka);\n         producerProperties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, StringSerializer.class);\n         producerProperties.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);\n+        if (eosEnabled) {\n+            producerProperties.put(ProducerConfig.TRANSACTIONAL_ID_CONFIG, \"broker-compatibility-producer-tx\");\n+        }", "originalCommit": "ef41d1a1c748b3930b4bf6175a015896eaefe962", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}