{"pr_number": 8047, "pr_title": "MINOR: Add timer for update limit offsets", "pr_createdAt": "2020-02-05T20:46:56Z", "pr_url": "https://github.com/apache/kafka/pull/8047", "timeline": [{"oid": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "url": "https://github.com/apache/kafka/commit/3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "message": "add timer for update limit offsets", "committedDate": "2020-02-05T20:44:05Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5ODgyMA==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375498820", "bodyText": "This function is only triggered internally and can be removed from interface.", "author": "guozhangwang", "createdAt": "2020-02-05T20:47:15Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ChangelogReader.java", "diffHunk": "@@ -30,11 +30,6 @@\n      */\n     void restore();\n \n-    /**\n-     * Update offset limit of a given changelog partition\n-     */\n-    void updateLimitOffsets();", "originalCommit": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5OTQwNw==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375499407", "bodyText": "Following the suggestion from KAFKA-9113 PR, by @ableegoldman we consolidate the limit-offset with end-offset.", "author": "guozhangwang", "createdAt": "2020-02-05T20:48:32Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -99,11 +100,18 @@\n \n         // only for active restoring tasks (for standby changelog it is null)\n         // NOTE we do not book keep the current offset since we leverage state manager as its source of truth\n-        private Long restoreEndOffset;\n \n-        // only for standby tasks that use source topics as changelogs (for active it is null);\n-        // if it is not on source topics it is also null\n-        private Long restoreLimitOffset;", "originalCommit": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTQ5OTY1OA==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375499658", "bodyText": "If user set this value to infinity we should still have a non-inf value to take care of the manual commit.", "author": "guozhangwang", "createdAt": "2020-02-05T20:49:06Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -208,10 +215,12 @@ public StoreChangelogReader(final StreamsConfig config,\n         // NOTE for restoring active and updating standby we may prefer different poll time\n         // in order to make sure we call the main consumer#poll in time.\n         // TODO: once both of these are moved to a separate thread this may no longer be a concern\n-        this.pollTime = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));\n+        this.pollTimeMs = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));\n+        this.updateOffsetIntervalMs = config.getLong(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG) == Long.MAX_VALUE ?\n+            DEFAULT_OFFSET_UPDATE_MS : config.getLong(StreamsConfig.COMMIT_INTERVAL_MS_CONFIG);", "originalCommit": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwMDY4OQ==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375500689", "bodyText": "If there's nothing to be updated or timed out, we do not update the timer.", "author": "guozhangwang", "createdAt": "2020-02-05T20:51:16Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -517,16 +520,21 @@ private void restoreChangelog(final ChangelogMetadata changelogMetadata) {\n         if (partitions.isEmpty())\n             return Collections.emptyMap();\n \n+        final Map<TopicPartition, Long> committedOffsets;\n         try {\n             // those do not have a committed offset would default to 0\n-            return mainConsumer.committed(partitions).entrySet().stream()\n+            committedOffsets =  mainConsumer.committed(partitions).entrySet().stream()\n                 .collect(Collectors.toMap(Map.Entry::getKey, e -> e.getValue() == null ? 0L : e.getValue().offset()));\n         } catch (final TimeoutException e) {\n             // if it timed out we just retry next time.\n             return Collections.emptyMap();\n         } catch (final KafkaException e) {\n             throw new StreamsException(String.format(\"Failed to retrieve end offsets for %s\", partitions), e);\n         }\n+\n+        lastUpdateOffsetTime = time.milliseconds();", "originalCommit": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA1OTMyNA==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r376059324", "bodyText": "This would be less mysterious if this method were inlined into updateLimitOffsets. Right now, it's not terribly clear why it's ok to set the \"last update offset time\" in a method that doesn't update the offsets.", "author": "vvcephei", "createdAt": "2020-02-06T20:17:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwMDY4OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEzNjM3Nw==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r376136377", "bodyText": "This function is triggered by another caller besides updateLimitOffsets, plus it is a bit close to the NPathComplexity threshold..", "author": "guozhangwang", "createdAt": "2020-02-06T23:17:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTUwMDY4OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzODQ5Ng==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r375638496", "bodyText": "the type of pollTimeMs is Duration. It seems to me that the \"ms\" is a bit redundant.", "author": "chia7712", "createdAt": "2020-02-06T04:45:45Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StoreChangelogReader.java", "diffHunk": "@@ -208,10 +215,12 @@ public StoreChangelogReader(final StreamsConfig config,\n         // NOTE for restoring active and updating standby we may prefer different poll time\n         // in order to make sure we call the main consumer#poll in time.\n         // TODO: once both of these are moved to a separate thread this may no longer be a concern\n-        this.pollTime = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));\n+        this.pollTimeMs = Duration.ofMillis(config.getLong(StreamsConfig.POLL_MS_CONFIG));", "originalCommit": "3bfd87c37032b1a6bdd343e2ee135d0b3bf33b6f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjA2MDMyNQ==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r376060325", "bodyText": "+1", "author": "vvcephei", "createdAt": "2020-02-06T20:19:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzODQ5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjEzNTg3Mw==", "url": "https://github.com/apache/kafka/pull/8047#discussion_r376135873", "bodyText": "Ack.", "author": "guozhangwang", "createdAt": "2020-02-06T23:16:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTYzODQ5Ng=="}], "type": "inlineReview"}, {"oid": "7493782dc28e02a132823b236ea275b066f058ac", "url": "https://github.com/apache/kafka/commit/7493782dc28e02a132823b236ea275b066f058ac", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into KMinor-changelog-reader-limit-offset-update", "committedDate": "2020-02-06T19:54:05Z", "type": "commit"}, {"oid": "26d868a440a6d83372195a67c8a4e68ef5b4ece8", "url": "https://github.com/apache/kafka/commit/26d868a440a6d83372195a67c8a4e68ef5b4ece8", "message": "address comments", "committedDate": "2020-02-06T23:27:15Z", "type": "commit"}]}