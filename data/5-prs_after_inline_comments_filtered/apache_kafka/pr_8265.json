{"pr_number": 8265, "pr_title": "KAFKA-9657: Throw upon offset fetch unsupported stable flag protocol ", "pr_createdAt": "2020-03-10T20:37:12Z", "pr_url": "https://github.com/apache/kafka/pull/8265", "timeline": [{"oid": "37f67e148461e0f1e17954c863f3ba3338b78603", "url": "https://github.com/apache/kafka/commit/37f67e148461e0f1e17954c863f3ba3338b78603", "message": "hotfix statemanager util", "committedDate": "2020-03-07T04:06:06Z", "type": "commit"}, {"oid": "cf6f7e4a098ba5f871caa08238be5d293b1c3a9c", "url": "https://github.com/apache/kafka/commit/cf6f7e4a098ba5f871caa08238be5d293b1c3a9c", "message": "Merge remote-tracking branch 'upstream/trunk' into trunk", "committedDate": "2020-03-10T17:45:41Z", "type": "commit"}, {"oid": "858908bccfea8718c94d34fd8bea21a52070ff53", "url": "https://github.com/apache/kafka/commit/858908bccfea8718c94d34fd8bea21a52070ff53", "message": "Merge remote-tracking branch 'upstream/trunk' into trunk", "committedDate": "2020-03-11T20:28:31Z", "type": "commit"}, {"oid": "1a24baa94eb583ebf92736a4a85d3e6724fd3e3e", "url": "https://github.com/apache/kafka/commit/1a24baa94eb583ebf92736a4a85d3e6724fd3e3e", "message": "add internal flag to throw upon unsupported version", "committedDate": "2020-03-11T20:30:56Z", "type": "commit"}, {"oid": "1a24baa94eb583ebf92736a4a85d3e6724fd3e3e", "url": "https://github.com/apache/kafka/commit/1a24baa94eb583ebf92736a4a85d3e6724fd3e3e", "message": "add internal flag to throw upon unsupported version", "committedDate": "2020-03-11T20:30:56Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMzNTcwMA==", "url": "https://github.com/apache/kafka/pull/8265#discussion_r391335700", "bodyText": "nit: shouldThrow -> expectThrows ?", "author": "mjsax", "createdAt": "2020-03-11T23:59:44Z", "path": "clients/src/test/java/org/apache/kafka/clients/consumer/internals/ConsumerCoordinatorTest.java", "diffHunk": "@@ -2589,6 +2557,54 @@ public void testConsumerRejoinAfterRebalance() {\n         }\n     }\n \n+    @Test\n+    public void testThrowOnUnsupportedStableFlag() {\n+        supportStableFlag((short) 6, true);\n+    }\n+\n+    @Test\n+    public void testNoThrowWhenStableFlagIsSupported() {\n+        supportStableFlag((short) 7, false);\n+    }\n+\n+    private void supportStableFlag(final short upperVersion, final boolean shouldThrow) {", "originalCommit": "1a24baa94eb583ebf92736a4a85d3e6724fd3e3e", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzExMQ==", "url": "https://github.com/apache/kafka/pull/8265#discussion_r391317111", "bodyText": "nit: if {} else {log.trace()}.", "author": "guozhangwang", "createdAt": "2020-03-11T22:58:27Z", "path": "clients/src/main/java/org/apache/kafka/common/requests/OffsetFetchRequest.java", "diffHunk": "@@ -83,6 +86,10 @@ public OffsetFetchRequest build(short version) {\n             }\n \n             if (data.requireStable() && version < 7) {\n+                if (throwOnStableFlagNotSupported) {\n+                    throw new UnsupportedVersionException(\"Broker unexpectedly doesn't support requireStable flag \" +\n+                        \"on version \" + version);\n+                }", "originalCommit": "1a24baa94eb583ebf92736a4a85d3e6724fd3e3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0ODU1Mw==", "url": "https://github.com/apache/kafka/pull/8265#discussion_r391348553", "bodyText": "Could you double check if the UnsupportedVersionException would be thrown all the way up to consumer.committed, un-wrapped?\nAlso besides consumer.committed it would be thrown to other consumer calls, e.g. consumer.poll could be possibly sending offset fetch request as part of rebalance as well. We need to make sure all consumer APIs that may get this exception updated their javadocs.", "author": "guozhangwang", "createdAt": "2020-03-12T00:50:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzExMQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTY5OTI0MQ==", "url": "https://github.com/apache/kafka/pull/8265#discussion_r391699241", "bodyText": "Addressed", "author": "abbccdda", "createdAt": "2020-03-12T15:25:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzExMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzU2Ng==", "url": "https://github.com/apache/kafka/pull/8265#discussion_r391317566", "bodyText": "nit: throw.on.fetch.stable.offsets.unsupported.", "author": "guozhangwang", "createdAt": "2020-03-11T22:59:52Z", "path": "clients/src/main/java/org/apache/kafka/clients/consumer/ConsumerConfig.java", "diffHunk": "@@ -263,6 +263,19 @@\n      */\n     static final String LEAVE_GROUP_ON_CLOSE_CONFIG = \"internal.leave.group.on.close\";\n \n+    /**\n+     * <code>internal.throw.on.stable.flag.unsupported</code>\n+     * Whether or not the consumer should throw when the new stable flag is supported. If set to <code>true</code>\n+     * then the client shall crash upon hitting it. The purpose of this flag is to prevent unexpected broker\n+     * downgrade which makes the offset fetch protection against pending commit invalid. The safest approach\n+     * is to fail fast to avoid introducing correctness issue.\n+     *\n+     * <p>\n+     * Note: this is an internal configuration and could be changed in the future in a backward incompatible way\n+     *\n+     */\n+    static final String THROW_ON_STABLE_FLAG_UNSUPPORTED = \"internal.throw.on.stable.flag.unsupported\";", "originalCommit": "1a24baa94eb583ebf92736a4a85d3e6724fd3e3e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTgwNTM3NQ==", "url": "https://github.com/apache/kafka/pull/8265#discussion_r391805375", "bodyText": "In a previous comment I requested to add the internal. prefix to align to\nLEAVE_GROUP_ON_CLOSE_CONFIG = \"internal.leave.group.on.close\";", "author": "mjsax", "createdAt": "2020-03-12T18:14:29Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTMxNzU2Ng=="}], "type": "inlineReview"}, {"oid": "d4b14abdb885cee0406fc0c93dc5602b3e600fc8", "url": "https://github.com/apache/kafka/commit/d4b14abdb885cee0406fc0c93dc5602b3e600fc8", "message": "address comments", "committedDate": "2020-03-12T01:16:28Z", "type": "commit"}, {"oid": "b2c7a974004e987d5f8d13593bc45041a97fb546", "url": "https://github.com/apache/kafka/commit/b2c7a974004e987d5f8d13593bc45041a97fb546", "message": "add consumer test and comments", "committedDate": "2020-03-12T04:37:18Z", "type": "commit"}]}