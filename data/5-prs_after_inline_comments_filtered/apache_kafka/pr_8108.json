{"pr_number": 8108, "pr_title": "KAFKA-9533: ValueTransform forwards `null` values", "pr_createdAt": "2020-02-13T17:51:14Z", "pr_url": "https://github.com/apache/kafka/pull/8108", "timeline": [{"oid": "b4589d0703592b4f27fa8c541a25acaa5cf31718", "url": "https://github.com/apache/kafka/commit/b4589d0703592b4f27fa8c541a25acaa5cf31718", "message": "Fixes KAFKA-9533: ValueTransform forwards `null` values\n\n* Fix for KStreamTransformValues to filter `null` values returned from ValueTransformer\n* Tests for `shouldNotForwardNullTransformValuesWithValueTransformerWithKey()`.", "committedDate": "2020-02-17T23:05:43Z", "type": "commit"}, {"oid": "8efedf8d78fd2742f0c702f14ab1007c023a783b", "url": "https://github.com/apache/kafka/commit/8efedf8d78fd2742f0c702f14ab1007c023a783b", "message": "Replace integration test with unit test\n\n* Remove integration test KStreamTransformIntegrationTest#esWithValueTransformerWithKey\n* Add unit test KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull", "committedDate": "2020-02-17T23:05:43Z", "type": "commit"}, {"oid": "8efedf8d78fd2742f0c702f14ab1007c023a783b", "url": "https://github.com/apache/kafka/commit/8efedf8d78fd2742f0c702f14ab1007c023a783b", "message": "Replace integration test with unit test\n\n* Remove integration test KStreamTransformIntegrationTest#esWithValueTransformerWithKey\n* Add unit test KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull", "committedDate": "2020-02-17T23:05:43Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU1NjA4Nw==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380556087", "bodyText": "req: I guess, I was not clear enough in my previous comment. Sorry for that! I see that the other unit tests in KStreamTransformValuesTest are also TopologyTestDriver tests. However, I think that is not needed in this case. TopologyTestDriver tests are harder to maintain and slower to run as a simple unit test like KStreamFlatTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull(). We need to rewrite TopologyTestDriver tests in KStreamTransformValueTest to simple unit tests at some point (not in this PR). Please use a simple unit test similar to the following.\n    @Test\n    public void shouldEmitNoRecordIfTransformReturnsNull() {\n        final ProcessorContext context = mock(ProcessorContext.class);\n        final ValueTransformerWithKey<Integer, Integer, Iterable<String>> valueTransformer = mock(ValueTransformerWithKey.class);\n        EasyMock.expect(valueTransformer.transform(inputKey, inputValue)).andReturn(null);\n        EasyMock.replay(context, valueTransfomer);\n        final Integer inputKey = 1;\n        final Integer inputValue = 10;\n        final KStreamFlatTransformValuesProcessor<Integer, Integer, String> processor = new KStreamFlatTransformValuesProcessor<>(valueTransformer);\n        processor.init(context);\n\n        processor.process(inputKey, inputValue);\n\n        EasyMock.verify(context, valueTransformer);\n    }", "author": "cadonna", "createdAt": "2020-02-18T09:38:13Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +138,54 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {", "originalCommit": "8efedf8d78fd2742f0c702f14ab1007c023a783b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgxMDk4MQ==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380810981", "bodyText": "Not a problem. Updated.", "author": "mviamari", "createdAt": "2020-02-18T17:07:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDU1NjA4Nw=="}], "type": "inlineReview"}, {"oid": "e835f4787a4591bdcab28521b0ba9a83aeee3706", "url": "https://github.com/apache/kafka/commit/e835f4787a4591bdcab28521b0ba9a83aeee3706", "message": "update KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull to use EasyMock instead of TestDriver.", "committedDate": "2020-02-18T17:05:33Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2Njk4MQ==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380866981", "bodyText": "req: Could you please remove context from the reset()? Since we did not specify any behavior for it, we also do not need to reset it.", "author": "cadonna", "createdAt": "2020-02-18T18:51:48Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);\n+        processor.init(context);\n+        EasyMock.reset(context, valueTransformer);", "originalCommit": "e835f4787a4591bdcab28521b0ba9a83aeee3706", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDkyMTY4NQ==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380921685", "bodyText": "I think that the valueTransformer is not strictly needed to be reset either, since it's not being verified, but there is a call to ValueTransformer#init, so I left it in the reset anyway.", "author": "mviamari", "createdAt": "2020-02-18T20:39:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2Njk4MQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTE4NzgzMg==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r381187832", "bodyText": "Good catch! I would prefer to remove it then.", "author": "cadonna", "createdAt": "2020-02-19T09:59:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2Njk4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2ODIzMw==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380868233", "bodyText": "req: Could you please put new KStreamTransformValues... in the next line?", "author": "cadonna", "createdAt": "2020-02-18T18:54:02Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);", "originalCommit": "e835f4787a4591bdcab28521b0ba9a83aeee3706", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2ODUyNA==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380868524", "bodyText": "req: Could you please replace .andReturn() with .andStubReturn()? This avoids the verification of the call to valueTransformer.transform(inputKey, inputValue) which I consider setup and not validation.", "author": "cadonna", "createdAt": "2020-02-18T18:54:36Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);\n+        processor.init(context);\n+        EasyMock.reset(context, valueTransformer);\n+\n+        final Integer inputKey = 1;\n+        final Integer inputValue = 10;\n+        EasyMock.expect(valueTransformer.transform(inputKey, inputValue)).andReturn(null);", "originalCommit": "e835f4787a4591bdcab28521b0ba9a83aeee3706", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg2OTc5Nw==", "url": "https://github.com/apache/kafka/pull/8108#discussion_r380869797", "bodyText": "req: Since we do not need to validate valueTransformer, could you please remove it from the verify().", "author": "cadonna", "createdAt": "2020-02-18T18:56:54Z", "path": "streams/src/test/java/org/apache/kafka/streams/kstream/internals/KStreamTransformValuesTest.java", "diffHunk": "@@ -138,6 +140,24 @@ public void close() { }\n         assertArrayEquals(expected, supplier.theCapturedProcessor().processed.toArray());\n     }\n \n+    @Test\n+    public void shouldEmitNoRecordIfTransformReturnsNull() {\n+        final ProcessorContext context = mock(ProcessorContext.class);\n+        final ValueTransformerWithKey<Integer, Integer, Integer> valueTransformer = mock(ValueTransformerWithKey.class);\n+        final KStreamTransformValues.KStreamTransformValuesProcessor<Integer, Integer, Integer> processor = new KStreamTransformValues.KStreamTransformValuesProcessor<>(valueTransformer);\n+        processor.init(context);\n+        EasyMock.reset(context, valueTransformer);\n+\n+        final Integer inputKey = 1;\n+        final Integer inputValue = 10;\n+        EasyMock.expect(valueTransformer.transform(inputKey, inputValue)).andReturn(null);\n+        EasyMock.replay(context, valueTransformer);\n+\n+        processor.process(inputKey, inputValue);\n+\n+        EasyMock.verify(context, valueTransformer);", "originalCommit": "e835f4787a4591bdcab28521b0ba9a83aeee3706", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "61de6083b3fbbcf93b70e22bdbb233b88eb411c0", "url": "https://github.com/apache/kafka/commit/61de6083b3fbbcf93b70e22bdbb233b88eb411c0", "message": "fix usage of mocks in KStreamTransformValuesTest#shouldEmitNoRecordIfTransformReturnsNull", "committedDate": "2020-02-18T20:33:53Z", "type": "commit"}, {"oid": "33aadd7036fa04a97df54031c33b1df61fd86b53", "url": "https://github.com/apache/kafka/commit/33aadd7036fa04a97df54031c33b1df61fd86b53", "message": "remove uneeded Easymock#reset", "committedDate": "2020-02-19T17:11:38Z", "type": "commit"}]}