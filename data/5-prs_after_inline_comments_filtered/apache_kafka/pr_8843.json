{"pr_number": 8843, "pr_title": "KAFKA-9991: Fix flaky unit tests", "pr_createdAt": "2020-06-10T02:50:53Z", "pr_url": "https://github.com/apache/kafka/pull/8843", "timeline": [{"oid": "711e5f67ef6bdbe98b297974ae53987b2f975086", "url": "https://github.com/apache/kafka/commit/711e5f67ef6bdbe98b297974ae53987b2f975086", "message": "fix flakiness", "committedDate": "2020-06-10T02:42:35Z", "type": "commit"}, {"oid": "8423700dcb5ef51def1d13414591f668abf9e32a", "url": "https://github.com/apache/kafka/commit/8423700dcb5ef51def1d13414591f668abf9e32a", "message": "remove unnecessary topic deletion", "committedDate": "2020-06-10T02:50:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1ODk1Ng==", "url": "https://github.com/apache/kafka/pull/8843#discussion_r437858956", "bodyText": "Does the deletion logic affect the success of each test? If not, I would prefer to keep it to simplify the broker side log for each subsequent tests, such that we don't have a lot of unused topics.", "author": "abbccdda", "createdAt": "2020-06-10T04:52:29Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -107,7 +109,6 @@ public void before() {\n     @After\n     public void after() throws Exception {\n         IntegrationTestUtils.purgeLocalStreamsState(STREAMS_CONFIG);\n-        CLUSTER.deleteAllTopicsAndWait(60000L);", "originalCommit": "8423700dcb5ef51def1d13414591f668abf9e32a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MDEzOA==", "url": "https://github.com/apache/kafka/pull/8843#discussion_r438270138", "bodyText": "Actually I think having different topics for different test cases have a merit for debugging -- in the past I've seen we unintentionally share topics between tests which is hard to trouble-shoot from the logs. Now with different topic names we would very easily notice if something went wrong.", "author": "guozhangwang", "createdAt": "2020-06-10T16:51:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1ODk1Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MTkyNw==", "url": "https://github.com/apache/kafka/pull/8843#discussion_r438271927", "bodyText": "Yeah I agree 100% with Guozhang here, I wasted a lot of time trying to debug failures in the RestoreIntegrationTest that turned out to be due to reusing a single shared topic. +1 for using different topics (especially when we actually write data to them!)", "author": "ableegoldman", "createdAt": "2020-06-10T16:54:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1ODk1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1OTI3Ng==", "url": "https://github.com/apache/kafka/pull/8843#discussion_r437859276", "bodyText": "The original logic seems unnecessary?", "author": "abbccdda", "createdAt": "2020-06-10T04:53:47Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -236,11 +237,7 @@ public void onRestoreStart(final TopicPartition topicPartition,\n                                    final String storeName,\n                                    final long startingOffset,\n                                    final long endingOffset) {\n-            try {", "originalCommit": "8423700dcb5ef51def1d13414591f668abf9e32a", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI2OTAzMw==", "url": "https://github.com/apache/kafka/pull/8843#discussion_r438269033", "bodyText": "Yes, the callee would not throw actually.", "author": "guozhangwang", "createdAt": "2020-06-10T16:49:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzg1OTI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MjM0Mw==", "url": "https://github.com/apache/kafka/pull/8843#discussion_r438272343", "bodyText": "super nit: can we rename to streams1 to be consistent with other tests?", "author": "ableegoldman", "createdAt": "2020-06-10T16:54:52Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -52,30 +51,28 @@\n import java.util.Map;\n import java.util.Properties;\n import java.util.concurrent.ConcurrentHashMap;\n-import java.util.concurrent.ExecutionException;\n \n @Category({IntegrationTest.class})\n public class KTableSourceTopicRestartIntegrationTest {\n     private static final int NUM_BROKERS = 3;\n     private static final String SOURCE_TOPIC = \"source-topic\";\n+    private static final Properties PRODUCER_CONFIG = new Properties();\n+    private static final Properties STREAMS_CONFIG = new Properties();\n \n     @ClassRule\n     public static final EmbeddedKafkaCluster CLUSTER = new EmbeddedKafkaCluster(NUM_BROKERS);\n+\n     private final Time time = CLUSTER.time;\n-    private KafkaStreams streamsOne;\n     private final StreamsBuilder streamsBuilder = new StreamsBuilder();\n     private final Map<String, String> readKeyValues = new ConcurrentHashMap<>();\n \n-    private static final Properties PRODUCER_CONFIG = new Properties();\n-    private static final Properties STREAMS_CONFIG = new Properties();\n+    private String sourceTopic;\n+    private KafkaStreams streamsOne;", "originalCommit": "8423700dcb5ef51def1d13414591f668abf9e32a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3MzIzNA==", "url": "https://github.com/apache/kafka/pull/8843#discussion_r438273234", "bodyText": "nit: use IntegrationTestUtils#safeUniqueTestName for the name", "author": "ableegoldman", "createdAt": "2020-06-10T16:56:24Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/KTableSourceTopicRestartIntegrationTest.java", "diffHunk": "@@ -96,8 +93,13 @@ public static void setUpBeforeAllTests() throws Exception {\n     public TestName testName = new TestName();\n \n     @Before\n-    public void before() {\n-        final KTable<String, String> kTable = streamsBuilder.table(SOURCE_TOPIC, Materialized.as(\"store\"));\n+    public void before() throws Exception {\n+        sourceTopic = SOURCE_TOPIC + \"-\" + testName.getMethodName();\n+        CLUSTER.createTopic(sourceTopic);\n+\n+        STREAMS_CONFIG.put(StreamsConfig.APPLICATION_ID_CONFIG, \"ktable-restore-from-source-\" + testName.getMethodName());", "originalCommit": "8423700dcb5ef51def1d13414591f668abf9e32a", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "447107848f5ec93dbbe24982bf69e82a78344751", "url": "https://github.com/apache/kafka/commit/447107848f5ec93dbbe24982bf69e82a78344751", "message": "Merge branch 'trunk' of https://github.com/apache/kafka into K9991-flaky-test", "committedDate": "2020-06-10T20:53:33Z", "type": "commit"}, {"oid": "086c1226752905788b0886c5c0710238ec27df5d", "url": "https://github.com/apache/kafka/commit/086c1226752905788b0886c5c0710238ec27df5d", "message": "github comments", "committedDate": "2020-06-10T21:06:08Z", "type": "commit"}]}