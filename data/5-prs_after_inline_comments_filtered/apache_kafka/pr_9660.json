{"pr_number": 9660, "pr_title": "Kafka 10629 - TopologyTestDriver should not require a Properties argument", "pr_createdAt": "2020-11-28T01:50:31Z", "pr_url": "https://github.com/apache/kafka/pull/9660", "timeline": [{"oid": "dc911335556e5adbb3184642dea556f2016e1f3d", "url": "https://github.com/apache/kafka/commit/dc911335556e5adbb3184642dea556f2016e1f3d", "message": "added default constructor without properties in TopologyTestDriver", "committedDate": "2020-10-29T23:50:25Z", "type": "commit"}, {"oid": "29d2981ada9b06982175b1a03f9d60c01fcef16d", "url": "https://github.com/apache/kafka/commit/29d2981ada9b06982175b1a03f9d60c01fcef16d", "message": "using constructor of TopologyTestDriver without properties parameter", "committedDate": "2020-10-30T01:16:04Z", "type": "commit"}, {"oid": "d12ef9095cd820db625332f2ac38522ca204f947", "url": "https://github.com/apache/kafka/commit/d12ef9095cd820db625332f2ac38522ca204f947", "message": "using constructor of TopologyTestDriver without properties parameter", "committedDate": "2020-10-30T01:17:55Z", "type": "commit"}, {"oid": "8fb237a7cdac1f18b1e990226fb55cc53c55bf42", "url": "https://github.com/apache/kafka/commit/8fb237a7cdac1f18b1e990226fb55cc53c55bf42", "message": "changed constructor reference to the one without properties", "committedDate": "2020-10-30T02:05:32Z", "type": "commit"}, {"oid": "e0d51752b1692aa574c3f53047984d5ca85f15d6", "url": "https://github.com/apache/kafka/commit/e0d51752b1692aa574c3f53047984d5ca85f15d6", "message": "keeping default test props final", "committedDate": "2020-10-30T18:57:49Z", "type": "commit"}, {"oid": "afa7639610e79ad28a8e0ee9f3a1eb474d177521", "url": "https://github.com/apache/kafka/commit/afa7639610e79ad28a8e0ee9f3a1eb474d177521", "message": "fixed merge conflicts", "committedDate": "2020-10-30T19:41:48Z", "type": "commit"}, {"oid": "58aec7e134f0f7ac2c67a0c34954deb48d54892e", "url": "https://github.com/apache/kafka/commit/58aec7e134f0f7ac2c67a0c34954deb48d54892e", "message": "made changes as per style guilde", "committedDate": "2020-10-31T03:56:54Z", "type": "commit"}, {"oid": "34fce937f4fbfd252c0fe8ecf026c539f24dc1b8", "url": "https://github.com/apache/kafka/commit/34fce937f4fbfd252c0fe8ecf026c539f24dc1b8", "message": "no need of static default properties", "committedDate": "2020-11-06T23:56:53Z", "type": "commit"}, {"oid": "825e8a456d226dfc139ee7db6165c81894094351", "url": "https://github.com/apache/kafka/commit/825e8a456d226dfc139ee7db6165c81894094351", "message": "provide randomized dummy app-id if it's not provided", "committedDate": "2020-11-07T04:26:11Z", "type": "commit"}, {"oid": "9bdb7b6de3b05186ba1c6430e398c9b07ab73921", "url": "https://github.com/apache/kafka/commit/9bdb7b6de3b05186ba1c6430e398c9b07ab73921", "message": "added another constructor with initial clock time parameter", "committedDate": "2020-11-08T06:41:46Z", "type": "commit"}, {"oid": "d62c8fc0ab33e4ac779f60f00e514af1c1024373", "url": "https://github.com/apache/kafka/commit/d62c8fc0ab33e4ac779f60f00e514af1c1024373", "message": "fixed merge conflicts", "committedDate": "2020-11-28T01:26:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NTc5Ng==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532055796", "bodyText": "the config is not from empty properties so it may be incorrect to remove config.", "author": "chia7712", "createdAt": "2020-11-28T16:07:39Z", "path": "streams/test-utils/src/test/java/org/apache/kafka/streams/TopologyTestDriverTest.java", "diffHunk": "@@ -471,7 +471,7 @@ public void shouldCloseProcessor() {\n \n     @Test\n     public void shouldThrowForUnknownTopic() {\n-        testDriver = new TopologyTestDriver(new Topology(), config);\n+        testDriver = new TopologyTestDriver(new Topology());", "originalCommit": "d62c8fc0ab33e4ac779f60f00e514af1c1024373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjEwNg==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532056106", "bodyText": "there are a lot of similar code change.", "author": "chia7712", "createdAt": "2020-11-28T16:11:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NTc5Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwNjM1Mw==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532106353", "bodyText": "Default config in the test provides application_id and state_dir_config parameters. Majority of the tests like shouldThrowForUnknownTopic,  shouldThrowForMissingTime,  shouldThrowNoSuchElementExceptionForUnusedOutputTopicWithDynamicRoutingdon't,  shouldCaptureSinkTopicNamesIfWrittenInto,  shouldProcessRecordForTopic, shouldSetRecordMetadata don't require these config parameters.                                                                                                                                                                    But tests using state stores such as shouldPopulateGlobalStore, shouldReturnAllStores and shouldThrowIfBuiltInStoreIsAccessedWithUntypedMethod may need specific dir config to clean up after the test. Right now I am relying on default state-dir-config value for these few tests which use state stores. I am open to change those specific tests which use state stores.", "author": "rohitrmd", "createdAt": "2020-11-28T21:02:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NTc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjAyMw==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532056023", "bodyText": "It seems to me putIfAbsent is more readable than containsKey + setProperty.", "author": "chia7712", "createdAt": "2020-11-28T16:10:20Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -298,8 +322,14 @@ private TopologyTestDriver(final InternalTopologyBuilder builder,\n                                final long initialWallClockTimeMs) {\n         final Properties configCopy = new Properties();\n         configCopy.putAll(config);\n-        configCopy.putIfAbsent(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG, \"dummy-bootstrap-host:0\");\n-        configCopy.putIfAbsent(StreamsConfig.APPLICATION_ID_CONFIG, \"dummy-topology-test-driver-app-id\");\n+        if (!configCopy.containsKey(StreamsConfig.BOOTSTRAP_SERVERS_CONFIG)) {", "originalCommit": "d62c8fc0ab33e4ac779f60f00e514af1c1024373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwNDAyOA==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532104028", "bodyText": "@chia7712 fixed it.", "author": "rohitrmd", "createdAt": "2020-11-28T20:37:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjAyMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjE1Ng==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532056156", "bodyText": "Is it ok to remove StreamsConfig.STATE_DIR_CONFIG here?", "author": "chia7712", "createdAt": "2020-11-28T16:11:33Z", "path": "streams/src/test/java/org/apache/kafka/streams/TopologyTest.java", "diffHunk": "@@ -353,8 +349,7 @@ public void shouldThrowOnUnassignedStateStoreAccess() {\n             .addProcessor(badNodeName, new LocalMockProcessorSupplier(), sourceNodeName);\n \n         try {\n-            new TopologyTestDriver(topology, mkProperties(\n-                mkMap(mkEntry(StreamsConfig.STATE_DIR_CONFIG, TestUtils.tempDirectory().getAbsolutePath()))));\n+            new TopologyTestDriver(topology);", "originalCommit": "d62c8fc0ab33e4ac779f60f00e514af1c1024373", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjEwMzczNw==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532103737", "bodyText": "That's a good point. This test is validating if exception is thrown when topology is created with processor node which doesn't have state store specified. Providing STATE_DIR_CONFIG config parameter in properties won't alter desired outcome of the test. Hence I removed it.", "author": "rohitrmd", "createdAt": "2020-11-28T20:34:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA1NjE1Ng=="}], "type": "inlineReview"}, {"oid": "324c0ea0ae2c4ade0f5320ac2e794b020f57ab52", "url": "https://github.com/apache/kafka/commit/324c0ea0ae2c4ade0f5320ac2e794b020f57ab52", "message": "made changes as per code review", "committedDate": "2020-11-28T20:35:39Z", "type": "commit"}, {"oid": "b098e345a0df5151c57c6831571be85fbf0de769", "url": "https://github.com/apache/kafka/commit/b098e345a0df5151c57c6831571be85fbf0de769", "message": "fixed failing tests", "committedDate": "2020-11-29T19:58:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4MzM0Mg==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r532983342", "bodyText": "This overload takes initialWallClockTimeMs, thus this sentence seems to be incorrect? Should go to TopologyTestDriver(final Topology topology) instead?", "author": "mjsax", "createdAt": "2020-12-01T00:01:49Z", "path": "streams/test-utils/src/main/java/org/apache/kafka/streams/TopologyTestDriver.java", "diffHunk": "@@ -254,6 +265,19 @@ public TopologyTestDriver(final Topology topology,\n         this(topology, config, null);\n     }\n \n+    /**\n+     * Create a new test diver instance.\n+     * Initialized the internally mocked wall-clock time with {@link System#currentTimeMillis() current system time}.", "originalCommit": "b098e345a0df5151c57c6831571be85fbf0de769", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5OTAwMw==", "url": "https://github.com/apache/kafka/pull/9660#discussion_r533099003", "bodyText": "@mjsax fixed the comment.", "author": "rohitrmd", "createdAt": "2020-12-01T06:25:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk4MzM0Mg=="}], "type": "inlineReview"}, {"oid": "260e36584ece3b107f83433c27fdd3a0c9c59971", "url": "https://github.com/apache/kafka/commit/260e36584ece3b107f83433c27fdd3a0c9c59971", "message": "fixed the comment as per review", "committedDate": "2020-12-01T06:24:52Z", "type": "commit"}]}