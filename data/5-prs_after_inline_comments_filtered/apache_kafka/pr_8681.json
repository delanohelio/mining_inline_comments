{"pr_number": 8681, "pr_title": "KAFKA-10010: Should make state store registration idempotent", "pr_createdAt": "2020-05-17T18:20:21Z", "pr_url": "https://github.com/apache/kafka/pull/8681", "timeline": [{"oid": "d2f26677f150951d9a6ae3d09ed6a058b936c050", "url": "https://github.com/apache/kafka/commit/d2f26677f150951d9a6ae3d09ed6a058b936c050", "message": "Handle task migrated inside corruption path", "committedDate": "2020-05-14T17:58:05Z", "type": "commit"}, {"oid": "50bedd04f4c9ddab75ba4c64f6d2df95c07635e8", "url": "https://github.com/apache/kafka/commit/50bedd04f4c9ddab75ba4c64f6d2df95c07635e8", "message": "Merge remote-tracking branch 'upstream/trunk' into trunk", "committedDate": "2020-05-15T17:48:45Z", "type": "commit"}, {"oid": "2c22da33c8b4a4683702b0e1dd555dd9674dbbb8", "url": "https://github.com/apache/kafka/commit/2c22da33c8b4a4683702b0e1dd555dd9674dbbb8", "message": "Merge remote-tracking branch 'upstream/trunk' into trunk", "committedDate": "2020-05-17T06:29:36Z", "type": "commit"}, {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "url": "https://github.com/apache/kafka/commit/eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "message": "idempotent state store registration", "committedDate": "2020-05-19T00:01:58Z", "type": "commit"}, {"oid": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "url": "https://github.com/apache/kafka/commit/eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "message": "idempotent state store registration", "committedDate": "2020-05-19T00:01:58Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw==", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426958947", "bodyText": "I think we might want to skip the re-registration higher up the call stack. In StateManagerUtil#registerStateStores we call store.init on each store which ultimately results in this registerStore being called", "author": "ableegoldman", "createdAt": "2020-05-19T00:13:22Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +", "originalCommit": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NTM2OQ==", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426975369", "bodyText": "+1, we can rely on storeManager#getStore inside StateManagerUtil to check if the store is already registered.", "author": "guozhangwang", "createdAt": "2020-05-19T01:16:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk5ODU0NQ==", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426998545", "bodyText": "So are we still required to remove the illegal argument exception here? What I'm concerned is that the latest version of state store initialization might be different from previous iteration, so it's safer to just go through the entire procedure once more.", "author": "abbccdda", "createdAt": "2020-05-19T02:45:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwMzU2MA==", "url": "https://github.com/apache/kafka/pull/8681#discussion_r427003560", "bodyText": "Nah, I think we should actually keep this (although IllegalStateException seems to make more sense, can we change it?) -- we should just make sure we don't reach it", "author": "ableegoldman", "createdAt": "2020-05-19T03:05:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzAwNjI4MA==", "url": "https://github.com/apache/kafka/pull/8681#discussion_r427006280", "bodyText": "Re: your concern, I don't think we can assume that a user's state store's init method is idempotent. AFAIK nothing should change that's relevant to the state store registration, but if something does (eg TaskCorrupted) we'd have to wipe out everything and start it all again anyways", "author": "ableegoldman", "createdAt": "2020-05-19T03:17:23Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk1ODk0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjk3NTg3Mg==", "url": "https://github.com/apache/kafka/pull/8681#discussion_r426975872", "bodyText": "nit: we could make the warn log entry more clear that we did not override the registered the store, e.g. \"Skipped registering state store {} since it has already existed in the state manager, ...\"", "author": "guozhangwang", "createdAt": "2020-05-19T01:18:01Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -266,7 +266,8 @@ public void registerStore(final StateStore store, final StateRestoreCallback sta\n         }\n \n         if (stores.containsKey(storeName)) {\n-            throw new IllegalArgumentException(format(\"%sStore %s has already been registered.\", logPrefix, storeName));\n+            log.warn(\"State Store {} has already been registered, which could be due to a half-way registration\" +\n+                \"in the previous round\", storeName);", "originalCommit": "eb661ea1ba9fad4520a39acbb00cb312f2baecb3", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "url": "https://github.com/apache/kafka/commit/ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "message": "change state manager util for idempotent registration", "committedDate": "2020-05-19T19:59:12Z", "type": "commit"}, {"oid": "ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "url": "https://github.com/apache/kafka/commit/ebf9ca4c78b51d1c0c07ae3c5866800238e310c6", "message": "change state manager util for idempotent registration", "committedDate": "2020-05-19T19:59:12Z", "type": "forcePushed"}]}