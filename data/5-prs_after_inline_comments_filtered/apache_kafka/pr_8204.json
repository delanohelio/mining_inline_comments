{"pr_number": 8204, "pr_title": "KAFKA-9633: Ensure ConfigProviders are closed", "pr_createdAt": "2020-03-02T18:01:22Z", "pr_url": "https://github.com/apache/kafka/pull/8204", "timeline": [{"oid": "0b06197f4c1949d21177358701627f41d226ec26", "url": "https://github.com/apache/kafka/commit/0b06197f4c1949d21177358701627f41d226ec26", "message": "Ensure ConfigProviders are closed\n\nFixes KAFKA-9633.", "committedDate": "2020-03-02T17:58:42Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg2NjA2NA==", "url": "https://github.com/apache/kafka/pull/8204#discussion_r416866064", "bodyText": "Looking at the initialization of workerConfigTransformer I see it should be made final.\nAnd then I notice that this is the case for connectorClientConfigOverridePolicy and all the class members of ConnectorStatusMetricsGroup. @tombentley do you mind tightening these types as well?", "author": "kkonstantine", "createdAt": "2020-04-28T19:26:07Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/Worker.java", "diffHunk": "@@ -220,6 +220,8 @@ public void stop() {\n \n         workerMetricsGroup.close();\n         connectorStatusMetricsGroup.close();\n+\n+        workerConfigTransformer.close();", "originalCommit": "0b06197f4c1949d21177358701627f41d226ec26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjg3MTkxOQ==", "url": "https://github.com/apache/kafka/pull/8204#discussion_r416871919", "bodyText": "should we also change this class to implement AutoCloseable?\nThis can't be used immediately in a try-with-resources clause, but probably better to signal the existence of this method at the class level.", "author": "kkonstantine", "createdAt": "2020-04-28T19:36:27Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerConfigTransformer.java", "diffHunk": "@@ -98,4 +101,8 @@ public void onCompletion(Throwable error, Void result) {\n         HerderRequest request = worker.herder().restartConnector(ttl, connectorName, cb);\n         connectorRequests.put(path, request);\n     }\n+\n+    public void close() {", "originalCommit": "0b06197f4c1949d21177358701627f41d226ec26", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "13ea796630adab0ee5085dc7a8ca8926a252bb75", "url": "https://github.com/apache/kafka/commit/13ea796630adab0ee5085dc7a8ca8926a252bb75", "message": "Review comment: make some fields final", "committedDate": "2020-04-29T09:20:10Z", "type": "commit"}, {"oid": "7f2a38fe9364281a989a8277bbdd84d30c56f89f", "url": "https://github.com/apache/kafka/commit/7f2a38fe9364281a989a8277bbdd84d30c56f89f", "message": "Review comment: WorkerConfigTransformer implements AutoCloseable", "committedDate": "2020-04-29T09:20:28Z", "type": "commit"}, {"oid": "1ec295242830e88fa5e4b6f8dc13911053dbc92d", "url": "https://github.com/apache/kafka/commit/1ec295242830e88fa5e4b6f8dc13911053dbc92d", "message": "Make MockFileConfigProvider.assertClosed() work multi-threaded\n\nGradle executes test classes concurrently, so MockFileConfigProvider\ncan't simply use a static field to hold its closure state.\nInstead use a protocol whereby the MockFileConfigProvider is configured\nwith some unique ket identifying the test which also used when calling\nassertClosed().", "committedDate": "2020-04-29T10:14:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQxNjkyOA==", "url": "https://github.com/apache/kafka/pull/8204#discussion_r417416928", "bodyText": "Seems volatile would works as well in this case. But that's fine for this test class.", "author": "kkonstantine", "createdAt": "2020-04-29T15:42:48Z", "path": "clients/src/test/java/org/apache/kafka/common/config/provider/MockFileConfigProvider.java", "diffHunk": "@@ -19,11 +19,46 @@\n import java.io.IOException;\n import java.io.Reader;\n import java.io.StringReader;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static org.junit.Assert.assertNotNull;\n+import static org.junit.Assert.assertTrue;\n \n public class MockFileConfigProvider extends FileConfigProvider {\n \n+    private static final Map<String, MockFileConfigProvider> INSTANCES = Collections.synchronizedMap(new HashMap<>());\n+    private String id;\n+    private boolean closed = false;\n+\n+    public void configure(Map<String, ?> configs) {\n+        Object id = configs.get(\"testId\");\n+        if (id == null) {\n+            throw new RuntimeException(getClass().getName() + \" missing 'testId' config\");\n+        }\n+        if (this.id != null) {\n+            throw new RuntimeException(getClass().getName() + \" instance was configured twice\");\n+        }\n+        this.id = id.toString();\n+        INSTANCES.put(id.toString(), this);\n+    }\n+\n     @Override\n     protected Reader reader(String path) throws IOException {\n         return new StringReader(\"key=testKey\\npassword=randomPassword\");\n     }\n+\n+    @Override\n+    public synchronized void close() {\n+        closed = true;\n+    }\n+\n+    public static void assertClosed(String id) {\n+        MockFileConfigProvider instance = INSTANCES.remove(id);\n+        assertNotNull(instance);\n+        synchronized (instance) {", "originalCommit": "1ec295242830e88fa5e4b6f8dc13911053dbc92d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bc4ff2aa6a62c1e35c225f7bd1a7e54bda6e51c9", "url": "https://github.com/apache/kafka/commit/bc4ff2aa6a62c1e35c225f7bd1a7e54bda6e51c9", "message": "Fix broken test", "committedDate": "2020-04-30T08:39:38Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQxMDM2Mg==", "url": "https://github.com/apache/kafka/pull/8204#discussion_r510410362", "bodyText": "if an exception occurs between line 477 and line 486, then the close function won't be called.  The solution would be to either create a type for providers that extends Map<String, ConfigProvider> and implements Autoclosable, or to simply put an explicit try/finally block here to ensure that the close function is called in every case.  That also implies that instantiateConfigProviders should be modified so that if an exception is thrown from inside it, any previously opened ConfigProvider instances are closed.", "author": "jherico", "createdAt": "2020-10-22T19:38:58Z", "path": "clients/src/main/java/org/apache/kafka/common/config/AbstractConfig.java", "diffHunk": "@@ -483,6 +483,7 @@ public void logUnused() {\n                 resolvedOriginals.putAll(result.data());\n             }\n         }\n+        providers.values().forEach(x -> Utils.closeQuietly(x, \"config provider\"));", "originalCommit": "bc4ff2aa6a62c1e35c225f7bd1a7e54bda6e51c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDYzMTc2Mw==", "url": "https://github.com/apache/kafka/pull/8204#discussion_r510631763", "bodyText": "Good observations @jherico . I believe the latter approach, of closing all the instantiated providers if an exception occurs in both cases, would be the most straightforward fix.\nIf you'd be interested in submitting a fix, that would be very welcome!", "author": "kkonstantine", "createdAt": "2020-10-23T05:50:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDQxMDM2Mg=="}], "type": "inlineReview"}]}