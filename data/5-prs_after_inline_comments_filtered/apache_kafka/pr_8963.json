{"pr_number": 8963, "pr_title": "KAFKA-10017: fix flaky EosBetaUpgradeIntegrationTest", "pr_createdAt": "2020-07-01T03:00:45Z", "pr_url": "https://github.com/apache/kafka/pull/8963", "timeline": [{"oid": "3f1300e0a329dd2ee1091464c2c1fa523c51e1fc", "url": "https://github.com/apache/kafka/commit/3f1300e0a329dd2ee1091464c2c1fa523c51e1fc", "message": "use punctuator to request commit", "committedDate": "2020-07-01T02:47:15Z", "type": "commit"}, {"oid": "4186531247e56862f0f74ed002a995e77b7eff99", "url": "https://github.com/apache/kafka/commit/4186531247e56862f0f74ed002a995e77b7eff99", "message": "env flakiness fixes", "committedDate": "2020-07-02T04:21:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MTc4NA==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449041784", "bodyText": "Would it speed up the test to choose a smaller number here?", "author": "vvcephei", "createdAt": "2020-07-02T14:26:47Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -837,6 +866,11 @@ public void init(final ProcessorContext context) {\n                             crash = errorInjectedClient2;\n                             sharedCommit = commitCounterClient2;\n                         }\n+                        punctuator = context.schedule(\n+                            Duration.ofSeconds(5),", "originalCommit": "4186531247e56862f0f74ed002a995e77b7eff99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyMzA0OA==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449223048", "bodyText": "I suppose it would. Does 100ms seem reasonable?", "author": "ableegoldman", "createdAt": "2020-07-02T19:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MTc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI4MDg3NA==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449280874", "bodyText": "Yeah, that's what I was thinking", "author": "vvcephei", "createdAt": "2020-07-02T21:47:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MTc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MzkwOQ==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449043909", "bodyText": "There should never be multiple requests, right? If there were, a second request might arrive between 168 and 169, violating the desired property. In that case, we should grab a lock instead. As long as there's only one requesting thread, and it always waits for the commit right after requesting, then we should be good.", "author": "vvcephei", "createdAt": "2020-07-02T14:29:40Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -147,6 +152,25 @@\n     private final AtomicInteger commitCounterClient2 = new AtomicInteger(-1);\n     private final AtomicInteger commitRequested = new AtomicInteger(0);\n \n+    private final AtomicBoolean requestCommit = new AtomicBoolean(false);\n+    private static class CommitPunctuator implements Punctuator {\n+        final ProcessorContext context;\n+        final AtomicBoolean requestCommit;\n+\n+        public CommitPunctuator(final ProcessorContext context, final AtomicBoolean requestCommit) {\n+            this.context = context;\n+            this.requestCommit = requestCommit;\n+        }\n+\n+        @Override\n+        public void punctuate(final long timestamp) {\n+            if (requestCommit.get()) {\n+                context.commit();\n+                requestCommit.set(false);\n+            }", "originalCommit": "4186531247e56862f0f74ed002a995e77b7eff99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIyMDQ0Nw==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449220447", "bodyText": "This is only meant to be used when there's a single thread (and single instance running). I just wanted to put in a quick fix for now--I'll leave a comment to warn our future selves that we'll have to tighten this up if we want to extend the test or use it elsewhere with multiple threads/instances", "author": "ableegoldman", "createdAt": "2020-07-02T19:17:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MzkwOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI4MTAwNQ==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449281005", "bodyText": "sounds good", "author": "vvcephei", "createdAt": "2020-07-02T21:48:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0MzkwOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDk5OQ==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449044999", "bodyText": "There's going to be a separate punctuator per task, right? Does the test account for this?", "author": "vvcephei", "createdAt": "2020-07-02T14:31:05Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/EosBetaUpgradeIntegrationTest.java", "diffHunk": "@@ -837,6 +866,11 @@ public void init(final ProcessorContext context) {\n                             crash = errorInjectedClient2;\n                             sharedCommit = commitCounterClient2;\n                         }\n+                        punctuator = context.schedule(", "originalCommit": "4186531247e56862f0f74ed002a995e77b7eff99", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTIxOTYyMQ==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449219621", "bodyText": "Sort of; with eos-beta when you need to commit one task, you need to commit all of them, so requesting a commit at all should be sufficient. It's kind of a subtle point, but I think it's actually preferable to just request a commit on one task so this test can also verify that we commit all tasks together", "author": "ableegoldman", "createdAt": "2020-07-02T19:15:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTI4MjMzNA==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449282334", "bodyText": "Ok, I was thinking more along the lines that we have just one requestCommit instance while we would have multiple punctuator instances all using it. It looked like a bug, but it seems like it'll be fine.", "author": "vvcephei", "createdAt": "2020-07-02T21:52:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDk5OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODIxMQ==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449798211", "bodyText": "In this test we would have multiple punctuator indeed but they would be executed by a single thread sequentially so that's fine.", "author": "guozhangwang", "createdAt": "2020-07-04T19:14:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA0NDk5OQ=="}], "type": "inlineReview"}, {"oid": "3b4b8c635c2887902f405bcfbb6e252678700290", "url": "https://github.com/apache/kafka/commit/3b4b8c635c2887902f405bcfbb6e252678700290", "message": "clarify usage and reduce punctuation interval", "committedDate": "2020-07-02T19:27:08Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTc5ODI5MQ==", "url": "https://github.com/apache/kafka/pull/8963#discussion_r449798291", "bodyText": "Makes sense to me.", "author": "guozhangwang", "createdAt": "2020-07-04T19:15:40Z", "path": "streams/src/test/java/org/apache/kafka/streams/integration/utils/IntegrationTestUtils.java", "diffHunk": "@@ -1273,7 +1273,7 @@ public void prepareForRebalance() {\n          */\n         public void waitForNextStableAssignment(final long maxWaitMs) throws InterruptedException {\n             waitForCondition(\n-                () -> nextExpectedNumStableAssignments == numStableAssignments(),\n+                () -> numStableAssignments() >= nextExpectedNumStableAssignments,", "originalCommit": "3b4b8c635c2887902f405bcfbb6e252678700290", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}