{"pr_number": 8463, "pr_title": "HOTFIX: need to cleanup any tasks closed in TaskManager", "pr_createdAt": "2020-04-10T23:25:25Z", "pr_url": "https://github.com/apache/kafka/pull/8463", "timeline": [{"oid": "e529977bab4b65a7d3dd3719415e2bde34f66f88", "url": "https://github.com/apache/kafka/commit/e529977bab4b65a7d3dd3719415e2bde34f66f88", "message": "cleanup tasks", "committedDate": "2020-04-10T04:20:03Z", "type": "commit"}, {"oid": "e50b021c4a0b43a53875aa81510d65f686957753", "url": "https://github.com/apache/kafka/commit/e50b021c4a0b43a53875aa81510d65f686957753", "message": "log level is too info", "committedDate": "2020-04-10T04:26:04Z", "type": "commit"}, {"oid": "504cc6354caead42848bbe4cb6337b007e07f184", "url": "https://github.com/apache/kafka/commit/504cc6354caead42848bbe4cb6337b007e07f184", "message": "revert excetion type change for now", "committedDate": "2020-04-10T22:03:08Z", "type": "commit"}, {"oid": "60b09bf79beaaf9aa650e8456708afb738828ae3", "url": "https://github.com/apache/kafka/commit/60b09bf79beaaf9aa650e8456708afb738828ae3", "message": "need to call cleanupTask before calling closeClean or closeDirty", "committedDate": "2020-04-10T22:35:03Z", "type": "commit"}, {"oid": "239e20ebcc371fde3e7c218335bac655bcf08c4c", "url": "https://github.com/apache/kafka/commit/239e20ebcc371fde3e7c218335bac655bcf08c4c", "message": "add test", "committedDate": "2020-04-10T22:55:17Z", "type": "commit"}, {"oid": "3902dd37fdabf34929a38cddb16adcf3b162dd31", "url": "https://github.com/apache/kafka/commit/3902dd37fdabf34929a38cddb16adcf3b162dd31", "message": "add new test", "committedDate": "2020-04-10T23:22:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MTgwOA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406981808", "bodyText": "These were absolutely spamming the logs, and don't seem like general-interest \"info\", so I demoted them to debug. But if they were set to info for a good reason I'm happy to revert", "author": "ableegoldman", "createdAt": "2020-04-10T23:26:42Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -317,7 +317,7 @@ public void prepareCommit() {\n                 stateMgr.flush();\n                 recordCollector.flush();\n \n-                log.info(\"Prepared task for committing\");\n+                log.debug(\"Prepared task for committing\");", "originalCommit": "3902dd37fdabf34929a38cddb16adcf3b162dd31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MTM1NA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407241354", "bodyText": "I think at TaskManager we already log at INFO level for time-based and user-based committing, so I'm fine with this.", "author": "guozhangwang", "createdAt": "2020-04-12T19:21:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MTgwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjUxOQ==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406982519", "bodyText": "This was the main bug, we try to batch commit active tasks above and deal with failure by adding to this dirtyTasks set. But we didn't actually do all of the required cleanup for a removed task in this loop here, specifically we did not ever call cleanupTask on tasks that were added to dirtyTasks from the additionalTasksForCommitting set on line 250", "author": "ableegoldman", "createdAt": "2020-04-10T23:29:57Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -258,23 +256,24 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n \n         for (final Map.Entry<Task, Map<TopicPartition, Long>> taskAndCheckpoint : checkpointPerTask.entrySet()) {\n             final Task task = taskAndCheckpoint.getKey();\n+            final Map<TopicPartition, Long> checkpoint = taskAndCheckpoint.getValue();\n+\n             try {\n-                task.closeClean(checkpointPerTask.get(task));\n+                completeTaskCloseClean(task, checkpoint);\n+                cleanUpTaskProducer(task, taskCloseExceptions);\n+                tasks.remove(task.id());\n             } catch (final RuntimeException e) {\n                 final String uncleanMessage = String.format(\"Failed to close task %s cleanly. Attempting to close remaining tasks before re-throwing:\", task.id());\n                 log.error(uncleanMessage, e);\n                 taskCloseExceptions.put(task.id(), e);\n                 // We've already recorded the exception (which is the point of clean).\n                 // Now, we should go ahead and complete the close because a half-closed task is no good to anyone.\n-                task.closeDirty();\n-            } finally {\n-                cleanUpTaskProducer(task, taskCloseExceptions);\n-                tasks.remove(task.id());\n+                dirtyTasks.add(task);\n             }\n         }\n \n         for (final Task task : dirtyTasks) {\n-            task.closeDirty();\n+            closeTaskDirty(task);", "originalCommit": "3902dd37fdabf34929a38cddb16adcf3b162dd31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4Mjc0OA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406982748", "bodyText": "I think we also didn't always call prepareCloseDirty before calling closeDirty. That was not the source of this particular bug, but I tried to consolidate all the cleanup tasks a bit to make sure they end up being called at all times, in the correct order", "author": "ableegoldman", "createdAt": "2020-04-10T23:31:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjUxOQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MTkxOA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407241918", "bodyText": "LGTM.", "author": "guozhangwang", "createdAt": "2020-04-12T19:26:05Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjUxOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjgzOA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406982838", "bodyText": "Verified that this test does fail on verify(changelogReader) without this fix", "author": "ableegoldman", "createdAt": "2020-04-10T23:31:50Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/TaskManagerTest.java", "diffHunk": "@@ -885,6 +885,57 @@ public void shouldNotCommitOnHandleAssignmentIfOnlyStandbyTaskClosed() {\n         assertThat(task10.commitPrepared, is(false));\n     }\n \n+    @Test\n+    public void shouldCleanupAnyTasksClosedAsDirtyAfterCommitException() {", "originalCommit": "3902dd37fdabf34929a38cddb16adcf3b162dd31", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5Mjk2OQ==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406992969", "bodyText": "Great to see this test case !", "author": "apurvam", "createdAt": "2020-04-11T00:32:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjgzOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk5MzMwOQ==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r406993309", "bodyText": "It's 500% easier to write tests for this thanks to the refactoring work @guozhangwang did for TaskManager and TaskManagerTest \ud83d\ude42", "author": "ableegoldman", "createdAt": "2020-04-11T00:34:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjk4MjgzOA=="}], "type": "inlineReview"}, {"oid": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3", "url": "https://github.com/apache/kafka/commit/5f8b15773b7d1eb96e8804a90e29cb27d390f6b3", "message": "remove unnecessary test changes", "committedDate": "2020-04-10T23:32:46Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjA5OA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407242098", "bodyText": "Could we move cleanUpTaskProducer into completeTaskCloseClean and closeTaskDirty respectively?", "author": "guozhangwang", "createdAt": "2020-04-12T19:27:50Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -258,23 +256,24 @@ public void handleAssignment(final Map<TaskId, Set<TopicPartition>> activeTasks,\n \n         for (final Map.Entry<Task, Map<TopicPartition, Long>> taskAndCheckpoint : checkpointPerTask.entrySet()) {\n             final Task task = taskAndCheckpoint.getKey();\n+            final Map<TopicPartition, Long> checkpoint = taskAndCheckpoint.getValue();\n+\n             try {\n-                task.closeClean(checkpointPerTask.get(task));\n+                completeTaskCloseClean(task, checkpoint);\n+                cleanUpTaskProducer(task, taskCloseExceptions);", "originalCommit": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczODEzNA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407738134", "bodyText": "I think yes, ultimately we can (and should), but the task producer cleanup is handled differently throughout this class and this would be a larger refactoring. I know there's some TaskManager cleanup planned or in progress already so  I wanted to hold off on anything more than the trivial refactoring done here", "author": "ableegoldman", "createdAt": "2020-04-13T21:41:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjA5OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc0NjM5Mw==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407746393", "bodyText": "Cool, sounds good.", "author": "guozhangwang", "createdAt": "2020-04-13T22:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjA5OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjM0Nw==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407242347", "bodyText": "Should we also close producers for the lost tasks as well?", "author": "guozhangwang", "createdAt": "2020-04-12T19:29:54Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -464,9 +463,7 @@ void handleLostAll() {\n             // Even though we've apparently dropped out of the group, we can continue safely to maintain our\n             // standby tasks while we rejoin.\n             if (task.isActive()) {\n-                cleanupTask(task);\n-                task.prepareCloseDirty();\n-                task.closeDirty();\n+                closeTaskDirty(task);", "originalCommit": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczOTA4Nw==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407739087", "bodyText": "We do, right below this, but rather than delegate to #cleanupTaskProducer  we just call activeTaskCreator.closeAndRemoveTaskProducerIfNeeded directly (which is what #cleanupTaskProducer ultimately does). I think we should consolidate these calls eventually, but not necessarily in this hotfix", "author": "ableegoldman", "createdAt": "2020-04-13T21:43:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjM0Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjQwNQ==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407242405", "bodyText": "Ditto, should we close producers as well?", "author": "guozhangwang", "createdAt": "2020-04-12T19:30:32Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/TaskManager.java", "diffHunk": "@@ -623,16 +630,13 @@ void shutdown(final boolean clean) {\n                     }\n                 } catch (final TaskMigratedException e) {\n                     // just ignore the exception as it doesn't matter during shutdown\n-                    task.prepareCloseDirty();\n-                    task.closeDirty();\n+                    closeTaskDirty(task);", "originalCommit": "5f8b15773b7d1eb96e8804a90e29cb27d390f6b3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzczOTYyMA==", "url": "https://github.com/apache/kafka/pull/8463#discussion_r407739620", "bodyText": "Same here, we do close it eventually a few loops after this one", "author": "ableegoldman", "createdAt": "2020-04-13T21:44:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzI0MjQwNQ=="}], "type": "inlineReview"}]}