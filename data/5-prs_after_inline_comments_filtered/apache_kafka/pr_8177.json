{"pr_number": 8177, "pr_title": "KAFKA-9605: Do not attempt to abort batches when txn manager is in fatal error", "pr_createdAt": "2020-02-26T21:47:32Z", "pr_url": "https://github.com/apache/kafka/pull/8177", "timeline": [{"oid": "0a997a40bf2fcbc275338caf094a39bdb373051e", "url": "https://github.com/apache/kafka/commit/0a997a40bf2fcbc275338caf094a39bdb373051e", "message": "do not handle failed batch after producer fenced\n\nThis reverts commit db81ce6b7cd31f6b133c044cec6f3a9742573a4e.", "committedDate": "2020-02-26T21:21:09Z", "type": "commit"}, {"oid": "0dad1a5278db7738fb5470874e040544e51bd592", "url": "https://github.com/apache/kafka/commit/0dad1a5278db7738fb5470874e040544e51bd592", "message": "unit test", "committedDate": "2020-02-26T22:01:23Z", "type": "commit"}, {"oid": "0dad1a5278db7738fb5470874e040544e51bd592", "url": "https://github.com/apache/kafka/commit/0dad1a5278db7738fb5470874e040544e51bd592", "message": "unit test", "committedDate": "2020-02-26T22:01:23Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0OTIzOA==", "url": "https://github.com/apache/kafka/pull/8177#discussion_r386549238", "bodyText": "nit: we might want log different message if we're ignoring due to a fatal state instead of due to a bumped epoch or ID.", "author": "bob-barrett", "createdAt": "2020-03-02T17:50:20Z", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/TransactionManager.java", "diffHunk": "@@ -706,9 +706,9 @@ synchronized void handleFailedBatch(ProducerBatch batch, RuntimeException except\n         maybeTransitionToErrorState(exception);\n         removeInFlightBatch(batch);\n \n-        if (!matchesProducerIdAndEpoch(batch)) {\n+        if (!matchesProducerIdAndEpoch(batch) || hasFatalError()) {\n             log.debug(\"Ignoring failed batch {} with producer id {}, epoch {}, and sequence number {} \" +\n-                            \"since the producerId has been reset internally\", batch, batch.producerId(),\n+                            \"since the batch has been reset internally\", batch, batch.producerId(),", "originalCommit": "0dad1a5278db7738fb5470874e040544e51bd592", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjY1MTE2Mw==", "url": "https://github.com/apache/kafka/pull/8177#discussion_r386651163", "bodyText": "sg", "author": "abbccdda", "createdAt": "2020-03-02T21:09:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0OTIzOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU0OTI3MA==", "url": "https://github.com/apache/kafka/pull/8177#discussion_r386549270", "bodyText": "\ud83d\udc4d", "author": "bob-barrett", "createdAt": "2020-03-02T17:50:23Z", "path": "clients/src/main/java/org/apache/kafka/clients/producer/internals/Sender.java", "diffHunk": "@@ -740,11 +740,7 @@ private void sendProduceRequest(long now, int destination, short acks, int timeo\n         }\n         ProduceRequest.Builder requestBuilder = ProduceRequest.Builder.forMagic(minUsedMagic, acks, timeout,\n                 produceRecordsByPartition, transactionalId);\n-        RequestCompletionHandler callback = new RequestCompletionHandler() {\n-            public void onComplete(ClientResponse response) {\n-                handleProduceResponse(response, recordsByPartition, time.milliseconds());\n-            }\n-        };\n+        RequestCompletionHandler callback = response -> handleProduceResponse(response, recordsByPartition, time.milliseconds());", "originalCommit": "0dad1a5278db7738fb5470874e040544e51bd592", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "5798cee17a381dcf4154cb665f2610fd4a56ce2c", "url": "https://github.com/apache/kafka/commit/5798cee17a381dcf4154cb665f2610fd4a56ce2c", "message": "amend log", "committedDate": "2020-03-02T23:12:14Z", "type": "commit"}, {"oid": "5798cee17a381dcf4154cb665f2610fd4a56ce2c", "url": "https://github.com/apache/kafka/commit/5798cee17a381dcf4154cb665f2610fd4a56ce2c", "message": "amend log", "committedDate": "2020-03-02T23:12:14Z", "type": "forcePushed"}]}