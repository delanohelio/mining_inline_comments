{"pr_number": 9010, "pr_title": "KAFKA-10262: Ensure that creating task directory is thread safe", "pr_createdAt": "2020-07-10T23:56:25Z", "pr_url": "https://github.com/apache/kafka/pull/9010", "timeline": [{"oid": "15a893e6c5c18c9eb4ea327566f6821ffe908741", "url": "https://github.com/apache/kafka/commit/15a893e6c5c18c9eb4ea327566f6821ffe908741", "message": "KAFKA-10262: Ensure that creating task directory is thread safe", "committedDate": "2020-07-10T23:54:55Z", "type": "commit"}, {"oid": "bdbc4fae6cf8cbafbc06c43c6a697a9db3d03a66", "url": "https://github.com/apache/kafka/commit/bdbc4fae6cf8cbafbc06c43c6a697a9db3d03a66", "message": "Add test", "committedDate": "2020-07-11T00:30:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzMTUxNQ==", "url": "https://github.com/apache/kafka/pull/9010#discussion_r453131515", "bodyText": "Without the fix, this test fails like 100% of the time for me. (Kinda surprising -- seems that the disk IO operations give us nice thread context switches so we hit the issue reliably.)", "author": "mjsax", "createdAt": "2020-07-11T00:32:43Z", "path": "streams/src/test/java/org/apache/kafka/streams/processor/internals/StateDirectoryTest.java", "diffHunk": "@@ -507,4 +510,51 @@ public void shouldLockGlobalStateDirectoryWhenDirectoryCreationDisabled() throws\n         initializeStateDirectory(false);\n         assertTrue(directory.lockGlobalState());\n     }\n+\n+    @Test\n+    public void shouldNotFailWhenCreatingTaskDirectoryInParallel() throws Exception {", "originalCommit": "bdbc4fae6cf8cbafbc06c43c6a697a9db3d03a66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzMjg1Mw==", "url": "https://github.com/apache/kafka/pull/9010#discussion_r453132853", "bodyText": "Huh, neat!", "author": "vvcephei", "createdAt": "2020-07-11T00:42:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzMTUxNQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzMzM2MA==", "url": "https://github.com/apache/kafka/pull/9010#discussion_r453133360", "bodyText": "In retrospect, this makes sense. The fs operations probably take an order of magnitude (at least) more time than the difference in time between starting the two threads. Thanks for adding it!", "author": "vvcephei", "createdAt": "2020-07-11T00:46:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzMTUxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzMjg3MQ==", "url": "https://github.com/apache/kafka/pull/9010#discussion_r453132871", "bodyText": "super nit: taskCreationLock --> taskDirCreationLock", "author": "ableegoldman", "createdAt": "2020-07-11T00:42:33Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StateDirectory.java", "diffHunk": "@@ -47,10 +47,10 @@\n public class StateDirectory {\n \n     private static final Pattern PATH_NAME = Pattern.compile(\"\\\\d+_\\\\d+\");\n-\n-    static final String LOCK_FILE_NAME = \".lock\";\n     private static final Logger log = LoggerFactory.getLogger(StateDirectory.class);\n+    static final String LOCK_FILE_NAME = \".lock\";\n \n+    private final Object taskCreationLock = new Object();", "originalCommit": "bdbc4fae6cf8cbafbc06c43c6a697a9db3d03a66", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzNDI1OA==", "url": "https://github.com/apache/kafka/pull/9010#discussion_r453134258", "bodyText": "That's fair.", "author": "mjsax", "createdAt": "2020-07-11T00:52:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzEzMjg3MQ=="}], "type": "inlineReview"}, {"oid": "386fa7aba2636454ed6eaf798a5413ea49d77459", "url": "https://github.com/apache/kafka/commit/386fa7aba2636454ed6eaf798a5413ea49d77459", "message": "Github comment", "committedDate": "2020-07-11T00:56:34Z", "type": "commit"}]}