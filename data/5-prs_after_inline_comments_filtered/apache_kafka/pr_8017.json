{"pr_number": 8017, "pr_title": "KAFKA-9422: Track the set of topics a connector is using (KIP-558)", "pr_createdAt": "2020-01-29T03:29:11Z", "pr_url": "https://github.com/apache/kafka/pull/8017", "timeline": [{"oid": "49dfb9543b1737bd7d16c0a59afe55caf02a25d0", "url": "https://github.com/apache/kafka/commit/49dfb9543b1737bd7d16c0a59afe55caf02a25d0", "message": "KAFKA-9422: Track the set of topics a connector is using (KIP-558)", "committedDate": "2020-01-29T20:46:41Z", "type": "commit"}, {"oid": "ac9e125100080f82e3868c2241e7b93621416375", "url": "https://github.com/apache/kafka/commit/ac9e125100080f82e3868c2241e7b93621416375", "message": "KAFKA-9422: Respond with error on topic/reset requests when reset is disabled", "committedDate": "2020-01-29T20:46:41Z", "type": "commit"}, {"oid": "228f634ccacaeae08da4bad741f3999c5387db16", "url": "https://github.com/apache/kafka/commit/228f634ccacaeae08da4bad741f3999c5387db16", "message": "KAFKA-9422: Fix formatting", "committedDate": "2020-01-29T20:46:41Z", "type": "commit"}, {"oid": "228f634ccacaeae08da4bad741f3999c5387db16", "url": "https://github.com/apache/kafka/commit/228f634ccacaeae08da4bad741f3999c5387db16", "message": "KAFKA-9422: Fix formatting", "committedDate": "2020-01-29T20:46:41Z", "type": "forcePushed"}, {"oid": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "url": "https://github.com/apache/kafka/commit/ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "message": "KAFKA-9422: Fix unchecked cast warning and unused imports", "committedDate": "2020-01-29T21:20:04Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0Njg2OA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372646868", "bodyText": "These new methods are in the runtime and not the public API, but I still would like to ask: have you thought about whether or not it makes to add default methods, just to be a bit more friendly if there are other implementations outside of the AK project? Might be good to at least capture that decision here, even if it is to leave the methods as abstract.", "author": "rhauch", "createdAt": "2020-01-29T21:43:35Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/StatusBackingStore.java", "diffHunk": "@@ -66,6 +67,12 @@\n      */\n     void putSafe(TaskStatus status);\n \n+    /**\n+     * Set the state of a connector's topic to the given value.\n+     * @param status the status of the topic used by a connector\n+     */\n+    void put(TopicStatus status);", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NDMzNA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372694334", "bodyText": "Indeed, I though initially about adding default methods for these new interface methods, but seems like put wouldn't have a reasonable default implementation. Therefore, since we'll need to extend at least one method, to maintain parity across all methods, I'm suggesting skipping defaults here. Upgrading to this version of Connect will require you to extend this interface.", "author": "kkonstantine", "createdAt": "2020-01-29T23:52:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0Njg2OA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNTAzMA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372715030", "bodyText": "That makes sense. I'm fine with the current approach of keeping all of the new methods abstract.", "author": "rhauch", "createdAt": "2020-01-30T01:09:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0Njg2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTM4Mg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671382", "bodyText": "Why return a map keyed by the connector name when ActiveTopicsInfo has the connector name in it? I understand that the ConnectorsResource is simply calling this, but maybe it'd be better to just return ActiveTopicsInfo here -- which seems closer to matching what this method is actually doing, and the fact that ConnectorsResource needs a map can be done in that class:\n    @GET\n    @Path(\"/{connector}/topics\")\n    public Map<String, ActiveTopicsInfo> getConnectorActiveTopics(final @PathParam(\"connector\") String connector) throws Throwable {\n        return herder.connectorActiveTopics(connector);\n    }\n\nto\n    @GET\n    @Path(\"/{connector}/topics\")\n    public Map<String, ActiveTopicsInfo> getConnectorActiveTopics(final @PathParam(\"connector\") String connector) throws Throwable {\n        ActiveTopicsInfo result = herder.connectorActiveTopics(connector);\n        return Collections.singletonMap(result.connector(), result);\n    }\n\nThis is kind of a minor thing, but since this is an (internal) API it seems better to reflect the actual behavior. WDYT?", "author": "rhauch", "createdAt": "2020-01-29T22:41:03Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/Herder.java", "diffHunk": "@@ -144,6 +146,24 @@\n      */\n     ConnectorStateInfo connectorStatus(String connName);\n \n+    /**\n+     * Lookup the set of topics currently used by a connector.\n+     * @param connName name of the connector\n+     */\n+    Map<String, ActiveTopicsInfo> connectorActiveTopics(String connName);", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3ODI3Nw==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372678277", "bodyText": "I see your point. Yeah, the requirement to return a map comes from the json definition in KIP-558. But what you suggest will lead to a cleaner interface extension in the herder.", "author": "kkonstantine", "createdAt": "2020-01-29T22:59:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTM4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTQzMA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671430", "bodyText": "Should be something like:\n* Request to asynchronously reset the active topics for the named connector.", "author": "rhauch", "createdAt": "2020-01-29T22:41:10Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/Herder.java", "diffHunk": "@@ -144,6 +146,24 @@\n      */\n     ConnectorStateInfo connectorStatus(String connName);\n \n+    /**\n+     * Lookup the set of topics currently used by a connector.\n+     * @param connName name of the connector\n+     */\n+    Map<String, ActiveTopicsInfo> connectorActiveTopics(String connName);\n+\n+    /**\n+     * Lookup the set of topics currently used by a connector.", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTU2NA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671564", "bodyText": "How about replacing these four lines with:\nthis(topic, Objects.requireNotNull(task).connector(), task.task(), discoverTimestamp);\n\nand then removing the TODO line?", "author": "rhauch", "createdAt": "2020-01-29T22:41:30Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/TopicStatus.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.connect.runtime;\n+\n+import org.apache.kafka.connect.util.ConnectorTaskId;\n+\n+public class TopicStatus {\n+    private final String topic;\n+    private final String connector;\n+    private final int task;\n+    private final long discoverTimestamp;\n+\n+    public TopicStatus(String topic, ConnectorTaskId task, long discoverTimestamp) {\n+        //TODO: check non-null\n+        this.topic = topic;\n+        this.connector = task.connector();\n+        this.task = task.task();\n+        this.discoverTimestamp = discoverTimestamp;", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY4MzE5Mw==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372683193", "bodyText": "This remained like this because I was undecided which constructor type to keep. Both make sense so, I'll call this now. \ud83d\udc4d", "author": "kkonstantine", "createdAt": "2020-01-29T23:14:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTU2NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTcxMw==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671713", "bodyText": "How about ensuring the topic and connector names are not null:\n        this.topic = Objects.requireNonNull(topic);\n        this.connector = Objects.requireNonNull(connector);", "author": "rhauch", "createdAt": "2020-01-29T22:41:51Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/TopicStatus.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.connect.runtime;\n+\n+import org.apache.kafka.connect.util.ConnectorTaskId;\n+\n+public class TopicStatus {\n+    private final String topic;\n+    private final String connector;\n+    private final int task;\n+    private final long discoverTimestamp;\n+\n+    public TopicStatus(String topic, ConnectorTaskId task, long discoverTimestamp) {\n+        //TODO: check non-null\n+        this.topic = topic;\n+        this.connector = task.connector();\n+        this.task = task.task();\n+        this.discoverTimestamp = discoverTimestamp;\n+    }\n+\n+    public TopicStatus(String topic, String connector, int task, long discoverTimestamp) {\n+        this.topic = topic;\n+        this.connector = connector;", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTc4Ng==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671786", "bodyText": "Might be good to add JavaDoc, if only to say:\n/*\n * Get the name of the topic.\n * \n * @return the topic name; never null\n */\n\nSimilar for the other getters.", "author": "rhauch", "createdAt": "2020-01-29T22:42:01Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/TopicStatus.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.connect.runtime;\n+\n+import org.apache.kafka.connect.util.ConnectorTaskId;\n+\n+public class TopicStatus {\n+    private final String topic;\n+    private final String connector;\n+    private final int task;\n+    private final long discoverTimestamp;\n+\n+    public TopicStatus(String topic, ConnectorTaskId task, long discoverTimestamp) {\n+        //TODO: check non-null\n+        this.topic = topic;\n+        this.connector = task.connector();\n+        this.task = task.task();\n+        this.discoverTimestamp = discoverTimestamp;\n+    }\n+\n+    public TopicStatus(String topic, String connector, int task, long discoverTimestamp) {\n+        this.topic = topic;\n+        this.connector = connector;\n+        this.task = task;\n+        this.discoverTimestamp = discoverTimestamp;\n+    }\n+\n+    public String topic() {", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTgxNA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671814", "bodyText": "What about adding a toString() method in case this gets logged?", "author": "rhauch", "createdAt": "2020-01-29T22:42:06Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/TopicStatus.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License. You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.kafka.connect.runtime;\n+\n+import org.apache.kafka.connect.util.ConnectorTaskId;\n+\n+public class TopicStatus {\n+    private final String topic;\n+    private final String connector;\n+    private final int task;\n+    private final long discoverTimestamp;\n+\n+    public TopicStatus(String topic, ConnectorTaskId task, long discoverTimestamp) {\n+        //TODO: check non-null\n+        this.topic = topic;\n+        this.connector = task.connector();\n+        this.task = task.task();\n+        this.discoverTimestamp = discoverTimestamp;\n+    }\n+\n+    public TopicStatus(String topic, String connector, int task, long discoverTimestamp) {\n+        this.topic = topic;\n+        this.connector = connector;\n+        this.task = task;\n+        this.discoverTimestamp = discoverTimestamp;\n+    }\n+\n+    public String topic() {\n+        return topic;\n+    }\n+\n+    public String connector() {\n+        return connector;\n+    }\n+\n+    public int task() {\n+        return task;\n+    }\n+\n+    public long discoverTimestamp() {\n+        return discoverTimestamp;\n+    }", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTg5Mg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671892", "bodyText": "I'm wondering if we really want to pass in the StatusBackingStore interface, or whether we should define a new interface? It'd be nice to constrain future developers to only use the methods related to active topics. It's a bit more complicated, but better captures the current intent to just allow the worker tasks to check whether a topic is considered active for a connector and if not to record that a topic has been used.", "author": "rhauch", "createdAt": "2020-01-29T22:42:20Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/WorkerTask.java", "diffHunk": "@@ -70,7 +73,9 @@ public WorkerTask(ConnectorTaskId id,\n                       TargetState initialState,\n                       ClassLoader loader,\n                       ConnectMetrics connectMetrics,\n-                      RetryWithToleranceOperator retryWithToleranceOperator) {\n+                      RetryWithToleranceOperator retryWithToleranceOperator,\n+                      Time time,\n+                      StatusBackingStore statusBackingStore) {", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwMTU5OQ==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372701599", "bodyText": "My main issue is that the new methods seem to belong to the StatusBackingStore interface. Fleshing them out to a different one (let's say TopicTracker) would would separate concerns here, but would also add a step of redirection that might be more complex to follow. wdyt?", "author": "kkonstantine", "createdAt": "2020-01-30T00:17:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTg5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxOTk3Mg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372719972", "bodyText": "Neither approach is terribly clean. I think the current approach certainly works, but as you point out if we add something like TopicTracker as a superinterface of StatusBackingStore then we'd be inconsistent with the pre-existing status methods.\nLet's keep things simple.", "author": "rhauch", "createdAt": "2020-01-30T01:29:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTg5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTk3Mw==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372671973", "bodyText": "Should this method return an error if the worker is configured to not enable the active topic feature?", "author": "rhauch", "createdAt": "2020-01-29T22:42:35Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/runtime/rest/resources/ConnectorsResource.java", "diffHunk": "@@ -173,6 +176,24 @@ public ConnectorStateInfo getConnectorStatus(final @PathParam(\"connector\") Strin\n         return herder.connectorStatus(connector);\n     }\n \n+    @GET\n+    @Path(\"/{connector}/topics\")\n+    public Map<String, ActiveTopicsInfo> getConnectorActiveTopics(final @PathParam(\"connector\") String connector) throws Throwable {\n+        return herder.connectorActiveTopics(connector);", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5MDExOA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372690118", "bodyText": "Yes. This was missed. Probably should amend slightly the KIP to describe this too.", "author": "kkonstantine", "createdAt": "2020-01-29T23:37:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5MTUzMg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372691532", "bodyText": "However, it's tricky because we currently return a map with the connector's name as a key. Leaving as is for now.", "author": "kkonstantine", "createdAt": "2020-01-29T23:42:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNzE1Mg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372717152", "bodyText": "Many of the other methods don't involve an optional feature. It may be possible to change the return type to Response, and then when the feature is disabled return an error response like in resetConnectorActiveTopics(...) but then when the feature is enabled build the map to be returned and then:\nreturn Response.ok(map).build();", "author": "rhauch", "createdAt": "2020-01-30T01:18:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcyMTcwMg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372721702", "bodyText": "Good point!\nChanged the return type to Response to return an error as well.", "author": "kkonstantine", "createdAt": "2020-01-30T01:37:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MTk3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjMxNg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672316", "bodyText": "Do we need to pass the connector name and topic name if we could instead just get them from the TopicStatus object?", "author": "rhauch", "createdAt": "2020-01-29T22:43:20Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaStatusBackingStore.java", "diffHunk": "@@ -218,6 +249,25 @@ private void sendTaskStatus(final TaskStatus status, boolean safeWrite) {\n         send(key, status, entry, safeWrite);\n     }\n \n+    private void sendTopicStatus(final String connector, final String topic, final TopicStatus status) {", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5MjYxNw==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372692617", "bodyText": "status may be null when we need to represent deletes.\nAnd I've kept it this way to avoid constructing another object, partially defined, to represent deletes/tombstones.", "author": "kkonstantine", "createdAt": "2020-01-29T23:46:13Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjMxNg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNzQ2Ng==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372717466", "bodyText": "Good point. I saw this method is called with a null topic status, but didn't put the two together. It's fine as-is.", "author": "rhauch", "createdAt": "2020-01-30T01:19:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjMxNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjM2OA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672368", "bodyText": "Would be nice to add a unit test for this method, which would require this to be protected for visibility to unit tests.", "author": "rhauch", "createdAt": "2020-01-29T22:43:28Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaStatusBackingStore.java", "diffHunk": "@@ -356,14 +433,56 @@ private TaskStatus parseTaskStatus(ConnectorTaskId taskId, byte[] data) {\n         }\n     }\n \n+    private TopicStatus parseTopicStatus(byte[] data) {", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5Mjg3Mw==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372692873", "bodyText": "True. I'm adding one which I'll extend during integration testing more.", "author": "kkonstantine", "createdAt": "2020-01-29T23:46:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjM2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjQxMA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672410", "bodyText": "Should we be a bit more fault tolerant here in case the active record is missing the task key -- or any other fields that are required? I understand that the current code will never write such a record, but it seems easy to do just in case users need/want to manually write active topic records with missing fields.", "author": "rhauch", "createdAt": "2020-01-29T22:43:35Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/KafkaStatusBackingStore.java", "diffHunk": "@@ -356,14 +433,56 @@ private TaskStatus parseTaskStatus(ConnectorTaskId taskId, byte[] data) {\n         }\n     }\n \n+    private TopicStatus parseTopicStatus(byte[] data) {\n+        try {\n+            SchemaAndValue schemaAndValue = converter.toConnectData(statusTopic, data);\n+            if (!(schemaAndValue.value() instanceof Map)) {\n+                log.error(\"Invalid topic status value {}\", schemaAndValue.value());\n+                return null;\n+            }\n+            @SuppressWarnings(\"unchecked\")\n+            Object innerValue = ((Map<String, Object>) schemaAndValue.value()).get(TOPIC_STATE_KEY);\n+            if (!(innerValue instanceof Map)) {\n+                log.error(\"Invalid topic status value {} for field {}\", innerValue, TOPIC_STATE_KEY);\n+                return null;\n+            }\n+            @SuppressWarnings(\"unchecked\")\n+            Map<String, Object> topicStatusMetadata = (Map<String, Object>) innerValue;\n+            return new TopicStatus((String) topicStatusMetadata.get(TOPIC_NAME_KEY),\n+                    (String) topicStatusMetadata.get(TOPIC_CONNECTOR_KEY),\n+                    ((Long) topicStatusMetadata.get(TOPIC_TASK_KEY)).intValue(),", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwMjc5Ng==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372702796", "bodyText": "My intention was also to be more fault tolerant. But I also didn't want to diverge from the pattern used for the rest of the values here (e.g. #parseConnectorStatus). I'd suggest refactoring in a separate PR for all.", "author": "kkonstantine", "createdAt": "2020-01-30T00:21:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjQxMA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxNzY2NA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372717664", "bodyText": "That works. Refactoring existing code is probably best in a simple but separate PR.", "author": "rhauch", "createdAt": "2020-01-30T01:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjQxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjUyOQ==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672529", "bodyText": "Might be nice to say that these parameters can never be null", "author": "rhauch", "createdAt": "2020-01-29T22:43:50Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/StatusBackingStore.java", "diffHunk": "@@ -87,6 +94,28 @@\n      */\n     Collection<TaskStatus> getAll(String connector);\n \n+    /**\n+     * Get the status of a connector's topic if the connector is actively using this topic\n+     * @param connector the connector name\n+     * @param topic the topic name", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NTc1OA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372695758", "bodyText": "Added note and runtime requirements to non-null in the implementations.", "author": "kkonstantine", "createdAt": "2020-01-29T23:56:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjUyOQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjU3Ng==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672576", "bodyText": "Might be nice to say that the connector name parameter may not be null", "author": "rhauch", "createdAt": "2020-01-29T22:43:58Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/StatusBackingStore.java", "diffHunk": "@@ -87,6 +94,28 @@\n      */\n     Collection<TaskStatus> getAll(String connector);\n \n+    /**\n+     * Get the status of a connector's topic if the connector is actively using this topic\n+     * @param connector the connector name\n+     * @param topic the topic name\n+     * @return the state or null if there is none\n+     */\n+    TopicStatus getTopic(String connector, String topic);\n+\n+    /**\n+     * Get the states of all topics that a connector is using.\n+     * @param connector the connector name", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NjM3NQ==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372696375", "bodyText": "Added note and runtime requirements to non-null in the implementations.", "author": "kkonstantine", "createdAt": "2020-01-29T23:58:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjU3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjYxNQ==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672615", "bodyText": "Can this ever be null?", "author": "rhauch", "createdAt": "2020-01-29T22:44:03Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/StatusBackingStore.java", "diffHunk": "@@ -87,6 +94,28 @@\n      */\n     Collection<TaskStatus> getAll(String connector);\n \n+    /**\n+     * Get the status of a connector's topic if the connector is actively using this topic\n+     * @param connector the connector name\n+     * @param topic the topic name\n+     * @return the state or null if there is none\n+     */\n+    TopicStatus getTopic(String connector, String topic);\n+\n+    /**\n+     * Get the states of all topics that a connector is using.\n+     * @param connector the connector name\n+     * @return a collection of topic states", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NjQ0Mg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372696442", "bodyText": "Only empty", "author": "kkonstantine", "createdAt": "2020-01-29T23:58:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjYxNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjY0OA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672648", "bodyText": "Might be nice to say that these parameters can never be null", "author": "rhauch", "createdAt": "2020-01-29T22:44:07Z", "path": "connect/runtime/src/main/java/org/apache/kafka/connect/storage/StatusBackingStore.java", "diffHunk": "@@ -87,6 +94,28 @@\n      */\n     Collection<TaskStatus> getAll(String connector);\n \n+    /**\n+     * Get the status of a connector's topic if the connector is actively using this topic\n+     * @param connector the connector name\n+     * @param topic the topic name\n+     * @return the state or null if there is none\n+     */\n+    TopicStatus getTopic(String connector, String topic);\n+\n+    /**\n+     * Get the states of all topics that a connector is using.\n+     * @param connector the connector name\n+     * @return a collection of topic states\n+     */\n+    Collection<TopicStatus> getAllTopics(String connector);\n+\n+    /**\n+     * Delete this topic from the connector's set of active topics\n+     * @param connector the connector name\n+     * @param topic the topic name", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NjkyMw==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372696923", "bodyText": "Added note and runtime requirements to non-null in the implementations.", "author": "kkonstantine", "createdAt": "2020-01-30T00:00:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjY0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjcwNA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372672704", "bodyText": "Maybe I'm missing it, but I don't see a difference between these two blocks, unlike the other two occurrences. Should this return expect.AndAnswer(...)?", "author": "rhauch", "createdAt": "2020-01-29T22:44:16Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/ErrorHandlingTaskTest.java", "diffHunk": "@@ -361,6 +365,29 @@ private void expectInitializeTask() throws Exception {\n         PowerMock.expectLastCall();\n     }\n \n+    private void expectTaskGetTopic(boolean anyTimes) {\n+        final Capture<String> connectorCapture = EasyMock.newCapture();\n+        final Capture<String> topicCapture = EasyMock.newCapture();\n+        IExpectationSetters<TopicStatus> expect = EasyMock.expect(statusBackingStore.getTopic(\n+                EasyMock.capture(connectorCapture),\n+                EasyMock.capture(topicCapture)));\n+        if (anyTimes) {\n+            expect.andStubAnswer(() -> new TopicStatus(\n+                    topicCapture.getValue(),\n+                    new ConnectorTaskId(connectorCapture.getValue(), 0),\n+                    Time.SYSTEM.milliseconds()));\n+        } else {\n+            expect.andStubAnswer(() -> new TopicStatus(\n+                    topicCapture.getValue(),\n+                    new ConnectorTaskId(connectorCapture.getValue(), 0),\n+                    Time.SYSTEM.milliseconds()));", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NzE2OA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372697168", "bodyText": "Correct. I remember noticing that, but missed to amend.", "author": "kkonstantine", "createdAt": "2020-01-30T00:01:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3MjcwNA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3Mzc4NA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372673784", "bodyText": "WDYT about doing something like the following to reduce the duplicate code:\nSupplier<TopicStatus> returnStatus = () -> new TopicStatus(\n        topicCapture.getValue(),\n        new ConnectorTaskId(connectorCapture.getValue(), 0),\n        Time.SYSTEM.milliseconds());\nif (anyTimes) {\n    expect.AndStubAnswer(returnStatus);\n} else {\n    expect.AndAnswer(returnStatus);\n}\n\nand doing the same in the other two similar methods?", "author": "rhauch", "createdAt": "2020-01-29T22:47:01Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/runtime/WorkerSinkTaskThreadedTest.java", "diffHunk": "@@ -695,6 +706,29 @@ public Object answer() throws Throwable {\n         return capturedCallback;\n     }\n \n+    private void expectTaskGetTopic(boolean anyTimes) {\n+        final Capture<String> connectorCapture = EasyMock.newCapture();\n+        final Capture<String> topicCapture = EasyMock.newCapture();\n+        IExpectationSetters<TopicStatus> expect = EasyMock.expect(statusBackingStore.getTopic(\n+                EasyMock.capture(connectorCapture),\n+                EasyMock.capture(topicCapture)));\n+        if (anyTimes) {\n+            expect.andStubAnswer(() -> new TopicStatus(\n+                    topicCapture.getValue(),\n+                    new ConnectorTaskId(connectorCapture.getValue(), 0),\n+                    Time.SYSTEM.milliseconds()));\n+        } else {\n+            expect.andAnswer(() -> new TopicStatus(\n+                    topicCapture.getValue(),\n+                    new ConnectorTaskId(connectorCapture.getValue(), 0),\n+                    Time.SYSTEM.milliseconds()));", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5ODkwNA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372698904", "bodyText": "I'm fuzzy on the details right now, but seems that it can't be inferred if it's not given inline.\nMaybe we can optimize in a follow up that will include the other calls that add two implementations of IAnswer", "author": "kkonstantine", "createdAt": "2020-01-30T00:07:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3Mzc4NA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcxOTU1MA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372719550", "bodyText": "Yeah, this was a minor change while leaving the fact there were still two other similar methods. We maybe should refactor later.", "author": "rhauch", "createdAt": "2020-01-30T01:27:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3Mzc4NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3NDAyMA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372674020", "bodyText": "Is this test really writing new active topic state?", "author": "rhauch", "createdAt": "2020-01-29T22:47:40Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/storage/KafkaStatusBackingStoreTest.java", "diffHunk": "@@ -394,6 +395,63 @@ public void readTaskState() {\n         verifyAll();\n     }\n \n+    @Test\n+    public void putTopicState() {", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5OTI3MA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372699270", "bodyText": "Hmm. Not yet. Removing for now. Will add in the follow up.", "author": "kkonstantine", "createdAt": "2020-01-30T00:08:55Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3NDAyMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3NDAzOA==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372674038", "bodyText": "Does this method really read the topic state?", "author": "rhauch", "createdAt": "2020-01-29T22:47:42Z", "path": "connect/runtime/src/test/java/org/apache/kafka/connect/storage/KafkaStatusBackingStoreTest.java", "diffHunk": "@@ -394,6 +395,63 @@ public void readTaskState() {\n         verifyAll();\n     }\n \n+    @Test\n+    public void putTopicState() {\n+        KafkaBasedLog<String, byte[]> kafkaBasedLog = mock(KafkaBasedLog.class);\n+        Converter converter = mock(JsonConverter.class);\n+        KafkaStatusBackingStore store = new KafkaStatusBackingStore(new MockTime(), converter, STATUS_TOPIC, kafkaBasedLog);\n+\n+        byte[] value = new byte[0];\n+        expect(converter.fromConnectData(eq(STATUS_TOPIC), anyObject(Schema.class), anyObject(Struct.class)))\n+                .andStubReturn(value);\n+\n+        final Capture<Callback> callbackCapture = newCapture();\n+        kafkaBasedLog.send(eq(\"status-connector-conn\"), eq(value), capture(callbackCapture));\n+        expectLastCall()\n+                .andAnswer(new IAnswer<Void>() {\n+                    @Override\n+                    public Void answer() throws Throwable {\n+                        callbackCapture.getValue().onCompletion(null, null);\n+                        return null;\n+                    }\n+                });\n+        replayAll();\n+\n+        ConnectorStatus status = new ConnectorStatus(CONNECTOR, ConnectorStatus.State.RUNNING, WORKER_ID, 0);\n+        store.put(status);\n+\n+        // state is not visible until read back from the log\n+        assertEquals(null, store.get(CONNECTOR));\n+\n+        verifyAll();\n+    }\n+\n+    @Test\n+    public void readTopicState() {", "originalCommit": "ec119b9ad4fbe6e30eabe165d5ba7818b3dcf652", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5OTMzNg==", "url": "https://github.com/apache/kafka/pull/8017#discussion_r372699336", "bodyText": "Hmm. Good catch. Not yet. Removing for now. Will add in the follow up.", "author": "kkonstantine", "createdAt": "2020-01-30T00:09:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY3NDAzOA=="}], "type": "inlineReview"}, {"oid": "7c36f7b90d7f29af5dd6daf298b4261006726ac0", "url": "https://github.com/apache/kafka/commit/7c36f7b90d7f29af5dd6daf298b4261006726ac0", "message": "KAFKA-9422: Address comments", "committedDate": "2020-01-30T00:25:30Z", "type": "commit"}, {"oid": "9529294e04330496e14eed402dedbd4adf7a2421", "url": "https://github.com/apache/kafka/commit/9529294e04330496e14eed402dedbd4adf7a2421", "message": "KAFKA-9422: Add a test on topic status records", "committedDate": "2020-01-30T00:39:17Z", "type": "commit"}, {"oid": "7328b172193c7c52d38fe24553e50c846e18319e", "url": "https://github.com/apache/kafka/commit/7328b172193c7c52d38fe24553e50c846e18319e", "message": "KAFKA-9422: Return error on topics endpoint when topic tracking is disabled", "committedDate": "2020-01-30T01:18:24Z", "type": "commit"}]}