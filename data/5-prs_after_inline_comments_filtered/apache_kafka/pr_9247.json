{"pr_number": 9247, "pr_title": "KAFKA-10362: When resuming Streams active task with EOS, the checkpoint file is deleted", "pr_createdAt": "2020-09-02T18:32:20Z", "pr_url": "https://github.com/apache/kafka/pull/9247", "timeline": [{"oid": "2ba81ca14a736d2606eb61ba700aa10280f32811", "url": "https://github.com/apache/kafka/commit/2ba81ca14a736d2606eb61ba700aa10280f32811", "message": "When resuming Streams active task with EOS, the checkpoint file is deleted", "committedDate": "2020-09-02T18:26:06Z", "type": "commit"}, {"oid": "aae073ba496f1b00c586fe804688892129980199", "url": "https://github.com/apache/kafka/commit/aae073ba496f1b00c586fe804688892129980199", "message": "changed error message of IO exception", "committedDate": "2020-09-02T18:43:43Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0MTgyOA==", "url": "https://github.com/apache/kafka/pull/9247#discussion_r485941828", "bodyText": "nit: I'd suggest we just inline this function inside StreamTask since 1) this is only triggered with EOS enabled, and its name deleteCheckPointFile maybe a bit misleading, and 2) it is a very simply function anyways.", "author": "guozhangwang", "createdAt": "2020-09-09T21:50:07Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/ProcessorStateManager.java", "diffHunk": "@@ -662,4 +662,10 @@ public TopicPartition registeredChangelogPartitionFor(final String storeName) {\n     public String changelogFor(final String storeName) {\n         return storeToChangelogTopic.get(storeName);\n     }\n+\n+    public void deleteCheckPointFile() throws IOException {", "originalCommit": "aae073ba496f1b00c586fe804688892129980199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMTUzOQ==", "url": "https://github.com/apache/kafka/pull/9247#discussion_r487431539", "bodyText": "Hi @guozhangwang\nI agree with you that name deleteCheckPointFile is a bit misleading, i think we can have a better name ( please suggest a better name :) )\nThe reasons I had written a new method inside ProcessorStateManager is because\n\nI felt that, logically; deleting the checkpoint file operation should be under ProcessorStateManager as deleting file comes under state management\nIf I have to write this inline, i will have to import checkpointFile and eosEnabled into StreamTask class; but these were already imported in ProcessorStateManager, so I created a new method in ProcessorStateManager\n\nPlease suggest how to go about it.", "author": "DOJI45", "createdAt": "2020-09-12T17:38:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0MTgyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTE1NjEwMA==", "url": "https://github.com/apache/kafka/pull/9247#discussion_r489156100", "bodyText": "SGTM. We can keep it as is then.", "author": "guozhangwang", "createdAt": "2020-09-16T04:35:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0MTgyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0MjM4NA==", "url": "https://github.com/apache/kafka/pull/9247#discussion_r485942384", "bodyText": "nit: log.debug(\"Deleted check point file upon resuming with EOS enabled\");", "author": "guozhangwang", "createdAt": "2020-09-09T21:51:25Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -332,6 +332,15 @@ public void resume() {\n             case SUSPENDED:\n                 // just transit the state without any logical changes: suspended and restoring states\n                 // are not actually any different for inner modules\n+\n+                // Deleting checkpoint file before transition to RESTORING state (KAFKA-10362)\n+                try {\n+                    stateMgr.deleteCheckPointFile();\n+                    log.debug(\"Deleted check point file\");", "originalCommit": "aae073ba496f1b00c586fe804688892129980199", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzQzMTYzNw==", "url": "https://github.com/apache/kafka/pull/9247#discussion_r487431637", "bodyText": "I will change the log message", "author": "DOJI45", "createdAt": "2020-09-12T17:38:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTk0MjM4NA=="}], "type": "inlineReview"}, {"oid": "70a7b2c3cbb60e265d10fc28d8356e8ddf2a18c3", "url": "https://github.com/apache/kafka/commit/70a7b2c3cbb60e265d10fc28d8356e8ddf2a18c3", "message": "Merge branch 'trunk' into KAFKA-10362", "committedDate": "2020-09-12T17:24:06Z", "type": "commit"}, {"oid": "489b034a8d34146d6f3de3471f44baf814cbf970", "url": "https://github.com/apache/kafka/commit/489b034a8d34146d6f3de3471f44baf814cbf970", "message": "unit test cases added", "committedDate": "2020-09-16T14:33:28Z", "type": "commit"}]}