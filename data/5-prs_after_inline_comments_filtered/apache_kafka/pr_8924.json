{"pr_number": 8924, "pr_title": "KAFKA-10198: guard against recycling dirty state", "pr_createdAt": "2020-06-24T22:44:58Z", "pr_url": "https://github.com/apache/kafka/pull/8924", "timeline": [{"oid": "c27a0ffb26322a78f14ad4fd205b26abfea5d3f6", "url": "https://github.com/apache/kafka/commit/c27a0ffb26322a78f14ad4fd205b26abfea5d3f6", "message": "validateClean", "committedDate": "2020-06-24T22:42:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTIxMjc2NQ==", "url": "https://github.com/apache/kafka/pull/8924#discussion_r445212765", "bodyText": "This diff turned out a bit awkward, basically I just factored this check out into a separate method that we should call at the beginning of both flavors of clean close", "author": "ableegoldman", "createdAt": "2020-06-24T22:46:45Z", "path": "streams/src/main/java/org/apache/kafka/streams/processor/internals/StreamTask.java", "diffHunk": "@@ -515,17 +517,20 @@ private void writeCheckpoint() {\n         stateMgr.checkpoint(checkpointableOffsets());\n     }\n \n-    /**\n-     * You must commit a task and checkpoint the state manager before closing as this will release the state dir lock\n-     */\n-    private void close(final boolean clean) {\n-        if (clean && commitNeeded) {\n-            // It may be that we failed to commit a task during handleRevocation, but \"forgot\" this and tried to\n-            // closeClean in handleAssignment. We should throw if we detect this to force the TaskManager to closeDirty\n+    private void validateClean() {\n+        // It may be that we failed to commit a task during handleRevocation, but \"forgot\" this and tried to\n+        // closeClean in handleAssignment. We should throw if we detect this to force the TaskManager to closeDirty\n+        if (commitNeeded) {\n             log.debug(\"Tried to close clean but there was pending uncommitted data, this means we failed to\"\n                           + \" commit and should close as dirty instead\");\n             throw new TaskMigratedException(\"Tried to close dirty task as clean\");\n         }\n+    }\n+\n+    /**\n+     * You must commit a task and checkpoint the state manager before closing as this will release the state dir lock\n+     */\n+    private void close(final boolean clean) {", "originalCommit": "c27a0ffb26322a78f14ad4fd205b26abfea5d3f6", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "3c8967f8f336c653a56575d2c29c15db4b16d33a", "url": "https://github.com/apache/kafka/commit/3c8967f8f336c653a56575d2c29c15db4b16d33a", "message": "add unit tests", "committedDate": "2020-06-24T22:51:03Z", "type": "commit"}, {"oid": "fc71861dfcb093d5d430f8e7a3fa8786c1d12fb1", "url": "https://github.com/apache/kafka/commit/fc71861dfcb093d5d430f8e7a3fa8786c1d12fb1", "message": "fix test setup", "committedDate": "2020-06-24T22:55:21Z", "type": "commit"}]}