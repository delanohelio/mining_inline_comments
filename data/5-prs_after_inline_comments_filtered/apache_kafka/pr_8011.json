{"pr_number": 8011, "pr_title": "KAFKA-8503; Add default api timeout to AdminClient (KIP-533)", "pr_createdAt": "2020-01-28T17:24:01Z", "pr_url": "https://github.com/apache/kafka/pull/8011", "timeline": [{"oid": "635513c61cbb5b0d8a402081c79445178604cd07", "url": "https://github.com/apache/kafka/commit/635513c61cbb5b0d8a402081c79445178604cd07", "message": "KAFKA-8503: Ignore retries config if a custom timeout is provided\n\nhttps://issues.apache.org/jira/browse/KAFKA-8503\n\nThe KIP-533 implementation.", "committedDate": "2020-01-28T16:52:38Z", "type": "commit"}, {"oid": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4", "url": "https://github.com/apache/kafka/commit/edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4", "message": "Add test cases and minor cleanups", "committedDate": "2020-01-28T17:23:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1NTc5Ng==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372555796", "bodyText": "Just to clarify my understanding, we will now retry \"forever\" with a lower request timeout (30s), but the total time spent attempting to satisfy a request will be bound by the new default.api.timeout.ms config or the explicit timeout given in the request options (if set)", "author": "mumrah", "createdAt": "2020-01-29T18:30:11Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/AdminClientConfig.java", "diffHunk": "@@ -154,10 +156,16 @@\n                                         CONNECTIONS_MAX_IDLE_MS_DOC)\n                                 .define(RETRIES_CONFIG,\n                                         Type.INT,\n-                                        5,\n-                                        atLeast(0),\n+                                        Integer.MAX_VALUE,", "originalCommit": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwMTQ4MQ==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372701481", "bodyText": "Yes, the number of retries is unbounded by default, but the time spent retrying now has a proper bound (60s).", "author": "hachikuji", "createdAt": "2020-01-30T00:16:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU1NTc5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MDEyOQ==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372560129", "bodyText": "Could we move this extra initialization logic to the factories and let the constructor accept the two new values? That we also allow us to make them final.", "author": "mumrah", "createdAt": "2020-01-29T18:38:57Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -500,9 +506,9 @@ private KafkaAdminClient(AdminClientConfig config,\n                              KafkaClient client,\n                              TimeoutProcessorFactory timeoutProcessorFactory,\n                              LogContext logContext) {\n-        this.defaultTimeoutMs = config.getInt(AdminClientConfig.REQUEST_TIMEOUT_MS_CONFIG);\n         this.clientId = clientId;\n         this.log = logContext.logger(KafkaAdminClient.class);\n+        configureDefaultApiTimeoutMsAndRequestTimeoutMs(config);", "originalCommit": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTU5OQ==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372561599", "bodyText": "There are a few other calls to calcTimeoutMsRemainingAsInt, do we need to consider the overall request timeout there as well?", "author": "mumrah", "createdAt": "2020-01-29T18:41:56Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -993,16 +1019,18 @@ private long sendEligibleCalls(long now) {\n                     continue;\n                 }\n                 Call call = calls.remove(0);\n-                int timeoutMs = calcTimeoutMsRemainingAsInt(now, call.deadlineMs);\n+                int requestTimeoutMs = Math.min(KafkaAdminClient.this.requestTimeoutMs,\n+                        calcTimeoutMsRemainingAsInt(now, call.deadlineMs));", "originalCommit": "edc0711cdb10fa4aea8c4bf67fbb8bca82ed22e4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjcwNTA3OQ==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r372705079", "bodyText": "I looked at the other callers and it seems they are just checking if the deadline has been reached. We have to do the min here since the request timeout may be smaller than the remaining time before the deadline.", "author": "hachikuji", "createdAt": "2020-01-30T00:29:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjU2MTU5OQ=="}], "type": "inlineReview"}, {"oid": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f", "url": "https://github.com/apache/kafka/commit/4ad7c907b5e4b226d3f5cf27181c1251a8a5067f", "message": "Make request timeout and default api timeout final fields", "committedDate": "2020-01-30T00:30:44Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAzMTk2MQ==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r373031961", "bodyText": "Should this say\n\nclient operations that do not explicitly accept a timeout\n\nor\n\nclient operations that do not specify a timeout", "author": "mumrah", "createdAt": "2020-01-30T15:51:41Z", "path": "clients/src/main/java/org/apache/kafka/clients/CommonClientConfigs.java", "diffHunk": "@@ -141,6 +141,10 @@\n                                                            + \"The value must be set lower than <code>session.timeout.ms</code>, but typically should be set no higher \"\n                                                            + \"than 1/3 of that value. It can be adjusted even lower to control the expected time for normal rebalances.\";\n \n+    public static final String DEFAULT_API_TIMEOUT_MS_CONFIG = \"default.api.timeout.ms\";\n+    public static final String DEFAULT_API_TIMEOUT_MS_DOC = \"Specifies the timeout (in milliseconds) for client APIs. \" +\n+            \"This configuration is used as the default timeout for all client operations that do not explicitly accept a <code>timeout</code> parameter.\";", "originalCommit": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAzMzkzOA==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r373033938", "bodyText": "This could even be static now, yes?", "author": "mumrah", "createdAt": "2020-01-30T15:54:48Z", "path": "clients/src/main/java/org/apache/kafka/clients/admin/KafkaAdminClient.java", "diffHunk": "@@ -520,8 +527,29 @@ private KafkaAdminClient(AdminClientConfig config,\n         thread.start();\n     }\n \n-    Time time() {\n-        return time;\n+    /**\n+     * If a default.api.timeout.ms has been explicitly specified, raise an error if it conflicts with request.timeout.ms.\n+     * If no default.api.timeout.ms has been configured, then set its value as the max of the default and request.timeout.ms. Also we should probably log a warning.\n+     * Otherwise, use the provided values for both configurations.\n+     *\n+     * @param config The configuration\n+     */\n+    private int configureDefaultApiTimeoutMs(AdminClientConfig config) {", "originalCommit": "4ad7c907b5e4b226d3f5cf27181c1251a8a5067f", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzA3OTI4Mg==", "url": "https://github.com/apache/kafka/pull/8011#discussion_r373079282", "bodyText": "We still have the log message, which is a bit annoying. Guess I will leave it as is unless you feel strongly about it.", "author": "hachikuji", "createdAt": "2020-01-30T17:11:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzAzMzkzOA=="}], "type": "inlineReview"}, {"oid": "c83cf9d4c951cbf57ece9e9903338e34007c7473", "url": "https://github.com/apache/kafka/commit/c83cf9d4c951cbf57ece9e9903338e34007c7473", "message": "Fix description of config", "committedDate": "2020-01-30T16:50:52Z", "type": "commit"}]}