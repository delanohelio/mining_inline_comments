{"pr_number": 1440, "pr_title": "HIVE-24087 FK side join elimination in presence of PK-FK constraint", "pr_createdAt": "2020-08-27T20:19:52Z", "pr_url": "https://github.com/apache/hive/pull/1440", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MjgzNQ==", "url": "https://github.com/apache/hive/pull/1440#discussion_r479342835", "bodyText": "why do we skip all other kinds which are not EQUALS?\nI think instead there should be a return here instead of a continue", "author": "kgyrtkirk", "createdAt": "2020-08-28T14:29:26Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/HiveJoinConstraintsRule.java", "diffHunk": "@@ -213,61 +218,137 @@ public void onMatch(RelOptRuleCall call) {\n \n     // 2) Check whether this join can be rewritten or removed\n     RewritablePKFKJoinInfo r = HiveRelOptUtil.isRewritablePKFKJoin(\n-        join, leftInput == fkInput, call.getMetadataQuery());\n+        join, fkInput,  nonFkInput, call.getMetadataQuery());\n \n     // 3) If it is the only condition, we can trigger the rewriting\n     if (r.rewritable) {\n-      List<RexNode> nullableNodes = r.nullableNodes;\n-      // If we reach here, we trigger the transform\n-      if (mode == Mode.REMOVE) {\n-        if (rightInputPotentialFK) {\n-          // First, if FK is the right input, we need to shift\n-          nullableNodes = nullableNodes.stream()\n-              .map(node -> RexUtil.shift(node, 0, -leftInput.getRowType().getFieldCount()))\n-              .collect(Collectors.toList());\n-          topProjExprs = topProjExprs.stream()\n-              .map(node -> RexUtil.shift(node, 0, -leftInput.getRowType().getFieldCount()))\n-              .collect(Collectors.toList());\n-        }\n-        // Fix nullability in references to the input node\n-        topProjExprs = HiveCalciteUtil.fixNullability(rexBuilder, topProjExprs, RelOptUtil.getFieldTypeList(fkInput.getRowType()));\n-        // Trigger transformation\n-        if (nullableNodes.isEmpty()) {\n-          call.transformTo(call.builder()\n-              .push(fkInput)\n-              .project(topProjExprs)\n-              .convert(project.getRowType(), false)\n-              .build());\n+      rewrite(mode, fkInput, nonFkInput, join, topProjExprs, call, project, r.nullableNodes);\n+    } else {\n+      // check if FK side could be removed instead\n+\n+      // Possibly this could be enhanced to take other join type into consideration.\n+      if (joinType != JoinRelType.INNER) {\n+        return;\n+      }\n+\n+      //first swap fk and non-fk input and see if we can rewrite them\n+      RewritablePKFKJoinInfo fkRemoval = HiveRelOptUtil.isRewritablePKFKJoin(\n+          join, nonFkInput, fkInput, call.getMetadataQuery());\n+\n+      if (fkRemoval.rewritable) {\n+        // we have established that nonFkInput is FK, and fkInput is PK\n+        // and there is no row filtering on FK side\n+\n+        // check that FK side join column is distinct (i.e. have a group by)\n+        ImmutableBitSet fkSideBitSet;\n+        if (nonFkInput == leftInput) {\n+          fkSideBitSet = leftBits;\n         } else {\n-          RexNode newFilterCond;\n-          if (nullableNodes.size() == 1) {\n-            newFilterCond = rexBuilder.makeCall(SqlStdOperatorTable.IS_NOT_NULL, nullableNodes.get(0));\n-          } else {\n-            List<RexNode> isNotNullConds = new ArrayList<>();\n-            for (RexNode nullableNode : nullableNodes) {\n-              isNotNullConds.add(rexBuilder.makeCall(SqlStdOperatorTable.IS_NOT_NULL, nullableNode));\n+          fkSideBitSet = rightBits;\n+        }\n+\n+        ImmutableBitSet.Builder fkJoinColBuilder = ImmutableBitSet.builder();\n+        for (RexNode conj : RelOptUtil.conjunctions(cond)) {\n+          if (!conj.isA(SqlKind.EQUALS)) {\n+            continue;", "originalCommit": "89377e579f398816ea23f914d55a76feede36929", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQzMDMxNA==", "url": "https://github.com/apache/hive/pull/1440#discussion_r479430314", "bodyText": "@kgyrtkirk If there is any other kind of predicate/condition isRewritablePKFKJoin will return false. But you are right that the code here should return instead of continue. I will update the code. Thanks for pointing it out.", "author": "vineetgarg02", "createdAt": "2020-08-28T17:05:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM0MjgzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTQ1MTQzMg==", "url": "https://github.com/apache/hive/pull/1440#discussion_r479451432", "bodyText": "nit. Use guava preconditions instead of Parquet.", "author": "jcamachor", "createdAt": "2020-08-28T17:49:38Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/HiveRelOptUtil.java", "diffHunk": "@@ -75,6 +75,7 @@\n import org.apache.hadoop.hive.ql.optimizer.calcite.translator.TypeConverter;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfo;\n import org.apache.hadoop.hive.serde2.typeinfo.TypeInfoUtils;\n+import org.apache.parquet.Preconditions;", "originalCommit": "0befb9f4ee0691adc87850ff7ae9bddddf2904cc", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "d9f412aed58c7660e171e298f513ccbf67f9b6bc", "url": "https://github.com/apache/hive/commit/d9f412aed58c7660e171e298f513ccbf67f9b6bc", "message": "FK-PK join elimiation", "committedDate": "2020-08-31T16:00:05Z", "type": "commit"}, {"oid": "4a5f1b7889fbe7130851a1ea456f2f3cf12f92d7", "url": "https://github.com/apache/hive/commit/4a5f1b7889fbe7130851a1ea456f2f3cf12f92d7", "message": "Addressing review comments", "committedDate": "2020-08-31T16:00:06Z", "type": "commit"}, {"oid": "1424bdf8a78ecb3a631bae295b14861007b89c78", "url": "https://github.com/apache/hive/commit/1424bdf8a78ecb3a631bae295b14861007b89c78", "message": "fixing import", "committedDate": "2020-08-31T16:00:06Z", "type": "forcePushed"}, {"oid": "d892925c5b294ddf31730f2d7ca8030be598a18f", "url": "https://github.com/apache/hive/commit/d892925c5b294ddf31730f2d7ca8030be598a18f", "message": "fixing imports", "committedDate": "2020-08-31T23:05:46Z", "type": "commit"}, {"oid": "d892925c5b294ddf31730f2d7ca8030be598a18f", "url": "https://github.com/apache/hive/commit/d892925c5b294ddf31730f2d7ca8030be598a18f", "message": "fixing imports", "committedDate": "2020-08-31T23:05:46Z", "type": "forcePushed"}]}