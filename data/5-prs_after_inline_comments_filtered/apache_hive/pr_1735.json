{"pr_number": 1735, "pr_title": "HIVE-24474: Failed compaction always logs TxnAbortedException (again)", "pr_createdAt": "2020-12-03T15:06:05Z", "pr_url": "https://github.com/apache/hive/pull/1735", "timeline": [{"oid": "41a688693e70a6303eb5d2cb18a2ac33839439f4", "url": "https://github.com/apache/hive/commit/41a688693e70a6303eb5d2cb18a2ac33839439f4", "message": "HIVE-24474: Failed compaction always throws TxnAbortedException (again)", "committedDate": "2020-12-03T08:43:20Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAyMDc2OQ==", "url": "https://github.com/apache/hive/pull/1735#discussion_r536020769", "bodyText": "Why not just set it to TXN_ID_NOT_SET after calling abortComapctionAndMarkFailed?", "author": "pvary", "createdAt": "2020-12-04T11:07:58Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -561,12 +561,12 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n       } catch (Throwable e) {\n         LOG.error(\"Caught exception while trying to compact \" + ci +\n             \".  Marking failed to avoid repeated failures\", e);\n-        abortCompactionAndMarkFailed(ci, compactorTxnId, e);\n+        compactorTxnId = abortCompactionAndMarkFailed(ci, compactorTxnId, e);\n       }\n     } catch (TException | IOException t) {\n       LOG.error(\"Caught an exception in the main loop of compactor worker \" + workerName, t);\n       try {\n-        abortCompactionAndMarkFailed(ci, compactorTxnId, t);\n+        compactorTxnId = abortCompactionAndMarkFailed(ci, compactorTxnId, t);", "originalCommit": "41a688693e70a6303eb5d2cb18a2ac33839439f4", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA3OTM0MA==", "url": "https://github.com/apache/hive/pull/1735#discussion_r536079340", "bodyText": "I thought that this way it would be more obvious to future developers that the compactorTxnId needs to be unset every time it's aborted.", "author": "klcopp", "createdAt": "2020-12-04T12:54:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAyMDc2OQ=="}], "type": "inlineReview"}, {"oid": "c3775e9c3a33eb5800d6ac6d0b15cafb58b3ecbb", "url": "https://github.com/apache/hive/commit/c3775e9c3a33eb5800d6ac6d0b15cafb58b3ecbb", "message": "Revert \"HIVE-24474: Failed compaction always throws TxnAbortedException (again)\"\n\nThis reverts commit 41a688693e70a6303eb5d2cb18a2ac33839439f4.", "committedDate": "2020-12-08T15:55:51Z", "type": "commit"}, {"oid": "65d4586a1bd2391f200c24604343838b9771333c", "url": "https://github.com/apache/hive/commit/65d4586a1bd2391f200c24604343838b9771333c", "message": "Created an inner class to track the compaction txn", "committedDate": "2020-12-09T15:57:38Z", "type": "commit"}, {"oid": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6", "url": "https://github.com/apache/hive/commit/70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6", "message": "Fixed mistake", "committedDate": "2020-12-10T15:13:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NjI4Mw==", "url": "https://github.com/apache/hive/pull/1735#discussion_r540796283", "bodyText": "Maybe change compactionHeartbeater to use the new class instead of Id?", "author": "pvary", "createdAt": "2020-12-11T09:09:46Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -483,12 +471,12 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n        * multiple statements in it (for query based compactor) which is not supported (and since\n        * this case some of the statements are DDL, even in the future will not be allowed in a\n        * multi-stmt txn. {@link Driver#setCompactionWriteIds(ValidWriteIdList, long)} */\n-      compactorTxnId = msc.openTxn(ci.runAs, TxnType.COMPACTION);\n+      compactionTxn.open(ci);\n \n-      heartbeater = new CompactionHeartbeater(compactorTxnId, fullTableName, conf);\n+      heartbeater = new CompactionHeartbeater(compactionTxn.getTxnId(), fullTableName, conf);", "originalCommit": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzOTUyMA==", "url": "https://github.com/apache/hive/pull/1735#discussion_r540839520", "bodyText": "Done", "author": "klcopp", "createdAt": "2020-12-11T10:17:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NjI4Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NjcwNw==", "url": "https://github.com/apache/hive/pull/1735#discussion_r540796707", "bodyText": "Maybe toString for CompactionTxnId?", "author": "pvary", "createdAt": "2020-12-11T09:10:26Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -556,20 +544,20 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n         verifyTableIdHasNotChanged(ci, t1);\n \n         LOG.info(\"Completed \" + ci.type.toString() + \" compaction for \" + ci.getFullPartitionName() + \" in txn \"\n-            + JavaUtils.txnIdToString(compactorTxnId) + \", marking as compacted.\");\n+            + JavaUtils.txnIdToString(compactionTxn.getTxnId()) + \", marking as compacted.\");", "originalCommit": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDgzOTQ2Nw==", "url": "https://github.com/apache/hive/pull/1735#discussion_r540839467", "bodyText": "Done", "author": "klcopp", "createdAt": "2020-12-11T10:17:19Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NjcwNw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NzM3Mw==", "url": "https://github.com/apache/hive/pull/1735#discussion_r540797373", "bodyText": "Maybe commitOrAbort? Or close? This is not always commit if I understand correctly", "author": "pvary", "createdAt": "2020-12-11T09:11:30Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -579,7 +567,7 @@ protected Boolean findNextCompactionAndExecute(boolean computeStats) throws Inte\n     } catch (Throwable t) {\n       LOG.error(\"Caught an exception in the main loop of compactor worker \" + workerName, t);\n     } finally {\n-      commitTxnIfSet(compactorTxnId);\n+      compactionTxn.commit();", "originalCommit": "70c7f5a1b8f7d0e537f30624606bf3b0db10d9d6", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg0MTQxOA==", "url": "https://github.com/apache/hive/pull/1735#discussion_r540841418", "bodyText": "If compaction failed, it should be aborted before this. CompactionTxn#commit will only commit the txn if it's still open.", "author": "klcopp", "createdAt": "2020-12-11T10:20:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDc5NzM3Mw=="}], "type": "inlineReview"}, {"oid": "c4f7ce97df8e3a1ebc1213c03506bd07034a41c5", "url": "https://github.com/apache/hive/commit/c4f7ce97df8e3a1ebc1213c03506bd07034a41c5", "message": "Addressed review comments", "committedDate": "2020-12-11T10:22:45Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTExMzcwMQ==", "url": "https://github.com/apache/hive/pull/1735#discussion_r541113701", "bodyText": "What if we extend AutoCloseable?\nThen we can use the try withresource without finally magic. And close could say - if needed commit.\nI think this is the last comment.\nHow do you like this code? Is it better?", "author": "pvary", "createdAt": "2020-12-11T17:36:54Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/txn/compactor/Worker.java", "diffHunk": "@@ -636,4 +621,66 @@ private static boolean isDynPartAbort(Table t, CompactionInfo ci) {\n     return t.getPartitionKeys() != null && t.getPartitionKeys().size() > 0\n         && ci.partName == null;\n   }\n+\n+  /**\n+   * Keep track of the compaction's transaction and its operations.\n+   */\n+  private class CompactionTxn {", "originalCommit": "c4f7ce97df8e3a1ebc1213c03506bd07034a41c5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "706dda7380ab3c3dfa455195928f1c89225f81f3", "url": "https://github.com/apache/hive/commit/706dda7380ab3c3dfa455195928f1c89225f81f3", "message": "Use try-with-resources", "committedDate": "2020-12-14T12:20:33Z", "type": "commit"}, {"oid": "2d8d6391821399796e1be0443a204073e1ad584e", "url": "https://github.com/apache/hive/commit/2d8d6391821399796e1be0443a204073e1ad584e", "message": "Cosmetic fixes and cleanup", "committedDate": "2020-12-14T12:40:00Z", "type": "commit"}, {"oid": "12cab7fff16ce0ce01be9e4c5292668af8789b83", "url": "https://github.com/apache/hive/commit/12cab7fff16ce0ce01be9e4c5292668af8789b83", "message": "Fixed mistake", "committedDate": "2020-12-15T08:42:33Z", "type": "commit"}]}