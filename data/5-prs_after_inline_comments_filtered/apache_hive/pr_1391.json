{"pr_number": 1391, "pr_title": "Spark client can create/alter/drop a view", "pr_createdAt": "2020-08-11T16:33:07Z", "pr_url": "https://github.com/apache/hive/pull/1391", "timeline": [{"oid": "40109583af4d1871ff27069ceea7343de7164693", "url": "https://github.com/apache/hive/commit/40109583af4d1871ff27069ceea7343de7164693", "message": "Spark client can create/alter/drop a view", "committedDate": "2020-08-11T16:29:59Z", "type": "commit"}, {"oid": "bcc17a0227379ebf66e6ad5159392a3425850180", "url": "https://github.com/apache/hive/commit/bcc17a0227379ebf66e6ad5159392a3425850180", "message": "Size of input hive privilege objects changed from 1 to 2 in checkSingleViewInput()", "committedDate": "2020-08-12T15:23:10Z", "type": "commit"}, {"oid": "76490a4e3c350ff1b4186d1ad0a2e1b30a6fa3e5", "url": "https://github.com/apache/hive/commit/76490a4e3c350ff1b4186d1ad0a2e1b30a6fa3e5", "message": "Non deferred views don't have to go through ranger authorization", "committedDate": "2020-08-14T00:55:02Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMDc4Ng==", "url": "https://github.com/apache/hive/pull/1391#discussion_r478720786", "bodyText": "Can you add a java doc of this method. May be I am missing the context here. What does deferred authorization mean?", "author": "vihangk1", "createdAt": "2020-08-27T22:02:43Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/security/authorization/command/CommandAuthorizerV2.java", "diffHunk": "@@ -121,6 +142,24 @@ private static void addPermanentFunctionEntities(SessionState ss, List<ReadEntit\n     return hivePrivobjs;\n   }\n \n+  private static boolean isDeferredAuthView(Table t){", "originalCommit": "76490a4e3c350ff1b4186d1ad0a2e1b30a6fa3e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODcyMTEwMg==", "url": "https://github.com/apache/hive/pull/1391#discussion_r478721102", "bodyText": "Instead of using a \"Authorized\" keyword, it is less error prone to create a constant and reuse it at all the places.", "author": "vihangk1", "createdAt": "2020-08-27T22:03:30Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/security/authorization/command/CommandAuthorizerV2.java", "diffHunk": "@@ -121,6 +142,24 @@ private static void addPermanentFunctionEntities(SessionState ss, List<ReadEntit\n     return hivePrivobjs;\n   }\n \n+  private static boolean isDeferredAuthView(Table t){\n+    String tableType = t.getTTable().getTableType();\n+    boolean isView = false;\n+    if (TableType.MATERIALIZED_VIEW.name().equals(tableType) || TableType.VIRTUAL_VIEW.name().equals(tableType)) {\n+      isView = true;\n+    }\n+    if(isView){\n+      Map<String, String> params = t.getParameters();\n+      if (params != null && params.containsKey(\"Authorized\")) {\n+        String authorized = params.get(\"Authorized\");", "originalCommit": "76490a4e3c350ff1b4186d1ad0a2e1b30a6fa3e5", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "eb79970920f2c814c3577366042df4d6226236a3", "url": "https://github.com/apache/hive/commit/eb79970920f2c814c3577366042df4d6226236a3", "message": "Added javadoc for deferred view. Constant value for string 'Authorized'", "committedDate": "2020-08-31T17:08:34Z", "type": "commit"}, {"oid": "1b971f7349eee65220361c78a615ec8db20e3e02", "url": "https://github.com/apache/hive/commit/1b971f7349eee65220361c78a615ec8db20e3e02", "message": "Rerun CI checks", "committedDate": "2020-08-31T17:25:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIzOTI1Nw==", "url": "https://github.com/apache/hive/pull/1391#discussion_r482239257", "bodyText": "What I meant was having a constant defined in HiveMetastoreAuthorizer.java like below.\npublic static final String DEFERRED_AUTHORIZED_KEY = \"Authorized\";\nOnce you do that you can use the key DEFERRED_AUTHORIZED_KEY everywhere whereever you are directly looking for \"Authorized\" key. The advantage of doing this way is that code is less error-prone and maintainable.\n\nFuture code modifications do introduce uppercase or lower case issues. (e.g. using \"authorized\" v/s \"Authorized\")\nIts easy to look for all the places where deferred authorized key is being used in the IDE by looking for the usages of the constant. Currently, we will have to do a git grep \"Authorized\" which is inconvenient.", "author": "vihangk1", "createdAt": "2020-09-02T17:20:23Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/security/authorization/command/CommandAuthorizerV2.java", "diffHunk": "@@ -121,6 +142,32 @@ private static void addPermanentFunctionEntities(SessionState ss, List<ReadEntit\n     return hivePrivobjs;\n   }\n \n+  /**\n+   * A deferred authorization view is view created by non-super user like spark-user. This view contains a parameter \"Authorized\"\n+   * set to false, so ranger will not authorize it during view creation. When a select statement is issued, then the ranger authorizes\n+   * the under lying tables.\n+   * @param Table t\n+   * @return boolean value\n+   */\n+  private static boolean isDeferredAuthView(Table t){\n+    String tableType = t.getTTable().getTableType();\n+    String authorizedKeyword = \"Authorized\";", "originalCommit": "1b971f7349eee65220361c78a615ec8db20e3e02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0MDE0OA==", "url": "https://github.com/apache/hive/pull/1391#discussion_r482240148", "bodyText": "The catch all exception here is not good, since the test will pass in case there is a MetaException thrown on line 142. The test added will pass without code modifications in the HiveMetastoreAuthorizer as well and hence I feel is not really a good regression test.\nAlso, looks like there are other tests in this class which do a catch all exception blocks which can give false positive (eg. testD_CreateView_SuperUser). Would be good to fix them up as well.", "author": "vihangk1", "createdAt": "2020-09-02T17:21:56Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/security/authorization/plugin/metastore/TestHiveMetaStoreAuthorizer.java", "diffHunk": "@@ -138,10 +140,37 @@ public void testC_CreateView_anyUser() throws Exception {\n               .setOwner(authorizedUser)\n               .build(conf);\n       hmsHandler.create_table(viewObj);\n+      Map<String, String> params = viewObj.getParameters();\n+      assertTrue(params.containsKey(\"Authorized\"));\n+      assertTrue(\"false\".equalsIgnoreCase(params.get(\"Authorized\")));\n     } catch (Exception e) {\n-      String err = e.getMessage();\n-      String expected = \"Operation type CREATE_VIEW not allowed for user:\" + authorizedUser;\n-      assertEquals(expected, err);\n+      // no Exceptions for user same as normal user is now allowed CREATE_VIEW operation", "originalCommit": "1b971f7349eee65220361c78a615ec8db20e3e02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjI0MDM1NA==", "url": "https://github.com/apache/hive/pull/1391#discussion_r482240354", "bodyText": "same comment as above related to exception handling.", "author": "vihangk1", "createdAt": "2020-09-02T17:22:19Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/security/authorization/plugin/metastore/TestHiveMetaStoreAuthorizer.java", "diffHunk": "@@ -138,10 +140,37 @@ public void testC_CreateView_anyUser() throws Exception {\n               .setOwner(authorizedUser)\n               .build(conf);\n       hmsHandler.create_table(viewObj);\n+      Map<String, String> params = viewObj.getParameters();\n+      assertTrue(params.containsKey(\"Authorized\"));\n+      assertTrue(\"false\".equalsIgnoreCase(params.get(\"Authorized\")));\n     } catch (Exception e) {\n-      String err = e.getMessage();\n-      String expected = \"Operation type CREATE_VIEW not allowed for user:\" + authorizedUser;\n-      assertEquals(expected, err);\n+      // no Exceptions for user same as normal user is now allowed CREATE_VIEW operation\n+    }\n+  }\n+\n+  @Test\n+  public void testC2_AlterView_anyUser() throws Exception{\n+    UserGroupInformation.setLoginUser(UserGroupInformation.createRemoteUser(authorizedUser));\n+    try {\n+      Table viewObj = new TableBuilder()\n+              .setTableName(viewName)\n+              .setType(TableType.VIRTUAL_VIEW.name())\n+              .addCol(\"name\", ColumnType.STRING_TYPE_NAME)\n+              .setOwner(authorizedUser)\n+              .build(conf);\n+      hmsHandler.create_table(viewObj);\n+      viewObj = new TableBuilder()\n+              .setTableName(viewName)\n+              .setType(TableType.VIRTUAL_VIEW.name())\n+              .addCol(\"dep\", ColumnType.STRING_TYPE_NAME)\n+              .setOwner(authorizedUser)\n+              .build(conf);\n+      hmsHandler.alter_table(\"default\", viewName, viewObj);\n+      Map<String, String> params = viewObj.getParameters();\n+      assertTrue(params.containsKey(\"Authorized\"));\n+      assertTrue(\"false\".equalsIgnoreCase(params.get(\"Authorized\")));\n+    } catch (Exception e) {", "originalCommit": "1b971f7349eee65220361c78a615ec8db20e3e02", "replyToReviewId": null, "replies": null, "type": "inlineReview"}]}