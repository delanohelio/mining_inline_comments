{"pr_number": 1684, "pr_title": "HIVE-21843: UNION query with regular expressions for column name does not work", "pr_createdAt": "2020-11-17T17:01:42Z", "pr_url": "https://github.com/apache/hive/pull/1684", "timeline": [{"oid": "bbd3fe98281ba0b6853d52c3179caec277e86a35", "url": "https://github.com/apache/hive/commit/bbd3fe98281ba0b6853d52c3179caec277e86a35", "message": "ctx-patch", "committedDate": "2020-11-17T15:08:57Z", "type": "commit"}, {"oid": "9a59e813c5d1ad4b82625449ca48942fd29c6480", "url": "https://github.com/apache/hive/commit/9a59e813c5d1ad4b82625449ca48942fd29c6480", "message": "add test", "committedDate": "2020-11-17T15:09:21Z", "type": "commit"}, {"oid": "05040b14bea855ca0e2848ba8cbbe456a6d836ac", "url": "https://github.com/apache/hive/commit/05040b14bea855ca0e2848ba8cbbe456a6d836ac", "message": "Revert \"ctx-patch\"\n\nThis reverts commit bbd3fe98281ba0b6853d52c3179caec277e86a35.", "committedDate": "2020-11-17T15:09:28Z", "type": "commit"}, {"oid": "10b81f1d8262239fadecb274417a73521d23ad1b", "url": "https://github.com/apache/hive/commit/10b81f1d8262239fadecb274417a73521d23ad1b", "message": "update test", "committedDate": "2020-11-17T15:27:59Z", "type": "commit"}, {"oid": "fb7e8065e03cd21238fa109c8be1a41d924c82e2", "url": "https://github.com/apache/hive/commit/fb7e8065e03cd21238fa109c8be1a41d924c82e2", "message": "Revert \"Revert \"ctx-patch\"\"\n\nThis reverts commit 05040b14bea855ca0e2848ba8cbbe456a6d836ac.", "committedDate": "2020-11-17T15:28:02Z", "type": "commit"}, {"oid": "d7e47b05a5442d3497bb426b8fe8aabc136fc51c", "url": "https://github.com/apache/hive/commit/d7e47b05a5442d3497bb426b8fe8aabc136fc51c", "message": "add q.out", "committedDate": "2020-11-17T15:48:46Z", "type": "commit"}, {"oid": "0e9a95856964a87408b3a731bc9c5d5162439b99", "url": "https://github.com/apache/hive/commit/0e9a95856964a87408b3a731bc9c5d5162439b99", "message": "remove no-arg parser", "committedDate": "2020-11-17T16:56:43Z", "type": "commit"}, {"oid": "c47aa8fa168f3781bbfa7dcbd3c5a45b77c590c4", "url": "https://github.com/apache/hive/commit/c47aa8fa168f3781bbfa7dcbd3c5a45b77c590c4", "message": "fix", "committedDate": "2020-11-18T09:39:57Z", "type": "commit"}, {"oid": "2b37a0d68329e0bdec576d26bb131b8652e34173", "url": "https://github.com/apache/hive/commit/2b37a0d68329e0bdec576d26bb131b8652e34173", "message": "fix lineageinfo cmdline", "committedDate": "2020-11-18T09:51:16Z", "type": "commit"}, {"oid": "56a519432151279c67b2cb1ed7735f1845c18c5c", "url": "https://github.com/apache/hive/commit/56a519432151279c67b2cb1ed7735f1845c18c5c", "message": "fix", "committedDate": "2020-11-18T10:06:52Z", "type": "commit"}, {"oid": "fd69fc9592f7f363568f6e9b482e6c36e916dfc0", "url": "https://github.com/apache/hive/commit/fd69fc9592f7f363568f6e9b482e6c36e916dfc0", "message": "Merge remote-tracking branch 'apache/master' into HIVE-21843-union-x2", "committedDate": "2020-11-30T09:52:01Z", "type": "commit"}, {"oid": "18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "url": "https://github.com/apache/hive/commit/18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "message": "fix test", "committedDate": "2020-11-30T10:13:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMDY5Mg==", "url": "https://github.com/apache/hive/pull/1684#discussion_r532610692", "bodyText": "This function is called from SemanticAnalyzer and its subclasses. I haven't found any other invocations. Is it necessary to change this to static ?", "author": "kasakrisz", "createdAt": "2020-11-30T13:51:37Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java", "diffHunk": "@@ -4453,7 +4452,7 @@ private boolean isAggregateInSelect(Node node, Collection<ASTNode> aggregateFunc\n    * Returns whether the pattern is a regex expression (instead of a normal\n    * string). Normal string is a string with all alphabets/digits and \"_\".\n    */\n-  boolean isRegex(String pattern, HiveConf conf) {\n+  static boolean isRegex(String pattern, HiveConf conf) {", "originalCommit": "18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzIxNzA4NA==", "url": "https://github.com/apache/hive/pull/1684#discussion_r533217084", "bodyText": "this patch adds a call to this method from ParseUtils  ; that's why it was neccessary to change it to at least static", "author": "kgyrtkirk", "createdAt": "2020-12-01T09:29:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMDY5Mg=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzI4NzU1NA==", "url": "https://github.com/apache/hive/pull/1684#discussion_r533287554", "bodyText": "found it.", "author": "kasakrisz", "createdAt": "2020-12-01T10:24:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMDY5Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMTkzOA==", "url": "https://github.com/apache/hive/pull/1684#discussion_r532611938", "bodyText": "nit: space\nqueryState, db, ctx);", "author": "kasakrisz", "createdAt": "2020-11-30T13:53:28Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/parse/authorization/PrivilegesTestBase.java", "diffHunk": "@@ -35,8 +37,9 @@\n \n   public static void grantUserTable(String privStr, PrivilegeType privType, QueryState queryState, Hive db)\n       throws Exception {\n+    Context ctx=new Context(new HiveConf());\n     DDLWork work = AuthorizationTestUtil.analyze(\n-        \"GRANT \" + privStr + \" ON TABLE \" + TABLE + \" TO USER \" + USER, queryState, db);\n+        \"GRANT \" + privStr + \" ON TABLE \" + TABLE + \" TO USER \" + USER, queryState, db,ctx);", "originalCommit": "18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMjUwOA==", "url": "https://github.com/apache/hive/pull/1684#discussion_r532612508", "bodyText": "nit: space\ndb, new Context", "author": "kasakrisz", "createdAt": "2020-11-30T13:54:25Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/parse/authorization/TestHiveAuthorizationTaskFactory.java", "diffHunk": "@@ -457,7 +458,7 @@ public void testGrantServer() throws Exception {\n   }\n \n   private DDLWork analyze(String command) throws Exception {\n-    return AuthorizationTestUtil.analyze(command, queryState, db);\n+    return AuthorizationTestUtil.analyze(command, queryState, db,new Context(queryState.getConf()));", "originalCommit": "18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMzA1Mg==", "url": "https://github.com/apache/hive/pull/1684#discussion_r532613052", "bodyText": "nit: space\ns.hr='11'\", ctx);", "author": "kasakrisz", "createdAt": "2020-11-30T13:55:11Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/tool/TestLineageInfo.java", "diffHunk": "@@ -58,7 +76,7 @@ public void testSimpleQuery() {\n     try {\n       lep.getLineageInfo(\"INSERT OVERWRITE TABLE dest1 partition (ds = '111')  \" \n           + \"SELECT s.* FROM srcpart TABLESAMPLE (BUCKET 1 OUT OF 1) s \" \n-          + \"WHERE s.ds='2008-04-08' and s.hr='11'\");\n+          + \"WHERE s.ds='2008-04-08' and s.hr='11'\",ctx);", "originalCommit": "18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMzcwOQ==", "url": "https://github.com/apache/hive/pull/1684#discussion_r532613709", "bodyText": "c.c4\", ctx);", "author": "kasakrisz", "createdAt": "2020-11-30T13:56:03Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/tool/TestLineageInfo.java", "diffHunk": "@@ -71,47 +89,37 @@ public void testSimpleQuery() {\n   }\n \n   @Test\n-  public void testSimpleQuery2() {\n+  public void testSimpleQuery2() throws Exception {\n     LineageInfo lep = new LineageInfo();\n-    try {\n-      lep.getLineageInfo(\"FROM (FROM src select src.key, src.value \" \n-          + \"WHERE src.key < 10 UNION ALL FROM src SELECT src.* WHERE src.key > 10 ) unioninput \" \n-          + \"INSERT OVERWRITE DIRECTORY '../../../../build/contrib/hive/ql/test/data/warehouse/union.out' \" \n-          + \"SELECT unioninput.*\");\n-      TreeSet<String> i = new TreeSet<String>();\n-      TreeSet<String> o = new TreeSet<String>();\n-      i.add(\"src\");\n-      checkOutput(lep, i, o);\n-    } catch (Exception e) {\n-      e.printStackTrace();\n-      fail(\"Failed\");\n-    }\n+    lep.getLineageInfo(\"FROM (FROM src select src.key, src.value \"\n+        + \"WHERE src.key < 10 UNION ALL FROM src SELECT src.* WHERE src.key > 10 ) unioninput \"\n+        + \"INSERT OVERWRITE DIRECTORY '../../../../build/contrib/hive/ql/test/data/warehouse/union.out' \"\n+        + \"SELECT unioninput.*\",ctx);\n+    TreeSet<String> i = new TreeSet<String>();\n+    TreeSet<String> o = new TreeSet<String>();\n+    i.add(\"src\");\n+    checkOutput(lep, i, o);\n   }\n \n   @Test\n-  public void testSimpleQuery3() {\n+  public void testSimpleQuery3() throws Exception {\n     LineageInfo lep = new LineageInfo();\n-    try {\n-      lep.getLineageInfo(\"FROM (FROM src select src.key, src.value \" \n-          + \"WHERE src.key < 10 UNION ALL FROM src1 SELECT src1.* WHERE src1.key > 10 ) unioninput \" \n-          + \"INSERT OVERWRITE DIRECTORY '../../../../build/contrib/hive/ql/test/data/warehouse/union.out' \" \n-          + \"SELECT unioninput.*\");\n-      TreeSet<String> i = new TreeSet<String>();\n-      TreeSet<String> o = new TreeSet<String>();\n-      i.add(\"src\");\n-      i.add(\"src1\");\n-      checkOutput(lep, i, o);\n-    } catch (Exception e) {\n-      e.printStackTrace();\n-      fail(\"Failed\");\n-    }\n+    lep.getLineageInfo(\"FROM (FROM src select src.key, src.value \"\n+        + \"WHERE src.key < 10 UNION ALL FROM src1 SELECT src1.* WHERE src1.key > 10 ) unioninput \"\n+        + \"INSERT OVERWRITE DIRECTORY '../../../../build/contrib/hive/ql/test/data/warehouse/union.out' \"\n+        + \"SELECT unioninput.*\",ctx);\n+    TreeSet<String> i = new TreeSet<String>();\n+    TreeSet<String> o = new TreeSet<String>();\n+    i.add(\"src\");\n+    i.add(\"src1\");\n+    checkOutput(lep, i, o);\n   }\n \n   @Test\n   public void testSimpleQuery4() {\n     LineageInfo lep = new LineageInfo();\n     try {\n-      lep.getLineageInfo(\"FROM ( FROM ( FROM src1 src1 SELECT src1.key AS c1, src1.value AS c2 WHERE src1.key > 10 and src1.key < 20) a RIGHT OUTER JOIN ( FROM src2 src2 SELECT src2.key AS c3, src2.value AS c4 WHERE src2.key > 15 and src2.key < 25) b ON (a.c1 = b.c3) SELECT a.c1 AS c1, a.c2 AS c2, b.c3 AS c3, b.c4 AS c4) c SELECT c.c1, c.c2, c.c3, c.c4\");\n+      lep.getLineageInfo(\"FROM ( FROM ( FROM src1 src1 SELECT src1.key AS c1, src1.value AS c2 WHERE src1.key > 10 and src1.key < 20) a RIGHT OUTER JOIN ( FROM src2 src2 SELECT src2.key AS c3, src2.value AS c4 WHERE src2.key > 15 and src2.key < 25) b ON (a.c1 = b.c3) SELECT a.c1 AS c1, a.c2 AS c2, b.c3 AS c3, b.c4 AS c4) c SELECT c.c1, c.c2, c.c3, c.c4\",ctx);", "originalCommit": "18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYxMzg4NQ==", "url": "https://github.com/apache/hive/pull/1684#discussion_r532613885", "bodyText": "(a.x = b.y)\", ctx);", "author": "kasakrisz", "createdAt": "2020-11-30T13:56:17Z", "path": "ql/src/test/org/apache/hadoop/hive/ql/tool/TestLineageInfo.java", "diffHunk": "@@ -128,7 +136,7 @@ public void testSimpleQuery5() {\n     LineageInfo lep = new LineageInfo();\n     try {\n       lep.getLineageInfo(\"insert overwrite table x select a.y, b.y \" \n-          + \"from a a full outer join b b on (a.x = b.y)\");\n+          + \"from a a full outer join b b on (a.x = b.y)\",ctx);", "originalCommit": "18d3a531a53a779c4f2c69ab2eda94b2f88e8814", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "bd2dfc9c0868232a9f55894b9e229131ebf53a1b", "url": "https://github.com/apache/hive/commit/bd2dfc9c0868232a9f55894b9e229131ebf53a1b", "message": "add space before ctx\n\nfix space", "committedDate": "2020-12-01T09:32:53Z", "type": "commit"}]}