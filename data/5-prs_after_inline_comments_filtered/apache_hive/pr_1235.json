{"pr_number": 1235, "pr_title": "HIVE-23830: Remove shutdownRunner runner after query is committed", "pr_createdAt": "2020-07-10T01:05:42Z", "pr_url": "https://github.com/apache/hive/pull/1235", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxNjc5MA==", "url": "https://github.com/apache/hive/pull/1235#discussion_r452616790", "bodyText": "This method starts to look like a cleanup.\nShall we separate out the functions to a different method, or just change the name?", "author": "pvary", "createdAt": "2020-07-10T04:33:14Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/DriverTxnHandler.java", "diffHunk": "@@ -553,11 +553,13 @@ private void release(boolean releaseLocks) {\n         LOG.warn(\"Exception when releasing locking in destroy: \" + e.getMessage());\n       }\n     }\n-    ShutdownHookManager.removeShutdownHook(shutdownRunner);\n+    ShutdownHookManager.removeShutdownHook(txnRollbackRunner);\n   }\n \n   void releaseLocksAndCommitOrRollback(boolean commit) throws LockException {", "originalCommit": "e9c3da0d2c8467d876343e2a9ab486908c6b1488", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYzOTc4OQ==", "url": "https://github.com/apache/hive/pull/1235#discussion_r452639789", "bodyText": "This is the one method that is called from everywhere to end a transaction in either way. Definitely more than a cleanup method. So I think we should not rename it to something that signals it is just a cleanup. I did not want to extract the two lines of clean up to another method either. What is your suggestion?", "author": "mustafaiman", "createdAt": "2020-07-10T06:07:08Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxNjc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY0MzY3Nw==", "url": "https://github.com/apache/hive/pull/1235#discussion_r452643677", "bodyText": "I do not have better idea than separate out to a cleanup method. I was hoping you come up with a golden one :)\nDoing cleanup in something called as \"releaseLocksAndCommitOrRollback\" is definitely not a good idea IMHO.", "author": "pvary", "createdAt": "2020-07-10T06:19:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxNjc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjY3NzkyMw==", "url": "https://github.com/apache/hive/pull/1235#discussion_r452677923", "bodyText": "After some more thought, I still was not able to come up with a really good idea :(\nThe best I can think is that we should rename the method to commitAndCleanUp\nBut I still open for any other ideas if you have some.\nThanks,\nPeter", "author": "pvary", "createdAt": "2020-07-10T07:43:12Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxNjc5MA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjkyOTgwNg==", "url": "https://github.com/apache/hive/pull/1235#discussion_r452929806", "bodyText": "I would not rename to commitAndCleanup because this method also rolls back transaction. I'll rename it to endTransactionAndCleanup", "author": "mustafaiman", "createdAt": "2020-07-10T15:54:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjYxNjc5MA=="}], "type": "inlineReview"}, {"oid": "4bab325b553fb25f3842bda1518e6bc755c7f55a", "url": "https://github.com/apache/hive/commit/4bab325b553fb25f3842bda1518e6bc755c7f55a", "message": "HIVE-23830: Remove shutdownRunner runner after query is committed\n\nEach query creates a shutdownRunner which will release transactional resources in case JVM exits mid-query. These shutdownRunners are not removed until session is closed. Session lifetime is unbounded. These shutdown hooks can cause OOM. We should remove them once query is committed or rolled back.\n\nChange-Id: I0b747bbfb2a451c2be1a28f21d4fb6354f76ee5a", "committedDate": "2020-07-10T15:54:49Z", "type": "commit"}, {"oid": "4bab325b553fb25f3842bda1518e6bc755c7f55a", "url": "https://github.com/apache/hive/commit/4bab325b553fb25f3842bda1518e6bc755c7f55a", "message": "HIVE-23830: Remove shutdownRunner runner after query is committed\n\nEach query creates a shutdownRunner which will release transactional resources in case JVM exits mid-query. These shutdownRunners are not removed until session is closed. Session lifetime is unbounded. These shutdown hooks can cause OOM. We should remove them once query is committed or rolled back.\n\nChange-Id: I0b747bbfb2a451c2be1a28f21d4fb6354f76ee5a", "committedDate": "2020-07-10T15:54:49Z", "type": "forcePushed"}]}