{"pr_number": 1703, "pr_title": "HIVE-24423: Improve DbNotificationListener Thread", "pr_createdAt": "2020-11-24T16:38:46Z", "pr_url": "https://github.com/apache/hive/pull/1703", "timeline": [{"oid": "9b1adc33372efd9c91ff8d3d72c7b4d2f6946fca", "url": "https://github.com/apache/hive/commit/9b1adc33372efd9c91ff8d3d72c7b4d2f6946fca", "message": "HIVE-24423: Improve DbNotificationListener Thread", "committedDate": "2020-11-24T16:38:16Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk0NzQ0OQ==", "url": "https://github.com/apache/hive/pull/1703#discussion_r530947449", "bodyText": "What if interruption occurs while the execution of CleanerThread is within this try block, wouldn't the InterruptedException be caught by this catch block, and the thread will go on?", "author": "miklosgergely", "createdAt": "2020-11-26T11:01:25Z", "path": "hcatalog/server-extensions/src/main/java/org/apache/hive/hcatalog/listener/DbNotificationListener.java", "diffHunk": "@@ -1242,64 +1244,50 @@ private void process(NotificationEvent event, ListenerEvent listenerEvent) throw\n   }\n \n   private static class CleanerThread extends Thread {\n-    private RawStore rs;\n+    private final RawStore rs;\n     private int ttl;\n-    private boolean shouldRun = true;\n     private long sleepTime;\n \n     CleanerThread(Configuration conf, RawStore rs) {\n       super(\"DB-Notification-Cleaner\");\n-      this.rs = rs;\n-      boolean isReplEnabled = MetastoreConf.getBoolVar(conf, ConfVars.REPLCMENABLED);\n-      if(isReplEnabled){\n-        setTimeToLive(MetastoreConf.getTimeVar(conf, ConfVars.REPL_EVENT_DB_LISTENER_TTL,\n-                TimeUnit.SECONDS));\n-      }\n-      else {\n-        setTimeToLive(MetastoreConf.getTimeVar(conf, ConfVars.EVENT_DB_LISTENER_TTL,\n-                TimeUnit.SECONDS));\n-      }\n-      setCleanupInterval(MetastoreConf.getTimeVar(conf, ConfVars.EVENT_DB_LISTENER_CLEAN_INTERVAL,\n-              TimeUnit.MILLISECONDS));\n       setDaemon(true);\n+      this.rs = Objects.requireNonNull(rs);\n+\n+      boolean isReplEnabled = MetastoreConf.getBoolVar(conf, ConfVars.REPLCMENABLED);\n+      ConfVars ttlConf = (isReplEnabled) ?  ConfVars.REPL_EVENT_DB_LISTENER_TTL : ConfVars.EVENT_DB_LISTENER_TTL;\n+      setTimeToLive(MetastoreConf.getTimeVar(conf, ttlConf, TimeUnit.SECONDS));\n+      setCleanupInterval(\n+          MetastoreConf.getTimeVar(conf, ConfVars.EVENT_DB_LISTENER_CLEAN_INTERVAL, TimeUnit.MILLISECONDS));\n     }\n \n     @Override\n     public void run() {\n-      while (shouldRun) {\n+      while (true) {\n+        LOG.debug(\"Cleaner thread running\");\n         try {\n           rs.cleanNotificationEvents(ttl);\n           rs.cleanWriteNotificationEvents(ttl);\n         } catch (Exception ex) {\n-          //catching exceptions here makes sure that the thread doesn't die in case of unexpected\n-          //exceptions\n-          LOG.warn(\"Exception received while cleaning notifications: \", ex);\n+          LOG.warn(\"Exception received while cleaning notifications\", ex);", "originalCommit": "9b1adc33372efd9c91ff8d3d72c7b4d2f6946fca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTcxNTc3Mw==", "url": "https://github.com/apache/hive/pull/1703#discussion_r531715773", "bodyText": "Hey, fair question, and I considered that, however, InterruptedException is a checked-exception and neither of these two methods declare it so it will never be thrown here (unless the signature changes later to throw one).  In fact, these methods do not throw any checked exceptions at all.\n void cleanWriteNotificationEvents(int olderThan);\n void cleanNotificationEvents(int olderThan);\n\nSo, if the thread is interrupted at any point, it will eventually make its ways to the Thread.sleep() call and throw the InterruptedException at that time (and exit).", "author": "belugabehr", "createdAt": "2020-11-27T17:48:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk0NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjA5Mzk4OQ==", "url": "https://github.com/apache/hive/pull/1703#discussion_r532093989", "bodyText": "@miklosgergely Any further questions or concerns?", "author": "belugabehr", "createdAt": "2020-11-28T18:54:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk0NzQ0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjQyNDQzMg==", "url": "https://github.com/apache/hive/pull/1703#discussion_r532424432", "bodyText": "No, go ahead and merge it", "author": "miklosgergely", "createdAt": "2020-11-30T08:39:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk0NzQ0OQ=="}], "type": "inlineReview"}]}