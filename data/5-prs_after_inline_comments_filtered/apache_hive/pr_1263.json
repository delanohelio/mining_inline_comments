{"pr_number": 1263, "pr_title": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "pr_createdAt": "2020-07-16T12:36:04Z", "pr_url": "https://github.com/apache/hive/pull/1263", "timeline": [{"oid": "c1206c572d9df98a32b40dc75268be9e4272b318", "url": "https://github.com/apache/hive/commit/c1206c572d9df98a32b40dc75268be9e4272b318", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "committedDate": "2020-07-17T09:18:15Z", "type": "forcePushed"}, {"oid": "1d5ddc49706c23ec5d89a6fc1c9fd0a7d2c225e8", "url": "https://github.com/apache/hive/commit/1d5ddc49706c23ec5d89a6fc1c9fd0a7d2c225e8", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "committedDate": "2020-07-17T09:20:33Z", "type": "forcePushed"}, {"oid": "d322d66fb09f1547614af771984df6233fec3819", "url": "https://github.com/apache/hive/commit/d322d66fb09f1547614af771984df6233fec3819", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "committedDate": "2020-07-20T12:50:40Z", "type": "forcePushed"}, {"oid": "9f554137b9220b3943b2e7be0b975e0bf1b54a02", "url": "https://github.com/apache/hive/commit/9f554137b9220b3943b2e7be0b975e0bf1b54a02", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "committedDate": "2020-07-20T13:05:29Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk1OTI1Mw==", "url": "https://github.com/apache/hive/pull/1263#discussion_r457959253", "bodyText": "nit: space", "author": "pvary", "createdAt": "2020-07-21T09:23:25Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java", "diffHunk": "@@ -12566,38 +12565,44 @@ void analyzeInternal(ASTNode ast, Supplier<PlannerContext> pcf) throws SemanticE\n       createVwDesc.setTablesUsed(getTablesUsed(pCtx));\n     }\n \n-    // 6. Generate table access stats if required\n-    if (HiveConf.getBoolVar(this.conf, HiveConf.ConfVars.HIVE_STATS_COLLECT_TABLEKEYS)) {\n-      TableAccessAnalyzer tableAccessAnalyzer = new TableAccessAnalyzer(pCtx);\n-      setTableAccessInfo(tableAccessAnalyzer.analyzeTableAccess());\n-    }\n+    //If we're creating views and ColumnAccessInfo is already created, we should not run these.\n+    if(!forViewCreation ||  getColumnAccessInfo() == null) {", "originalCommit": "9f554137b9220b3943b2e7be0b975e0bf1b54a02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY0MDA4NQ==", "url": "https://github.com/apache/hive/pull/1263#discussion_r458640085", "bodyText": "thanks @pvary", "author": "bmaidics", "createdAt": "2020-07-22T08:54:06Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk1OTI1Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzNTYwNg==", "url": "https://github.com/apache/hive/pull/1263#discussion_r458335606", "bodyText": "Can we add information to the comment above about why we are skipping those specific steps 6-8?", "author": "jcamachor", "createdAt": "2020-07-21T19:26:33Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/SemanticAnalyzer.java", "diffHunk": "@@ -12566,38 +12565,44 @@ void analyzeInternal(ASTNode ast, Supplier<PlannerContext> pcf) throws SemanticE\n       createVwDesc.setTablesUsed(getTablesUsed(pCtx));\n     }\n \n-    // 6. Generate table access stats if required\n-    if (HiveConf.getBoolVar(this.conf, HiveConf.ConfVars.HIVE_STATS_COLLECT_TABLEKEYS)) {\n-      TableAccessAnalyzer tableAccessAnalyzer = new TableAccessAnalyzer(pCtx);\n-      setTableAccessInfo(tableAccessAnalyzer.analyzeTableAccess());\n-    }\n+    //If we're creating views and ColumnAccessInfo is already created, we should not run these.\n+    if(!forViewCreation ||  getColumnAccessInfo() == null) {\n+      // 6. Generate table access stats if required\n+      if (HiveConf.getBoolVar(this.conf, HiveConf.ConfVars.HIVE_STATS_COLLECT_TABLEKEYS)) {\n+        TableAccessAnalyzer tableAccessAnalyzer = new TableAccessAnalyzer(pCtx);\n+        setTableAccessInfo(tableAccessAnalyzer.analyzeTableAccess());\n+      }\n+      AuxOpTreeSignature.linkAuxSignatures(pCtx);\n+      // 7. Perform Logical optimization\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"Before logical optimization\\n\" + Operator.toString(pCtx.getTopOps().values()));\n+      }\n+      Optimizer optm = new Optimizer();\n+      optm.setPctx(pCtx);\n+      optm.initialize(conf);\n+      pCtx = optm.optimize();\n+      if (pCtx.getColumnAccessInfo() != null) {\n+        // set ColumnAccessInfo for view column authorization\n+        setColumnAccessInfo(pCtx.getColumnAccessInfo());\n+      }\n+      if (LOG.isDebugEnabled()) {\n+        LOG.debug(\"After logical optimization\\n\" + Operator.toString(pCtx.getTopOps().values()));\n+      }\n \n-    AuxOpTreeSignature.linkAuxSignatures(pCtx);\n-    // 7. Perform Logical optimization\n-    if (LOG.isDebugEnabled()) {\n-      LOG.debug(\"Before logical optimization\\n\" + Operator.toString(pCtx.getTopOps().values()));\n-    }\n-    Optimizer optm = new Optimizer();\n-    optm.setPctx(pCtx);\n-    optm.initialize(conf);\n-    pCtx = optm.optimize();\n-    if (pCtx.getColumnAccessInfo() != null) {\n-      // set ColumnAccessInfo for view column authorization\n-      setColumnAccessInfo(pCtx.getColumnAccessInfo());\n+      // 8. Generate column access stats if required - wait until column pruning", "originalCommit": "9f554137b9220b3943b2e7be0b975e0bf1b54a02", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0ODQ1Nw==", "url": "https://github.com/apache/hive/pull/1263#discussion_r458748457", "bodyText": "Thanks, @jcamachor . Added a more specific comment.", "author": "bmaidics", "createdAt": "2020-07-22T12:17:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMzNTYwNg=="}], "type": "inlineReview"}, {"oid": "791b009c523ea55bde0bff52e674afaabcf89fe4", "url": "https://github.com/apache/hive/commit/791b009c523ea55bde0bff52e674afaabcf89fe4", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "committedDate": "2020-07-22T09:30:04Z", "type": "forcePushed"}, {"oid": "041e34fbb823344950de3aec8453b20b811311c5", "url": "https://github.com/apache/hive/commit/041e34fbb823344950de3aec8453b20b811311c5", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "committedDate": "2020-07-22T12:15:49Z", "type": "commit"}, {"oid": "041e34fbb823344950de3aec8453b20b811311c5", "url": "https://github.com/apache/hive/commit/041e34fbb823344950de3aec8453b20b811311c5", "message": "HIVE-23849: Hive skips the creation of ColumnAccessInfo when creating a view", "committedDate": "2020-07-22T12:15:49Z", "type": "forcePushed"}]}