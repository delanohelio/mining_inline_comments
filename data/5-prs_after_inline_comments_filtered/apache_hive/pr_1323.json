{"pr_number": 1323, "pr_title": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "pr_createdAt": "2020-07-27T14:34:10Z", "pr_url": "https://github.com/apache/hive/pull/1323", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3NTcwNA==", "url": "https://github.com/apache/hive/pull/1323#discussion_r461675704", "bodyText": "Should we also check whether the ReduceSink also has a topn value greater then 0?\nreduceSink.getConf().getTopN() > 0", "author": "kasakrisz", "createdAt": "2020-07-28T15:33:05Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/OrderlessLimitPushDownOptimizer.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ *\n+ *  * Licensed to the Apache Software Foundation (ASF) under one\n+ *  * or more contributor license agreements.  See the NOTICE file\n+ *  * distributed with this work for additional information\n+ *  * regarding copyright ownership.  The ASF licenses this file\n+ *  * to you under the Apache License, Version 2.0 (the\n+ *  * \"License\"); you may not use this file except in compliance\n+ *  * with the License.  You may obtain a copy of the License at\n+ *  *\n+ *  *     http://www.apache.org/licenses/LICENSE-2.0\n+ *  *\n+ *  * Unless required by applicable law or agreed to in writing, software\n+ *  * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  * See the License for the specific language governing permissions and\n+ *  * limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hadoop.hive.ql.optimizer;\n+\n+import static org.apache.hadoop.hive.ql.optimizer.topnkey.TopNKeyProcessor.copyDown;\n+import static org.apache.hadoop.hive.ql.optimizer.topnkey.TopNKeyPushdownProcessor.moveDown;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Stack;\n+\n+import org.apache.hadoop.hive.ql.exec.CommonJoinOperator;\n+import org.apache.hadoop.hive.ql.exec.LimitOperator;\n+import org.apache.hadoop.hive.ql.exec.Operator;\n+import org.apache.hadoop.hive.ql.exec.ReduceSinkOperator;\n+import org.apache.hadoop.hive.ql.lib.DefaultGraphWalker;\n+import org.apache.hadoop.hive.ql.lib.DefaultRuleDispatcher;\n+import org.apache.hadoop.hive.ql.lib.Node;\n+import org.apache.hadoop.hive.ql.lib.NodeProcessorCtx;\n+import org.apache.hadoop.hive.ql.lib.RuleRegExp;\n+import org.apache.hadoop.hive.ql.lib.SemanticGraphWalker;\n+import org.apache.hadoop.hive.ql.lib.SemanticNodeProcessor;\n+import org.apache.hadoop.hive.ql.lib.SemanticRule;\n+import org.apache.hadoop.hive.ql.parse.ParseContext;\n+import org.apache.hadoop.hive.ql.parse.SemanticException;\n+import org.apache.hadoop.hive.ql.plan.JoinCondDesc;\n+import org.apache.hadoop.hive.ql.plan.JoinDesc;\n+import org.apache.hadoop.hive.ql.plan.OperatorDesc;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+/**\n+ * Push LIMIT without an Order By through Selects and Left Outer Joins\n+ */\n+public class OrderlessLimitPushDownOptimizer extends Transform {\n+  private static final Logger LOG = LoggerFactory.getLogger(OrderlessLimitPushDownOptimizer.class);\n+\n+  @Override\n+  public ParseContext transform(ParseContext pctx) throws SemanticException {\n+    Map<SemanticRule, SemanticNodeProcessor> opRules = new LinkedHashMap<SemanticRule, SemanticNodeProcessor>();\n+    opRules.put(\n+            new RuleRegExp(\"LIMIT push down\", LimitOperator.getOperatorName() + \"%\"),\n+            new LimitPushDown());\n+    SemanticGraphWalker walker = new DefaultGraphWalker(new DefaultRuleDispatcher(null, opRules, null));\n+    walker.startWalking(new ArrayList<>(pctx.getTopOps().values()), null);\n+    return pctx;\n+  }\n+\n+  private static class LimitPushDown implements SemanticNodeProcessor {\n+    @Override\n+    public Object process(Node nd, Stack<Node> stack, NodeProcessorCtx procCtx, Object... nodeOutputs) throws SemanticException {\n+      ReduceSinkOperator reduceSink = findReduceSink(stack);\n+      if (reduceSink != null && !reduceSink.getConf().hasOrderBy()) { // LIMIT + ORDER BY handled by TopNKey push down", "originalCommit": "2759c81ae5e39137f669b1d21e9d68be674bfe5d", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjMwNjE1MA==", "url": "https://github.com/apache/hive/pull/1323#discussion_r462306150", "bodyText": "As we discussed offline a limit without order by, sort by and group by doesn't set ReduceSinkDesc.topn", "author": "kasakrisz", "createdAt": "2020-07-29T13:40:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3NTcwNA=="}], "type": "inlineReview"}, {"oid": "c223a3e76574f8ed62c5962c89bdfa4d826fbc99", "url": "https://github.com/apache/hive/commit/c223a3e76574f8ed62c5962c89bdfa4d826fbc99", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-07-29T14:04:51Z", "type": "forcePushed"}, {"oid": "933dcb6e0f2f7fb432d34246b8d2e44ec9992eff", "url": "https://github.com/apache/hive/commit/933dcb6e0f2f7fb432d34246b8d2e44ec9992eff", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-05T13:28:22Z", "type": "forcePushed"}, {"oid": "b9ab95d3cb5c925cdead74a9633eafeeb9dbc916", "url": "https://github.com/apache/hive/commit/b9ab95d3cb5c925cdead74a9633eafeeb9dbc916", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "23ad0504777b61cac8575f1b757fbd3a2733f8d7", "url": "https://github.com/apache/hive/commit/23ad0504777b61cac8575f1b757fbd3a2733f8d7", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "748db6e71e423fc516f9fd2808e24d1ec938a035", "url": "https://github.com/apache/hive/commit/748db6e71e423fc516f9fd2808e24d1ec938a035", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "cc0107b1157c4dfd5c91dd8a8d114f947a098db6", "url": "https://github.com/apache/hive/commit/cc0107b1157c4dfd5c91dd8a8d114f947a098db6", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "ab5988fea63c9e281abdf181fab4d0809f0c6f3e", "url": "https://github.com/apache/hive/commit/ab5988fea63c9e281abdf181fab4d0809f0c6f3e", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:11Z", "type": "commit"}, {"oid": "7fc560e13c6ac28ceac77e870d249e85602fdb31", "url": "https://github.com/apache/hive/commit/7fc560e13c6ac28ceac77e870d249e85602fdb31", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:12Z", "type": "commit"}, {"oid": "4ba2c5f4a113ad1291e232e84c220124f1560144", "url": "https://github.com/apache/hive/commit/4ba2c5f4a113ad1291e232e84c220124f1560144", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:12Z", "type": "commit"}, {"oid": "9a8a601e7086abd654cbfcf4ecbcd9d098e3e546", "url": "https://github.com/apache/hive/commit/9a8a601e7086abd654cbfcf4ecbcd9d098e3e546", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:12Z", "type": "commit"}, {"oid": "12e879caea755db324e816ccac8b47193c7f47a7", "url": "https://github.com/apache/hive/commit/12e879caea755db324e816ccac8b47193c7f47a7", "message": " HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:13Z", "type": "commit"}, {"oid": "b002080112f89130094f6b64cf5a51c30efddaee", "url": "https://github.com/apache/hive/commit/b002080112f89130094f6b64cf5a51c30efddaee", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:13Z", "type": "commit"}, {"oid": "e29d1fc54231428ed555bf3f85506112e6522ac8", "url": "https://github.com/apache/hive/commit/e29d1fc54231428ed555bf3f85506112e6522ac8", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T14:03:13Z", "type": "commit"}, {"oid": "e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "url": "https://github.com/apache/hive/commit/e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T16:03:49Z", "type": "commit"}, {"oid": "e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "url": "https://github.com/apache/hive/commit/e7f1e12fa6e46ce7f82d3426a25aa538a2af6cb4", "message": "HIVE-23723. Limit operator pushdown through LOJ (amagyar)", "committedDate": "2020-08-12T16:03:49Z", "type": "forcePushed"}]}