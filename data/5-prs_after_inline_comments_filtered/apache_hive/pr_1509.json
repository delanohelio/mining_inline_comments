{"pr_number": 1509, "pr_title": "HIVE-24179: Memory leak in HS2 DbTxnManager when compiling SHOW LOCKS statement", "pr_createdAt": "2020-09-18T23:12:32Z", "pr_url": "https://github.com/apache/hive/pull/1509", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA==", "url": "https://github.com/apache/hive/pull/1509#discussion_r491922128", "bodyText": "Do we create txnManager instance here just to get the value of useNewLocksFormat flag?", "author": "deniskuzZ", "createdAt": "2020-09-21T09:57:59Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/table/lock/show/ShowDbLocksAnalyzer.java", "diffHunk": "@@ -47,14 +47,16 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n     String dbName = stripQuotes(root.getChild(0).getText());\n     boolean isExtended = (root.getChildCount() > 1);\n \n-    HiveTxnManager txnManager = null;\n+    boolean useNewLocksFormat;\n     try {\n-      txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);\n+      HiveTxnManager txnManager = TxnManagerFactory.getTxnManagerFactory().getTxnManager(conf);", "originalCommit": "0e38686db29c51db368771b416810c7de06b2322", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyNTU0NQ==", "url": "https://github.com/apache/hive/pull/1509#discussion_r492225545", "bodyText": "That's correct. Normally, we should (but I am not 100% sure) have a TxnManager at this point so there is no need to create a new one just to obtain the flag. I pushed commit 297882e to try this out.", "author": "zabetak", "createdAt": "2020-09-21T17:23:42Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI2MjkxMQ==", "url": "https://github.com/apache/hive/pull/1509#discussion_r492262911", "bodyText": "TxnManager is initialized before query compilation and has a session scope. Correct way to access it is via SessionState. Looks like ShowDbLocksAnalyzer was always creating new instance of TxnManager.", "author": "deniskuzZ", "createdAt": "2020-09-21T18:28:30Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjM2NDc5MA==", "url": "https://github.com/apache/hive/pull/1509#discussion_r492364790", "bodyText": "Did you check the last commit? Do you have something else in mind?", "author": "zabetak", "createdAt": "2020-09-21T21:47:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUxMDEzOQ==", "url": "https://github.com/apache/hive/pull/1509#discussion_r492510139", "bodyText": "LGTM", "author": "deniskuzZ", "createdAt": "2020-09-22T06:55:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyMjEyOA=="}], "type": "inlineReview"}, {"oid": "301085b0ede69f8c9b64f70b4150d39df1796926", "url": "https://github.com/apache/hive/commit/301085b0ede69f8c9b64f70b4150d39df1796926", "message": "HIVE-24179: Memory leak in HS2 DbTxnManager when compiling SHOW LOCKS statement\n\n1. Avoid multiple shutdown hooks for the same threadpool in DbTxnManager.\n\nEnforce unique initialization and shutdown of the thread pool. Apart\nfrom the apparent memory leak there is no need to register a shutdown\nhook for the executor service multiple times. It wastes memory,\ncomplicates code, and serves no purpose.\n\nChange initHeartbeatExecutorService to synchronized putting the class\nlock in the whole method. Mixing instance and class locks is confusing\nand does not offer any particular benefit.\n\n2. Avoid HiveTxnManager instantiation in lock analyzers.\n\nA transaction manager should already exist inside the\nanalyzer before calling the analyze method. There is no need to create a\nnew one just to obtain the useNewShowLocksFormat boolean indicator.", "committedDate": "2020-11-13T17:08:48Z", "type": "commit"}, {"oid": "301085b0ede69f8c9b64f70b4150d39df1796926", "url": "https://github.com/apache/hive/commit/301085b0ede69f8c9b64f70b4150d39df1796926", "message": "HIVE-24179: Memory leak in HS2 DbTxnManager when compiling SHOW LOCKS statement\n\n1. Avoid multiple shutdown hooks for the same threadpool in DbTxnManager.\n\nEnforce unique initialization and shutdown of the thread pool. Apart\nfrom the apparent memory leak there is no need to register a shutdown\nhook for the executor service multiple times. It wastes memory,\ncomplicates code, and serves no purpose.\n\nChange initHeartbeatExecutorService to synchronized putting the class\nlock in the whole method. Mixing instance and class locks is confusing\nand does not offer any particular benefit.\n\n2. Avoid HiveTxnManager instantiation in lock analyzers.\n\nA transaction manager should already exist inside the\nanalyzer before calling the analyze method. There is no need to create a\nnew one just to obtain the useNewShowLocksFormat boolean indicator.", "committedDate": "2020-11-13T17:08:48Z", "type": "forcePushed"}]}