{"pr_number": 1633, "pr_title": "HIVE-24230 Integrate HPL/SQL into HiveServer2 (amagyar)", "pr_createdAt": "2020-10-30T15:47:50Z", "pr_url": "https://github.com/apache/hive/pull/1633", "timeline": [{"oid": "57184bda0bd107beb44443c3d65e244db791c3ea", "url": "https://github.com/apache/hive/commit/57184bda0bd107beb44443c3d65e244db791c3ea", "message": "HIVE-24230 Integrate HPL/SQL into HiveServer2 (amagyar)", "committedDate": "2020-10-30T15:46:21Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNDk4Mg==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515314982", "bodyText": "Minor: we can extract this if statement to a private method.", "author": "mustafaiman", "createdAt": "2020-10-30T18:59:06Z", "path": "service/src/java/org/apache/hive/service/cli/operation/ExecuteStatementOperation.java", "diffHunk": "@@ -45,6 +62,21 @@ public static ExecuteStatementOperation newExecuteStatementOperation(HiveSession\n       throws HiveSQLException {\n \n     String cleanStatement = HiveStringUtils.removeComments(statement);\n+    if (!HPLSQL.equals(confOverlay.get(QUERY_EXECUTOR)) && hplSqlMode()) {\n+      if (SessionState.get().getHplsqlInterpreter() == null) {", "originalCommit": "57184bda0bd107beb44443c3d65e244db791c3ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgyOTk2OA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515829968", "bodyText": "Done.", "author": "zeroflag", "createdAt": "2020-11-02T09:11:59Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxNDk4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxODA1OA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515318058", "bodyText": "runInBackground is not used", "author": "mustafaiman", "createdAt": "2020-10-30T19:05:39Z", "path": "service/src/java/org/apache/hive/service/cli/operation/ExecuteStatementOperation.java", "diffHunk": "@@ -36,6 +48,11 @@ public ExecuteStatementOperation(HiveSession parentSession, String statement,\n     this.statement = statement;\n   }\n \n+  public ExecuteStatementOperation(HiveSession parentSession, String statement, Map<String, String> confOverlay, boolean runInBackground, boolean generateNewQueryId) {", "originalCommit": "57184bda0bd107beb44443c3d65e244db791c3ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMDA0Mg==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515830042", "bodyText": "Removed.", "author": "zeroflag", "createdAt": "2020-11-02T09:12:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMxODA1OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMyMDI3Ng==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515320276", "bodyText": "HiveHplSqlSessionState does not hold any info which is not accessible in SessionState already. Why is that class needed?", "author": "mustafaiman", "createdAt": "2020-10-30T19:10:43Z", "path": "service/src/java/org/apache/hive/service/cli/operation/ExecuteStatementOperation.java", "diffHunk": "@@ -45,6 +62,21 @@ public static ExecuteStatementOperation newExecuteStatementOperation(HiveSession\n       throws HiveSQLException {\n \n     String cleanStatement = HiveStringUtils.removeComments(statement);\n+    if (!HPLSQL.equals(confOverlay.get(QUERY_EXECUTOR)) && hplSqlMode()) {\n+      if (SessionState.get().getHplsqlInterpreter() == null) {\n+        Exec interpreter = new Exec(\n+                new Conf(),\n+                new BeelineConsole(),\n+                ResultListener.NONE,\n+                new HplSqlQueryExecutor(parentSession),\n+                parentSession.getMetaStoreClient(),\n+                new HiveHplSqlSessionState(SessionState.get())", "originalCommit": "57184bda0bd107beb44443c3d65e244db791c3ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMDEwMw==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515830103", "bodyText": "The session state is not available when the operation is running in the background.", "author": "zeroflag", "createdAt": "2020-11-02T09:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMyMDI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjM2ODAwMQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r516368001", "bodyText": "So this gets a reference to active SessionState. Then it is offloaded to another background thread to run. What if the next operation changes sessionState.currentDatabase? Then hpl operation might run on wrong database, no?", "author": "mustafaiman", "createdAt": "2020-11-03T00:45:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMyMDI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY1OTU2Mg==", "url": "https://github.com/apache/hive/pull/1633#discussion_r516659562", "bodyText": "Yes, that might be a problem, let me check that.", "author": "zeroflag", "createdAt": "2020-11-03T13:19:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMyMDI3Ng=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTk3MzA4Nw==", "url": "https://github.com/apache/hive/pull/1633#discussion_r519973087", "bodyText": "@mustafaiman,\nI added a unittest to verify it and looks like it still works this way. HiveHplSqlSessionState holds a reference to SessionState which changes when the the current db is modified. The reason why the HiveHplSqlSessionState is still needed is because the SessionState is in the ql project which cannot be referenced from hplsql without introducing circular dependency.", "author": "zeroflag", "createdAt": "2020-11-09T17:03:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMyMDI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1NDEwNg==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515354106", "bodyText": "I think this would not log e without a matching {}", "author": "mustafaiman", "createdAt": "2020-10-30T20:14:51Z", "path": "service/src/java/org/apache/hive/service/cli/operation/hplsql/HplSqlOperation.java", "diffHunk": "@@ -0,0 +1,240 @@\n+/*\n+ *\n+ *  Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hive.service.cli.operation.hplsql;\n+\n+import java.security.PrivilegedExceptionAction;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.concurrent.Future;\n+import java.util.concurrent.RejectedExecutionException;\n+\n+import org.apache.hadoop.hive.common.LogUtils;\n+import org.apache.hadoop.hive.ql.log.PerfLogger;\n+import org.apache.hadoop.hive.ql.metadata.Hive;\n+import org.apache.hadoop.hive.ql.session.SessionState;\n+import org.apache.hadoop.hive.serde2.thrift.Type;\n+import org.apache.hadoop.hive.shims.ShimLoader;\n+import org.apache.hadoop.hive.shims.Utils;\n+import org.apache.hadoop.security.UserGroupInformation;\n+import org.apache.hive.hplsql.Exec;\n+import org.apache.hive.hplsql.ResultListener;\n+import org.apache.hive.hplsql.executor.Metadata;\n+import org.apache.hive.service.cli.FetchOrientation;\n+import org.apache.hive.service.cli.HiveSQLException;\n+import org.apache.hive.service.cli.OperationState;\n+import org.apache.hive.service.cli.OperationType;\n+import org.apache.hive.service.cli.RowSet;\n+import org.apache.hive.service.cli.RowSetFactory;\n+import org.apache.hive.service.cli.TableSchema;\n+import org.apache.hive.service.cli.operation.ExecuteStatementOperation;\n+import org.apache.hive.service.cli.session.HiveSession;\n+import org.apache.hive.service.server.ThreadWithGarbageCleanup;\n+\n+public class HplSqlOperation extends ExecuteStatementOperation implements ResultListener {\n+  private final Exec exec;\n+  private final boolean runInBackground;\n+  private RowSet rowSet;\n+  private TableSchema schema;\n+\n+  public HplSqlOperation(HiveSession parentSession, String statement, Map<String, String> confOverlay, boolean runInBackground, Exec exec) {\n+    super(parentSession, statement, confOverlay, runInBackground, false);\n+    this.exec = exec;\n+    this.runInBackground = runInBackground;\n+    exec.setResultListener(this);\n+  }\n+\n+  @Override\n+  protected void runInternal() throws HiveSQLException {\n+    setState(OperationState.PENDING);\n+    if (!runInBackground) {\n+      interpret();\n+    } else {\n+      Runnable work = new BackgroundWork(getCurrentUGI(), parentSession.getSessionHive(), SessionState.get());\n+      try {\n+        // This submit blocks if no background threads are available to run this operation\n+        Future<?> backgroundHandle = getParentSession().submitBackgroundOperation(work);\n+        setBackgroundHandle(backgroundHandle);\n+      } catch (RejectedExecutionException rejected) {\n+        setState(OperationState.ERROR);\n+        throw new HiveSQLException(\"The background threadpool cannot accept\" +\n+                \" new task for execution, please retry the operation\", rejected);\n+      }\n+    }\n+  }\n+\n+  private void interpret() throws HiveSQLException {\n+    try {\n+      OperationState opState = getStatus().getState();\n+      // Operation may have been cancelled by another thread\n+      if (opState.isTerminal()) {\n+        log.info(\"Not running the query. Operation is already in terminal state: \" + opState\n+                + \", perhaps cancelled due to query timeout or by another thread.\");\n+        return;\n+      }\n+      setState(OperationState.RUNNING);\n+      int code = exec.run(new String[]{\"-e\", statement});\n+      if (code != 0) {\n+        throw new HiveSQLException(\"HPL/SQL returned \" + code);\n+      }\n+      setState(OperationState.FINISHED);\n+    } catch (Throwable e) {\n+      if (getStatus().getState().isTerminal()) {\n+        log.warn(\"Ignore exception in terminal state: {}\", getStatus().getState(), e);", "originalCommit": "57184bda0bd107beb44443c3d65e244db791c3ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMDM0OA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515830348", "bodyText": "I tried it, and it still works this way. The same way is used at other places in the code.", "author": "zeroflag", "createdAt": "2020-11-02T09:12:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1NDEwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1NzgyNA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515357824", "bodyText": "Shouldn't this be configurable?", "author": "mustafaiman", "createdAt": "2020-10-30T20:24:00Z", "path": "service/src/java/org/apache/hive/service/cli/operation/hplsql/HplSqlQueryExecutor.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ *\n+ *  Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hive.service.cli.operation.hplsql;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.antlr.v4.runtime.ParserRuleContext;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hive.hplsql.executor.ColumnMeta;\n+import org.apache.hive.hplsql.executor.Metadata;\n+import org.apache.hive.hplsql.executor.QueryException;\n+import org.apache.hive.hplsql.executor.QueryExecutor;\n+import org.apache.hive.hplsql.executor.QueryResult;\n+import org.apache.hive.hplsql.executor.RowResult;\n+import org.apache.hive.service.cli.ColumnDescriptor;\n+import org.apache.hive.service.cli.FetchOrientation;\n+import org.apache.hive.service.cli.FetchType;\n+import org.apache.hive.service.cli.HiveSQLException;\n+import org.apache.hive.service.cli.OperationHandle;\n+import org.apache.hive.service.cli.RowSet;\n+import org.apache.hive.service.cli.TableSchema;\n+import org.apache.hive.service.cli.session.HiveSession;\n+\n+/**\n+ * Executing HiveQL from HPL/SQL directly, without JDBC or Thrift.\n+ */\n+public class HplSqlQueryExecutor implements QueryExecutor {\n+  public static final String QUERY_EXECUTOR = \"QUERY_EXECUTOR\";\n+  public static final String HPLSQL = \"HPLSQL\";\n+  private final HiveSession hiveSession;\n+  private long defaultMaxRows = HiveConf.ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE.defaultIntVal;", "originalCommit": "57184bda0bd107beb44443c3d65e244db791c3ea", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTgzMDM3OQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r515830379", "bodyText": "I made it configurable.", "author": "zeroflag", "createdAt": "2020-11-02T09:12:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM1NzgyNA=="}], "type": "inlineReview"}, {"oid": "f7e24e0c53ae50c3ac5bf38b17eb9581cc60f9ba", "url": "https://github.com/apache/hive/commit/f7e24e0c53ae50c3ac5bf38b17eb9581cc60f9ba", "message": "HIVE-24230 Integrate HPL/SQL into HiveServer2 (amagyar)", "committedDate": "2020-11-02T10:32:35Z", "type": "commit"}, {"oid": "e7eeafeb56170581e58c9e6d10478c6d1cdcd584", "url": "https://github.com/apache/hive/commit/e7eeafeb56170581e58c9e6d10478c6d1cdcd584", "message": "HIVE-24230 Integrate HPL/SQL into HiveServer2 (amagyar)", "committedDate": "2020-11-09T17:02:59Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxMTAyMQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r521911021", "bodyText": "I don't fully understand why we have this field \"here\" - we don't even use hplsql from ql.\nThis field is only used from the \"service\" module", "author": "kgyrtkirk", "createdAt": "2020-11-12T08:14:17Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/session/SessionState.java", "diffHunk": "@@ -270,6 +271,8 @@\n \n   private SparkSession sparkSession;\n \n+  private Exec hplsqlInterpreter;", "originalCommit": "e7eeafeb56170581e58c9e6d10478c6d1cdcd584", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA4NDc3MA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r522084770", "bodyText": "I made this dynamic.", "author": "zeroflag", "createdAt": "2020-11-12T12:55:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxMTAyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxNDMxMA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r521914310", "bodyText": "I think if I set fetchsize to 1 - and then I try to fetch a resultset of 10 rows with hplsql; I'll get 1 row back", "author": "kgyrtkirk", "createdAt": "2020-11-12T08:19:24Z", "path": "service/src/java/org/apache/hive/service/cli/operation/hplsql/HplSqlQueryExecutor.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ *\n+ *  Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hive.service.cli.operation.hplsql;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+import org.antlr.v4.runtime.ParserRuleContext;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hive.hplsql.executor.ColumnMeta;\n+import org.apache.hive.hplsql.executor.Metadata;\n+import org.apache.hive.hplsql.executor.QueryException;\n+import org.apache.hive.hplsql.executor.QueryExecutor;\n+import org.apache.hive.hplsql.executor.QueryResult;\n+import org.apache.hive.hplsql.executor.RowResult;\n+import org.apache.hive.service.cli.ColumnDescriptor;\n+import org.apache.hive.service.cli.FetchOrientation;\n+import org.apache.hive.service.cli.FetchType;\n+import org.apache.hive.service.cli.HiveSQLException;\n+import org.apache.hive.service.cli.OperationHandle;\n+import org.apache.hive.service.cli.RowSet;\n+import org.apache.hive.service.cli.TableSchema;\n+import org.apache.hive.service.cli.session.HiveSession;\n+\n+/**\n+ * Executing HiveQL from HPL/SQL directly, without JDBC or Thrift.\n+ */\n+public class HplSqlQueryExecutor implements QueryExecutor {\n+  public static final String QUERY_EXECUTOR = \"QUERY_EXECUTOR\";\n+  public static final String HPLSQL = \"HPLSQL\";\n+  private final HiveSession hiveSession;\n+  private long fetchSize;\n+\n+  public HplSqlQueryExecutor(HiveSession hiveSession) {\n+    this.fetchSize = hiveSession.getHiveConf().getIntVar(HiveConf.ConfVars.HIVE_SERVER2_THRIFT_RESULTSET_DEFAULT_FETCH_SIZE);\n+    this.hiveSession = hiveSession;\n+  }\n+\n+  @Override\n+  public QueryResult executeQuery(String sql, ParserRuleContext ctx) {\n+    try {\n+      Map<String, String> confOverlay = new HashMap<>();\n+      confOverlay.put(QUERY_EXECUTOR, HPLSQL);\n+      OperationHandle operationHandle = hiveSession.executeStatement(sql, confOverlay);\n+      return new QueryResult(new OperationRowResult(operationHandle), () -> metadata(operationHandle), null);\n+    } catch (HiveSQLException e) {\n+      return new QueryResult(null, () -> new Metadata(Collections.emptyList()), e);\n+    }\n+  }\n+\n+  public Metadata metadata(OperationHandle operationHandle) {\n+    try {\n+      TableSchema meta = hiveSession.getResultSetMetadata(operationHandle);\n+      List<ColumnMeta> colMeta = new ArrayList<>();\n+      for (int i = 0; i < meta.getSize(); i++) {\n+        ColumnDescriptor col = meta.getColumnDescriptorAt(i);\n+        colMeta.add(new ColumnMeta(col.getName(), col.getTypeName(), col.getType().toJavaSQLType()));\n+      }\n+      return new Metadata(colMeta);\n+    } catch (HiveSQLException e) {\n+      throw new QueryException(e);\n+    }\n+  }\n+\n+  private class OperationRowResult implements RowResult {\n+    private final OperationHandle handle;\n+    private RowSet rows;\n+    private Iterator<Object[]> iterator;\n+    private Object[] current;\n+\n+    private OperationRowResult(OperationHandle operationHandle) {\n+      this.handle = operationHandle;\n+    }\n+\n+    @Override\n+    public boolean next() {\n+      if (rows == null) {\n+        this.rows = fetch();\n+        this.iterator = rows.iterator();\n+      }\n+      if (iterator.hasNext()) {\n+        current = iterator.next();\n+        return true;\n+      } else {\n+        current = null;\n+        return false;\n+      }\n+    }\n+\n+    private RowSet fetch() {\n+      try {\n+        return hiveSession.fetchResults(\n+                handle, FetchOrientation.FETCH_NEXT, fetchSize, FetchType.QUERY_OUTPUT);", "originalCommit": "e7eeafeb56170581e58c9e6d10478c6d1cdcd584", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE4MDcyNw==", "url": "https://github.com/apache/hive/pull/1633#discussion_r522180727", "bodyText": "Right. I think I fixed it by adding an extra condition.", "author": "zeroflag", "createdAt": "2020-11-12T15:12:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxNDMxMA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxNzAzNg==", "url": "https://github.com/apache/hive/pull/1633#discussion_r521917036", "bodyText": "this doesnt look right...\nwhy are we moviong a UDF into the service package? can't we avoid that?", "author": "kgyrtkirk", "createdAt": "2020-11-12T08:21:55Z", "path": "service/src/java/org/apache/hive/service/cli/operation/hplsql/Udf.java", "diffHunk": "@@ -1,123 +1,125 @@\n /*\n- * Licensed to the Apache Software Foundation (ASF) under one\n- * or more contributor license agreements.  See the NOTICE file\n- * distributed with this work for additional information\n- * regarding copyright ownership.  The ASF licenses this file\n- * to you under the Apache License, Version 2.0 (the\n- * \"License\"); you may not use this file except in compliance\n- * with the License.  You may obtain a copy of the License at\n  *\n- *     http://www.apache.org/licenses/LICENSE-2.0\n+ *  Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n  *\n- * Unless required by applicable law or agreed to in writing, software\n- * distributed under the License is distributed on an \"AS IS\" BASIS,\n- * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n- * See the License for the specific language governing permissions and\n- * limitations under the License.\n  */\n \n-package org.apache.hive.hplsql;\n+package org.apache.hive.service.cli.operation.hplsql;", "originalCommit": "e7eeafeb56170581e58c9e6d10478c6d1cdcd584", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA4NDkzMA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r522084930", "bodyText": "I put it back to hplsql project.", "author": "zeroflag", "createdAt": "2020-11-12T12:55:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTkxNzAzNg=="}], "type": "inlineReview"}, {"oid": "3764bff31a467a53dcf4fc7e49dd37cdcb428b2d", "url": "https://github.com/apache/hive/commit/3764bff31a467a53dcf4fc7e49dd37cdcb428b2d", "message": " HIVE-24230 Integrate HPL/SQL into HiveServer2 (amagyar)", "committedDate": "2020-11-12T12:53:20Z", "type": "commit"}, {"oid": "91be26a5852446768e2264613c987a73a87d8710", "url": "https://github.com/apache/hive/commit/91be26a5852446768e2264613c987a73a87d8710", "message": "HIVE-24230 Integrate HPL/SQL into HiveServer2 (amagyar)", "committedDate": "2020-11-12T15:09:48Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1NzI3Mw==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527557273", "bodyText": "I think it would be better if this would be mode=hplsql; that way we may add more \"mode\"-s later\nwhat do you think?", "author": "kgyrtkirk", "createdAt": "2020-11-20T09:22:17Z", "path": "beeline/src/java/org/apache/hive/beeline/BeeLine.java", "diffHunk": "@@ -892,8 +893,12 @@ private boolean connectUsingArgs(BeelineParser beelineParser, CommandLine cl) {\n     getOpts().setInitFiles(cl.getOptionValues(\"i\"));\n     getOpts().setScriptFile(cl.getOptionValue(\"f\"));\n \n-\n     if (url != null) {\n+      String hplSqlMode = Utils.parsePropertyFromUrl(url, Constants.HPLSQL_MODE);", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU2ODI2OQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528568269", "bodyText": "Ok, modified it.", "author": "zeroflag", "createdAt": "2020-11-23T09:32:26Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU1NzI3Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2Mzc3NQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527563775", "bodyText": "(QR-indexes#1) there seems to be existing loops starting for idx \"1\"", "author": "kgyrtkirk", "createdAt": "2020-11-20T09:32:54Z", "path": "hplsql/src/main/java/org/apache/hive/hplsql/Cmp.java", "diffHunk": "@@ -138,28 +147,26 @@ else if (query2.error()) {\n       exec.signal(query2);\n       return null;\n     }\n-    ResultSet rs1 = query1.getResultSet();\n-    ResultSet rs2 = query2.getResultSet();\n-    if (rs1 == null || rs2 == null) {\n+    if (query1 == null || query2 == null) {\n       exec.setSqlCode(-1);\n       return null;\n     }\n     boolean equal = true;\n     tests = 0;\n     failedTests = 0;\n     try {\n-      ResultSetMetaData rm1 = rs1.getMetaData();\n-      ResultSetMetaData rm2 = rs2.getMetaData();\n-      int cnt1 = rm1.getColumnCount();\n-      int cnt2 = rm2.getColumnCount();\n+      Metadata rm1 = query1.metadata();\n+      Metadata rm2 = query2.metadata();\n+      int cnt1 = rm1.columnCount();\n+      int cnt2 = rm2.columnCount();\n       tests = cnt1;\n-      while (rs1.next() && rs2.next()) {\n+      while (query1.next() && query2.next()) {\n         for (int i = 1; i <= tests; i++) {", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2MjgwNQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528662805", "bodyText": "Yes, I missed this. It should have been 0 based. Fixed it. I also removed the 2 threads since Tez doesn't support concurrent queries within the same session.", "author": "zeroflag", "createdAt": "2020-11-23T12:18:28Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2Mzc3NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2NDA4MQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527564081", "bodyText": "(QR-indexes#2) and there are places where it changes to 0 indexed", "author": "kgyrtkirk", "createdAt": "2020-11-20T09:33:27Z", "path": "hplsql/src/main/java/org/apache/hive/hplsql/Copy.java", "diffHunk": "@@ -233,16 +219,16 @@ void copyToFile(HplsqlParser.Copy_stmtContext ctx, Query query) throws Exception\n         sql = \"INSERT INTO \" + sqlInsertName + \" VALUES (\";\n         rowdel = \");\\n\".getBytes();\n       }\n-      while (rs.next()) {\n+      while (query.next()) {\n         if (sqlInsert) {\n           out.write(sql.getBytes());\n         }\n-        for (int i = 1; i <= cols; i++) {\n-          if (i > 1) {\n+        for (int i = 0; i < cols; i++) {", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2MzIxNg==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528663216", "bodyText": "I supposed to be 0 based everywhere.", "author": "zeroflag", "createdAt": "2020-11-23T12:19:09Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2NDA4MQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2NTI3Ng==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527565276", "bodyText": "(QR-indexes#2) and there are places where it changes to 0 indexed\njdbc drivers usually start numbering from 1; but internal stuff tends to use 0.\nit would be helpfull to write this contract down in the QueryResult's apidoc\nwill the \"old\" approach still work after these changes?", "author": "kgyrtkirk", "createdAt": "2020-11-20T09:35:30Z", "path": "hplsql/src/main/java/org/apache/hive/hplsql/Var.java", "diffHunk": "@@ -258,44 +256,35 @@ public void setValue(Object value) {\n       this.value = value;\n \t  }\n   }\n-\t\n-\t/**\n-   * Set the new value from the result set\n-   */\n-  public Var setValue(ResultSet rs, ResultSetMetaData rsm, int idx) throws SQLException {\n-    int type = rsm.getColumnType(idx);\n+\n+  public Var setValue(QueryResult queryResult, int idx) {\n+    int type = queryResult.jdbcType(idx);\n     if (type == java.sql.Types.CHAR || type == java.sql.Types.VARCHAR) {\n-      cast(new Var(rs.getString(idx)));\n-    }\n-    else if (type == java.sql.Types.INTEGER || type == java.sql.Types.BIGINT ||\n-        type == java.sql.Types.SMALLINT || type == java.sql.Types.TINYINT) {\n-      cast(new Var(Long.valueOf(rs.getLong(idx))));\n-    }\n-    else if (type == java.sql.Types.DECIMAL || type == java.sql.Types.NUMERIC) {\n-      cast(new Var(rs.getBigDecimal(idx)));\n-    }\n-    else if (type == java.sql.Types.FLOAT || type == java.sql.Types.DOUBLE) {\n-      cast(new Var(Double.valueOf(rs.getDouble(idx))));\n+      cast(new Var(queryResult.column(idx, String.class)));\n+    } else if (type == java.sql.Types.INTEGER || type == java.sql.Types.BIGINT ||\n+            type == java.sql.Types.SMALLINT || type == java.sql.Types.TINYINT) {\n+      cast(new Var(Long.valueOf(queryResult.column(idx, Long.class))));\n+    } else if (type == java.sql.Types.DECIMAL || type == java.sql.Types.NUMERIC) {\n+      cast(new Var(queryResult.column(idx, BigDecimal.class)));\n+    } else if (type == java.sql.Types.FLOAT || type == java.sql.Types.DOUBLE) {\n+      cast(new Var(Double.valueOf(queryResult.column(idx, Double.class))));\n     }\n     return this;\n   }\n-  \n-  /**\n-   * Set ROW values from the result set\n-   */\n-  public Var setValues(ResultSet rs, ResultSetMetaData rsm) throws SQLException {\n+\n+  public Var setValues(QueryResult queryResult) {\n     Row row = (Row)this.value;\n-    int idx = 1;\n+    int idx = 0;", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU2ODUzMA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528568530", "bodyText": "I added a javadoc explaining the difference.", "author": "zeroflag", "createdAt": "2020-11-23T09:32:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2NTI3Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2Njk0MA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527566940", "bodyText": "(QR-indexes#4) given the things I've seen so far:\nI think right now queryresult is 0 indexed; and this seems to be the jdbc adaptor so I would have expected a +/- 1 here", "author": "kgyrtkirk", "createdAt": "2020-11-20T09:38:20Z", "path": "hplsql/src/main/java/org/apache/hive/hplsql/executor/JdbcQueryExecutor.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/*\n+ *\n+ *  Licensed to the Apache Software Foundation (ASF) under one\n+ *  or more contributor license agreements.  See the NOTICE file\n+ *  distributed with this work for additional information\n+ *  regarding copyright ownership.  The ASF licenses this file\n+ *  to you under the Apache License, Version 2.0 (the\n+ *  \"License\"); you may not use this file except in compliance\n+ *  with the License.  You may obtain a copy of the License at\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ *  Unless required by applicable law or agreed to in writing, software\n+ *  distributed under the License is distributed on an \"AS IS\" BASIS,\n+ *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ *  See the License for the specific language governing permissions and\n+ *  limitations under the License.\n+ *\n+ */\n+\n+package org.apache.hive.hplsql.executor;\n+\n+import java.sql.ResultSet;\n+import java.sql.ResultSetMetaData;\n+import java.sql.SQLException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.antlr.v4.runtime.ParserRuleContext;\n+import org.apache.hive.hplsql.Exec;\n+import org.apache.hive.hplsql.Query;\n+\n+public class JdbcQueryExecutor implements QueryExecutor {\n+  private final Exec exec;\n+\n+  public JdbcQueryExecutor(Exec exec) {\n+    this.exec = exec;\n+  }\n+\n+  @Override\n+  public QueryResult executeQuery(String sql, ParserRuleContext ctx) {\n+    String conn = exec.getStatementConnection();\n+    Query query = exec.executeQuery(ctx, new Query(sql), conn);\n+    ResultSet resultSet = query.getResultSet();\n+    if (resultSet == null) { // offline mode\n+      return new QueryResult(null, () -> new Metadata(Collections.emptyList()), query.getException());\n+    } else {\n+      return new QueryResult(new JdbcRowResult(resultSet), () -> metadata(resultSet), query.getException());\n+    }\n+  }\n+\n+  private static Metadata metadata(ResultSet resultSet) {\n+    try {\n+      ResultSetMetaData meta = resultSet.getMetaData();\n+      List<ColumnMeta> colMetas = new ArrayList<>();\n+      for (int i = 1; i <= meta.getColumnCount(); i++) {\n+        colMetas.add(new ColumnMeta(\n+                meta.getColumnName(i), meta.getColumnTypeName(i), meta.getColumnType(i)));\n+      }\n+      return new Metadata(colMetas);\n+    } catch (SQLException e) {\n+      throw new QueryException(e);\n+    }\n+  }\n+\n+  private static class JdbcRowResult implements RowResult {\n+    private final ResultSet resultSet;\n+\n+    private JdbcRowResult(ResultSet resultSet) {\n+      this.resultSet = resultSet;\n+    }\n+\n+    @Override\n+    public boolean next() {\n+      try {\n+        return resultSet.next();\n+      } catch (SQLException e) {\n+        throw new QueryException(e);\n+      }\n+    }\n+\n+    @Override\n+    public <T> T get(int columnIndex, Class<T> type) {\n+      try {\n+        return resultSet.getObject(columnIndex, type);", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2Mzg1NQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528663855", "bodyText": "Right, this is off by one. the Jdbc adaptor was added for compatibility, I'm not sure for how long we'll want to support it but I fixed indexing.", "author": "zeroflag", "createdAt": "2020-11-23T12:20:15Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2Njk0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2OTg5NA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527569894", "bodyText": "could you configure import order in your ide to not reorder imports \"this much\"?", "author": "kgyrtkirk", "createdAt": "2020-11-20T09:43:28Z", "path": "jdbc/src/java/org/apache/hive/jdbc/HiveConnection.java", "diffHunk": "@@ -18,18 +18,67 @@\n \n package org.apache.hive.jdbc;\n \n-import com.google.common.annotations.VisibleForTesting;\n+import static org.apache.hadoop.hive.conf.Constants.HPLSQL_MODE;\n+import java.io.BufferedReader;\n+import java.io.DataInputStream;\n+import java.io.File;", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2NDI0NA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528664244", "bodyText": "I'll try to do something about it.", "author": "zeroflag", "createdAt": "2020-11-23T12:20:54Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU2OTg5NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3NDM5NQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527574395", "bodyText": "what does embedded mean here?\n\nembedded hiveserver2\nsome hplsql related stuff?", "author": "kgyrtkirk", "createdAt": "2020-11-20T09:50:27Z", "path": "service/src/java/org/apache/hive/service/cli/operation/Operation.java", "diffHunk": "@@ -102,7 +109,7 @@ protected Operation(HiveSession parentSession,\n         MetricsConstant.COMPLETED_OPERATION_PREFIX, state);\n     queryState = new QueryState.Builder()\n                      .withConfOverlay(confOverlay)\n-                     .withGenerateNewQueryId(true)\n+                     .withGenerateNewQueryId(!embedded)", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODU2NzA1OQ==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528567059", "bodyText": "An hplsql script contains both declarative (for example select) and imperative statements (for example a for loop). The script is executed by an HplSqlOperation but this will start SQLOperations when it sees hive ql stuffs. So this flag indicates that one operation was started by an other operation.", "author": "zeroflag", "createdAt": "2020-11-23T09:30:27Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU3NDM5NQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4Mjc2OA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r527582768", "bodyText": "I don't see this or SqlOperation called with a true embedded parameter\nthis one way to create a multi statement query thing - I wonder if we could have that as a first class citizen - and implement the old one as a single-instruction operation. what do you think?", "author": "kgyrtkirk", "createdAt": "2020-11-20T10:03:41Z", "path": "service/src/java/org/apache/hive/service/cli/operation/Operation.java", "diffHunk": "@@ -88,8 +89,14 @@ protected Operation(HiveSession parentSession, OperationType opType) {\n   }\n \n   protected Operation(HiveSession parentSession,\n-      Map<String, String> confOverlay, OperationType opType) {\n+                      Map<String, String> confOverlay, OperationType opType) {\n+    this(parentSession, confOverlay, opType, false);\n+  }\n+\n+  protected Operation(HiveSession parentSession,\n+      Map<String, String> confOverlay, OperationType opType, boolean embedded) {", "originalCommit": "91be26a5852446768e2264613c987a73a87d8710", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODY2NjE2OA==", "url": "https://github.com/apache/hive/pull/1633#discussion_r528666168", "bodyText": "The SqlOperation is called with embedded=true when it is instantiated from a running hplsql script.\nnew SQLOperation(parentSession, statement, confOverlay, runAsync, queryTimeout, hplSqlMode());\n\nCould elaborate more on that idea of having it as a first class citizen?", "author": "zeroflag", "createdAt": "2020-11-23T12:24:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4Mjc2OA=="}], "type": "inlineReview"}, {"oid": "aff6cfd7426aec1a45852783f5571e8803eef1dd", "url": "https://github.com/apache/hive/commit/aff6cfd7426aec1a45852783f5571e8803eef1dd", "message": "HIVE-24230 Integrate HPL/SQL into HiveServer2 (amagyar)", "committedDate": "2020-11-23T12:29:26Z", "type": "commit"}]}