{"pr_number": 1471, "pr_title": "HIVE-23454 : Querying hive table which has Materialized view fails with HiveAccessControlException", "pr_createdAt": "2020-09-04T18:22:46Z", "pr_url": "https://github.com/apache/hive/pull/1471", "timeline": [{"oid": "7fffd02546e86899d0a499db4cba3814e9bed99f", "url": "https://github.com/apache/hive/commit/7fffd02546e86899d0a499db4cba3814e9bed99f", "message": "HIVE-23454 : Querying hive table which has Materialized view fails with HiveAccessControlException", "committedDate": "2020-09-04T18:21:47Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4OTc5MQ==", "url": "https://github.com/apache/hive/pull/1471#discussion_r483989791", "bodyText": "validateMaterializedViewsFromRegistry is only called if the MV is coming from the registry. However, we need the authorization check in all cases, e.g., dummy registry.\nYou can simply call the new method from Calcite planner.", "author": "jcamachor", "createdAt": "2020-09-05T21:04:12Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -1736,6 +1768,10 @@ public boolean validateMaterializedViewsFromRegistry(List<Table> cachedMateriali\n       // Final result\n       boolean result = true;\n       for (Table cachedMaterializedViewTable : cachedMaterializedViewTables) {\n+        if (!checkPrivillegeForMV(cachedMaterializedViewTable)) {", "originalCommit": "7fffd02546e86899d0a499db4cba3814e9bed99f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4OTgyNA==", "url": "https://github.com/apache/hive/pull/1471#discussion_r483989824", "bodyText": "Can we move this to HiveMaterializedViewUtils?\nThere is also a typo: Privillege", "author": "jcamachor", "createdAt": "2020-09-05T21:04:41Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -1718,6 +1722,34 @@ public Table apply(org.apache.hadoop.hive.metastore.api.Table table) {\n     }\n   }\n \n+  /**\n+   * Validate if given materialized view has SELECT privileges for current user\n+   * @param cachedMVTable\n+   * @return false if user does not have privilege otherwise true\n+   * @throws HiveException\n+   */\n+  private boolean checkPrivillegeForMV(final Table cachedMVTable) throws HiveException{", "originalCommit": "7fffd02546e86899d0a499db4cba3814e9bed99f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk4OTkwNg==", "url": "https://github.com/apache/hive/pull/1471#discussion_r483989906", "bodyText": "Can we check the privileges for all MVs used by the query at once so we do not need multiple round trips?", "author": "jcamachor", "createdAt": "2020-09-05T21:05:44Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -1718,6 +1722,34 @@ public Table apply(org.apache.hadoop.hive.metastore.api.Table table) {\n     }\n   }\n \n+  /**\n+   * Validate if given materialized view has SELECT privileges for current user\n+   * @param cachedMVTable\n+   * @return false if user does not have privilege otherwise true\n+   * @throws HiveException\n+   */\n+  private boolean checkPrivillegeForMV(final Table cachedMVTable) throws HiveException{\n+    List<String> colNames =\n+        cachedMVTable.getAllCols().stream()\n+            .map(FieldSchema::getName)\n+            .collect(Collectors.toList());\n+\n+    HivePrivilegeObject privObject = new HivePrivilegeObject(cachedMVTable.getDbName(),\n+        cachedMVTable.getTableName(), colNames);\n+    List<HivePrivilegeObject> privObjects = new ArrayList<HivePrivilegeObject>();\n+    privObjects.add(privObject);\n+    try {\n+      SessionState.get().getAuthorizerV2().\n+          checkPrivileges(HiveOperationType.QUERY, privObjects, privObjects, new HiveAuthzContext.Builder().build());", "originalCommit": "7fffd02546e86899d0a499db4cba3814e9bed99f", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "ce65adf605102f912179b34140f3435b0295627b", "url": "https://github.com/apache/hive/commit/ce65adf605102f912179b34140f3435b0295627b", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23454", "committedDate": "2020-09-08T19:53:18Z", "type": "commit"}, {"oid": "51e0a465ba45b0af889aa633520731f448d816ca", "url": "https://github.com/apache/hive/commit/51e0a465ba45b0af889aa633520731f448d816ca", "message": "addressing review comments", "committedDate": "2020-09-08T20:24:57Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTAwOA==", "url": "https://github.com/apache/hive/pull/1471#discussion_r485205008", "bodyText": "nit. typo", "author": "jcamachor", "createdAt": "2020-09-08T21:25:48Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/parse/CalcitePlanner.java", "diffHunk": "@@ -2280,6 +2280,15 @@ private RelNode applyMaterializedViewRewriting(RelOptPlanner planner, RelNode ba\n         return calcitePreMVRewritingPlan;\n       }\n \n+      try {\n+        if (!HiveMaterializedViewUtils.checkPrivilegeForMV(materializedViewsUsedAfterRewrite)) {\n+          // if materialized views do not have appropriate privilges, we shouldn't be using them", "originalCommit": "51e0a465ba45b0af889aa633520731f448d816ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyOTI5NQ==", "url": "https://github.com/apache/hive/pull/1471#discussion_r485929295", "bodyText": "Fixed", "author": "vineetgarg02", "createdAt": "2020-09-09T21:21:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTAwOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTM4NQ==", "url": "https://github.com/apache/hive/pull/1471#discussion_r485205385", "bodyText": "Can we use full name: checkPrivilegeForMaterializedViews ?", "author": "jcamachor", "createdAt": "2020-09-08T21:26:44Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/calcite/rules/views/HiveMaterializedViewUtils.java", "diffHunk": "@@ -347,6 +355,38 @@ public static RelNode copyNodeNewCluster(RelOptCluster optCluster, RelNode node)\n     }\n   }\n \n+  /**\n+   * Validate if given materialized view has SELECT privileges for current user\n+   * @param cachedMVTable\n+   * @return false if user does not have privilege otherwise true\n+   * @throws HiveException\n+   */\n+  public static boolean checkPrivilegeForMV(List<Table> cachedMVTableList) throws HiveException {", "originalCommit": "51e0a465ba45b0af889aa633520731f448d816ca", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkyOTI1Nw==", "url": "https://github.com/apache/hive/pull/1471#discussion_r485929257", "bodyText": "Done", "author": "vineetgarg02", "createdAt": "2020-09-09T21:21:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIwNTM4NQ=="}], "type": "inlineReview"}, {"oid": "98083e6c476cb9ca7fe3dcd22eec3f12d8c94898", "url": "https://github.com/apache/hive/commit/98083e6c476cb9ca7fe3dcd22eec3f12d8c94898", "message": "fixing typo and refactoring", "committedDate": "2020-09-09T21:21:19Z", "type": "commit"}, {"oid": "6af005c9b6332f6f3cf918813aa234b559379e14", "url": "https://github.com/apache/hive/commit/6af005c9b6332f6f3cf918813aa234b559379e14", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23454", "committedDate": "2020-09-09T21:21:30Z", "type": "commit"}, {"oid": "d8d33cc2677209fd78b5d3cfb1376b722b155471", "url": "https://github.com/apache/hive/commit/d8d33cc2677209fd78b5d3cfb1376b722b155471", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23454", "committedDate": "2020-09-10T15:31:21Z", "type": "commit"}, {"oid": "59ba49f7ae0958da7b08ebcb475c9582a4b9ff14", "url": "https://github.com/apache/hive/commit/59ba49f7ae0958da7b08ebcb475c9582a4b9ff14", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23454", "committedDate": "2020-09-11T20:41:53Z", "type": "commit"}, {"oid": "f149ff74866c2fa98ea028504fa8786499ce5b21", "url": "https://github.com/apache/hive/commit/f149ff74866c2fa98ea028504fa8786499ce5b21", "message": "Merge remote-tracking branch 'upstream/master' into HIVE-23454", "committedDate": "2020-09-14T19:13:03Z", "type": "commit"}]}