{"pr_number": 1772, "pr_title": "HIVE-24519: Optimize MV: Materialized views should not rebuild when tables are not modified", "pr_createdAt": "2020-12-14T10:44:34Z", "pr_url": "https://github.com/apache/hive/pull/1772", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDg1MA==", "url": "https://github.com/apache/hive/pull/1772#discussion_r542464850", "bodyText": "Is there any reason not to do this check right after tableName is parsed from the tree? Probably I'm missing something, but I believe that right after  line 62 this could be checked - no need to create the rootTasks then clear them. Also it would be nice to move this logic into a separate function, returning. boolean if it is outdated or not.", "author": "miklosgergely", "createdAt": "2020-12-14T15:17:40Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/view/materialized/alter/rebuild/AlterMaterializedViewRebuildAnalyzer.java", "diffHunk": "@@ -69,6 +72,23 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n \n     LOG.debug(\"Rebuilding materialized view \" + tableName.getNotEmptyDbTable());\n     super.analyzeInternal(rewrittenAST);\n+\n+    try {\n+      Table table = db.getTable(tableName.getDb(), tableName.getTable());", "originalCommit": "a97f4087c468dcc62dc69ea7df70e3d5b8480c1b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI4MjYxMw==", "url": "https://github.com/apache/hive/pull/1772#discussion_r544282613", "bodyText": "Thanks for highlighting that we have all necessary info before calling super.analyzeInternal().\nCreating HiveOperation.ALTER_MATERIALIZED_VIEW_REBUILD was necessary to get this work but no need to modify the rootTasks.", "author": "kasakrisz", "createdAt": "2020-12-16T13:06:07Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ2NDg1MA=="}], "type": "inlineReview"}, {"oid": "47a33e6b97072c1e0dc282423116cdfe5dce5d88", "url": "https://github.com/apache/hive/commit/47a33e6b97072c1e0dc282423116cdfe5dce5d88", "message": "add ALTER_MATERIALIZED_VIEW_REBUILD Operation", "committedDate": "2020-12-16T12:39:30Z", "type": "forcePushed"}, {"oid": "8cb8da886d68d75c0a42b938005de1f954fd6fd2", "url": "https://github.com/apache/hive/commit/8cb8da886d68d75c0a42b938005de1f954fd6fd2", "message": "move check before getRewrittenAST", "committedDate": "2020-12-16T13:00:28Z", "type": "forcePushed"}, {"oid": "f278c42c5a5d5a8827c1abfa8553b26b5f3b5639", "url": "https://github.com/apache/hive/commit/f278c42c5a5d5a8827c1abfa8553b26b5f3b5639", "message": "skip checking of rewriting.time.window when rebuild MV", "committedDate": "2020-12-16T16:49:37Z", "type": "forcePushed"}, {"oid": "7bfce8bcff2fe28b7528d90c0215786f1d379fb8", "url": "https://github.com/apache/hive/commit/7bfce8bcff2fe28b7528d90c0215786f1d379fb8", "message": "pass HiveTxnManager to isOutdatedMaterializedView", "committedDate": "2020-12-21T10:43:30Z", "type": "forcePushed"}, {"oid": "e1c365cf87dd3672506bd35a5eac72dc72816e1e", "url": "https://github.com/apache/hive/commit/e1c365cf87dd3672506bd35a5eac72dc72816e1e", "message": "add ALTER_MATERIALIZED_VIEW_REBUILD to Operation2Privilege", "committedDate": "2020-12-21T13:06:15Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMyNzc1MA==", "url": "https://github.com/apache/hive/pull/1772#discussion_r548327750", "bodyText": "nit. Materialized view %s.%s is up to date. Cancelling rebuild. -> Materialized view %s.%s is up to date. Skipping rebuild. ?", "author": "jcamachor", "createdAt": "2020-12-24T00:14:50Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/ddl/view/materialized/alter/rebuild/AlterMaterializedViewRebuildAnalyzer.java", "diffHunk": "@@ -63,6 +66,20 @@ public void analyzeInternal(ASTNode root) throws SemanticException {\n       unparseTranslator.addTableNameTranslation(tableTree, SessionState.get().getCurrentDatabase());\n       return;\n     }\n+\n+    try {\n+      Boolean outdated = db.isOutdatedMaterializedView(getTxnMgr(), tableName);\n+      if (outdated != null && !outdated) {\n+        String msg = String.format(\"Materialized view %s.%s is up to date. Cancelling rebuild.\",\n+                tableName.getDb(), tableName.getTable());\n+        LOG.info(msg);\n+        console.printInfo(msg, false);", "originalCommit": "e1c365cf87dd3672506bd35a5eac72dc72816e1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTE0NDU1Mw==", "url": "https://github.com/apache/hive/pull/1772#discussion_r551144553", "bodyText": "Changed.", "author": "kasakrisz", "createdAt": "2021-01-04T07:00:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMyNzc1MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzMTU2Ng==", "url": "https://github.com/apache/hive/pull/1772#discussion_r548331566", "bodyText": "Why do we need to add this operation? I saw a comment about it in another conversation but it was not clear over there.\nIn the q file below, I see that that this change is leading to inconsistent operation type when rebuild is executed (QUERY) vs skipped (ALTER_MATERIALIZED_VIEW_REBUILD). This should not happen: The operation type should be the same in both cases.", "author": "jcamachor", "createdAt": "2020-12-24T00:34:57Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/plan/HiveOperation.java", "diffHunk": "@@ -120,6 +120,8 @@\n       new Privilege[]{Privilege.DROP}),\n   ALTER_MATERIALIZED_VIEW_REWRITE(\"ALTER_MATERIALIZED_VIEW_REWRITE\", HiveParser.TOK_ALTER_MATERIALIZED_VIEW_REWRITE,\n       new Privilege[]{Privilege.ALTER_METADATA}, null),\n+  ALTER_MATERIALIZED_VIEW_REBUILD(\"ALTER_MATERIALIZED_VIEW_REBUILD\", HiveParser.TOK_ALTER_MATERIALIZED_VIEW_REBUILD,", "originalCommit": "e1c365cf87dd3672506bd35a5eac72dc72816e1e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIyMDYyOA==", "url": "https://github.com/apache/hive/pull/1772#discussion_r551220628", "bodyText": "Without this an exception is thrown at execution time.\njava.lang.IllegalStateException: Unknown HiveOperation(null) for queryId=krisz_20210104002338_38173ed5-af09-4e65-af17-8be1dc49e62e\n\tat org.apache.hadoop.hive.ql.lockmgr.DbTxnManager.verifyState(DbTxnManager.java:315)\n\tat org.apache.hadoop.hive.ql.lockmgr.DbTxnManager.acquireLocks(DbTxnManager.java:389)\n...\n\tat org.apache.hadoop.hive.ql.Driver.lockAndRespond(Driver.java:329)\n\tat org.apache.hadoop.hive.ql.Driver.runInternal(Driver.java:193)\n...\n\nFixed the inconsistency by setting back the operation type to ALTER_MATERIALIZED_VIEW_REBUILD after analyzing the query like in the case of CREATE_MATERIALIZED_VIEW", "author": "kasakrisz", "createdAt": "2021-01-04T10:06:24Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODMzMTU2Ng=="}], "type": "inlineReview"}, {"oid": "d37b775aaa189ce279f9b4a29f2d4b981d1bb121", "url": "https://github.com/apache/hive/commit/d37b775aaa189ce279f9b4a29f2d4b981d1bb121", "message": "Change message: Cancelling -> Skipping", "committedDate": "2021-01-04T06:59:48Z", "type": "forcePushed"}, {"oid": "2a8263cc5a6e5b9474a1442124f818d0e1f78476", "url": "https://github.com/apache/hive/commit/2a8263cc5a6e5b9474a1442124f818d0e1f78476", "message": "update q test outs", "committedDate": "2021-01-05T07:06:51Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA1MDYxOQ==", "url": "https://github.com/apache/hive/pull/1772#discussion_r552050619", "bodyText": "nit. repeated import", "author": "jcamachor", "createdAt": "2021-01-05T16:38:55Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/metadata/Hive.java", "diffHunk": "@@ -28,11 +28,14 @@\n import com.google.common.util.concurrent.MoreExecutors;\n import com.google.common.util.concurrent.ThreadFactoryBuilder;\n \n+import static org.apache.hadoop.hive.conf.Constants.MATERIALIZED_VIEW_REWRITING_TIME_WINDOW;\n import static org.apache.hadoop.hive.metastore.api.hive_metastoreConstants.META_TABLE_STORAGE;\n import static org.apache.hadoop.hive.metastore.utils.MetaStoreUtils.getDefaultCatalog;\n import static org.apache.hadoop.hive.ql.io.AcidUtils.getFullTableName;\n import static org.apache.hadoop.hive.ql.metadata.HiveRelOptMaterialization.RewriteAlgorithm.CALCITE;\n import static org.apache.hadoop.hive.ql.metadata.HiveRelOptMaterialization.RewriteAlgorithm.ALL;\n+import static org.apache.hadoop.hive.ql.metadata.HiveRelOptMaterialization.RewriteAlgorithm.CALCITE;", "originalCommit": "2a8263cc5a6e5b9474a1442124f818d0e1f78476", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQ0MzMyOA==", "url": "https://github.com/apache/hive/pull/1772#discussion_r552443328", "bodyText": "removed duplicates", "author": "kasakrisz", "createdAt": "2021-01-06T08:51:48Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA1MDYxOQ=="}], "type": "inlineReview"}, {"oid": "a90d7cee0060b4569c58a313c712f12e6d4fbf2a", "url": "https://github.com/apache/hive/commit/a90d7cee0060b4569c58a313c712f12e6d4fbf2a", "message": "HIVE-24519: Optimize MV: Materialized views should not rebuild when tables are not modified", "committedDate": "2021-01-06T07:57:07Z", "type": "commit"}, {"oid": "fdb21bddbedc974cc29de69f26f0b91d930fe435", "url": "https://github.com/apache/hive/commit/fdb21bddbedc974cc29de69f26f0b91d930fe435", "message": "HIVE-24519: Optimize MV: Materialized views should not rebuild when tables are not modified - move outdate check before analyzeInternal", "committedDate": "2021-01-06T07:57:07Z", "type": "commit"}, {"oid": "9bf1e6191dcf4a5d79e4b9cd0e477a5d41cdf31c", "url": "https://github.com/apache/hive/commit/9bf1e6191dcf4a5d79e4b9cd0e477a5d41cdf31c", "message": "update q test", "committedDate": "2021-01-06T07:57:07Z", "type": "commit"}, {"oid": "a5bf8952edcfc563b09b76fbeaacea2113bd1876", "url": "https://github.com/apache/hive/commit/a5bf8952edcfc563b09b76fbeaacea2113bd1876", "message": "rename q test", "committedDate": "2021-01-06T07:57:07Z", "type": "commit"}, {"oid": "f0eebc271fb3ef740f1510ef24c7ddfbf2e9e89c", "url": "https://github.com/apache/hive/commit/f0eebc271fb3ef740f1510ef24c7ddfbf2e9e89c", "message": "add ALTER_MATERIALIZED_VIEW_REBUILD Operation", "committedDate": "2021-01-06T07:57:07Z", "type": "commit"}, {"oid": "efbc9f5f4bfb8ee9bcc41f625bf53ae691c10407", "url": "https://github.com/apache/hive/commit/efbc9f5f4bfb8ee9bcc41f625bf53ae691c10407", "message": "move check before getRewrittenAST", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "b779c87c192556f135311898449d0f0d3595cb60", "url": "https://github.com/apache/hive/commit/b779c87c192556f135311898449d0f0d3595cb60", "message": "skip checking of rewriting.time.window when rebuild MV", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "9d08f1b309a33b19b97fcd999cfe1b130f9e9557", "url": "https://github.com/apache/hive/commit/9d08f1b309a33b19b97fcd999cfe1b130f9e9557", "message": "add ALTER_MATERIALIZED_VIEW_REBUILD to HiveOperationType.java", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "e3da31e249f45843fc4c999f0b9e265b404cc73a", "url": "https://github.com/apache/hive/commit/e3da31e249f45843fc4c999f0b9e265b404cc73a", "message": "pass HiveTxnManager to isOutdatedMaterializedView", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "a4f6bbfc62abdf9d357108a64cfd5ab737cf5130", "url": "https://github.com/apache/hive/commit/a4f6bbfc62abdf9d357108a64cfd5ab737cf5130", "message": "add ALTER_MATERIALIZED_VIEW_REBUILD to Operation2Privilege", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "e92b2e29f74035886a3be845bd1031dd24d96a71", "url": "https://github.com/apache/hive/commit/e92b2e29f74035886a3be845bd1031dd24d96a71", "message": "drop test mv after test run", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "d135a4f666973af36bb886fa930a98136f76c252", "url": "https://github.com/apache/hive/commit/d135a4f666973af36bb886fa930a98136f76c252", "message": "Change message: Cancelling -> Skipping", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "88e0859f6535193dd99ff23e2ac9b77a94fdda30", "url": "https://github.com/apache/hive/commit/88e0859f6535193dd99ff23e2ac9b77a94fdda30", "message": "do not print stage dependencies/plan if tasks is empty", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "625a75760088d4393f14d352ad18e369dc539b7e", "url": "https://github.com/apache/hive/commit/625a75760088d4393f14d352ad18e369dc539b7e", "message": "added q test: aggregation in MV definition", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "09a6c74edbc246681c785603033467b290cdf7ca", "url": "https://github.com/apache/hive/commit/09a6c74edbc246681c785603033467b290cdf7ca", "message": "do not add stage dependencies/plan to json if empty", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "766188f3650f90315d7ba34972abdf01a7ca0a57", "url": "https://github.com/apache/hive/commit/766188f3650f90315d7ba34972abdf01a7ca0a57", "message": "setting back command type to Alter_Materialized_View_Rebuild", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "778a53d11cc72516e0f694ece2aa736aefd57a84", "url": "https://github.com/apache/hive/commit/778a53d11cc72516e0f694ece2aa736aefd57a84", "message": "Revert \"do not add stage dependencies/plan to json if empty\"\n\nThis reverts commit e42bdce567a8e31e6f4a65751f9aa4c1825120b9.", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "666f4b558ce0e799eb06135ae51c717ebfc338e5", "url": "https://github.com/apache/hive/commit/666f4b558ce0e799eb06135ae51c717ebfc338e5", "message": "refac: extract constants", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "b346f12c3db5fa7a90d357f690a453c4b89128f9", "url": "https://github.com/apache/hive/commit/b346f12c3db5fa7a90d357f690a453c4b89128f9", "message": "update q test outs", "committedDate": "2021-01-06T07:57:08Z", "type": "commit"}, {"oid": "e55864279c5651ebd37935d13a7bff15f8f6aa5e", "url": "https://github.com/apache/hive/commit/e55864279c5651ebd37935d13a7bff15f8f6aa5e", "message": "remove duplicate imports", "committedDate": "2021-01-06T08:29:49Z", "type": "commit"}, {"oid": "d43ef9fcc68a2a4bbde66da15d058170d2e3618e", "url": "https://github.com/apache/hive/commit/d43ef9fcc68a2a4bbde66da15d058170d2e3618e", "message": "revert: refac: extract constants, do not print stage dependencies/plan if tasks is empty", "committedDate": "2021-01-06T08:49:56Z", "type": "commit"}, {"oid": "d43ef9fcc68a2a4bbde66da15d058170d2e3618e", "url": "https://github.com/apache/hive/commit/d43ef9fcc68a2a4bbde66da15d058170d2e3618e", "message": "revert: refac: extract constants, do not print stage dependencies/plan if tasks is empty", "committedDate": "2021-01-06T08:49:56Z", "type": "forcePushed"}, {"oid": "c0a953c8640fdd6334e9aa8d198a639d591d24a9", "url": "https://github.com/apache/hive/commit/c0a953c8640fdd6334e9aa8d198a639d591d24a9", "message": "fix privileges", "committedDate": "2021-01-06T10:14:06Z", "type": "commit"}, {"oid": "27de075530b8b010c794d011cef360733231915c", "url": "https://github.com/apache/hive/commit/27de075530b8b010c794d011cef360733231915c", "message": "update q tests", "committedDate": "2021-01-06T17:18:50Z", "type": "commit"}]}