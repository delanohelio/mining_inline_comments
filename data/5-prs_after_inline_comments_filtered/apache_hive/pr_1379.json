{"pr_number": 1379, "pr_title": "HIVE-23408: Hive on Tez : Kafka storage handler broken in secure envi\u2026", "pr_createdAt": "2020-08-07T14:53:43Z", "pr_url": "https://github.com/apache/hive/pull/1379", "timeline": [{"oid": "792f69499f1935cfaad743353630dc51835bd119", "url": "https://github.com/apache/hive/commit/792f69499f1935cfaad743353630dc51835bd119", "message": "HIVE-23408: Hive on Tez : Kafka storage handler broken in secure environment\n\nChange-Id: I486e9169279765b8a695d27264b770c8db92128f", "committedDate": "2020-08-24T13:26:54Z", "type": "commit"}, {"oid": "792f69499f1935cfaad743353630dc51835bd119", "url": "https://github.com/apache/hive/commit/792f69499f1935cfaad743353630dc51835bd119", "message": "HIVE-23408: Hive on Tez : Kafka storage handler broken in secure environment\n\nChange-Id: I486e9169279765b8a695d27264b770c8db92128f", "committedDate": "2020-08-24T13:26:54Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NDk0OQ==", "url": "https://github.com/apache/hive/pull/1379#discussion_r483044949", "bodyText": "This is iterating over all partition objects in plan even when kafka is not used. This gets expensive when there are large number of partition objects. Is it possible to do a quick check to see if kafka is used before iterating over full list of parttions?", "author": "ashutoshc", "createdAt": "2020-09-03T14:58:44Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/tez/DagUtils.java", "diffHunk": "@@ -265,11 +279,70 @@ public URI apply(Path path) {\n         }\n         dag.addURIsForCredentials(uris);\n       }\n+      getKafkaCredentials((MapWork)work, dag, conf);\n     }\n-\n     getCredentialsForFileSinks(work, dag);\n   }\n \n+  private void getKafkaCredentials(MapWork work, DAG dag, JobConf conf) {\n+    Token<?> tokenCheck = dag.getCredentials().getToken(KAFKA_DELEGATION_TOKEN_KEY);\n+    if (tokenCheck != null) {\n+      LOG.debug(\"Kafka credentials already added, skipping...\");\n+      return;\n+    }\n+    LOG.info(\"Getting kafka credentials for mapwork: \" + work.getName());\n+\n+    String kafkaBrokers = null;\n+    Map<String, PartitionDesc> partitions = work.getAliasToPartnInfo();", "originalCommit": "792f69499f1935cfaad743353630dc51835bd119", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzEzOTA3Mw==", "url": "https://github.com/apache/hive/pull/1379#discussion_r483139073", "bodyText": "good point, I was thinking about the same, this can become an expensive loop and 100% useless for users not using kafka, let me look for a short-circuit way", "author": "abstractdog", "createdAt": "2020-09-03T17:23:04Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NDk0OQ=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzYwNzA3MQ==", "url": "https://github.com/apache/hive/pull/1379#discussion_r483607071", "bodyText": "@ashutoshc : what do you think about this? edc4ad4#diff-d7b5b051769b68ed5dd602cc30744439R303-R306\n(tested on cluster)", "author": "abstractdog", "createdAt": "2020-09-04T13:13:41Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzA0NDk0OQ=="}], "type": "inlineReview"}, {"oid": "0f7a0ed812713b57d261e4744a510ea5bba64c01", "url": "https://github.com/apache/hive/commit/0f7a0ed812713b57d261e4744a510ea5bba64c01", "message": "HIVE-23408: addressing PR comments\n\nChange-Id: I5b09b318f5dfdbda07247748f9f8e566e00805ed", "committedDate": "2020-09-04T14:54:44Z", "type": "commit"}, {"oid": "0f7a0ed812713b57d261e4744a510ea5bba64c01", "url": "https://github.com/apache/hive/commit/0f7a0ed812713b57d261e4744a510ea5bba64c01", "message": "HIVE-23408: addressing PR comments\n\nChange-Id: I5b09b318f5dfdbda07247748f9f8e566e00805ed", "committedDate": "2020-09-04T14:54:44Z", "type": "forcePushed"}]}