{"pr_number": 1665, "pr_title": "HIVE-24341", "pr_createdAt": "2020-11-11T16:12:34Z", "pr_url": "https://github.com/apache/hive/pull/1665", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NDc5MA==", "url": "https://github.com/apache/hive/pull/1665#discussion_r521994790", "bodyText": "How can this be null?", "author": "pvary", "createdAt": "2020-11-12T10:20:56Z", "path": "llap-server/src/java/org/apache/hadoop/hive/llap/cache/ProactiveEvictingCachePolicy.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.llap.cache;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hive.common.util.ShutdownHookManager;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+\n+/**\n+ * Interface for classes required to be able to receive notifyProactiveEvictionMark event. Had to be this way due to\n+ * how CacheContentsTracker is designed to wrap around actual cache policies.\n+ *\n+ * Implementing this interface is required but not sufficient for a cache policy to be proactive eviction supporting.\n+ * Such policies also need to extend the implementation below, so that the asynchronous sweeping is taken care of,\n+ * and they need to implement evictProactively() method.\n+ */\n+public interface ProactiveEvictingCachePolicy {\n+\n+  /**\n+   * Invoking this signals that new buffers have been marked for proactive eviction. Cache policies implementing this\n+   * need this information to correctly time sweep runs.\n+   */\n+  void notifyProactiveEvictionMark();\n+\n+  abstract class Impl implements ProactiveEvictingCachePolicy {\n+    protected final boolean proactiveEvictionEnabled;\n+    private final long proactiveEvictionSweepIntervalInMs;\n+    private static final ScheduledExecutorService PROACTIVE_EVICTION_SWEEPER_EXECUTOR =\n+        Executors.newSingleThreadScheduledExecutor(new ThreadFactoryBuilder()\n+            .setNameFormat(\"Proactive-Eviction-Sweeper\").setDaemon(true).build());\n+\n+    // Last sweep starts higher, so we don't trigger sweeps before the first mark\n+    AtomicLong lastMarkTime = new AtomicLong(0L);\n+    AtomicLong lastSweepTime = new AtomicLong(1L);\n+\n+    static {\n+      ShutdownHookManager.addShutdownHook(new Runnable() {\n+        @Override\n+        public void run() {\n+          if (PROACTIVE_EVICTION_SWEEPER_EXECUTOR != null) {", "originalCommit": "8e9107fab7cbc403ae868387f7b4d6ddf180b93c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA2NjIzMQ==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522066231", "bodyText": "See other comment.", "author": "szlta", "createdAt": "2020-11-12T12:23:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NDc5MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NjE2Nw==", "url": "https://github.com/apache/hive/pull/1665#discussion_r521996167", "bodyText": "Do not we want to create the executor here?", "author": "pvary", "createdAt": "2020-11-12T10:23:04Z", "path": "llap-server/src/java/org/apache/hadoop/hive/llap/cache/ProactiveEvictingCachePolicy.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.llap.cache;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hive.common.util.ShutdownHookManager;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+\n+/**\n+ * Interface for classes required to be able to receive notifyProactiveEvictionMark event. Had to be this way due to\n+ * how CacheContentsTracker is designed to wrap around actual cache policies.\n+ *\n+ * Implementing this interface is required but not sufficient for a cache policy to be proactive eviction supporting.\n+ * Such policies also need to extend the implementation below, so that the asynchronous sweeping is taken care of,\n+ * and they need to implement evictProactively() method.\n+ */\n+public interface ProactiveEvictingCachePolicy {\n+\n+  /**\n+   * Invoking this signals that new buffers have been marked for proactive eviction. Cache policies implementing this\n+   * need this information to correctly time sweep runs.\n+   */\n+  void notifyProactiveEvictionMark();\n+\n+  abstract class Impl implements ProactiveEvictingCachePolicy {\n+    protected final boolean proactiveEvictionEnabled;\n+    private final long proactiveEvictionSweepIntervalInMs;\n+    private static final ScheduledExecutorService PROACTIVE_EVICTION_SWEEPER_EXECUTOR =\n+        Executors.newSingleThreadScheduledExecutor(new ThreadFactoryBuilder()\n+            .setNameFormat(\"Proactive-Eviction-Sweeper\").setDaemon(true).build());\n+\n+    // Last sweep starts higher, so we don't trigger sweeps before the first mark\n+    AtomicLong lastMarkTime = new AtomicLong(0L);\n+    AtomicLong lastSweepTime = new AtomicLong(1L);\n+\n+    static {\n+      ShutdownHookManager.addShutdownHook(new Runnable() {\n+        @Override\n+        public void run() {\n+          if (PROACTIVE_EVICTION_SWEEPER_EXECUTOR != null) {\n+            PROACTIVE_EVICTION_SWEEPER_EXECUTOR.shutdownNow();\n+          }\n+        }\n+      });\n+    }\n+\n+    protected Impl(Configuration conf) {\n+      proactiveEvictionEnabled = HiveConf.getBoolVar(conf, HiveConf.ConfVars.LLAP_IO_PROACTIVE_EVICTION_ENABLED);\n+      proactiveEvictionSweepIntervalInMs = HiveConf.getTimeVar(conf,\n+          HiveConf.ConfVars.LLAP_IO_PROACTIVE_EVICTION_SWEEP_INTERVAL, TimeUnit.MILLISECONDS);\n+\n+      if (proactiveEvictionEnabled) {\n+        PROACTIVE_EVICTION_SWEEPER_EXECUTOR.scheduleWithFixedDelay(new Runnable() {", "originalCommit": "8e9107fab7cbc403ae868387f7b4d6ddf180b93c", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA2NjE1NA==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522066154", "bodyText": "Yes thanks for spotting this, looks like I was thinking about something like this when I put the null check in the static block :)", "author": "szlta", "createdAt": "2020-11-12T12:22:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5NjE2Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA3ODA3NA==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522078074", "bodyText": "Maybe set it to null after shutdown?\nGenerally a good practice, it does not really matter here..", "author": "pvary", "createdAt": "2020-11-12T12:44:06Z", "path": "llap-server/src/java/org/apache/hadoop/hive/llap/cache/ProactiveEvictingCachePolicy.java", "diffHunk": "@@ -0,0 +1,100 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.llap.cache;\n+\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.ScheduledExecutorService;\n+import java.util.concurrent.TimeUnit;\n+import java.util.concurrent.atomic.AtomicLong;\n+\n+import org.apache.hadoop.conf.Configuration;\n+import org.apache.hadoop.hive.conf.HiveConf;\n+import org.apache.hive.common.util.ShutdownHookManager;\n+\n+import com.google.common.util.concurrent.ThreadFactoryBuilder;\n+\n+/**\n+ * Interface for classes required to be able to receive notifyProactiveEvictionMark event. Had to be this way due to\n+ * how CacheContentsTracker is designed to wrap around actual cache policies.\n+ *\n+ * Implementing this interface is required but not sufficient for a cache policy to be proactive eviction supporting.\n+ * Such policies also need to extend the implementation below, so that the asynchronous sweeping is taken care of,\n+ * and they need to implement evictProactively() method.\n+ */\n+public interface ProactiveEvictingCachePolicy {\n+\n+  /**\n+   * Invoking this signals that new buffers have been marked for proactive eviction. Cache policies implementing this\n+   * need this information to correctly time sweep runs.\n+   */\n+  void notifyProactiveEvictionMark();\n+\n+  abstract class Impl implements ProactiveEvictingCachePolicy {\n+    protected final boolean proactiveEvictionEnabled;\n+    private final long proactiveEvictionSweepIntervalInMs;\n+    private static ScheduledExecutorService PROACTIVE_EVICTION_SWEEPER_EXECUTOR = null;\n+\n+    // Last sweep starts higher, so we don't trigger sweeps before the first mark\n+    AtomicLong lastMarkTime = new AtomicLong(0L);\n+    AtomicLong lastSweepTime = new AtomicLong(1L);\n+\n+    static {\n+      ShutdownHookManager.addShutdownHook(new Runnable() {\n+        @Override\n+        public void run() {\n+          if (PROACTIVE_EVICTION_SWEEPER_EXECUTOR != null) {\n+            PROACTIVE_EVICTION_SWEEPER_EXECUTOR.shutdownNow();", "originalCommit": "b8fae5273e8e8ce927fb56f61a2efdc3d40be452", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA5MjcwNg==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522092706", "bodyText": "Yeah I guess it makes no difference here.", "author": "szlta", "createdAt": "2020-11-12T13:08:46Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA3ODA3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwMDk3NA==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522500974", "bodyText": "Why is this required?", "author": "asinkovits", "createdAt": "2020-11-12T23:27:52Z", "path": "llap-server/src/java/org/apache/hadoop/hive/llap/cache/EvictionListener.java", "diffHunk": "@@ -20,4 +20,5 @@\n \n public interface EvictionListener {\n   void notifyEvicted(LlapCacheableBuffer buffer);\n+  void notifyEvictedBytes(long size);", "originalCommit": "b8fae5273e8e8ce927fb56f61a2efdc3d40be452", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwNzUwMw==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522907503", "bodyText": "Good point, reworked in follow-up commit as discussed offline.", "author": "szlta", "createdAt": "2020-11-13T12:01:53Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwMDk3NA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwMTA4Mg==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522501082", "bodyText": "I think this would make sense in the mark phase as well.", "author": "asinkovits", "createdAt": "2020-11-12T23:28:03Z", "path": "llap-server/src/java/org/apache/hadoop/hive/llap/io/api/impl/LlapIoImpl.java", "diffHunk": "@@ -151,8 +151,10 @@ private LlapIoImpl(Configuration conf) throws IOException {\n       LowLevelCachePolicy\n           realCachePolicy =\n           useLrfu ? new LowLevelLrfuCachePolicy(minAllocSize, totalMemorySize, conf) : new LowLevelFifoCachePolicy();\n-      // TODO: if realCachePolicy is not something that supports proactive caching\n-      // turn the feature off (LLAP_IO_PROACTIVE_EVICTION_ENABLED) and log it\n+      if (!(realCachePolicy instanceof ProactiveEvictingCachePolicy.Impl)) {", "originalCommit": "b8fae5273e8e8ce927fb56f61a2efdc3d40be452", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkwNzk0Nw==", "url": "https://github.com/apache/hive/pull/1665#discussion_r522907947", "bodyText": "It would be very cumbersome to check this on HS2 side due to potentially different config files being used for HS2 and LLAP side. Also these services might get restarted independently from each other with different config.", "author": "szlta", "createdAt": "2020-11-13T12:03:01Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjUwMTA4Mg=="}], "type": "inlineReview"}, {"oid": "6eaa9a0d8bd7e3abfcf70e9cb661f8dbad52c0ce", "url": "https://github.com/apache/hive/commit/6eaa9a0d8bd7e3abfcf70e9cb661f8dbad52c0ce", "message": "HIVE-24341: Sweep phase for proactive cache eviction + squash commits from PR", "committedDate": "2020-11-16T08:52:42Z", "type": "commit"}, {"oid": "6eaa9a0d8bd7e3abfcf70e9cb661f8dbad52c0ce", "url": "https://github.com/apache/hive/commit/6eaa9a0d8bd7e3abfcf70e9cb661f8dbad52c0ce", "message": "HIVE-24341: Sweep phase for proactive cache eviction + squash commits from PR", "committedDate": "2020-11-16T08:52:42Z", "type": "forcePushed"}]}