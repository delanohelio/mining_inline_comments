{"pr_number": 1647, "pr_title": "HIVE-24329: Add Notification event for compaction commit", "pr_createdAt": "2020-11-03T12:19:24Z", "pr_url": "https://github.com/apache/hive/pull/1647", "timeline": [{"oid": "22e62209f365f530633b68ef6c803e44252d2b0c", "url": "https://github.com/apache/hive/commit/22e62209f365f530633b68ef6c803e44252d2b0c", "message": "HIVE-24329: Add Notification event for compaction commit", "committedDate": "2020-11-03T12:17:36Z", "type": "commit"}, {"oid": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "url": "https://github.com/apache/hive/commit/21fab98f792042bd82ae6ef1f73a08ce89d85a61", "message": "Merge remote-tracking branch 'origin/master' into HIVE-24329-compaction-notification-2\n\n# Conflicts:\n#\tstandalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "committedDate": "2020-11-10T15:22:13Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3OTk2OQ==", "url": "https://github.com/apache/hive/pull/1647#discussion_r521379969", "bodyText": "I haven't seen that other events contained db information. Is it required here?", "author": "deniskuzZ", "createdAt": "2020-11-11T14:04:55Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/events/CommitCompactionEvent.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.metastore.events;\n+\n+import org.apache.hadoop.classification.InterfaceAudience;\n+import org.apache.hadoop.classification.InterfaceStability;\n+import org.apache.hadoop.hive.metastore.IHMSHandler;\n+import org.apache.hadoop.hive.metastore.api.CompactionType;\n+import org.apache.hadoop.hive.metastore.api.TxnType;\n+import org.apache.hadoop.hive.metastore.txn.CompactionInfo;\n+\n+/**\n+ * CommitCompactionEvent\n+ * Event generated for compaction commit operation\n+ */\n+@InterfaceAudience.Public\n+@InterfaceStability.Stable\n+public class CommitCompactionEvent extends ListenerEvent {\n+\n+  private final Long txnId;\n+  private final Long compactionId;\n+  private final CompactionType type;\n+  private final String dbname;", "originalCommit": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDIzMjUxNQ==", "url": "https://github.com/apache/hive/pull/1647#discussion_r524232515", "bodyText": "The filemetadata cache will have to invalidate the cache of a given partition based on the event payload. It most likely  will need to use the dbName as part of the key, to identify the right table. When it matters the event contains this info (see AllocWriteIdEvent)", "author": "pvargacl", "createdAt": "2020-11-16T12:41:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM3OTk2OQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MTM2NA==", "url": "https://github.com/apache/hive/pull/1647#discussion_r521381364", "bodyText": "Same as above, do we actually need db name here?", "author": "deniskuzZ", "createdAt": "2020-11-11T14:07:10Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/messaging/CommitCompactionMessage.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/* * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.hadoop.hive.metastore.messaging;\n+\n+import org.apache.hadoop.hive.metastore.api.CompactionType;\n+import org.apache.hadoop.hive.metastore.api.Partition;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.WriteEventInfo;\n+\n+import java.util.List;\n+\n+/**\n+ * Message sent when a compaction commit is done.\n+ */\n+public abstract class CommitCompactionMessage extends EventMessage {\n+\n+  protected CommitCompactionMessage() {\n+    super(EventType.COMMIT_COMPACTION);\n+  }\n+\n+  public abstract Long getTxnId();\n+\n+  public abstract Long getCompactionId();\n+\n+  public abstract  CompactionType getType();\n+\n+  public abstract String getDbname();", "originalCommit": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MjQwMg==", "url": "https://github.com/apache/hive/pull/1647#discussion_r521382402", "bodyText": "Maybe use builder to avoid constructor with huge number of params?", "author": "deniskuzZ", "createdAt": "2020-11-11T14:08:47Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/messaging/json/JSONCommitCompactionMessage.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one\n+ * or more contributor license agreements.  See the NOTICE file\n+ * distributed with this work for additional information\n+ * regarding copyright ownership.  The ASF licenses this file\n+ * to you under the Apache License, Version 2.0 (the\n+ * \"License\"); you may not use this file except in compliance\n+ * with the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.apache.hadoop.hive.metastore.messaging.json;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.google.common.collect.Lists;\n+import org.apache.hadoop.hive.metastore.api.CompactionType;\n+import org.apache.hadoop.hive.metastore.api.Partition;\n+import org.apache.hadoop.hive.metastore.api.Table;\n+import org.apache.hadoop.hive.metastore.api.WriteEventInfo;\n+import org.apache.hadoop.hive.metastore.messaging.CommitCompactionMessage;\n+import org.apache.hadoop.hive.metastore.messaging.CommitTxnMessage;\n+import org.apache.hadoop.hive.metastore.messaging.MessageBuilder;\n+\n+import java.util.List;\n+\n+/**\n+ * JSON implementation of CommitCompactionMessage\n+ */\n+public class JSONCommitCompactionMessage extends CommitCompactionMessage {\n+\n+  @JsonProperty\n+  private Long txnid;\n+\n+  @JsonProperty\n+  private Long timestamp;\n+\n+  @JsonProperty\n+  private String server;\n+\n+  @JsonProperty\n+  private String servicePrincipal;\n+\n+  @JsonProperty\n+  private Long compactionId;\n+\n+  @JsonProperty\n+  private CompactionType type;\n+\n+  @JsonProperty\n+  private String dbname;\n+\n+  @JsonProperty\n+  private String tableName;\n+\n+  @JsonProperty\n+  private String partName;\n+\n+  /**\n+   * Default constructor, needed for Jackson.\n+   */\n+  public JSONCommitCompactionMessage() {\n+  }\n+\n+  public JSONCommitCompactionMessage(String server, String servicePrincipal, Long timestamp, Long txnid,", "originalCommit": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5MjYzNg==", "url": "https://github.com/apache/hive/pull/1647#discussion_r525992636", "bodyText": "passed the event as parameter.", "author": "pvargacl", "createdAt": "2020-11-18T10:53:22Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MjQwMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MzI4MA==", "url": "https://github.com/apache/hive/pull/1647#discussion_r521383280", "bodyText": "why is it protected?", "author": "deniskuzZ", "createdAt": "2020-11-11T14:10:05Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/CompactionTxnHandler.java", "diffHunk": "@@ -1162,6 +1172,55 @@ protected void updateWSCommitIdAndCleanUpMetadata(Statement stmt, long txnid, Tx\n               TxnDbUtil.getEpochFn(dbProduct) + \" WHERE \\\"CQ_TXN_ID\\\" = \" + txnid);\n     }\n   }\n+\n+  protected CompactionInfo getCompactionByTxnId(Connection dbConn, long txnid) throws SQLException, MetaException {", "originalCommit": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0ODc2Mg==", "url": "https://github.com/apache/hive/pull/1647#discussion_r524248762", "bodyText": "fixed.", "author": "pvargacl", "createdAt": "2020-11-16T12:57:58Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4MzI4MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4NjU2OA==", "url": "https://github.com/apache/hive/pull/1647#discussion_r521386568", "bodyText": "Why do we have compaction related stuff in TxnHandler? It's an abstract class already.", "author": "deniskuzZ", "createdAt": "2020-11-11T14:15:05Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "diffHunk": "@@ -1409,6 +1407,23 @@ public void commitTxn(CommitTxnRequest rqst)\n     }\n   }\n \n+  /**\n+   * Create Notifiaction Events on txn commit\n+   * @param dbConn DatabaseConnection\n+   * @param txnid committed txn\n+   * @param txnType transaction type\n+   * @throws MetaException ex\n+   */\n+  protected void createCommitNotificationEvent(Connection dbConn, long txnid, Optional<TxnType> txnType)\n+      throws MetaException, SQLException {\n+    if (transactionalListeners != null) {\n+      MetaStoreListenerNotifier.notifyEventWithDirectSql(transactionalListeners,\n+              EventMessage.EventType.COMMIT_TXN, new CommitTxnEvent(txnid, txnType.get()), dbConn, sqlGenerator);\n+    }\n+  }\n+\n+  protected abstract CompactionInfo getCompactionByTxnId(Connection dbConn, long txnid) throws SQLException, MetaException;", "originalCommit": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0NDk1Mg==", "url": "https://github.com/apache/hive/pull/1647#discussion_r524244952", "bodyText": "It was a leftover, deleted.", "author": "pvargacl", "createdAt": "2020-11-16T12:53:14Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4NjU2OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQyNDg1NA==", "url": "https://github.com/apache/hive/pull/1647#discussion_r521424854", "bodyText": "I think, this has overlap with createCommitNotificationEvent", "author": "deniskuzZ", "createdAt": "2020-11-11T15:10:24Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/HiveMetaStore.java", "diffHunk": "@@ -8373,6 +8374,11 @@ public void commit_txn(CommitTxnRequest rqst) throws TException {\n       if (listeners != null && !listeners.isEmpty()) {\n         MetaStoreListenerNotifier.notifyEvent(listeners, EventType.COMMIT_TXN,\n                 new CommitTxnEvent(rqst.getTxnid(), this));\n+        CompactionInfo compactionInfo = getTxnHandler().getCompactionByTxnId(rqst.getTxnid());", "originalCommit": "21fab98f792042bd82ae6ef1f73a08ce89d85a61", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI0ODU4MQ==", "url": "https://github.com/apache/hive/pull/1647#discussion_r524248581", "bodyText": "This does a little bit different thing. In TxnHandler we notify the transactional eventListeners using the same jdbc connection from the txnhandler. The event will be committed together with the \"hive transaction commit\". This on the other hand notifies the \"normal\" event listeners. The file metadata cache strictly needs only the first one, but every other transactional event is fired as normal event also, so I don't want to break this pattern.", "author": "pvargacl", "createdAt": "2020-11-16T12:57:37Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQyNDg1NA=="}], "type": "inlineReview"}, {"oid": "aa358c5eac2bf8d5ba5e594e6835a2ccbfb45f78", "url": "https://github.com/apache/hive/commit/aa358c5eac2bf8d5ba5e594e6835a2ccbfb45f78", "message": "Fix review comments", "committedDate": "2020-11-16T13:01:16Z", "type": "commit"}, {"oid": "18e9e86d4d1977f88b85994469dc8377d386b8c5", "url": "https://github.com/apache/hive/commit/18e9e86d4d1977f88b85994469dc8377d386b8c5", "message": "Merge remote-tracking branch 'origin/master' into HIVE-24329-compaction-notification-2\n\n# Conflicts:\n#\tstandalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/TxnHandler.java", "committedDate": "2020-11-16T13:04:17Z", "type": "commit"}, {"oid": "afcc84a8ad4877cb73c7c49272aeb7e55e80dab3", "url": "https://github.com/apache/hive/commit/afcc84a8ad4877cb73c7c49272aeb7e55e80dab3", "message": "Fix DbNotificationListener", "committedDate": "2020-11-16T13:19:34Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1NzkyNQ==", "url": "https://github.com/apache/hive/pull/1647#discussion_r527057925", "bodyText": "Wouldn't it be better if we wrap this with Optional?", "author": "deniskuzZ", "createdAt": "2020-11-19T17:13:17Z", "path": "standalone-metastore/metastore-server/src/main/java/org/apache/hadoop/hive/metastore/txn/CompactionTxnHandler.java", "diffHunk": "@@ -1176,6 +1186,55 @@ protected void updateWSCommitIdAndCleanUpMetadata(Statement stmt, long txnid, Tx\n               TxnDbUtil.getEpochFn(dbProduct) + \" WHERE \\\"CQ_TXN_ID\\\" = \" + txnid);\n     }\n   }\n+\n+  private CompactionInfo getCompactionByTxnId(Connection dbConn, long txnid) throws SQLException, MetaException {\n+    CompactionInfo info = null;", "originalCommit": "afcc84a8ad4877cb73c7c49272aeb7e55e80dab3", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzUzODkyMA==", "url": "https://github.com/apache/hive/pull/1647#discussion_r527538920", "bodyText": "good catch, fixed.", "author": "pvargacl", "createdAt": "2020-11-20T09:00:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzA1NzkyNQ=="}], "type": "inlineReview"}, {"oid": "602299ce70461db371e0ab92e36d0687c5f6b77b", "url": "https://github.com/apache/hive/commit/602299ce70461db371e0ab92e36d0687c5f6b77b", "message": "Use Optional", "committedDate": "2020-11-20T08:41:21Z", "type": "commit"}]}