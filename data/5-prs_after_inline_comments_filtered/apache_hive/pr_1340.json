{"pr_number": 1340, "pr_title": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading", "pr_createdAt": "2020-07-30T16:19:58Z", "pr_url": "https://github.com/apache/hive/pull/1340", "timeline": [{"oid": "f379d93e38532be318bbab59e41cd4cae795c643", "url": "https://github.com/apache/hive/commit/f379d93e38532be318bbab59e41cd4cae795c643", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name", "committedDate": "2020-07-31T16:08:45Z", "type": "forcePushed"}, {"oid": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "url": "https://github.com/apache/hive/commit/6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name", "committedDate": "2020-08-01T04:27:21Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNTkwNQ==", "url": "https://github.com/apache/hive/pull/1340#discussion_r464815905", "bodyText": "Can you add TODO or a followup ticket that would replace this string with actual TaskCounter enum from tez (in next subsequent tez release) ?", "author": "rbalamohan", "createdAt": "2020-08-04T05:55:06Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "diffHunk": "@@ -125,13 +126,24 @@ public void load(MapJoinTableContainer[] mapJoinTables,\n         KeyValueReader kvReader = (KeyValueReader) input.getReader();\n \n         Long keyCountObj = parentKeyCounts.get(pos);\n-        long keyCount = (keyCountObj == null) ? -1 : keyCountObj.longValue();\n+        long estKeyCount = (keyCountObj == null) ? -1 : keyCountObj;\n+\n+        long inputRecords = -1;\n+        try {\n+          inputRecords = ((AbstractLogicalInput) input).getContext().getCounters().", "originalCommit": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDgxNjE3NQ==", "url": "https://github.com/apache/hive/pull/1340#discussion_r464816175", "bodyText": "Can you add \"delta\" (line 171) in the log as well, to have details on the hash table load time?", "author": "rbalamohan", "createdAt": "2020-08-04T05:56:04Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/exec/vector/mapjoin/fast/VectorMapJoinFastHashTableLoader.java", "diffHunk": "@@ -125,13 +126,24 @@ public void load(MapJoinTableContainer[] mapJoinTables,\n         KeyValueReader kvReader = (KeyValueReader) input.getReader();\n \n         Long keyCountObj = parentKeyCounts.get(pos);\n-        long keyCount = (keyCountObj == null) ? -1 : keyCountObj.longValue();\n+        long estKeyCount = (keyCountObj == null) ? -1 : keyCountObj;\n+\n+        long inputRecords = -1;\n+        try {\n+          inputRecords = ((AbstractLogicalInput) input).getContext().getCounters().\n+                  findCounter(\"org.apache.tez.common.counters.TaskCounter\",\n+                          \"APPROXIMATE_INPUT_RECORDS\").getValue();\n+        } catch (Exception e) {\n+          LOG.debug(\"Failed to get value for counter APPROXIMATE_INPUT_RECORDS\", e);\n+        }\n+        long keyCount = Math.max(estKeyCount, inputRecords);\n \n         VectorMapJoinFastTableContainer vectorMapJoinFastTableContainer =\n                 new VectorMapJoinFastTableContainer(desc, hconf, keyCount);\n \n-        LOG.info(\"Loading hash table for input: {} cacheKey: {} tableContainer: {} smallTablePos: {}\", inputName,\n-          cacheKey, vectorMapJoinFastTableContainer.getClass().getSimpleName(), pos);\n+        LOG.info(\"Loading hash table for input: {} cacheKey: {} tableContainer: {} smallTablePos: {} \" +", "originalCommit": "6672bfa4d9f2a67f5e1bb41c0fba50b77a011b1d", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "1a0af20bbb873b56c72132bfcc23124a92011400", "url": "https://github.com/apache/hive/commit/1a0af20bbb873b56c72132bfcc23124a92011400", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading", "committedDate": "2020-08-04T07:11:00Z", "type": "commit"}, {"oid": "9e01811d75420caf76aa0f3e9d8f3cf33446b7de", "url": "https://github.com/apache/hive/commit/9e01811d75420caf76aa0f3e9d8f3cf33446b7de", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name", "committedDate": "2020-08-04T07:11:00Z", "type": "commit"}, {"oid": "6e6aca60301c11f0713bc57fbb7eb35389387e7d", "url": "https://github.com/apache/hive/commit/6e6aca60301c11f0713bc57fbb7eb35389387e7d", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name", "committedDate": "2020-08-04T07:11:00Z", "type": "commit"}, {"oid": "6e6aca60301c11f0713bc57fbb7eb35389387e7d", "url": "https://github.com/apache/hive/commit/6e6aca60301c11f0713bc57fbb7eb35389387e7d", "message": "HIVE-23953 : Use task counter information to compute keycount during hashtable loading : with counter name", "committedDate": "2020-08-04T07:11:00Z", "type": "forcePushed"}]}