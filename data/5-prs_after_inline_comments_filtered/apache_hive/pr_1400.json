{"pr_number": 1400, "pr_title": "HIVE-18284: Fix NPE when inserting data with 'distribute by' clause with dynpart sort optimization", "pr_createdAt": "2020-08-13T08:17:53Z", "pr_url": "https://github.com/apache/hive/pull/1400", "timeline": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxMjA4Nw==", "url": "https://github.com/apache/hive/pull/1400#discussion_r479212087", "bodyText": "I think we should be merging the child into the parent inside this \"if\" - and we have 2  specific conditionals which are handled - so I think an else false here would be needed - to close down unhandled future cases", "author": "kgyrtkirk", "createdAt": "2020-08-28T12:11:30Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/correlation/ReduceSinkDeDuplicationUtils.java", "diffHunk": "@@ -181,6 +183,23 @@ public static boolean merge(HiveConf hiveConf, ReduceSinkOperator cRS, ReduceSin\n         TableDesc keyTable = PlanUtils.getReduceKeyTableDesc(new ArrayList<FieldSchema>(), pRS\n             .getConf().getOrder(), pRS.getConf().getNullOrder());\n         pRS.getConf().setKeySerializeInfo(keyTable);\n+      } else if (cRS.getConf().getKeyCols() != null && cRS.getConf().getKeyCols().size() > 0) {\n+        ArrayList<String> keyColNames = Lists.newArrayList();\n+        for (ExprNodeDesc keyCol : pRS.getConf().getKeyCols()) {\n+          String keyColName = keyCol.getExprString();\n+          keyColNames.add(keyColName);\n+        }\n+        List<FieldSchema> fields = PlanUtils.getFieldSchemasFromColumnList(pRS.getConf().getKeyCols(),\n+            keyColNames, 0, \"\");\n+        TableDesc keyTable = PlanUtils.getReduceKeyTableDesc(fields, pRS.getConf().getOrder(),\n+            pRS.getConf().getNullOrder());\n+        ArrayList<String> outputKeyCols = Lists.newArrayList();\n+        for (int i = 0; i < fields.size(); i++) {\n+          outputKeyCols.add(fields.get(i).getName());\n+        }\n+        pRS.getConf().setOutputKeyColumnNames(outputKeyCols);\n+        pRS.getConf().setKeySerializeInfo(keyTable);\n+        pRS.getConf().setNumDistributionKeys(cRS.getConf().getNumDistributionKeys());\n       }", "originalCommit": "1ac7b0f70e07faa87ce75669d65040f983027a6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg5NDEyOA==", "url": "https://github.com/apache/hive/pull/1400#discussion_r479894128", "bodyText": "Such case would arise only when both pRS keyCol is not empty and cRS keyCol is empty, In such cases wouldn't it be correct to return to true and go with the pRS values. I mean by the time the program pointer reaches here there would have been some merging of cRS to pRS would have happened upstream.", "author": "shameersss1", "createdAt": "2020-08-31T05:24:31Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxMjA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTcxOTY3NA==", "url": "https://github.com/apache/hive/pull/1400#discussion_r495719674", "bodyText": "Just to add more context here, Number of distribution keys of cRS is chosen only when numDistKeys of pRS is 0 or less. In all other cases, distribution of the keys is based on the pRS which is more generic than cRS. We will enter this \"if\" condition only in two cases\n\npRS keyCol is empty and cRS keyCol is empty\npRS keyCol is empty and cRS keyCol is not empty\n\nSo in case I we would like to keep the pRS properties intact since pRS is more generic. In case (2) we want to go with cRS properties hence i think returning false is not required.\nDoes this make sense? Or am i missing any thing?", "author": "shameersss1", "createdAt": "2020-09-28T06:43:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxMjA4Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5NTc1NQ==", "url": "https://github.com/apache/hive/pull/1400#discussion_r514195755", "bodyText": "yes; you are correct", "author": "kgyrtkirk", "createdAt": "2020-10-29T11:44:16Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxMjA4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxNjkxNw==", "url": "https://github.com/apache/hive/pull/1400#discussion_r479216917", "bodyText": "don't we need any conditional on pRS here?", "author": "kgyrtkirk", "createdAt": "2020-08-28T12:15:50Z", "path": "ql/src/java/org/apache/hadoop/hive/ql/optimizer/correlation/ReduceSinkDeDuplicationUtils.java", "diffHunk": "@@ -181,6 +183,23 @@ public static boolean merge(HiveConf hiveConf, ReduceSinkOperator cRS, ReduceSin\n         TableDesc keyTable = PlanUtils.getReduceKeyTableDesc(new ArrayList<FieldSchema>(), pRS\n             .getConf().getOrder(), pRS.getConf().getNullOrder());\n         pRS.getConf().setKeySerializeInfo(keyTable);\n+      } else if (cRS.getConf().getKeyCols() != null && cRS.getConf().getKeyCols().size() > 0) {", "originalCommit": "1ac7b0f70e07faa87ce75669d65040f983027a6e", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTg4Mzg2Ng==", "url": "https://github.com/apache/hive/pull/1400#discussion_r479883866", "bodyText": "setNumDistributionKeys is a subset of keycols, We enters this conditions only when NumDistributionKeys of pRS is null or <= 0. Hence checking for pRS doesn't make sense here since we anyhow want to go with cRS.", "author": "shameersss1", "createdAt": "2020-08-31T04:39:40Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTIxNjkxNw=="}], "type": "inlineReview"}, {"oid": "4bf9c6647bdedd15fcedce92508ea447cbbece1d", "url": "https://github.com/apache/hive/commit/4bf9c6647bdedd15fcedce92508ea447cbbece1d", "message": "HIVE-18284: Fix NPE when inserting data with 'distribute by' clause with dynpart sort optimization", "committedDate": "2021-01-18T05:09:58Z", "type": "commit"}, {"oid": "4bf9c6647bdedd15fcedce92508ea447cbbece1d", "url": "https://github.com/apache/hive/commit/4bf9c6647bdedd15fcedce92508ea447cbbece1d", "message": "HIVE-18284: Fix NPE when inserting data with 'distribute by' clause with dynpart sort optimization", "committedDate": "2021-01-18T05:09:58Z", "type": "forcePushed"}, {"oid": "0acbff32030619c982b8961d25ce16e19bce5cd6", "url": "https://github.com/apache/hive/commit/0acbff32030619c982b8961d25ce16e19bce5cd6", "message": "Fix qtest failure", "committedDate": "2021-01-21T08:27:41Z", "type": "commit"}]}