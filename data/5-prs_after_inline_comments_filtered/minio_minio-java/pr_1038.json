{"pr_number": 1038, "pr_title": "add IAM AWS credential provider", "pr_createdAt": "2020-08-14T09:05:56Z", "pr_url": "https://github.com/minio/minio-java/pull/1038", "timeline": [{"oid": "0b9eb617a36de7f82bae4bf8a720fde1291c976b", "url": "https://github.com/minio/minio-java/commit/0b9eb617a36de7f82bae4bf8a720fde1291c976b", "message": "add IAM AWS credential provider", "committedDate": "2020-08-17T10:11:51Z", "type": "forcePushed"}, {"oid": "9cc75802edab935bf2811947ff370c898cf5d9bd", "url": "https://github.com/minio/minio-java/commit/9cc75802edab935bf2811947ff370c898cf5d9bd", "message": "add IAM AWS credential provider", "committedDate": "2020-08-19T09:02:00Z", "type": "forcePushed"}, {"oid": "75aea949b786a7f04610c90d69cecbdd8045fd84", "url": "https://github.com/minio/minio-java/commit/75aea949b786a7f04610c90d69cecbdd8045fd84", "message": "add IAM AWS credential provider", "committedDate": "2020-08-21T11:20:47Z", "type": "forcePushed"}, {"oid": "42e586690415214a1de09ffdc202ab79f06b3066", "url": "https://github.com/minio/minio-java/commit/42e586690415214a1de09ffdc202ab79f06b3066", "message": "add IAM AWS credential provider", "committedDate": "2020-09-03T10:38:26Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NTkzMw==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483575933", "bodyText": "To making this call twice with same argument, we can save the output of thisgetProperty in a variable tokenFile and pass it as argument to getToken", "author": "anjalshireesh", "createdAt": "2020-09-04T12:10:42Z", "path": "api/src/main/java/io/minio/credentials/IamAwsProvider.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import io.minio.messages.ResponseDate;\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Protocol;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html\">IAM roles\n+ * for Amazon EC2</a>.\n+ */\n+public class IamAwsProvider extends EnvironmentProvider {\n+  // Custom endpoint to fetch IAM role credentials.\n+  private final HttpUrl customEndpoint;\n+  private final OkHttpClient httpClient;\n+  private final ObjectMapper mapper;\n+  private Credentials credentials;\n+\n+  public IamAwsProvider(@Nullable String customEndpoint, @Nullable OkHttpClient customHttpClient) {\n+    this.customEndpoint =\n+        (customEndpoint != null)\n+            ? Objects.requireNonNull(HttpUrl.parse(customEndpoint), \"Invalid custom endpoint\")\n+            : null;\n+    // HTTP/1.1 is only supported in default client because of HTTP/2 in OkHttpClient cause 5\n+    // minutes timeout on program exit.\n+    this.httpClient =\n+        (customHttpClient != null)\n+            ? customHttpClient\n+            : new OkHttpClient().newBuilder().protocols(Arrays.asList(Protocol.HTTP_1_1)).build();\n+    this.mapper = new ObjectMapper();\n+    this.mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+    this.mapper.configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);\n+  }\n+\n+  private void checkLoopbackHost(HttpUrl url) {\n+    try {\n+      for (InetAddress addr : InetAddress.getAllByName(url.host())) {\n+        if (!addr.isLoopbackAddress()) {\n+          throw new IllegalArgumentException(url.host() + \" is not loopback only host\");\n+        }\n+      }\n+    } catch (UnknownHostException e) {\n+      throw new IllegalStateException(\"Host in \" + url + \" is not loopback address\");\n+    }\n+  }\n+\n+  private Credentials fetchCredentials(HttpUrl url) {\n+    try (Response response =\n+        httpClient.newCall(new Request.Builder().url(url).method(\"GET\", null).build()).execute()) {\n+      if (!response.isSuccessful()) {\n+        throw new IllegalStateException(url + \" failed with HTTP status code \" + response.code());\n+      }\n+\n+      EcsCredentials creds = mapper.readValue(response.body().charStream(), EcsCredentials.class);\n+      if (!\"Success\".equals(creds.code())) {\n+        throw new IllegalStateException(url + \" failed with message \" + creds.message());\n+      }\n+      return creds.toCredentials();\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Unable to parse response\", e);\n+    }\n+  }\n+\n+  private Jwt getToken() {\n+    String tokenFile = getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\");\n+    try {\n+      byte[] data = Files.readAllBytes(Paths.get(tokenFile));\n+      return new Jwt(new String(data, StandardCharsets.UTF_8), 0);\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Error in reading file \" + tokenFile, e);\n+    }\n+  }\n+\n+  @Override\n+  public synchronized Credentials fetch() {\n+    if (credentials != null && !credentials.isExpired()) {\n+      return credentials;\n+    }\n+\n+    HttpUrl url = this.customEndpoint;\n+    if (getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\") != null) {", "originalCommit": "42e586690415214a1de09ffdc202ab79f06b3066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3NTQzNw==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483675437", "bodyText": "Moved to fetchCredentials(String tokenFile).", "author": "balamurugana", "createdAt": "2020-09-04T15:02:43Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NTkzMw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NjQyMQ==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483576421", "bodyText": "Can be extracted out into a method fetchUsingAwsTokenFile", "author": "anjalshireesh", "createdAt": "2020-09-04T12:11:49Z", "path": "api/src/main/java/io/minio/credentials/IamAwsProvider.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import io.minio.messages.ResponseDate;\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Protocol;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html\">IAM roles\n+ * for Amazon EC2</a>.\n+ */\n+public class IamAwsProvider extends EnvironmentProvider {\n+  // Custom endpoint to fetch IAM role credentials.\n+  private final HttpUrl customEndpoint;\n+  private final OkHttpClient httpClient;\n+  private final ObjectMapper mapper;\n+  private Credentials credentials;\n+\n+  public IamAwsProvider(@Nullable String customEndpoint, @Nullable OkHttpClient customHttpClient) {\n+    this.customEndpoint =\n+        (customEndpoint != null)\n+            ? Objects.requireNonNull(HttpUrl.parse(customEndpoint), \"Invalid custom endpoint\")\n+            : null;\n+    // HTTP/1.1 is only supported in default client because of HTTP/2 in OkHttpClient cause 5\n+    // minutes timeout on program exit.\n+    this.httpClient =\n+        (customHttpClient != null)\n+            ? customHttpClient\n+            : new OkHttpClient().newBuilder().protocols(Arrays.asList(Protocol.HTTP_1_1)).build();\n+    this.mapper = new ObjectMapper();\n+    this.mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+    this.mapper.configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);\n+  }\n+\n+  private void checkLoopbackHost(HttpUrl url) {\n+    try {\n+      for (InetAddress addr : InetAddress.getAllByName(url.host())) {\n+        if (!addr.isLoopbackAddress()) {\n+          throw new IllegalArgumentException(url.host() + \" is not loopback only host\");\n+        }\n+      }\n+    } catch (UnknownHostException e) {\n+      throw new IllegalStateException(\"Host in \" + url + \" is not loopback address\");\n+    }\n+  }\n+\n+  private Credentials fetchCredentials(HttpUrl url) {\n+    try (Response response =\n+        httpClient.newCall(new Request.Builder().url(url).method(\"GET\", null).build()).execute()) {\n+      if (!response.isSuccessful()) {\n+        throw new IllegalStateException(url + \" failed with HTTP status code \" + response.code());\n+      }\n+\n+      EcsCredentials creds = mapper.readValue(response.body().charStream(), EcsCredentials.class);\n+      if (!\"Success\".equals(creds.code())) {\n+        throw new IllegalStateException(url + \" failed with message \" + creds.message());\n+      }\n+      return creds.toCredentials();\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Unable to parse response\", e);\n+    }\n+  }\n+\n+  private Jwt getToken() {\n+    String tokenFile = getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\");\n+    try {\n+      byte[] data = Files.readAllBytes(Paths.get(tokenFile));\n+      return new Jwt(new String(data, StandardCharsets.UTF_8), 0);\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Error in reading file \" + tokenFile, e);\n+    }\n+  }\n+\n+  @Override\n+  public synchronized Credentials fetch() {\n+    if (credentials != null && !credentials.isExpired()) {\n+      return credentials;\n+    }\n+\n+    HttpUrl url = this.customEndpoint;\n+    if (getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\") != null) {\n+      if (url == null) {\n+        String region = getProperty(\"AWS_REGION\");\n+        url =\n+            HttpUrl.parse(\n+                (region == null)\n+                    ? \"https://sts.amazonaws.com\"\n+                    : \"https://sts.\" + region + \".amazonaws.com\");\n+      }\n+\n+      Provider provider =\n+          new WebIdentityProvider(\n+              () -> getToken(),\n+              url.toString(),\n+              null,\n+              null,\n+              getProperty(\"AWS_ROLE_ARN\"),\n+              getProperty(\"AWS_ROLE_SESSION_NAME\"),\n+              httpClient);\n+      credentials = provider.fetch();\n+      return credentials;", "originalCommit": "42e586690415214a1de09ffdc202ab79f06b3066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3NTc4NQ==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483675785", "bodyText": "Moved to fetchCredentials(String tokenFile).", "author": "balamurugana", "createdAt": "2020-09-04T15:03:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3NjQyMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3Njk4Nw==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483576987", "bodyText": "Can be extracted into a method getAwsCredentialsUrl", "author": "anjalshireesh", "createdAt": "2020-09-04T12:13:01Z", "path": "api/src/main/java/io/minio/credentials/IamAwsProvider.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import io.minio.messages.ResponseDate;\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Protocol;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html\">IAM roles\n+ * for Amazon EC2</a>.\n+ */\n+public class IamAwsProvider extends EnvironmentProvider {\n+  // Custom endpoint to fetch IAM role credentials.\n+  private final HttpUrl customEndpoint;\n+  private final OkHttpClient httpClient;\n+  private final ObjectMapper mapper;\n+  private Credentials credentials;\n+\n+  public IamAwsProvider(@Nullable String customEndpoint, @Nullable OkHttpClient customHttpClient) {\n+    this.customEndpoint =\n+        (customEndpoint != null)\n+            ? Objects.requireNonNull(HttpUrl.parse(customEndpoint), \"Invalid custom endpoint\")\n+            : null;\n+    // HTTP/1.1 is only supported in default client because of HTTP/2 in OkHttpClient cause 5\n+    // minutes timeout on program exit.\n+    this.httpClient =\n+        (customHttpClient != null)\n+            ? customHttpClient\n+            : new OkHttpClient().newBuilder().protocols(Arrays.asList(Protocol.HTTP_1_1)).build();\n+    this.mapper = new ObjectMapper();\n+    this.mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+    this.mapper.configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);\n+  }\n+\n+  private void checkLoopbackHost(HttpUrl url) {\n+    try {\n+      for (InetAddress addr : InetAddress.getAllByName(url.host())) {\n+        if (!addr.isLoopbackAddress()) {\n+          throw new IllegalArgumentException(url.host() + \" is not loopback only host\");\n+        }\n+      }\n+    } catch (UnknownHostException e) {\n+      throw new IllegalStateException(\"Host in \" + url + \" is not loopback address\");\n+    }\n+  }\n+\n+  private Credentials fetchCredentials(HttpUrl url) {\n+    try (Response response =\n+        httpClient.newCall(new Request.Builder().url(url).method(\"GET\", null).build()).execute()) {\n+      if (!response.isSuccessful()) {\n+        throw new IllegalStateException(url + \" failed with HTTP status code \" + response.code());\n+      }\n+\n+      EcsCredentials creds = mapper.readValue(response.body().charStream(), EcsCredentials.class);\n+      if (!\"Success\".equals(creds.code())) {\n+        throw new IllegalStateException(url + \" failed with message \" + creds.message());\n+      }\n+      return creds.toCredentials();\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Unable to parse response\", e);\n+    }\n+  }\n+\n+  private Jwt getToken() {\n+    String tokenFile = getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\");\n+    try {\n+      byte[] data = Files.readAllBytes(Paths.get(tokenFile));\n+      return new Jwt(new String(data, StandardCharsets.UTF_8), 0);\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Error in reading file \" + tokenFile, e);\n+    }\n+  }\n+\n+  @Override\n+  public synchronized Credentials fetch() {\n+    if (credentials != null && !credentials.isExpired()) {\n+      return credentials;\n+    }\n+\n+    HttpUrl url = this.customEndpoint;\n+    if (getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\") != null) {\n+      if (url == null) {\n+        String region = getProperty(\"AWS_REGION\");\n+        url =\n+            HttpUrl.parse(\n+                (region == null)\n+                    ? \"https://sts.amazonaws.com\"\n+                    : \"https://sts.\" + region + \".amazonaws.com\");\n+      }\n+\n+      Provider provider =\n+          new WebIdentityProvider(\n+              () -> getToken(),\n+              url.toString(),\n+              null,\n+              null,\n+              getProperty(\"AWS_ROLE_ARN\"),\n+              getProperty(\"AWS_ROLE_SESSION_NAME\"),\n+              httpClient);\n+      credentials = provider.fetch();\n+      return credentials;\n+    }\n+\n+    if (getProperty(\"AWS_CONTAINER_CREDENTIALS_RELATIVE_URI\") != null) {\n+      if (url == null) {\n+        url =\n+            new HttpUrl.Builder()\n+                .scheme(\"http\")\n+                .host(\"169.254.170.2\")\n+                .addPathSegments(getProperty(\"AWS_CONTAINER_CREDENTIALS_RELATIVE_URI\"))\n+                .build();\n+      }\n+    } else if (getProperty(\"AWS_CONTAINER_CREDENTIALS_FULL_URI\") != null) {\n+      if (url == null) {\n+        url = HttpUrl.parse(getProperty(\"AWS_CONTAINER_CREDENTIALS_FULL_URI\"));\n+      }\n+      checkLoopbackHost(url);\n+    } else {\n+      if (url == null) {\n+        url = HttpUrl.parse(\"http://169.254.169.254/latest/meta-data/iam/security-credentials/\");\n+      } else {\n+        url =\n+            new HttpUrl.Builder()\n+                .scheme(url.scheme())\n+                .host(url.host())\n+                .addPathSegments(\"latest/meta-data/iam/security-credentials/\")\n+                .build();\n+      }", "originalCommit": "42e586690415214a1de09ffdc202ab79f06b3066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3NjIyNA==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483676224", "bodyText": "Moved to getIamRoleNamedUrl()", "author": "balamurugana", "createdAt": "2020-09-04T15:04:02Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3Njk4Nw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODA4Mg==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483578082", "bodyText": "Can be extracted into a method getAwsRoleName", "author": "anjalshireesh", "createdAt": "2020-09-04T12:15:28Z", "path": "api/src/main/java/io/minio/credentials/IamAwsProvider.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import io.minio.messages.ResponseDate;\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Protocol;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html\">IAM roles\n+ * for Amazon EC2</a>.\n+ */\n+public class IamAwsProvider extends EnvironmentProvider {\n+  // Custom endpoint to fetch IAM role credentials.\n+  private final HttpUrl customEndpoint;\n+  private final OkHttpClient httpClient;\n+  private final ObjectMapper mapper;\n+  private Credentials credentials;\n+\n+  public IamAwsProvider(@Nullable String customEndpoint, @Nullable OkHttpClient customHttpClient) {\n+    this.customEndpoint =\n+        (customEndpoint != null)\n+            ? Objects.requireNonNull(HttpUrl.parse(customEndpoint), \"Invalid custom endpoint\")\n+            : null;\n+    // HTTP/1.1 is only supported in default client because of HTTP/2 in OkHttpClient cause 5\n+    // minutes timeout on program exit.\n+    this.httpClient =\n+        (customHttpClient != null)\n+            ? customHttpClient\n+            : new OkHttpClient().newBuilder().protocols(Arrays.asList(Protocol.HTTP_1_1)).build();\n+    this.mapper = new ObjectMapper();\n+    this.mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+    this.mapper.configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);\n+  }\n+\n+  private void checkLoopbackHost(HttpUrl url) {\n+    try {\n+      for (InetAddress addr : InetAddress.getAllByName(url.host())) {\n+        if (!addr.isLoopbackAddress()) {\n+          throw new IllegalArgumentException(url.host() + \" is not loopback only host\");\n+        }\n+      }\n+    } catch (UnknownHostException e) {\n+      throw new IllegalStateException(\"Host in \" + url + \" is not loopback address\");\n+    }\n+  }\n+\n+  private Credentials fetchCredentials(HttpUrl url) {\n+    try (Response response =\n+        httpClient.newCall(new Request.Builder().url(url).method(\"GET\", null).build()).execute()) {\n+      if (!response.isSuccessful()) {\n+        throw new IllegalStateException(url + \" failed with HTTP status code \" + response.code());\n+      }\n+\n+      EcsCredentials creds = mapper.readValue(response.body().charStream(), EcsCredentials.class);\n+      if (!\"Success\".equals(creds.code())) {\n+        throw new IllegalStateException(url + \" failed with message \" + creds.message());\n+      }\n+      return creds.toCredentials();\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Unable to parse response\", e);\n+    }\n+  }\n+\n+  private Jwt getToken() {\n+    String tokenFile = getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\");\n+    try {\n+      byte[] data = Files.readAllBytes(Paths.get(tokenFile));\n+      return new Jwt(new String(data, StandardCharsets.UTF_8), 0);\n+    } catch (IOException e) {\n+      throw new IllegalStateException(\"Error in reading file \" + tokenFile, e);\n+    }\n+  }\n+\n+  @Override\n+  public synchronized Credentials fetch() {\n+    if (credentials != null && !credentials.isExpired()) {\n+      return credentials;\n+    }\n+\n+    HttpUrl url = this.customEndpoint;\n+    if (getProperty(\"AWS_WEB_IDENTITY_TOKEN_FILE\") != null) {\n+      if (url == null) {\n+        String region = getProperty(\"AWS_REGION\");\n+        url =\n+            HttpUrl.parse(\n+                (region == null)\n+                    ? \"https://sts.amazonaws.com\"\n+                    : \"https://sts.\" + region + \".amazonaws.com\");\n+      }\n+\n+      Provider provider =\n+          new WebIdentityProvider(\n+              () -> getToken(),\n+              url.toString(),\n+              null,\n+              null,\n+              getProperty(\"AWS_ROLE_ARN\"),\n+              getProperty(\"AWS_ROLE_SESSION_NAME\"),\n+              httpClient);\n+      credentials = provider.fetch();\n+      return credentials;\n+    }\n+\n+    if (getProperty(\"AWS_CONTAINER_CREDENTIALS_RELATIVE_URI\") != null) {\n+      if (url == null) {\n+        url =\n+            new HttpUrl.Builder()\n+                .scheme(\"http\")\n+                .host(\"169.254.170.2\")\n+                .addPathSegments(getProperty(\"AWS_CONTAINER_CREDENTIALS_RELATIVE_URI\"))\n+                .build();\n+      }\n+    } else if (getProperty(\"AWS_CONTAINER_CREDENTIALS_FULL_URI\") != null) {\n+      if (url == null) {\n+        url = HttpUrl.parse(getProperty(\"AWS_CONTAINER_CREDENTIALS_FULL_URI\"));\n+      }\n+      checkLoopbackHost(url);\n+    } else {\n+      if (url == null) {\n+        url = HttpUrl.parse(\"http://169.254.169.254/latest/meta-data/iam/security-credentials/\");\n+      } else {\n+        url =\n+            new HttpUrl.Builder()\n+                .scheme(url.scheme())\n+                .host(url.host())\n+                .addPathSegments(\"latest/meta-data/iam/security-credentials/\")\n+                .build();\n+      }\n+\n+      String[] roleNames = null;\n+      try (Response response =\n+          httpClient\n+              .newCall(new Request.Builder().url(url).method(\"GET\", null).build())\n+              .execute()) {\n+        if (!response.isSuccessful()) {\n+          throw new IllegalStateException(url + \" failed with HTTP status code \" + response.code());\n+        }\n+\n+        roleNames = response.body().string().split(\"\\\\R\");\n+      } catch (IOException e) {\n+        throw new IllegalStateException(\"Unable to parse response\", e);\n+      }\n+\n+      if (roleNames.length == 0) {\n+        throw new IllegalStateException(\"No IAM roles attached to EC2 service \" + url);\n+      }", "originalCommit": "42e586690415214a1de09ffdc202ab79f06b3066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3NjQ4NA==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483676484", "bodyText": "Moved to getIamRoleName()", "author": "balamurugana", "createdAt": "2020-09-04T15:04:33Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3ODA4Mg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3OTA5Nw==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483579097", "bodyText": "Not sure if IllegalArgumentException is the right choice for all the exceptions in this class.", "author": "anjalshireesh", "createdAt": "2020-09-04T12:17:39Z", "path": "api/src/main/java/io/minio/credentials/IamAwsProvider.java", "diffHunk": "@@ -0,0 +1,218 @@\n+/*\n+ * MinIO Java SDK for Amazon S3 Compatible Cloud Storage, (C) 2020 MinIO, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.minio.credentials;\n+\n+import com.fasterxml.jackson.annotation.JsonProperty;\n+import com.fasterxml.jackson.databind.DeserializationFeature;\n+import com.fasterxml.jackson.databind.MapperFeature;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import io.minio.messages.ResponseDate;\n+import java.io.IOException;\n+import java.net.InetAddress;\n+import java.net.UnknownHostException;\n+import java.nio.charset.StandardCharsets;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Arrays;\n+import java.util.Objects;\n+import javax.annotation.Nullable;\n+import okhttp3.HttpUrl;\n+import okhttp3.OkHttpClient;\n+import okhttp3.Protocol;\n+import okhttp3.Request;\n+import okhttp3.Response;\n+\n+/**\n+ * Credential provider using <a\n+ * href=\"http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html\">IAM roles\n+ * for Amazon EC2</a>.\n+ */\n+public class IamAwsProvider extends EnvironmentProvider {\n+  // Custom endpoint to fetch IAM role credentials.\n+  private final HttpUrl customEndpoint;\n+  private final OkHttpClient httpClient;\n+  private final ObjectMapper mapper;\n+  private Credentials credentials;\n+\n+  public IamAwsProvider(@Nullable String customEndpoint, @Nullable OkHttpClient customHttpClient) {\n+    this.customEndpoint =\n+        (customEndpoint != null)\n+            ? Objects.requireNonNull(HttpUrl.parse(customEndpoint), \"Invalid custom endpoint\")\n+            : null;\n+    // HTTP/1.1 is only supported in default client because of HTTP/2 in OkHttpClient cause 5\n+    // minutes timeout on program exit.\n+    this.httpClient =\n+        (customHttpClient != null)\n+            ? customHttpClient\n+            : new OkHttpClient().newBuilder().protocols(Arrays.asList(Protocol.HTTP_1_1)).build();\n+    this.mapper = new ObjectMapper();\n+    this.mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);\n+    this.mapper.configure(MapperFeature.ACCEPT_CASE_INSENSITIVE_PROPERTIES, true);\n+  }\n+\n+  private void checkLoopbackHost(HttpUrl url) {\n+    try {\n+      for (InetAddress addr : InetAddress.getAllByName(url.host())) {\n+        if (!addr.isLoopbackAddress()) {\n+          throw new IllegalArgumentException(url.host() + \" is not loopback only host\");", "originalCommit": "42e586690415214a1de09ffdc202ab79f06b3066", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3NTAwNg==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483675006", "bodyText": "Using IllegalStateException() now.", "author": "balamurugana", "createdAt": "2020-09-04T15:02:00Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3OTA5Nw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY3ODI2NQ==", "url": "https://github.com/minio/minio-java/pull/1038#discussion_r483678265", "bodyText": "Sorry I wrote this comment at the wrong place with the wrong exception name! I meant to say that I'm not sure if IllegalStateException makes sense for most of the exceptions in the class..", "author": "anjalshireesh", "createdAt": "2020-09-04T15:07:47Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzU3OTA5Nw=="}], "type": "inlineReview"}, {"oid": "c53a11b917300b835de5d64df7a4f17bd11c5366", "url": "https://github.com/minio/minio-java/commit/c53a11b917300b835de5d64df7a4f17bd11c5366", "message": "add IAM AWS credential provider", "committedDate": "2020-09-06T16:07:19Z", "type": "commit"}, {"oid": "dbab92569a2f3733973086967eee12ae5de6908c", "url": "https://github.com/minio/minio-java/commit/dbab92569a2f3733973086967eee12ae5de6908c", "message": "address review comments", "committedDate": "2020-09-06T16:07:30Z", "type": "commit"}, {"oid": "2f3cd92e13b8b885307ff9a0854b615d4201633a", "url": "https://github.com/minio/minio-java/commit/2f3cd92e13b8b885307ff9a0854b615d4201633a", "message": "Use ProviderException instead of IllegalStateException", "committedDate": "2020-09-06T16:09:48Z", "type": "forcePushed"}, {"oid": "3454c1dbbd7f441b83bb80724a1a0ae6216aabcd", "url": "https://github.com/minio/minio-java/commit/3454c1dbbd7f441b83bb80724a1a0ae6216aabcd", "message": "Use ProviderException instead of IllegalStateException", "committedDate": "2020-09-06T16:20:53Z", "type": "commit"}, {"oid": "3454c1dbbd7f441b83bb80724a1a0ae6216aabcd", "url": "https://github.com/minio/minio-java/commit/3454c1dbbd7f441b83bb80724a1a0ae6216aabcd", "message": "Use ProviderException instead of IllegalStateException", "committedDate": "2020-09-06T16:20:53Z", "type": "forcePushed"}]}