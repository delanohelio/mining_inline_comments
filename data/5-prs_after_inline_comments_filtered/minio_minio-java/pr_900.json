{"pr_number": 900, "pr_title": "handle accelerate and dual-stack aws endpoints", "pr_createdAt": "2020-04-13T07:17:49Z", "pr_url": "https://github.com/minio/minio-java/pull/900", "timeline": [{"oid": "eb37d7fd0ea3ea7e55d8dc78fc6dd0d1207a7cdc", "url": "https://github.com/minio/minio-java/commit/eb37d7fd0ea3ea7e55d8dc78fc6dd0d1207a7cdc", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893, #894, #895, #897, #899", "committedDate": "2020-04-13T07:18:35Z", "type": "forcePushed"}, {"oid": "4f5d3353cf2058f3d0bd9f625bdb4af3ce50be5b", "url": "https://github.com/minio/minio-java/commit/4f5d3353cf2058f3d0bd9f625bdb4af3ce50be5b", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893, #894, #895, #897, #899", "committedDate": "2020-04-13T08:22:10Z", "type": "forcePushed"}, {"oid": "c2df96786887fe9c68a85105219b28713cd6ac21", "url": "https://github.com/minio/minio-java/commit/c2df96786887fe9c68a85105219b28713cd6ac21", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893, #894, #895, #897, #899", "committedDate": "2020-04-13T08:59:07Z", "type": "forcePushed"}, {"oid": "44347308c3b36e8bec9ac9473ac1910d1d8e73a3", "url": "https://github.com/minio/minio-java/commit/44347308c3b36e8bec9ac9473ac1910d1d8e73a3", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893, #894, #895, #897, #899", "committedDate": "2020-04-13T10:30:43Z", "type": "forcePushed"}, {"oid": "d5d14fcfa9bab615878fcac04f9940e2b1be9d60", "url": "https://github.com/minio/minio-java/commit/d5d14fcfa9bab615878fcac04f9940e2b1be9d60", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893, #894, #895, #897, #899", "committedDate": "2020-04-13T10:42:33Z", "type": "forcePushed"}, {"oid": "4291b770b1c0205c6ffa2f50d7c2a5e90b1680db", "url": "https://github.com/minio/minio-java/commit/4291b770b1c0205c6ffa2f50d7c2a5e90b1680db", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893, #894, #895, #897, #899", "committedDate": "2020-04-13T10:54:42Z", "type": "forcePushed"}, {"oid": "870891d18ec331eeec3c31b18edb6b0ccd9e84b9", "url": "https://github.com/minio/minio-java/commit/870891d18ec331eeec3c31b18edb6b0ccd9e84b9", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893, #894, #895, #897, #899", "committedDate": "2020-04-13T11:57:13Z", "type": "forcePushed"}, {"oid": "4b013507e3565b1b8527bdb740cda9d4cc353231", "url": "https://github.com/minio/minio-java/commit/4b013507e3565b1b8527bdb740cda9d4cc353231", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-04-13T12:04:32Z", "type": "forcePushed"}, {"oid": "a42417e2e6188ee2c52405f3c12d352e068ac303", "url": "https://github.com/minio/minio-java/commit/a42417e2e6188ee2c52405f3c12d352e068ac303", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-04-13T12:08:18Z", "type": "forcePushed"}, {"oid": "1fff8432b18a859c4a5a63e086924f400de12fe5", "url": "https://github.com/minio/minio-java/commit/1fff8432b18a859c4a5a63e086924f400de12fe5", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-04-14T14:08:29Z", "type": "forcePushed"}, {"oid": "ee90822fcf90e703a2cf5892fe3022075a22c83d", "url": "https://github.com/minio/minio-java/commit/ee90822fcf90e703a2cf5892fe3022075a22c83d", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-04-21T14:20:56Z", "type": "forcePushed"}, {"oid": "b889b8e149342df6b0678cb41a577bb6166a7107", "url": "https://github.com/minio/minio-java/commit/b889b8e149342df6b0678cb41a577bb6166a7107", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-04-21T15:09:59Z", "type": "forcePushed"}, {"oid": "b2e971bef64dc72b04879a410d9e2b97edef30d1", "url": "https://github.com/minio/minio-java/commit/b2e971bef64dc72b04879a410d9e2b97edef30d1", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-04-27T11:19:08Z", "type": "forcePushed"}, {"oid": "b84ca9841e52e8911c17a1c3cd107941e3ac028d", "url": "https://github.com/minio/minio-java/commit/b84ca9841e52e8911c17a1c3cd107941e3ac028d", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-02T04:49:40Z", "type": "forcePushed"}, {"oid": "c8cd33f21e8641b0ce1bd20746a87c4acb8c1fd7", "url": "https://github.com/minio/minio-java/commit/c8cd33f21e8641b0ce1bd20746a87c4acb8c1fd7", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-06T08:08:43Z", "type": "forcePushed"}, {"oid": "ce1251d02b18e405d0949a992cd7290aac46f2e7", "url": "https://github.com/minio/minio-java/commit/ce1251d02b18e405d0949a992cd7290aac46f2e7", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-13T18:40:03Z", "type": "forcePushed"}, {"oid": "f496927ff3a237d051ce6333778b12962775f575", "url": "https://github.com/minio/minio-java/commit/f496927ff3a237d051ce6333778b12962775f575", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-13T18:43:34Z", "type": "forcePushed"}, {"oid": "ba3a6ac6ab16d461acf54ec9af881da1a8606b17", "url": "https://github.com/minio/minio-java/commit/ba3a6ac6ab16d461acf54ec9af881da1a8606b17", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-19T14:58:43Z", "type": "forcePushed"}, {"oid": "4204167b5794f9dbe1db504b778cf338b4c4d9a9", "url": "https://github.com/minio/minio-java/commit/4204167b5794f9dbe1db504b778cf338b4c4d9a9", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-19T16:24:23Z", "type": "forcePushed"}, {"oid": "82d33665d1b8077ed79df85f95ae03357808f6ad", "url": "https://github.com/minio/minio-java/commit/82d33665d1b8077ed79df85f95ae03357808f6ad", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-19T16:28:45Z", "type": "forcePushed"}, {"oid": "0770de1e11c6444a8a69a64b0b931fed97593db4", "url": "https://github.com/minio/minio-java/commit/0770de1e11c6444a8a69a64b0b931fed97593db4", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-19T16:37:43Z", "type": "forcePushed"}, {"oid": "92862cf6114e275328664f30b75031b1a7fd6f87", "url": "https://github.com/minio/minio-java/commit/92862cf6114e275328664f30b75031b1a7fd6f87", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-19T16:48:56Z", "type": "forcePushed"}, {"oid": "4b71244433cc9f7c45a2e01a419fa06739a0a728", "url": "https://github.com/minio/minio-java/commit/4b71244433cc9f7c45a2e01a419fa06739a0a728", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-21T08:34:46Z", "type": "forcePushed"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYwNjk2Mw==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428606963", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                return (endpoint.startsWith(\"s3.\") || endpoint.startsWith(\"s3-accelerate.\"))\n          \n          \n            \n                return (endpoint.startsWith(\"s3.\") || isAwsAccelerateEndpoint(endpoint))", "author": "anjalshireesh", "createdAt": "2020-05-21T11:54:38Z", "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -734,53 +779,38 @@ public MinioClient(\n           throw new RuntimeException(e);\n         }\n       }\n+    } else {\n+      this.httpClient = httpClient;\n     }\n+  }\n \n-    HttpUrl url = HttpUrl.parse(endpoint);\n-    if (url != null) {\n-      if (!\"/\".equals(url.encodedPath())) {\n-        throw new InvalidEndpointException(endpoint, \"no path allowed in endpoint\");\n-      }\n-\n-      HttpUrl.Builder urlBuilder = url.newBuilder();\n-      Scheme scheme = Scheme.HTTP;\n-      if (secure) {\n-        scheme = Scheme.HTTPS;\n-      }\n-\n-      urlBuilder.scheme(scheme.toString());\n+  private static boolean isAwsEndpoint(String endpoint) {\n+    return (endpoint.startsWith(\"s3.\") || endpoint.startsWith(\"s3-accelerate.\"))", "originalCommit": "4b71244433cc9f7c45a2e01a419fa06739a0a728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYyMjYxNw==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428622617", "bodyText": "done", "author": "balamurugana", "createdAt": "2020-05-21T12:31:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYwNjk2Mw=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYwODkxOA==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428608918", "bodyText": "Please add some method level comments explaining the logic, preferably with an example.\nDoes this apply only in case of dualstack endpoint?", "author": "anjalshireesh", "createdAt": "2020-05-21T11:59:36Z", "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -734,53 +779,38 @@ public MinioClient(\n           throw new RuntimeException(e);\n         }\n       }\n+    } else {\n+      this.httpClient = httpClient;\n     }\n+  }\n \n-    HttpUrl url = HttpUrl.parse(endpoint);\n-    if (url != null) {\n-      if (!\"/\".equals(url.encodedPath())) {\n-        throw new InvalidEndpointException(endpoint, \"no path allowed in endpoint\");\n-      }\n-\n-      HttpUrl.Builder urlBuilder = url.newBuilder();\n-      Scheme scheme = Scheme.HTTP;\n-      if (secure) {\n-        scheme = Scheme.HTTPS;\n-      }\n-\n-      urlBuilder.scheme(scheme.toString());\n+  private static boolean isAwsEndpoint(String endpoint) {\n+    return (endpoint.startsWith(\"s3.\") || endpoint.startsWith(\"s3-accelerate.\"))\n+        && (endpoint.endsWith(\".amazonaws.com\") || endpoint.endsWith(\".amazonaws.com.cn\"));\n+  }\n \n-      if (port > 0) {\n-        urlBuilder.port(port);\n-      }\n+  private static boolean isAwsAccelerateEndpoint(String endpoint) {\n+    return endpoint.startsWith(\"s3-accelerate.\");\n+  }\n \n-      this.baseUrl = urlBuilder.build();\n-      this.accessKey = accessKey;\n-      this.secretKey = secretKey;\n-      this.region = region;\n+  private static boolean isAwsDualStackEndpoint(String endpoint) {\n+    return endpoint.contains(\".dualstack.\");\n+  }\n \n-      return;\n-    }\n+  private static String extractRegion(String endpoint) {", "originalCommit": "4b71244433cc9f7c45a2e01a419fa06739a0a728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNzA5Ng==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428637096", "bodyText": "Done\nNo. A regular AWS endpoints may contain region.", "author": "balamurugana", "createdAt": "2020-05-21T13:02:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYwODkxOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxMDUyNg==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428610526", "bodyText": "This method (buildUrl) seems too big. It might be a good idea to refactor it and make it smaller.\nFor the AWS specific logic in this method, maybe introduce a new class called AwsUrlBuilder and use it from here?", "author": "anjalshireesh", "createdAt": "2020-05-21T12:03:40Z", "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -947,55 +977,77 @@ private HttpUrl buildUrl(\n       Multimap<String, String> queryParamMap)\n       throws IllegalArgumentException, InvalidBucketNameException, NoSuchAlgorithmException {\n     if (bucketName == null && objectName != null) {\n-      throw new InvalidBucketNameException(\n-          NULL_STRING, \"null bucket name for object '\" + objectName + \"'\");\n+      throw new IllegalArgumentException(\"null bucket name for object '\" + objectName + \"'\");", "originalCommit": "4b71244433cc9f7c45a2e01a419fa06739a0a728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzOTA0OA==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428639048", "bodyText": "I think this can be done when we bring builder pattern to constructor", "author": "balamurugana", "createdAt": "2020-05-21T13:06:34Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxMDUyNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxMTM1Ng==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428611356", "bodyText": "This comment is probably more appropriate just before the line\nAwsRegionCache.INSTANCE.set(bucketName, region);", "author": "anjalshireesh", "createdAt": "2020-05-21T12:05:47Z", "path": "api/src/main/java/io/minio/MinioClient.java", "diffHunk": "@@ -1317,50 +1373,43 @@ private Response execute(\n         method, bucketName, objectName, region, headerMultiMap, queryParamMultiMap, body, length);\n   }\n \n-  /** Updates Region cache for given bucket. */\n-  private void updateRegionCache(String bucketName)\n+  /** Returns region of given bucket either from region cache or set in constructor. */\n+  private String getRegion(String bucketName)\n       throws ErrorResponseException, IllegalArgumentException, InsufficientDataException,\n           InternalException, InvalidBucketNameException, InvalidKeyException,\n           InvalidResponseException, IOException, NoSuchAlgorithmException, XmlParserException {\n-    if (bucketName != null\n-        && this.accessKey != null\n-        && this.secretKey != null\n-        && !BucketRegionCache.INSTANCE.exists(bucketName)) {\n-      Map<String, String> queryParamMap = new HashMap<>();\n-      queryParamMap.put(\"location\", null);\n-\n-      Response response =\n-          execute(Method.GET, bucketName, null, US_EAST_1, null, queryParamMap, null, 0);\n-\n-      String region;\n-      try (ResponseBody body = response.body()) {\n-        LocationConstraint lc = Xml.unmarshal(LocationConstraint.class, body.charStream());\n-        if (lc.location() == null || lc.location().equals(\"\")) {\n-          region = US_EAST_1; // default region\n-        } else if (lc.location().equals(\"EU\")) {\n-          region = \"eu-west-1\"; // eu-west-1 can be sometimes 'EU'.\n-        } else {\n-          region = lc.location();\n-        }\n-      }\n+    if (this.region != null && !this.region.equals(\"\")) {\n+      return this.region;\n+    }\n \n-      // Add the new location.\n-      BucketRegionCache.INSTANCE.set(bucketName, region);\n+    if (!isAwsHost || bucketName == null || this.accessKey == null) {\n+      return US_EAST_1;\n     }\n-  }\n \n-  /** Returns region of given bucket either from region cache or set in constructor. */\n-  private String getRegion(String bucketName)\n-      throws ErrorResponseException, IllegalArgumentException, InsufficientDataException,\n-          InternalException, InvalidBucketNameException, InvalidKeyException,\n-          InvalidResponseException, IOException, NoSuchAlgorithmException, XmlParserException {\n-    String region;\n-    if (this.region == null || \"\".equals(this.region)) {\n-      updateRegionCache(bucketName);\n-      region = BucketRegionCache.INSTANCE.region(bucketName);\n-    } else {\n-      region = this.region;\n+    String region = AwsRegionCache.INSTANCE.get(bucketName);\n+    if (region != null) {\n+      return region;\n+    }\n+\n+    // Updates region cache for this bucket.", "originalCommit": "4b71244433cc9f7c45a2e01a419fa06739a0a728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0MDU5NQ==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428640595", "bodyText": "I changed the comment to // Execute GetBucketLocation REST API to get region of the bucket. for specific meaning.", "author": "balamurugana", "createdAt": "2020-05-21T13:09:45Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxMTM1Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxMTc1Nw==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428611757", "bodyText": "The above comment also needs to change accordingly?", "author": "anjalshireesh", "createdAt": "2020-05-21T12:06:44Z", "path": "functional/FunctionalTest.java", "diffHunk": "@@ -4345,7 +4345,7 @@ public static void runTests() throws Exception {\n \n     // SSE_S3 and SSE_KMS only work with endpoint=\"s3.amazonaws.com\"\n     String requestUrl = endpoint;\n-    if (requestUrl.equals(\"s3.amazonaws.com\")) {\n+    if (requestUrl.contains(\".amazonaws.com\")) {", "originalCommit": "4b71244433cc9f7c45a2e01a419fa06739a0a728", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODY0MTc0NQ==", "url": "https://github.com/minio/minio-java/pull/900#discussion_r428641745", "bodyText": "Done", "author": "balamurugana", "createdAt": "2020-05-21T13:11:57Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYxMTc1Nw=="}], "type": "inlineReview"}, {"oid": "341153bc8c30bc666ce84a01021dbcf4184a1d6a", "url": "https://github.com/minio/minio-java/commit/341153bc8c30bc666ce84a01021dbcf4184a1d6a", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-21T13:13:26Z", "type": "commit"}, {"oid": "341153bc8c30bc666ce84a01021dbcf4184a1d6a", "url": "https://github.com/minio/minio-java/commit/341153bc8c30bc666ce84a01021dbcf4184a1d6a", "message": "handle accelerate and dual-stack aws endpoints\n\nFixes #893\nFixes #894\nFixes #895\nFixes #897\nFixes #899", "committedDate": "2020-05-21T13:13:26Z", "type": "forcePushed"}]}