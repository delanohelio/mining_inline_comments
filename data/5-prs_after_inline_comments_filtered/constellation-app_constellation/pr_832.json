{"pr_number": 832, "pr_title": "Bugfix/issue189 copy to new graph", "pr_createdAt": "2020-09-01T22:07:19Z", "pr_url": "https://github.com/constellation-app/constellation/pull/832", "timeline": [{"oid": "fc5a0f9357ede340481466ff4a6645a0b8980766", "url": "https://github.com/constellation-app/constellation/commit/fc5a0f9357ede340481466ff4a6645a0b8980766", "message": "Added functions to handle copy to nw files", "committedDate": "2020-08-21T17:42:08Z", "type": "commit"}, {"oid": "364292cb5e7d94c2aa08d15a143ba733737bb501", "url": "https://github.com/constellation-app/constellation/commit/364292cb5e7d94c2aa08d15a143ba733737bb501", "message": "Merge remote-tracking branch 'upstream/master' into issue189_copy_to_new_graph", "committedDate": "2020-08-21T17:45:29Z", "type": "commit"}, {"oid": "584f1feeb4ee560b851a9af692a5396875b4322e", "url": "https://github.com/constellation-app/constellation/commit/584f1feeb4ee560b851a9af692a5396875b4322e", "message": "Moved the regex pattern into the function as expect this to not be the used\nvery often so saving on space. Can move this back to a static if this is \ndeemed to be a better choice.", "committedDate": "2020-08-22T09:48:23Z", "type": "commit"}, {"oid": "b3d428f99e5e190f671cd72a9d927b3aa49f59f6", "url": "https://github.com/constellation-app/constellation/commit/b3d428f99e5e190f671cd72a9d927b3aa49f59f6", "message": "Code formatting", "committedDate": "2020-08-22T10:00:05Z", "type": "commit"}, {"oid": "c036a6eeb5db127139eb69fd1f33683a20541a76", "url": "https://github.com/constellation-app/constellation/commit/c036a6eeb5db127139eb69fd1f33683a20541a76", "message": "Merge remote-tracking branch 'upstream/master' into bugfix/issue189_copy_to_new_graph", "committedDate": "2020-09-01T19:08:07Z", "type": "commit"}, {"oid": "afac24c30ab2db181567b36af8e5fac0411ad99b", "url": "https://github.com/constellation-app/constellation/commit/afac24c30ab2db181567b36af8e5fac0411ad99b", "message": "Fixing some logic errors and adding some unit tests", "committedDate": "2020-09-01T22:02:37Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU0NzA5Ng==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481547096", "bodyText": "Since the constructor is private, I would move the instantiation of this constant to the declaration in line 54.\nTo the constructor, I would then add throw new IllegalStateException(\"Utility class\")", "author": "antares1470", "createdAt": "2020-09-02T01:59:05Z", "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -29,11 +36,28 @@\n  */\n public class GraphObjectUtilities {\n \n+    private static final GraphObjectUtilities graphObjectUtilities = new GraphObjectUtilities();\n+\n+    private GraphObjectUtilities() {\n+        //Adding private to remove code smell\n+        COPY_NAME_MATCHER = Pattern.compile(COPY_STRING_PATTERN);", "originalCommit": "afac24c30ab2db181567b36af8e5fac0411ad99b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3ODc4OQ==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r483778789", "bodyText": "I changed the COPY_NAME_MATCHER to static and removed the now empty constructor", "author": "GCHQDeveloper601", "createdAt": "2020-09-04T18:11:35Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU0NzA5Ng=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1NjA4OA==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481556088", "bodyText": "Based on what I could see from the usage, I think it would be better to make relevant functions and variables being called static rather than creating a static instance of the class within itself (doing a bit of testing, it seems to work the same).", "author": "antares1470", "createdAt": "2020-09-02T02:13:36Z", "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -29,11 +36,28 @@\n  */\n public class GraphObjectUtilities {\n \n+    private static final GraphObjectUtilities graphObjectUtilities = new GraphObjectUtilities();", "originalCommit": "afac24c30ab2db181567b36af8e5fac0411ad99b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3OTA4NA==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r483779084", "bodyText": "Changed the other methods to static so this isn't needed.", "author": "GCHQDeveloper601", "createdAt": "2020-09-04T18:12:11Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1NjA4OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1OTAwNg==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481559006", "bodyText": "if you move the instantiation of COPY_NAME_MATCHER out of the constructor, you should be able to uncomment this line and remove the line above it (you'll probably need to make COPY_NAME_MATCHER  static)", "author": "antares1470", "createdAt": "2020-09-02T02:18:23Z", "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -61,15 +85,54 @@\n      */\n     public static GraphDataObject createMemoryDataObject(final String name, final boolean numbered) {\n         GraphDataObject gdo = null;\n+        final FileObject root = FILE_SYSTEM.getRoot();\n         try {\n-            final String fnam = numbered ? String.format(\"%s%d%s\", name, ++fileCounter, GraphDataObject.FILE_EXTENSION) : String.format(\"%s%s\", name, GraphDataObject.FILE_EXTENSION);\n-            final FileObject root = FILE_SYSTEM.getRoot();\n+            String fnam = graphObjectUtilities.getNewFileName(name, numbered, root);\n+            while (graphObjectUtilities.isFileNameDuplicateInMemory(fnam, root)) {\n+                //If after all of the above the filename already exists in memory, start again.\n+                fnam = graphObjectUtilities.getNewFileName(fnam, numbered, root);\n+            }\n+            while (fnam.length() >= FILENAME_LENGTH_LIMIT) {\n+                fnam = (String) JOptionPane.showInputDialog(null,\n+                        CHOOSE_FILENAME,\n+                        FILENAME_TITLE,\n+                        JOptionPane.INFORMATION_MESSAGE,\n+                        null,\n+                        null,\n+                        fnam);\n+            }\n+            fnam = String.format(\"%s%s\", fnam, GraphDataObject.FILE_EXTENSION);\n             final FileObject fo = FileUtil.createData(root, fnam);\n             gdo = (GraphDataObject) DataObject.find(fo);\n         } catch (IOException ex) {\n             Exceptions.printStackTrace(ex);\n         }\n-\n         return gdo;\n     }\n+\n+    private String getNewFileName(final String name, final boolean numbered, final FileObject root) {\n+        final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(name)).collect(Collectors.toList());\n+        if (files.size() > 0) {\n+            if (name.endsWith(COPY_STRING)) {\n+                return String.format(\"%s (%d)\", name, 1);\n+            }\n+\n+            final Matcher matcher = Pattern.compile(COPY_STRING_PATTERN).matcher(name);\n+            //final Matcher matcher =  COPY_NAME_MATCHER.matcher(name);", "originalCommit": "afac24c30ab2db181567b36af8e5fac0411ad99b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3OTM3Nw==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r483779377", "bodyText": "My bad, I already had it compiled. Bad debug left in the code. Removed :)", "author": "GCHQDeveloper601", "createdAt": "2020-09-04T18:12:50Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1OTAwNg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1OTQwMw==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r481559403", "bodyText": "Change this to !files.isEmpty(). Should also be able to omit the brackets", "author": "antares1470", "createdAt": "2020-09-02T02:19:01Z", "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -61,15 +85,54 @@\n      */\n     public static GraphDataObject createMemoryDataObject(final String name, final boolean numbered) {\n         GraphDataObject gdo = null;\n+        final FileObject root = FILE_SYSTEM.getRoot();\n         try {\n-            final String fnam = numbered ? String.format(\"%s%d%s\", name, ++fileCounter, GraphDataObject.FILE_EXTENSION) : String.format(\"%s%s\", name, GraphDataObject.FILE_EXTENSION);\n-            final FileObject root = FILE_SYSTEM.getRoot();\n+            String fnam = graphObjectUtilities.getNewFileName(name, numbered, root);\n+            while (graphObjectUtilities.isFileNameDuplicateInMemory(fnam, root)) {\n+                //If after all of the above the filename already exists in memory, start again.\n+                fnam = graphObjectUtilities.getNewFileName(fnam, numbered, root);\n+            }\n+            while (fnam.length() >= FILENAME_LENGTH_LIMIT) {\n+                fnam = (String) JOptionPane.showInputDialog(null,\n+                        CHOOSE_FILENAME,\n+                        FILENAME_TITLE,\n+                        JOptionPane.INFORMATION_MESSAGE,\n+                        null,\n+                        null,\n+                        fnam);\n+            }\n+            fnam = String.format(\"%s%s\", fnam, GraphDataObject.FILE_EXTENSION);\n             final FileObject fo = FileUtil.createData(root, fnam);\n             gdo = (GraphDataObject) DataObject.find(fo);\n         } catch (IOException ex) {\n             Exceptions.printStackTrace(ex);\n         }\n-\n         return gdo;\n     }\n+\n+    private String getNewFileName(final String name, final boolean numbered, final FileObject root) {\n+        final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(name)).collect(Collectors.toList());\n+        if (files.size() > 0) {\n+            if (name.endsWith(COPY_STRING)) {\n+                return String.format(\"%s (%d)\", name, 1);\n+            }\n+\n+            final Matcher matcher = Pattern.compile(COPY_STRING_PATTERN).matcher(name);\n+            //final Matcher matcher =  COPY_NAME_MATCHER.matcher(name);\n+            if (matcher.matches()) {\n+                final String fileNamePart = matcher.group(1);\n+                final int copyNum = Integer.parseInt(matcher.group(2));\n+                return String.format(\"%s (%d)\", fileNamePart, copyNum + 1);\n+            }\n+            return String.format(\"%s - Copy\", name);\n+        }\n+        return numbered ? String.format(\"%s%d\", name, ++fileCounter) : String.format(\"%s\", name);\n+    }\n+\n+    private boolean isFileNameDuplicateInMemory(final String name, final FileObject root) {\n+\n+        final String tempName = FilenameUtils.getBaseName(name);\n+        final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(tempName)).collect(Collectors.toList());\n+        return (files.size() > 0);", "originalCommit": "afac24c30ab2db181567b36af8e5fac0411ad99b", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3OTQxNA==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r483779414", "bodyText": "Done", "author": "GCHQDeveloper601", "createdAt": "2020-09-04T18:12:56Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTU1OTQwMw=="}], "type": "inlineReview"}, {"oid": "886c73ba4558e2e0c95913107202dd23f2334d6a", "url": "https://github.com/constellation-app/constellation/commit/886c73ba4558e2e0c95913107202dd23f2334d6a", "message": "Adding changes to reflect the comments", "committedDate": "2020-09-04T18:09:20Z", "type": "commit"}, {"oid": "81de89a9d099c6eafca43197363d16d800f43204", "url": "https://github.com/constellation-app/constellation/commit/81de89a9d099c6eafca43197363d16d800f43204", "message": "Removing empty contructor", "committedDate": "2020-09-04T18:10:56Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEyMjI2OQ==", "url": "https://github.com/constellation-app/constellation/pull/832#discussion_r484122269", "bodyText": "will want !files.isEmpty() here", "author": "antares1470", "createdAt": "2020-09-06T22:41:35Z", "path": "CoreGraphFile/src/au/gov/asd/tac/constellation/graph/file/GraphObjectUtilities.java", "diffHunk": "@@ -129,10 +121,10 @@ private String getNewFileName(final String name, final boolean numbered, final F\n         return numbered ? String.format(\"%s%d\", name, ++fileCounter) : String.format(\"%s\", name);\n     }\n \n-    private boolean isFileNameDuplicateInMemory(final String name, final FileObject root) {\n+    private static boolean isFileNameDuplicateInMemory(final String name, final FileObject root) {\n \n         final String tempName = FilenameUtils.getBaseName(name);\n         final List<FileObject> files = Arrays.stream(root.getChildren()).filter(file -> file.getName().equals(tempName)).collect(Collectors.toList());\n-        return (files.size() > 0);\n+        return files.isEmpty();", "originalCommit": "81de89a9d099c6eafca43197363d16d800f43204", "replyToReviewId": null, "replies": null, "type": "inlineReview"}, {"oid": "29f76620c12aa702fcea342493c0239a0733c4cc", "url": "https://github.com/constellation-app/constellation/commit/29f76620c12aa702fcea342493c0239a0733c4cc", "message": "Reversed Boolean check to give correct response for empty files", "committedDate": "2020-09-09T20:36:25Z", "type": "commit"}, {"oid": "48881e3220c2715db6e3e29b044b78a6839d2fea", "url": "https://github.com/constellation-app/constellation/commit/48881e3220c2715db6e3e29b044b78a6839d2fea", "message": "Merge branch 'master' of github.com:constellation-app/constellation into bugfix/issue189_copy_to_new_graph", "committedDate": "2020-09-09T20:37:57Z", "type": "commit"}]}