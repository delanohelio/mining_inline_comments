{"pr_number": 564, "pr_title": "Automate Project Updater (#344)", "pr_createdAt": "2020-06-04T19:00:17Z", "pr_url": "https://github.com/constellation-app/constellation/pull/564", "timeline": [{"oid": "c0313e964fd157d22c9c92e57333e1e7aa2f70f7", "url": "https://github.com/constellation-app/constellation/commit/c0313e964fd157d22c9c92e57333e1e7aa2f70f7", "message": ":green_heart: Automate managing dependencies\n* Added `ProjectUpdater` which will manage adding dependencies to the `project.xml` file.", "committedDate": "2020-05-28T05:32:39Z", "type": "commit"}, {"oid": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "url": "https://github.com/constellation-app/constellation/commit/474155ebc8632250fc8eec25d1bdf606aa1f66c9", "message": ":green_heart: Update to Project Updater\n* Added a fix to META-INF appearing sometimes in the package section\n* Added finals", "committedDate": "2020-06-04T06:46:12Z", "type": "commit"}, {"oid": "7ded7c4b27b45c1623379816697dbdc1722917d5", "url": "https://github.com/constellation-app/constellation/commit/7ded7c4b27b45c1623379816697dbdc1722917d5", "message": ":green_heart: Fix to unwanted package", "committedDate": "2020-06-05T03:56:42Z", "type": "commit"}, {"oid": "98a1ad31c884a12fcb8edf52323b0e1fdf3a213a", "url": "https://github.com/constellation-app/constellation/commit/98a1ad31c884a12fcb8edf52323b0e1fdf3a213a", "message": "Merge branch 'feature/project-updater' of https://github.com/constellation-app/constellation into feature/project-updater", "committedDate": "2020-06-05T04:10:36Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODMzNQ==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435678335", "bodyText": "final", "author": "antares1470", "createdAt": "2020-06-05T04:04:04Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;\n+\n+// IMPORTANT! You need to compile this class against ant.jar.\n+// The easiest way to do this is to add ${ant.core.lib} to your project's classpath.\n+// For example, for a plain Java project with no other dependencies, set in project.properties:\n+// javac.classpath=${ant.core.lib}\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipInputStream;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.apache.tools.ant.BuildException;\n+import org.apache.tools.ant.Task;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+\n+/**\n+ * Rewrite the project.xml file with the latest dependencies\n+ *\n+ * @author sirius\n+ * @author arcturus\n+ */\n+public class ProjectUpdater extends Task {\n+\n+    private File projectDirectory = null;\n+\n+    public void setProjectdirectory(File projectDirectory) {\n+        this.projectDirectory = projectDirectory;\n+    }\n+\n+    @Override\n+    public void execute() throws BuildException {\n+        try {\n+            logMessage(\"Updating wrapped jars for \" + projectDirectory);\n+\n+            final File projectFile = new File(projectDirectory, \"nbproject/project.xml\");\n+            final File oldProjectFile = new File(projectDirectory, \"nbproject/project_old.xml\");\n+            final File jarDirectory = new File(projectDirectory, \"release/modules/ext\");\n+            final File publicPackagesFile = new File(projectDirectory, \"/src/public.xml\");\n+\n+            // Create a document to work on\n+            final Document document = readXMLFile(projectFile);\n+\n+            // Find the data element and ensure there is only one\n+            final NodeList dataNodes = document.getElementsByTagName(\"data\");\n+            if (dataNodes.getLength() != 1) {\n+                throw new IllegalStateException(\"Not a valid project.xml file\");\n+            }\n+            final Node dataNode = dataNodes.item(0);\n+\n+            final List<String> packages = new ArrayList<>();\n+            final Set<String> publicPackages = new TreeSet<>();\n+            Node publicPackagesNode = null;\n+            if (publicPackagesFile.exists()) {\n+                final NodeList publicPackagesNodes = document.getElementsByTagName(\"public-packages\");\n+                if (publicPackagesNodes.getLength() != 1) {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+                publicPackagesNode = publicPackagesNodes.item(0);\n+\n+                final NodeList children = publicPackagesNode.getChildNodes();\n+                while (children.getLength() > 0) {\n+                    final Node child = children.item(0);\n+                    if (child instanceof Element) {\n+                        final Element childElement = (Element) child;\n+                        if (childElement.getTagName().equals(\"package\")) {\n+                            publicPackages.add(childElement.getTextContent());\n+                        }\n+                    }\n+                    publicPackagesNode.removeChild(child);\n+                }\n+\n+                final Document publicXMLFile = readXMLFile(publicPackagesFile);\n+                final NodeList packageNodes = publicXMLFile.getElementsByTagName(\"package\");\n+                for (int i = 0; i < packageNodes.getLength(); i++) {\n+                    packages.add(packageNodes.item(i).getTextContent());\n+                }\n+            }\n+\n+            // Remove all the class-path-extension elements\n+            // Ensure that each is a child of the data element\n+            // Remore all white space around the elements\n+            final NodeList classPathExtensionNodes = document.getElementsByTagName(\"class-path-extension\");\n+            while (classPathExtensionNodes.getLength() > 0) {\n+                final Node classPathExtensionNode = classPathExtensionNodes.item(0);\n+                if (classPathExtensionNode.getParentNode() == dataNode) {\n+                    Node nextNode = classPathExtensionNode.getNextSibling();\n+                    while (nextNode instanceof Text) {\n+                        Node textNode = nextNode;", "originalCommit": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4ODY2NQ==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435688665", "bodyText": "added", "author": "arcturus2", "createdAt": "2020-06-05T04:51:39Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODMzNQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODQ0MA==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435678440", "bodyText": "final", "author": "antares1470", "createdAt": "2020-06-05T04:04:39Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;\n+\n+// IMPORTANT! You need to compile this class against ant.jar.\n+// The easiest way to do this is to add ${ant.core.lib} to your project's classpath.\n+// For example, for a plain Java project with no other dependencies, set in project.properties:\n+// javac.classpath=${ant.core.lib}\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipInputStream;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.apache.tools.ant.BuildException;\n+import org.apache.tools.ant.Task;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+\n+/**\n+ * Rewrite the project.xml file with the latest dependencies\n+ *\n+ * @author sirius\n+ * @author arcturus\n+ */\n+public class ProjectUpdater extends Task {\n+\n+    private File projectDirectory = null;\n+\n+    public void setProjectdirectory(File projectDirectory) {\n+        this.projectDirectory = projectDirectory;\n+    }\n+\n+    @Override\n+    public void execute() throws BuildException {\n+        try {\n+            logMessage(\"Updating wrapped jars for \" + projectDirectory);\n+\n+            final File projectFile = new File(projectDirectory, \"nbproject/project.xml\");\n+            final File oldProjectFile = new File(projectDirectory, \"nbproject/project_old.xml\");\n+            final File jarDirectory = new File(projectDirectory, \"release/modules/ext\");\n+            final File publicPackagesFile = new File(projectDirectory, \"/src/public.xml\");\n+\n+            // Create a document to work on\n+            final Document document = readXMLFile(projectFile);\n+\n+            // Find the data element and ensure there is only one\n+            final NodeList dataNodes = document.getElementsByTagName(\"data\");\n+            if (dataNodes.getLength() != 1) {\n+                throw new IllegalStateException(\"Not a valid project.xml file\");\n+            }\n+            final Node dataNode = dataNodes.item(0);\n+\n+            final List<String> packages = new ArrayList<>();\n+            final Set<String> publicPackages = new TreeSet<>();\n+            Node publicPackagesNode = null;\n+            if (publicPackagesFile.exists()) {\n+                final NodeList publicPackagesNodes = document.getElementsByTagName(\"public-packages\");\n+                if (publicPackagesNodes.getLength() != 1) {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+                publicPackagesNode = publicPackagesNodes.item(0);\n+\n+                final NodeList children = publicPackagesNode.getChildNodes();\n+                while (children.getLength() > 0) {\n+                    final Node child = children.item(0);\n+                    if (child instanceof Element) {\n+                        final Element childElement = (Element) child;\n+                        if (childElement.getTagName().equals(\"package\")) {\n+                            publicPackages.add(childElement.getTextContent());\n+                        }\n+                    }\n+                    publicPackagesNode.removeChild(child);\n+                }\n+\n+                final Document publicXMLFile = readXMLFile(publicPackagesFile);\n+                final NodeList packageNodes = publicXMLFile.getElementsByTagName(\"package\");\n+                for (int i = 0; i < packageNodes.getLength(); i++) {\n+                    packages.add(packageNodes.item(i).getTextContent());\n+                }\n+            }\n+\n+            // Remove all the class-path-extension elements\n+            // Ensure that each is a child of the data element\n+            // Remore all white space around the elements\n+            final NodeList classPathExtensionNodes = document.getElementsByTagName(\"class-path-extension\");\n+            while (classPathExtensionNodes.getLength() > 0) {\n+                final Node classPathExtensionNode = classPathExtensionNodes.item(0);\n+                if (classPathExtensionNode.getParentNode() == dataNode) {\n+                    Node nextNode = classPathExtensionNode.getNextSibling();\n+                    while (nextNode instanceof Text) {\n+                        Node textNode = nextNode;\n+                        nextNode = nextNode.getNextSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    Node prevNode = classPathExtensionNode.getPreviousSibling();\n+                    while (prevNode instanceof Text) {\n+                        Node textNode = prevNode;", "originalCommit": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4ODY4NQ==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435688685", "bodyText": "added", "author": "arcturus2", "createdAt": "2020-06-05T04:51:44Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODQ0MA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODYyOA==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435678628", "bodyText": "final", "author": "antares1470", "createdAt": "2020-06-05T04:05:22Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;\n+\n+// IMPORTANT! You need to compile this class against ant.jar.\n+// The easiest way to do this is to add ${ant.core.lib} to your project's classpath.\n+// For example, for a plain Java project with no other dependencies, set in project.properties:\n+// javac.classpath=${ant.core.lib}\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipInputStream;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.apache.tools.ant.BuildException;\n+import org.apache.tools.ant.Task;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+\n+/**\n+ * Rewrite the project.xml file with the latest dependencies\n+ *\n+ * @author sirius\n+ * @author arcturus\n+ */\n+public class ProjectUpdater extends Task {\n+\n+    private File projectDirectory = null;\n+\n+    public void setProjectdirectory(File projectDirectory) {\n+        this.projectDirectory = projectDirectory;\n+    }\n+\n+    @Override\n+    public void execute() throws BuildException {\n+        try {\n+            logMessage(\"Updating wrapped jars for \" + projectDirectory);\n+\n+            final File projectFile = new File(projectDirectory, \"nbproject/project.xml\");\n+            final File oldProjectFile = new File(projectDirectory, \"nbproject/project_old.xml\");\n+            final File jarDirectory = new File(projectDirectory, \"release/modules/ext\");\n+            final File publicPackagesFile = new File(projectDirectory, \"/src/public.xml\");\n+\n+            // Create a document to work on\n+            final Document document = readXMLFile(projectFile);\n+\n+            // Find the data element and ensure there is only one\n+            final NodeList dataNodes = document.getElementsByTagName(\"data\");\n+            if (dataNodes.getLength() != 1) {\n+                throw new IllegalStateException(\"Not a valid project.xml file\");\n+            }\n+            final Node dataNode = dataNodes.item(0);\n+\n+            final List<String> packages = new ArrayList<>();\n+            final Set<String> publicPackages = new TreeSet<>();\n+            Node publicPackagesNode = null;\n+            if (publicPackagesFile.exists()) {\n+                final NodeList publicPackagesNodes = document.getElementsByTagName(\"public-packages\");\n+                if (publicPackagesNodes.getLength() != 1) {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+                publicPackagesNode = publicPackagesNodes.item(0);\n+\n+                final NodeList children = publicPackagesNode.getChildNodes();\n+                while (children.getLength() > 0) {\n+                    final Node child = children.item(0);\n+                    if (child instanceof Element) {\n+                        final Element childElement = (Element) child;\n+                        if (childElement.getTagName().equals(\"package\")) {\n+                            publicPackages.add(childElement.getTextContent());\n+                        }\n+                    }\n+                    publicPackagesNode.removeChild(child);\n+                }\n+\n+                final Document publicXMLFile = readXMLFile(publicPackagesFile);\n+                final NodeList packageNodes = publicXMLFile.getElementsByTagName(\"package\");\n+                for (int i = 0; i < packageNodes.getLength(); i++) {\n+                    packages.add(packageNodes.item(i).getTextContent());\n+                }\n+            }\n+\n+            // Remove all the class-path-extension elements\n+            // Ensure that each is a child of the data element\n+            // Remore all white space around the elements\n+            final NodeList classPathExtensionNodes = document.getElementsByTagName(\"class-path-extension\");\n+            while (classPathExtensionNodes.getLength() > 0) {\n+                final Node classPathExtensionNode = classPathExtensionNodes.item(0);\n+                if (classPathExtensionNode.getParentNode() == dataNode) {\n+                    Node nextNode = classPathExtensionNode.getNextSibling();\n+                    while (nextNode instanceof Text) {\n+                        Node textNode = nextNode;\n+                        nextNode = nextNode.getNextSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    Node prevNode = classPathExtensionNode.getPreviousSibling();\n+                    while (prevNode instanceof Text) {\n+                        Node textNode = prevNode;\n+                        prevNode = prevNode.getPreviousSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    dataNode.removeChild(classPathExtensionNode);\n+                } else {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+            }\n+\n+            // Restore each jar file to the project.xml\n+            // If the jar directory does not exist then assume no wrapped jars\n+            // Ensure each file is a JAR file\n+            // Add white space to make it look the same as the Netbeans version\n+            if (jarDirectory.exists()) {\n+                for (File jarFile : jarDirectory.listFiles()) {\n+                    if (jarFile.getName().endsWith(\".jar\")) {\n+                        logMessage(\"\\tIncluding jar file: \" + jarFile.getName());\n+                        addClassPathExtension(document, jarFile, dataNode);\n+\n+                        if (publicPackagesFile.exists()) {\n+                            extractMatchingPackages(jarFile, packages, publicPackages);\n+                        }\n+                    } else {\n+                        throw new IllegalStateException(\"Not a JAR file: \" + jarFile.getAbsolutePath());\n+                    }\n+                }\n+\n+                dataNode.appendChild(document.createTextNode(\"\\n        \"));\n+            }\n+\n+            if (publicPackagesFile.exists()) {\n+                for (String publicPackage : publicPackages) {\n+                    if (!publicPackage.startsWith(\"META-INF\")) {\n+                        Element publicPackageElement = document.createElement(\"package\");", "originalCommit": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4ODY5OQ==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435688699", "bodyText": "added", "author": "arcturus2", "createdAt": "2020-06-05T04:51:49Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3ODYyOA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTQyMg==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435679422", "bodyText": "Is there a more specific set of exceptions that can be caught in this instance? (Can't tell just glancing at the code whether the generic exception needs to be caught or not)", "author": "antares1470", "createdAt": "2020-06-05T04:08:59Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;\n+\n+// IMPORTANT! You need to compile this class against ant.jar.\n+// The easiest way to do this is to add ${ant.core.lib} to your project's classpath.\n+// For example, for a plain Java project with no other dependencies, set in project.properties:\n+// javac.classpath=${ant.core.lib}\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipInputStream;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.apache.tools.ant.BuildException;\n+import org.apache.tools.ant.Task;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+\n+/**\n+ * Rewrite the project.xml file with the latest dependencies\n+ *\n+ * @author sirius\n+ * @author arcturus\n+ */\n+public class ProjectUpdater extends Task {\n+\n+    private File projectDirectory = null;\n+\n+    public void setProjectdirectory(File projectDirectory) {\n+        this.projectDirectory = projectDirectory;\n+    }\n+\n+    @Override\n+    public void execute() throws BuildException {\n+        try {\n+            logMessage(\"Updating wrapped jars for \" + projectDirectory);\n+\n+            final File projectFile = new File(projectDirectory, \"nbproject/project.xml\");\n+            final File oldProjectFile = new File(projectDirectory, \"nbproject/project_old.xml\");\n+            final File jarDirectory = new File(projectDirectory, \"release/modules/ext\");\n+            final File publicPackagesFile = new File(projectDirectory, \"/src/public.xml\");\n+\n+            // Create a document to work on\n+            final Document document = readXMLFile(projectFile);\n+\n+            // Find the data element and ensure there is only one\n+            final NodeList dataNodes = document.getElementsByTagName(\"data\");\n+            if (dataNodes.getLength() != 1) {\n+                throw new IllegalStateException(\"Not a valid project.xml file\");\n+            }\n+            final Node dataNode = dataNodes.item(0);\n+\n+            final List<String> packages = new ArrayList<>();\n+            final Set<String> publicPackages = new TreeSet<>();\n+            Node publicPackagesNode = null;\n+            if (publicPackagesFile.exists()) {\n+                final NodeList publicPackagesNodes = document.getElementsByTagName(\"public-packages\");\n+                if (publicPackagesNodes.getLength() != 1) {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+                publicPackagesNode = publicPackagesNodes.item(0);\n+\n+                final NodeList children = publicPackagesNode.getChildNodes();\n+                while (children.getLength() > 0) {\n+                    final Node child = children.item(0);\n+                    if (child instanceof Element) {\n+                        final Element childElement = (Element) child;\n+                        if (childElement.getTagName().equals(\"package\")) {\n+                            publicPackages.add(childElement.getTextContent());\n+                        }\n+                    }\n+                    publicPackagesNode.removeChild(child);\n+                }\n+\n+                final Document publicXMLFile = readXMLFile(publicPackagesFile);\n+                final NodeList packageNodes = publicXMLFile.getElementsByTagName(\"package\");\n+                for (int i = 0; i < packageNodes.getLength(); i++) {\n+                    packages.add(packageNodes.item(i).getTextContent());\n+                }\n+            }\n+\n+            // Remove all the class-path-extension elements\n+            // Ensure that each is a child of the data element\n+            // Remore all white space around the elements\n+            final NodeList classPathExtensionNodes = document.getElementsByTagName(\"class-path-extension\");\n+            while (classPathExtensionNodes.getLength() > 0) {\n+                final Node classPathExtensionNode = classPathExtensionNodes.item(0);\n+                if (classPathExtensionNode.getParentNode() == dataNode) {\n+                    Node nextNode = classPathExtensionNode.getNextSibling();\n+                    while (nextNode instanceof Text) {\n+                        Node textNode = nextNode;\n+                        nextNode = nextNode.getNextSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    Node prevNode = classPathExtensionNode.getPreviousSibling();\n+                    while (prevNode instanceof Text) {\n+                        Node textNode = prevNode;\n+                        prevNode = prevNode.getPreviousSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    dataNode.removeChild(classPathExtensionNode);\n+                } else {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+            }\n+\n+            // Restore each jar file to the project.xml\n+            // If the jar directory does not exist then assume no wrapped jars\n+            // Ensure each file is a JAR file\n+            // Add white space to make it look the same as the Netbeans version\n+            if (jarDirectory.exists()) {\n+                for (File jarFile : jarDirectory.listFiles()) {\n+                    if (jarFile.getName().endsWith(\".jar\")) {\n+                        logMessage(\"\\tIncluding jar file: \" + jarFile.getName());\n+                        addClassPathExtension(document, jarFile, dataNode);\n+\n+                        if (publicPackagesFile.exists()) {\n+                            extractMatchingPackages(jarFile, packages, publicPackages);\n+                        }\n+                    } else {\n+                        throw new IllegalStateException(\"Not a JAR file: \" + jarFile.getAbsolutePath());\n+                    }\n+                }\n+\n+                dataNode.appendChild(document.createTextNode(\"\\n        \"));\n+            }\n+\n+            if (publicPackagesFile.exists()) {\n+                for (String publicPackage : publicPackages) {\n+                    if (!publicPackage.startsWith(\"META-INF\")) {\n+                        Element publicPackageElement = document.createElement(\"package\");\n+                        publicPackageElement.setTextContent(publicPackage);\n+                        publicPackagesNode.appendChild(document.createTextNode(\"\\n                \"));\n+                        publicPackagesNode.appendChild(publicPackageElement);\n+                    }\n+                }\n+            }\n+            if (publicPackagesNode != null) {\n+                publicPackagesNode.appendChild(document.createTextNode(\"\\n            \"));\n+            }\n+\n+            // Delete the existing old file and replace it with a copy of the current project.xml\n+            oldProjectFile.delete();\n+            projectFile.renameTo(oldProjectFile);\n+\n+            // Save the edited document to project.xml\n+            saveXMLFile(document, projectFile);\n+        } catch (Exception ex) {", "originalCommit": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4OTI1OQ==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435689259", "bodyText": "The way this is written the generic exception works out the best (because there are too many possible exceptions). It will also pick up run time errors this way. Cool?", "author": "arcturus2", "createdAt": "2020-06-05T04:54:17Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTQyMg=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTU0OA==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435679548", "bodyText": "the above can be final", "author": "antares1470", "createdAt": "2020-06-05T04:09:32Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;\n+\n+// IMPORTANT! You need to compile this class against ant.jar.\n+// The easiest way to do this is to add ${ant.core.lib} to your project's classpath.\n+// For example, for a plain Java project with no other dependencies, set in project.properties:\n+// javac.classpath=${ant.core.lib}\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipInputStream;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.apache.tools.ant.BuildException;\n+import org.apache.tools.ant.Task;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+\n+/**\n+ * Rewrite the project.xml file with the latest dependencies\n+ *\n+ * @author sirius\n+ * @author arcturus\n+ */\n+public class ProjectUpdater extends Task {\n+\n+    private File projectDirectory = null;\n+\n+    public void setProjectdirectory(File projectDirectory) {\n+        this.projectDirectory = projectDirectory;\n+    }\n+\n+    @Override\n+    public void execute() throws BuildException {\n+        try {\n+            logMessage(\"Updating wrapped jars for \" + projectDirectory);\n+\n+            final File projectFile = new File(projectDirectory, \"nbproject/project.xml\");\n+            final File oldProjectFile = new File(projectDirectory, \"nbproject/project_old.xml\");\n+            final File jarDirectory = new File(projectDirectory, \"release/modules/ext\");\n+            final File publicPackagesFile = new File(projectDirectory, \"/src/public.xml\");\n+\n+            // Create a document to work on\n+            final Document document = readXMLFile(projectFile);\n+\n+            // Find the data element and ensure there is only one\n+            final NodeList dataNodes = document.getElementsByTagName(\"data\");\n+            if (dataNodes.getLength() != 1) {\n+                throw new IllegalStateException(\"Not a valid project.xml file\");\n+            }\n+            final Node dataNode = dataNodes.item(0);\n+\n+            final List<String> packages = new ArrayList<>();\n+            final Set<String> publicPackages = new TreeSet<>();\n+            Node publicPackagesNode = null;\n+            if (publicPackagesFile.exists()) {\n+                final NodeList publicPackagesNodes = document.getElementsByTagName(\"public-packages\");\n+                if (publicPackagesNodes.getLength() != 1) {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+                publicPackagesNode = publicPackagesNodes.item(0);\n+\n+                final NodeList children = publicPackagesNode.getChildNodes();\n+                while (children.getLength() > 0) {\n+                    final Node child = children.item(0);\n+                    if (child instanceof Element) {\n+                        final Element childElement = (Element) child;\n+                        if (childElement.getTagName().equals(\"package\")) {\n+                            publicPackages.add(childElement.getTextContent());\n+                        }\n+                    }\n+                    publicPackagesNode.removeChild(child);\n+                }\n+\n+                final Document publicXMLFile = readXMLFile(publicPackagesFile);\n+                final NodeList packageNodes = publicXMLFile.getElementsByTagName(\"package\");\n+                for (int i = 0; i < packageNodes.getLength(); i++) {\n+                    packages.add(packageNodes.item(i).getTextContent());\n+                }\n+            }\n+\n+            // Remove all the class-path-extension elements\n+            // Ensure that each is a child of the data element\n+            // Remore all white space around the elements\n+            final NodeList classPathExtensionNodes = document.getElementsByTagName(\"class-path-extension\");\n+            while (classPathExtensionNodes.getLength() > 0) {\n+                final Node classPathExtensionNode = classPathExtensionNodes.item(0);\n+                if (classPathExtensionNode.getParentNode() == dataNode) {\n+                    Node nextNode = classPathExtensionNode.getNextSibling();\n+                    while (nextNode instanceof Text) {\n+                        Node textNode = nextNode;\n+                        nextNode = nextNode.getNextSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    Node prevNode = classPathExtensionNode.getPreviousSibling();\n+                    while (prevNode instanceof Text) {\n+                        Node textNode = prevNode;\n+                        prevNode = prevNode.getPreviousSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    dataNode.removeChild(classPathExtensionNode);\n+                } else {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+            }\n+\n+            // Restore each jar file to the project.xml\n+            // If the jar directory does not exist then assume no wrapped jars\n+            // Ensure each file is a JAR file\n+            // Add white space to make it look the same as the Netbeans version\n+            if (jarDirectory.exists()) {\n+                for (File jarFile : jarDirectory.listFiles()) {\n+                    if (jarFile.getName().endsWith(\".jar\")) {\n+                        logMessage(\"\\tIncluding jar file: \" + jarFile.getName());\n+                        addClassPathExtension(document, jarFile, dataNode);\n+\n+                        if (publicPackagesFile.exists()) {\n+                            extractMatchingPackages(jarFile, packages, publicPackages);\n+                        }\n+                    } else {\n+                        throw new IllegalStateException(\"Not a JAR file: \" + jarFile.getAbsolutePath());\n+                    }\n+                }\n+\n+                dataNode.appendChild(document.createTextNode(\"\\n        \"));\n+            }\n+\n+            if (publicPackagesFile.exists()) {\n+                for (String publicPackage : publicPackages) {\n+                    if (!publicPackage.startsWith(\"META-INF\")) {\n+                        Element publicPackageElement = document.createElement(\"package\");\n+                        publicPackageElement.setTextContent(publicPackage);\n+                        publicPackagesNode.appendChild(document.createTextNode(\"\\n                \"));\n+                        publicPackagesNode.appendChild(publicPackageElement);\n+                    }\n+                }\n+            }\n+            if (publicPackagesNode != null) {\n+                publicPackagesNode.appendChild(document.createTextNode(\"\\n            \"));\n+            }\n+\n+            // Delete the existing old file and replace it with a copy of the current project.xml\n+            oldProjectFile.delete();\n+            projectFile.renameTo(oldProjectFile);\n+\n+            // Save the edited document to project.xml\n+            saveXMLFile(document, projectFile);\n+        } catch (Exception ex) {\n+            logMessage(\"Exception during update: \" + ex.getClass() + \" \" + ex.getMessage() + \" \" + ex.getStackTrace()[0]);\n+        }\n+    }\n+\n+    private static void addClassPathExtension(Document document, File jarFile, Node parentNode) {\n+        final Element classPathExtensionElement = document.createElement(\"class-path-extension\");\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n                \"));\n+\n+        final Element runtimeRelativePathElement = document.createElement(\"runtime-relative-path\");\n+        runtimeRelativePathElement.setTextContent(\"ext/\" + jarFile.getName());\n+        classPathExtensionElement.appendChild(runtimeRelativePathElement);\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n                \"));\n+\n+        final Element binaryOriginElement = document.createElement(\"binary-origin\");\n+        binaryOriginElement.setTextContent(\"release/modules/ext/\" + jarFile.getName());\n+        classPathExtensionElement.appendChild(binaryOriginElement);\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n            \"));\n+\n+        parentNode.appendChild(document.createTextNode(\"\\n            \"));\n+        parentNode.appendChild(classPathExtensionElement);\n+    }\n+\n+    private static Document readXMLFile(File xmlFile) throws Exception {\n+        final DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+        final Transformer transformer = TransformerFactory.newInstance().newTransformer();\n+\n+        // Create a document to work on\n+        final Document document = builder.newDocument();\n+\n+        // Read in the existing project.xml into the document\n+        try (FileInputStream in = new FileInputStream(xmlFile)) {\n+            Source loadSource = new StreamSource(in);\n+            Result loadResult = new DOMResult(document);", "originalCommit": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4OTI5Mg==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435689292", "bodyText": "added", "author": "arcturus2", "createdAt": "2020-06-05T04:54:25Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTU0OA=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTcxMQ==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435679711", "bodyText": "the above can be final", "author": "antares1470", "createdAt": "2020-06-05T04:10:14Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;\n+\n+// IMPORTANT! You need to compile this class against ant.jar.\n+// The easiest way to do this is to add ${ant.core.lib} to your project's classpath.\n+// For example, for a plain Java project with no other dependencies, set in project.properties:\n+// javac.classpath=${ant.core.lib}\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipInputStream;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.apache.tools.ant.BuildException;\n+import org.apache.tools.ant.Task;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+\n+/**\n+ * Rewrite the project.xml file with the latest dependencies\n+ *\n+ * @author sirius\n+ * @author arcturus\n+ */\n+public class ProjectUpdater extends Task {\n+\n+    private File projectDirectory = null;\n+\n+    public void setProjectdirectory(File projectDirectory) {\n+        this.projectDirectory = projectDirectory;\n+    }\n+\n+    @Override\n+    public void execute() throws BuildException {\n+        try {\n+            logMessage(\"Updating wrapped jars for \" + projectDirectory);\n+\n+            final File projectFile = new File(projectDirectory, \"nbproject/project.xml\");\n+            final File oldProjectFile = new File(projectDirectory, \"nbproject/project_old.xml\");\n+            final File jarDirectory = new File(projectDirectory, \"release/modules/ext\");\n+            final File publicPackagesFile = new File(projectDirectory, \"/src/public.xml\");\n+\n+            // Create a document to work on\n+            final Document document = readXMLFile(projectFile);\n+\n+            // Find the data element and ensure there is only one\n+            final NodeList dataNodes = document.getElementsByTagName(\"data\");\n+            if (dataNodes.getLength() != 1) {\n+                throw new IllegalStateException(\"Not a valid project.xml file\");\n+            }\n+            final Node dataNode = dataNodes.item(0);\n+\n+            final List<String> packages = new ArrayList<>();\n+            final Set<String> publicPackages = new TreeSet<>();\n+            Node publicPackagesNode = null;\n+            if (publicPackagesFile.exists()) {\n+                final NodeList publicPackagesNodes = document.getElementsByTagName(\"public-packages\");\n+                if (publicPackagesNodes.getLength() != 1) {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+                publicPackagesNode = publicPackagesNodes.item(0);\n+\n+                final NodeList children = publicPackagesNode.getChildNodes();\n+                while (children.getLength() > 0) {\n+                    final Node child = children.item(0);\n+                    if (child instanceof Element) {\n+                        final Element childElement = (Element) child;\n+                        if (childElement.getTagName().equals(\"package\")) {\n+                            publicPackages.add(childElement.getTextContent());\n+                        }\n+                    }\n+                    publicPackagesNode.removeChild(child);\n+                }\n+\n+                final Document publicXMLFile = readXMLFile(publicPackagesFile);\n+                final NodeList packageNodes = publicXMLFile.getElementsByTagName(\"package\");\n+                for (int i = 0; i < packageNodes.getLength(); i++) {\n+                    packages.add(packageNodes.item(i).getTextContent());\n+                }\n+            }\n+\n+            // Remove all the class-path-extension elements\n+            // Ensure that each is a child of the data element\n+            // Remore all white space around the elements\n+            final NodeList classPathExtensionNodes = document.getElementsByTagName(\"class-path-extension\");\n+            while (classPathExtensionNodes.getLength() > 0) {\n+                final Node classPathExtensionNode = classPathExtensionNodes.item(0);\n+                if (classPathExtensionNode.getParentNode() == dataNode) {\n+                    Node nextNode = classPathExtensionNode.getNextSibling();\n+                    while (nextNode instanceof Text) {\n+                        Node textNode = nextNode;\n+                        nextNode = nextNode.getNextSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    Node prevNode = classPathExtensionNode.getPreviousSibling();\n+                    while (prevNode instanceof Text) {\n+                        Node textNode = prevNode;\n+                        prevNode = prevNode.getPreviousSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    dataNode.removeChild(classPathExtensionNode);\n+                } else {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+            }\n+\n+            // Restore each jar file to the project.xml\n+            // If the jar directory does not exist then assume no wrapped jars\n+            // Ensure each file is a JAR file\n+            // Add white space to make it look the same as the Netbeans version\n+            if (jarDirectory.exists()) {\n+                for (File jarFile : jarDirectory.listFiles()) {\n+                    if (jarFile.getName().endsWith(\".jar\")) {\n+                        logMessage(\"\\tIncluding jar file: \" + jarFile.getName());\n+                        addClassPathExtension(document, jarFile, dataNode);\n+\n+                        if (publicPackagesFile.exists()) {\n+                            extractMatchingPackages(jarFile, packages, publicPackages);\n+                        }\n+                    } else {\n+                        throw new IllegalStateException(\"Not a JAR file: \" + jarFile.getAbsolutePath());\n+                    }\n+                }\n+\n+                dataNode.appendChild(document.createTextNode(\"\\n        \"));\n+            }\n+\n+            if (publicPackagesFile.exists()) {\n+                for (String publicPackage : publicPackages) {\n+                    if (!publicPackage.startsWith(\"META-INF\")) {\n+                        Element publicPackageElement = document.createElement(\"package\");\n+                        publicPackageElement.setTextContent(publicPackage);\n+                        publicPackagesNode.appendChild(document.createTextNode(\"\\n                \"));\n+                        publicPackagesNode.appendChild(publicPackageElement);\n+                    }\n+                }\n+            }\n+            if (publicPackagesNode != null) {\n+                publicPackagesNode.appendChild(document.createTextNode(\"\\n            \"));\n+            }\n+\n+            // Delete the existing old file and replace it with a copy of the current project.xml\n+            oldProjectFile.delete();\n+            projectFile.renameTo(oldProjectFile);\n+\n+            // Save the edited document to project.xml\n+            saveXMLFile(document, projectFile);\n+        } catch (Exception ex) {\n+            logMessage(\"Exception during update: \" + ex.getClass() + \" \" + ex.getMessage() + \" \" + ex.getStackTrace()[0]);\n+        }\n+    }\n+\n+    private static void addClassPathExtension(Document document, File jarFile, Node parentNode) {\n+        final Element classPathExtensionElement = document.createElement(\"class-path-extension\");\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n                \"));\n+\n+        final Element runtimeRelativePathElement = document.createElement(\"runtime-relative-path\");\n+        runtimeRelativePathElement.setTextContent(\"ext/\" + jarFile.getName());\n+        classPathExtensionElement.appendChild(runtimeRelativePathElement);\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n                \"));\n+\n+        final Element binaryOriginElement = document.createElement(\"binary-origin\");\n+        binaryOriginElement.setTextContent(\"release/modules/ext/\" + jarFile.getName());\n+        classPathExtensionElement.appendChild(binaryOriginElement);\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n            \"));\n+\n+        parentNode.appendChild(document.createTextNode(\"\\n            \"));\n+        parentNode.appendChild(classPathExtensionElement);\n+    }\n+\n+    private static Document readXMLFile(File xmlFile) throws Exception {\n+        final DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+        final Transformer transformer = TransformerFactory.newInstance().newTransformer();\n+\n+        // Create a document to work on\n+        final Document document = builder.newDocument();\n+\n+        // Read in the existing project.xml into the document\n+        try (FileInputStream in = new FileInputStream(xmlFile)) {\n+            Source loadSource = new StreamSource(in);\n+            Result loadResult = new DOMResult(document);\n+            transformer.transform(loadSource, loadResult);\n+        }\n+\n+        return document;\n+    }\n+\n+    private static void saveXMLFile(Document document, File xmlFile) throws Exception {\n+        final Transformer transformer = TransformerFactory.newInstance().newTransformer();\n+\n+        try (FileOutputStream out = new FileOutputStream(xmlFile)) {\n+            Source saveSource = new DOMSource(document);\n+            Result saveResult = new StreamResult(out);", "originalCommit": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4OTMxMw==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435689313", "bodyText": "added", "author": "arcturus2", "createdAt": "2020-06-05T04:54:32Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTcxMQ=="}], "type": "inlineReview"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTg4Nw==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435679887", "bodyText": "final", "author": "antares1470", "createdAt": "2020-06-05T04:10:59Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,267 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;\n+\n+// IMPORTANT! You need to compile this class against ant.jar.\n+// The easiest way to do this is to add ${ant.core.lib} to your project's classpath.\n+// For example, for a plain Java project with no other dependencies, set in project.properties:\n+// javac.classpath=${ant.core.lib}\n+import java.io.File;\n+import java.io.FileInputStream;\n+import java.io.FileOutputStream;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.TreeSet;\n+import java.util.zip.ZipEntry;\n+import java.util.zip.ZipInputStream;\n+import javax.xml.parsers.DocumentBuilder;\n+import javax.xml.parsers.DocumentBuilderFactory;\n+import javax.xml.transform.Result;\n+import javax.xml.transform.Source;\n+import javax.xml.transform.Transformer;\n+import javax.xml.transform.TransformerFactory;\n+import javax.xml.transform.dom.DOMResult;\n+import javax.xml.transform.dom.DOMSource;\n+import javax.xml.transform.stream.StreamResult;\n+import javax.xml.transform.stream.StreamSource;\n+import org.apache.tools.ant.BuildException;\n+import org.apache.tools.ant.Task;\n+import org.w3c.dom.Document;\n+import org.w3c.dom.Element;\n+import org.w3c.dom.Node;\n+import org.w3c.dom.NodeList;\n+import org.w3c.dom.Text;\n+\n+/**\n+ * Rewrite the project.xml file with the latest dependencies\n+ *\n+ * @author sirius\n+ * @author arcturus\n+ */\n+public class ProjectUpdater extends Task {\n+\n+    private File projectDirectory = null;\n+\n+    public void setProjectdirectory(File projectDirectory) {\n+        this.projectDirectory = projectDirectory;\n+    }\n+\n+    @Override\n+    public void execute() throws BuildException {\n+        try {\n+            logMessage(\"Updating wrapped jars for \" + projectDirectory);\n+\n+            final File projectFile = new File(projectDirectory, \"nbproject/project.xml\");\n+            final File oldProjectFile = new File(projectDirectory, \"nbproject/project_old.xml\");\n+            final File jarDirectory = new File(projectDirectory, \"release/modules/ext\");\n+            final File publicPackagesFile = new File(projectDirectory, \"/src/public.xml\");\n+\n+            // Create a document to work on\n+            final Document document = readXMLFile(projectFile);\n+\n+            // Find the data element and ensure there is only one\n+            final NodeList dataNodes = document.getElementsByTagName(\"data\");\n+            if (dataNodes.getLength() != 1) {\n+                throw new IllegalStateException(\"Not a valid project.xml file\");\n+            }\n+            final Node dataNode = dataNodes.item(0);\n+\n+            final List<String> packages = new ArrayList<>();\n+            final Set<String> publicPackages = new TreeSet<>();\n+            Node publicPackagesNode = null;\n+            if (publicPackagesFile.exists()) {\n+                final NodeList publicPackagesNodes = document.getElementsByTagName(\"public-packages\");\n+                if (publicPackagesNodes.getLength() != 1) {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+                publicPackagesNode = publicPackagesNodes.item(0);\n+\n+                final NodeList children = publicPackagesNode.getChildNodes();\n+                while (children.getLength() > 0) {\n+                    final Node child = children.item(0);\n+                    if (child instanceof Element) {\n+                        final Element childElement = (Element) child;\n+                        if (childElement.getTagName().equals(\"package\")) {\n+                            publicPackages.add(childElement.getTextContent());\n+                        }\n+                    }\n+                    publicPackagesNode.removeChild(child);\n+                }\n+\n+                final Document publicXMLFile = readXMLFile(publicPackagesFile);\n+                final NodeList packageNodes = publicXMLFile.getElementsByTagName(\"package\");\n+                for (int i = 0; i < packageNodes.getLength(); i++) {\n+                    packages.add(packageNodes.item(i).getTextContent());\n+                }\n+            }\n+\n+            // Remove all the class-path-extension elements\n+            // Ensure that each is a child of the data element\n+            // Remore all white space around the elements\n+            final NodeList classPathExtensionNodes = document.getElementsByTagName(\"class-path-extension\");\n+            while (classPathExtensionNodes.getLength() > 0) {\n+                final Node classPathExtensionNode = classPathExtensionNodes.item(0);\n+                if (classPathExtensionNode.getParentNode() == dataNode) {\n+                    Node nextNode = classPathExtensionNode.getNextSibling();\n+                    while (nextNode instanceof Text) {\n+                        Node textNode = nextNode;\n+                        nextNode = nextNode.getNextSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    Node prevNode = classPathExtensionNode.getPreviousSibling();\n+                    while (prevNode instanceof Text) {\n+                        Node textNode = prevNode;\n+                        prevNode = prevNode.getPreviousSibling();\n+                        dataNode.removeChild(textNode);\n+                    }\n+                    dataNode.removeChild(classPathExtensionNode);\n+                } else {\n+                    throw new IllegalStateException(\"Not a valid project.xml file\");\n+                }\n+            }\n+\n+            // Restore each jar file to the project.xml\n+            // If the jar directory does not exist then assume no wrapped jars\n+            // Ensure each file is a JAR file\n+            // Add white space to make it look the same as the Netbeans version\n+            if (jarDirectory.exists()) {\n+                for (File jarFile : jarDirectory.listFiles()) {\n+                    if (jarFile.getName().endsWith(\".jar\")) {\n+                        logMessage(\"\\tIncluding jar file: \" + jarFile.getName());\n+                        addClassPathExtension(document, jarFile, dataNode);\n+\n+                        if (publicPackagesFile.exists()) {\n+                            extractMatchingPackages(jarFile, packages, publicPackages);\n+                        }\n+                    } else {\n+                        throw new IllegalStateException(\"Not a JAR file: \" + jarFile.getAbsolutePath());\n+                    }\n+                }\n+\n+                dataNode.appendChild(document.createTextNode(\"\\n        \"));\n+            }\n+\n+            if (publicPackagesFile.exists()) {\n+                for (String publicPackage : publicPackages) {\n+                    if (!publicPackage.startsWith(\"META-INF\")) {\n+                        Element publicPackageElement = document.createElement(\"package\");\n+                        publicPackageElement.setTextContent(publicPackage);\n+                        publicPackagesNode.appendChild(document.createTextNode(\"\\n                \"));\n+                        publicPackagesNode.appendChild(publicPackageElement);\n+                    }\n+                }\n+            }\n+            if (publicPackagesNode != null) {\n+                publicPackagesNode.appendChild(document.createTextNode(\"\\n            \"));\n+            }\n+\n+            // Delete the existing old file and replace it with a copy of the current project.xml\n+            oldProjectFile.delete();\n+            projectFile.renameTo(oldProjectFile);\n+\n+            // Save the edited document to project.xml\n+            saveXMLFile(document, projectFile);\n+        } catch (Exception ex) {\n+            logMessage(\"Exception during update: \" + ex.getClass() + \" \" + ex.getMessage() + \" \" + ex.getStackTrace()[0]);\n+        }\n+    }\n+\n+    private static void addClassPathExtension(Document document, File jarFile, Node parentNode) {\n+        final Element classPathExtensionElement = document.createElement(\"class-path-extension\");\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n                \"));\n+\n+        final Element runtimeRelativePathElement = document.createElement(\"runtime-relative-path\");\n+        runtimeRelativePathElement.setTextContent(\"ext/\" + jarFile.getName());\n+        classPathExtensionElement.appendChild(runtimeRelativePathElement);\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n                \"));\n+\n+        final Element binaryOriginElement = document.createElement(\"binary-origin\");\n+        binaryOriginElement.setTextContent(\"release/modules/ext/\" + jarFile.getName());\n+        classPathExtensionElement.appendChild(binaryOriginElement);\n+        classPathExtensionElement.appendChild(document.createTextNode(\"\\n            \"));\n+\n+        parentNode.appendChild(document.createTextNode(\"\\n            \"));\n+        parentNode.appendChild(classPathExtensionElement);\n+    }\n+\n+    private static Document readXMLFile(File xmlFile) throws Exception {\n+        final DocumentBuilder builder = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+        final Transformer transformer = TransformerFactory.newInstance().newTransformer();\n+\n+        // Create a document to work on\n+        final Document document = builder.newDocument();\n+\n+        // Read in the existing project.xml into the document\n+        try (FileInputStream in = new FileInputStream(xmlFile)) {\n+            Source loadSource = new StreamSource(in);\n+            Result loadResult = new DOMResult(document);\n+            transformer.transform(loadSource, loadResult);\n+        }\n+\n+        return document;\n+    }\n+\n+    private static void saveXMLFile(Document document, File xmlFile) throws Exception {\n+        final Transformer transformer = TransformerFactory.newInstance().newTransformer();\n+\n+        try (FileOutputStream out = new FileOutputStream(xmlFile)) {\n+            Source saveSource = new DOMSource(document);\n+            Result saveResult = new StreamResult(out);\n+            transformer.transform(saveSource, saveResult);\n+        }\n+    }\n+\n+    private void extractMatchingPackages(File jarFile, List<String> expressions, Set<String> publicPackages) throws Exception {\n+        final ZipInputStream zip = new ZipInputStream(new FileInputStream(jarFile));\n+        ZipEntry entry = zip.getNextEntry();\n+        while (entry != null) {\n+            final String path = entry.getName();\n+            int lastDivider = path.lastIndexOf('/');", "originalCommit": "474155ebc8632250fc8eec25d1bdf606aa1f66c9", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY4OTMzMg==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r435689332", "bodyText": "added", "author": "arcturus2", "createdAt": "2020-06-05T04:54:36Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTY3OTg4Nw=="}], "type": "inlineReview"}, {"oid": "37212c47fc832e5a35de9d13af9a22cf8f89ed3d", "url": "https://github.com/constellation-app/constellation/commit/37212c47fc832e5a35de9d13af9a22cf8f89ed3d", "message": ":green_heart: Improvements to ProjectUpdater\n* Made sure the packages list is sorted so that it will be consistent every time and avoid merge conflicts\n* More finals", "committedDate": "2020-06-05T04:35:34Z", "type": "commit"}, {"oid": "042969a0042413183e31692d85f9cbcc14a8e886", "url": "https://github.com/constellation-app/constellation/commit/042969a0042413183e31692d85f9cbcc14a8e886", "message": ":green_heart: minor tweaks based on feedback", "committedDate": "2020-06-05T04:47:10Z", "type": "commit"}, {"oid": "8fb7eb2f3d91dd49e9b0f0b47e3ba1a57585d52c", "url": "https://github.com/constellation-app/constellation/commit/8fb7eb2f3d91dd49e9b0f0b47e3ba1a57585d52c", "message": ":green_heart: Missed a final", "committedDate": "2020-06-05T04:56:12Z", "type": "commit"}, {"oid": "ba1081c1e4132106a17bf0dd6b0e8c3c77255930", "url": "https://github.com/constellation-app/constellation/commit/ba1081c1e4132106a17bf0dd6b0e8c3c77255930", "message": ":green_heart: Restore the target java version", "committedDate": "2020-06-05T04:57:44Z", "type": "commit"}, {"oid": "182227a71534e0a9e8f0733cff7b162650fa2f34", "url": "https://github.com/constellation-app/constellation/commit/182227a71534e0a9e8f0733cff7b162650fa2f34", "message": ":art: Improve the format of the project.properties file", "committedDate": "2020-06-05T05:28:51Z", "type": "commit"}, {"oid": "5c15ee278a5bdc9ef31862fca77c472381716983", "url": "https://github.com/constellation-app/constellation/commit/5c15ee278a5bdc9ef31862fca77c472381716983", "message": ":shirt: Fix to a number of SonarQube warnings\n* use try with resource\n* extract constants for magic strings\n* use java.util.logger\n* some security improvements to the xml parser referencing external files", "committedDate": "2020-06-05T07:05:39Z", "type": "commit"}, {"oid": "465486d27578c405ebcd84cbf1e8c57b90b5eec0", "url": "https://github.com/constellation-app/constellation/commit/465486d27578c405ebcd84cbf1e8c57b90b5eec0", "message": ":shirt: More sonarQube cleanup\n* Removed redundant exceptions\n* Added a security check to make sure archives are not trying to leave the parent directory", "committedDate": "2020-06-05T08:25:14Z", "type": "commit"}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1NTk3Mw==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r437055973", "bodyText": "You should update the package names.", "author": "cygnus-x-1", "createdAt": "2020-06-08T23:30:14Z", "path": "ProjectUpdater/src/au/gov/asd/tac/projectupdater/ProjectUpdater.java", "diffHunk": "@@ -0,0 +1,311 @@\n+/*\n+ * Copyright 2010-2020 Australian Signals Directorate\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package au.gov.asd.tac.projectupdater;", "originalCommit": "465486d27578c405ebcd84cbf1e8c57b90b5eec0", "replyToReviewId": null, "replies": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA3ODA4MQ==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r437078081", "bodyText": "to au.gov.asd.tac.constellation.projectupdater  @cygnus-x-1 ?", "author": "arcturus2", "createdAt": "2020-06-09T00:53:18Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1NTk3Mw=="}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA4NjI5Nw==", "url": "https://github.com/constellation-app/constellation/pull/564#discussion_r437086297", "bodyText": "Updated it @cygnus-x-1", "author": "arcturus2", "createdAt": "2020-06-09T01:25:20Z", "replyToReviewId": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzA1NTk3Mw=="}], "type": "inlineReview"}, {"oid": "921044cb00cb1c08e8897734e0b77afb569045ab", "url": "https://github.com/constellation-app/constellation/commit/921044cb00cb1c08e8897734e0b77afb569045ab", "message": ":art: Update to package name based on feedback", "committedDate": "2020-06-09T01:24:24Z", "type": "commit"}]}